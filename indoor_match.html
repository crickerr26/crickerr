<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Cricker - Indoor Match Controller</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb"/>
    <link rel="apple-touch-icon" href="icon-512.png">

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    
<style>
    /* --- Base Styles --- */
    body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
    
    /* --- MOBILE SPECIFIC FIXES --- */
    @media (max-width: 768px) {
        body { font-size: 14px; }
        
        #setup-screen {
            align-items: flex-start !important;
            justify-content: flex-start !important;
            padding: 0 !important;
            background-color: white !important;
        }
        
        .setup-card { 
            width: 100% !important;
            height: 100% !important;
            min-height: 100vh !important;
            max-width: 100% !important;
            border: none !important;
            border-radius: 0 !important;
            box-shadow: none !important;
            padding-top: 1rem !important;
        }

        #app { overflow: hidden; }
        #app > .flex-grow { padding: 8px; display: flex; flex-direction: column; }
        #match-header h1 { font-size: 1.25rem; }
        #scoreboard { padding: 0; }
        #batting-table th, #batting-table td, #bowling-table th, #bowling-table td { padding: 4px 2px; font-size: 0.75rem; }
    }

    /* --- Setup & UI Components --- */
    .setup-bg { background-color:#f3f4f6; }
    .setup-card { background: #ffffff; border: 1px solid #e5e7eb; border-radius: 1rem; }
    .setup-step { transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out; }
    .setup-step.hidden { opacity: 0; transform: translateX(30px) scale(0.98); position: absolute; pointer-events: none; }
    .setup-step.active { opacity: 1; transform: translateX(0) scale(1); }
    .progress-bar-fill { background-color: #2563eb; transition: width 0.5s ease-in-out; }
    
    /* Toss Buttons */
    .toss-card-btn { 
        border-radius: 1rem; 
        background-color: white; 
        border: 2px solid #e5e7eb; 
        transition: all 0.2s ease-out; 
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        padding: 2rem; cursor: pointer;
    }
    .toss-card-btn:hover { border-color: #93c5fd; }
    .toss-card-btn.selected { background-color: #eff6ff; border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2); }

    .decision-btn {
        border-radius: 0.75rem; background-color: white; border: 1px solid #d1d5db;
        padding: 0.75rem 2rem; font-weight: bold; transition: all 0.2s;
    }
    .decision-btn.selected { background-color: #2563eb; color: white; border-color: #2563eb; box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.3); }
    
    /* --- Scoring Grid --- */
    .scoring-grid { 
        display: grid; grid-template-columns: repeat(4, 1fr); grid-template-rows: 1fr 1fr 0.7fr; 
        flex-grow: 1; gap: 6px; padding: 6px; background: #f0f2f5;
    }

    .watery-btn {
        border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.3);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.4);
        font-family: 'Inter', sans-serif; transition: transform 0.1s active, filter 0.2s;
        backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center;
        position: relative; overflow: hidden;
    }
    .watery-btn:active { transform: scale(0.96); }

    /* Gradients */
    .btn-grey { background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%); color: #374151; }
    .btn-dark-grey { background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%); color: #ffffff; text-shadow: 0 1px 2px rgba(0,0,0,0.3); }
    .btn-sky { background: linear-gradient(135deg, #7dd3fc 0%, #0ea5e9 100%); color: #ffffff; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }
    .btn-green { background: linear-gradient(135deg, #86efac 0%, #16a34a 100%); color: #ffffff; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }
    .btn-red { background: linear-gradient(135deg, #fca5a5 0%, #dc2626 100%); color: #ffffff; text-shadow: 0 1px 2px rgba(0,0,0,0.3); }
    .btn-yellow { background: linear-gradient(135deg, #fde047 0%, #eab308 100%); color: #713f12; }
    .btn-purple { background: linear-gradient(135deg, #c084fc 0%, #9333ea 100%); color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }

    /* Animation */
    @keyframes popIn { 0% { transform: scale(0); opacity: 0; } 50% { transform: scale(1.3); opacity: 1; } 100% { transform: scale(1); opacity: 1; } }
    .animate-pop { animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
    
    .modal-overlay { transition: opacity 0.3s ease-in-out; }
    .roster-row { display: grid; grid-template-columns: auto 1fr auto; gap: 0.75rem; align-items: center; padding: 0.5rem; background-color: white; border: 1px solid #e5e7eb; border-radius: 0.5rem; transition: all 0.2s; }
    .roster-row.selected { background-color: #eff6ff; border-color: #3b82f6; }
    .roster-input { width: 100%; font-weight: 600; color: #374151; background: transparent; border: none; outline: none; text-transform: uppercase; font-size: 0.85rem; }
    .roster-input:focus { border-bottom: 2px solid #3b82f6; }
    
    /* Ball Chips */
    .ball-chip { display: inline-flex; justify-content: center; align-items: center; width: 1.2rem; height: 1.2rem; font-size: 0.6rem; font-weight: bold; border-radius: 9999px; margin-right: 0.1rem; background-color: #e5e7eb; color: #374151; flex-shrink: 0; }
    .ball-4 { background-color: #3b82f6; color: white; }
    .ball-6 { background-color: #22c55e; color: white; }
    .ball-w { background-color: #ef4444; color: white; }
    .ball-wd, .ball-nb { background-color: #f59e0b; color: white; }

    .custom-scroll::-webkit-scrollbar { width: 6px; }
    .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
    .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    .opacity-60 { filter: grayscale(100%); opacity: 0.6; }

    /* iOS Toggle */
    .ios-toggle { appearance: none; width: 50px; height: 30px; background: #e5e7eb; border-radius: 9999px; position: relative; cursor: pointer; outline: none; transition: background-color 0.3s ease; }
    .ios-toggle::after { content: ''; position: absolute; top: 2px; left: 2px; width: 26px; height: 26px; background: white; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1); }
    .ios-toggle:checked { background-color: #34c759; }
    .ios-toggle:checked::after { transform: translateX(20px); }

    /* --- EDIT MODAL STYLES --- */
    .ball-edit-row { display: flex; align-items: stretch; margin-bottom: 0.75rem; cursor: pointer; transition: transform 0.1s ease-in-out; }
    .ball-edit-row:active { transform: scale(0.98); }
    .ball-label { width: 4.5rem; display: flex; align-items: center; justify-content: center; background-color: #f1f5f9; color: #64748b; font-size: 0.65rem; font-weight: 900; text-transform: uppercase; border-top-left-radius: 0.75rem; border-bottom-left-radius: 0.75rem; border: 1px solid #e2e8f0; border-right: none; letter-spacing: 0.05em; }
    .ball-value { flex-grow: 1; display: flex; align-items: center; justify-content: space-between; background-color: white; padding: 0 1.25rem; height: 3.5rem; border: 1px solid #e2e8f0; border-top-right-radius: 0.75rem; border-bottom-right-radius: 0.75rem; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
    
    .mini-score-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; background: #f1f5f9; padding: 8px; border-radius: 12px; border: 1px solid #cbd5e1; margin-bottom: 10px; }
    .mini-score-grid .watery-btn { height: 3.5rem; font-size: 1.1rem; font-weight: 800; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1), inset 0 1px 0 rgba(255,255,255,0.4); }
    .mini-score-grid .watery-btn:active { transform: scale(0.95); }
    .extras-edit-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 4px; padding: 8px; background: #f8fafc; border-radius: 12px; }
</style>
</head>
<body class="bg-gray-100 antialiased text-gray-800">

    <div id="splash-screen" class="fixed inset-0 z-[9999] flex flex-col items-center justify-center bg-gray-50 transition-opacity duration-700" style="display: none;">
        <img src="my-logo.png" alt="App Logo" class="w-24 h-24 mb-4 animate-pulse">
        <h1 class="text-xl font-bold text-blue-700">INDOOR CRICKET</h1>
    </div>

    <div id="event-animation-overlay" class="fixed inset-0 flex items-center justify-center bg-black/60 backdrop-blur-sm pointer-events-none hidden z-50 transition-opacity duration-300">
        <h1 id="event-animation-text" class="text-8xl font-black uppercase drop-shadow-2xl text-center"></h1>
    </div>

    <div id="setup-screen" class="min-h-screen w-full flex flex-col md:items-center md:justify-center setup-bg">
        <div class="w-full md:max-w-6xl md:shadow-xl md:rounded-2xl p-4 md:p-8 setup-card overflow-hidden min-h-screen md:min-h-0 bg-white">
            <div id="progress-container" class="mb-8 max-w-2xl mx-auto">
                <div class="w-full h-2 bg-gray-200 rounded-full">
                    <div id="progress-bar" class="progress-bar-fill h-2 rounded-full" style="width: 33%;"></div>
                </div>
                <div class="flex justify-between text-xs sm:text-sm text-gray-500 mt-2 font-medium">
                    <span>Config</span><span>Squad Review</span><span>Toss</span>
                </div>
            </div>

            <div class="relative">
                <div id="setup-step-1" class="setup-step active max-w-2xl mx-auto">
                    <header class="text-center mb-6">
                        <h1 class="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-600 via-purple-600 to-pink-600 tracking-tight" id="setup-title">Indoor Match Setup</h1>
                        <p class="text-xs text-gray-500 mt-1">Configure format and specific rules</p>
                    </header>
                    <div class="space-y-6 h-[60vh] overflow-y-auto pr-2 custom-scroll">
                        <div class="bg-gray-50 p-4 rounded-xl border border-gray-200 space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><label class="block text-sm font-bold mb-1">Ground</label><input type="text" id="venue" placeholder="ARENA NAME" class="w-full p-2 border rounded uppercase"></div>
                                <div><label class="block text-sm font-bold mb-1">Date</label><input type="date" id="match-date-input" class="w-full p-2 border rounded"></div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-bold mb-1">Overs (3-15)</label>
                                    <select id="total-overs" class="w-full p-2 border rounded">
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-bold mb-1">Players/Side (4-11)</label>
                                    <select id="players-per-side" class="w-full p-2 border rounded">
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 space-y-4">
                            <h3 class="text-sm font-bold text-blue-500 uppercase tracking-wider">Indoor Rules</h3>
                            <div class="grid grid-cols-3 gap-2">
                                <div>
                                    <label class="block text-xs font-bold mb-1">Wicket Penalty <span class="text-red-500 text-lg">*</span></label>
                                    <select id="rule-wicket" class="w-full p-2 border rounded text-sm text-red-600 font-bold border-red-300 focus:ring-2 focus:ring-red-500 outline-none">
                                        <option value="" selected disabled>Select...</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold mb-1">Wide <span class="text-red-500 text-lg">*</span></label>
                                    <select id="rule-wide" class="w-full p-2 border rounded text-sm border-red-300 focus:ring-2 focus:ring-red-500 outline-none">
                                        <option value="" selected disabled>Select...</option>
                                        <option value="2">2 Runs</option>
                                        <option value="3">3 Runs</option>
                                        <option value="1">1 Run</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold mb-1">No Ball <span class="text-red-500 text-lg">*</span></label>
                                    <select id="rule-noball" class="w-full p-2 border rounded text-sm border-red-300 focus:ring-2 focus:ring-red-500 outline-none">
                                        <option value="" selected disabled>Select...</option>
                                        <option value="2">2 Runs</option>
                                        <option value="3">3 Runs</option>
                                        <option value="1">1 Run</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                             <div class="p-3 bg-green-50 rounded-xl border border-green-200">
   <label class="block text-xs font-bold mb-1 text-green-800">Home Team</label>
   <select id="team1-select" class="w-full p-2 mb-2 border rounded text-sm"><option value="">+ Load Saved Team</option></select>
   <input type="text" id="team1-name-input" placeholder="Home Team Name" class="w-full p-2 border rounded font-bold uppercase">
   <input type="file" id="team1-logo-input" class="mt-2 text-xs" onchange="handleLogoUpload(this.files[0], 'team1')">
   <img id="team1-logo-preview" class="hidden mt-2 w-16 h-16 object-cover rounded-full border-2 border-green-500 shadow-sm">
</div>
<div class="p-3 bg-blue-50 rounded-xl border border-blue-200">
   <label class="block text-xs font-bold mb-1 text-blue-800">Away Team</label>
   <select id="team2-select" class="w-full p-2 mb-2 border rounded text-sm"><option value="">+ Load Saved Team</option></select>
   <input type="text" id="team2-name-input" placeholder="Away Team Name" class="w-full p-2 border rounded font-bold uppercase">
   <input type="file" id="team2-logo-input" class="mt-2 text-xs" onchange="handleLogoUpload(this.files[0], 'team2')">
   <img id="team2-logo-preview" class="hidden mt-2 w-16 h-16 object-cover rounded-full border-2 border-blue-500 shadow-sm">
</div>
                        </div>
                    </div>
                    <div class="mt-4 text-right"><button onclick="goToStep(2)" class="px-6 py-3 bg-blue-600 text-white font-bold rounded-lg shadow">Next Step ‚Üí</button></div>
                </div>

                <div id="setup-step-2" class="setup-step hidden w-full">
                    <header class="text-center mb-6"><h1 class="text-2xl font-bold">Select Playing Squad</h1><p class="text-xs text-gray-500">Tick the players for today's match</p></header>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-white rounded-xl shadow-sm border border-blue-200 h-full flex flex-col">
                            <div class="bg-blue-50 p-4 border-b flex items-center gap-3"><img id="team1-roster-logo" class="w-10 h-10 rounded-full object-cover"><h2 id="team1-roster-title" class="font-bold text-lg text-blue-900">HOME</h2><span id="team1-count-badge" class="ml-auto text-xs bg-white px-2 py-1 rounded border">0/0</span></div>
                            <div id="team1-player-inputs" class="flex-grow overflow-y-auto max-h-[50vh] p-2 space-y-1 custom-scroll"></div>
                            <div class="p-2 border-t"><button onclick="addNewPlayerToRoster('team1')" class="w-full py-2 border-dashed border-2 text-sm font-bold text-gray-500 rounded hover:text-blue-600">+ Add New Player</button></div>
                        </div>
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 h-full flex flex-col">
                            <div class="bg-gray-100 p-4 border-b flex items-center gap-3"><img id="team2-roster-logo" class="w-10 h-10 rounded-full object-cover"><h2 id="team2-roster-title" class="font-bold text-lg text-gray-800">AWAY</h2><span id="team2-count-badge" class="ml-auto text-xs bg-white px-2 py-1 rounded border">0/0</span></div>
                            <div id="team2-player-inputs" class="flex-grow overflow-y-auto max-h-[50vh] p-2 space-y-1 custom-scroll"></div>
                            <div class="p-2 border-t"><button onclick="addNewPlayerToRoster('team2')" class="w-full py-2 border-dashed border-2 text-sm font-bold text-gray-500 rounded hover:text-gray-800">+ Add New Player</button></div>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-between"><button onclick="goToStep(1)" class="text-gray-500 font-bold px-4">‚Üê Back</button><button onclick="proceedFromUnifiedRoster()" id="btn-roster-confirm" class="px-8 py-3 bg-blue-600 text-white font-bold rounded-xl shadow">Confirm & Toss ‚Üí</button></div>
                </div>

                <div id="setup-step-4" class="setup-step hidden text-center max-w-md mx-auto pb-20 pt-4">
                    
                    <div class="mb-10">
                        <h1 class="text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-600 via-purple-600 to-pink-600 tracking-tight drop-shadow-sm">Toss Time</h1>
                        <p class="text-gray-500 font-bold text-xs uppercase tracking-[0.2em] mt-2">Who won the coin toss?</p>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-5 mb-10">
                        <div id="toss-winner-team1" onclick="selectTossWinner('team1')" 
                             class="toss-card-btn group relative flex flex-col items-center justify-center p-5 bg-white border-2 border-transparent rounded-3xl shadow-[0_10px_30px_-10px_rgba(0,0,0,0.1)] cursor-pointer transition-all duration-300 hover:scale-[1.03] active:scale-95 h-48">
                            <div class="absolute inset-0 bg-gradient-to-br from-blue-50 to-purple-50 opacity-0 group-hover:opacity-100 rounded-3xl transition-opacity"></div>
                            <div id="toss-team1-logo-container" class="relative z-10 w-20 h-20 rounded-full shadow-lg mb-4 overflow-hidden bg-white flex items-center justify-center border-4 border-white"></div>
                            <span id="toss-team1-name" class="relative z-10 font-black text-gray-800 text-sm uppercase tracking-wide truncate w-full px-2">Home</span>
                            
                            <div class="absolute -top-3 -right-3 w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white shadow-lg opacity-0 check-icon transition-all duration-300 transform scale-50"><svg class="w-5 h-5 fill-current" viewBox="0 0 20 20"><path d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"/></svg></div>
                        </div>

                        <div id="toss-winner-team2" onclick="selectTossWinner('team2')" 
                             class="toss-card-btn group relative flex flex-col items-center justify-center p-5 bg-white border-2 border-transparent rounded-3xl shadow-[0_10px_30px_-10px_rgba(0,0,0,0.1)] cursor-pointer transition-all duration-300 hover:scale-[1.03] active:scale-95 h-48">
                            <div class="absolute inset-0 bg-gradient-to-br from-orange-50 to-red-50 opacity-0 group-hover:opacity-100 rounded-3xl transition-opacity"></div>
                            <div id="toss-team2-logo-container" class="relative z-10 w-20 h-20 rounded-full shadow-lg mb-4 overflow-hidden bg-white flex items-center justify-center border-4 border-white"></div>
                            <span id="toss-team2-name" class="relative z-10 font-black text-gray-800 text-sm uppercase tracking-wide truncate w-full px-2">Away</span>
                            
                            <div class="absolute -top-3 -right-3 w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white shadow-lg opacity-0 check-icon transition-all duration-300 transform scale-50"><svg class="w-5 h-5 fill-current" viewBox="0 0 20 20"><path d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"/></svg></div>
                        </div>
                    </div>

                    <p class="mb-4 text-gray-400 text-xs font-bold uppercase tracking-widest">Decision</p>
                    <div class="grid grid-cols-2 gap-4 mb-10">
                        <button id="toss-choice-bat" onclick="selectTossChoice('bat')" class="decision-btn relative overflow-hidden py-4 rounded-2xl border-2 border-gray-100 hover:border-orange-200 bg-white transition-all duration-300 group">
                            <div class="absolute inset-0 bg-gradient-to-r from-yellow-100 to-orange-100 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                            <span class="relative z-10 flex items-center justify-center gap-2 text-gray-500 group-hover:text-orange-600 font-black text-lg uppercase">
                                <span>üèè</span> Bat
                            </span>
                        </button>
                        <button id="toss-choice-bowl" onclick="selectTossChoice('bowl')" class="decision-btn relative overflow-hidden py-4 rounded-2xl border-2 border-gray-100 hover:border-blue-200 bg-white transition-all duration-300 group">
                            <div class="absolute inset-0 bg-gradient-to-r from-blue-100 to-cyan-100 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                            <span class="relative z-10 flex items-center justify-center gap-2 text-gray-500 group-hover:text-blue-600 font-black text-lg uppercase">
                                <span>‚öæ</span> Bowl
                            </span>
                        </button>
                    </div>

                    <div class="mb-8">
                         <button id="btn-broadcast-enable" onclick="generateBroadcastCode()" class="group relative w-full py-5 bg-white border-2 border-gray-100 text-gray-600 rounded-2xl shadow-sm hover:shadow-xl hover:border-green-400 transition-all duration-300 active:scale-95 flex flex-col items-center justify-center overflow-hidden">
                            <div class="absolute inset-0 bg-gradient-to-r from-emerald-50 to-teal-50 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                            <div class="relative z-10 flex items-center gap-3">
                                <span class="text-3xl filter grayscale group-hover:grayscale-0 transition-all">üì°</span>
                                <div class="text-left">
                                    <span class="block text-base font-black tracking-wide group-hover:text-green-700 uppercase">Enable Live Broadcast</span>
                                    <span class="block text-[10px] text-gray-400 font-bold group-hover:text-green-600 uppercase tracking-wider">Required to start</span>
                                </div>
                            </div>
                        </button>
                        
                        <div id="broadcast-display" class="hidden mt-6 animate-pop">
                            <div class="bg-gradient-to-br from-gray-900 to-black rounded-3xl p-6 shadow-2xl flex flex-col items-center border border-gray-800 ring-4 ring-gray-100">
                                <p class="text-[10px] text-emerald-400 font-bold uppercase mb-2 tracking-[0.3em]">Camera Code</p>
                                <div id="match-code-box" class="text-6xl font-mono font-black text-white tracking-widest cursor-pointer hover:text-emerald-300 transition-colors drop-shadow-[0_0_10px_rgba(52,211,153,0.5)]" onclick="copyBroadcastLink()">0000</div>
                                <p id="copy-feedback" class="text-xs text-gray-500 font-bold mt-3 hidden">Copied to clipboard!</p>
                            </div>
                        </div>
                    </div>

                    <button id="start-match-btn" disabled class="w-full py-6 bg-gray-200 text-gray-400 font-black rounded-3xl text-xl shadow-none transition-all duration-300 cursor-not-allowed uppercase tracking-widest mb-12" onclick="startMatch()">
                        Start Match
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="app" class="h-screen w-full flex flex-col hidden bg-gray-100">
        <div id="match-header" class="bg-white border-b border-gray-200 p-2 text-center shadow-sm z-10"></div>

        <div class="flex-grow flex flex-col lg:flex-row overflow-hidden">
            <div class="flex-grow flex flex-col p-2 lg:p-4 gap-2 overflow-y-auto">
                <div id="scoreboard" class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden">
                    <div id="team-scores-container" class="flex flex-col"></div>
                </div>

                <div class="bg-white rounded-lg shadow border border-gray-100 overflow-hidden">
                    <table class="w-full text-left text-xs">
                        <thead class="bg-gray-100 text-gray-600 border-b">
                            <tr>
                                <th class="p-2 w-1/2 flex items-center justify-between">
                                    <span>Batting</span>
                                    <button onclick="manualSwap()" class="bg-blue-100 hover:bg-blue-200 text-blue-700 text-[10px] px-2 py-1 rounded border border-blue-300 font-bold shadow-sm transition-transform active:scale-95">‚áÑ Swap</button>
                                </th>
                                <th class="p-2 text-center">R</th>
                                <th class="p-2 text-center">B</th>
                                <th class="p-2 text-center">4s</th>
                                <th class="p-2 text-center">6s</th>
                                <th class="p-2 text-right">SR</th>
                            </tr>
                        </thead>
                        <tbody id="batting-table" class="divide-y divide-gray-50"></tbody>
                    </table>
                </div>
                
                <div class="bg-white rounded-lg shadow border border-gray-100 overflow-hidden">
                    <table class="w-full text-left text-xs">
                        <thead class="bg-gray-100 text-gray-500 border-b">
                            <tr class="text-[10px] uppercase tracking-wider">
                                <th class="py-1 px-2 w-1/2">Bowling</th>
                                <th class="py-1 text-center">O</th>
                                <th class="py-1 text-center">M</th>
                                <th class="py-1 text-center">R</th>
                                <th class="py-1 text-center">W</th>
                                <th class="py-1 text-right pr-2">Eco</th>
                            </tr>
                        </thead>
                        <tbody id="bowling-table" class="divide-y divide-gray-50"></tbody>
                    </table>
                </div>
            </div>

            <div class="flex-shrink-0 lg:w-96 bg-white border-t lg:border-l border-gray-200 flex flex-col z-20">

                <div class="scoring-grid h-64 lg:h-auto lg:flex-grow">
                    <button onclick="addRuns(0)" class="watery-btn btn-grey font-bold text-xl">0</button>
                    <button onclick="addRuns(1)" class="watery-btn btn-grey font-bold text-xl">1</button>
                    <button onclick="addRuns(2)" class="watery-btn btn-grey font-bold text-xl">2</button>
                    <button onclick="addRuns(3)" class="watery-btn btn-grey font-bold text-xl">3</button>

                    <button onclick="undoLastAction()" id="undo-btn" class="watery-btn btn-yellow font-bold text-sm">UNDO</button>
                    <button onclick="addRuns(4)" class="watery-btn btn-sky font-bold text-2xl">4</button>
                    <button onclick="addRuns(6)" class="watery-btn btn-green font-bold text-2xl">6</button>
                    <button onclick="addRuns(5)" class="watery-btn btn-grey font-bold text-xl">5</button>

                    <button id="btn-wicket" onclick="openWicketModal()" class="watery-btn btn-red font-bold text-lg col-span-1">WKT</button>
                    <button onclick="openModal('wide-modal')" class="watery-btn btn-dark-grey font-bold text-sm">WD</button>
                    <button onclick="openModal('noball-modal')" class="watery-btn btn-dark-grey font-bold text-sm">NB</button>
                    <button onclick="openModal('extras-modal')" class="watery-btn btn-dark-grey font-bold text-sm">EXT</button>
                </div>

                <div class="p-2 bg-gray-50 flex justify-between items-center border-t px-4">
                    <button onclick="confirmExit()" class="text-xs font-bold uppercase tracking-wider text-red-600">Exit Match</button>
                    <button onclick="openEditMatchMode()" class="text-xs font-bold uppercase tracking-wider text-blue-600 border border-blue-200 px-3 py-1 rounded-lg hover:bg-blue-50">‚úé Edit Match</button>
                    <button onclick="openViewControlModal()" class="text-xs font-bold uppercase tracking-wider text-white bg-indigo-600 px-4 py-2 rounded-full border border-indigo-700 shadow-lg hover:bg-indigo-700">üì∫ BROADCAST</button>
                </div>
            </div>
        </div>
    </div>

    <div id="opening-pair-modal" class="modal-overlay fixed inset-0 bg-black/80 backdrop-blur-sm hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-2xl p-6 w-full max-w-lg shadow-2xl m-4">
            <h3 class="text-xl font-bold mb-6 text-center text-blue-900">Select Batting Pair</h3>
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1 uppercase text-center">Striker</label>
                    <select id="pair-striker-select" class="w-full p-3 bg-blue-50 border border-blue-200 rounded-xl font-bold text-gray-800 focus:ring-2 focus:ring-blue-500 outline-none text-sm text-center" onchange="updatePairExclusions()"></select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1 uppercase text-center">Non-Striker</label>
                    <select id="pair-nonstriker-select" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl font-bold text-gray-800 focus:ring-2 focus:ring-blue-500 outline-none text-sm text-center" onchange="updatePairExclusions()"></select>
                </div>
            </div>
            <button onclick="confirmOpeningPair()" class="w-full py-4 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl shadow-lg transition-all transform active:scale-95">Confirm Batting Pair</button>
        </div>
    </div>

    <div id="player-modal" class="modal-overlay fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-50 flex items-center justify-center">
    <div class="modal-content bg-white rounded-2xl p-6 w-80 shadow-2xl relative">
        <button onclick="cancelPlayerSelection()" class="absolute top-3 right-4 text-red-600 hover:text-red-800 font-black text-xl transition-transform hover:scale-110">
            ‚úï
        </button>

        <h3 id="modal-title" class="text-lg font-bold mb-4 text-center mt-2">Select Player</h3>
        <select id="player-select" class="w-full p-3 bg-gray-50 border rounded-xl mb-4 text-lg outline-none focus:ring-2 focus:ring-blue-500"></select>
        <button id="player-save-btn" class="w-full py-3 bg-blue-600 text-white font-bold rounded-xl shadow-lg active:scale-95 transition-transform">Confirm</button>
    </div>
</div>

    <div id="bowler-edit-modal" class="modal-overlay fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-2xl p-6 w-96 shadow-2xl relative max-h-[80vh] overflow-y-auto">
            <button onclick="closeModal('bowler-edit-modal')" class="absolute top-3 right-4 text-gray-400 hover:text-gray-600 font-bold text-xl">‚úï</button>
            <h3 class="text-lg font-bold mb-4 text-center text-blue-900">Edit Bowler & Over</h3>
            
            <div class="mb-6">
                <label class="block text-xs font-bold text-gray-500 mb-1 uppercase tracking-wider">Current Bowler</label>
                <select id="edit-bowler-select" class="w-full p-3 border border-gray-300 rounded-xl font-bold text-lg bg-gray-50 outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all" onchange="changeCurrentBowler(this.value)">
                    </select>
            </div>

            <div class="mb-4">
                <label class="block text-xs font-bold text-gray-500 mb-3 uppercase tracking-wider">Tap ball to edit</label>
                <div id="edit-over-list" class="space-y-2">
                    </div>
            </div>

            <button onclick="closeModal('bowler-edit-modal')" class="w-full py-4 bg-blue-600 hover:bg-blue-700 text-white font-black rounded-xl shadow-lg active:scale-95 transition-transform uppercase tracking-widest">Done</button>
        </div>
    </div>

    <div id="wicket-type-modal" class="modal-overlay fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-50 flex items-center justify-center">
    <div class="modal-content bg-white rounded-2xl p-6 w-80 shadow-2xl text-center max-h-[90vh] overflow-y-auto">
        <h3 id="wicket-modal-title" class="text-xl font-black text-red-600 mb-4 uppercase tracking-wider">Wicket Type</h3>
        
        <div class="grid grid-cols-2 gap-3 text-sm">
            <button onclick="handleWicketAction('Bowled')" class="p-4 bg-red-50 hover:bg-red-100 text-red-900 font-bold rounded-xl border border-red-200">BOWLED</button>
            <button onclick="setupFielderSelect('Catch')" class="p-4 bg-blue-50 hover:bg-blue-100 text-blue-900 font-bold rounded-xl border border-blue-200">CATCH</button>
            
            <button onclick="handleWicketAction('LBW')" class="p-3 bg-gray-50 hover:bg-gray-100 font-bold rounded-xl border border-gray-200">LBW</button>
            <button onclick="handleWicketAction('Run Out')" class="p-3 bg-orange-50 hover:bg-orange-100 text-orange-900 font-bold rounded-xl border border-orange-200">RUN OUT</button>
            
            <button onclick="setupFielderSelect('Stumped')" class="p-3 bg-purple-50 hover:bg-purple-100 text-purple-900 font-bold rounded-xl border border-purple-200">STUMPED</button>
            <button onclick="handleWicketAction('Hit Wicket')" class="p-3 bg-gray-50 hover:bg-gray-100 font-bold rounded-xl border border-gray-200">HIT WKT</button>
            
            <button onclick="handleWicketAction('Retired Out')" class="p-3 bg-gray-50 hover:bg-gray-100 font-bold rounded-xl border border-gray-200">Retired</button>
            <button onclick="handleWicketAction('Other')" class="p-3 bg-gray-50 hover:bg-gray-100 font-bold rounded-xl border border-gray-200">Other</button>
        </div>
        
        <button onclick="closeModal('wicket-type-modal')" class="mt-5 text-gray-400 text-xs font-bold uppercase tracking-widest hover:text-gray-600">Cancel</button>
    </div>
</div>

<div id="fielder-modal" class="modal-overlay fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-[60] flex items-center justify-center">
    <div class="modal-content bg-white rounded-2xl p-6 w-80 shadow-2xl relative">
        <button onclick="closeModal('fielder-modal')" class="absolute top-3 right-4 text-gray-400 hover:text-gray-600 font-bold text-xl">‚úï</button>
        
        <h3 id="fielder-modal-title" class="text-lg font-bold mb-4 text-center text-blue-900">Select Fielder</h3>
        <select id="fielder-select" class="w-full p-3 bg-gray-50 border rounded-xl mb-4 text-lg outline-none focus:ring-2 focus:ring-blue-500"></select>
        
        <button onclick="confirmFielder()" class="w-full py-3 bg-blue-600 text-white font-bold rounded-xl shadow-lg active:scale-95 transition-transform">Confirm</button>
    </div>
</div>

    <div id="runout-modal" class="modal-overlay fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-50 flex items-center justify-center">
        <div class="modal-content bg-white rounded-2xl p-6 w-80 shadow-2xl text-center">
            <h3 class="text-xl font-bold text-red-600 mb-4">Who is Out?</h3>
            <div class="grid grid-cols-1 gap-3">
                <button id="btn-ro-striker" onclick="finalizeRunOut('striker')" class="p-4 bg-gray-100 font-bold rounded-xl text-md hover:bg-red-50 border border-gray-200 text-gray-800">Striker</button>
                <button id="btn-ro-nonstriker" onclick="finalizeRunOut('nonstriker')" class="p-4 bg-gray-100 font-bold rounded-xl text-md hover:bg-red-50 border border-gray-200 text-gray-800">Non-Striker</button>
            </div>
            <button onclick="closeModal('runout-modal')" class="mt-4 text-gray-400 text-sm">Cancel</button>
        </div>
    </div>

    <div id="broadcast-control-modal" class="modal-overlay fixed inset-0 bg-black/80 backdrop-blur-sm hidden z-[100] flex items-center justify-center">
        <div class="bg-white rounded-3xl p-6 w-80 shadow-2xl text-center border border-gray-200">
            <h3 class="text-lg font-bold text-gray-900 mb-2 uppercase tracking-wide">Broadcast Views</h3>
            <p class="text-[10px] text-gray-400 mb-6 font-semibold uppercase tracking-wider">Toggle to Show on Stream</p>
            
            <div class="space-y-4 bg-gray-50 p-4 rounded-2xl">
                <div class="flex items-center justify-between">
                    <span class="text-sm font-bold text-gray-700">Playing Squad</span>
                    <input type="checkbox" class="ios-toggle" id="toggle-squad" onchange="toggleView('SQUAD', this)">
                </div>
                
                <div class="flex items-center justify-between border-t border-gray-200 pt-4">
    <span class="text-sm font-bold text-gray-700">Batting Card</span>
    <input type="checkbox" class="ios-toggle" id="toggle-batting" onchange="toggleView('BATTING', this)">
</div>

<div class="flex items-center justify-between border-t border-gray-200 pt-4">
    <span class="text-sm font-bold text-gray-700">Bowling Card</span>
    <input type="checkbox" class="ios-toggle" id="toggle-bowling" onchange="toggleView('BOWLING', this)">
</div>

<div class="flex items-center justify-between border-t border-gray-200 pt-4">
    <span class="text-sm font-bold text-gray-700">Run Rate (CRR/RRR)</span>
    <input type="checkbox" class="ios-toggle" id="toggle-runrate" onchange="toggleView('RUN_RATE', this)">
</div>
            </div>
            
            <button onclick="closeModal('broadcast-control-modal')" class="mt-6 w-full py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold rounded-xl text-sm transition-colors">Close Menu</button>
        </div>
    </div>

    <div id="wide-modal" class="modal-overlay fixed inset-0 bg-black/50 hidden z-50 flex items-end justify-center" onclick="closeModal('wide-modal')">
        <div class="bg-white w-full max-w-md p-6 rounded-t-2xl shadow-xl mb-0" onclick="event.stopPropagation()">
            <h3 class="font-bold text-center mb-4">Wide Ball</h3>
            <div class="grid grid-cols-3 gap-3" id="wide-options"></div>
        </div>
    </div>

    <div id="noball-modal" class="modal-overlay fixed inset-0 bg-black/50 hidden z-50 flex items-end justify-center" onclick="closeModal('noball-modal')">
        <div class="bg-white w-full max-w-md p-6 rounded-t-2xl shadow-xl mb-0" onclick="event.stopPropagation()">
            <h3 class="font-bold text-center mb-4">No Ball</h3>
            <div class="grid grid-cols-3 gap-3" id="noball-options"></div>
        </div>
    </div>
    
    <div id="extras-modal" class="modal-overlay fixed inset-0 bg-black/50 hidden z-50 flex items-end justify-center" onclick="closeModal('extras-modal')">
        <div class="bg-white w-full max-w-md p-6 rounded-t-2xl shadow-xl mb-0" onclick="event.stopPropagation()">
            <h3 class="font-bold text-center mb-4">Extras / Penalties</h3>
            
            <div class="mb-4">
                <p class="text-xs font-bold text-green-600 uppercase mb-2">Add Runs (+)</p>
                <div class="grid grid-cols-6 gap-2">
                    <button onclick="handleAddExtra('ext', 1)" class="p-3 bg-green-50 text-green-800 font-bold rounded-lg text-sm border border-green-200 hover:bg-green-100">+1</button>
                    <button onclick="handleAddExtra('ext', 2)" class="p-3 bg-green-50 text-green-800 font-bold rounded-lg text-sm border border-green-200 hover:bg-green-100">+2</button>
                    <button onclick="handleAddExtra('ext', 3)" class="p-3 bg-green-50 text-green-800 font-bold rounded-lg text-sm border border-green-200 hover:bg-green-100">+3</button>
                    <button onclick="handleAddExtra('ext', 4)" class="p-3 bg-green-50 text-green-800 font-bold rounded-lg text-sm border border-green-200 hover:bg-green-100">+4</button>
                    <button onclick="handleAddExtra('ext', 5)" class="p-3 bg-green-50 text-green-800 font-bold rounded-lg text-sm border border-green-200 hover:bg-green-100">+5</button>
                    <button onclick="handleAddExtra('ext', 6)" class="p-3 bg-green-50 text-green-800 font-bold rounded-lg text-sm border border-green-200 hover:bg-green-100">+6</button>
                </div>
            </div>

            <div>
                <p class="text-xs font-bold text-red-600 uppercase mb-2">Penalty Runs (-)</p>
                <div class="grid grid-cols-6 gap-2">
                    <button onclick="handleAddExtra('pen', -1)" class="p-3 bg-red-50 text-red-800 font-bold rounded-lg text-sm border border-red-200 hover:bg-red-100">-1</button>
                    <button onclick="handleAddExtra('pen', -2)" class="p-3 bg-red-50 text-red-800 font-bold rounded-lg text-sm border border-red-200 hover:bg-red-100">-2</button>
                    <button onclick="handleAddExtra('pen', -3)" class="p-3 bg-red-50 text-red-800 font-bold rounded-lg text-sm border border-red-200 hover:bg-red-100">-3</button>
                    <button onclick="handleAddExtra('pen', -4)" class="p-3 bg-red-50 text-red-800 font-bold rounded-lg text-sm border border-red-200 hover:bg-red-100">-4</button>
                    <button onclick="handleAddExtra('pen', -5)" class="p-3 bg-red-50 text-red-800 font-bold rounded-lg text-sm border border-red-200 hover:bg-red-100">-5</button>
                    <button onclick="handleAddExtra('pen', -6)" class="p-3 bg-red-50 text-red-800 font-bold rounded-lg text-sm border border-red-200 hover:bg-red-100">-6</button>
                </div>
            </div>
        </div>
    </div>

    <div id="pair-change-modal" class="modal-overlay fixed inset-0 bg-black/70 hidden z-50 flex items-center justify-center">
        <div class="modal-content bg-white rounded-xl p-6 w-80 text-center">
            <h3 class="text-xl font-bold text-blue-800 mb-2">Skin Complete!</h3>
            <p class="text-sm text-gray-600 mb-4">Time to swap the batting pair.</p>
            <button onclick="performPairSwap()" class="w-full py-3 bg-blue-600 text-white font-bold rounded-lg shadow-lg">Select New Pair</button>
        </div>
    </div>

    <div id="innings-break-modal" class="modal-overlay fixed inset-0 bg-slate-900/95 hidden z-[100] flex items-center justify-center text-white backdrop-blur-sm">
        <div class="text-center w-full max-w-3xl p-4">
            <h2 class="text-sm font-bold tracking-[0.3em] text-blue-400 mb-8 uppercase animate-pulse">Innings Break</h2>
            
            <div class="bg-gradient-to-b from-blue-800 to-blue-900 rounded-3xl p-8 md:p-12 border border-blue-700 shadow-2xl relative overflow-hidden">
                <div class="absolute top-0 left-1/2 -translate-x-1/2 w-64 h-64 bg-blue-500/20 rounded-full blur-3xl pointer-events-none"></div>

                <div class="relative z-10">
                    <div class="mb-2 text-blue-200 text-xs font-bold uppercase tracking-wider">First Innings Score</div>
                    <h1 id="ib-batting-team" class="text-3xl md:text-5xl font-black mb-2 uppercase text-white drop-shadow-md tracking-tight">TEAM NAME</h1>
                    
                    <div class="text-6xl md:text-8xl font-black text-white mb-2 tracking-tighter" style="text-shadow: 0 4px 0px rgba(0,0,0,0.3);">
                        <span id="ib-score">0</span><span class="text-4xl text-blue-400 mx-1">/</span><span id="ib-wickets">0</span>
                    </div>
                    
                    <div class="inline-flex items-center gap-2 bg-blue-950/50 px-4 py-1.5 rounded-full border border-blue-800 mb-8">
                        <span class="text-blue-300 text-xs font-bold uppercase">Overs Bowled</span>
                        <span id="ib-overs" class="text-white font-mono font-bold">0.0</span>
                    </div>

                    <div class="w-full h-px bg-gradient-to-r from-transparent via-blue-400/30 to-transparent my-6"></div>

                    <div class="flex flex-col items-center">
                        <span class="text-xs font-bold text-yellow-400 uppercase tracking-[0.2em] mb-1">Target to Win</span>
                        <span id="ib-target" class="text-5xl md:text-7xl font-black text-white">0</span>
                    </div>
                </div>
            </div>

            <button onclick="startSecondInnings()" class="mt-8 px-12 py-4 bg-white text-blue-900 font-black text-lg rounded-full shadow-[0_0_20px_rgba(255,255,255,0.3)] hover:scale-105 active:scale-95 transition-all uppercase tracking-wider">
                Start 2nd Innings ‚Üí
            </button>
        </div>
    </div>

    <div id="match-summary-modal" class="fixed inset-0 z-[100] hidden bg-gradient-to-br from-indigo-900 via-purple-900 to-blue-900 overflow-y-auto">
    <div class="absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none">
        <div class="absolute top-[-10%] left-[-10%] w-96 h-96 bg-purple-500 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob"></div>
        <div class="absolute top-[-10%] right-[-10%] w-96 h-96 bg-yellow-500 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob animation-delay-2000"></div>
        <div class="absolute bottom-[-20%] left-[20%] w-96 h-96 bg-pink-500 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob animation-delay-4000"></div>
    </div>

    <div class="relative z-10 min-h-screen flex flex-col items-center justify-center p-4 md:p-8">
        
        <div class="text-center mb-8 animate-pop">
            <h2 class="text-xs font-bold text-yellow-300 tracking-[0.3em] uppercase mb-2">Match Result</h2>
            <h1 id="summary-winner-text" class="text-5xl md:text-7xl font-black text-transparent bg-clip-text bg-gradient-to-r from-yellow-200 via-yellow-400 to-yellow-200 drop-shadow-sm uppercase leading-tight">
                WINNER
            </h1>
            <div id="summary-margin-text" class="inline-block mt-2 px-4 py-1 bg-white/10 backdrop-blur-md rounded-full border border-white/20 text-white font-bold tracking-wider text-sm">
                WON BY ...
            </div>
        </div>

        <div class="w-full max-w-4xl grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
            <div id="card-t1" class="bg-white/10 backdrop-blur-lg border border-white/20 rounded-2xl p-6 flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div id="sum-t1-logo" class="w-16 h-16 rounded-full bg-white/20 shadow-lg flex items-center justify-center text-xl font-black text-white overflow-hidden"></div>
                    <div>
                        <h3 id="sum-t1-name" class="text-white/70 font-bold uppercase text-xs tracking-widest">TEAM 1</h3>
                        <div id="sum-t1-score" class="text-3xl font-black text-white">0/0</div>
                    </div>
                </div>
                <div id="sum-t1-overs" class="text-right text-white/50 font-mono font-bold">0.0</div>
            </div>

            <div id="card-t2" class="bg-white/10 backdrop-blur-lg border border-white/20 rounded-2xl p-6 flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div id="sum-t2-logo" class="w-16 h-16 rounded-full bg-white/20 shadow-lg flex items-center justify-center text-xl font-black text-white overflow-hidden"></div>
                    <div>
                        <h3 id="sum-t2-name" class="text-white/70 font-bold uppercase text-xs tracking-widest">TEAM 2</h3>
                        <div id="sum-t2-score" class="text-3xl font-black text-white">0/0</div>
                    </div>
                </div>
                <div id="sum-t2-overs" class="text-right text-white/50 font-mono font-bold">0.0</div>
            </div>
        </div>

        <div class="w-full max-w-4xl grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            
            <div class="bg-black/20 backdrop-blur-md rounded-2xl p-5 border border-white/10">
                <h4 class="text-yellow-400 font-black uppercase text-xs tracking-widest mb-4 flex items-center gap-2">
                    <span>üèè</span> Top Batters
                </h4>
                <div id="sum-top-batters" class="space-y-3"></div>
            </div>

            <div class="bg-black/20 backdrop-blur-md rounded-2xl p-5 border border-white/10">
                <h4 class="text-blue-400 font-black uppercase text-xs tracking-widest mb-4 flex items-center gap-2">
                    <span>‚öæ</span> Top Bowlers
                </h4>
                <div id="sum-top-bowlers" class="space-y-3"></div>
            </div>

            <div class="bg-gradient-to-b from-yellow-500/20 to-orange-500/20 backdrop-blur-md rounded-2xl p-5 border border-yellow-500/30">
                <h4 class="text-white font-black uppercase text-xs tracking-widest mb-4 flex items-center gap-2">
                    <span>üèÜ</span> Man of the Match
                </h4>
                <div id="sum-pom-list" class="space-y-2 max-h-48 overflow-y-auto custom-scroll"></div>
            </div>
        </div>

        <div class="flex flex-col md:flex-row gap-4 w-full max-w-xl">
            <button onclick="broadcastMatchResult()" class="flex-1 py-4 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-400 hover:to-emerald-500 text-white font-black uppercase tracking-wider rounded-xl shadow-lg shadow-green-900/50 transition-all active:scale-95 flex items-center justify-center gap-2">
                <span>üì° Broadcast Result</span>
            </button>
            <div class="flex gap-2 flex-1">
                <button onclick="closeModal('match-summary-modal')" class="flex-1 py-4 bg-white/10 hover:bg-white/20 text-white font-bold uppercase rounded-xl border border-white/10">
                    Close
                </button>
                <button onclick="location.reload()" class="flex-1 py-4 bg-blue-600 hover:bg-blue-500 text-white font-bold uppercase rounded-xl shadow-lg">
                    New Match
                </button>
            </div>
        </div>

    </div>
</div>

    <script>
        // --- ADD THIS FUNCTION TO YOUR CONTROLLER SCRIPT (51 - .html) ---

function broadcastMatchResult() {
    if (!broadcastId) {
        alert("Broadcast not active! Generate a code first.");
        return;
    }

    const t1 = state.team1;
    const t2 = state.team2;
    let resultMain = "MATCH TIED";
    let resultSub = "Scores Level";

    // 1. Calculate Winner Text
    if (t1.score > t2.score) {
        resultMain = `${t1.name} WINS`;
        resultSub = `WON BY ${t1.score - t2.score} RUNS`;
    } else if (t2.score > t1.score) {
        resultMain = `${t2.name} WINS`;
        const wicketsLeft = (state.playersPerSide - 1) - (t2.wickets || 0); 
        resultSub = `WON BY ${Math.max(1, wicketsLeft)} WICKETS`;
    }

    // 2. Get Man of the Match from Radio Button
    const pomId = document.querySelector('input[name="pom"]:checked')?.value;
    let pomData = null;
    if (pomId) {
        let p = state.team1.playerStats[pomId] || state.team2.playerStats[pomId];
        if (p) {
            pomData = { 
                name: p.name, 
                stats: `${p.runs} Runs ‚Ä¢ ${p.wickets} Wickets` 
            };
        }
    }

    // 3. Prepare Top Stats Lists
    const allPlayers = [];
    ['team1', 'team2'].forEach(tk => {
        Object.values(state[tk].playerStats).forEach(p => {
            p.teamName = state[tk].name;
            allPlayers.push(p);
        });
    });

    const topBatters = [...allPlayers].sort((a,b) => b.runs - a.runs).slice(0, 3).map(p => ({
        name: p.name, team: p.teamName, runs: p.runs, balls: p.balls
    }));

    const topBowlers = [...allPlayers].sort((a,b) => (b.wickets - a.wickets) || (a.runsConceded - b.runsConceded)).slice(0, 3).map(p => ({
        name: p.name, team: p.teamName, wickets: p.wickets, runs: p.runsConceded, balls: p.ballsBowled
    }));

    // 4. Send to Firebase
    db.collection("live_matches").doc(broadcastId).set({
        matchStatus: "COMPLETE",
        showSquad: false,
        showBattingCard: false,
        showBowlingCard: false,
        showRunRate: false,
        resultMain: resultMain,
        resultSub: resultSub,
        
        // --- ADDED SCORE DATA ---
        resultT1: { 
            name: t1.name, 
            score: `${t1.score}/${t1.wickets}`, 
            overs: `${t1.overs}.${t1.balls}` 
        },
        resultT2: { 
            name: t2.name, 
            score: `${t2.score}/${t2.wickets}`, 
            overs: `${t2.overs}.${t2.balls}` 
        },
        // ------------------------

        pom: pomData,
        topBatters: topBatters,
        topBowlers: topBowlers
    }, { merge: true }).then(() => {
        alert("Result Broadcasted to Screen!");
    }).catch(err => console.error("Broadcast Error", err));
}
        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyBqcD59IAPpKqk98oDZkgzgkoVZ8b8LGgY",
            authDomain: "livecricketscoring-92087.firebaseapp.com",
            databaseURL: "https://livecricketscoring-92087-default-rtdb.firebaseio.com",
            projectId: "livecricketscoring-92087",
            storageBucket: "livecricketscoring-92087.firebasestorage.app",
            messagingSenderId: "522927197627",
            appId: "1:522927197627:web:f1df5db736cae96893089e"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- DOM Elements ---
        const ui = {
            venueInput: document.getElementById('venue'),
            matchDateInput: document.getElementById('match-date-input'),
            totalOversInput: document.getElementById('total-overs'),
            playersPerSideInput: document.getElementById('players-per-side'),
            team1NameInput: document.getElementById('team1-name-input'),
            team2NameInput: document.getElementById('team2-name-input'),
            team1LogoInput: document.getElementById('team1-logo-input'),
            team2LogoInput: document.getElementById('team2-logo-input'),
            team1RosterTitle: document.getElementById('team1-roster-title'),
            team2RosterTitle: document.getElementById('team2-roster-title'),
            progressBar: document.getElementById('progress-bar'),
            tossTeam1Name: document.getElementById('toss-team1-name'),
            tossTeam2Name: document.getElementById('toss-team2-name'),
            tossTeam1LogoContainer: document.getElementById('toss-team1-logo-container'),
            tossTeam2LogoContainer: document.getElementById('toss-team2-logo-container'),
            tossWinnerTeam1: document.getElementById('toss-winner-team1'),
            tossWinnerTeam2: document.getElementById('toss-winner-team2'),
            tossChoiceBat: document.getElementById('toss-choice-bat'),
            tossChoiceBowl: document.getElementById('toss-choice-bowl'),
            startMatchBtn: document.getElementById('start-match-btn')
        };

        // --- STATE & HISTORY ---
        let state = {
            rules: { wicketRuns: 5, wideRuns: 2, noBallRuns: 2, skins: false },
            team1: { name: "", logo: "", squad: [], playing: [], playerStats: {}, isLoaded: false },
            team2: { name: "", logo: "", squad: [], playing: [], playerStats: {}, isLoaded: false },
            battingTeam: 'team1', bowlingTeam: 'team2',
            striker: null, nonStriker: null, bowler: null,
            id: null, innings: 1, target: 0, totalOvers: 16, playersPerSide: 8,
            currentOver: [], history: []
        };
        
        let undoStack = []; 
        let editingBallIndex = null; // --- EDIT MODE CONTEXT ---

        let tossWinner = null, tossDecision = null;
        let broadcastId = null;
        let savedTeamsData = [];
        let isEditMatchMode = false;

        // --- INITIALIZATION ---
        window.onload = function() {
            const today = new Date();
            ui.matchDateInput.value = today.toISOString().split('T')[0];
            
            const oversSelect = document.getElementById('total-overs');
            const defOvers = document.createElement('option'); defOvers.value = ""; defOvers.text = "Select Overs..."; defOvers.selected = true; defOvers.disabled = true;
            oversSelect.appendChild(defOvers);
            for(let i=3; i<=15; i++) {
                const opt = document.createElement('option'); opt.value = i; opt.text = i + ' Overs';
                oversSelect.appendChild(opt);
            }

            const playersSelect = document.getElementById('players-per-side');
            const defPlayers = document.createElement('option'); defPlayers.value = ""; defPlayers.text = "Select Players..."; defPlayers.selected = true; defPlayers.disabled = true;
            playersSelect.appendChild(defPlayers);
            for(let i=4; i<=11; i++) {
                const opt = document.createElement('option'); opt.value = i; opt.text = i + ' Players';
                playersSelect.appendChild(opt);
            }
            
            const wicketSelect = document.getElementById('rule-wicket');
            for(let i=0; i<=6; i++) {
                const opt = document.createElement('option'); 
                opt.value = i; 
                opt.text = (i === 0) ? "No Penalty (0)" : `-${i} Runs`;
                wicketSelect.appendChild(opt);
            }

            loadSavedTeams();
            showScreen('setup-screen');
        };

        function showScreen(id) {
            document.querySelectorAll('body > div').forEach(d => {
                if(d.id !== 'splash-screen' && !d.classList.contains('modal-overlay')) d.classList.add('hidden');
            });
            const el = document.getElementById(id);
            if(el) { el.classList.remove('hidden'); if(id==='app') el.classList.add('flex'); }
        }
        function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function closeModal(id) { 
            document.getElementById(id).classList.add('hidden'); 
            if(id !== 'bowler-edit-modal' && id !== 'player-modal' && editingBallIndex === null) {
                // Keep editingBallIndex active if inside the bowler edit flow
            }
        }
        
        function openWicketModal() { openModal('wicket-type-modal'); }
        function openViewControlModal() { openModal('broadcast-control-modal'); } // ADDED MISSING FUNCTION

        function generateUniqueId() { return 'p_' + Math.random().toString(36).substr(2, 9); }

        function getTeamInitials(name) {
            if (!name) return '??';
            const parts = name.trim().split(/\s+/);
            if (parts.length === 1) return name.substring(0, 2).toUpperCase();
            return parts.map(p => p[0]).join('').substring(0, 3).toUpperCase();
        }

        // --- DATA LOADING & SETUP LOGIC ---
        function loadSavedTeams() {
            db.collection("teams").orderBy("updatedAt", "desc").get().then((querySnapshot) => {
                savedTeamsData = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const players = (data.players || []).map(p => typeof p === 'string' ? { name: p } : p);
                    savedTeamsData.push({ id: doc.id, name: data.name, logo: data.logo, players: players });
                });
                populateTeamDropdowns();
            });
        }
        function populateTeamDropdowns() {
            ['team1-select', 'team2-select'].forEach(id => {
                const select = document.getElementById(id);
                select.innerHTML = '<option value="">+ Load Saved Team</option>';
                savedTeamsData.forEach(team => {
                    const opt = document.createElement('option');
                    opt.value = team.name;
                    opt.textContent = team.name;
                    select.appendChild(opt);
                });
                select.onchange = (e) => handleTeamSelection(e.target.value, id.includes('team1') ? 'team1' : 'team2');
            });
        }
        function handleTeamSelection(teamName, teamKey) {
    if(!teamName) return;
    const teamData = savedTeamsData.find(t => t.name === teamName);
    if(!teamData) return;
    
    // Set Input Value
    document.getElementById(`${teamKey}-name-input`).value = teamData.name;
    
    // Update State
    state[teamKey].name = teamData.name;
    state[teamKey].logo = teamData.logo || '';
    state[teamKey].squad = teamData.players.map(p => ({...p, id: generateUniqueId()}));
    state[teamKey].isLoaded = true;

    // NEW: Show Logo Preview
    const previewEl = document.getElementById(`${teamKey}-logo-preview`);
    if (state[teamKey].logo) {
        previewEl.src = state[teamKey].logo;
        previewEl.classList.remove('hidden');
    } else {
        previewEl.classList.add('hidden');
    }
}
        function handleLogoUpload(file, teamKey) {
    if (file) {
        const reader = new FileReader();
        reader.onload = (e) => { 
            state[teamKey].logo = e.target.result;
            
            // NEW: Update Preview Immediately
            const previewEl = document.getElementById(`${teamKey}-logo-preview`);
            previewEl.src = e.target.result;
            previewEl.classList.remove('hidden');
        };
        reader.readAsDataURL(file);
    }
}

        function goToStep(step) {
            if (step === 2) {
                const overs = document.getElementById('total-overs').value;
                const players = document.getElementById('players-per-side').value;
                const w = document.getElementById('rule-wicket').value;
                const wd = document.getElementById('rule-wide').value;
                const nb = document.getElementById('rule-noball').value;

                if (!overs || !players) {
                    alert("‚ö†Ô∏è MANDATORY: Please select Overs and Players per Side.");
                    return;
                }
                if (!w || !wd || !nb) {
                    alert("‚ö†Ô∏è MANDATORY: Please select Wicket Penalty, Wide, and No Ball rules to proceed.");
                    return;
                }

                state.rules.wicketRuns = parseInt(w);
                state.rules.wideRuns = parseInt(wd);
                state.rules.noBallRuns = parseInt(nb);
                state.rules.skins = false; 

                const t1Name = ui.team1NameInput.value.trim() || 'HOME TEAM';
                const t2Name = ui.team2NameInput.value.trim() || 'AWAY TEAM';

                if (!state.team1.isLoaded) {
                    state.team1.name = t1Name.toUpperCase();
                    handleLogoUpload(ui.team1LogoInput.files[0], 'team1');
                }
                if (!state.team2.isLoaded) {
                    state.team2.name = t2Name.toUpperCase();
                    handleLogoUpload(ui.team2LogoInput.files[0], 'team2');
                }

                ui.team1RosterTitle.textContent = state.team1.name;
                document.getElementById('team1-roster-logo').src = state.team1.logo || 'https://placehold.co/60x60/3b82f6/white?text=H';
                ui.team2RosterTitle.textContent = state.team2.name;
                document.getElementById('team2-roster-logo').src = state.team2.logo || 'https://placehold.co/60x60/64748b/white?text=A';
                generateUnifiedRoster('team1');
                generateUnifiedRoster('team2');
            }

            document.querySelectorAll('.setup-step').forEach(s => { s.classList.remove('active'); s.classList.add('hidden'); });
            const next = document.getElementById(`setup-step-${step}`);
            next.classList.remove('hidden');
            setTimeout(() => next.classList.add('active'), 10);
            
            ui.progressBar.style.width = `${step * 33}%`;

            if(step === 4) {
                if(isEditMatchMode) {
                    saveEditChanges();
                    return;
                }

                ui.tossTeam1Name.textContent = state.team1.name;
                if (state.team1.logo) {
                    ui.tossTeam1LogoContainer.innerHTML = `<img src="${state.team1.logo}" class="w-full h-full object-cover rounded-full border-2 border-white shadow-sm">`;
                    ui.tossTeam1LogoContainer.style.backgroundColor = 'transparent';
                } else {
                    ui.tossTeam1LogoContainer.style.backgroundColor = '#3b82f6';
                    ui.tossTeam1LogoContainer.innerHTML = `<span class="text-xl font-bold text-white tracking-wider">${getTeamInitials(state.team1.name)}</span>`;
                }
                ui.tossTeam2Name.textContent = state.team2.name;
                if (state.team2.logo) {
                    ui.tossTeam2LogoContainer.innerHTML = `<img src="${state.team2.logo}" class="w-full h-full object-cover rounded-full border-2 border-white shadow-sm">`;
                    ui.tossTeam2LogoContainer.style.backgroundColor = 'transparent';
                } else {
                    ui.tossTeam2LogoContainer.style.backgroundColor = '#ef4444'; 
                    ui.tossTeam2LogoContainer.innerHTML = `<span class="text-xl font-bold text-white tracking-wider">${getTeamInitials(state.team2.name)}</span>`;
                }
            }
        }

        function generateUnifiedRoster(teamKey) {
            const container = document.getElementById(`${teamKey}-player-inputs`);
            const countBadge = document.getElementById(`${teamKey}-count-badge`);
            container.innerHTML = '';
            const required = parseInt(ui.playersPerSideInput.value);
            
            if (state[teamKey].squad.length < required) {
                for(let i = state[teamKey].squad.length; i < required; i++) {
                    state[teamKey].squad.push({ id: generateUniqueId(), name: '', image: '' });
                }
            }

            let selectedCount = 0;
            
            state[teamKey].squad.forEach((player, index) => {
                const isSelected = state[teamKey].playing.length > 0 ? state[teamKey].playing.includes(player.id) : index < required;
                
                if (isSelected) {
                    if (!state[teamKey].playing.includes(player.id)) state[teamKey].playing.push(player.id);
                    selectedCount++;
                }

                const isCaptain = state[teamKey].captainId === player.id;

                const row = document.createElement('div');
                row.className = `roster-row ${isSelected ? 'selected' : ''}`;
                
                row.innerHTML = `
                    <div class="flex items-center gap-2">
                        <input type="checkbox" class="w-5 h-5 text-blue-600 rounded" 
                            onchange="togglePlayerSelection(this, '${teamKey}', '${player.id}')" ${isSelected ? 'checked' : ''}>
                        
                        <button onclick="setCaptain('${teamKey}', '${player.id}')" 
                            class="w-6 h-6 rounded-full text-[10px] font-bold border flex items-center justify-center transition-colors ${isCaptain ? 'bg-yellow-400 text-black border-yellow-500' : 'bg-gray-100 text-gray-400 border-gray-300'}" 
                            title="Set as Captain">
                            C
                        </button>
                    </div>

                    <div class="flex items-center gap-2 overflow-hidden">
                        <div class="relative group cursor-pointer" onclick="triggerImageUpload('${teamKey}', '${player.id}')">
                            <img id="img-${player.id}" src="${player.image || 'https://placehold.co/40x40/e2e8f0/gray?text=P'}" class="w-8 h-8 rounded-full border object-cover">
                            <div class="absolute inset-0 bg-black/50 hidden group-hover:flex items-center justify-center rounded-full">
                                <span class="text-[8px] text-white">üì∑</span>
                            </div>
                        </div>
                        
                        <input type="text" value="${player.name}" class="roster-input" 
                            onchange="updatePlayerName(this.value, '${teamKey}', '${player.id}')" placeholder="Player Name">
                    </div>

                    <button onclick="deletePlayerFromRoster('${teamKey}', '${player.id}')" class="text-gray-400 hover:text-red-500">üóëÔ∏è</button>
                    
                    <input type="file" id="file-${player.id}" class="hidden" accept="image/*" onchange="uploadPlayerImage(this, '${teamKey}', '${player.id}')">
                `;
                container.appendChild(row);
            });
            countBadge.textContent = `${selectedCount} / ${required} Playing`;
        }

        function updatePlayerName(newName, teamKey, playerId) {
            const player = state[teamKey].squad.find(p => p.id === playerId);
            if(player) player.name = newName.toUpperCase();
        }

        function togglePlayerSelection(checkbox, teamKey, playerId) {
            const row = checkbox.closest('.roster-row');
            const limit = parseInt(ui.playersPerSideInput.value); 

            if (checkbox.checked) {
                if (state[teamKey].playing.length >= limit) {
                    checkbox.checked = false; 
                    row.classList.add('bg-red-100', 'border-red-500'); 
                    setTimeout(() => {
                        row.classList.remove('bg-red-100', 'border-red-500');
                    }, 800);
                    return; 
                }
                row.classList.add('selected');
                if (!state[teamKey].playing.includes(playerId)) state[teamKey].playing.push(playerId);
            } else {
                row.classList.remove('selected');
                state[teamKey].playing = state[teamKey].playing.filter(id => id !== playerId);
            }
            generateUnifiedRoster(teamKey); 
        }

        function deletePlayerFromRoster(teamKey, playerId) {
            if(confirm("Delete player?")) {
                state[teamKey].squad = state[teamKey].squad.filter(p => p.id !== playerId);
                state[teamKey].playing = state[teamKey].playing.filter(id => id !== playerId);
                generateUnifiedRoster(teamKey);
            }
        }
        function addNewPlayerToRoster(teamKey) {
            const newId = generateUniqueId();
            state[teamKey].squad.push({ id: newId, name: '', image: '' });
            generateUnifiedRoster(teamKey);
        }
        function proceedFromUnifiedRoster() {
            const required = parseInt(ui.playersPerSideInput.value);
            if (state.team1.playing.length !== required) { alert(`Home Team needs exactly ${required} players.`); return; }
            if (state.team2.playing.length !== required) { alert(`Away Team needs exactly ${required} players.`); return; }
            
            if (!isEditMatchMode) {
                ['team1', 'team2'].forEach(key => {
                    state[key].playerStats = {};
                    state[key].playing.forEach(pid => {
                        const p = state[key].squad.find(sq => sq.id === pid);
                        const pName = p && p.name ? p.name : "Player " + pid.substr(0,4);
                        state[key].playerStats[pid] = { id: pid, name: pName, runs: 0, balls: 0, wickets: 0, runsConceded: 0, ballsBowled: 0 };
                    });
                });
            }
            goToStep(4);
        }

        // --- EDIT MATCH MODE LOGIC ---
        function openEditMatchMode() {
            isEditMatchMode = true;
            document.getElementById('setup-title').textContent = "Edit Match Settings";
            document.getElementById('btn-roster-confirm').textContent = "Confirm Changes ‚Üí";
            showScreen('setup-screen');
            goToStep(1);
        }

        function saveEditChanges() {
            state.totalOvers = parseInt(ui.totalOversInput.value);
            state.playersPerSide = parseInt(ui.playersPerSideInput.value);
            state.venue = ui.venueInput.value;
            alert("Match Settings Updated!");
            isEditMatchMode = false;
            updateMatchHeader();
            updateScoreboard();
            syncToLiveDB();
            showScreen('app');
        }

        // --- TOSS & BROADCAST LOGIC ---
        function selectTossWinner(w) {
            tossWinner = w;
            document.querySelectorAll('.toss-card-btn').forEach(b => b.classList.remove('selected'));
            document.getElementById(`toss-winner-${w}`).classList.add('selected');
            checkStartReady();
        }

        function selectTossChoice(c) {
            tossDecision = c;
            document.querySelectorAll('.decision-btn').forEach(b => b.classList.remove('selected'));
            document.getElementById(`toss-choice-${c}`).classList.add('selected');
            checkStartReady();
        }

        function generateBroadcastCode() {
            broadcastId = Math.floor(1000 + Math.random() * 9000).toString();
            const display = document.getElementById('broadcast-display');
            const codeBox = document.getElementById('match-code-box');
            display.classList.remove('hidden');
            codeBox.textContent = broadcastId;
            const btn = document.getElementById('btn-broadcast-enable');
            btn.classList.remove('bg-blue-50', 'text-blue-700');
            btn.classList.add('bg-green-100', 'text-green-800', 'border-green-300');
            btn.innerHTML = `<span class="text-lg">‚úÖ BROADCAST LIVE</span><span class="text-xs font-normal">Code: ${broadcastId}</span>`;
            syncToLiveDB();
            checkStartReady();
        }
        
        function checkStartReady() {
            const btn = document.getElementById('start-match-btn');
            if(tossWinner && tossDecision && broadcastId) {
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed', 'bg-gray-300');
                btn.classList.add('bg-blue-600', 'hover:bg-blue-700', 'shadow-lg');
            } else {
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed', 'bg-gray-300');
                btn.classList.remove('bg-blue-600', 'hover:bg-blue-700', 'shadow-lg');
            }
        }

        function copyBroadcastLink() {
            const code = document.getElementById('match-code-box').textContent;
            navigator.clipboard.writeText(code).then(() => {
                const fb = document.getElementById('copy-feedback');
                fb.classList.remove('hidden');
                setTimeout(() => fb.classList.add('hidden'), 2000);
            });
        }

        // --- ADDED MISSING TOGGLE FUNCTION ---
        function toggleView(viewName, toggleEl) {
    if(!broadcastId) return;
    let updateData = {};
    
    // Simple toggle logic:
    if(viewName === 'SQUAD') updateData = { showSquad: toggleEl.checked };
    else if(viewName === 'BATTING') updateData = { showBattingCard: toggleEl.checked };
    else if(viewName === 'BOWLING') updateData = { showBowlingCard: toggleEl.checked };
    else if(viewName === 'RUN_RATE') updateData = { showRunRate: toggleEl.checked }; // <--- ADDED THIS LINE

    db.collection("live_matches").doc(broadcastId).set(updateData, { merge: true });
}

        function syncToLiveDB(lastAction = null) {
            if (!broadcastId) return;

            const bt = state[state.battingTeam];
            const bl = state[state.bowlingTeam];
            const striker = state.striker || { name: "", runs: 0, balls: 0 };
            const nonStriker = state.nonStriker || { name: "", runs: 0, balls: 0 };
            const bowler = state.bowler || { name: "", wickets: 0, runsConceded: 0, ballsBowled: 0 };

            const t1Obj = state.team1;
            const t2Obj = state.team2;
            const t1CapPlayer = t1Obj.squad.find(p => p.id === t1Obj.captainId);
            const t2CapPlayer = t2Obj.squad.find(p => p.id === t2Obj.captainId);

            // --- GENERATE SQUAD LISTS ---
            const getSquadList = (teamObj) => {
                return teamObj.playing.map(pid => {
                    const p = teamObj.squad.find(s => s.id === pid);
                    return p ? p.name : "";
                }).filter(n => n !== "");
            };

            // --- GENERATE BATTING CARD ---
            const getBattingCard = () => {
                const team = state[state.battingTeam];
                let list = [];
                // Loop through all playing members to find those with stats
                team.playing.forEach(pid => {
                    const p = team.playerStats[pid];
                    // Include if: has faced balls OR has runs OR is out OR is currently at crease
                    if (p && (p.balls > 0 || p.runs > 0 || p.dismissal || (state.striker && p.id === state.striker.id) || (state.nonStriker && p.id === state.nonStriker.id))) {
                        let status = "not out";
                        if (p.dismissal) status = p.dismissal.toUpperCase();
                        else if (state.striker && p.id === state.striker.id) status = "BATTING *";
                        else if (state.nonStriker && p.id === state.nonStriker.id) status = "BATTING";
                        
                        list.push({
                            name: p.name,
                            runs: p.runs,
                            balls: p.balls,
                            status: status
                        });
                    }
                });
                return list;
            };

            // --- GENERATE BOWLING CARD ---
            const getBowlingCard = () => {
                const team = state[state.bowlingTeam];
                let list = [];
                team.playing.forEach(pid => {
                    const p = team.playerStats[pid];
                    if (p && p.ballsBowled > 0) {
                        const overs = Math.floor(p.ballsBowled / 6) + '.' + (p.ballsBowled % 6);
                        const econ = (p.runsConceded / (p.ballsBowled/6 || 1)).toFixed(1);
                        list.push({
                            name: p.name,
                            o: overs,
                            m: 0, // Maidens not currently tracked in simple state, defaulting to 0
                            r: p.runsConceded,
                            w: p.wickets,
                            e: econ
                        });
                    }
                });
                return list;
            };

            const payload = {
                venue: state.venue || document.getElementById('venue').value || "Unknown Ground",
                matchDate: document.getElementById('match-date-input').value || new Date().toDateString(),
                t1: t1Obj.name,
                t1Logo: t1Obj.logo || null,
                t1CaptainImg: t1CapPlayer ? t1CapPlayer.image : null, 
                
                squad1: getSquadList(t1Obj),
                squad2: getSquadList(t2Obj),

                // --- NEW: SEND CARDS TO DATABASE ---
                battingCard: getBattingCard(),
                bowlingCard: getBowlingCard(),
                // -----------------------------------

                t2: t2Obj.name,
                t2Logo: t2Obj.logo || null,
                t2CaptainImg: t2CapPlayer ? t2CapPlayer.image : null,
                score: bt.score || 0,
                wickets: bt.wickets || 0,
                overs: bt.overs || 0,
                balls: bt.balls || 0,
                target: state.target || 0, 
                totalOvers: state.totalOvers || 0,
                playersPerSide: state.playersPerSide || 0,
                striker: { name: striker.name, runs: striker.runs, balls: striker.balls },
                nonStriker: { name: nonStriker.name, runs: nonStriker.runs, balls: nonStriker.balls },
                bowler: { name: bowler.name, wkts: bowler.wickets, runs: bowler.runsConceded, balls: bowler.ballsBowled }, 
                currentOver: state.currentOver.map(b => b.event), 
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };

            if (lastAction) payload.lastAction = { id: Date.now(), type: lastAction };

            db.collection("live_matches").doc(broadcastId).set(payload, { merge: true })
                .catch(err => console.error("Sync Error:", err));
        }

        function startMatch() {
            state.totalOvers = parseInt(ui.totalOversInput.value);
            state.playersPerSide = parseInt(ui.playersPerSideInput.value);
            state.venue = ui.venueInput.value;

            state.team1.score = 0; state.team1.wickets = 0; state.team1.overs = 0; state.team1.balls = 0;
            state.team2.score = 0; state.team2.wickets = 0; state.team2.overs = 0; state.team2.balls = 0;

            if ((tossWinner === 'team1' && tossDecision === 'bat') || (tossWinner === 'team2' && tossDecision === 'bowl')) {
                state.battingTeam = 'team1'; state.bowlingTeam = 'team2';
            } else {
                state.battingTeam = 'team2'; state.bowlingTeam = 'team1';
            }

            syncToLiveDB();

            state.rules.wicketRuns = parseInt(document.getElementById('rule-wicket').value); 
            
            document.getElementById('btn-wicket').textContent = `WKT (-${state.rules.wicketRuns})`;
            document.getElementById('wicket-modal-title').textContent = `WICKET! (-${state.rules.wicketRuns} Runs)`;
            
            const wVal = state.rules.wideRuns;
            const nbVal = state.rules.noBallRuns;

            let wButtons = `<button onclick="handleAddExtra('wd', ${wVal})" class="col-span-3 p-4 bg-blue-100 text-blue-900 font-bold rounded-xl mb-1">Standard (+${wVal})</button>`;
            [3, 4, 5, 6].forEach(r => {
                if (r !== wVal) wButtons += `<button onclick="handleAddExtra('wd', ${r})" class="p-4 bg-gray-100 font-bold rounded-xl">+${r}</button>`;
            });
            document.getElementById('wide-options').innerHTML = wButtons;

            let nbButtons = `<button onclick="handleAddExtra('nb', ${nbVal})" class="col-span-3 p-4 bg-blue-100 text-blue-900 font-bold rounded-xl mb-1">Standard (+${nbVal})</button>`;
            [3, 4, 5, 6].forEach(r => {
                if (r !== nbVal) nbButtons += `<button onclick="handleAddExtra('nb', ${r})" class="p-4 bg-gray-100 font-bold rounded-xl">+${r}</button>`;
            });
            document.getElementById('noball-options').innerHTML = nbButtons;

            updateMatchHeader();
            updateScoreboard();
            showScreen('app');
            initInnings();
        }

        function updateMatchHeader() {
            const t1 = state.team1.name;
            const t2 = state.team2.name;
            const venue = (state.venue || 'Unknown Venue').toUpperCase();
            const dateObj = state.matchDate ? new Date(state.matchDate) : new Date();
            const dateStr = dateObj.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
            const subTitle = `${venue} | ${dateStr} | ${state.totalOvers} Overs | ${state.playersPerSide}-a-side`;

            let codeDisplay = "";
            if (typeof broadcastId !== 'undefined' && broadcastId) {
                codeDisplay = `<div class="absolute top-0 left-0 bg-blue-600 text-white text-[10px] font-bold px-2 py-1 rounded-br-lg shadow-sm z-50">üì° CODE: ${broadcastId}</div>`;
            }

            const headerHTML = `
                <div class="py-2 relative">
                    ${codeDisplay} <h1 class="text-xl sm:text-2xl font-black text-gray-900 uppercase tracking-tight leading-tight">${t1} <span class="text-gray-400 font-medium text-lg px-1">vs</span> ${t2}</h1>
                    <p class="text-xs sm:text-sm text-gray-500 font-medium mt-1 tracking-wide">${subTitle}</p>
                </div>
            `;
            document.getElementById('match-header').innerHTML = headerHTML;
        }

        function updateScoreboard() {
            const battingTeamKey = state.battingTeam;
            const bowlingTeamKey = state.bowlingTeam;
            const battingTeam = state[battingTeamKey];
            const bowlingTeam = state[bowlingTeamKey];

            const createTeamRow = (team, isBatting, isFirstInnings) => {
                const logoSrc = team.logo || '';
                const logoHTML = logoSrc ? `<img src="${logoSrc}" class="w-8 h-8 rounded-full object-cover border border-gray-200">` : `<div class="w-8 h-8 rounded-full flex items-center justify-center font-bold text-white text-xs" style="background-color: #3b82f6;">${getTeamInitials(team.name)}</div>`;
                let rightSideHTML = '';
                
                const score = team.score || 0;
                const wkts = team.wickets || 0;
                const overs = team.overs || 0;
                const balls = team.balls || 0;
                
                if (isBatting) {
                    rightSideHTML = `<div class="text-right"><div class="text-xl font-bold text-gray-900 leading-none">${score}/${wkts}</div><div class="text-xs text-gray-500 font-medium mt-0.5">(${overs}.${balls} / ${state.totalOvers} ov)</div></div>`;
                } else {
                    if (isFirstInnings) rightSideHTML = `<div class="text-sm font-bold text-gray-400 uppercase tracking-wide">Yet to bat</div>`;
                    else rightSideHTML = `<div class="text-right"><div class="text-lg font-bold text-gray-700 leading-none">${score}/${wkts}</div><div class="text-xs text-gray-400">(${overs}.${balls} ov)</div></div>`;
                }

                const containerClass = isBatting ? "flex items-center justify-between py-3 border-b border-gray-100 bg-white px-2" : "flex items-center justify-between py-3 bg-gray-50/50 opacity-60 px-2";
                const nameClass = isBatting ? "text-base font-black text-gray-800 uppercase tracking-tight" : "text-base font-bold text-gray-500 uppercase tracking-tight";

                return `<div class="${containerClass}"><div class="flex items-center gap-3">${logoHTML}<span class="${nameClass}">${team.name}</span></div>${rightSideHTML}</div>`;
            };

            const row1 = createTeamRow(battingTeam, true, state.innings === 1);
            const row2 = createTeamRow(bowlingTeam, false, state.innings === 1);
            document.getElementById('team-scores-container').innerHTML = row1 + row2;
        }

        function selectOpeningPair(callback) {
            const team = state.battingTeam;
            const sSelect = document.getElementById('pair-striker-select');
            const nsSelect = document.getElementById('pair-nonstriker-select');
            
            sSelect.innerHTML = '<option value="">Select Striker...</option>';
            nsSelect.innerHTML = '<option value="">Select Non-Striker...</option>';
            
            Object.keys(state[team].playerStats).forEach(pid => {
                const p = state[team].playerStats[pid];
                const optS = document.createElement('option');
                optS.value = p.id;
                optS.textContent = p.name;
                sSelect.appendChild(optS);

                const optNS = document.createElement('option');
                optNS.value = p.id;
                optNS.textContent = p.name;
                nsSelect.appendChild(optNS);
            });

            openModal('opening-pair-modal');
            state.pairSelectionCallback = callback;
        }

        function updatePairExclusions() {
            const sSelect = document.getElementById('pair-striker-select');
            const nsSelect = document.getElementById('pair-nonstriker-select');
            
            const sVal = sSelect.value;
            const nsVal = nsSelect.value;

            Array.from(nsSelect.options).forEach(opt => {
                if (opt.value === "") return;
                opt.disabled = (opt.value === sVal);
            });

            Array.from(sSelect.options).forEach(opt => {
                if (opt.value === "") return;
                opt.disabled = (opt.value === nsVal);
            });
        }

        function confirmOpeningPair() {
            const sVal = document.getElementById('pair-striker-select').value;
            const nsVal = document.getElementById('pair-nonstriker-select').value;
            
            if(!sVal || !nsVal || sVal === nsVal) {
                alert("Please select two different players.");
                return;
            }

            const team = state.battingTeam;
            state.striker = state[team].playerStats[sVal];
            state.nonStriker = state[team].playerStats[nsVal];
            
            closeModal('opening-pair-modal');
            if (state.pairSelectionCallback) state.pairSelectionCallback();
        }

        let pendingSelection = null; 

        function selectPlayer(role, callback) {
            pendingSelection = { role, callback };
            
            const select = document.getElementById('player-select');
            const title = document.getElementById('modal-title');
            select.innerHTML = ''; 

            let teamKey;
            let excludeIds = [];
            let previousBowlerId = null;

            if (role === 'bowler') {
                teamKey = state.bowlingTeam;
                title.textContent = "Select Next Bowler";
                if (state.bowler) {
                    previousBowlerId = state.bowler.id;
                }
            } else {
                teamKey = state.battingTeam;
                title.textContent = "Select New Batter";
                if (role === 'striker' && state.nonStriker) excludeIds.push(state.nonStriker.id);
                if (role === 'nonStriker' && state.striker) excludeIds.push(state.striker.id);
            }

            const roster = state[teamKey].playerStats;
            let count = 0;
            
            Object.values(roster).forEach(player => {
                if (!excludeIds.includes(player.id)) {
                    const opt = document.createElement('option');
                    opt.value = player.id;
                    opt.textContent = player.name;

                    if ((role === 'striker' || role === 'nonStriker') && player.dismissal) {
                        opt.disabled = true; 
                        opt.textContent += " (OUT)"; 
                        opt.style.color = "#9ca3af"; 
                        opt.style.backgroundColor = "#f3f4f6"; 
                    }

                    if (role === 'bowler' && player.id === previousBowlerId) {
                        opt.disabled = true;
                        opt.textContent += " (Just Bowled)";
                        opt.style.color = "#9ca3af";
                        opt.style.backgroundColor = "#f3f4f6";
                    }
                    
                    select.appendChild(opt);
                    count++;
                }
            });

            if (count === 0) {
                const opt = document.createElement('option');
                opt.textContent = "No players available";
                select.appendChild(opt);
            }

            const closeBtn = document.querySelector('#player-modal button[onclick="cancelPlayerSelection()"]');
            if(closeBtn) {
                if (window.correctionMode === true) {
                    closeBtn.style.display = 'block'; 
                } else {
                    closeBtn.style.display = 'none';  
                }
            }

            openModal('player-modal');
        }

        document.getElementById('player-save-btn').onclick = function() {
            if (!pendingSelection) return;

            const selectedId = document.getElementById('player-select').value;
            if (!selectedId || selectedId === "No players available") {
                closeModal('player-modal');
                return; 
            }

            const role = pendingSelection.role;
            const teamKey = (role === 'bowler') ? state.bowlingTeam : state.battingTeam;
            const newPlayer = state[teamKey].playerStats[selectedId];

            if (window.correctionMode) {
                const oldPlayer = state[role]; 
                if (oldPlayer && newPlayer.id !== oldPlayer.id) {
                    newPlayer.runs = (newPlayer.runs || 0) + (oldPlayer.runs || 0);
                    newPlayer.balls = (newPlayer.balls || 0) + (oldPlayer.balls || 0);
                    newPlayer.wickets = (newPlayer.wickets || 0) + (oldPlayer.wickets || 0);
                    newPlayer.runsConceded = (newPlayer.runsConceded || 0) + (oldPlayer.runsConceded || 0);
                    newPlayer.ballsBowled = (newPlayer.ballsBowled || 0) + (oldPlayer.ballsBowled || 0);

                    oldPlayer.runs = 0; oldPlayer.balls = 0;
                    oldPlayer.wickets = 0; oldPlayer.runsConceded = 0; oldPlayer.ballsBowled = 0;
                }
                window.correctionMode = false; 
            }

            if (role === 'bowler') { state.bowler = newPlayer; } 
            else if (role === 'striker') { state.striker = newPlayer; } 
            else if (role === 'nonStriker') { state.nonStriker = newPlayer; }

            closeModal('player-modal');
            if (pendingSelection.callback) pendingSelection.callback();
            
            pendingSelection = null;
            updateUI(); 
        };

        function initInnings() {
            selectOpeningPair(() => {
                selectPlayer('bowler', updateUI);
            });
        }

        // --- ENHANCED EVENT HANDLERS (NORMAL + EDIT SUPPORT) ---
        let tempWicketType = null;

        function handleWicketAction(type) {
            closeModal('wicket-type-modal');
            
            if (type === 'Run Out') {
                const btnS = document.getElementById('btn-ro-striker');
                const btnNS = document.getElementById('btn-ro-nonstriker');
                btnS.textContent = state.striker ? `${state.striker.name} (Striker)` : "Striker";
                btnNS.textContent = state.nonStriker ? `${state.nonStriker.name} (Non-Striker)` : "Non-Striker";
                openModal('runout-modal');
            } else {
                if (editingBallIndex !== null) {
                    // EDIT MODE: Apply specific wicket change
                    applyBallCorrection(editingBallIndex, 0, 'W');
                    // Reset
                    editingBallIndex = null;
                } else {
                    // NORMAL MODE
                    applyWicketPenalty('striker', type);
                }
            }
        }

        function handleAddExtra(type, runs) {
            if (editingBallIndex !== null) {
                // EDIT MODE
                closeModal('wide-modal'); closeModal('noball-modal'); closeModal('extras-modal');
                let label = type.toUpperCase();
                if (type === 'wd' || type === 'nb') {
                    if (runs > 1) { label = `${type.toUpperCase()}+${runs - 1}`; }
                } else if (type === 'pen' && runs < 0) {
                    label = `${runs}`;
                } else if (type === 'ext' && runs > 0) {
                    label = `+${runs}`;
                }
                applyBallCorrection(editingBallIndex, runs, label);
                editingBallIndex = null;
            } else {
                // NORMAL MODE
                addExtra(type, runs);
            }
        }

        function setupFielderSelect(type) {
            closeModal('wicket-type-modal');
            tempWicketType = type; 
            const select = document.getElementById('fielder-select');
            select.innerHTML = '';
            const title = document.getElementById('fielder-modal-title');
            title.textContent = (type === 'Catch') ? "Who took the Catch?" : "Who is the Keeper?";
            
            const roster = state[state.bowlingTeam].playerStats;
            Object.values(roster).forEach(player => {
                const opt = document.createElement('option');
                opt.value = player.name; 
                opt.textContent = player.name;
                select.appendChild(opt);
            });
            openModal('fielder-modal');
        }

        function confirmFielder() {
            const fielderName = document.getElementById('fielder-select').value;
            if(!fielderName) return;
            closeModal('fielder-modal');
            
            if (editingBallIndex !== null) {
                // Edit Mode: Just mark as Wicket (simplification for edit pad)
                applyBallCorrection(editingBallIndex, 0, 'W'); 
                editingBallIndex = null;
            } else {
                applyWicketPenalty('striker', tempWicketType, fielderName);
            }
        }

        function finalizeRunOut(who) {
            closeModal('runout-modal');
            if (editingBallIndex !== null) {
                applyBallCorrection(editingBallIndex, 0, 'W');
                editingBallIndex = null;
            } else {
                applyWicketPenalty(who, 'Run Out');
            }
        }

        function applyWicketPenalty(who, type, fielder = null) {
            addToHistory();
            const penalty = state.rules.wicketRuns;
            const bt = state[state.battingTeam];
            const bwl = state.bowler; 
            
            const roleKey = (who === 'nonstriker' || who === 'nonStriker') ? 'nonStriker' : 'striker';
            const victim = state[roleKey];

            let dismissalText = type; 
            if (victim) {
                if (type === 'Bowled' && bwl) dismissalText = `b. ${bwl.name}`;
                else if (type === 'LBW' && bwl) dismissalText = `lbw b. ${bwl.name}`;
                else if (type === 'Catch' && bwl) dismissalText = `c. ${fielder || 'Sub'} b. ${bwl.name}`;
                else if (type === 'Stumped' && bwl) dismissalText = `st. ${fielder || 'Keeper'} b. ${bwl.name}`;
                else if (type === 'Hit Wicket' && bwl) dismissalText = `hit wkt b. ${bwl.name}`;
                
                victim.dismissal = dismissalText; 
                victim.runs -= penalty; 
            }

            bt.score -= penalty;
            if (state.striker) { state.striker.balls++; }
            bt.wickets = (bt.wickets || 0) + 1;
            
            if (bwl && type !== 'Run Out' && type !== 'Retired Out' && type !== 'Other') { bwl.wickets++; }
            if (bwl) { bwl.ballsBowled++; }

            showEventPopup("OUT", "text-red-600");
            processBall(0, 'W', true);
            updateUI();

            if (victim && broadcastId) {
                setTimeout(() => {
                    const cardData = {
                        name: victim.name, score: victim.runs, balls: victim.balls,
                        howOut: dismissalText.toUpperCase(), teamLogo: state[state.battingTeam].logo
                    };
                    db.collection("live_matches").doc(broadcastId).set({ showDismissalCard: true, dismissalData: cardData }, { merge: true });
                    setTimeout(() => { db.collection("live_matches").doc(broadcastId).set({ showDismissalCard: false }, { merge: true }); }, 7000);
                }, 1500);
            }

            setTimeout(() => { selectPlayer(roleKey, updateUI); }, 1200);
        }

        function addToHistory() {
            undoStack.push(JSON.parse(JSON.stringify(state)));
        }

        function undoLastAction() {
            if (undoStack.length === 0) { alert("Nothing to undo!"); return; }
            state = undoStack.pop();
            closeModal('wicket-type-modal'); closeModal('wide-modal'); closeModal('noball-modal'); closeModal('extras-modal'); closeModal('runout-modal'); 
            updateScoreboard(); updateUI();
        }

        function addRuns(runs) {
            addToHistory();
            const bt = state[state.battingTeam];
            const str = state.striker;
            const bwl = state.bowler; 

            bt.score = (bt.score || 0) + runs;
            if (str) { str.runs += runs; str.balls++; }
            if (bwl) { bwl.runsConceded += runs; bwl.ballsBowled++; }

            if (state.innings === 2 && state.rules.wicketRuns === 0) {
                if (bt.score >= state.target) {
                    processBall(runs, `${runs}`, true);
                    updateUI(); setTimeout(endInnings, 100); return;
                }
            }

            if (runs === 4) showEventPopup("4", "text-blue-500");
            if (runs === 6) showEventPopup("6", "text-green-500");

            processBall(runs, `${runs}`, true);
            if(runs % 2 !== 0) swapStrikers();
            updateUI();
        }

        function showEventPopup(text, colorClass) {
            let animType = null;
            if (text === "4") animType = "4";
            if (text === "6") animType = "6";
            if (text === "OUT") animType = "W";
            if (animType) syncToLiveDB(animType); 

            const overlay = document.getElementById('event-animation-overlay');
            const textEl = document.getElementById('event-animation-text');
            textEl.textContent = text;
            textEl.className = `text-9xl font-black drop-shadow-2xl animate-pop ${colorClass}`;
            overlay.classList.remove('hidden');
            setTimeout(() => { overlay.classList.add('hidden'); }, 1200);
        }

        function addExtra(type, runs) {
            addToHistory();
            closeModal('wide-modal'); closeModal('noball-modal'); closeModal('extras-modal');
            const bt = state[state.battingTeam];
            const bwl = state.bowler; 
            
            bt.score += runs;
            if(bwl) { bwl.runsConceded += runs; }
            
            let label = type.toUpperCase();
            if (type === 'wd' || type === 'nb') {
                if (runs > 1) { label = `${type.toUpperCase()}+${runs - 1}`; }
            } else if (type === 'pen' && runs < 0) {
                label = `${runs}`;
            } else if (type === 'ext' && runs > 0) {
                label = `+${runs}`;
            }

            if (state.innings === 2 && state.rules.wicketRuns === 0) {
                if (bt.score >= state.target) {
                    processBall(runs, label, false); 
                    updateUI(); setTimeout(endInnings, 100); return;
                }
            }

            processBall(runs, label, false); 
            updateUI();
        }

        function processBall(runs, eventLabel, isLegal) {
    const bt = state[state.battingTeam];
    if (isLegal) { bt.balls = (bt.balls || 0) + 1; }
    
    // --- UPDATED: SAVE NAMES ---
    const currentStrikerId = state.striker ? state.striker.id : null;
    const bowlerName = state.bowler ? state.bowler.name : "Bowler";
    const batterName = state.striker ? state.striker.name : "Batter";

    state.currentOver.push({ 
        event: eventLabel, 
        runs: runs, 
        isLegal: isLegal, 
        strikerId: currentStrikerId,
        bowler: bowlerName, // Saving Bowler Name
        batter: batterName  // Saving Batter Name
    });
    // ---------------------------

    if(bt.balls === 6) {
                bt.overs = (bt.overs || 0) + 1;
                bt.balls = 0;
                
                if(bt.overs >= state.totalOvers) {
                    endInnings();
                } else if (state.rules.skins && bt.overs % 4 === 0) {
                    setTimeout(() => { state.currentOver = []; openModal('pair-change-modal'); }, 500);
                } else {
                    setTimeout(() => { swapStrikers(); state.currentOver = []; selectPlayer('bowler', updateUI); }, 200);
                }
            }
        }

        function swapStrikers() { const t = state.striker; state.striker = state.nonStriker; state.nonStriker = t; }
        
        function performPairSwap() { 
            closeModal('pair-change-modal'); 
            selectOpeningPair(() => {
                selectPlayer('bowler', updateUI);
            });
        }

        function endInnings() {
            if(state.innings === 1) {
                const battingTeam = state[state.battingTeam];
                state.target = battingTeam.score + 1;
                document.getElementById('ib-batting-team').textContent = battingTeam.name;
                document.getElementById('ib-score').textContent = battingTeam.score;
                document.getElementById('ib-wickets').textContent = battingTeam.wickets || 0;
                document.getElementById('ib-overs').textContent = `${battingTeam.overs}.${battingTeam.balls}`;
                document.getElementById('ib-target').textContent = state.target;
                document.getElementById('innings-break-modal').classList.remove('hidden');
            } else {
                generateMatchSummary();
                document.getElementById('match-summary-modal').classList.remove('hidden');
            }
        }

        function generateMatchSummary() {
            const t1 = state.team1;
            const t2 = state.team2;
            let winnerText = "MATCH TIED";
            let marginText = "Scores Level";

            if (t1.score > t2.score) {
                winnerText = `${t1.name} WINS!`;
                marginText = `WON BY ${t1.score - t2.score} RUNS`;
                document.getElementById('card-t1').className = "bg-gradient-to-r from-green-500/20 to-emerald-500/20 backdrop-blur-lg border border-green-500/50 rounded-2xl p-6 flex items-center justify-between shadow-[0_0_30px_rgba(16,185,129,0.2)]";
                document.getElementById('card-t2').className = "bg-white/5 backdrop-blur-lg border border-white/10 rounded-2xl p-6 flex items-center justify-between opacity-70 grayscale";
            } else if (t2.score > t1.score) {
                winnerText = `${t2.name} WINS!`;
                const wicketsLeft = (state.playersPerSide - 1) - (t2.wickets || 0); 
                marginText = `WON BY ${wicketsLeft > 0 ? wicketsLeft : 1} WICKETS`;
                document.getElementById('card-t2').className = "bg-gradient-to-r from-green-500/20 to-emerald-500/20 backdrop-blur-lg border border-green-500/50 rounded-2xl p-6 flex items-center justify-between shadow-[0_0_30px_rgba(16,185,129,0.2)]";
                document.getElementById('card-t1').className = "bg-white/5 backdrop-blur-lg border border-white/10 rounded-2xl p-6 flex items-center justify-between opacity-70 grayscale";
            }

            document.getElementById('summary-winner-text').textContent = winnerText;
            document.getElementById('summary-margin-text').textContent = marginText;

            document.getElementById('sum-t1-name').textContent = t1.name;
            if(t1.logo) document.getElementById('sum-t1-logo').innerHTML = `<img src="${t1.logo}" class="w-full h-full object-cover">`;
            else document.getElementById('sum-t1-logo').textContent = getTeamInitials(t1.name);
            document.getElementById('sum-t1-score').textContent = `${t1.score}/${t1.wickets||0}`;
            document.getElementById('sum-t1-overs').textContent = `${t1.overs}.${t1.balls} ov`;

            document.getElementById('sum-t2-name').textContent = t2.name;
            if(t2.logo) document.getElementById('sum-t2-logo').innerHTML = `<img src="${t2.logo}" class="w-full h-full object-cover">`;
            else document.getElementById('sum-t2-logo').textContent = getTeamInitials(t2.name);
            document.getElementById('sum-t2-score').textContent = `${t2.score}/${t2.wickets||0}`;
            document.getElementById('sum-t2-overs').textContent = `${t2.overs}.${t2.balls} ov`;

            const allPlayers = [];
            ['team1', 'team2'].forEach(tk => {
                Object.values(state[tk].playerStats).forEach(p => {
                    p.teamName = state[tk].name;
                    allPlayers.push(p);
                });
            });

            const topBatters = [...allPlayers].sort((a,b) => b.runs - a.runs).slice(0, 3);
            document.getElementById('sum-top-batters').innerHTML = topBatters.map(p => `
                <div class="flex justify-between items-center border-b border-white/10 pb-2 last:border-0">
                    <div>
                        <div class="font-bold text-white text-sm">${p.name}</div>
                        <div class="text-[10px] text-white/50">${p.teamName}</div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-yellow-400 text-lg">${p.runs}</div>
                        <div class="text-[9px] text-white/50">${p.balls} balls</div>
                    </div>
                </div>
            `).join('');

            const topBowlers = [...allPlayers].sort((a,b) => (b.wickets - a.wickets) || (a.runsConceded - b.runsConceded)).slice(0, 3);
            document.getElementById('sum-top-bowlers').innerHTML = topBowlers.map(p => `
                <div class="flex justify-between items-center border-b border-white/10 pb-2 last:border-0">
                    <div>
                        <div class="font-bold text-white text-sm">${p.name}</div>
                        <div class="text-[10px] text-white/50">${p.teamName}</div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-blue-400 text-lg">${p.wickets}<span class="text-white/50 text-xs">/${p.runsConceded}</span></div>
                        <div class="text-[9px] text-white/50">${p.ballsBowled} balls</div>
                    </div>
                </div>
            `).join('');

            const pomCandidates = [...new Set([...topBatters.slice(0,2), ...topBowlers.slice(0,2)])];
            document.getElementById('sum-pom-list').innerHTML = pomCandidates.map((p, i) => `
                <label class="flex items-center gap-3 p-3 bg-white/5 rounded-xl cursor-pointer hover:bg-white/10 transition border border-transparent hover:border-yellow-500/50">
                    <input type="radio" name="pom" value="${p.id}" ${i===0?'checked':''} class="w-5 h-5 accent-yellow-500">
                    <div class="flex-grow">
                        <div class="font-bold text-sm text-white">${p.name}</div>
                        <div class="text-[10px] text-white/60">${p.runs} Runs ‚Ä¢ ${p.wickets} Wickets</div>
                    </div>
                </label>
            `).join('');
        }

        function startSecondInnings() {
            document.getElementById('innings-break-modal').classList.add('hidden');
            state.innings = 2;
            const t = state.battingTeam; state.battingTeam = state.bowlingTeam; state.bowlingTeam = t;
            state.currentOver = []; 
            state.bowler = null; 
            alert(`2nd Innings Starting!\nBatting: ${state[state.battingTeam].name}\nTarget: ${state.target}`);
            initInnings();
        }

        function manualSwap() {
            addToHistory();
            swapStrikers();
            updateUI();
        }

        function confirmExit() {
            if(confirm("‚ö†Ô∏è Are you sure you want to EXIT?\n\nCurrent match data will be lost.")) {
                location.reload();
            }
        }

        // --- NEW EDITING LOGIC (BOWLER & OVER) ---
        function editActivePlayer(role) {
            if (role === 'bowler') {
                openBowlerEdit();
            } else {
                window.correctionMode = true; 
                selectPlayer(role, updateUI);
            }
        }

        function openBowlerEdit() {
            if (!state.bowler) return;
            
            // 1. Populate Dropdown with Bowling Team Squad
            const select = document.getElementById('edit-bowler-select');
            select.innerHTML = "";
            const squad = state[state.bowlingTeam].playerStats;
            
            Object.values(squad).forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.id;
                opt.text = p.name;
                if(p.id === state.bowler.id) opt.selected = true;
                select.appendChild(opt);
            });

            // 2. Render Over List
            renderOverEditList();
            openModal('bowler-edit-modal');
        }

        function changeCurrentBowler(newBowlerId) {
            // Swap the active bowler reference
            const newBowler = state[state.bowlingTeam].playerStats[newBowlerId];
            if(newBowler) {
                state.bowler = newBowler;
                updateUI(); // Refreshes stats display
            }
        }

        function renderOverEditList() {
            const list = document.getElementById('edit-over-list');
            list.innerHTML = "";

            state.currentOver.forEach((ball, index) => {
                const row = document.createElement('div');
                // New "Card" Layout
                row.className = "ball-edit-row"; 
                row.onclick = () => showMiniScoringPad(index, row); 

                row.innerHTML = `
                    <div class="ball-label">
                        BALL ${index + 1}
                    </div>
                    <div class="ball-value group hover:border-blue-300 hover:bg-blue-50 transition-colors">
                        <span class="text-3xl font-black text-gray-800">${ball.event}</span>
                        <div class="flex items-center gap-2 text-gray-400 group-hover:text-blue-600">
                            <span class="text-[10px] font-bold uppercase tracking-wider">Tap to Edit</span>
                            <span class="text-lg">‚úé</span>
                        </div>
                    </div>
                `;
                list.appendChild(row);
            });
        }

        // --- REPLACED: Show the Full Scoring Pad in Edit Mode ---
        function showMiniScoringPad(index, rowElement) {
            const padHTML = `
                <div class="mini-score-grid animate-pop">
                    <button class="watery-btn btn-grey" onclick="applyBallCorrection(${index}, 0, '0')">0</button>
                    <button class="watery-btn btn-grey" onclick="applyBallCorrection(${index}, 1, '1')">1</button>
                    <button class="watery-btn btn-grey" onclick="applyBallCorrection(${index}, 2, '2')">2</button>
                    <button class="watery-btn btn-grey" onclick="applyBallCorrection(${index}, 3, '3')">3</button>

                    <button class="watery-btn btn-yellow text-xs" onclick="renderOverEditList()">CANCEL</button>
                    <button class="watery-btn btn-sky text-2xl" onclick="applyBallCorrection(${index}, 4, '4')">4</button>
                    <button class="watery-btn btn-green text-2xl" onclick="applyBallCorrection(${index}, 6, '6')">6</button>
                    <button class="watery-btn btn-grey" onclick="applyBallCorrection(${index}, 5, '5')">5</button>

                    <button class="watery-btn btn-red text-sm" onclick="initiateEditAction(${index}, 'WKT')">WKT</button>
                    <button class="watery-btn btn-dark-grey text-sm" onclick="initiateEditAction(${index}, 'WD')">WD</button>
                    <button class="watery-btn btn-dark-grey text-sm" onclick="initiateEditAction(${index}, 'NB')">NB</button>
                    <button class="watery-btn btn-purple text-sm" onclick="showEditExtrasPad(${index}, this.parentNode.parentNode)">EXT</button>
                </div>
            `;
            
            const wrapper = document.createElement('div');
            wrapper.innerHTML = padHTML;
            
            rowElement.onclick = null;
            rowElement.className = "mb-2"; 
            rowElement.innerHTML = "";
            rowElement.appendChild(wrapper);
        }

        // --- NEW: Triggers for specific modals in edit mode ---
        function initiateEditAction(index, type) {
            editingBallIndex = index;
            if (type === 'WKT') openWicketModal();
            else if (type === 'WD') openModal('wide-modal');
            else if (type === 'NB') openModal('noball-modal');
        }

        function showEditExtrasPad(index, containerElement) {
            const extHTML = `
                <div class="animate-pop bg-white p-2 rounded-xl border border-purple-200 shadow-sm">
                    <div class="mb-2">
                        <p class="text-[10px] font-bold text-green-600 uppercase mb-1 text-center">Add Runs (+)</p>
                        <div class="extras-edit-grid">
                            ${[1,2,3,4,5,6].map(r => `<button onclick="handleAddExtra('ext', ${r})" class="p-2 bg-green-50 text-green-800 font-bold rounded border border-green-200 hover:bg-green-100">+${r}</button>`).join('')}
                        </div>
                    </div>
                    <div>
                        <p class="text-[10px] font-bold text-red-600 uppercase mb-1 text-center">Penalty Runs (-)</p>
                        <div class="extras-edit-grid">
                            ${[-1,-2,-3,-4,-5,-6].map(r => `<button onclick="handleAddExtra('pen', ${r})" class="p-2 bg-red-50 text-red-800 font-bold rounded border border-red-200 hover:bg-red-100">${r}</button>`).join('')}
                        </div>
                    </div>
                    <button onclick="renderOverEditList()" class="w-full mt-2 py-2 bg-gray-100 text-gray-500 font-bold text-xs rounded uppercase">Cancel</button>
                </div>
            `;
            // Set editing context before showing this pad
            editingBallIndex = index;
            containerElement.innerHTML = extHTML;
        }

        function applyBallCorrection(index, newRuns, newEvent) {
            const ball = state.currentOver[index];
            const oldRuns = ball.runs;
            const batterId = ball.strikerId; // Retrieve the ID of who played this ball

            // 1. Update Team Score
            state[state.battingTeam].score += (newRuns - oldRuns);

            // 2. Update Bowler Stats (Runs Conceded)
            if(state.bowler) {
                state.bowler.runsConceded += (newRuns - oldRuns);
            }

            // 3. Update Batter Stats (Corrected Logic)
            if (batterId) {
                // Fetch the specific player object from the team roster
                const batter = state[state.battingTeam].playerStats[batterId];
                
                if (batter) {
                    // Remove Old Runs
                    let oldBatterRuns = oldRuns;
                    if(ball.event.includes('WD')) oldBatterRuns = 0; 
                    
                    // Add New Runs
                    let newBatterRuns = newRuns;
                    if(newEvent.includes('WD')) newBatterRuns = 0;

                    batter.runs += (newBatterRuns - oldBatterRuns);
                    
                    // Force refresh current striker reference if it matches this batter
                    if (state.striker && state.striker.id === batterId) {
                        state.striker = batter;
                    }
                }
            }

            // --- FIX: AUTO-ROTATE STRIKE ON EDIT ---
            // If the odd/even nature changed, we must swap the CURRENT strikers to realign 
            // with the sequence of events.
            const oldIsOdd = (oldRuns % 2 !== 0);
            const newIsOdd = (newRuns % 2 !== 0);
            if (oldIsOdd !== newIsOdd) {
                swapStrikers();
            }

            // 4. Update the Ball Object
            ball.runs = newRuns;
            ball.event = newEvent;

            // 5. Clear edit mode context
            editingBallIndex = null;

            // Refresh UI and Re-render Modal list to close the pad
            updateUI();
            renderOverEditList();
        }

        function cancelPlayerSelection() {
            window.correctionMode = false;
            pendingSelection = null;
            closeModal('player-modal');
        }

        function updateUI() {
            // --- STATE RESYNC ---
            // Force re-fetch the striker/nonStriker objects from the central team stats
            // to ensure UI displays the latest edits immediately.
            const btStats = state[state.battingTeam].playerStats;
            if (state.striker && btStats[state.striker.id]) {
                state.striker = btStats[state.striker.id];
            }
            if (state.nonStriker && btStats[state.nonStriker.id]) {
                state.nonStriker = btStats[state.nonStriker.id];
            }

            syncToLiveDB(); 
            updateScoreboard(); 
            
            const batTable = document.getElementById('batting-table');
            batTable.innerHTML = '';
            
            const createRow = (p, isStriker) => {
                const sr = p.balls > 0 ? ((p.runs / p.balls) * 100).toFixed(2) : '0.00';
                const roleArg = isStriker ? 'striker' : 'nonStriker';
                
                return `
                <tr class="border-t ${isStriker ? 'bg-blue-50' : ''}">
                    <td class="p-2 font-bold text-gray-800">
                        <div class="flex items-center justify-between w-full">
                            <span>${p.name} ${isStriker ? '<span class="text-red-500">*</span>' : ''}</span>
                            <button onclick="editActivePlayer('${roleArg}')" class="text-gray-400 hover:text-blue-600 px-2 text-lg">‚úé</button>
                        </div>
                    </td>
                    <td class="text-center p-2 font-bold ${p.runs < 0 ? 'text-red-600' : ''}">${p.runs}</td>
                    <td class="text-center p-2 text-gray-600">${p.balls}</td>
                    <td class="text-center p-2 text-gray-400">-</td>
                    <td class="text-center p-2 text-gray-400">-</td>
                    <td class="text-right p-2 text-gray-500 text-xs">${sr}</td>
                </tr>`;
            };
            
            if(state.striker) batTable.innerHTML += createRow(state.striker, true);
            if(state.nonStriker) batTable.innerHTML += createRow(state.nonStriker, false);

            if(state.bowler) {
                const ballsHTML = state.currentOver.map(b => {
                    let c = 'ball-0';
                    let fontSize = 'text-[9px]'; 
                    
                    if(b.runs === 4) c = 'ball-4';
                    else if(b.runs === 6) c = 'ball-6';
                    else if(b.event.includes('W') && !b.event.includes('WD')) c = 'ball-w';
                    else if(b.event.includes('WD') || b.event.includes('NB')) {
                        c = 'ball-wd';
                        if (b.event.length > 2) fontSize = 'text-[6px] leading-tight';
                    }
                    
                    return `<span class="ball-chip ${c} ${fontSize}">${b.event}</span>`;
                }).join('');

                const overs = Math.floor(state.bowler.ballsBowled / 6) + '.' + (state.bowler.ballsBowled % 6);
                const econ = state.bowler.ballsBowled > 0 ? (state.bowler.runsConceded / (state.bowler.ballsBowled/6)).toFixed(2) : '0.00';

                document.getElementById('bowling-table').innerHTML = `
                <tr class="border-t">
                    <td class="py-1 px-2 align-middle">
                        <div class="font-bold text-gray-800 text-[11px] leading-tight flex items-center gap-2">
                            ${state.bowler.name}
                            <button onclick="editActivePlayer('bowler')" class="text-gray-400 hover:text-blue-600">‚úé</button>
                        </div>
                        <div class="mt-0.5 flex items-center overflow-x-auto gap-0.5 min-h-[1.4rem] w-full no-scrollbar">${ballsHTML}</div>
                    </td>
                    <td class="text-center py-1 font-medium text-gray-700 text-[10px] align-middle">${overs}</td>
                    <td class="text-center py-1 text-gray-400 text-[10px] align-middle">0</td>
                    <td class="text-center py-1 font-medium text-gray-800 text-[10px] align-middle">${state.bowler.runsConceded}</td>
                    <td class="text-center py-1 font-bold text-red-600 text-[10px] align-middle">${state.bowler.wickets}</td>
                    <td class="text-right py-1 pr-2 text-gray-500 text-[9px] align-middle">${econ}</td>
                </tr>`;
            }
        }
    </script>
</body>
</html>
