<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Cricker - Indoor Match Controller</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb"/>
    <link rel="apple-touch-icon" href="icon-512.png">

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
<style>
    /* --- Base Styles --- */
    body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; color: #000000; overscroll-behavior-y: none; }
    
    /* Professional Typography Resets */
    ::placeholder { font-size: 0.95em; color: #e6e8eb; font-weight: 300; opacity: 0.5; } /* Ultra Light Grey */
    input, select, textarea { color: #ff0000 !important; -webkit-text-fill-color: #393939 !important; }
    
    /* --- PROFESSIONAL SCROLLING UTILITIES (Mobile First) --- */
    
    /* 1. Hide Scrollbars but keep functionality */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    
    /* 2. Horizontal Sliding & Snapping */
    .snap-x { scroll-snap-type: x mandatory; }
    .snap-start { scroll-snap-align: start; }
    .snap-center { scroll-snap-align: center; }
    
    /* 3. Smooth Momentum Scrolling for iOS */
    .custom-scroll { -webkit-overflow-scrolling: touch; scroll-behavior: smooth; }
    
    /* Desktop Scrollbar (Visible only on larger screens) */
    @media (min-width: 768px) {
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    }
    /* Mobile: Hide scrollbars by default for cleaner look */
    @media (max-width: 768px) {
        .custom-scroll::-webkit-scrollbar { display: none; }
        .custom-scroll { scrollbar-width: none; }
    }

    /* Title Animation */
    @keyframes gradient-x {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }
    .animate-gradient-x {
        background-size: 200% auto;
        animation: gradient-x 4s linear infinite;
    }

    /* --- MOBILE & APP UX STYLES --- */
    @media (max-width: 768px) {
        body { font-size: 14px; background-color: #f8fafc; }
        
        /* Flatten the setup card on mobile */
        #setup-screen {
            width: 100%; 
            padding: 0 !important;
            background-color: #f8fafc !important;
        }
        
        .setup-card { 
            width: 100% !important;
            max-width: 100% !important;
            min-height: 100vh !important;
            border: none !important;
            border-radius: 0 !important;
            box-shadow: none !important;
            padding: 1rem !important;
            padding-bottom: 6rem !important; /* Space for sticky button */
            background-color: transparent !important;
        }

        /* Prevent nested scrolling issues - Allow natural scrolling in containers */
        .overflow-y-auto { 
            overflow-y: auto !important; 
            -webkit-overflow-scrolling: touch;
        }
        
        #app { overflow: hidden; height: 100vh; }
        #app > .flex-grow { padding: 4px; display: flex; flex-direction: column; overflow: hidden; }
        #scoreboard { padding: 0; margin-bottom: 4px; }
        #batting-table th, #batting-table td, #bowling-table th, #bowling-table td { padding: 4px 6px; font-size: 0.75rem; }
    }

   /* --- Mobile Wizard Components (Production Grade) --- */
    .wizard-section { 
        margin-bottom: 1rem; 
        background: white; 
        border-radius: 12px; 
        padding: 1.25rem; 
        border: 1px solid #e5e7eb; 
        box-shadow: 0 1px 2px rgba(0,0,0,0.05); 
    }
    .wizard-header { 
        display: flex; align-items: center; gap: 0.75rem; 
        margin-bottom: 1rem; border-bottom: 1px solid #f3f4f6; padding-bottom: 0.75rem; 
    }
    .wizard-icon { 
        width: 2.5rem; height: 2.5rem; 
        border-radius: 8px; 
        display: flex; align-items: center; justify-content: center; 
        font-size: 1.25rem; 
        background-color: #f9fafb;
        color: #111827;
        border: 1px solid #f3f4f6;
    }
    
    /* Input Fields - Professional Typography Scale */
    .mobile-input-group { margin-bottom: 1.15rem; }
    
    .mobile-label { 
        display: block; 
        font-size: 0.75rem; /* 12px */
        font-weight: 600;   /* SemiBold, not Black */
        color: #6b7280;     /* Cool Grey (Secondary) */
        text-transform: uppercase; 
        margin-bottom: 0.35rem; 
        letter-spacing: 0.04em; 
    }
    
    .mobile-input { 
        width: 100%; 
        padding: 0.75rem 0.875rem; 
        background-color: #ffffff; 
        border: 1px solid #d1d5db; /* Neutral Grey Border */
        border-radius: 0.5rem;     /* 8px radius - Standard App Feel */
        
        font-family: 'Inter', sans-serif;
        font-weight: 600; 
        font-size: 1rem;      /* 16px - Readable & prevents zoom */
        color: #000000;       /* PURE BLACK (Main Content) */
        
        outline: none; 
        transition: border-color 0.2s; 
    }
    .mobile-input:focus { 
        border-color: #000000; /* Black focus border like sleek apps */
        background-color: #ffffff;
    }
    .mobile-input.error { border-color: #ef4444; background-color: #fff9f9; }

    /* Sticky Bottom Actions */
    .sticky-footer { 
        position: fixed; bottom: 0; left: 0; right: 0; 
        padding: 1rem; 
        background: rgba(255,255,255,0.98); 
        border-top: 1px solid #e5e7eb; 
        z-index: 100; 
    }
    
    /* --- NEW: Selection Cards (Ball Type) --- */
    .option-card-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; }
    .option-card {
        border: 2px solid #e2e8f0;
        border-radius: 1rem;
        padding: 1rem 0.5rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        background: white;
        position: relative;
        overflow: hidden;
    }
    .option-card:hover { border-color: #cbd5e1; transform: translateY(-2px); }
    .option-card.selected {
        border-color: #2563eb;
        background-color: #eff6ff;
        color: #1d4ed8;
        box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.2);
    }
    .option-card-icon { font-size: 1.5rem; margin-bottom: 0.25rem; display: block; }
    .option-card-label { font-size: 0.7rem; font-weight: 800; text-transform: uppercase; display: block; line-height: 1.2; }
    .option-check { 
        position: absolute; top: 4px; right: 4px; 
        width: 16px; height: 16px; 
        background: #2563eb; color: white; 
        border-radius: 50%; font-size: 10px; 
        display: none; align-items: center; justify-content: center; 
    }
    .option-card.selected .option-check { display: flex; }
    
    /* Mobile Cards (Teams & Schedule) */
    .mobile-card { background: white; border: 1px solid #e2e8f0; border-radius: 1rem; padding: 1rem; margin-bottom: 0.75rem; position: relative; }
    .mobile-card.active { border-color: #3b82f6; box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.1); }
    
    /* Schedule specific */
    .sch-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; }
    .sch-versus { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem; background: #f8fafc; padding: 0.5rem; border-radius: 0.75rem; }
    .drag-handle-mobile { width: 2rem; height: 2rem; display: flex; align-items: center; justify-content: center; color: #cbd5e1; touch-action: none; }

    /* --- Setup & UI Components --- */
    .setup-bg { background-color:#f3f4f6; }
    .setup-card { background: #ffffff; border: 1px solid #e5e7eb; border-radius: 1rem; }
    .setup-step { transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out; }
    .setup-step.hidden { opacity: 0; transform: translateX(30px) scale(0.98); position: absolute; pointer-events: none; }
    .setup-step.active { opacity: 1; transform: translateX(0) scale(1); }
    .progress-bar-fill { background-color: #2563eb; transition: width 0.5s ease-in-out; }
    
    /* Toss Buttons */
    .toss-card-btn { 
        border-radius: 1rem; 
        background-color: white; 
        border: 2px solid #e5e7eb; 
        transition: all 0.2s ease-out; 
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        padding: 2rem; cursor: pointer;
    }
    .toss-card-btn:hover { border-color: #93c5fd; }
    .toss-card-btn.selected { background-color: #eff6ff; border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2); }

    .decision-btn {
        border-radius: 0.75rem; background-color: white; border: 1px solid #d1d5db;
        padding: 0.75rem 2rem; font-weight: bold; transition: all 0.2s;
    }
    .decision-btn.selected { background-color: #2563eb; color: white; border-color: #2563eb; box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.3); }
    
    /* --- Scoring Grid --- */
    .scoring-grid { 
        display: grid; grid-template-columns: repeat(4, 1fr); grid-template-rows: 1fr 1fr 0.7fr; 
        flex-grow: 1; gap: 6px; padding: 6px; background: #f0f2f5;
    }

    .watery-btn {
        border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.3);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.4);
        font-family: 'Inter', sans-serif; transition: transform 0.1s active, filter 0.2s;
        backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center;
        position: relative; overflow: hidden;
    }
    .watery-btn:active { transform: scale(0.96); }

    /* Gradients */
    .btn-grey { background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%); color: #374151; }
    .btn-dark-grey { background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%); color: #ffffff; text-shadow: 0 1px 2px rgba(0,0,0,0.3); }
    .btn-sky { background: linear-gradient(135deg, #7dd3fc 0%, #0ea5e9 100%); color: #ffffff; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }
    .btn-green { background: linear-gradient(135deg, #86efac 0%, #16a34a 100%); color: #ffffff; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }
    .btn-red { background: linear-gradient(135deg, #fca5a5 0%, #dc2626 100%); color: #ffffff; text-shadow: 0 1px 2px rgba(0,0,0,0.3); }
    .btn-yellow { background: linear-gradient(135deg, #fde047 0%, #eab308 100%); color: #713f12; }
    .btn-purple { background: linear-gradient(135deg, #c084fc 0%, #9333ea 100%); color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }

    /* Animation */
    @keyframes popIn { 0% { transform: scale(0); opacity: 0; } 50% { transform: scale(1.3); opacity: 1; } 100% { transform: scale(1); opacity: 1; } }
    .animate-pop { animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
    
    .modal-overlay { transition: opacity 0.3s ease-in-out; }
    /* UPDATED: Roster Row with Drag Handle Support */
    .roster-row { display: grid; grid-template-columns: auto auto 1fr auto; gap: 0.5rem; align-items: center; padding: 0.5rem; background-color: white; border: 1px solid #e5e7eb; border-radius: 0.5rem; transition: background-color 0.2s, border-color 0.2s; touch-action: none; }
    .roster-row.selected { background-color: #eff6ff; border-color: #3b82f6; }
    .roster-input { width: 100%; font-weight: 600; color: #374151; background: transparent; border: none; outline: none; text-transform: uppercase; font-size: 0.85rem; }
    .roster-input:focus { border-bottom: 2px solid #3b82f6; }
    
    /* NEW: Drag & Drop Styles */
    .drag-handle { cursor: grab; color: #9ca3af; padding: 4px; display: flex; align-items: center; justify-content: center; }
    .drag-handle:hover { color: #3b82f6; background: #f3f4f6; border-radius: 4px; }
    .sortable-ghost { opacity: 0.4; background: #e0e7ff; border: 2px dashed #6366f1; }
    .sortable-drag { cursor: grabbing; opacity: 1; background: white; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); transform: scale(1.02); }
    
    /* Ball Chips */
    .ball-chip { display: inline-flex; justify-content: center; align-items: center; width: 1.2rem; height: 1.2rem; font-size: 0.6rem; font-weight: bold; border-radius: 9999px; margin-right: 0.1rem; background-color: #e5e7eb; color: #374151; flex-shrink: 0; }
    
    /* NEW: Square Chip for Complex Events (NB+RunOut etc) */
    .ball-chip.ball-square { border-radius: 4px; width: auto; min-width: 1.2rem; padding: 0 2px; }

    .ball-4 { background-color: #3b82f6; color: white; }
    .ball-6 { background-color: #22c55e; color: white; }
    .ball-w { background-color: #ef4444; color: white; }
    .ball-wd, .ball-nb { background-color: #f59e0b; color: white; }

    .opacity-60 { filter: grayscale(100%); opacity: 0.6; }

    /* iOS Toggle */
    .ios-toggle { appearance: none; width: 50px; height: 30px; background: #e5e7eb; border-radius: 9999px; position: relative; cursor: pointer; outline: none; transition: background-color 0.3s ease; }
    .ios-toggle::after { content: ''; position: absolute; top: 2px; left: 2px; width: 26px; height: 26px; background: white; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1); }
    .ios-toggle:checked { background-color: #34c759; }
    .ios-toggle:checked::after { transform: translateX(20px); }

    /* --- EDIT MODAL STYLES --- */
    .ball-edit-row { display: flex; align-items: stretch; margin-bottom: 0.75rem; cursor: pointer; transition: transform 0.1s ease-in-out; }
    .ball-edit-row:active { transform: scale(0.98); }
    .ball-label { width: 4.5rem; display: flex; align-items: center; justify-content: center; background-color: #f1f5f9; color: #64748b; font-size: 0.65rem; font-weight: 900; text-transform: uppercase; border-top-left-radius: 0.75rem; border-bottom-left-radius: 0.75rem; border: 1px solid #e2e8f0; border-right: none; letter-spacing: 0.05em; }
    .ball-value { flex-grow: 1; display: flex; align-items: center; justify-content: space-between; background-color: white; padding: 0 1.25rem; height: 3.5rem; border: 1px solid #e2e8f0; border-top-right-radius: 0.75rem; border-bottom-right-radius: 0.75rem; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
    
    .mini-score-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; background: #f1f5f9; padding: 8px; border-radius: 12px; border: 1px solid #cbd5e1; margin-bottom: 10px; }
    .mini-score-grid .watery-btn { height: 3.5rem; font-size: 1.1rem; font-weight: 800; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1), inset 0 1px 0 rgba(255,255,255,0.4); }
    .mini-score-grid .watery-btn:active { transform: scale(0.95); }
    .extras-edit-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 4px; padding: 8px; background: #f8fafc; border-radius: 12px; }
</style>
</head>
<body class="bg-gray-100 antialiased text-gray-800">

    <div id="splash-screen" class="fixed inset-0 z-[9999] flex flex-col items-center justify-center bg-gray-50 transition-opacity duration-700" style="display: none;">
        <img src="my-logo.png" alt="App Logo" class="w-24 h-24 mb-4 animate-pulse">
        <h1 class="text-xl font-bold text-blue-700">INDOOR CRICKET</h1>
    </div>

    <div id="event-animation-overlay" class="fixed inset-0 flex items-center justify-center bg-black/60 backdrop-blur-sm pointer-events-none hidden z-50 transition-opacity duration-300">
        <h1 id="event-animation-text" class="text-8xl font-black uppercase drop-shadow-2xl text-center"></h1>
    </div>

    <div id="setup-screen" class="min-h-screen w-full flex flex-col md:items-center md:justify-center setup-bg">
        <div class="w-full md:max-w-6xl md:shadow-xl md:rounded-2xl p-4 md:p-8 setup-card overflow-hidden min-h-screen md:min-h-0 bg-white">
            <div id="progress-container" class="mb-8 max-w-2xl mx-auto">
                <div class="w-full h-2 bg-gray-200 rounded-full">
                    <div id="progress-bar" class="progress-bar-fill h-2 rounded-full" style="width: 33%;"></div>
                </div>
                <div class="flex justify-between text-xs sm:text-sm text-gray-500 mt-2 font-medium">
                    <span>Config</span><span>Squad Review</span><span>Toss</span>
                </div>
            </div>

            <div class="relative">
                <div id="mode-selection-screen" class="setup-step active w-full max-w-4xl mx-auto text-center py-10">
    <div class="mb-10">
        <h1 class="text-2xl md:text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-600 via-purple-600 to-pink-600 mb-4">CRICKERR MATCH SETUP</h1>
        <p class="text-gray-500 font-bold uppercase tracking-[0.2em] text-xs">Select the game Mode</p>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-2xl mx-auto">
        <button onclick="selectGameMode('SINGLE')" class="group relative p-8 bg-white border-2 border-gray-100 rounded-3xl hover:border-blue-400 hover:shadow-2xl transition-all text-left overflow-hidden">
            <div class="absolute right-0 top-0 w-32 h-32 bg-blue-50 rounded-bl-full -mr-10 -mt-10 transition-transform group-hover:scale-110"></div>
            <div class="relative z-10">
                <span class="text-4xl mb-4 block">üèè</span>
                <h3 class="text-1xl font-black text-gray-800 mb-2 uppercase italic">Single Match Mode</h3>
                <p class="text-xs text-gray-500 font-medium leading-relaxed">Quick play mode. Set up two teams, toss, and score immediately.</p>
            </div>
        </button>

        <button onclick="selectGameMode('TOURNAMENT')" class="group relative p-8 bg-white border-2 border-gray-100 rounded-3xl hover:border-purple-400 hover:shadow-2xl transition-all text-left overflow-hidden">
            <div class="absolute right-0 top-0 w-32 h-32 bg-purple-50 rounded-bl-full -mr-10 -mt-10 transition-transform group-hover:scale-110"></div>
            <div class="relative z-10">
                <span class="text-4xl mb-4 block">üèÜ</span>
                <h3 class="text-1xl font-black text-gray-800 mb-2 uppercase italic">Tournament Mode</h3>
                <p class="text-xs text-gray-500 font-medium leading-relaxed">Leagues & Knockouts. Auto-fixtures, points tables, NRR & MVP stats.</p>
            </div>
        </button>
    </div>
    
    <div class="mt-12 max-w-md mx-auto">
        <div class="flex items-center gap-2 bg-gray-50 p-2 rounded-xl border border-gray-200">
            <input type="text" id="tournament-load-id" placeholder="Enter Tournament ID to Resume" class="bg-transparent flex-grow px-4 py-2 text-sm font-bold uppercase outline-none text-gray-700">
            <button onclick="loadTournament()" class="bg-purple-600 text-white px-6 py-2 rounded-lg text-xs font-bold uppercase hover:bg-purple-700 transition">Load</button>
        </div>
    </div>
</div>

<div id="setup-step-1" class="setup-step hidden w-full max-w-5xl mx-auto px-2">
    <button onclick="backToModeSelect()" class="mb-4 text-xs font-bold text-gray-400 hover:text-gray-600 uppercase tracking-wider">‚Üê Back to Menu</button>
    
    <div class="text-center mb-8 mt-4">
        <div class="inline-flex items-center justify-center gap-2 mb-2">
                <div class="h-1 w-8 bg-purple-500 rounded-full"></div>
                <span class="text-[10px] font-black tracking-[0.3em] text-transparent bg-clip-text bg-gradient-to-r from-purple-500 to-pink-500 uppercase">Indoor Match Configuration</span>
                <div class="h-1 w-8 bg-purple-500 rounded-full"></div>
        </div>
        <h1 class="text-3xl md:text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-700 via-purple-600 to-pink-600  tracking-tighter drop-shadow-sm leading-tight" id="setup-title">Indoor Crickerr Match</h1>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 h-[60vh] overflow-y-auto pr-2 custom-scroll content-start pb-10">
        
        <div class="lg:col-span-12 space-y-6">
            
            <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl border border-blue-200 shadow-sm overflow-hidden">
                <div class="p-5">
                    <div class="flex items-center gap-2 mb-5">
                        <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 shadow-sm border border-blue-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                        </div>
                        <h3 class="text-xs font-bold text-blue-700 uppercase tracking-widest">Match Details</h3>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-5">
                        <div>
                            <label class="block text-[10px] font-bold text-blue-400 uppercase mb-1">Venue Name</label>
                            <input type="text" id="venue" placeholder="STADIUM / ARENA" class="w-full p-3 bg-white/70 backdrop-blur-sm border border-blue-200 rounded-lg font-bold text-gray-700 text-sm focus:ring-2 focus:ring-blue-500 outline-none transition-all uppercase placeholder-blue-300 shadow-sm">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-blue-400 uppercase mb-1">Date</label>
                            <input type="date" id="match-date-input" class="w-full p-3 bg-white/70 backdrop-blur-sm border border-blue-200 rounded-lg font-bold text-gray-700 text-sm focus:ring-2 focus:ring-blue-500 outline-none transition-all uppercase shadow-sm">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-blue-400 uppercase mb-1">Overs</label>
                            <select id="total-overs" class="w-full p-3 bg-white/70 backdrop-blur-sm border border-blue-200 rounded-lg font-bold text-gray-700 text-sm focus:ring-2 focus:ring-blue-500 outline-none transition-all cursor-pointer shadow-sm"></select>
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-blue-400 uppercase mb-1">Squad Size</label>
                            <select id="players-per-side" class="w-full p-3 bg-white/70 backdrop-blur-sm border border-blue-200 rounded-lg font-bold text-gray-700 text-sm focus:ring-2 focus:ring-blue-500 outline-none transition-all cursor-pointer shadow-sm"></select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-gradient-to-br from-orange-50 to-amber-50 rounded-xl border border-orange-200 shadow-sm overflow-hidden">
                <div class="p-5">
                    <div class="flex items-center gap-2 mb-5">
                        <div class="w-8 h-8 rounded-full bg-orange-100 flex items-center justify-center text-orange-600 shadow-sm border border-orange-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>
                        </div>
                        <h3 class="text-xs font-bold text-orange-700 uppercase tracking-widest">Playing Conditions</h3>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-5">
                        <div>
                            <label class="block text-[10px] font-bold text-red-500 uppercase mb-1">Wicket Penalty</label>
                            <div class="relative">
                                <select id="rule-wicket" class="w-full p-3 bg-white/70 backdrop-blur-sm border border-red-200 rounded-lg font-bold text-red-600 text-sm focus:ring-2 focus:ring-red-500 outline-none transition-all appearance-none cursor-pointer shadow-sm"></select>
                                <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-red-400 text-xs">‚ñº</div>
                            </div>
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-orange-600 uppercase mb-1">Balls / Over</label>
                            <div class="relative">
                                <select id="balls-per-over" class="w-full p-3 bg-white/70 backdrop-blur-sm border border-orange-200 rounded-lg font-bold text-orange-700 text-sm focus:ring-2 focus:ring-orange-500 outline-none transition-all appearance-none cursor-pointer shadow-sm">
                                    <option value="6" selected>6 Balls</option>
                                    <option value="5">5 Balls</option>
                                    <option value="4">4 Balls</option>
                                </select>
                                <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-orange-400 text-xs">‚ñº</div>
                            </div>
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-orange-600 uppercase mb-1">Wide Ball</label>
                            <div class="relative">
                                <select id="rule-wide" class="w-full p-3 bg-white/70 backdrop-blur-sm border border-orange-200 rounded-lg font-bold text-orange-700 text-sm focus:ring-2 focus:ring-orange-500 outline-none transition-all appearance-none cursor-pointer shadow-sm">
                                    <option value="1" selected>1 Run</option>
                                    <option value="2">2 Runs</option>
                                    <option value="3">3 Runs</option>
                                </select>
                                <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-orange-400 text-xs">‚ñº</div>
                            </div>
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-orange-600 uppercase mb-1">No Ball</label>
                            <div class="relative">
                                <select id="rule-noball" class="w-full p-3 bg-white/70 backdrop-blur-sm border border-orange-200 rounded-lg font-bold text-orange-700 text-sm focus:ring-2 focus:ring-orange-500 outline-none transition-all appearance-none cursor-pointer shadow-sm">
                                    <option value="1" selected>1 Run</option>
                                    <option value="2">2 Runs</option>
                                    <option value="3">3 Runs</option>
                                </select>
                                <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-orange-400 text-xs">‚ñº</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <style>
                @keyframes glassShimmer {
                    0% { background-position: 0% 50%; }
                    50% { background-position: 100% 50%; }
                    100% { background-position: 0% 50%; }
                }
                .glass-input {
                    background: linear-gradient(90deg, rgba(255,255,255,0.4), rgba(255,255,255,0.7), rgba(255,255,255,0.4));
                    background-size: 200% 100%;
                    animation: glassShimmer 5s ease-in-out infinite;
                }
                .glass-input:focus {
                    background: white;
                    animation: none;
                }
            </style>

            <div class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden">
                <div class="bg-gradient-to-r from-blue-900 via-indigo-900 to-purple-900 px-6 py-4 flex justify-between items-center shadow-md relative z-10">
                    <span class="text-white font-bold uppercase tracking-widest text-xs flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-green-400 animate-pulse"></span>
                        Match Fixture
                    </span>
                    <span class="text-white/30 text-xs font-black tracking-[0.2em]">VERSUS MODE</span>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 relative">
                    
                    <div class="hidden md:flex absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-12 h-12 bg-white rounded-full items-center justify-center z-20 shadow-xl border-4 border-gray-100">
                        <span class="text-xs font-black text-transparent bg-clip-text bg-gradient-to-br from-blue-600 to-red-600">VS</span>
                    </div>

                    <div class="p-6 md:p-8 bg-gradient-to-br from-blue-50 via-white to-blue-50/30 flex flex-col gap-6 border-b md:border-b-0 md:border-r border-gray-100">
                        <div class="flex justify-between items-center">
                            <span class="text-[10px] font-black text-white bg-gradient-to-r from-blue-500 to-cyan-500 px-3 py-1 rounded-full uppercase tracking-wider shadow-sm shadow-blue-200">Home Team</span>
                            <label for="team1-logo-input" class="cursor-pointer text-[10px] font-bold text-blue-400 hover:text-blue-600 transition-colors flex items-center gap-1 group bg-white px-2 py-1 rounded-lg border border-blue-100 shadow-sm">
                                <span class="group-hover:underline">UPLOAD LOGO</span> üì§
                            </label>
                        </div>
                        
                        <div class="flex items-center gap-4">
                            <div class="relative flex-shrink-0 group">
                                <div class="w-16 h-16 md:w-20 md:h-20 rounded-full bg-white border-4 border-blue-100 flex items-center justify-center overflow-hidden shadow-lg group-hover:border-blue-300 transition-colors">
                                    <img id="team1-logo-preview" class="hidden w-full h-full object-cover">
                                    <span class="text-blue-100 font-black text-3xl">H</span>
                                </div>
                                <input type="file" id="team1-logo-input" class="hidden" onchange="handleLogoUpload(this.files[0], 'team1')">
                            </div>
                            
                            <div class="flex-grow space-y-2">
                                <select id="team1-select" class="w-full p-2 bg-white/80 backdrop-blur-sm border border-blue-200 rounded-lg text-xs font-bold uppercase text-blue-700 shadow-sm focus:ring-2 focus:ring-blue-500 outline-none cursor-pointer hover:bg-white transition-colors"><option value="">‚ñº Load Saved Team</option></select>
                                
                                <input type="text" id="team1-name-input" 
                                        onblur="this.value = this.value.replace(/Cricket Club/gi, 'C.C').replace(/Cricket/gi, 'C.').trim().toUpperCase()"
                                        placeholder="HOME TEAM" 
                                        class="glass-input w-full p-2.5 rounded-lg text-xs md:text-sm font-black text-gray-800 uppercase border border-blue-100 focus:border-blue-500 outline-none transition-all placeholder-blue-200/50 shadow-sm">
                            </div>
                        </div>
                    </div>

                    <div class="p-6 md:p-8 bg-gradient-to-br from-red-50 via-white to-red-50/30 flex flex-col gap-6">
                        <div class="flex justify-between items-center">
                            <span class="text-[10px] font-black text-white bg-gradient-to-r from-red-500 to-orange-500 px-3 py-1 rounded-full uppercase tracking-wider shadow-sm shadow-red-200">Away Team</span>
                            <label for="team2-logo-input" class="cursor-pointer text-[10px] font-bold text-red-400 hover:text-red-600 transition-colors flex items-center gap-1 group bg-white px-2 py-1 rounded-lg border border-red-100 shadow-sm">
                                <span class="group-hover:underline">UPLOAD LOGO</span> üì§
                            </label>
                        </div>
                        
                        <div class="flex items-center gap-4">
                            <div class="relative flex-shrink-0 group">
                                <div class="w-16 h-16 md:w-20 md:h-20 rounded-full bg-white border-4 border-red-100 flex items-center justify-center overflow-hidden shadow-lg group-hover:border-red-300 transition-colors">
                                    <img id="team2-logo-preview" class="hidden w-full h-full object-cover">
                                    <span class="text-red-100 font-black text-3xl">A</span>
                                </div>
                                <input type="file" id="team2-logo-input" class="hidden" onchange="handleLogoUpload(this.files[0], 'team2')">
                            </div>

                            <div class="flex-grow space-y-2">
                                <select id="team2-select" class="w-full p-2 bg-white/80 backdrop-blur-sm border border-red-200 rounded-lg text-xs font-bold uppercase text-red-700 shadow-sm focus:ring-2 focus:ring-red-500 outline-none cursor-pointer hover:bg-white transition-colors"><option value="">‚ñº Load Saved Team</option></select>
                                
                                <input type="text" id="team2-name-input" 
                                        onblur="this.value = this.value.replace(/Cricket Club/gi, 'C.C').replace(/Cricket/gi, 'C.').trim().toUpperCase()"
                                        placeholder="AWAY TEAM" 
                                        class="glass-input w-full p-2.5 rounded-lg text-xs md:text-sm font-black text-gray-800 uppercase border border-red-100 focus:border-red-500 outline-none transition-all placeholder-red-200/50 shadow-sm">
                            </div>
                        </div>
                    </div>

                </div>
            </div>

        </div>
    </div>
    
    <div class="mt-4 border-t border-gray-100 pt-6 flex items-center justify-between pb-6">
        <div class="flex items-center gap-3">
            <div class="bg-gray-50 rounded-xl p-1.5 flex items-center border border-gray-200 shadow-inner">
                <span class="text-[10px] font-bold text-gray-400 px-3">RESUME MATCH:</span>
                <input type="text" id="resume-code" placeholder="CODE" class="bg-transparent border-none w-20 text-left font-mono font-bold text-gray-700 focus:ring-0 text-sm p-0 uppercase placeholder-gray-300">
            </div>
            <button onclick="resumeMatch()" class="hidden md:block text-[10px] font-bold text-purple-600 bg-purple-50 px-4 py-2 rounded-xl border border-purple-100 hover:bg-purple-100 transition-colors shadow-sm">LOAD DATA</button>
        </div>
        <button onclick="goToStep(2)" class="px-10 py-4 bg-gradient-to-r from-blue-600 to-indigo-700 text-white font-black text-sm rounded-xl shadow-xl shadow-blue-500/30 hover:scale-[1.02] hover:shadow-2xl transition-all transform active:scale-[0.98] flex items-center gap-3">
            <span>CONFIRM SQUADS</span>
            <span class="bg-white/20 px-2 py-0.5 rounded text-[10px]">‚ûú</span>
        </button>
    </div>
</div>

<div id="tournament-setup" class="setup-step hidden w-full md:max-w-5xl mx-auto bg-[#F8F9FA] min-h-screen font-sans">
    
    <style>
        /* Professional Animations for this section */
        @keyframes slideUpFade {
            from { transform: translateY(15px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .animate-slide-up { animation: slideUpFade 0.4s ease-out forwards; }
        .delay-100 { animation-delay: 0.1s; }
        .delay-200 { animation-delay: 0.2s; }
        .delay-300 { animation-delay: 0.3s; }

        /* Wizard Stepper Active States */
        .step-active-bg { background-color: #1e3a8a !important; color: white !important; }
        .step-active-line { background-color: #1e3a8a !important; width: 100% !important; }
    </style>

    <div class="sticky top-0 z-40 bg-white border-b border-gray-200 shadow-sm">
        <div class="max-w-5xl mx-auto px-4 py-4 flex items-center justify-between">
            <button onclick="backToModeSelect()" class="group flex items-center gap-2 text-gray-500 hover:text-gray-900 transition-colors px-2 py-1 rounded hover:bg-gray-100">
                <span class="text-lg">‚Üê</span>
                <span class="text-xs font-bold uppercase tracking-wider">Dashboard</span>
            </button>
            
            <div class="flex items-center gap-2">
                 <div class="flex items-center gap-1">
                    <div id="wiz-dot-1" class="w-6 h-6 rounded-full bg-blue-900 text-white text-[10px] font-bold flex items-center justify-center transition-all duration-300">1</div>
                    <div class="w-8 h-0.5 bg-gray-200 rounded-full overflow-hidden">
                        <div id="wiz-line-1" class="h-full bg-gray-200 w-0 transition-all duration-500"></div>
                    </div>
                 </div>
                 <div class="flex items-center gap-1">
                    <div id="wiz-dot-2" class="w-6 h-6 rounded-full bg-gray-200 text-gray-400 text-[10px] font-bold flex items-center justify-center transition-all duration-300">2</div>
                    <div class="w-8 h-0.5 bg-gray-200 rounded-full overflow-hidden">
                        <div id="wiz-line-2" class="h-full bg-gray-200 w-0 transition-all duration-500"></div>
                    </div>
                 </div>
                 <div class="flex items-center gap-1">
                    <div id="wiz-dot-3" class="w-6 h-6 rounded-full bg-gray-200 text-gray-400 text-[10px] font-bold flex items-center justify-center transition-all duration-300">3</div>
                    <div class="w-8 h-0.5 bg-gray-200 rounded-full overflow-hidden">
                        <div id="wiz-line-3" class="h-full bg-gray-200 w-0 transition-all duration-500"></div>
                    </div>
                 </div>
                 <div id="wiz-dot-4" class="w-6 h-6 rounded-full bg-gray-200 text-gray-400 text-[10px] font-bold flex items-center justify-center transition-all duration-300">4</div>
            </div>
            
            <div class="w-20 text-right">
                <span class="text-[9px] font-bold text-gray-400 uppercase tracking-widest">SETUP</span>
            </div>
        </div>
    </div>

    <div id="tourney-page-1" class="w-full relative pb-40 animate-slide-up">
        <div class="max-w-3xl mx-auto px-4 mt-8 space-y-8">
            
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                <div class="bg-gray-50 px-6 py-3 border-b border-gray-200 flex items-center gap-2">
                    <span class="text-blue-600 font-bold text-lg">01.</span>
                    <h3 class="text-sm font-bold text-gray-800 uppercase tracking-wide">General Information</h3>
                </div>
                
                <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-xs font-bold text-gray-600 uppercase tracking-wider mb-2">Tournament Name <span class="text-red-500">*</span></label>
                        <input type="text" id="tourney-name" placeholder="e.g. Winter Cup 2026" 
                            class="w-full bg-white border border-gray-300 rounded-lg px-4 py-3 text-sm font-bold text-gray-900 focus:ring-2 focus:ring-blue-600 focus:border-blue-600 outline-none transition-all placeholder-gray-400">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-600 uppercase tracking-wider mb-2">Category</label>
                        <div class="relative">
                            <select id="tourney-category" class="w-full bg-white border border-gray-300 rounded-lg px-4 py-3 text-sm font-bold text-gray-900 focus:ring-2 focus:ring-blue-600 focus:border-blue-600 outline-none appearance-none cursor-pointer">
                                <option value="Open" selected>Open Tournament</option>
                                <option value="Corporate">Corporate League</option>
                                <option value="Community">Community Cup</option>
                                <option value="School">School / University</option>
                                <option value="Series">Bilateral Series</option>
                            </select>
                            <div class="absolute right-4 top-3.5 pointer-events-none text-gray-500 text-xs">‚ñº</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden animate-slide-up delay-100">
                <div class="bg-gray-50 px-6 py-3 border-b border-gray-200 flex items-center gap-2">
                    <span class="text-blue-600 font-bold text-lg">02.</span>
                    <h3 class="text-sm font-bold text-gray-800 uppercase tracking-wide">Logistics</h3>
                </div>
                
                <div class="p-6 space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-xs font-bold text-gray-600 uppercase tracking-wider mb-2">Organizer</label>
                            <input type="text" id="organizer-name" placeholder="Organization Name" 
                                class="w-full bg-white border border-gray-300 rounded-lg px-4 py-3 text-sm font-bold text-gray-900 focus:ring-2 focus:ring-blue-600 focus:border-blue-600 outline-none transition-all">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-600 uppercase tracking-wider mb-2">Host Country</label>
                            <div class="relative">
                                <select id="tourney-country" class="w-full bg-white border border-gray-300 rounded-lg px-4 py-3 text-sm font-bold text-gray-900 focus:ring-2 focus:ring-blue-600 focus:border-blue-600 outline-none appearance-none cursor-pointer">
                                    <option value="India">üáÆüá≥ India</option>
                                    <option value="Australia">üá¶üá∫ Australia</option>
                                    <option value="England">üá¨üáß England</option>
                                    <option value="Pakistan">üáµüá∞ Pakistan</option>
                                    <option value="Sri Lanka">üá±üá∞ Sri Lanka</option>
                                    <option value="South Africa">üáøüá¶ South Africa</option>
                                    <option value="Canada">üá®üá¶ Canada</option>
                                    <option value="USA">üá∫üá∏ USA</option>
                                    <option value="UAE">üá¶üá™ UAE</option>
                                    <option value="Other">üåç Other</option>
                                </select>
                                <div class="absolute right-4 top-3.5 pointer-events-none text-gray-500 text-xs">‚ñº</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                         <div>
                            <label class="block text-xs font-bold text-gray-600 uppercase tracking-wider mb-2">Start Date</label>
                            <input type="date" id="tourney-start-date" class="w-full bg-white border border-gray-300 rounded-lg px-4 py-3 text-sm font-bold text-gray-900 focus:ring-2 focus:ring-blue-600 focus:border-blue-600 outline-none">
                        </div>
                        <div>
                             <label class="block text-xs font-bold text-gray-600 uppercase tracking-wider mb-2">Venues</label>
                             <div class="relative">
                                <select id="tourney-ground-count" onchange="renderGroundInputs()" class="w-full bg-white border border-gray-300 rounded-lg px-4 py-3 text-sm font-bold text-gray-900 focus:ring-2 focus:ring-blue-600 focus:border-blue-600 outline-none appearance-none cursor-pointer">
                                    <option value="1" selected>1 Ground</option>
                                    <option value="2">2 Grounds</option>
                                    <option value="3">3 Grounds</option>
                                    <option value="4">4 Grounds</option>
                                    <option value="5">5 Grounds</option>
                                </select>
                                <div class="absolute right-4 top-3.5 pointer-events-none text-gray-500 text-xs">‚ñº</div>
                            </div>
                        </div>
                    </div>

                    <div id="dynamic-grounds-container" class="space-y-3 pt-2"></div>
                </div>
            </div>
            
            <input type="hidden" id="organizer-code">
        </div>

        <div class="fixed bottom-0 left-0 right-0 p-4 bg-white border-t border-gray-200 z-50">
            <div class="max-w-3xl mx-auto flex justify-end">
                <button onclick="updateStepper(2); nextTourneyStep()" class="px-8 py-3 bg-blue-900 text-white font-bold rounded-lg shadow hover:bg-black transition-all active:scale-[0.98] flex items-center gap-2 uppercase tracking-wide text-xs">
                    <span>Next: Rules</span>
                    <span>‚Üí</span>
                </button>
            </div>
        </div>
    </div>

    <div id="tourney-page-2" class="hidden w-full relative pb-40 animate-slide-up">
        <div class="max-w-3xl mx-auto px-4 mt-8 space-y-8">
            
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                <div class="bg-gray-50 px-6 py-3 border-b border-gray-200 flex items-center gap-2">
                    <span class="text-blue-600 font-bold text-lg">03.</span>
                    <h3 class="text-sm font-bold text-gray-800 uppercase tracking-wide">Match Format</h3>
                </div>
                <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="relative p-4 border border-gray-200 rounded-lg hover:border-blue-500 transition-colors bg-gray-50">
                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Overs Per Innings</label>
                        <select id="tourney-overs" onchange="document.getElementById('disp-overs').innerText = this.value" class="w-full bg-transparent text-2xl font-black text-gray-900 outline-none cursor-pointer z-10 relative py-2">
                            <option value="6" selected>6 Overs</option>
                            <option value="8">8 Overs</option>
                            <option value="10">10 Overs</option>
                            <option value="12">12 Overs</option>
                            <option value="15">15 Overs</option>
                            <option value="20">20 Overs</option>
                        </select>
                         <div class="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-gray-400 text-xs">‚ñº</div>
                    </div>
                    
                    <div class="relative p-4 border border-gray-200 rounded-lg hover:border-blue-500 transition-colors bg-gray-50">
                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Squad Size</label>
                        <select id="tourney-players" onchange="document.getElementById('disp-players').innerText = this.value" class="w-full bg-transparent text-2xl font-black text-gray-900 outline-none cursor-pointer z-10 relative py-2">
                            <option value="8" selected>8 Players</option>
                            <option value="6">6 Players</option>
                            <option value="7">7 Players</option>
                            <option value="9">9 Players</option>
                            <option value="11">11 Players</option>
                        </select>
                        <div class="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-gray-400 text-xs">‚ñº</div>
                        <div class="hidden" id="disp-overs"></div><div class="hidden" id="disp-players"></div>
                    </div>
                </div>
                 <input type="hidden" id="tourney-wickets" value="10">
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                    <div class="bg-gray-50 px-6 py-3 border-b border-gray-200 flex items-center gap-2">
                        <span class="text-blue-600 font-bold text-lg">04.</span>
                        <h3 class="text-sm font-bold text-gray-800 uppercase tracking-wide">League Configuration</h3>
                    </div>
                    <div class="p-4 space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Total Teams</label>
                                <select id="tourney-team-count" onchange="renderTournamentSlots()" class="w-full bg-white border border-gray-300 rounded-lg px-3 py-2 text-xs font-bold text-gray-800 outline-none focus:border-blue-500">
                                    <option value="" selected disabled>Select...</option>
                                    <option value="2">2 Teams</option>
                                    <option value="3">3 Teams</option>
                                    <option value="4">4 Teams</option>
                                    <option value="5">5 Teams</option>
                                    <option value="6">6 Teams</option>
                                    <option value="8">8 Teams</option>
                                    <option value="10">10 Teams</option>
                                    <option value="12">12 Teams</option>
                                    <option value="14">14 Teams</option>
                                    <option value="16">16 Teams</option>
                                    <option value="18">18 Teams</option>
                                    <option value="20">20 Teams</option>
                                    <option value="24">24 Teams</option>
                                    <option value="32">32 Teams</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Group Stage</label>
                                <select id="tourney-group-mode" onchange="renderTournamentSlots()" class="w-full bg-white border border-gray-300 rounded-lg px-3 py-2 text-xs font-bold text-gray-800 outline-none focus:border-blue-500">
                                    <option value="1" selected>1 Single Group</option>
                                    <option value="2">2 Groups (A-B)</option>
                                    <option value="3">3 Groups (A-C)</option>
                                    <option value="4">4 Groups (A-D)</option>
                                    <option value="5">5 Groups (A-E)</option>
                                    <option value="6">6 Groups (A-F)</option>
                                    <option value="8">8 Groups (A-H)</option>
                                    <option value="10">10 Groups (A-J)</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Matches Per Team</label>
                            <div class="relative">
                                <select id="tourney-rounds-count" class="w-full bg-white border border-gray-300 rounded-lg px-3 py-2 text-xs font-bold text-gray-800 outline-none focus:border-blue-500 appearance-none">
                                    <option value="1" selected>1 Match</option>
                                    <option value="2">2 Matches</option>
                                    <option value="3">3 Matches</option>
                                    <option value="4">4 Matches</option>
                                    <option value="5">5 Matches</option>
                                    <option value="6">6 Matches</option>
                                    <option value="7">7 Matches</option>
                                    <option value="8">8 Matches</option>
                                    <option value="9">9 Matches</option>
                                    <option value="10">10 Matches</option>
                                    <option value="11">11 Matches</option>
                                    <option value="12">12 Matches</option>
                                    <option value="13">13 Matches</option>
                                    <option value="14">14 Matches</option>
                                    <option value="15">15 Matches</option>
                                    <option value="16">16 Matches</option>
                                    <option value="17">17 Matches</option>
                                    <option value="18">18 Matches</option>
                                    <option value="19">19 Matches</option>
                                    <option value="20">20 Matches</option>
                                </select>
                                <div class="absolute right-3 top-2.5 pointer-events-none text-gray-400 text-[10px]">‚ñº</div>
                            </div>
                        </div>

                        <div>
                            <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Qualification Rule</label>
                            <select id="tourney-qualify-rule" class="w-full bg-white border border-gray-300 rounded-lg px-3 py-2 text-xs font-bold text-gray-800 outline-none focus:border-blue-500">
                                <option value="TOP_4">Top 4 Teams Qualify (Semis)</option>
                                <option value="TOP_2">Top 2 Teams Qualify (Final)</option>
                                <option value="TOP_8">Top 8 Teams Qualify (Quarters)</option>
                                <option value="TOP_1">Table Topper Declared Winner</option>
                                <option value="GROUP_TOP">Group Toppers Only</option>
                                <option value="GROUP_TOP_2">Top 2 from Each Group</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                     <div class="bg-gray-50 px-6 py-3 border-b border-gray-200 flex items-center gap-2">
                        <span class="text-blue-600 font-bold text-lg">05.</span>
                        <h3 class="text-sm font-bold text-gray-800 uppercase tracking-wide">Points System</h3>
                    </div>
                    <div class="p-4 grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-[9px] font-bold text-green-600 uppercase mb-1">Win</label>
                            <input type="number" value="2" class="w-full border border-gray-200 rounded p-2 text-center font-bold text-sm outline-none focus:ring-1 focus:ring-green-500">
                        </div>
                        <div>
                            <label class="block text-[9px] font-bold text-blue-600 uppercase mb-1">Tie / NR</label>
                            <input type="number" value="1" class="w-full border border-gray-200 rounded p-2 text-center font-bold text-sm outline-none focus:ring-1 focus:ring-blue-500">
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden animate-slide-up delay-100">
                <div class="bg-gray-50 px-6 py-3 border-b border-gray-200 flex items-center gap-2">
                    <span class="text-blue-600 font-bold text-lg">06.</span>
                    <h3 class="text-sm font-bold text-gray-800 uppercase tracking-wide">Penalties & Ball Type</h3>
                </div>
                
                <div class="p-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="bg-red-50/50 rounded-lg p-4 border border-red-100 flex justify-between items-center">
                            <div>
                                <span class="block text-xs font-bold text-red-600 uppercase mb-1">Wide Ball</span>
                            </div>
                            <div class="relative w-32">
                                <select id="tourney-wide-runs" class="w-full bg-white rounded border border-red-200 px-3 py-2 text-sm font-bold text-gray-900 outline-none focus:border-red-500">
                                    <option value="-1">-1</option>
                                    <option value="0">0</option>
                                    <option value="1" selected>+1 Run</option>
                                    <option value="2">+2 Runs</option>
                                </select>
                            </div>
                        </div>
                        <div class="bg-red-50/50 rounded-lg p-4 border border-red-100 flex justify-between items-center">
                            <div>
                                <span class="block text-xs font-bold text-red-600 uppercase mb-1">No Ball</span>
                            </div>
                            <div class="relative w-32">
                                <select id="tourney-noball-runs" class="w-full bg-white rounded border border-red-200 px-3 py-2 text-sm font-bold text-gray-900 outline-none focus:border-red-500">
                                    <option value="-1">-1</option>
                                    <option value="0">0</option>
                                    <option value="1" selected>+1 Run</option>
                                    <option value="2">+2 Runs</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <input type="hidden" id="tourney-ball-type" value="Soft Ball">
                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-3">Select Ball Type</label>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <button onclick="setBallType('Soft Ball', this)" class="ball-card selected border-2 border-blue-600 bg-blue-50 text-blue-900 rounded-lg p-3 text-sm font-bold transition-all">Soft Ball</button>
                        <button onclick="setBallType('Tape Ball', this)" class="ball-card border border-gray-200 bg-white text-gray-600 rounded-lg p-3 text-sm font-bold hover:border-blue-400 transition-all">Tape Ball</button>
                        <button onclick="setBallType('MRI', this)" class="ball-card border border-gray-200 bg-white text-gray-600 rounded-lg p-3 text-sm font-bold hover:border-blue-400 transition-all">MRI</button>
                        <button onclick="setBallType('Leather Ball', this)" class="ball-card border border-gray-200 bg-white text-gray-600 rounded-lg p-3 text-sm font-bold hover:border-blue-400 transition-all">Leather</button>
                    </div>
                    <div class="check-icon hidden"></div> 
                </div>
            </div>
        </div>

        <div class="fixed bottom-0 left-0 right-0 p-4 bg-white border-t border-gray-200 z-50">
            <div class="max-w-3xl mx-auto flex justify-between">
                <button onclick="updateStepper(1); document.getElementById('tourney-page-2').classList.add('hidden'); document.getElementById('tourney-page-1').classList.remove('hidden');" class="px-6 py-3 text-gray-500 font-bold text-xs uppercase hover:text-gray-900">
                    ‚Üê Back
                </button>
                <button onclick="updateStepper(3); nextTourneyStep()" class="px-8 py-3 bg-blue-900 text-white font-bold rounded-lg shadow hover:bg-black transition-all active:scale-[0.98] flex items-center gap-2 uppercase tracking-wide text-xs">
                    <span>Next: Teams</span>
                    <span>‚Üí</span>
                </button>
            </div>
        </div>
    </div>

    <div id="tourney-page-3" class="hidden w-full relative pb-40 animate-slide-up">
        <div class="max-w-3xl mx-auto px-4 mt-8 space-y-8">
            
             <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                <div class="bg-gray-50 px-6 py-3 border-b border-gray-200 flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <span class="text-blue-600 font-bold text-lg">07.</span>
                        <h3 class="text-sm font-bold text-gray-800 uppercase tracking-wide">Participating Teams</h3>
                    </div>
                </div>

                <div class="p-6">
                    <div id="tournament-slots-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="col-span-1 md:col-span-2 text-center py-12 border-2 border-dashed border-gray-300 rounded-lg">
                            <p class="text-xs font-bold text-gray-400 uppercase tracking-wide">Select Team Count in 'League Rules' to begin</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="fixed bottom-0 left-0 right-0 p-4 bg-white border-t border-gray-200 z-50">
            <div class="max-w-3xl mx-auto flex justify-between">
                <button onclick="updateStepper(2); document.getElementById('tourney-page-3').classList.add('hidden'); document.getElementById('tourney-page-2').classList.remove('hidden');" class="px-6 py-3 text-gray-500 font-bold text-xs uppercase hover:text-gray-900">
                    ‚Üê Back
                </button>
                <button onclick="updateStepper(4); nextTourneyStep()" class="px-8 py-3 bg-blue-900 text-white font-bold rounded-lg shadow hover:bg-black transition-all active:scale-[0.98] flex items-center gap-2 uppercase tracking-wide text-xs">
                    <span>Next: Schedule</span>
                    <span>‚Üí</span>
                </button>
            </div>
        </div>
    </div>

    <div id="tourney-page-4" class="hidden w-full relative pb-40 animate-slide-up">
        <div class="max-w-5xl mx-auto px-4 mt-6 pb-32">
            
            <div class="w-full mb-8 bg-white border border-gray-200 rounded-xl shadow-sm p-5 animate-slide-up">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                    <div>
                        <h3 class="text-sm font-black text-gray-900 uppercase tracking-wide">Tournament Share Link</h3>
                        <p class="text-[10px] text-gray-400 font-bold uppercase tracking-wider mt-1">Anyone with this link can view standings & schedule</p>
                    </div>
                    <div class="flex items-center gap-2 w-full md:w-auto">
                        <div class="flex-grow md:w-80 relative">
                            <input type="text" id="public-tourney-link" readonly value="Generating..." class="w-full bg-gray-50 border border-gray-200 text-gray-600 text-xs font-bold rounded-lg px-3 py-2.5 outline-none select-all">
                        </div>
                        <button onclick="copyTourneyLink()" class="bg-gray-100 hover:bg-gray-200 text-gray-600 border border-gray-200 px-3 py-2.5 rounded-lg text-xs font-bold uppercase transition-colors">
                            Copy
                        </button>
                        <button onclick="openTourneyLink()" class="bg-blue-50 hover:bg-blue-100 text-blue-600 border border-blue-200 px-3 py-2.5 rounded-lg text-xs font-bold uppercase transition-colors">
                            Open
                        </button>
                    </div>
                </div>
            </div>

            <div class="w-full animate-slide-up delay-200">
                 <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-gray-900 uppercase tracking-wide">Match Schedule</h3>
                    <div class="flex gap-2">
                        <button onclick="addScheduleRow('League Match')" class="bg-white border border-gray-300 text-gray-700 px-3 py-2 rounded-lg text-[10px] font-bold uppercase tracking-wide hover:bg-gray-50 shadow-sm transition-colors">+ Manual</button>
                        
                        <button onclick="generateProfessionalSchedule()" class="bg-blue-600 border border-blue-600 text-white px-3 py-2 rounded-lg text-[10px] font-bold uppercase tracking-wide hover:bg-blue-700 shadow-sm transition-colors flex items-center gap-1">
                            <span>‚ö° Auto Gen</span>
                        </button>
                    </div>
                </div>

                <div class="bg-white border border-gray-200 rounded-xl shadow-sm min-h-[400px] p-4 relative">
                    <div id="schedule-rows" class="space-y-3 h-[400px] overflow-y-auto pr-2 custom-scroll">
                        <div class="flex flex-col items-center justify-center h-full text-gray-300 space-y-2">
                            <span class="text-4xl opacity-50">üìÖ</span>
                            <p class="text-xs font-bold uppercase tracking-wide">No Matches Scheduled</p>
                            <p class="text-[10px]">Use 'Auto Gen' to create fixtures based on settings.</p>
                        </div>
                    </div>
                    
                    <div class="absolute bottom-4 left-4 right-4">
                         <button onclick="addScheduleRow('Final')" class="w-full py-2 bg-yellow-50 text-yellow-800 font-bold rounded border border-yellow-300 uppercase tracking-wide text-[10px] hover:bg-yellow-100 transition shadow-sm border-dashed hover:border-solid">
                            + Add Final Match Card
                        </button>
                    </div>
                </div>
            </div>

        </div>

        <div class="fixed bottom-0 left-0 right-0 p-4 bg-white border-t border-gray-200 z-50">
            <div class="max-w-4xl mx-auto flex justify-between items-center">
                <button onclick="updateStepper(3); document.getElementById('tourney-page-4').classList.add('hidden'); document.getElementById('tourney-page-3').classList.remove('hidden');" class="px-6 py-3 text-gray-500 font-bold text-xs uppercase hover:text-gray-900">
                    ‚Üê Back
                </button>
                <button id="btn-create-tourney" onclick="createProfessionalTournament()" class="animate-gradient-x px-12 py-4 bg-gradient-to-r from-emerald-500 via-green-400 to-teal-500 text-white font-black rounded-xl shadow-[0_0_25px_rgba(16,185,129,0.6)] hover:shadow-[0_0_35px_rgba(16,185,129,0.8)] hover:scale-105 transition-all duration-300 active:scale-95 flex flex-col items-center justify-center gap-1 uppercase tracking-widest border border-white/20">
                    <span class="text-sm drop-shadow-md flex items-center gap-2">Start Playing üöÄ</span>
                    <span class="text-[9px] text-white font-bold tracking-[0.3em] opacity-90 animate-pulse">‚ú® Let's Crickerr ‚ú®</span>
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // 1. Wizard Stepper Logic
        function updateStepper(step) {
            for(let i=1; i<=4; i++) {
                const dot = document.getElementById(`wiz-dot-${i}`);
                const line = document.getElementById(`wiz-line-${i-1}`);
                if(dot) {
                    dot.classList.remove('step-active-bg', 'bg-blue-900', 'text-white');
                    dot.classList.add('bg-gray-200', 'text-gray-400');
                }
                if (i > 1 && line) {
                    line.classList.remove('step-active-line', 'bg-blue-900', 'w-full');
                    line.classList.add('bg-gray-200', 'w-0');
                }
            }
            for(let i=1; i<=step; i++) {
                const dot = document.getElementById(`wiz-dot-${i}`);
                const line = document.getElementById(`wiz-line-${i-1}`);
                if(dot) {
                    dot.classList.remove('bg-gray-200', 'text-gray-400');
                    dot.classList.add('step-active-bg'); 
                }
                if (i > 1 && line) {
                    line.classList.remove('bg-gray-200', 'w-0');
                    line.classList.add('step-active-line');
                }
            }
        }
        
        // 2. Render Team Input Slots (Auto-filled from Page 2 settings)
        window.renderTournamentSlots = function() {
            const count = parseInt(document.getElementById('tourney-team-count').value);
            const container = document.getElementById('tournament-slots-container');
            const groupModeEl = document.getElementById('tourney-group-mode');
            const groupMode = groupModeEl ? parseInt(groupModeEl.value) : 1;
            
            if (!container || isNaN(count)) return;
            
            container.innerHTML = '';
            
            // Generate letters A through J (or more) dynamically
            const allGroups = Array.from({length: 26}, (_, i) => String.fromCharCode(65 + i)); // ['A', 'B', 'C'...]

            // Helper to generate group options
            const getGroupOptions = (defaultIdx) => {
                if (groupMode === 1) return ''; 
                
                let opts = '';
                const limit = groupMode; 
                // Auto-assign logic: 0->A, 1->B, 2->C...
                const autoGroupChar = allGroups[defaultIdx % limit];

                for(let g=0; g<limit; g++) {
                    const char = allGroups[g];
                    const selected = (char === autoGroupChar) ? 'selected' : '';
                    opts += `<option value="${char}" ${selected}>Group ${char}</option>`;
                }
                
                return `
                    <div class="w-24 border-l border-gray-200 pl-2">
                        <label class="block text-[9px] font-bold text-gray-400 uppercase tracking-wider mb-1">Group</label>
                        <select class="tourney-team-group w-full bg-white border border-gray-300 rounded px-2 py-2 text-xs font-bold text-gray-800 outline-none focus:border-blue-500 cursor-pointer">
                            ${opts}
                        </select>
                    </div>
                `;
            };

            for(let i = 0; i < count; i++) {
                const groupSelectHTML = getGroupOptions(i);
                
                container.innerHTML += `
                    <div class="bg-gray-50 p-3 rounded-lg border border-gray-200 flex items-center gap-3 animate-slide-up" style="animation-delay: ${i*50}ms">
                        <div class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 font-bold flex items-center justify-center text-xs shadow-sm flex-shrink-0">${i+1}</div>
                        <div class="flex-1">
                            <label class="block text-[9px] font-bold text-gray-400 uppercase tracking-wider mb-1">Team Name</label>
                            <input type="text" placeholder="Team ${i+1}" class="tourney-team-select w-full bg-white border border-gray-300 rounded px-3 py-2 text-sm font-bold text-gray-900 outline-none focus:border-blue-500 transition-all">
                        </div>
                        ${groupSelectHTML}
                    </div>
                `;
            }
        };

        // 3. Add Schedule Row Helper (Styled for Finals/Semis)
        window.addScheduleRow = function(matchType, prefill = null) {
            const container = document.getElementById('schedule-rows');
            
            if (container.children.length > 0 && container.children[0].innerText.includes('No Matches')) {
                container.innerHTML = '';
            }

            const matchId = 'match-' + new Date().getTime() + Math.random();
            const t1Val = prefill ? prefill.t1 : '';
            const t2Val = prefill ? prefill.t2 : '';
            
            // Dynamic Styles based on Match Type
            let cardClass = "bg-white border-gray-200 hover:border-blue-300";
            let badgeClass = "bg-gray-100 text-gray-400";
            let inputClass = "bg-gray-50 border-gray-200 focus:border-blue-500";
            let vsClass = "text-gray-400";

            if (matchType.includes('Final') && !matchType.includes('Semi')) {
                // Gold Theme for Final
                cardClass = "bg-gradient-to-r from-yellow-50 via-amber-50 to-yellow-50 border-yellow-300 shadow-md transform scale-[1.02]";
                badgeClass = "bg-gradient-to-r from-yellow-400 to-orange-400 text-white shadow-sm";
                inputClass = "bg-white/80 border-yellow-200 focus:border-yellow-500 text-yellow-900 placeholder-yellow-300";
                vsClass = "text-yellow-500 font-black";
            } else if (matchType.includes('Semi')) {
                // Blue/Bronze Theme for Semis
                cardClass = "bg-gradient-to-r from-slate-50 to-blue-50 border-blue-200 shadow-sm";
                badgeClass = "bg-blue-100 text-blue-700 border border-blue-200";
                inputClass = "bg-white border-blue-100 focus:border-blue-400 text-blue-900";
                vsClass = "text-blue-300 font-black";
            } else if (matchType.includes('Quarter')) {
                // Slight highlight for QF
                cardClass = "bg-gray-50 border-gray-300";
                badgeClass = "bg-gray-200 text-gray-600";
            }

            const rowHtml = `
            <div id="${matchId}" class="schedule-card ${cardClass} border rounded-xl p-4 mb-3 animate-slide-up relative group transition-all">
                <div class="flex justify-between items-center mb-3">
                    <span class="text-[10px] font-black uppercase tracking-widest px-3 py-1 rounded-full ${badgeClass}">${matchType}</span>
                    <button onclick="document.getElementById('${matchId}').remove()" class="text-gray-300 hover:text-red-500 transition-colors px-2">√ó</button>
                </div>
                <div class="flex items-center gap-3">
                    <div class="flex-1 relative">
                        ${matchType.includes('Final') ? '<span class="absolute -top-2 -left-1 text-[8px] text-yellow-600 font-bold uppercase tracking-wider">Home</span>' : ''}
                        <input type="text" placeholder="Team A" value="${t1Val}" class="match-team-a w-full ${inputClass} border rounded-lg px-3 py-2.5 text-xs font-bold outline-none transition-all shadow-sm">
                    </div>
                    <span class="text-[10px] ${vsClass}">VS</span>
                    <div class="flex-1 relative">
                        ${matchType.includes('Final') ? '<span class="absolute -top-2 -right-1 text-[8px] text-yellow-600 font-bold uppercase tracking-wider">Away</span>' : ''}
                        <input type="text" placeholder="Team B" value="${t2Val}" class="match-team-b w-full ${inputClass} border rounded-lg px-3 py-2.5 text-xs font-bold outline-none transition-all shadow-sm">
                    </div>
                </div>
            </div>`;
            
            container.insertAdjacentHTML('beforeend', rowHtml);
        };

        // 4. Auto-Generate Schedule Logic (Knockout Aware & Persist Placeholders)
        window.generateProfessionalSchedule = function() {
            // Get Config
            const matchesPerTeam = parseInt(document.getElementById('tourney-rounds-count').value) || 1;
            const qualifyRule = document.getElementById('tourney-qualify-rule').value;
            const groupModeEl = document.getElementById('tourney-group-mode');
            const numGroups = groupModeEl ? parseInt(groupModeEl.value) : 1;
            
            // Get Teams from Inputs
            const teams = [];
            document.querySelectorAll('.tourney-team-select').forEach(sel => {
                if(sel.value.trim() !== "") teams.push(sel.value);
                else teams.push(sel.placeholder); 
            });

            if (teams.length < 2) {
                alert("Please enter at least 2 teams to generate a schedule.");
                return;
            }

            // Clear Table
            const container = document.getElementById('schedule-rows');
            container.innerHTML = '';

            // --- A. Generate League Matches (Standard Circle Method) ---
            let pool = [...teams];
            if (pool.length % 2 !== 0) pool.push(null); // Add dummy for Bye

            const totalTeams = pool.length;
            const half = totalTeams / 2;

            for (let round = 0; round < matchesPerTeam; round++) {
                for (let i = 0; i < half; i++) {
                    const t1 = pool[i];
                    const t2 = pool[totalTeams - 1 - i];

                    if (t1 && t2) {
                        const home = (round % 2 === 0) ? t1 : t2;
                        const away = (round % 2 === 0) ? t2 : t1;
                        addScheduleRow(`League Match`, { t1: home, t2: away });
                    }
                }

                // Rotate Pool
                const fixed = pool[0];
                const rotated = pool.slice(1);
                const last = rotated.pop();
                rotated.unshift(last);
                pool = [fixed, ...rotated];
            }

            // --- B. Generate Knockouts with Force-Injected Placeholders ---
            // This ensures "Winner SF1" etc. are saved as valid teams instead of being cleared.

            const addKnockoutRow = (type, t1Text, t2Text) => {
                addScheduleRow(type, { t1: t1Text, t2: t2Text });
                
                // FORCE INJECT OPTIONS: The default dropdowns wipe unknown values.
                // We must re-inject these placeholders so they pass validation when saving.
                const lastCard = container.lastElementChild;
                if(lastCard) {
                    const inject = (sel, val) => {
                        if(val && val !== "TBD" && !Array.from(sel.options).some(o => o.value === val)) {
                            const opt = document.createElement('option');
                            opt.value = val;
                            opt.text = val;
                            sel.add(opt);
                            sel.value = val; // Force selection
                        }
                    };
                    inject(lastCard.querySelector('.sch-t1'), t1Text);
                    inject(lastCard.querySelector('.sch-t2'), t2Text);
                }
            };
            
            if (qualifyRule === 'TOP_4') {
                if (teams.length >= 4) {
                    addKnockoutRow('Semi Final 1', "1st Place", "4th Place");
                    addKnockoutRow('Semi Final 2', "2nd Place", "3rd Place");
                    addKnockoutRow('Final', "Winner SF1", "Winner SF2");
                } else {
                    addKnockoutRow('Final', "1st Place", "2nd Place");
                }
            } 
            else if (qualifyRule === 'TOP_2') {
                addKnockoutRow('Final', "1st Place", "2nd Place");
            }
            else if (qualifyRule === 'TOP_8' && teams.length >= 8) {
                addKnockoutRow('Quarter Final 1', "1st", "8th");
                addKnockoutRow('Quarter Final 2', "2nd", "7th");
                addKnockoutRow('Quarter Final 3', "3rd", "6th");
                addKnockoutRow('Quarter Final 4', "4th", "5th");
                addKnockoutRow('Semi Final 1', "Winner QF1", "Winner QF4");
                addKnockoutRow('Semi Final 2', "Winner QF2", "Winner QF3");
                addKnockoutRow('Final', "Winner SF1", "Winner SF2");
            }
            else if (qualifyRule === 'GROUP_TOP') {
                if (numGroups === 2) {
                    addKnockoutRow('Final', "Winner Group A", "Winner Group B");
                } else if (numGroups === 4) {
                    addKnockoutRow('Semi Final 1', "Winner Group A", "Winner Group D");
                    addKnockoutRow('Semi Final 2', "Winner Group B", "Winner Group C");
                    addKnockoutRow('Final', "Winner SF1", "Winner SF2");
                } else {
                    addKnockoutRow('Final', "Top Ranked 1", "Top Ranked 2");
                }
            }
            else if (qualifyRule === 'GROUP_TOP_2') {
                if (numGroups === 2) {
                    addKnockoutRow('Semi Final 1', "A1 (Winner A)", "B2 (Runner B)");
                    addKnockoutRow('Semi Final 2', "B1 (Winner B)", "A2 (Runner A)");
                    addKnockoutRow('Final', "Winner SF1", "Winner SF2");
                } else {
                     addKnockoutRow('Final', "Qualifier 1", "Qualifier 2");
                }
            }
        };

        // Initialize Step 1
        updateStepper(1);
    </script>
</div>

<div id="tournament-dashboard" class="setup-step hidden w-full h-full md:h-[80vh] flex flex-col md:flex-row bg-gray-100 rounded-2xl overflow-hidden border border-gray-200">
    <div class="w-full md:w-64 bg-white border-r border-gray-200 flex flex-col">
        <div class="p-6 border-b border-gray-100">
            <h2 id="dashboard-title" class="text-xl font-black text-purple-700 uppercase leading-tight">Tournament</h2>
            <p class="text-[10px] text-gray-400 font-bold mt-1">ID: <span id="dashboard-id" class="select-all">---</span></p>
        </div>
        <nav class="flex-grow p-4 space-y-2">
            <button onclick="switchDashTab('fixtures')" id="tab-fixtures" class="w-full text-left p-3 rounded-xl font-bold text-xs uppercase bg-purple-50 text-purple-700">üìÖ Matches</button>
            <button onclick="switchDashTab('standings')" id="tab-standings" class="w-full text-left p-3 rounded-xl font-bold text-xs uppercase text-gray-500 hover:bg-gray-50">üèÜ Standings</button>
            <button onclick="switchDashTab('stats')" id="tab-stats" class="w-full text-left p-3 rounded-xl font-bold text-xs uppercase text-gray-500 hover:bg-gray-50">üìä Player Stats</button>
        </nav>
        <div class="p-4 border-t border-gray-100">
            <button onclick="exitTournament()" class="w-full p-3 border border-red-200 text-red-600 rounded-xl font-bold text-xs uppercase hover:bg-red-50">Exit Dashboard</button>
        </div>
    </div>

    <div class="flex-grow bg-gray-50 overflow-y-auto custom-scroll p-4 md:p-8 relative">
        
        <div id="view-fixtures" class="dash-view h-full flex flex-col">
    <div class="flex justify-between items-center mb-6 shrink-0 bg-white p-4 rounded-xl shadow-sm border border-gray-100">
        <div>
            <h3 class="text-xl font-black text-gray-900 uppercase tracking-tight">Match Center</h3>
            <p class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">Tap a card to start/edit match</p>
        </div>
        <button onclick="quickCreateMatch()" class="bg-blue-600 text-white w-10 h-10 rounded-full font-black shadow-lg hover:bg-blue-700 flex items-center justify-center transition-transform active:scale-95 text-xl">
            +
        </button>
    </div>

    <div id="kanban-board" class="flex-grow overflow-y-auto custom-scroll space-y-8 pb-10">
        </div>
</div>

        <div id="view-standings" class="dash-view hidden">
            <h3 class="text-2xl font-black text-gray-800 mb-6 uppercase">Points Table</h3>
            <div class="bg-white rounded-xl border border-gray-200 overflow-hidden shadow-sm">
                <table class="w-full text-left text-xs">
                    <thead class="bg-gray-100 border-b">
                        <tr>
                            <th class="p-4 font-black text-gray-500">TEAM</th>
                            <th class="p-4 font-black text-gray-500 text-center">P</th>
                            <th class="p-4 font-black text-gray-500 text-center">W</th>
                            <th class="p-4 font-black text-gray-500 text-center">L</th>
                            <th class="p-4 font-black text-gray-500 text-center">NRR</th>
                            <th class="p-4 font-black text-purple-600 text-center">PTS</th>
                        </tr>
                    </thead>
                    <tbody id="standings-body"></tbody>
                </table>
            </div>
        </div>

        <div id="view-stats" class="dash-view hidden">
            <h3 class="text-2xl font-black text-gray-800 mb-6 uppercase">Tournament Stats</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
                    <h4 class="text-xs font-black text-orange-500 uppercase tracking-widest mb-4">Top Run Scorers</h4>
                    <div id="stats-runs" class="space-y-2"></div>
                </div>
                <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
                    <h4 class="text-xs font-black text-blue-500 uppercase tracking-widest mb-4">Top Wicket Takers</h4>
                    <div id="stats-wickets" class="space-y-2"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="add-match-modal" class="modal-overlay fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-[60] flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl w-full max-w-md shadow-2xl overflow-hidden">
        <div class="p-5 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
            <h3 class="text-lg font-black text-gray-800 uppercase tracking-tight">Create Fixture</h3>
            <button onclick="closeModal('add-match-modal')" class="text-gray-400 hover:text-gray-600 font-bold">‚úï</button>
        </div>
        
        <div class="p-6 space-y-4">
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Team A</label>
                    <select id="am-team-a" class="w-full p-3 border rounded-xl font-bold text-sm bg-blue-50/50 border-blue-100 text-blue-900 outline-none focus:ring-2 focus:ring-blue-500"></select>
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Team B</label>
                    <select id="am-team-b" class="w-full p-3 border rounded-xl font-bold text-sm bg-red-50/50 border-red-100 text-red-900 outline-none focus:ring-2 focus:ring-red-500"></select>
                </div>
            </div>

            <div>
                <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Stage / Round Name</label>
                <input type="text" id="am-stage" placeholder="e.g. League Match 1, Semi Final" class="w-full p-3 border rounded-xl font-bold text-sm outline-none focus:border-purple-500 uppercase">
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Group (Optional)</label>
                    <select id="am-group" class="w-full p-3 border rounded-xl font-bold text-sm outline-none">
                        <option value="">None</option>
                        <option value="A">Group A</option>
                        <option value="B">Group B</option>
                        <option value="C">Group C</option>
                        <option value="D">Group D</option>
                    </select>
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Overs</label>
                    <input type="number" id="am-overs" value="16" class="w-full p-3 border rounded-xl font-bold text-sm outline-none">
                </div>
            </div>

            <button onclick="saveManualMatch()" class="w-full py-4 bg-gray-900 text-white font-black rounded-xl shadow-lg hover:bg-black transition-transform active:scale-95 uppercase tracking-widest text-xs mt-2">
                Save Match
            </button>
        </div>
    </div>
</div>

<div id="setup-step-2" class="setup-step hidden w-full">
    <button onclick="goToStep(1)" class="mb-4 text-xs font-bold text-gray-400 hover:text-gray-600 uppercase tracking-wider">‚Üê Back to Configuration</button>
    
    <header class="text-center mb-6">
        <h1 class="text-2xl font-black text-gray-800 uppercase">Build Formation</h1>
        <p class="text-xs text-blue-600 font-bold uppercase tracking-wider bg-blue-50 inline-block px-3 py-1 rounded-full mt-2">
            ‚áÖ Drag players to set Batting Order
        </p>
    </header>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-white rounded-xl shadow-sm border border-blue-200 h-full flex flex-col">
                            <div class="bg-blue-50 p-4 border-b flex items-center gap-3"><img id="team1-roster-logo" class="w-10 h-10 rounded-full object-cover"><h2 id="team1-roster-title" class="font-bold text-lg text-blue-900">HOME</h2><span id="team1-count-badge" class="ml-auto text-xs bg-white px-2 py-1 rounded border">0/0</span></div>
                            <div id="team1-player-inputs" class="flex-grow overflow-y-auto max-h-[50vh] p-2 space-y-1 custom-scroll"></div>
                            <div class="p-2 border-t"><button onclick="addNewPlayerToRoster('team1')" class="w-full py-2 border-dashed border-2 text-sm font-bold text-gray-500 rounded hover:text-blue-600">+ Add New Player</button></div>
                        </div>
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 h-full flex flex-col">
                            <div class="bg-gray-100 p-4 border-b flex items-center gap-3"><img id="team2-roster-logo" class="w-10 h-10 rounded-full object-cover"><h2 id="team2-roster-title" class="font-bold text-lg text-gray-800">AWAY</h2><span id="team2-count-badge" class="ml-auto text-xs bg-white px-2 py-1 rounded border">0/0</span></div>
                            <div id="team2-player-inputs" class="flex-grow overflow-y-auto max-h-[50vh] p-2 space-y-1 custom-scroll"></div>
                            <div class="p-2 border-t"><button onclick="addNewPlayerToRoster('team2')" class="w-full py-2 border-dashed border-2 text-sm font-bold text-gray-500 rounded hover:text-gray-800">+ Add New Player</button></div>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-between"><button onclick="goToStep(1)" class="text-gray-500 font-bold px-4">‚Üê Back</button><button onclick="proceedFromUnifiedRoster()" id="btn-roster-confirm" class="px-8 py-3 bg-blue-600 text-white font-bold rounded-xl shadow">Confirm & Toss ‚Üí</button></div>
                </div>

                <div id="setup-step-4" class="setup-step hidden w-full max-w-md mx-auto pb-20 pt-4">
                    <div class="text-left w-full mb-6">
                        <button onclick="goToStep(2)" class="text-xs font-bold text-gray-400 hover:text-gray-600 uppercase tracking-wider">‚Üê Back to Squads</button>
                    </div>
                    
                    <div class="mb-10 text-center">
                        <h1 class="text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-600 via-purple-600 to-pink-600 tracking-tight drop-shadow-sm">Toss Time</h1>
                        <p class="text-gray-500 font-bold text-xs uppercase tracking-[0.2em] mt-2">Who won the toss?</p>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-5 mb-10">
                        <div id="toss-winner-team1" onclick="selectTossWinner('team1')" 
                             class="toss-card-btn group relative flex flex-col items-center justify-center p-5 bg-white border-2 border-transparent rounded-3xl shadow-[0_10px_30px_-10px_rgba(0,0,0,0.1)] cursor-pointer transition-all duration-300 hover:scale-[1.03] active:scale-95 h-48">
                            <div class="absolute inset-0 bg-gradient-to-br from-blue-50 to-purple-50 opacity-0 group-hover:opacity-100 rounded-3xl transition-opacity"></div>
                            <div id="toss-team1-logo-container" class="relative z-10 w-20 h-20 rounded-full shadow-lg mb-4 overflow-hidden bg-white flex items-center justify-center border-4 border-white"></div>
                            <span id="toss-team1-name" class="relative z-10 font-black text-gray-800 text-sm uppercase tracking-wide truncate w-full px-2">Home</span>
                            
                            <div class="absolute -top-3 -right-3 w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white shadow-lg opacity-0 check-icon transition-all duration-300 transform scale-50"><svg class="w-5 h-5 fill-current" viewBox="0 0 20 20"><path d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"/></svg></div>
                        </div>

                        <div id="toss-winner-team2" onclick="selectTossWinner('team2')" 
                             class="toss-card-btn group relative flex flex-col items-center justify-center p-5 bg-white border-2 border-transparent rounded-3xl shadow-[0_10px_30px_-10px_rgba(0,0,0,0.1)] cursor-pointer transition-all duration-300 hover:scale-[1.03] active:scale-95 h-48">
                            <div class="absolute inset-0 bg-gradient-to-br from-orange-50 to-red-50 opacity-0 group-hover:opacity-100 rounded-3xl transition-opacity"></div>
                            <div id="toss-team2-logo-container" class="relative z-10 w-20 h-20 rounded-full shadow-lg mb-4 overflow-hidden bg-white flex items-center justify-center border-4 border-white"></div>
                            <span id="toss-team2-name" class="relative z-10 font-black text-gray-800 text-sm uppercase tracking-wide truncate w-full px-2">Away</span>
                            
                            <div class="absolute -top-3 -right-3 w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white shadow-lg opacity-0 check-icon transition-all duration-300 transform scale-50"><svg class="w-5 h-5 fill-current" viewBox="0 0 20 20"><path d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"/></svg></div>
                        </div>
                    </div>

                    <p class="mb-4 text-gray-400 text-xs font-bold uppercase tracking-widest">Decision</p>
                    <div class="grid grid-cols-2 gap-4 mb-10">
                        <button id="toss-choice-bat" onclick="selectTossChoice('bat')" class="decision-btn relative overflow-hidden py-4 rounded-2xl border-2 border-gray-100 hover:border-orange-200 bg-white transition-all duration-300 group">
                            <div class="absolute inset-0 bg-gradient-to-r from-yellow-100 to-orange-100 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                            <span class="relative z-10 flex items-center justify-center gap-2 text-gray-500 group-hover:text-orange-600 font-black text-lg uppercase">
                                <span>üèè</span> Bat
                            </span>
                        </button>
                        <button id="toss-choice-bowl" onclick="selectTossChoice('bowl')" class="decision-btn relative overflow-hidden py-4 rounded-2xl border-2 border-gray-100 hover:border-blue-200 bg-white transition-all duration-300 group">
                            <div class="absolute inset-0 bg-gradient-to-r from-blue-100 to-cyan-100 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                            <span class="relative z-10 flex items-center justify-center gap-2 text-gray-500 group-hover:text-blue-600 font-black text-lg uppercase">
                                <span>‚öæ</span> Bowl
                            </span>
                        </button>
                    </div>

                    <div class="mb-8">
                         <button id="btn-broadcast-enable" onclick="generateBroadcastCode()" class="group relative w-full py-5 bg-white border-2 border-gray-100 text-gray-600 rounded-2xl shadow-sm hover:shadow-xl hover:border-green-400 transition-all duration-300 active:scale-95 flex flex-col items-center justify-center overflow-hidden">
                            <div class="absolute inset-0 bg-gradient-to-r from-emerald-50 to-teal-50 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                            <div class="relative z-10 flex items-center gap-3">
                                <span class="text-3xl filter grayscale group-hover:grayscale-0 transition-all">üì°</span>
                                <div class="text-left">
                                    <span class="block text-base font-black tracking-wide group-hover:text-green-700 uppercase">Enable Live Broadcast</span>
                                    <span class="block text-[10px] text-gray-400 font-bold group-hover:text-green-600 uppercase tracking-wider">Required to start</span>
                                </div>
                            </div>
                        </button>
                        
                        <div id="broadcast-display" class="hidden mt-6 animate-pop">
                            <div class="bg-gradient-to-br from-gray-900 to-black rounded-3xl p-6 shadow-2xl flex flex-col items-center border border-gray-800 ring-4 ring-gray-100">
                                <p class="text-[10px] text-emerald-400 font-bold uppercase mb-2 tracking-[0.3em]">Camera Code</p>
                                <div id="match-code-box" class="text-6xl font-mono font-black text-white tracking-widest cursor-pointer hover:text-emerald-300 transition-colors drop-shadow-[0_0_10px_rgba(52,211,153,0.5)]" onclick="copyBroadcastLink()">0000</div>
                                <p id="copy-feedback" class="text-xs text-gray-500 font-bold mt-3 hidden">Copied to clipboard!</p>
                            </div>
                        </div>
                    </div>

                    <button id="start-match-btn" disabled class="w-full py-6 bg-gray-200 text-gray-400 font-black rounded-3xl text-xl shadow-none transition-all duration-300 cursor-not-allowed uppercase tracking-widest mb-12" onclick="startMatch()">
                        Start Match
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="app" class="h-screen w-full flex flex-col hidden bg-gray-100">
        <div id="match-header" class="bg-white border-b border-gray-200 p-2 text-center shadow-sm z-10"></div>

        <div class="flex-grow flex flex-col lg:flex-row overflow-hidden">
            <div class="flex-grow flex flex-col p-2 lg:p-4 gap-2 overflow-y-auto">
                <div id="scoreboard" class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden">
                    <div id="team-scores-container" class="flex flex-col"></div>
                </div>

                <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden mb-6">
                    <table class="w-full text-left text-xs">
                        <thead class="bg-gray-50 border-b border-gray-200">
                            <tr class="text-xs font-bold text-gray-500 uppercase tracking-wider">
                                <th class="p-3 w-1/2">BATTING</th>
                                <th class="p-3 text-center w-10">R</th>
                                <th class="p-3 text-center w-10">B</th>
                                <th class="p-3 text-center w-10">4s</th>
                                <th class="p-3 text-center w-10">6s</th>
                                <th class="p-3 text-right">SR</th>
                            </tr>
                        </thead>
                        <tbody id="batting-table" class="divide-y divide-gray-50"></tbody>
                    </table>
                </div>
                
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                    <table class="w-full text-left text-xs">
                        <thead class="bg-gray-50 border-b border-gray-200">
                            <tr class="text-xs font-bold text-gray-500 uppercase tracking-wider">
                                <th class="p-3 w-1/2">BOWLING</th>
                                <th class="p-3 text-center w-10">O</th>
                                <th class="p-3 text-center w-10">M</th>
                                <th class="p-3 text-center w-10">R</th>
                                <th class="p-3 text-center w-10">W</th>
                                <th class="p-3 text-right">ECO</th>
                            </tr>
                        </thead>
                        <tbody id="bowling-table" class="divide-y divide-gray-50"></tbody>
                    </table>
                </div>
            </div>

            <div class="flex-shrink-0 lg:w-96 bg-white border-t lg:border-l border-gray-200 flex flex-col z-20">

                <div class="scoring-grid h-64 lg:h-auto lg:flex-grow">
                    <button onclick="addRuns(0)" class="watery-btn btn-grey font-bold text-xl">0</button>
                    <button onclick="addRuns(1)" class="watery-btn btn-grey font-bold text-xl">1</button>
                    <button onclick="addRuns(2)" class="watery-btn btn-grey font-bold text-xl">2</button>
                    <button onclick="addRuns(3)" class="watery-btn btn-grey font-bold text-xl">3</button>

                    <button onclick="undoLastAction()" id="undo-btn" class="watery-btn btn-yellow font-bold text-sm">UNDO</button>
                    <button onclick="addRuns(4)" class="watery-btn btn-sky font-bold text-2xl">4</button>
                    <button onclick="addRuns(6)" class="watery-btn btn-green font-bold text-2xl">6</button>
                    <button onclick="addRuns(5)" class="watery-btn btn-grey font-bold text-xl">5</button>

                    <button id="btn-wicket" onclick="openWicketModal()" class="watery-btn btn-red font-bold text-lg col-span-1">WKT</button>
                    <button onclick="openModal('wide-modal')" class="watery-btn btn-dark-grey font-bold text-sm">WD</button>
                    <button onclick="openModal('noball-modal')" class="watery-btn btn-dark-grey font-bold text-sm">NB</button>
                    <button onclick="openModal('mid-over-modal')" class="watery-btn btn-purple font-bold text-[10px] leading-tight flex flex-col items-center justify-center">
                        <span>PEN /</span>
                        <span>EVENTS</span>
                    </button>
                </div>

                <div class="p-2 bg-gray-50 flex justify-between items-center border-t px-4">
                    <button onclick="confirmExit()" class="text-xs font-bold uppercase tracking-wider text-red-600">Exit Match</button>
                    <button onclick="openEditMatchMode()" class="text-xs font-bold uppercase tracking-wider text-blue-600 border border-blue-200 px-3 py-1 rounded-lg hover:bg-blue-50">‚úé Edit Match</button>
                    <button onclick="openViewControlModal()" class="text-xs font-bold uppercase tracking-wider text-white bg-indigo-600 px-4 py-2 rounded-full border border-indigo-700 shadow-lg hover:bg-indigo-700">üì∫ BROADCAST</button>
                </div>
            </div>
        </div>
    </div>

    <div id="player-modal" class="modal-overlay fixed inset-0 bg-slate-900/90 backdrop-blur-md hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl w-full max-w-md shadow-2xl flex flex-col max-h-[80vh]">
            <div class="p-5 border-b border-gray-100 flex justify-between items-center">
                <div>
                    <h3 id="modal-title" class="text-xl font-black text-gray-800 uppercase tracking-tight">Select Player</h3>
                    <p class="text-xs text-gray-400 font-bold uppercase tracking-wider">Tap player to select</p>
                </div>
                </div>

            <div id="player-selection-grid" class="grid grid-cols-3 gap-3 p-4 overflow-y-auto custom-scroll">
            </div>
            
            <input type="hidden" id="player-select" value="">
            <button id="player-save-btn" class="hidden"></button>
        </div>
    </div>

    <div id="opening-pair-modal" class="modal-overlay fixed inset-0 bg-slate-900/95 backdrop-blur-xl hidden z-50 flex items-center justify-center p-2">
        <div class="bg-white rounded-3xl w-full max-w-5xl shadow-2xl flex flex-col h-[90vh] overflow-hidden">
            <div class="p-6 border-b border-gray-100 bg-gray-50 flex justify-between items-center flex-shrink-0">
                <div>
                    <h3 class="text-2xl font-black text-blue-900 uppercase tracking-tight">Select Opening Pair</h3>
                    <p class="text-xs text-gray-400 font-bold uppercase tracking-wider">Choose Striker first, then Non-Striker</p>
                </div>
            </div>

            <div class="flex-grow grid grid-cols-1 md:grid-cols-2 divide-y md:divide-y-0 md:divide-x divide-gray-100 overflow-y-auto md:overflow-hidden">
                
                <div class="flex flex-col h-auto md:h-full bg-blue-50/30">
                    <div class="p-3 bg-blue-100/50 text-blue-800 font-black text-center text-sm uppercase tracking-widest border-b border-blue-100 sticky top-0 z-10">
                        1. Choose Striker üèè
                    </div>
                    <div id="op-striker-grid" class="grid grid-cols-3 md:grid-cols-4 gap-3 p-4 overflow-y-visible md:overflow-y-auto custom-scroll content-start"></div>
                </div>

                <div class="flex flex-col h-auto md:h-full bg-orange-50/30">
                    <div id="op-ns-header" class="p-3 bg-orange-100/50 text-orange-800 font-black text-center text-sm uppercase tracking-widest border-b border-orange-100 sticky top-0 z-10">
                        2. Choose Non-Striker üèÉ
                    </div>
                    <div id="op-nonstriker-grid" class="grid grid-cols-3 md:grid-cols-4 gap-3 p-4 overflow-y-visible md:overflow-y-auto custom-scroll content-start transition-opacity duration-300"></div>
                </div>
            </div>
            
            <div class="p-4 border-t border-gray-100 bg-gray-50 flex justify-center flex-shrink-0">
                <button id="op-confirm-btn" onclick="confirmOpeningPair()" class="w-full md:w-1/2 py-4 bg-gray-300 text-gray-500 font-black rounded-xl text-xl shadow-none transition-all uppercase tracking-widest cursor-not-allowed" disabled>
                    Confirm Pair
                </button>
            </div>
        </div>
    </div>

    <div id="bowler-edit-modal" class="modal-overlay fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-2xl p-6 w-96 shadow-2xl relative max-h-[80vh] overflow-y-auto">
            <button onclick="closeModal('bowler-edit-modal')" class="absolute top-3 right-4 text-gray-400 hover:text-gray-600 font-bold text-xl">‚úï</button>
            <h3 class="text-lg font-bold mb-4 text-center text-blue-900">Edit Bowler & Over</h3>
            
            <div class="mb-6">
                <label class="block text-xs font-bold text-gray-500 mb-1 uppercase tracking-wider">Current Bowler</label>
                <select id="edit-bowler-select" class="w-full p-3 border border-gray-300 rounded-xl font-bold text-lg bg-gray-50 outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all" onchange="changeCurrentBowler(this.value)">
                    </select>
            </div>

            <div class="mb-4">
                <label class="block text-xs font-bold text-gray-500 mb-3 uppercase tracking-wider">Tap ball to edit</label>
                <div id="edit-over-list" class="space-y-2">
                    </div>
            </div>

            <button onclick="closeModal('bowler-edit-modal')" class="w-full py-4 bg-blue-600 hover:bg-blue-700 text-white font-black rounded-xl shadow-lg active:scale-95 transition-transform uppercase tracking-widest">Done</button>
        </div>
    </div>

    <div id="wicket-type-modal" class="modal-overlay fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-50 flex items-center justify-center">
    <div class="modal-content bg-white rounded-2xl p-6 w-80 shadow-2xl text-center max-h-[90vh] overflow-y-auto">
        <h3 id="wicket-modal-title" class="text-xl font-black text-red-600 mb-4 uppercase tracking-wider">Wicket Type</h3>
        
        <div class="grid grid-cols-2 gap-3 text-sm">
            <button onclick="handleWicketAction('Bowled')" class="p-4 bg-red-50 hover:bg-red-100 text-red-900 font-bold rounded-xl border border-red-200">BOWLED</button>
            <button onclick="setupFielderSelect('Catch')" class="p-4 bg-blue-50 hover:bg-blue-100 text-blue-900 font-bold rounded-xl border border-blue-200">CATCH</button>
            
            <button onclick="handleWicketAction('LBW')" class="p-3 bg-gray-50 hover:bg-gray-100 font-bold rounded-xl border border-gray-200">LBW</button>
            <button onclick="handleWicketAction('Run Out')" class="p-3 bg-orange-50 hover:bg-orange-100 text-orange-900 font-bold rounded-xl border border-orange-200">RUN OUT</button>
            
            <button onclick="setupFielderSelect('Stumped')" class="p-3 bg-purple-50 hover:bg-purple-100 text-purple-900 font-bold rounded-xl border border-purple-200">STUMPED</button>
            <button onclick="handleWicketAction('Hit Wicket')" class="p-3 bg-gray-50 hover:bg-gray-100 font-bold rounded-xl border border-gray-200">HIT WKT</button>
            
            <button onclick="handleWicketAction('Retired Out')" class="p-3 bg-gray-50 hover:bg-gray-100 font-bold rounded-xl border border-gray-200">Retired</button>
            <button onclick="handleWicketAction('Other')" class="p-3 bg-gray-50 hover:bg-gray-100 font-bold rounded-xl border border-gray-200">Other</button>
        </div>
        
        <button onclick="closeModal('wicket-type-modal')" class="mt-5 text-gray-400 text-xs font-bold uppercase tracking-widest hover:text-gray-600">Cancel</button>
    </div>
</div>

<div id="fielder-modal" class="modal-overlay fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-[60] flex items-center justify-center">
    <div class="modal-content bg-white rounded-2xl p-6 w-80 shadow-2xl relative">
        <button onclick="closeModal('fielder-modal')" class="absolute top-3 right-4 text-gray-400 hover:text-gray-600 font-bold text-xl">‚úï</button>
        
        <h3 id="fielder-modal-title" class="text-lg font-bold mb-4 text-center text-blue-900">Select Fielder</h3>
        <select id="fielder-select" class="w-full p-3 bg-gray-50 border rounded-xl mb-4 text-lg outline-none focus:ring-2 focus:ring-blue-500"></select>
        
        <button onclick="confirmFielder()" class="w-full py-3 bg-blue-600 text-white font-bold rounded-xl shadow-lg active:scale-95 transition-transform">Confirm</button>
    </div>
</div>

    <div id="runout-modal" class="modal-overlay fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-50 flex items-center justify-center">
        <div class="modal-content bg-white rounded-2xl p-6 w-80 shadow-2xl text-center">
            <h3 class="text-xl font-bold text-red-600 mb-4">Who is Out?</h3>
            <div class="grid grid-cols-1 gap-3">
                <button id="btn-ro-striker" onclick="finalizeRunOut('striker')" class="p-4 bg-gray-100 font-bold rounded-xl text-md hover:bg-red-50 border border-gray-200 text-gray-800">Striker</button>
                <button id="btn-ro-nonstriker" onclick="finalizeRunOut('nonstriker')" class="p-4 bg-gray-100 font-bold rounded-xl text-md hover:bg-red-50 border border-gray-200 text-gray-800">Non-Striker</button>
            </div>
            <button onclick="closeModal('runout-modal')" class="mt-4 text-gray-400 text-sm">Cancel</button>
        </div>
    </div>

    <div id="broadcast-control-modal" class="modal-overlay fixed inset-0 bg-black/80 backdrop-blur-sm hidden z-[100] flex items-center justify-center">
        <div class="bg-white rounded-3xl p-6 w-80 shadow-2xl text-center border border-gray-200">
            <h3 class="text-lg font-bold text-gray-900 mb-2 uppercase tracking-wide">Broadcast Views</h3>
            <p class="text-[10px] text-gray-400 mb-6 font-semibold uppercase tracking-wider">Toggle to Show on Stream</p>
            
            <div class="space-y-4 bg-gray-50 p-4 rounded-2xl">
                <div class="flex items-center justify-between">
                    <span class="text-sm font-bold text-gray-700">Playing Squad</span>
                    <input type="checkbox" class="ios-toggle" id="toggle-squad" onchange="toggleView('SQUAD', this)">
                </div>
                
                <div class="flex items-center justify-between border-t border-gray-200 pt-4">
    <span class="text-sm font-bold text-gray-700">Batting Card</span>
    <input type="checkbox" class="ios-toggle" id="toggle-batting" onchange="toggleView('BATTING', this)">
</div>

<div class="flex items-center justify-between border-t border-gray-200 pt-4">
    <span class="text-sm font-bold text-gray-700">Bowling Card</span>
    <input type="checkbox" class="ios-toggle" id="toggle-bowling" onchange="toggleView('BOWLING', this)">
</div>

<div class="flex items-center justify-between border-t border-gray-200 pt-4">
    <span class="text-sm font-bold text-gray-700">Run Rate (CRR/RRR)</span>
    <input type="checkbox" class="ios-toggle" id="toggle-runrate" onchange="toggleView('RUN_RATE', this)">
</div>
            </div>
            
            <button onclick="closeModal('broadcast-control-modal')" class="mt-6 w-full py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold rounded-xl text-sm transition-colors">Close Menu</button>
        </div>
    </div>

    <div id="wide-modal" class="modal-overlay fixed inset-0 bg-black/50 hidden z-50 flex items-end justify-center" onclick="closeModal('wide-modal')">
        <div class="bg-white w-full max-w-md p-6 rounded-t-2xl shadow-xl mb-0" onclick="event.stopPropagation()">
            <h3 class="font-bold text-center mb-4">Wide Ball</h3>
            <div class="grid grid-cols-3 gap-3" id="wide-options"></div>
        </div>
    </div>

    <div id="noball-modal" class="modal-overlay fixed inset-0 bg-black/50 hidden z-50 flex items-end justify-center" onclick="closeModal('noball-modal')">
        <div class="bg-white w-full max-w-md p-6 rounded-t-2xl shadow-xl mb-0" onclick="event.stopPropagation()">
            <h3 class="font-bold text-center mb-4">No Ball</h3>
            <div class="grid grid-cols-3 gap-3" id="noball-options"></div>
        </div>
    </div>
    
    <div id="mid-over-modal" class="modal-overlay fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-50 flex items-end justify-center" onclick="closeModal('mid-over-modal')">
        <div class="bg-white w-full max-w-md rounded-t-3xl shadow-2xl overflow-hidden max-h-[85vh] flex flex-col" onclick="event.stopPropagation()">
            
            <div class="bg-gray-50 p-4 border-b border-gray-100 flex justify-between items-center sticky top-0 z-10">
                <h3 class="font-black text-gray-800 uppercase tracking-tight text-lg">Match Events</h3>
                <button onclick="closeModal('mid-over-modal')" class="w-8 h-8 rounded-full bg-gray-200 text-gray-500 font-bold">‚úï</button>
            </div>

            <div class="p-6 overflow-y-auto custom-scroll">
                
                <div class="mb-6 p-4 bg-red-50 rounded-2xl border border-red-100">
                    <div class="flex items-center gap-2 mb-3">
                        <span class="text-xl">‚ö†Ô∏è</span>
                        <h4 class="text-sm font-black text-red-700 uppercase tracking-wide">Change Bowler Mid-Over</h4>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="triggerMidOverChange('INJURY')" class="p-3 bg-white text-red-700 font-bold text-xs rounded-xl border border-red-200 hover:bg-red-500 hover:text-white transition-colors shadow-sm text-left">
                            ü©π Bowler Injured
                        </button>
                        <button onclick="triggerMidOverChange('PENALTY')" class="p-3 bg-white text-orange-700 font-bold text-xs rounded-xl border border-orange-200 hover:bg-orange-500 hover:text-white transition-colors shadow-sm text-left">
                            üö´ Umpire Penalty
                        </button>
                        <button onclick="triggerMidOverChange('DISQUALIFIED')" class="p-3 bg-white text-gray-700 font-bold text-xs rounded-xl border border-gray-300 hover:bg-gray-700 hover:text-white transition-colors shadow-sm text-left">
                            ‚ùå Disqualified
                        </button>
                        <button onclick="triggerMidOverChange('MANUAL')" class="p-3 bg-white text-blue-700 font-bold text-xs rounded-xl border border-blue-200 hover:bg-blue-600 hover:text-white transition-colors shadow-sm text-left">
                            üîÅ Manual Change
                        </button>
                    </div>
                </div>

                <div class="mb-4">
                    <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-2 ml-1">Extras & Penalties</p>
                    
                    <div class="mb-4">
                        <p class="text-xs font-bold text-green-600 uppercase mb-2">Add Runs (+)</p>
                        <div class="grid grid-cols-6 gap-2 mb-2">
                            <button onclick="handleAddExtra('ext', 1)" class="p-3 bg-green-50 text-green-800 font-bold rounded-lg text-sm border border-green-200 hover:bg-green-100">+1</button>
                            <button onclick="handleAddExtra('ext', 2)" class="p-3 bg-green-50 text-green-800 font-bold rounded-lg text-sm border border-green-200 hover:bg-green-100">+2</button>
                            <button onclick="handleAddExtra('ext', 3)" class="p-3 bg-green-50 text-green-800 font-bold rounded-lg text-sm border border-green-200 hover:bg-green-100">+3</button>
                            <button onclick="handleAddExtra('ext', 4)" class="p-3 bg-green-50 text-green-800 font-bold rounded-lg text-sm border border-green-200 hover:bg-green-100">+4</button>
                            <button onclick="handleAddExtra('ext', 5)" class="p-3 bg-green-50 text-green-800 font-bold rounded-lg text-sm border border-green-200 hover:bg-green-100">+5</button>
                            <button onclick="handleAddExtra('ext', 6)" class="p-3 bg-green-50 text-green-800 font-bold rounded-lg text-sm border border-green-200 hover:bg-green-100">+6</button>
                        </div>
                        <button onclick="setupExtraRunOut('ext')" class="w-full py-3 bg-orange-50 text-orange-800 font-bold rounded-lg border border-orange-200 hover:bg-orange-100 uppercase tracking-wide text-xs">
                            Leg Byes / Extra Run Out
                        </button>
                    </div>

                    <div>
                        <p class="text-xs font-bold text-red-600 uppercase mb-2">Penalty Runs (-)</p>
                        <div class="grid grid-cols-6 gap-2">
                            <button onclick="handleAddExtra('pen', -1)" class="p-3 bg-red-50 text-red-800 font-bold rounded-lg text-sm border border-red-200 hover:bg-red-100">-1</button>
                            <button onclick="handleAddExtra('pen', -2)" class="p-3 bg-red-50 text-red-800 font-bold rounded-lg text-sm border border-red-200 hover:bg-red-100">-2</button>
                            <button onclick="handleAddExtra('pen', -3)" class="p-3 bg-red-50 text-red-800 font-bold rounded-lg text-sm border border-red-200 hover:bg-red-100">-3</button>
                            <button onclick="handleAddExtra('pen', -4)" class="p-3 bg-red-50 text-red-800 font-bold rounded-lg text-sm border border-red-200 hover:bg-red-100">-4</button>
                            <button onclick="handleAddExtra('pen', -5)" class="p-3 bg-red-50 text-red-800 font-bold rounded-lg text-sm border border-red-200 hover:bg-red-100">-5</button>
                            <button onclick="handleAddExtra('pen', -6)" class="p-3 bg-red-50 text-red-800 font-bold rounded-lg text-sm border border-red-200 hover:bg-red-100">-6</button>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div id="extra-runs-modal" class="modal-overlay fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-50 flex items-center justify-center">
        <div class="modal-content bg-white rounded-2xl p-6 w-80 shadow-2xl text-center relative">
            <button onclick="closeModal('extra-runs-modal')" class="absolute top-3 right-4 text-gray-400 hover:text-gray-600 font-bold text-xl">‚úï</button>
            <h3 class="text-xl font-bold text-blue-900 mb-2">Runs Completed?</h3>
            <p class="text-xs text-gray-500 mb-4 uppercase tracking-wide">Before the Run Out occurred</p>
            
            <div class="grid grid-cols-3 gap-3 mb-4">
                <button onclick="selectExtraRuns(0)" class="aspect-square bg-gray-100 hover:bg-blue-50 hover:border-blue-200 border-2 border-transparent text-gray-800 font-black text-2xl rounded-xl transition-all">0</button>
                <button onclick="selectExtraRuns(1)" class="aspect-square bg-gray-100 hover:bg-blue-50 hover:border-blue-200 border-2 border-transparent text-gray-800 font-black text-2xl rounded-xl transition-all">1</button>
                <button onclick="selectExtraRuns(2)" class="aspect-square bg-gray-100 hover:bg-blue-50 hover:border-blue-200 border-2 border-transparent text-gray-800 font-black text-2xl rounded-xl transition-all">2</button>
                <button onclick="selectExtraRuns(3)" class="aspect-square bg-gray-100 hover:bg-blue-50 hover:border-blue-200 border-2 border-transparent text-gray-800 font-black text-2xl rounded-xl transition-all">3</button>
                <button onclick="selectExtraRuns(4)" class="aspect-square bg-gray-100 hover:bg-blue-50 hover:border-blue-200 border-2 border-transparent text-gray-800 font-black text-2xl rounded-xl transition-all">4</button>
                <button onclick="selectExtraRuns(5)" class="aspect-square bg-gray-100 hover:bg-blue-50 hover:border-blue-200 border-2 border-transparent text-gray-800 font-black text-2xl rounded-xl transition-all">5</button>
            </div>
            <button onclick="closeModal('extra-runs-modal')" class="text-xs font-bold text-gray-400 uppercase tracking-widest hover:text-gray-600">Cancel</button>
        </div>
    </div>

    <div id="pair-change-modal" class="modal-overlay fixed inset-0 bg-black/70 hidden z-50 flex items-center justify-center">
        <div class="modal-content bg-white rounded-xl p-6 w-80 text-center">
            <h3 class="text-xl font-bold text-blue-800 mb-2">Skin Complete!</h3>
            <p class="text-sm text-gray-600 mb-4">Time to swap the batting pair.</p>
            <button onclick="performPairSwap()" class="w-full py-3 bg-blue-600 text-white font-bold rounded-lg shadow-lg">Select New Pair</button>
        </div>
    </div>

    <div id="innings-break-modal" class="modal-overlay fixed inset-0 bg-[#020617]/95 backdrop-blur-2xl hidden z-[100] overflow-y-auto">
        <div class="flex flex-col items-center justify-center min-h-screen py-8 px-4 text-white transition-opacity duration-500">
        
            <div class="text-center mb-6">
                <h2 class="text-[10px] font-bold tracking-[0.5em] text-blue-300 uppercase animate-pulse mb-2">Innings Break</h2>
                <div class="h-0.5 w-12 bg-gradient-to-r from-transparent via-blue-500 to-transparent mx-auto"></div>
            </div>

            <div class="relative w-full max-w-4xl bg-[#0f172a] rounded-[2rem] shadow-2xl border border-white/10 overflow-hidden flex flex-col md:flex-row">
                
                <div class="relative w-full md:w-5/12 bg-gradient-to-br from-[#1e3a8a] to-[#172554] p-8 flex flex-col items-center justify-center text-center relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-full bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10"></div>
                    <div class="absolute -top-20 -left-20 w-60 h-60 bg-blue-500/30 rounded-full blur-[60px]"></div>

                    <div class="relative z-10">
                        <img id="ib-team-logo" class="w-20 h-20 rounded-full object-cover border-4 border-white/20 shadow-xl bg-white mx-auto mb-4" src="" alt="">
                        <h1 id="ib-batting-team" class="text-3xl font-black uppercase text-white tracking-tight leading-none mb-2">TEAM NAME</h1>
                        <div class="text-blue-200/60 text-[10px] font-bold uppercase tracking-widest mb-6">First Innings Total</div>

                        <div class="flex items-end justify-center gap-1 mb-2">
                            <span id="ib-score" class="text-7xl font-black text-white leading-none drop-shadow-lg">0</span>
                            <span class="text-4xl font-bold text-blue-400 mb-2">/</span>
                            <span id="ib-wickets" class="text-6xl font-black text-white mb-1 leading-none">0</span>
                        </div>
                        <div class="inline-block bg-black/20 px-4 py-1 rounded-lg border border-white/10 text-xs font-mono text-blue-200 mb-8">
                            <span id="ib-overs">0.0</span> Overs
                        </div>

                        <div class="bg-white/10 backdrop-blur-md rounded-2xl p-4 border border-white/10 w-full animate-pop">
                            <span class="block text-[10px] font-bold text-yellow-400 uppercase tracking-[0.2em] mb-1">Target to Win</span>
                            <span id="ib-target" class="text-5xl font-black text-white">0</span>
                            <span class="block text-[10px] text-white/50 mt-1 uppercase">Required Run Rate: <span id="ib-rrr" class="text-white font-bold">0.00</span></span>
                        </div>
                    </div>
                </div>

                <div class="w-full md:w-7/12 bg-[#0f172a] p-6 md:p-8 flex flex-col">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-sm font-bold text-white uppercase tracking-wider flex items-center gap-2">
                            <span class="w-1.5 h-1.5 rounded-full bg-green-400"></span> Match Summary
                        </h3>
                        <div class="text-[10px] font-bold text-gray-500 uppercase">CRR: <span id="ib-crr" class="text-white">0.00</span></div>
                    </div>

                    <div class="mb-6">
                        <div class="flex justify-between items-end border-b border-white/10 pb-2 mb-3">
                            <span class="text-xs font-bold text-blue-400 uppercase tracking-wide">Top Batters</span>
                            <span class="text-[9px] text-gray-500 uppercase">R (B)</span>
                        </div>
                        <div id="ib-batting-list" class="space-y-3">
                            </div>
                    </div>

                    <div class="mb-4">
                        <div class="flex justify-between items-end border-b border-white/10 pb-2 mb-3">
                            <span class="text-xs font-bold text-orange-400 uppercase tracking-wide">Top Bowlers</span>
                            <span class="text-[9px] text-gray-500 uppercase">W - R (O)</span>
                        </div>
                        <div id="ib-bowling-list" class="space-y-3">
                            </div>
                    </div>
                </div>
            </div>

            <button onclick="startSecondInnings()" class="mt-8 px-12 py-4 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white font-black rounded-xl shadow-[0_0_30px_rgba(37,99,235,0.4)] transition-all transform hover:scale-105 active:scale-95 flex items-center gap-3 uppercase tracking-wider text-sm border border-white/10">
                <span>Start 2nd Innings</span>
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
            </button>
        </div>
    </div>

    <div id="match-summary-modal" class="fixed inset-0 z-[100] hidden bg-gradient-to-br from-indigo-900 via-purple-900 to-blue-900 overflow-y-auto">
    <div class="absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none">
        <div class="absolute top-[-10%] left-[-10%] w-96 h-96 bg-purple-500 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob"></div>
        <div class="absolute top-[-10%] right-[-10%] w-96 h-96 bg-yellow-500 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob animation-delay-2000"></div>
        <div class="absolute bottom-[-20%] left-[20%] w-96 h-96 bg-pink-500 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob animation-delay-4000"></div>
    </div>

    <div class="relative z-10 min-h-screen flex flex-col items-center justify-center p-4 md:p-8">
        
        <div class="text-center mb-8 animate-pop">
            <h2 class="text-xs font-bold text-yellow-300 tracking-[0.3em] uppercase mb-2">Match Result</h2>
            <h1 id="summary-winner-text" class="text-5xl md:text-7xl font-black text-transparent bg-clip-text bg-gradient-to-r from-yellow-200 via-yellow-400 to-yellow-200 drop-shadow-sm uppercase leading-tight">
                WINNER
            </h1>
            <div id="summary-margin-text" class="inline-block mt-2 px-4 py-1 bg-white/10 backdrop-blur-md rounded-full border border-white/20 text-white font-bold tracking-wider text-sm">
                WON BY ...
            </div>
        </div>

        <div class="w-full max-w-4xl grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
            <div id="card-t1" class="bg-white/10 backdrop-blur-lg border border-white/20 rounded-2xl p-6 flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div id="sum-t1-logo" class="w-16 h-16 rounded-full bg-white/20 shadow-lg flex items-center justify-center text-xl font-black text-white overflow-hidden"></div>
                    <div>
                        <h3 id="sum-t1-name" class="text-white/70 font-bold uppercase text-xs tracking-widest">TEAM 1</h3>
                        <div id="sum-t1-score" class="text-3xl font-black text-white">0/0</div>
                    </div>
                </div>
                <div id="sum-t1-overs" class="text-right text-white/50 font-mono font-bold">0.0</div>
            </div>

            <div id="card-t2" class="bg-white/10 backdrop-blur-lg border border-white/20 rounded-2xl p-6 flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div id="sum-t2-logo" class="w-16 h-16 rounded-full bg-white/20 shadow-lg flex items-center justify-center text-xl font-black text-white overflow-hidden"></div>
                    <div>
                        <h3 id="sum-t2-name" class="text-white/70 font-bold uppercase text-xs tracking-widest">TEAM 2</h3>
                        <div id="sum-t2-score" class="text-3xl font-black text-white">0/0</div>
                    </div>
                </div>
                <div id="sum-t2-overs" class="text-right text-white/50 font-mono font-bold">0.0</div>
            </div>
        </div>

        <div class="w-full max-w-4xl grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            
            <div class="bg-black/20 backdrop-blur-md rounded-2xl p-5 border border-white/10">
                <h4 class="text-yellow-400 font-black uppercase text-xs tracking-widest mb-4 flex items-center gap-2">
                    <span>üèè</span> Top Batters
                </h4>
                <div id="sum-top-batters" class="space-y-3"></div>
            </div>

            <div class="bg-black/20 backdrop-blur-md rounded-2xl p-5 border border-white/10">
                <h4 class="text-blue-400 font-black uppercase text-xs tracking-widest mb-4 flex items-center gap-2">
                    <span>‚öæ</span> Top Bowlers
                </h4>
                <div id="sum-top-bowlers" class="space-y-3"></div>
            </div>

            <div class="bg-gradient-to-b from-yellow-500/20 to-orange-500/20 backdrop-blur-md rounded-2xl p-5 border border-yellow-500/30">
                <h4 class="text-white font-black uppercase text-xs tracking-widest mb-4 flex items-center gap-2">
                    <span>üèÜ</span> Man of the Match
                </h4>
                <div id="sum-pom-list" class="space-y-2 max-h-48 overflow-y-auto custom-scroll"></div>
            </div>
        </div>

        <div class="flex flex-col md:flex-row gap-4 w-full max-w-xl">
            <button onclick="broadcastMatchResult()" class="flex-1 py-4 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-400 hover:to-emerald-500 text-white font-black uppercase tracking-wider rounded-xl shadow-lg shadow-green-900/50 transition-all active:scale-95 flex items-center justify-center gap-2">
                <span>üì° Broadcast Result</span>
            </button>
        </div>
        
        <div id="summary-action-buttons" class="w-full max-w-xl mt-4">
            </div>

    </div>
</div>
<div id="custom-dialog-modal" class="modal-overlay fixed inset-0 bg-black/70 backdrop-blur-sm hidden z-[200] flex items-center justify-center p-4" style="transition: opacity 0.3s ease-out;">
        <div class="bg-white rounded-3xl w-full max-w-sm shadow-2xl overflow-hidden transform transition-all scale-100 animate-pop border border-gray-100">
            
            <div id="dialog-header-strip" class="h-2 w-full bg-blue-600"></div>

            <div class="p-6 text-center">
                <div id="dialog-icon-container" class="mx-auto w-16 h-16 bg-blue-50 rounded-full flex items-center justify-center mb-4 shadow-sm">
                    <span id="dialog-icon" class="text-3xl">‚ú®</span>
                </div>

                <h3 id="dialog-title" class="text-xl font-black text-gray-900 uppercase tracking-tight mb-2">
                    Notification
                </h3>
                
                <div id="dialog-message" class="text-sm text-gray-500 font-medium leading-relaxed mb-8 px-2">
                    Message goes here...
                </div>

                <div id="dialog-buttons" class="grid grid-cols-1 gap-3">
                    </div>
            </div>
        </div>
    </div>
    
    <script>
        // --- ADD THIS FUNCTION TO YOUR CONTROLLER SCRIPT (51 - .html) ---

function broadcastMatchResult() {
            if (!broadcastId) {
                showCustomAlert("Broadcast Error", "Broadcast is not active!<br>Please generate a code in Setup first.", "red");
                return;
            }

            const t1 = state.team1;
            const t2 = state.team2;
            let resultMain = "MATCH TIED";
            let resultSub = "Scores Level";

            // 1. Calculate Winner Text
            if (t1.score > t2.score) {
                resultMain = `${t1.name} WINS`;
                resultSub = `WON BY ${t1.score - t2.score} RUNS`;
            } else if (t2.score > t1.score) {
                resultMain = `${t2.name} WINS`;
                const wicketsLeft = (state.playersPerSide - 1) - (t2.wickets || 0); 
                resultSub = `WON BY ${Math.max(1, wicketsLeft)} WICKETS`;
            }

            // 2. Get Man of the Match from Radio Button
            const pomId = document.querySelector('input[name="pom"]:checked')?.value;
            let pomData = null;
            if (pomId) {
                let p = state.team1.playerStats[pomId] || state.team2.playerStats[pomId];
                if (p) {
                    pomData = { 
                        name: p.name, 
                        stats: `${p.runs} Runs ‚Ä¢ ${p.wickets} Wickets` 
                    };
                }
            }

            // 3. Prepare Top Stats Lists
            const allPlayers = [];
            ['team1', 'team2'].forEach(tk => {
                Object.values(state[tk].playerStats).forEach(p => {
                    p.teamName = state[tk].name;
                    allPlayers.push(p);
                });
            });

            const topBatters = [...allPlayers].sort((a,b) => b.runs - a.runs).slice(0, 3).map(p => ({
                name: p.name, team: p.teamName, runs: p.runs, balls: p.balls
            }));

            const topBowlers = [...allPlayers].sort((a,b) => (b.wickets - a.wickets) || (a.runsConceded - b.runsConceded)).slice(0, 3).map(p => ({
                name: p.name, team: p.teamName, wickets: p.wickets, runs: p.runsConceded, balls: p.ballsBowled
            }));

            // 4. Send to Firebase
            db.collection("live_matches").doc(broadcastId).set({
                matchStatus: "COMPLETE",
                showSquad: false,
                showBattingCard: false,
                showBowlingCard: false,
                showRunRate: false,
                resultMain: resultMain,
                resultSub: resultSub,
                resultT1: { 
                    name: t1.name, 
                    score: `${t1.score}/${t1.wickets}`, 
                    overs: `${t1.overs}.${t1.balls}` 
                },
                resultT2: { 
                    name: t2.name, 
                    score: `${t2.score}/${t2.wickets}`, 
                    overs: `${t2.overs}.${t2.balls}` 
                },
                pom: pomData,
                topBatters: topBatters,
                topBowlers: topBowlers
            }, { merge: true }).then(() => {
                showCustomAlert("Success", "Match Result has been broadcasted to the big screen!", "green");
            }).catch(err => console.error("Broadcast Error", err));
        }
        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyBqcD59IAPpKqk98oDZkgzgkoVZ8b8LGgY",
            authDomain: "livecricketscoring-92087.firebaseapp.com",
            databaseURL: "https://livecricketscoring-92087-default-rtdb.firebaseio.com",
            projectId: "livecricketscoring-92087",
            storageBucket: "livecricketscoring-92087.firebasestorage.app",
            messagingSenderId: "522927197627",
            appId: "1:522927197627:web:f1df5db736cae96893089e"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- DOM Elements ---
        const ui = {
            venueInput: document.getElementById('venue'),
            matchDateInput: document.getElementById('match-date-input'),
            totalOversInput: document.getElementById('total-overs'),
            playersPerSideInput: document.getElementById('players-per-side'),
            team1NameInput: document.getElementById('team1-name-input'),
            team2NameInput: document.getElementById('team2-name-input'),
            team1LogoInput: document.getElementById('team1-logo-input'),
            team2LogoInput: document.getElementById('team2-logo-input'),
            team1RosterTitle: document.getElementById('team1-roster-title'),
            team2RosterTitle: document.getElementById('team2-roster-title'),
            progressBar: document.getElementById('progress-bar'),
            tossTeam1Name: document.getElementById('toss-team1-name'),
            tossTeam2Name: document.getElementById('toss-team2-name'),
            tossTeam1LogoContainer: document.getElementById('toss-team1-logo-container'),
            tossTeam2LogoContainer: document.getElementById('toss-team2-logo-container'),
            tossWinnerTeam1: document.getElementById('toss-winner-team1'),
            tossWinnerTeam2: document.getElementById('toss-winner-team2'),
            tossChoiceBat: document.getElementById('toss-choice-bat'),
            tossChoiceBowl: document.getElementById('toss-choice-bowl'),
            startMatchBtn: document.getElementById('start-match-btn')
        };

        // --- STATE & HISTORY ---
        let state = {
    rules: { wicketRuns: 5, wideRuns: 2, noBallRuns: 2, skins: false },
    team1: { name: "", logo: "", squad: [], playing: [], playerStats: {}, isLoaded: false },
    team2: { name: "", logo: "", squad: [], playing: [], playerStats: {}, isLoaded: false },
    battingTeam: 'team1', bowlingTeam: 'team2',
    striker: null, nonStriker: null, bowler: null,
    id: null, innings: 1, target: 0, totalOvers: 16, playersPerSide: 8, ballsPerOver: 6, // Added configurable ballsPerOver
    currentOver: [], history: [], timeline: [] 
};
        
        let undoStack = []; 
        let editingBallIndex = null; // --- EDIT MODE CONTEXT ---

        let tossWinner = null, tossDecision = null;
        let broadcastId = null;
        let savedTeamsData = [];
        let isEditMatchMode = false;

        // --- INITIALIZATION ---
        window.onload = function() {
            const today = new Date();
            ui.matchDateInput.value = today.toISOString().split('T')[0];
            
            // 1. Single Match Dropdowns
            const oversSelect = document.getElementById('total-overs');
            const defOvers = document.createElement('option'); defOvers.value = ""; defOvers.text = "Select Overs..."; defOvers.selected = true; defOvers.disabled = true;
            oversSelect.appendChild(defOvers);
            for(let i=3; i<=15; i++) {
                const opt = document.createElement('option'); opt.value = i; opt.text = i + ' Overs';
                oversSelect.appendChild(opt);
            }

            const playersSelect = document.getElementById('players-per-side');
            const defPlayers = document.createElement('option'); defPlayers.value = ""; defPlayers.text = "Select Players..."; defPlayers.selected = true; defPlayers.disabled = true;
            playersSelect.appendChild(defPlayers);
            for(let i=4; i<=11; i++) {
                const opt = document.createElement('option'); opt.value = i; opt.text = i + ' Players';
                playersSelect.appendChild(opt);
            }

            // 2. Tournament Dropdowns (Step 2)
            const tOvers = document.getElementById('tourney-overs');
            if (tOvers) {
                tOvers.innerHTML = ""; // Clear default
                for(let i=2; i<=20; i++) {
                    const opt = document.createElement('option'); 
                    opt.value = i; opt.text = i + ' Overs';
                    if(i === 6) opt.selected = true; // Default
                    tOvers.appendChild(opt);
                }
            }

            const tPlayers = document.getElementById('tourney-players');
            if (tPlayers) {
                tPlayers.innerHTML = ""; // Clear default
                for(let i=4; i<=15; i++) {
                    const opt = document.createElement('option'); 
                    opt.value = i; opt.text = i + ' Players';
                    if(i === 8) opt.selected = true; // Default
                    tPlayers.appendChild(opt);
                }
            }
            
            // 3. Rules Dropdowns
            const wicketSelect = document.getElementById('rule-wicket');
            for(let i=0; i<=6; i++) {
                const opt = document.createElement('option'); 
                opt.value = i; 
                opt.text = (i === 0) ? "No Penalty (0)" : `-${i} Runs`;
                if(i === 0) opt.selected = true; // Auto-select No Penalty
                wicketSelect.appendChild(opt);
            }

            loadSavedTeams();
            showScreen('setup-screen');
            setupGlobalEnterNavigation(); // Initialize Global Navigation
        };


        // --- GLOBAL KEYBOARD NAVIGATION (PROFESSIONAL UX) ---
        function setupGlobalEnterNavigation() {
            document.addEventListener('keydown', (e) => {
                // Logic: Enter key acts as Tab for data entry
                if (e.key !== 'Enter') return;

                const target = e.target;
                
                // Allow standard Enter behavior for Buttons, Links, and Textareas
                if (['BUTTON', 'A', 'TEXTAREA'].includes(target.tagName)) return;

                // 1. Identify all potentially focusable inputs/selects
                const selector = 'input:not([type="hidden"]):not([disabled]), select:not([disabled])';
                const allElements = Array.from(document.querySelectorAll(selector));
                
                // 2. Filter for ONLY visible elements (Handling SPA hidden sections)
                // We check offsetParent or dimensions to ensure the user can actually see it
                const visibleElements = allElements.filter(el => {
                    return !!(el.offsetWidth || el.offsetHeight || el.getClientRects().length) &&
                           window.getComputedStyle(el).visibility !== 'hidden';
                });

                const index = visibleElements.indexOf(target);

                if (index > -1 && index < visibleElements.length - 1) {
                    e.preventDefault(); // Prevent premature form submission
                    const nextEl = visibleElements[index + 1];
                    nextEl.focus();
                    
                    // UX Polish: Auto-select text in inputs for rapid overwrite
                    if (nextEl.tagName === 'INPUT' && ['text', 'number', 'tel', 'email'].includes(nextEl.type)) {
                        nextEl.select();
                    }
                } else if (index === visibleElements.length - 1) {
                    // Last field: Blur to close mobile keyboard or indicate completion
                    target.blur();
                }
            });
        }

        function showScreen(id) {
            document.querySelectorAll('body > div').forEach(d => {
                if(d.id !== 'splash-screen' && !d.classList.contains('modal-overlay')) d.classList.add('hidden');
            });
            const el = document.getElementById(id);
            if(el) { el.classList.remove('hidden'); if(id==='app') el.classList.add('flex'); }
        }

        // --- GAME MODE SELECTION LOGIC ---
        function selectGameMode(mode) {
            // Hide the selection screen
            document.getElementById('mode-selection-screen').classList.add('hidden');
            document.getElementById('mode-selection-screen').classList.remove('active');
            
            if (mode === 'SINGLE') {
                // Show Single Match Setup (Step 1)
                state.matchType = 'SINGLE';
                const step1 = document.getElementById('setup-step-1');
                step1.classList.remove('hidden');
                setTimeout(() => step1.classList.add('active'), 10);
            } else if (mode === 'TOURNAMENT') {
                // Show Tournament Setup
                state.matchType = 'TOURNAMENT';
                const tourneySetup = document.getElementById('tournament-setup');
                tourneySetup.classList.remove('hidden');
                setTimeout(() => tourneySetup.classList.add('active'), 10);
                
                // FIX: Only render if empty (Prevents data loss when navigating back)
                const container = document.getElementById('tournament-slots-container');
                if (!container.innerHTML.trim()) {
                    renderTournamentSlots();
                }
            }
        }

        function backToModeSelect() {
            // Hide all sub-steps
            document.querySelectorAll('.setup-step').forEach(el => {
                if (el.id !== 'mode-selection-screen') {
                    el.classList.add('hidden');
                    el.classList.remove('active');
                }
            });
            
            // Show Selection Screen
            const menu = document.getElementById('mode-selection-screen');
            menu.classList.remove('hidden');
            setTimeout(() => menu.classList.add('active'), 10);
        }
        function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function closeModal(id) { 
            document.getElementById(id).classList.add('hidden'); 
            if(id !== 'bowler-edit-modal' && id !== 'player-modal' && editingBallIndex === null) {
                // Keep editingBallIndex active if inside the bowler edit flow
            }
        }
        
        function openWicketModal() { openModal('wicket-type-modal'); }
        function openViewControlModal() { openModal('broadcast-control-modal'); } // ADDED MISSING FUNCTION

        function generateUniqueId() { return 'p_' + Math.random().toString(36).substr(2, 9); }

        function getTeamInitials(name) {
            if (!name) return '??';
            const parts = name.trim().split(/\s+/);
            if (parts.length === 1) return name.substring(0, 2).toUpperCase();
            return parts.map(p => p[0]).join('').substring(0, 3).toUpperCase();
        }
        // --- CUSTOM DIALOG SYSTEM (Replaces Alert/Confirm) ---
        
        const CustomDialog = {
            el: document.getElementById('custom-dialog-modal'),
            title: document.getElementById('dialog-title'),
            msg: document.getElementById('dialog-message'),
            icon: document.getElementById('dialog-icon'),
            iconContainer: document.getElementById('dialog-icon-container'),
            strip: document.getElementById('dialog-header-strip'),
            btns: document.getElementById('dialog-buttons'),
            
            show(config) {
                // Config: { title, message, type: 'alert'|'confirm', icon, theme: 'blue'|'red'|'green', onConfirm, onCancel }
                const theme = config.theme || 'blue';
                const colors = {
                    blue: { bg: 'bg-blue-50', text: 'text-blue-600', strip: 'bg-blue-600' },
                    red: { bg: 'bg-red-50', text: 'text-red-600', strip: 'bg-red-600' },
                    green: { bg: 'bg-green-50', text: 'text-green-600', strip: 'bg-green-600' },
                    purple: { bg: 'bg-purple-50', text: 'text-purple-600', strip: 'bg-purple-600' }
                };
                const c = colors[theme];

                // 1. Style UI
                this.title.textContent = config.title || "Notification";
                this.msg.innerHTML = config.message || ""; // Allow HTML for bold text
                this.icon.textContent = config.icon || "‚ÑπÔ∏è";
                
                this.iconContainer.className = `mx-auto w-16 h-16 rounded-full flex items-center justify-center mb-4 shadow-sm ${c.bg} ${c.text}`;
                this.strip.className = `h-2 w-full ${c.strip}`;

                // 2. Build Buttons
                this.btns.innerHTML = '';
                
                if (config.type === 'confirm') {
                    this.btns.className = "grid grid-cols-2 gap-3";
                    
                    // Cancel Button
                    const btnCancel = document.createElement('button');
                    btnCancel.className = "py-3 bg-gray-100 hover:bg-gray-200 text-gray-600 font-bold rounded-xl transition-colors uppercase text-xs tracking-wider";
                    btnCancel.textContent = config.cancelText || "Cancel";
                    btnCancel.onclick = () => {
                        this.hide();
                        if(config.onCancel) config.onCancel();
                    };
                    this.btns.appendChild(btnCancel);

                    // Confirm Button
                    const btnConfirm = document.createElement('button');
                    btnConfirm.className = `py-3 ${c.strip} hover:opacity-90 text-white font-bold rounded-xl shadow-lg transition-transform active:scale-95 uppercase text-xs tracking-wider`;
                    btnConfirm.textContent = config.confirmText || "Confirm";
                    btnConfirm.onclick = () => {
                        this.hide();
                        if(config.onConfirm) config.onConfirm();
                    };
                    this.btns.appendChild(btnConfirm);
                    
                } else {
                    // Alert Button (Single)
                    this.btns.className = "grid grid-cols-1";
                    const btnOk = document.createElement('button');
                    btnOk.className = `w-full py-3.5 ${c.strip} hover:opacity-90 text-white font-bold rounded-xl shadow-lg transition-transform active:scale-95 uppercase text-xs tracking-wider`;
                    btnOk.textContent = "Okay, Got it";
                    btnOk.onclick = () => {
                        this.hide();
                        if(config.onConfirm) config.onConfirm();
                    };
                    this.btns.appendChild(btnOk);
                }

                // 3. Show Modal
                this.el.classList.remove('hidden');
            },

            hide() {
                this.el.classList.add('hidden');
            }
        };

        // Helper Shortcuts
        function showCustomAlert(title, message, theme='blue') {
            CustomDialog.show({ type: 'alert', title, message, theme });
        }

        function showCustomConfirm(title, message, onConfirm, theme='blue') {
            CustomDialog.show({ type: 'confirm', title, message, onConfirm, theme, icon: '‚ùì' });
        }


        // --- DATA LOADING & SETUP LOGIC ---
        function loadSavedTeams() {
            db.collection("teams").orderBy("updatedAt", "desc").get().then((querySnapshot) => {
                savedTeamsData = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const players = (data.players || []).map(p => {
                        if (typeof p === 'string') return { name: p, image: '' };
                        return { 
                            name: p.name, 
                            image: p.avatar || p.image || '', 
                            id: p.id || null 
                        };
                    });
                    // Capture Country, Default to Canada if missing (for testing)
                    savedTeamsData.push({ 
                        id: doc.id, 
                        name: data.name, 
                        logo: data.logo, 
                        players: players,
                        country: data.country || "Canada" 
                    });
                });
                populateTeamDropdowns();
            });
        }
        function populateTeamDropdowns() {
            ['team1-select', 'team2-select'].forEach(id => {
                const select = document.getElementById(id);
                select.innerHTML = '<option value="">+ Load Saved Team</option>';
                savedTeamsData.forEach(team => {
                    const opt = document.createElement('option');
                    opt.value = team.name;
                    opt.textContent = team.name;
                    select.appendChild(opt);
                });
                select.onchange = (e) => handleTeamSelection(e.target.value, id.includes('team1') ? 'team1' : 'team2');
            });
        }
        function handleTeamSelection(teamName, teamKey) {
            if(!teamName) return;
            const teamData = savedTeamsData.find(t => t.name === teamName);
            if(!teamData) return;
            
            // Set Input Value
            document.getElementById(`${teamKey}-name-input`).value = teamData.name;
            
            // Update State
            state[teamKey].name = teamData.name;
            state[teamKey].logo = teamData.logo || '';
            
            // 1. Load New Squad with fresh IDs
            state[teamKey].squad = teamData.players.map(p => ({...p, id: generateUniqueId()}));
            
            // 2. RESET Squad Selection State
            state[teamKey].playing = [];       
            state[teamKey].playerStats = {};   
            state[teamKey].captainId = null;   
            
            state[teamKey].isLoaded = true;

            // NEW: FORCE Logo Preview Display
            const previewEl = document.getElementById(`${teamKey}-logo-preview`);
            const initialsEl = previewEl.nextElementSibling; // The text span sibling
            
            if (state[teamKey].logo) {
                previewEl.src = state[teamKey].logo;
                previewEl.classList.remove('hidden');
                if(initialsEl) initialsEl.classList.add('hidden'); // Hide initials if logo exists
            } else {
                previewEl.classList.add('hidden');
                if(initialsEl) initialsEl.classList.remove('hidden');
            }
        }
        function handleLogoUpload(file, teamKey) {
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => { 
                    state[teamKey].logo = e.target.result;
                    const previewEl = document.getElementById(`${teamKey}-logo-preview`);
                    previewEl.src = e.target.result;
                    previewEl.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        }

        // --- NEW: Player Image Upload Handlers ---
        function triggerImageUpload(teamKey, playerId) {
            document.getElementById(`file-${playerId}`).click();
        }

        function uploadPlayerImage(input, teamKey, playerId) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    // 1. Update the UI Image
                    const imgEl = document.getElementById(`img-${playerId}`);
                    if(imgEl) imgEl.src = e.target.result;
                    
                    // 2. Update the State (Crucial for Innings Break/Modals)
                    const player = state[teamKey].squad.find(p => p.id === playerId);
                    if(player) player.image = e.target.result;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function goToStep(step) {
            if (step === 2) {
                // --- FIX: TOURNAMENT VALIDATION LOGIC ---
                let overs = document.getElementById('total-overs').value;
                let players = document.getElementById('players-per-side').value;
                
                // If in Tournament Mode, ensure DOM reflects state (fixes "Missing Info" error)
                if (state.matchType === 'TOURNAMENT') {
                     // Force DOM to match state if it's empty (e.g. 16/20 overs option missing in dropdown)
                     if (!overs && state.totalOvers) {
                         const os = document.getElementById('total-overs');
                         const opt = document.createElement('option');
                         opt.value = state.totalOvers;
                         opt.text = state.totalOvers + " Overs (Tourney)";
                         opt.selected = true;
                         os.add(opt);
                         os.value = state.totalOvers;
                         overs = state.totalOvers; 
                     }
                     
                     if (!players && state.playersPerSide) {
                         const ps = document.getElementById('players-per-side');
                         const opt = document.createElement('option');
                         opt.value = state.playersPerSide;
                         opt.text = state.playersPerSide + " Players (Tourney)";
                         opt.selected = true;
                         ps.add(opt);
                         ps.value = state.playersPerSide;
                         players = state.playersPerSide;
                     }
                }

                const bpo = document.getElementById('balls-per-over').value; 
                const w = document.getElementById('rule-wicket').value;
                const wd = document.getElementById('rule-wide').value;
                const nb = document.getElementById('rule-noball').value;

                if (!overs || !players) {
                    showCustomAlert("Missing Info", "Please select <b>Overs</b> and <b>Players per Side</b>.", "purple");
                    return;
                }
                if (!w || !wd || !nb || !bpo) {
                    showCustomAlert("Missing Info", "Please configure <b>Balls Per Over</b> and all <b>Penalty Rules</b>.", "purple");
                    return;
                }

                state.ballsPerOver = parseInt(bpo);
                state.rules.wicketRuns = parseInt(w);
                state.rules.wideRuns = parseInt(wd);
                state.rules.noBallRuns = parseInt(nb);
                state.rules.skins = false; 

                // FIX: Only read inputs if NOT in Tournament Mode to prevent overwriting names
                if (state.matchType !== 'TOURNAMENT') {
                    const t1Name = ui.team1NameInput.value.trim() || 'HOME TEAM';
                    const t2Name = ui.team2NameInput.value.trim() || 'AWAY TEAM';

                    if (!state.team1.isLoaded) {
                        state.team1.name = t1Name.toUpperCase();
                        handleLogoUpload(ui.team1LogoInput.files[0], 'team1');
                    }
                    if (!state.team2.isLoaded) {
                        state.team2.name = t2Name.toUpperCase();
                        handleLogoUpload(ui.team2LogoInput.files[0], 'team2');
                    }
                }

                ui.team1RosterTitle.textContent = state.team1.name;
                document.getElementById('team1-roster-logo').src = state.team1.logo || 'https://placehold.co/60x60/3b82f6/white?text=H';
                ui.team2RosterTitle.textContent = state.team2.name;
                document.getElementById('team2-roster-logo').src = state.team2.logo || 'https://placehold.co/60x60/64748b/white?text=A';
                generateUnifiedRoster('team1');
                generateUnifiedRoster('team2');
            }

            document.querySelectorAll('.setup-step').forEach(s => { s.classList.remove('active'); s.classList.add('hidden'); });
            const next = document.getElementById(`setup-step-${step}`);
            next.classList.remove('hidden');
            setTimeout(() => next.classList.add('active'), 10);
            
            ui.progressBar.style.width = `${step * 33}%`;

            if(step === 4) {
                if(isEditMatchMode) {
                    saveEditChanges();
                    return;
                }

                ui.tossTeam1Name.textContent = state.team1.name;
                if (state.team1.logo) {
                    ui.tossTeam1LogoContainer.innerHTML = `<img src="${state.team1.logo}" class="w-full h-full object-cover rounded-full border-2 border-white shadow-sm">`;
                    ui.tossTeam1LogoContainer.style.backgroundColor = 'transparent';
                } else {
                    ui.tossTeam1LogoContainer.style.backgroundColor = '#3b82f6';
                    ui.tossTeam1LogoContainer.innerHTML = `<span class="text-xl font-bold text-white tracking-wider">${getTeamInitials(state.team1.name)}</span>`;
                }
                ui.tossTeam2Name.textContent = state.team2.name;
                if (state.team2.logo) {
                    ui.tossTeam2LogoContainer.innerHTML = `<img src="${state.team2.logo}" class="w-full h-full object-cover rounded-full border-2 border-white shadow-sm">`;
                    ui.tossTeam2LogoContainer.style.backgroundColor = 'transparent';
                } else {
                    ui.tossTeam2LogoContainer.style.backgroundColor = '#ef4444'; 
                    ui.tossTeam2LogoContainer.innerHTML = `<span class="text-xl font-bold text-white tracking-wider">${getTeamInitials(state.team2.name)}</span>`;
                }
            }
        }

        // --- NEW: SQUAD BUILDER WITH DRAG & DROP ---
        let teamSortables = {}; // Store sortable instances

        function generateUnifiedRoster(teamKey) {
            const container = document.getElementById(`${teamKey}-player-inputs`);
            const countBadge = document.getElementById(`${teamKey}-count-badge`);
            container.innerHTML = '';
            
            // 1. Ensure minimal squad size exists
            const required = parseInt(ui.playersPerSideInput.value) || 8;
            if (state[teamKey].squad.length < required) {
                for(let i = state[teamKey].squad.length; i < required; i++) {
                    state[teamKey].squad.push({ id: generateUniqueId(), name: '', image: '' });
                }
            }

            let selectedCount = 0;
            
            // 2. Render Rows
            state[teamKey].squad.forEach((player, index) => {
                const isSelected = state[teamKey].playing.length > 0 ? state[teamKey].playing.includes(player.id) : index < required;
                
                if (isSelected) {
                    if (!state[teamKey].playing.includes(player.id)) state[teamKey].playing.push(player.id);
                    selectedCount++;
                }

                const isCaptain = state[teamKey].captainId === player.id;
                const isRematchDim = (state.seriesStats && state.seriesStats.active && !isSelected);
                const extraClass = isRematchDim ? 'opacity-50 grayscale bg-gray-50' : '';

                const row = document.createElement('div');
                
                // Add 'data-id' so Sortable knows which player this is
                row.setAttribute('data-id', player.id);
                row.className = `roster-row ${isSelected ? 'selected' : ''} ${extraClass}`;
                
                row.innerHTML = `
                    <div class="drag-handle" title="Drag to reorder">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </div>

                    <div class="flex items-center gap-2">
                        <input type="checkbox" class="w-5 h-5 text-blue-600 rounded cursor-pointer" 
                            onchange="togglePlayerSelection(this, '${teamKey}', '${player.id}')" ${isSelected ? 'checked' : ''}>
                        
                        <button onclick="setCaptain('${teamKey}', '${player.id}')" 
                            class="w-6 h-6 rounded-full text-[10px] font-bold border flex items-center justify-center transition-colors ${isCaptain ? 'bg-yellow-400 text-black border-yellow-500' : 'bg-gray-100 text-gray-400 border-gray-300'}" 
                            title="Set as Captain">
                            C
                        </button>
                    </div>

                    <div class="flex items-center gap-2 overflow-hidden">
                        <div class="relative group cursor-pointer" onclick="triggerImageUpload('${teamKey}', '${player.id}')">
                            <img id="img-${player.id}" src="${player.image || 'https://placehold.co/40x40/e2e8f0/gray?text=P'}" class="w-8 h-8 rounded-full border object-cover bg-gray-50">
                            <div class="absolute inset-0 bg-black/50 hidden group-hover:flex items-center justify-center rounded-full">
                                <span class="text-[8px] text-white">üì∑</span>
                            </div>
                        </div>
                        
                        <input type="text" value="${player.name}" class="roster-input" 
                            onchange="updatePlayerName(this.value, '${teamKey}', '${player.id}')" placeholder="PLAYER NAME">
                    </div>

                    <button onclick="deletePlayerFromRoster('${teamKey}', '${player.id}')" class="text-gray-300 hover:text-red-500 transition-colors">‚úï</button>
                    <input type="file" id="file-${player.id}" class="hidden" accept="image/*" onchange="uploadPlayerImage(this, '${teamKey}', '${player.id}')">
                `;
                container.appendChild(row);
            });
            
            countBadge.textContent = `${selectedCount} / ${required}`;
            if(selectedCount === required) {
                countBadge.classList.add('bg-green-100', 'text-green-700', 'border-green-200');
                countBadge.classList.remove('bg-white');
            } else {
                 countBadge.classList.remove('bg-green-100', 'text-green-700', 'border-green-200');
                 countBadge.classList.add('bg-white');
            }

            // 3. Initialize SortableJS
            if (teamSortables[teamKey]) teamSortables[teamKey].destroy(); // Cleanup old instance
            teamSortables[teamKey] = new Sortable(container, {
                animation: 150,
                handle: '.drag-handle', // Drag via handle only
                ghostClass: 'sortable-ghost',
                dragClass: 'sortable-drag',
                onEnd: function (evt) {
                    // Visual reorder is enough, we read the DOM in 'proceedFromUnifiedRoster'
                }
            });
        }
        function updatePlayerName(newName, teamKey, playerId) {
            const player = state[teamKey].squad.find(p => p.id === playerId);
            if(player) player.name = newName.toUpperCase();
        }

        function togglePlayerSelection(checkbox, teamKey, playerId) {
            const row = checkbox.closest('.roster-row');
            const limit = parseInt(ui.playersPerSideInput.value); 

            if (checkbox.checked) {
                if (state[teamKey].playing.length >= limit) {
                    checkbox.checked = false; 
                    row.classList.add('bg-red-100', 'border-red-500'); 
                    setTimeout(() => {
                        row.classList.remove('bg-red-100', 'border-red-500');
                    }, 800);
                    return; 
                }
                row.classList.add('selected');
                if (!state[teamKey].playing.includes(playerId)) state[teamKey].playing.push(playerId);
            } else {
                row.classList.remove('selected');
                state[teamKey].playing = state[teamKey].playing.filter(id => id !== playerId);
            }
            generateUnifiedRoster(teamKey); 
        }

        function deletePlayerFromRoster(teamKey, playerId) {
            if(confirm("Delete player?")) {
                state[teamKey].squad = state[teamKey].squad.filter(p => p.id !== playerId);
                state[teamKey].playing = state[teamKey].playing.filter(id => id !== playerId);
                generateUnifiedRoster(teamKey);
            }
        }
        function addNewPlayerToRoster(teamKey) {
            const newId = generateUniqueId();
            state[teamKey].squad.push({ id: newId, name: '', image: '' });
            generateUnifiedRoster(teamKey);
        }
        function proceedFromUnifiedRoster() {
            const required = parseInt(ui.playersPerSideInput.value);
            
            // 1. Capture the Visual Order from DOM (This builds the formation)
            ['team1', 'team2'].forEach(key => {
                const container = document.getElementById(`${key}-player-inputs`);
                const rows = container.querySelectorAll('.roster-row');
                
                // Rebuild 'playing' array based on visual DOM order
                let newPlayingOrder = [];
                let fullSquadReordered = []; // We also reorder the main squad to match visuals

                rows.forEach(row => {
                    const pid = row.getAttribute('data-id');
                    const checkbox = row.querySelector('input[type="checkbox"]');
                    
                    // Find original player object
                    const pObj = state[key].squad.find(p => p.id === pid);
                    if(pObj) fullSquadReordered.push(pObj);

                    if (checkbox && checkbox.checked) {
                        newPlayingOrder.push(pid);
                    }
                });

                // Update State
                state[key].squad = fullSquadReordered; // Save the new visual order
                state[key].playing = newPlayingOrder;  // Save the Playing XI in order
            });

            // 2. Validate Count
            if (state.team1.playing.length !== required) { 
                showCustomAlert("Squad Error", `<b>Home Team</b> needs exactly ${required} players selected.<br>Current: ${state.team1.playing.length}`, "red");
                return; 
            }
            if (state.team2.playing.length !== required) { 
                showCustomAlert("Squad Error", `<b>Away Team</b> needs exactly ${required} players selected.<br>Current: ${state.team2.playing.length}`, "red");
                return; 
            }
            
            // 3. Initialize Player Stats based on this new order
            if (!isEditMatchMode) {
                ['team1', 'team2'].forEach(key => {
                    state[key].playerStats = {};
                    state[key].playing.forEach((pid, index) => {
                        const p = state[key].squad.find(sq => sq.id === pid);
                        const pName = p && p.name ? p.name : "Player " + (index+1);
                        state[key].playerStats[pid] = { 
                            id: pid, 
                            name: pName, 
                            runs: 0, balls: 0, fours: 0, sixes: 0, wickets: 0, runsConceded: 0, ballsBowled: 0 
                        };
                    });
                });
            }
            goToStep(4);
        }

        // --- EDIT MATCH MODE LOGIC ---
        function openEditMatchMode() {
            isEditMatchMode = true;
            document.getElementById('setup-title').textContent = "Edit Match Settings";
            document.getElementById('btn-roster-confirm').textContent = "Confirm Changes ‚Üí";
            showScreen('setup-screen');
            goToStep(1);
        }

        function saveEditChanges() {
            state.totalOvers = parseInt(ui.totalOversInput.value);
            state.playersPerSide = parseInt(ui.playersPerSideInput.value);
            state.ballsPerOver = parseInt(document.getElementById('balls-per-over').value); // Update BPO
            state.venue = ui.venueInput.value;
            alert("Match Settings Updated!");
            isEditMatchMode = false;
            updateMatchHeader();
            updateScoreboard();
            syncToLiveDB();
            showScreen('app');
        }
function generateBroadcastCode() {
            // 1. Generate Robust ID (e.g., MATCH_9X2Y5) to prevent collisions
            // Generates a random alphanumeric string (base 36)
            const randomPart = Math.random().toString(36).substring(2, 7).toUpperCase();
            broadcastId = `MATCH_${randomPart}`;

            const display = document.getElementById('broadcast-display');
            const codeBox = document.getElementById('match-code-box');
            
            display.classList.remove('hidden');
            
            // 2. Adjust font size for longer ID so it fits on mobile
            codeBox.classList.remove('text-6xl');
            codeBox.classList.add('text-3xl', 'md:text-4xl'); 
            
            codeBox.textContent = broadcastId;
            
            const btn = document.getElementById('btn-broadcast-enable');
            btn.classList.remove('bg-blue-50', 'text-blue-700');
            btn.classList.add('bg-green-100', 'text-green-800', 'border-green-300');
            btn.innerHTML = `<span class="text-lg">‚úÖ BROADCAST LIVE</span><span class="text-xs font-normal">Code: ${broadcastId}</span>`;
            
            // FIX: Check readiness FIRST, then sync. This prevents the logic gap.
            checkStartReady();
            syncToLiveDB();
        }
        // --- TOSS & BROADCAST LOGIC ---
        function selectTossWinner(w) {
            tossWinner = w;
            document.querySelectorAll('.toss-card-btn').forEach(b => b.classList.remove('selected'));
            document.getElementById(`toss-winner-${w}`).classList.add('selected');
            checkStartReady();
        }

        function selectTossChoice(c) {
    tossDecision = c;
    document.querySelectorAll('.decision-btn').forEach(b => b.classList.remove('selected'));
    document.getElementById(`toss-choice-${c}`).classList.add('selected');
    checkStartReady();

    // --- NEW: Smooth Scroll to Start Button ---
    setTimeout(() => {
        document.getElementById('start-match-btn').scrollIntoView({ 
            behavior: 'smooth', 
            block: 'center' 
        });
    }, 300); // Small delay for a natural feel
}

        function syncToLiveDB(lastAction = null) {
            if (!broadcastId) return;

            // --- Helper to Generate a Team's Full Card ---
            const generateInningsData = (teamKey, opponentKey) => {
                const team = state[teamKey];
                const opp = state[opponentKey];
                
                // 1. Batting Stats
                const batting = [];
                let extrasTotal = 0; // You can enhance this with specific wide/nb counts later
                
                Object.values(team.playerStats).forEach(p => {
                     // Include if they played any part
                     const isAtCrease = (state.striker?.id === p.id) || (state.nonStriker?.id === p.id);
                     if (p.balls > 0 || p.runs > 0 || p.dismissal || isAtCrease) {
                         let status = "not out";
                         if (p.dismissal) status = p.dismissal;
                         else if (isAtCrease) status = "not out";
                         
                         batting.push({
                             name: p.name,
                             runs: p.runs,
                             balls: p.balls,
                             fours: p.fours || 0,
                             sixes: p.sixes || 0,
                             sr: p.balls > 0 ? (p.runs * 100 / p.balls).toFixed(2) : "0.00",
                             dismissal: status
                         });
                     }
                });

                // 2. Bowling Stats (Opponent Bowlers)
                const bowling = [];
                const bpo = state.ballsPerOver || 6;
                Object.values(opp.playerStats).forEach(p => {
                    if (p.ballsBowled > 0) {
                        const o = Math.floor(p.ballsBowled / bpo) + '.' + (p.ballsBowled % bpo);
                        const econ = (p.runsConceded / (p.ballsBowled/bpo)).toFixed(2);
                        bowling.push({
                            name: p.name,
                            o: o,
                            m: 0,
                            r: p.runsConceded,
                            w: p.wickets,
                            econ: econ
                        });
                    }
                });
                
                return {
                    name: team.name,
                    score: `${team.score}/${team.wickets}`,
                    overs: `${team.overs}.${team.balls}`,
                    batting: batting,
                    bowling: bowling,
                    logo: team.logo
                };
            };

            // --- Prepare Payload ---
            const payload = {
                // Security & Session
                adminPin: "2626", 
                lastUpdatedBy: Date.now(),

                // Game State (CRITICAL FOR HANDOVER)
                currentInnings: state.innings,       // Save that we are in Innings 2
                activeBattingTeam: state.battingTeam, // Save 'team1' or 'team2' key
                target: state.target || 0,

                // Basic Info
                venue: state.venue || "Unknown Venue",
                matchDate: document.getElementById('match-date-input').value,
                matchStatus: state.innings === 2 && state.team2.score > state.team1.score ? "COMPLETE" : "LIVE",
                
                isSuperOver: state.isSuperOver || false, 
                
                // Live State
                currentOver: state.currentOver.map(b => b.event),
                timeline: state.timeline || [],

                // Player Names
                striker: state.striker || { name: "", runs: 0, balls: 0 },
                nonStriker: state.nonStriker || { name: "", runs: 0, balls: 0 },
                bowler: state.bowler || { name: "", wkts: 0, runs: 0, balls: 0 },
                
                // Full Scorecards
                scorecard: {
                    innings1: generateInningsData('team1', 'team2'),
                    innings2: generateInningsData('team2', 'team1')
                },

                // Legacy
                t1: state.team1.name, t2: state.team2.name,
                t1Logo: state.team1.logo, t2Logo: state.team2.logo, 
                
                score: state[state.battingTeam].score || 0,
                wickets: state[state.battingTeam].wickets || 0,
                overs: state[state.battingTeam].overs || 0,
                balls: state[state.battingTeam].balls || 0,
                
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };

            if (lastAction) payload.lastAction = { id: Date.now(), type: lastAction };

            db.collection("live_matches").doc(broadcastId).set(payload, { merge: true })
                .catch(err => console.error("Sync Error:", err));
        }
        
        function checkStartReady() {
    const btn = document.getElementById('start-match-btn');
    
    // Define the "Active" classes for the pulsing green effect
    const activeClasses = ['bg-gradient-to-r', 'from-green-500', 'to-emerald-600', 'text-white', 'shadow-[0_0_30px_rgba(34,197,94,0.8)]', 'animate-pulse', 'transform', 'hover:scale-105'];
    // Define the "Disabled" classes
    const disabledClasses = ['bg-gray-200', 'text-gray-400', 'opacity-50', 'cursor-not-allowed', 'shadow-none'];

    if(tossWinner && tossDecision && broadcastId) {
        btn.disabled = false;
        
        // Remove disabled styles
        btn.classList.remove(...disabledClasses);
        
        // Add Pulsing Green Styles
        btn.classList.add(...activeClasses);
        btn.innerHTML = "üöÄ START MATCH üöÄ"; // Changes text for emphasis
    } else {
        btn.disabled = true;
        
        // Add disabled styles
        btn.classList.add(...disabledClasses);
        
        // Remove active styles
        btn.classList.remove(...activeClasses);
        btn.innerHTML = "START MATCH";
    }
}

        function copyBroadcastLink() {
            const code = document.getElementById('match-code-box').textContent;
            navigator.clipboard.writeText(code).then(() => {
                const fb = document.getElementById('copy-feedback');
                fb.classList.remove('hidden');
                setTimeout(() => fb.classList.add('hidden'), 2000);
            });
        }

        // --- ADDED MISSING TOGGLE FUNCTION ---
        function toggleView(viewName, toggleEl) {
    if(!broadcastId) return;
    let updateData = {};
    
    // Simple toggle logic:
    if(viewName === 'SQUAD') updateData = { showSquad: toggleEl.checked };
    else if(viewName === 'BATTING') updateData = { showBattingCard: toggleEl.checked };
    else if(viewName === 'BOWLING') updateData = { showBowlingCard: toggleEl.checked };
    else if(viewName === 'RUN_RATE') updateData = { showRunRate: toggleEl.checked }; // <--- ADDED THIS LINE

    db.collection("live_matches").doc(broadcastId).set(updateData, { merge: true });
}

        function selectTossChoice(c) {
            tossDecision = c;
            document.querySelectorAll('.decision-btn').forEach(b => b.classList.remove('selected'));
            document.getElementById(`toss-choice-${c}`).classList.add('selected');
            checkStartReady();

            // --- NEW: Smooth Scroll to Start Button ---
            setTimeout(() => {
                document.getElementById('start-match-btn').scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center' 
                });
            }, 300); // Small delay for a natural feel
        }

        function startMatch() {
            // --- NEW: Confetti Explosion ---
            confetti({
                particleCount: 150,
                spread: 100,
                origin: { y: 0.6 }, // Starts from slightly below center
                colors: ['#2563eb', '#facc15', '#ef4444', '#22c55e'] // Blue, Yellow, Red, Green
            });
            // -------------------------------

            state.totalOvers = parseInt(ui.totalOversInput.value);
            state.playersPerSide = parseInt(ui.playersPerSideInput.value);
            state.venue = ui.venueInput.value;

            state.team1.score = 0; state.team1.wickets = 0; state.team1.overs = 0; state.team1.balls = 0;
            state.team2.score = 0; state.team2.wickets = 0; state.team2.overs = 0; state.team2.balls = 0;

            if ((tossWinner === 'team1' && tossDecision === 'bat') || (tossWinner === 'team2' && tossDecision === 'bowl')) {
                state.battingTeam = 'team1'; state.bowlingTeam = 'team2';
            } else {
                state.battingTeam = 'team2'; state.bowlingTeam = 'team1';
            }

            syncToLiveDB();

            state.rules.wicketRuns = parseInt(document.getElementById('rule-wicket').value); 
            
            document.getElementById('btn-wicket').textContent = `WKT (-${state.rules.wicketRuns})`;
            document.getElementById('wicket-modal-title').textContent = `WICKET! (-${state.rules.wicketRuns} Runs)`;
            
            const wVal = state.rules.wideRuns;
            const nbVal = state.rules.noBallRuns;

            // Wide Buttons + Run Out Option
            let wButtons = `<button onclick="handleAddExtra('wd', ${wVal})" class="col-span-3 p-4 bg-blue-100 text-blue-900 font-bold rounded-xl mb-1">Standard (+${wVal})</button>`;
            [3, 4, 5, 6].forEach(r => {
                if (r !== wVal) wButtons += `<button onclick="handleAddExtra('wd', ${r})" class="p-4 bg-gray-100 font-bold rounded-xl">+${r}</button>`;
            });
            // Add Wide Run Out Button
            wButtons += `<button onclick="setupExtraRunOut('wd')" class="col-span-3 mt-2 p-3 bg-red-50 text-red-900 font-bold rounded-xl border border-red-200">RUN OUT</button>`;
            document.getElementById('wide-options').innerHTML = wButtons;

            // No Ball Buttons + Run Out Option
            let nbButtons = `<button onclick="handleAddExtra('nb', ${nbVal})" class="col-span-3 p-4 bg-blue-100 text-blue-900 font-bold rounded-xl mb-1">Standard (+${nbVal})</button>`;
            [3, 4, 5, 6].forEach(r => {
                if (r !== nbVal) nbButtons += `<button onclick="handleAddExtra('nb', ${r})" class="p-4 bg-gray-100 font-bold rounded-xl">+${r}</button>`;
            });
            // Add NB Run Out Button
            nbButtons += `<button onclick="setupExtraRunOut('nb')" class="col-span-3 mt-2 p-3 bg-red-50 text-red-900 font-bold rounded-xl border border-red-200">RUN OUT</button>`;
            document.getElementById('noball-options').innerHTML = nbButtons;

            updateMatchHeader();
            updateScoreboard();
            showScreen('app');
            initInnings();
        }

        function updateMatchHeader() {
            const t1 = state.team1.name;
            const t2 = state.team2.name;
            const venue = (state.venue || 'Unknown Venue').toUpperCase();
            const dateObj = state.matchDate ? new Date(state.matchDate) : new Date();
            const dateStr = dateObj.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
            
            // Build the subtitle parts
            let infoParts = [];
            
            // 1. Add Match Code first (Styled Blue)
            if (typeof broadcastId !== 'undefined' && broadcastId) {
                infoParts.push(`<span class="text-blue-600 font-bold">CODE: ${broadcastId}</span>`);
            }
            
            // 2. Add remaining details
            infoParts.push(venue);
            infoParts.push(dateStr);
            infoParts.push(`${state.totalOvers} Overs`);
            infoParts.push(`${state.playersPerSide}-a-side`);

            // Join with a separator
            const subTitle = infoParts.join(" <span class='text-gray-300'>|</span> ");

            // --- REMATCH CONTEXT ---
            let rematchHTML = '';
            if (state.seriesStats && state.seriesStats.active) {
                const s = state.seriesStats;
                rematchHTML = `
                    <div class="mt-1 flex items-center justify-center gap-3 text-[9px] font-bold uppercase tracking-widest bg-yellow-50 border-y border-yellow-100 py-1">
                        <span class="text-gray-500">H2H: <span class="text-gray-800">${s.t1Wins} - ${s.t2Wins}</span></span>
                        ${s.lastWinner ? `<span class="text-blue-600">Last: ${s.lastWinner} (${s.lastMargin})</span>` : ''}
                    </div>
                `;
            }

            const headerHTML = `
                <div class="py-2 relative">
                    <h1 class="text-xs font-black text-gray-900 uppercase tracking-tight leading-tight">
                        ${t1} <span class="text-gray-400 font-medium text-[10px] px-1">vs</span> ${t2}
                    </h1>
                    <p class="text-[10px] text-gray-500 font-medium mt-1 tracking-wide">
                        ${subTitle}
                    </p>
                    ${rematchHTML}
                </div>
            `;
            document.getElementById('match-header').innerHTML = headerHTML;
        }

        function updateScoreboard() {
            const battingTeamKey = state.battingTeam;
            const bowlingTeamKey = state.bowlingTeam;
            const battingTeam = state[battingTeamKey];
            const bowlingTeam = state[bowlingTeamKey];

            const createTeamRow = (team, isBatting, isFirstInnings) => {
                const logoSrc = team.logo || '';
                const logoHTML = logoSrc ? `<img src="${logoSrc}" class="w-8 h-8 rounded-full object-cover border border-gray-200">` : `<div class="w-8 h-8 rounded-full flex items-center justify-center font-bold text-white text-xs" style="background-color: #3b82f6;">${getTeamInitials(team.name)}</div>`;
                let rightSideHTML = '';
                
                const score = team.score || 0;
                const wkts = team.wickets || 0;
                const overs = team.overs || 0;
                const balls = team.balls || 0;
                
                if (isBatting) {
                    rightSideHTML = `<div class="text-right"><div class="text-xl font-bold text-gray-900 leading-none">${score}/${wkts}</div><div class="text-xs text-gray-500 font-medium mt-0.5">(${overs}.${balls} / ${state.totalOvers} ov)</div></div>`;
                } else {
                    if (isFirstInnings) rightSideHTML = `<div class="text-sm font-bold text-gray-400 uppercase tracking-wide">Yet to bat</div>`;
                    else rightSideHTML = `<div class="text-right"><div class="text-lg font-bold text-gray-700 leading-none">${score}/${wkts}</div><div class="text-xs text-gray-400">(${overs}.${balls} ov)</div></div>`;
                }

                const containerClass = isBatting ? "flex items-center justify-between py-3 border-b border-gray-100 bg-white px-2" : "flex items-center justify-between py-3 bg-gray-50/50 opacity-60 px-2";
                const nameClass = isBatting ? "text-base font-black text-gray-800 uppercase tracking-tight" : "text-base font-bold text-gray-500 uppercase tracking-tight";

                return `<div class="${containerClass}"><div class="flex items-center gap-3">${logoHTML}<span class="${nameClass}">${team.name}</span></div>${rightSideHTML}</div>`;
            };

            const row1 = createTeamRow(battingTeam, true, state.innings === 1);
            const row2 = createTeamRow(bowlingTeam, false, state.innings === 1);
            document.getElementById('team-scores-container').innerHTML = row1 + row2;
        }

        function selectOpeningPair(callback) {
            const team = state.battingTeam;
            const sSelect = document.getElementById('pair-striker-select');
            const nsSelect = document.getElementById('pair-nonstriker-select');
            
            sSelect.innerHTML = '<option value="">Select Striker...</option>';
            nsSelect.innerHTML = '<option value="">Select Non-Striker...</option>';
            
            Object.keys(state[team].playerStats).forEach(pid => {
                const p = state[team].playerStats[pid];
                const optS = document.createElement('option');
                optS.value = p.id;
                optS.textContent = p.name;
                sSelect.appendChild(optS);

                const optNS = document.createElement('option');
                optNS.value = p.id;
                optNS.textContent = p.name;
                nsSelect.appendChild(optNS);
            });

            openModal('opening-pair-modal');
            state.pairSelectionCallback = callback;
        }

        function updatePairExclusions() {
            const sSelect = document.getElementById('pair-striker-select');
            const nsSelect = document.getElementById('pair-nonstriker-select');
            
            const sVal = sSelect.value;
            const nsVal = nsSelect.value;

            Array.from(nsSelect.options).forEach(opt => {
                if (opt.value === "") return;
                opt.disabled = (opt.value === sVal);
            });

            Array.from(sSelect.options).forEach(opt => {
                if (opt.value === "") return;
                opt.disabled = (opt.value === nsVal);
            });
        }

        function confirmOpeningPair() {
            const sVal = document.getElementById('pair-striker-select').value;
            const nsVal = document.getElementById('pair-nonstriker-select').value;
            
            if(!sVal || !nsVal || sVal === nsVal) {
                alert("Please select two different players.");
                return;
            }

            const team = state.battingTeam;
            state.striker = state[team].playerStats[sVal];
            state.nonStriker = state[team].playerStats[nsVal];
            
            closeModal('opening-pair-modal');
            if (state.pairSelectionCallback) state.pairSelectionCallback();
        }

        let pendingSelection = null; 

        function applyWicketPenalty(who, type, fielder = null) {
            addToHistory();
            const penalty = state.rules.wicketRuns;
            const bt = state[state.battingTeam];
            const bwl = state.bowler; 
            
            const roleKey = (who === 'nonstriker' || who === 'nonStriker') ? 'nonStriker' : 'striker';
            const victim = state[roleKey];

            let dismissalText = type; 
            if (victim) {
                if (type === 'Bowled' && bwl) dismissalText = `b. ${bwl.name}`;
                else if (type === 'LBW' && bwl) dismissalText = `lbw b. ${bwl.name}`;
                else if (type === 'Catch' && bwl) dismissalText = `c. ${fielder || 'Sub'} b. ${bwl.name}`;
                else if (type === 'Stumped' && bwl) dismissalText = `st. ${fielder || 'Keeper'} b. ${bwl.name}`;
                else if (type === 'Hit Wicket' && bwl) dismissalText = `hit wkt b. ${bwl.name}`;
                
                victim.dismissal = dismissalText; 
                victim.runs -= penalty; 
            }

            bt.score -= penalty;
            if (state.striker) { state.striker.balls++; }
            bt.wickets = (bt.wickets || 0) + 1;
            
            if (bwl && type !== 'Run Out' && type !== 'Retired Out' && type !== 'Other') { bwl.wickets++; }
            if (bwl) { bwl.ballsBowled++; }

            showEventPopup("OUT", "text-red-600");
            
            // Pass 'true' (isDismissal) to stop auto-next-bowler
            processBall(0, 'W', true, true);
            updateUI();

            if (victim && broadcastId) {
                setTimeout(() => {
                    const cardData = {
                        name: victim.name, score: victim.runs, balls: victim.balls,
                        howOut: dismissalText.toUpperCase(), teamLogo: state[state.battingTeam].logo
                    };
                    db.collection("live_matches").doc(broadcastId).set({ showDismissalCard: true, dismissalData: cardData }, { merge: true });
                    setTimeout(() => { db.collection("live_matches").doc(broadcastId).set({ showDismissalCard: false }, { merge: true }); }, 7000);
                }, 1500);
            }

            let wicketLimit = state.playersPerSide - 1;
            if (state.isSuperOver) {
                wicketLimit = 2; 
            }

            if (bt.wickets >= wicketLimit) {
                setTimeout(() => { 
                    alert(state.isSuperOver ? "SUPER OVER ENDS (2 Wickets!)" : "ALL OUT!"); 
                    endInnings(); 
                }, 1200);
            } else {
                // FIX: Check for Over End AFTER selecting next batter
                setTimeout(() => { 
                    selectPlayer(roleKey, () => {
                        updateUI();
                        // If this was the last ball (balls reset to 0 by processBall), ask for bowler now
                        if (bt.balls === 0 && bt.overs > 0 && bt.overs < state.totalOvers) {
                            swapStrikers();
                            state.currentOver = [];
                            setTimeout(() => selectPlayer('bowler', updateUI), 300);
                        }
                    }); 
                }, 1200);
            }
        }

        document.getElementById('player-save-btn').onclick = function() {
            if (!pendingSelection) return;

            const selectedId = document.getElementById('player-select').value;
            if (!selectedId || selectedId === "No players available") {
                closeModal('player-modal');
                return; 
            }

            const role = pendingSelection.role;
            const teamKey = (role === 'bowler') ? state.bowlingTeam : state.battingTeam;
            const newPlayer = state[teamKey].playerStats[selectedId];

            // --- NEW: Strict Validation ---
            if (newPlayer.status === 'DISQUALIFIED') {
                showCustomAlert("Action Denied", "This player has been disqualified and cannot participate.", "red");
                return;
            }

            if (window.correctionMode) {
                const oldPlayer = state[role]; 
                if (oldPlayer && newPlayer.id !== oldPlayer.id) {
                    newPlayer.runs = (newPlayer.runs || 0) + (oldPlayer.runs || 0);
                    newPlayer.balls = (newPlayer.balls || 0) + (oldPlayer.balls || 0);
                    newPlayer.wickets = (newPlayer.wickets || 0) + (oldPlayer.wickets || 0);
                    newPlayer.runsConceded = (newPlayer.runsConceded || 0) + (oldPlayer.runsConceded || 0);
                    newPlayer.ballsBowled = (newPlayer.ballsBowled || 0) + (oldPlayer.ballsBowled || 0);

                    oldPlayer.runs = 0; oldPlayer.balls = 0;
                    oldPlayer.wickets = 0; oldPlayer.runsConceded = 0; oldPlayer.ballsBowled = 0;
                }
                window.correctionMode = false; 
            }

            if (role === 'bowler') { state.bowler = newPlayer; } 
            else if (role === 'striker') { state.striker = newPlayer; } 
            else if (role === 'nonStriker') { state.nonStriker = newPlayer; }

            closeModal('player-modal');
            if (pendingSelection.callback) pendingSelection.callback();
            
            pendingSelection = null;
            updateUI(); 
        };

    // --- NEW OPENING PAIR LOGIC ---
    let tempStrikerId = null;
    let tempNonStrikerId = null;

    function initInnings() {
        openOpeningPairModal();
    }

    function openOpeningPairModal() {
        tempStrikerId = null;
        tempNonStrikerId = null;
        renderOpeningPairGrids();
        document.getElementById('opening-pair-modal').classList.remove('hidden');
    }

    function renderOpeningPairGrids() {
        const team = state.battingTeam;
        const squad = state[team].playerStats;
        const fullSquad = state[team].squad; // For images
        
        const sGrid = document.getElementById('op-striker-grid');
        const nsGrid = document.getElementById('op-nonstriker-grid');
        const confirmBtn = document.getElementById('op-confirm-btn');

        sGrid.innerHTML = '';
        nsGrid.innerHTML = '';

        // UI STATE LOGIC
        const isStrikerSelected = !!tempStrikerId;
        const isBothSelected = !!(tempStrikerId && tempNonStrikerId);

        // Update Confirm Button
        if (isBothSelected) {
            confirmBtn.disabled = false;
            confirmBtn.classList.remove('bg-gray-300', 'text-gray-500', 'cursor-not-allowed', 'shadow-none');
            confirmBtn.classList.add('bg-gradient-to-r', 'from-blue-600', 'to-indigo-600', 'text-white', 'shadow-xl', 'scale-105');
            confirmBtn.innerHTML = "START INNINGS üöÄ";
        } else {
            confirmBtn.disabled = true;
            confirmBtn.className = "w-full md:w-1/2 py-4 bg-gray-300 text-gray-500 font-black rounded-xl text-xl shadow-none transition-all uppercase tracking-widest cursor-not-allowed";
            confirmBtn.innerHTML = "Select Both Players";
        }

        // Render Players
        Object.values(squad).forEach(p => {
            if(p.dismissal) return; // Skip players who are out (if any)

            const pImg = fullSquad.find(x => x.id === p.id)?.image;
            
            // --- 1. STRIKER CARD ---
            const sCard = createPairCard(p, pImg, (p.id === tempStrikerId));
            
            // Interaction: If striker selected, grey out the rest of striker grid (Visual Focus)
            if (isStrikerSelected) {
                if (p.id !== tempStrikerId) sCard.classList.add('opacity-40', 'grayscale', 'scale-90');
                else sCard.classList.add('ring-4', 'ring-blue-500', 'scale-105', 'z-10');
            }

            sCard.onclick = () => {
                // If clicking the already selected one, Reset
                if (tempStrikerId === p.id) {
                    tempStrikerId = null;
                    tempNonStrikerId = null; // Reset NS too
                } else {
                    tempStrikerId = p.id;
                    tempNonStrikerId = null; // Reset NS if Striker changes
                    
                    // --- NEW: Scroll to Non-Striker Section on Mobile ---
                    setTimeout(() => {
                        const nsSection = document.getElementById('op-ns-header');
                        if(nsSection) nsSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 150);
                }
                renderOpeningPairGrids();
            };
            sGrid.appendChild(sCard);

            // --- 2. NON-STRIKER CARD ---
            const nsCard = createPairCard(p, pImg, (p.id === tempNonStrikerId));

            // Interaction: 
            // - If NO striker selected: Completely disabled
            // - If Striker IS selected: Enable, but hide the Striker himself
            if (!isStrikerSelected) {
                nsCard.classList.add('opacity-20', 'pointer-events-none', 'grayscale');
            } else {
                if (p.id === tempStrikerId) {
                    nsCard.classList.add('opacity-0', 'pointer-events-none'); // Hide Striker from NS list
                } else if (tempNonStrikerId && p.id !== tempNonStrikerId) {
                    nsCard.classList.add('opacity-40', 'grayscale', 'scale-90');
                } else if (p.id === tempNonStrikerId) {
                    nsCard.classList.add('ring-4', 'ring-orange-500', 'scale-105', 'z-10');
                }
            }

            nsCard.onclick = () => {
                tempNonStrikerId = p.id;
                renderOpeningPairGrids();
            };
            nsGrid.appendChild(nsCard);
        });
    }

    function createPairCard(p, img, isSelected) {
        const div = document.createElement('div');
        div.className = `flex flex-col items-center p-2 rounded-2xl bg-white border border-gray-200 shadow-sm transition-all duration-300 cursor-pointer hover:shadow-md select-none relative`;
        
        const avatar = img 
            ? `<img src="${img}" class="w-14 h-14 rounded-full object-cover border-2 border-white shadow-md bg-gray-100 mb-2">`
            : `<div class="w-14 h-14 rounded-full bg-gradient-to-br from-gray-500 to-gray-700 text-white flex items-center justify-center font-black text-lg border-2 border-white shadow-md mb-2">${p.name.substring(0,2)}</div>`;

        div.innerHTML = `
            ${avatar}
            <div class="text-[9px] font-black text-gray-700 text-center uppercase leading-tight w-full truncate">${p.name}</div>
            ${isSelected ? '<div class="absolute top-2 right-2 text-green-500 bg-white rounded-full"><svg class="w-4 h-4 fill-current" viewBox="0 0 20 20"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"/></svg></div>' : ''}
        `;
        return div;
    }

    function confirmOpeningPair() {
        if(!tempStrikerId || !tempNonStrikerId) return;

        const team = state.battingTeam;
        state.striker = state[team].playerStats[tempStrikerId];
        state.nonStriker = state[team].playerStats[tempNonStrikerId];

        document.getElementById('opening-pair-modal').classList.add('hidden');
        
        // Proceed to Bowler Selection
        selectPlayer('bowler', updateUI);
    }

    // --- FUNCTION RESTORED: Handles Individual Player Selection (Bowlers/Next Batsman) ---
    function selectPlayer(role, callback) {
        pendingSelection = { role, callback };
        
        const teamKey = (role === 'bowler') ? state.bowlingTeam : state.battingTeam;
        const roster = state[teamKey].playerStats;
        const fullSquad = state[teamKey].squad; 
        
        const grid = document.getElementById('player-selection-grid');
        grid.innerHTML = '';

        const title = document.getElementById('modal-title');
        if(title) {
            if(role === 'bowler') title.textContent = "Select Bowler";
            else if(role === 'striker') title.textContent = "Select Striker";
            else if(role === 'nonStriker') title.textContent = "Select Non-Striker";
        }

        const players = Object.values(roster);
        
        if(players.length === 0) {
            grid.innerHTML = '<p class="col-span-3 text-center text-gray-400 text-sm">No players available</p>';
            openModal('player-modal');
            return;
        }

        players.forEach(p => {
            // 1. Identify if this is the "Resting" bowler (Previous Bowler)
            const isResting = (role === 'bowler' && state.bowler && state.bowler.id === p.id && !window.correctionMode);
            
            // --- NEW: Check Disqualification Status ---
            const isDisqualified = (p.status === 'DISQUALIFIED');
            const isInjured = (p.status === 'INJURED');

            // 2. If selecting batter, exclude the other batter on crease
            if (role === 'striker' && state.nonStriker && state.nonStriker.id === p.id) return;
            if (role === 'nonStriker' && state.striker && state.striker.id === p.id) return;

            // 3. If selecting batter, exclude those who are already OUT (unless correcting)
            if ((role === 'striker' || role === 'nonStriker') && p.dismissal && !window.correctionMode) return;

            // Find Image
            const squadMember = fullSquad.find(s => s.id === p.id);
            const imgSrc = squadMember ? squadMember.image : null;
            
            // Base Avatar HTML
            let avatarHTML = imgSrc 
                ? `<img src="${imgSrc}" class="w-10 h-10 rounded-full object-cover border border-gray-200">`
                : `<div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center font-bold text-gray-500 text-xs">${getTeamInitials(p.name).substring(0,2)}</div>`;

            // If Resting, Add Banner Overlay
            if (isResting) {
                avatarHTML = `
                <div class="relative">
                    ${avatarHTML}
                    <div class="absolute -bottom-1 left-1/2 -translate-x-1/2 bg-gray-800 text-white text-[7px] px-1.5 py-0.5 rounded font-bold uppercase tracking-wider shadow-sm border border-white">RESTING</div>
                </div>`;
            }

            // --- NEW: Disqualified Banner Overlay ---
            if (isDisqualified) {
                avatarHTML = `
                <div class="relative">
                    ${avatarHTML}
                    <div class="absolute -bottom-1 left-1/2 -translate-x-1/2 bg-red-600 text-white text-[7px] px-1.5 py-0.5 rounded font-bold uppercase tracking-wider shadow-sm border border-white">DISQUALIFIED</div>
                </div>`;
            }

            const btn = document.createElement('button');
            
            if (isResting || isDisqualified) {
                // Disabled / Greyed Out Styling
                btn.className = "flex flex-col items-center justify-center p-3 bg-gray-50 border border-gray-200 rounded-xl shadow-none opacity-50 grayscale cursor-not-allowed";
                btn.onclick = (e) => { e.preventDefault(); }; 
            } else {
                // Active / Selectable Styling
                btn.className = "flex flex-col items-center justify-center p-3 bg-white border border-gray-200 rounded-xl shadow-sm hover:border-blue-500 hover:bg-blue-50 transition-all";
                btn.onclick = () => {
                    document.getElementById('player-select').value = p.id;
                    document.getElementById('player-save-btn').click();
                };
            }

            btn.innerHTML = `
                ${avatarHTML}
                <span class="mt-2 text-xs font-bold text-gray-700 text-center leading-tight">${p.name}</span>
                ${p.ballsBowled > 0 && role === 'bowler' ? `<span class="text-[9px] text-gray-400 mt-1">${p.wickets}-${p.runsConceded}</span>` : ''}
                ${(p.balls > 0 || p.runs > 0) && role !== 'bowler' ? `<span class="text-[9px] text-gray-400 mt-1">${p.runs} (${p.balls})</span>` : ''}
            `;
            
            grid.appendChild(btn);
        });

        openModal('player-modal');
    }

        // --- ENHANCED EVENT HANDLERS (NORMAL + EDIT SUPPORT) ---
        let tempWicketType = null;

        function handleWicketAction(type) {
            closeModal('wicket-type-modal');
            
            if (type === 'Run Out') {
                const btnS = document.getElementById('btn-ro-striker');
                const btnNS = document.getElementById('btn-ro-nonstriker');
                btnS.textContent = state.striker ? `${state.striker.name} (Striker)` : "Striker";
                btnNS.textContent = state.nonStriker ? `${state.nonStriker.name} (Non-Striker)` : "Non-Striker";
                openModal('runout-modal');
            } else {
                if (editingBallIndex !== null) {
                    // EDIT MODE: Apply specific wicket change
                    applyBallCorrection(editingBallIndex, 0, 'W');
                    // Reset
                    editingBallIndex = null;
                } else {
                    // NORMAL MODE
                    applyWicketPenalty('striker', type);
                }
            }
        }

        // Global to hold temp data for Extra Run Outs
        let extraRunOutState = null;
        let tempExtraType = null; // Temp storage for the type while selecting runs

        function setupExtraRunOut(type) {
            // 1. Close the extra modal
            if(type === 'wd') closeModal('wide-modal');
            if(type === 'nb') closeModal('noball-modal');
            if(type === 'ext') closeModal('extras-modal');

            // 2. Store the type (Wide, NB, or Leg Bye) and Open the Runs Modal
            tempExtraType = type;
            openModal('extra-runs-modal');
        }

        function selectExtraRuns(runs) {
            closeModal('extra-runs-modal');
            
            // 3. Store state and open the "Who is Out?" modal
            extraRunOutState = { type: tempExtraType, runs: runs };
            
            const btnS = document.getElementById('btn-ro-striker');
            const btnNS = document.getElementById('btn-ro-nonstriker');
            btnS.textContent = state.striker ? `${state.striker.name} (Striker)` : "Striker";
            btnNS.textContent = state.nonStriker ? `${state.nonStriker.name} (Non-Striker)` : "Non-Striker";
            
            openModal('runout-modal');
        }

        function handleAddExtra(type, runs) {
            if (editingBallIndex !== null) {
                // EDIT MODE
                closeModal('wide-modal'); closeModal('noball-modal'); closeModal('extras-modal');
                let label = type.toUpperCase();
                if (type === 'wd' || type === 'nb') {
                    if (runs > 1) { label = `${type.toUpperCase()}+${runs - 1}`; }
                } else if (type === 'pen' && runs < 0) {
                    label = `${runs}`;
                } else if (type === 'ext' && runs > 0) {
                    label = `+${runs}`;
                }
                applyBallCorrection(editingBallIndex, runs, label);
                editingBallIndex = null;
            } else {
                // NORMAL MODE
                addExtra(type, runs);
            }
        }

        function setupFielderSelect(type) {
            closeModal('wicket-type-modal');
            tempWicketType = type; 
            const select = document.getElementById('fielder-select');
            select.innerHTML = '';
            const title = document.getElementById('fielder-modal-title');
            title.textContent = (type === 'Catch') ? "Who took the Catch?" : "Who is the Keeper?";
            
            const roster = state[state.bowlingTeam].playerStats;
            Object.values(roster).forEach(player => {
                const opt = document.createElement('option');
                opt.value = player.name; 
                opt.textContent = player.name;
                select.appendChild(opt);
            });
            openModal('fielder-modal');
        }

        function confirmFielder() {
            const fielderName = document.getElementById('fielder-select').value;
            if(!fielderName) return;
            closeModal('fielder-modal');
            
            if (editingBallIndex !== null) {
                // Edit Mode: Just mark as Wicket (simplification for edit pad)
                applyBallCorrection(editingBallIndex, 0, 'W'); 
                editingBallIndex = null;
            } else {
                applyWicketPenalty('striker', tempWicketType, fielderName);
            }
        }

        function finalizeRunOut(who) {
            closeModal('runout-modal');
            
            if (editingBallIndex !== null) {
                applyBallCorrection(editingBallIndex, 0, 'W');
                editingBallIndex = null;
            } 
            else if (extraRunOutState) {
                // --- SPECIAL EXTRA RUN OUT LOGIC ---
                const { type, runs } = extraRunOutState;
                const penalty = state.rules.wicketRuns;
                const bt = state[state.battingTeam];
                const bwl = state.bowler;
                const roleKey = (who === 'nonstriker' || who === 'nonStriker') ? 'nonStriker' : 'striker';
                const victim = state[roleKey];

                addToHistory();

                // 1. Calculate Score based on Type
                let totalRunsToAdd = 0;
                let eventLabel = "";
                let isLegal = false;

                if (type === 'wd') {
                    // Wide (1) + Completed Runs
                    totalRunsToAdd = state.rules.wideRuns + runs; 
                    eventLabel = `WD+${runs} W`;
                    isLegal = false;
                } else if (type === 'nb') {
                    // NB (1) + Completed Runs
                    totalRunsToAdd = state.rules.noBallRuns + runs;
                    eventLabel = `NB+${runs} W`;
                    isLegal = false; // NB doesn't count as ball bowled
                } else if (type === 'ext') {
                    // Just Completed Runs (Leg Byes)
                    totalRunsToAdd = runs;
                    eventLabel = `LB+${runs} W`;
                    isLegal = true; // Leg Byes count as legal ball
                }
                
                // 2. Apply Scores & Wicket Penalty
                bt.score += totalRunsToAdd; // Add the extras/runs first
                if (bwl) bwl.runsConceded += totalRunsToAdd;

                bt.score -= penalty; // Then subtract wicket penalty
                bt.wickets++;

                if (victim) {
                    victim.runs -= penalty;
                    victim.dismissal = `Run Out (${eventLabel})`;
                }
                
                if (bwl && isLegal) bwl.ballsBowled++; 

                // 3. Process Ball (Pass true for isDismissal)
                processBall(totalRunsToAdd - penalty, eventLabel, isLegal, true);
                
                // 4. Reset & UI
                extraRunOutState = null;
                showEventPopup("OUT", "text-red-600");
                updateUI();

                // 5. Check All Out / Next Player
                let wicketLimit = state.playersPerSide - 1;
                if (state.isSuperOver) wicketLimit = 2;

                if (bt.wickets >= wicketLimit) {
                    setTimeout(() => { alert("ALL OUT!"); endInnings(); }, 500);
                } else {
                    // FIX: Check for Over End AFTER selecting next batter
                    setTimeout(() => { 
                        selectPlayer(roleKey, () => {
                            updateUI();
                            if (isLegal && bt.balls === 0 && bt.overs > 0 && bt.overs < state.totalOvers) {
                                swapStrikers();
                                state.currentOver = [];
                                setTimeout(() => selectPlayer('bowler', updateUI), 300);
                            }
                        }); 
                    }, 500);
                }
            } 
            else {
                // Standard Run Out
                applyWicketPenalty(who, 'Run Out');
            }
        }

        function applyWicketPenalty(who, type, fielder = null) {
            addToHistory();
            const penalty = state.rules.wicketRuns;
            const bt = state[state.battingTeam];
            const bwl = state.bowler; 
            
            const roleKey = (who === 'nonstriker' || who === 'nonStriker') ? 'nonStriker' : 'striker';
            const victim = state[roleKey];

            let dismissalText = type; 
            if (victim) {
                if (type === 'Bowled' && bwl) dismissalText = `b. ${bwl.name}`;
                else if (type === 'LBW' && bwl) dismissalText = `lbw b. ${bwl.name}`;
                else if (type === 'Catch' && bwl) dismissalText = `c. ${fielder || 'Sub'} b. ${bwl.name}`;
                else if (type === 'Stumped' && bwl) dismissalText = `st. ${fielder || 'Keeper'} b. ${bwl.name}`;
                else if (type === 'Hit Wicket' && bwl) dismissalText = `hit wkt b. ${bwl.name}`;
                
                victim.dismissal = dismissalText; 
                victim.runs -= penalty; 
            }

            bt.score -= penalty;
            if (state.striker) { state.striker.balls++; }
            bt.wickets = (bt.wickets || 0) + 1;
            
            if (bwl && type !== 'Run Out' && type !== 'Retired Out' && type !== 'Other') { bwl.wickets++; }
            if (bwl) { bwl.ballsBowled++; }

            showEventPopup("OUT", "text-red-600");
            
            // FIX: Pass 'true' as 4th argument (isDismissal)
            processBall(0, 'W', true, true);
            updateUI();

            if (victim && broadcastId) {
                setTimeout(() => {
                    const cardData = {
                        name: victim.name, score: victim.runs, balls: victim.balls,
                        howOut: dismissalText.toUpperCase(), teamLogo: state[state.battingTeam].logo
                    };
                    db.collection("live_matches").doc(broadcastId).set({ showDismissalCard: true, dismissalData: cardData }, { merge: true });
                    setTimeout(() => { db.collection("live_matches").doc(broadcastId).set({ showDismissalCard: false }, { merge: true }); }, 7000);
                }, 1500);
            }

            // --- SUPER OVER LOGIC: 2 Wickets = All Out ---
            // --- REGULAR LOGIC: Players-1 = All Out ---
            let wicketLimit = state.playersPerSide - 1;
            if (state.isSuperOver) {
                wicketLimit = 2; // ICC Rule: Innings ends at 2 wickets
            }

            if (bt.wickets >= wicketLimit) {
                setTimeout(() => { 
                    alert(state.isSuperOver ? "SUPER OVER ENDS (2 Wickets!)" : "ALL OUT!"); 
                    endInnings(); 
                }, 1200);
            } else {
                // FIX: Modified flow for last ball wicket
                setTimeout(() => { 
                    selectPlayer(roleKey, () => {
                        updateUI();
                        // AFTER batter is selected, check if that wicket ended the over
                        // If ball count is 0 and overs > 0, the over just finished
                        if (bt.balls === 0 && bt.overs > 0 && bt.overs < state.totalOvers) {
                            swapStrikers();
                            state.currentOver = [];
                            selectPlayer('bowler', updateUI);
                        }
                    }); 
                }, 1200);
            }
        }

        function addToHistory() {
            undoStack.push(JSON.parse(JSON.stringify(state)));
        }

        function undoLastAction() {
            if (undoStack.length === 0) { 
                if(typeof showCustomAlert === 'function') showCustomAlert("Info", "Nothing to undo!", "blue");
                else alert("Nothing to undo!"); 
                return; 
            }
            
            // 1. Restore the Old State completely
            state = undoStack.pop();
            
            // 2. Close any open modals/dialogs
            const modals = ['wicket-type-modal', 'wide-modal', 'noball-modal', 'extras-modal', 'runout-modal', 'mid-over-modal', 'player-modal'];
            modals.forEach(id => {
                const el = document.getElementById(id);
                if(el) el.classList.add('hidden');
            });
            if(typeof CustomDialog !== 'undefined' && CustomDialog.hide) CustomDialog.hide();

            // 3. Restore Reference Integrity
            // Crucial: We must ensure state.striker points to the player object INSIDE the restored state.teamX
            // otherwise the UI might read from the 'old' state object but the logic updates a 'detached' object.
            const restoreRef = (role, teamKey) => {
                // Determine the correct team based on the restored state
                const team = state[teamKey];
                
                if (state[role] && state[role].id && team && team.playerStats) {
                    const realObj = team.playerStats[state[role].id];
                    // Force the role to point to the object inside the team stats
                    if (realObj) {
                        state[role] = realObj;
                    }
                } else {
                    state[role] = null;
                }
            };
            
            restoreRef('bowler', state.bowlingTeam);
            restoreRef('striker', state.battingTeam);
            restoreRef('nonStriker', state.battingTeam);

            // 4. Force Update UI
            // We specifically call these to repaint the tables with the 'state' data we just restored
            updateScoreboard(); 
            updateUI(); 
        }

        // --- Helper Render Functions (Ensures Undo Visuals Work) ---

        function renderBattingCard() {
            const container = document.getElementById('batting-table');
            if(!container) return;
            container.innerHTML = '';

            const team = state[state.battingTeam];
            // Iterate through the playing squad to show everyone
            team.playing.forEach(playerId => {
                const player = team.playerStats[playerId];
                if (!player) return;

                // Determine Status (Striker, Non-Striker, Out, etc.)
                let status = '';
                let highlightClass = '';
                
                if (state.striker && state.striker.id === playerId) {
                    status = 'üèè'; // Striker
                    highlightClass = 'bg-blue-50 font-bold';
                } else if (state.nonStriker && state.nonStriker.id === playerId) {
                    status = 'üèÉ'; // Non-Striker
                    highlightClass = 'bg-blue-50/50';
                } else if (player.dismissal) {
                    status = `<span class="text-[10px] text-red-500 font-bold uppercase">${player.dismissal}</span>`;
                    highlightClass = 'opacity-70 grayscale';
                }

                // Don't show players who haven't batted yet (optional, but cleaner)
                // Remove this 'if' if you want to see the full list
                if (!status && player.balls === 0 && player.runs === 0) return;

                const row = document.createElement('div');
                row.className = `flex justify-between items-center p-3 border-b border-gray-100 ${highlightClass}`;
                row.innerHTML = `
                    <div class="flex items-center gap-2">
                        <span class="text-xs font-bold text-gray-700">${player.name}</span>
                        <span class="text-xs">${status}</span>
                    </div>
                    <div class="text-xs font-mono font-bold text-gray-800">
                        ${player.runs} <span class="text-gray-400 font-normal">(${player.balls})</span>
                    </div>
                `;
                container.appendChild(row);
            });
        }

        function renderBowlingCard() {
            const container = document.getElementById('bowling-table');
            if(!container) return;
            container.innerHTML = '';

            const team = state[state.bowlingTeam];
            // Sort: Active bowler first, then others
            const activeId = state.bowler ? state.bowler.id : null;
            const bowlers = team.playing
                .map(id => team.playerStats[id])
                .filter(p => p.ballsBowled > 0 || (activeId === p.id)); // Show only if bowled or active

            bowlers.forEach(player => {
                const isActive = (activeId === player.id);
                const row = document.createElement('div');
                row.className = `flex justify-between items-center p-3 border-b border-gray-100 ${isActive ? 'bg-green-50 border-l-4 border-l-green-500' : ''}`;
                
                // Calculate overs (e.g. 1.3)
                const completedOvers = Math.floor(player.ballsBowled / 6); // Assuming 6 ball overs roughly for display
                const balls = player.ballsBowled % 6; // This is a rough approx for display
                // Better: Use the overs calculation logic from your main loop if available
                const oversDisplay = `${Math.floor(player.ballsBowled / state.ballsPerOver)}.${player.ballsBowled % state.ballsPerOver}`;

                row.innerHTML = `
                    <div class="flex flex-col">
                        <span class="text-xs font-bold text-gray-700">${player.name} ${isActive ? 'ü•é' : ''}</span>
                        ${player.status === 'DISQUALIFIED' ? '<span class="text-[9px] text-red-600 font-bold">DISQUALIFIED</span>' : ''}
                    </div>
                    <div class="text-xs font-mono font-bold text-gray-800 text-right">
                        <div>${player.wickets}-${player.runsConceded}</div>
                        <div class="text-[9px] text-gray-400">${oversDisplay} ov</div>
                    </div>
                `;
                container.appendChild(row);
            });
        }

        function addRuns(runs) {
            addToHistory();
            const bt = state[state.battingTeam];
            const str = state.striker;
            const bwl = state.bowler; 

            bt.score = (bt.score || 0) + runs;
            if (str) { 
                str.runs += runs; 
                str.balls++; 
                if(runs === 4) str.fours = (str.fours || 0) + 1;
                if(runs === 6) str.sixes = (str.sixes || 0) + 1;
            }
            if (bwl) { bwl.runsConceded += runs; bwl.ballsBowled++; }

            // --- FIX: Check for Win in Innings 2 OR Super Over Chase (Innings 4) ---
            const isChaseInning = (state.innings === 2 && state.rules.wicketRuns === 0) || state.innings === 4;
            
            if (isChaseInning) {
                if (bt.score >= state.target) {
                    processBall(runs, `${runs}`, true);
                    updateUI(); 
                    setTimeout(() => {
                        alert("TARGET CHASED! " + bt.name + " WINS!");
                        endInnings();
                    }, 100); 
                    return;
                }
            }

            if (runs === 4) showEventPopup("4", "text-blue-500");
            if (runs === 6) showEventPopup("6", "text-green-500");

            processBall(runs, `${runs}`, true);
            if(runs % 2 !== 0) swapStrikers();
            updateUI();
        }

        function showEventPopup(text, colorClass) {
            let animType = null;
            if (text === "4") animType = "4";
            if (text === "6") animType = "6";
            if (text === "OUT") animType = "W";
            if (animType) syncToLiveDB(animType); 

            const overlay = document.getElementById('event-animation-overlay');
            const textEl = document.getElementById('event-animation-text');
            textEl.textContent = text;
            textEl.className = `text-9xl font-black drop-shadow-2xl animate-pop ${colorClass}`;
            overlay.classList.remove('hidden');
            setTimeout(() => { overlay.classList.add('hidden'); }, 1200);
        }

        function addExtra(type, runs) {
            addToHistory();
            closeModal('wide-modal'); closeModal('noball-modal'); closeModal('extras-modal');
            const bt = state[state.battingTeam];
            const bwl = state.bowler; 
            
            bt.score += runs;
            if(bwl) { bwl.runsConceded += runs; }
            
            let label = type.toUpperCase();
            if (type === 'wd' || type === 'nb') {
                if (runs > 1) { label = `${type.toUpperCase()}+${runs - 1}`; }
            } else if (type === 'pen' && runs < 0) {
                label = `${runs}`;
            } else if (type === 'ext' && runs > 0) {
                label = `+${runs}`;
            }

            // --- FIX: Check for Win in Innings 2 OR Super Over Chase (Innings 4) ---
            const isChaseInning = (state.innings === 2 && state.rules.wicketRuns === 0) || state.innings === 4;

            if (isChaseInning) {
                if (bt.score >= state.target) {
                    processBall(runs, label, false); 
                    updateUI(); 
                    setTimeout(() => {
                        alert("TARGET CHASED! " + bt.name + " WINS!");
                        endInnings();
                    }, 100); 
                    return;
                }
            }

            processBall(runs, label, false); 
            updateUI();
        }

        function processBall(runs, eventLabel, isLegal, isDismissal = false) {
            const bt = state[state.battingTeam];
            if (isLegal) { bt.balls = (bt.balls || 0) + 1; }

            // 1. Get Current Names
            const currentStrikerId = state.striker ? state.striker.id : null;
            const bowlerName = state.bowler ? state.bowler.name : "Bowler";
            const batterName = state.striker ? state.striker.name : "Batter";

            // 2. Create detailed ball object
            const ballObj = {
                event: eventLabel,
                runs: runs,
                isLegal: isLegal,
                strikerId: currentStrikerId,
                bowler: bowlerName,
                batter: batterName,
                over: bt.overs || 0,
                ball: bt.balls || 0
            };

            // 3. Save to Arrays
            state.currentOver.push(ballObj);
            if(!state.timeline) state.timeline = [];
            state.timeline.push(ballObj); // Save to permanent history

            // 4. Check for Over End (DYNAMIC CHECK)
            if(bt.balls >= state.ballsPerOver) {
                bt.overs = (bt.overs || 0) + 1;
                bt.balls = 0;
                
                if(bt.overs >= state.totalOvers) {
                    endInnings();
                } else if (state.rules.skins && bt.overs % 4 === 0) {
                    setTimeout(() => { state.currentOver = []; openModal('pair-change-modal'); }, 500);
                } else {
                    // FIX: If it's a dismissal, we STOP here. 
                    // We let applyWicketPenalty handle the 'Next Bowler' call after the batsman is picked.
                    if (!isDismissal) {
                        setTimeout(() => { swapStrikers(); state.currentOver = []; selectPlayer('bowler', updateUI); }, 200);
                    }
                }
            }
        }

        function swapStrikers() { const t = state.striker; state.striker = state.nonStriker; state.nonStriker = t; }
        
        function performPairSwap() { 
            closeModal('pair-change-modal'); 
            selectOpeningPair(() => {
                selectPlayer('bowler', updateUI);
            });
        }
function endInnings() {
    // SECURITY: Ensure we don't accidentally end the match early
    if (state.innings === 1) {
        // --- INNINGS 1 END LOGIC ---
        const battingTeamObj = state[state.battingTeam];
        const bowlingTeamObj = state[state.bowlingTeam]; 
        
        // 1. Set Target
        state.target = battingTeamObj.score + 1;
        
        // 2. Populate Innings Break UI
        document.getElementById('ib-batting-team').textContent = battingTeamObj.name;
        document.getElementById('ib-score').textContent = battingTeamObj.score;
        document.getElementById('ib-wickets').textContent = battingTeamObj.wickets || 0;
        document.getElementById('ib-overs').textContent = `${battingTeamObj.overs}.${battingTeamObj.balls}`;
        document.getElementById('ib-target').textContent = state.target;
        
        const logoImg = document.getElementById('ib-team-logo');
        if (battingTeamObj.logo) {
            logoImg.src = battingTeamObj.logo;
            logoImg.classList.remove('hidden');
        } else {
            logoImg.src = `https://placehold.co/100x100/1e3a8a/white?text=${getTeamInitials(battingTeamObj.name)}`;
        }

        // Stats Calculation
        const bpo = state.ballsPerOver || 6;
        const totalBallsBowled = (battingTeamObj.overs * bpo) + battingTeamObj.balls;
        const totalOversDecimal = totalBallsBowled > 0 ? totalBallsBowled / bpo : 1;
        const crr = (battingTeamObj.score / totalOversDecimal).toFixed(2);
        document.getElementById('ib-crr').textContent = crr;
        const rrr = (state.target / state.totalOvers).toFixed(2);
        document.getElementById('ib-rrr').textContent = rrr;

        // Top Batters
        const batters = Object.values(battingTeamObj.playerStats)
            .filter(p => p.balls > 0 || p.runs > 0)
            .sort((a, b) => b.runs - a.runs);
        const topBatters = batters.slice(0, 3);
        const batListEl = document.getElementById('ib-batting-list');
        batListEl.innerHTML = topBatters.length ? topBatters.map(p => {
            const squadMember = battingTeamObj.squad.find(s => s.id === p.id);
            const imgSrc = squadMember && squadMember.image ? squadMember.image : null;
            const avatarHTML = imgSrc ? `<img src="${imgSrc}" class="w-8 h-8 rounded-full object-cover border border-blue-500 shadow-sm bg-blue-900">` : `<span class="w-8 h-8 rounded-full bg-blue-900 text-xs text-white flex items-center justify-center font-bold border border-blue-700">${getTeamInitials(p.name).substring(0,1)}</span>`;
            return `<div class="flex items-center justify-between group"><div class="flex items-center gap-3">${avatarHTML}<span class="text-sm font-bold text-gray-200 group-hover:text-white transition-colors">${p.name}</span></div><div class="font-mono font-bold text-white text-sm">${p.runs} <span class="text-xs text-gray-500 font-normal">(${p.balls})</span></div></div>`;
        }).join('') : '<div class="text-xs text-gray-500 italic text-center">No batting data available</div>';

        // Top Bowlers
        const bowlers = Object.values(bowlingTeamObj.playerStats)
            .filter(p => p.ballsBowled > 0)
            .sort((a, b) => (b.wickets - a.wickets) || (a.runsConceded - b.runsConceded));
        const topBowlers = bowlers.slice(0, 3);
        const bowlListEl = document.getElementById('ib-bowling-list');
        bowlListEl.innerHTML = topBowlers.length ? topBowlers.map(p => {
            const squadMember = bowlingTeamObj.squad.find(s => s.id === p.id);
            const imgSrc = squadMember && squadMember.image ? squadMember.image : null;
            const avatarHTML = imgSrc ? `<img src="${imgSrc}" class="w-8 h-8 rounded-full object-cover border border-orange-500 shadow-sm bg-orange-900">` : `<span class="w-8 h-8 rounded-full bg-orange-900 text-xs text-white flex items-center justify-center font-bold border border-orange-700">${getTeamInitials(p.name).substring(0,1)}</span>`;
            const bpo = state.ballsPerOver || 6;
            const bOvers = Math.floor(p.ballsBowled / bpo) + '.' + (p.ballsBowled % bpo);
            return `<div class="flex items-center justify-between group"><div class="flex items-center gap-3">${avatarHTML}<span class="text-sm font-bold text-gray-200 group-hover:text-white transition-colors">${p.name}</span></div><div class="font-mono font-bold text-white text-sm">${p.wickets}<span class="text-gray-500 mx-0.5">-</span>${p.runsConceded} <span class="text-xs text-gray-500 font-normal">(${bOvers})</span></div></div>`;
        }).join('') : '<div class="text-xs text-gray-500 italic text-center">No bowling data available</div>';

        document.getElementById('innings-break-modal').classList.remove('hidden');

    } else if (state.innings === 3) {
        // --- SUPER OVER 1st INNINGS END ---
        state.innings = 4;
        const battingTeam = state[state.battingTeam];
        state.target = battingTeam.score + 1;
        
        // Swap Teams for Chase
        const t = state.battingTeam; state.battingTeam = state.bowlingTeam; state.bowlingTeam = t;
        
        // Reset Crease
        state.currentOver = []; state.bowler = null; state.striker = null; state.nonStriker = null;
        
        alert(`SUPER OVER 2nd INNINGS!\nTarget: ${state.target} Runs (1 Over)`);
        initInnings();

    } else if (state.innings === 2 || state.innings === 4) {
        // --- MATCH COMPLETE (Only if Innings 2 or 4 ends) ---
        
        // 1. Update Tournament Data (Safe Check Included inside function)
        if(state.matchType === 'TOURNAMENT') {
            updateTournamentStatsAfterMatch(); 
        }
        
        // 2. Generate Summary UI
        generateMatchSummary();
        document.getElementById('match-summary-modal').classList.remove('hidden');
    }
}

        function generateMatchSummary() {
            const t1 = state.team1;
            const t2 = state.team2;
            let winnerText = "MATCH TIED";
            let marginText = "Scores Level";
            let isTie = false;
            let pointsBadge = "";

            // PROFESSIONAL MARGIN CALCULATION
            if (t1.score > t2.score) {
                // Team 1 (Batting 1st typically) Wins -> Won by RUNS
                winnerText = `${t1.name} WINS!`;
                marginText = `WON BY ${t1.score - t2.score} RUNS`;
                
                // Styling
                document.getElementById('card-t1').className = "bg-gradient-to-r from-green-500/20 to-emerald-500/20 backdrop-blur-lg border border-green-500/50 rounded-2xl p-6 flex items-center justify-between shadow-[0_0_30px_rgba(16,185,129,0.2)] transform scale-[1.02] transition-transform";
                document.getElementById('card-t2').className = "bg-white/5 backdrop-blur-lg border border-white/10 rounded-2xl p-6 flex items-center justify-between opacity-70 grayscale";
            
            } else if (t2.score > t1.score) {
                // Team 2 (Batting 2nd typically) Wins -> Won by WICKETS
                winnerText = `${t2.name} WINS!`;
                
                if (state.isSuperOver) {
                     marginText = `WON BY ${t2.score - t1.score} RUNS (SUPER OVER)`;
                } else {
                    // Calculate wickets remaining
                    // Assuming All Out is (Players - 1)
                    const wicketsLost = t2.wickets || 0;
                    const maxWickets = state.playersPerSide - 1; 
                    const wicketsLeft = Math.max(1, maxWickets - wicketsLost);
                    
                    marginText = `WON BY ${wicketsLeft} WICKETS`;
                }

                // Styling
                document.getElementById('card-t2').className = "bg-gradient-to-r from-green-500/20 to-emerald-500/20 backdrop-blur-lg border border-green-500/50 rounded-2xl p-6 flex items-center justify-between shadow-[0_0_30px_rgba(16,185,129,0.2)] transform scale-[1.02] transition-transform";
                document.getElementById('card-t1').className = "bg-white/5 backdrop-blur-lg border border-white/10 rounded-2xl p-6 flex items-center justify-between opacity-70 grayscale";
            
            } else {
                isTie = true;
            }

            // Points Table Update Notification
            if (state.matchType === 'TOURNAMENT') {
                pointsBadge = `<div class="mt-2 inline-flex items-center gap-2 bg-purple-500/20 border border-purple-500/50 px-3 py-1 rounded-full text-[10px] font-bold text-purple-200 uppercase tracking-widest animate-pulse">
                    <span>üèÜ Points Table Updated</span>
                </div>`;
            }

            document.getElementById('summary-winner-text').textContent = winnerText;
            document.getElementById('summary-margin-text').innerHTML = `${marginText} ${pointsBadge}`;

            // Super Over Button Logic
            const actionBtnContainer = document.getElementById('summary-action-buttons');
            const oldBtn = document.getElementById('btn-super-over');
            if(oldBtn) oldBtn.remove();
            
            // Add Button if Tie
            if (isTie && !state.isSuperOver) {
                const soBtn = document.createElement('button');
                soBtn.id = "btn-super-over";
                soBtn.onclick = startSuperOver;
                soBtn.className = "w-full mb-4 py-4 bg-gradient-to-r from-purple-600 to-indigo-600 text-white font-black uppercase tracking-widest rounded-xl shadow-[0_0_20px_rgba(124,58,237,0.5)] animate-pulse hover:scale-105 transition-transform";
                soBtn.innerHTML = "‚ö° START SUPER OVER ‚ö°";
                
                // Insert properly using the new structure
                if(actionBtnContainer) actionBtnContainer.parentNode.insertBefore(soBtn, actionBtnContainer);
            }

            // Populate Cards
            document.getElementById('sum-t1-name').textContent = t1.name;
            if(t1.logo) document.getElementById('sum-t1-logo').innerHTML = `<img src="${t1.logo}" class="w-full h-full object-cover">`;
            else document.getElementById('sum-t1-logo').textContent = getTeamInitials(t1.name);
            document.getElementById('sum-t1-score').textContent = `${t1.score}/${t1.wickets||0}`;
            document.getElementById('sum-t1-overs').textContent = `${t1.overs}.${t1.balls} ov`;

            document.getElementById('sum-t2-name').textContent = t2.name;
            if(t2.logo) document.getElementById('sum-t2-logo').innerHTML = `<img src="${t2.logo}" class="w-full h-full object-cover">`;
            else document.getElementById('sum-t2-logo').textContent = getTeamInitials(t2.name);
            document.getElementById('sum-t2-score').textContent = `${t2.score}/${t2.wickets||0}`;
            document.getElementById('sum-t2-overs').textContent = `${t2.overs}.${t2.balls} ov`;

            // Helper to find image
            const getPlayerImg = (pid, teamKey) => {
                const p = state[teamKey].squad.find(s => s.id === pid);
                return p && p.image ? p.image : null;
            };

            const allPlayers = [];
            ['team1', 'team2'].forEach(tk => {
                Object.values(state[tk].playerStats).forEach(p => {
                    p.teamName = state[tk].name;
                    p.teamKey = tk;
                    allPlayers.push(p);
                });
            });

            // TOP BATTERS
            const topBatters = [...allPlayers].sort((a,b) => b.runs - a.runs).slice(0, 3);
            document.getElementById('sum-top-batters').innerHTML = topBatters.map(p => {
                const img = getPlayerImg(p.id, p.teamKey);
                const av = img ? `<img src="${img}" class="w-8 h-8 rounded-full object-cover border border-white/30">` : `<div class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center text-[10px] font-bold text-white border border-white/30">${p.name[0]}</div>`;
                return `
                <div class="flex justify-between items-center border-b border-white/10 pb-2 last:border-0">
                    <div class="flex items-center gap-3">
                        ${av}
                        <div>
                            <div class="font-bold text-white text-sm leading-none">${p.name}</div>
                            <div class="text-[10px] text-white/50 mt-1">${p.teamName}</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-yellow-400 text-lg leading-none">${p.runs}</div>
                        <div class="text-[9px] text-white/50 mt-1">${p.balls} balls</div>
                    </div>
                </div>
            `}).join('');

            // TOP BOWLERS
            const topBowlers = [...allPlayers].sort((a,b) => (b.wickets - a.wickets) || (a.runsConceded - b.runsConceded)).slice(0, 3);
            document.getElementById('sum-top-bowlers').innerHTML = topBowlers.map(p => {
                const img = getPlayerImg(p.id, p.teamKey);
                const av = img ? `<img src="${img}" class="w-8 h-8 rounded-full object-cover border border-white/30">` : `<div class="w-8 h-8 rounded-full bg-orange-600 flex items-center justify-center text-[10px] font-bold text-white border border-white/30">${p.name[0]}</div>`;
                return `
                <div class="flex justify-between items-center border-b border-white/10 pb-2 last:border-0">
                    <div class="flex items-center gap-3">
                        ${av}
                        <div>
                            <div class="font-bold text-white text-sm leading-none">${p.name}</div>
                            <div class="text-[10px] text-white/50 mt-1">${p.teamName}</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-blue-400 text-lg leading-none">${p.wickets}<span class="text-white/50 text-xs">/${p.runsConceded}</span></div>
                        <div class="text-[9px] text-white/50 mt-1">${p.ballsBowled} balls</div>
                    </div>
                </div>
            `}).join('');

            // MAN OF THE MATCH
            const pomCandidates = [...new Set([...topBatters.slice(0,2), ...topBowlers.slice(0,2)])];
            document.getElementById('sum-pom-list').innerHTML = pomCandidates.map((p, i) => {
                const img = getPlayerImg(p.id, p.teamKey);
                const av = img ? `<img src="${img}" class="w-10 h-10 rounded-full object-cover border-2 border-yellow-500/50">` : `<div class="w-10 h-10 rounded-full bg-gray-700 flex items-center justify-center text-xs font-bold text-white border-2 border-yellow-500/50">${p.name[0]}</div>`;
                return `
                <label class="flex items-center gap-3 p-3 bg-white/5 rounded-xl cursor-pointer hover:bg-white/10 transition border border-transparent hover:border-yellow-500/50 group">
                    <input type="radio" name="pom" value="${p.id}" ${i===0?'checked':''} class="w-5 h-5 accent-yellow-500">
                    ${av}
                    <div class="flex-grow">
                        <div class="font-bold text-sm text-white group-hover:text-yellow-200 transition-colors">${p.name}</div>
                        <div class="text-[10px] text-white/60">${p.runs} Runs ‚Ä¢ ${p.wickets} Wickets</div>
                    </div>
                </label>
            `;
            }).join('');

            // --- DYNAMIC BUTTONS BASED ON MODE ---
            if (actionBtnContainer) {
                if (state.matchType === 'TOURNAMENT') {
                    // PROFESSIONAL TOURNAMENT VIEW: No Rematch, only Return to Hub
                    actionBtnContainer.innerHTML = `
                        <div class="flex flex-col gap-3">
                            <button onclick="handleMatchEndAction('TOURNAMENT_RETURN')" class="w-full py-5 bg-gradient-to-r from-purple-600 to-indigo-600 text-white font-black uppercase tracking-widest rounded-xl shadow-xl hover:scale-[1.01] transition-transform border border-white/20 flex items-center justify-center gap-3">
                                <span>Update Standings & Return</span>
                                <span class="bg-white/20 px-2 rounded text-xs">‚ûú</span>
                            </button>
                            <p class="text-center text-[10px] text-gray-400 uppercase font-bold">This match will be locked as completed</p>
                        </div>
                    `;
                } else {
                    // STANDARD SINGLE MATCH VIEW
                    actionBtnContainer.innerHTML = `
                        <div class="grid grid-cols-3 gap-3">
                            <button onclick="handleMatchEndAction('END')" class="py-4 bg-gray-800 hover:bg-gray-700 text-gray-400 font-bold uppercase rounded-xl border border-gray-700">End Match</button>
                            <button onclick="handleMatchEndAction('REMATCH')" class="py-4 bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-black uppercase tracking-wider rounded-xl shadow-lg hover:scale-[1.02] transition-transform border border-blue-400/30">‚Üª Rematch</button>
                            <button onclick="handleMatchEndAction('NEW')" class="py-4 bg-gray-200 hover:bg-white text-gray-900 font-bold uppercase rounded-xl">New Match</button>
                        </div>
                    `;
                }
            }
        }
        function startSuperOver() {
            // 1. Close the Summary Modal
            document.getElementById('match-summary-modal').classList.add('hidden');

            // 2. Setup Super Over State
            state.isSuperOver = true;
            state.innings = 3; // Technically 3rd innings of the session
            state.totalOvers = 1; // 1 Over only
            state.target = 9999; // Reset target for first batting team
            
            // 3. Reset Team Scores for the Super Over
            // Note: We keep the same Batting Team as the end of Innings 2 
            // (Because the team batting 2nd in main match bats 1st in Super Over)
            state.team1.score = 0; state.team1.wickets = 0; state.team1.balls = 0; state.team1.overs = 0;
            state.team2.score = 0; state.team2.wickets = 0; state.team2.balls = 0; state.team2.overs = 0;
            state.currentOver = [];

            // 4. Clear player stats visually for the Super Over (so they start from 0 on scoreboard)
            ['team1', 'team2'].forEach(tk => {
                Object.values(state[tk].playerStats).forEach(p => {
                    // Reset stats for the "Super Over" display
                    p.runs = 0; p.balls = 0; p.wickets = 0; 
                    p.runsConceded = 0; p.ballsBowled = 0; 
                    p.dismissal = null; 
                });
            });

            // 5. Update UI
            updateMatchHeader();
            updateScoreboard();

            // 6. Alert and Start
            // state.battingTeam is currently the team that batted 2nd in match, which is correct for SO start.
            alert(`SUPER OVER STARTING!\n${state[state.battingTeam].name} to Bat First.\n(1 Over, Max 2 Wickets)`);
            
            initInnings();
        }

        function startSecondInnings() {
    document.getElementById('innings-break-modal').classList.add('hidden');
    
    // Explicitly set to Innings 2
    state.innings = 2;
    
    // Swap Batting/Bowling Teams
    const t = state.battingTeam; 
    state.battingTeam = state.bowlingTeam; 
    state.bowlingTeam = t;
    
    // Reset Over and Active Players for fresh innings
    state.currentOver = []; 
    state.bowler = null; 
    state.striker = null;
    state.nonStriker = null;

    alert(`2nd Innings Starting!\nBatting: ${state[state.battingTeam].name}\nTarget: ${state.target}`);
    
    // Begin Player Selection
    initInnings();
}

        function manualSwap() {
            addToHistory();
            swapStrikers();
            updateUI();
        }

        function confirmExit() {
            CustomDialog.show({
                type: 'confirm',
                title: "Exit Match?",
                message: "Are you sure you want to exit? <br>All unsaved progress will be lost.",
                theme: "red",
                icon: "üö™",
                confirmText: "Yes, Exit",
                onConfirm: () => location.reload()
            });
        }

        // --- NEW EDITING LOGIC (BOWLER & OVER) ---
        function editActivePlayer(role) {
            if (role === 'bowler') {
                openBowlerEdit();
            } else {
                window.correctionMode = true; 
                selectPlayer(role, updateUI);
            }
        }

        function openBowlerEdit() {
            if (!state.bowler) return;
            
            // 1. Populate Dropdown with Bowling Team Squad
            const select = document.getElementById('edit-bowler-select');
            select.innerHTML = "";
            const squad = state[state.bowlingTeam].playerStats;
            
            Object.values(squad).forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.id;
                opt.text = p.name;
                if(p.id === state.bowler.id) opt.selected = true;
                select.appendChild(opt);
            });

            // 2. Render Over List
            renderOverEditList();
            openModal('bowler-edit-modal');
        }

        function changeCurrentBowler(newBowlerId) {
            // Swap the active bowler reference
            const newBowler = state[state.bowlingTeam].playerStats[newBowlerId];
            if(newBowler) {
                state.bowler = newBowler;
                updateUI(); // Refreshes stats display
            }
        }

        function renderOverEditList() {
            const list = document.getElementById('edit-over-list');
            list.innerHTML = "";

            state.currentOver.forEach((ball, index) => {
                const row = document.createElement('div');
                // New "Card" Layout
                row.className = "ball-edit-row"; 
                row.onclick = () => showMiniScoringPad(index, row); 

                row.innerHTML = `
                    <div class="ball-label">
                        BALL ${index + 1}
                    </div>
                    <div class="ball-value group hover:border-blue-300 hover:bg-blue-50 transition-colors">
                        <span class="text-3xl font-black text-gray-800">${ball.event}</span>
                        <div class="flex items-center gap-2 text-gray-400 group-hover:text-blue-600">
                            <span class="text-[10px] font-bold uppercase tracking-wider">Tap to Edit</span>
                            <span class="text-lg">‚úé</span>
                        </div>
                    </div>
                `;
                list.appendChild(row);
            });
        }

        // --- REPLACED: Show the Full Scoring Pad in Edit Mode ---
        function showMiniScoringPad(index, rowElement) {
            const padHTML = `
                <div class="mini-score-grid animate-pop">
                    <button class="watery-btn btn-grey" onclick="applyBallCorrection(${index}, 0, '0')">0</button>
                    <button class="watery-btn btn-grey" onclick="applyBallCorrection(${index}, 1, '1')">1</button>
                    <button class="watery-btn btn-grey" onclick="applyBallCorrection(${index}, 2, '2')">2</button>
                    <button class="watery-btn btn-grey" onclick="applyBallCorrection(${index}, 3, '3')">3</button>

                    <button class="watery-btn btn-yellow text-xs" onclick="renderOverEditList()">CANCEL</button>
                    <button class="watery-btn btn-sky text-2xl" onclick="applyBallCorrection(${index}, 4, '4')">4</button>
                    <button class="watery-btn btn-green text-2xl" onclick="applyBallCorrection(${index}, 6, '6')">6</button>
                    <button class="watery-btn btn-grey" onclick="applyBallCorrection(${index}, 5, '5')">5</button>

                    <button class="watery-btn btn-red text-sm" onclick="initiateEditAction(${index}, 'WKT')">WKT</button>
                    <button class="watery-btn btn-dark-grey text-sm" onclick="initiateEditAction(${index}, 'WD')">WD</button>
                    <button class="watery-btn btn-dark-grey text-sm" onclick="initiateEditAction(${index}, 'NB')">NB</button>
                    <button class="watery-btn btn-purple text-sm" onclick="showEditExtrasPad(${index}, this.parentNode.parentNode)">EXT</button>
                </div>
            `;
            
            const wrapper = document.createElement('div');
            wrapper.innerHTML = padHTML;
            
            rowElement.onclick = null;
            rowElement.className = "mb-2"; 
            rowElement.innerHTML = "";
            rowElement.appendChild(wrapper);
        }

        // --- NEW: Triggers for specific modals in edit mode ---
        function initiateEditAction(index, type) {
            editingBallIndex = index;
            if (type === 'WKT') openWicketModal();
            else if (type === 'WD') openModal('wide-modal');
            else if (type === 'NB') openModal('noball-modal');
        }

        function showEditExtrasPad(index, containerElement) {
            const extHTML = `
                <div class="animate-pop bg-white p-2 rounded-xl border border-purple-200 shadow-sm">
                    <div class="mb-2">
                        <p class="text-[10px] font-bold text-green-600 uppercase mb-1 text-center">Add Runs (+)</p>
                        <div class="extras-edit-grid">
                            ${[1,2,3,4,5,6].map(r => `<button onclick="handleAddExtra('ext', ${r})" class="p-2 bg-green-50 text-green-800 font-bold rounded border border-green-200 hover:bg-green-100">+${r}</button>`).join('')}
                        </div>
                    </div>
                    <div>
                        <p class="text-[10px] font-bold text-red-600 uppercase mb-1 text-center">Penalty Runs (-)</p>
                        <div class="extras-edit-grid">
                            ${[-1,-2,-3,-4,-5,-6].map(r => `<button onclick="handleAddExtra('pen', ${r})" class="p-2 bg-red-50 text-red-800 font-bold rounded border border-red-200 hover:bg-red-100">${r}</button>`).join('')}
                        </div>
                    </div>
                    <button onclick="renderOverEditList()" class="w-full mt-2 py-2 bg-gray-100 text-gray-500 font-bold text-xs rounded uppercase">Cancel</button>
                </div>
            `;
            // Set editing context before showing this pad
            editingBallIndex = index;
            containerElement.innerHTML = extHTML;
        }

        function applyBallCorrection(index, newRuns, newEvent) {
            const ball = state.currentOver[index];
            const oldRuns = ball.runs;
            const batterId = ball.strikerId; // Retrieve the ID of who played this ball

            // 1. Update Team Score
            state[state.battingTeam].score += (newRuns - oldRuns);

            // 2. Update Bowler Stats (Runs Conceded)
            if(state.bowler) {
                state.bowler.runsConceded += (newRuns - oldRuns);
            }

            // 3. Update Batter Stats (Corrected Logic)
            if (batterId) {
                // Fetch the specific player object from the team roster
                const batter = state[state.battingTeam].playerStats[batterId];
                
                if (batter) {
                    // Remove Old Runs
                    let oldBatterRuns = oldRuns;
                    if(ball.event.includes('WD')) oldBatterRuns = 0; 
                    
                    // Add New Runs
                    let newBatterRuns = newRuns;
                    if(newEvent.includes('WD')) newBatterRuns = 0;

                    batter.runs += (newBatterRuns - oldBatterRuns);
                    
                    // Force refresh current striker reference if it matches this batter
                    if (state.striker && state.striker.id === batterId) {
                        state.striker = batter;
                    }
                }
            }

            // --- FIX: AUTO-ROTATE STRIKE ON EDIT ---
            // If the odd/even nature changed, we must swap the CURRENT strikers to realign 
            // with the sequence of events.
            const oldIsOdd = (oldRuns % 2 !== 0);
            const newIsOdd = (newRuns % 2 !== 0);
            if (oldIsOdd !== newIsOdd) {
                swapStrikers();
            }

            // 4. Update the Ball Object
            ball.runs = newRuns;
            ball.event = newEvent;

            // 5. Clear edit mode context
            editingBallIndex = null;

            // Refresh UI and Re-render Modal list to close the pad
            updateUI();
            renderOverEditList();
        }

        function cancelPlayerSelection() {
            window.correctionMode = false;
            pendingSelection = null;
            closeModal('player-modal');
        }

        function updateUI() {
            // --- STATE RESYNC ---
            // Force re-fetch the striker/nonStriker objects from the central team stats
            // to ensure UI displays the latest edits immediately.
            const btStats = state[state.battingTeam].playerStats;
            if (state.striker && btStats[state.striker.id]) {
                state.striker = btStats[state.striker.id];
            }
            if (state.nonStriker && btStats[state.nonStriker.id]) {
                state.nonStriker = btStats[state.nonStriker.id];
            }

            syncToLiveDB(); 
            updateScoreboard(); 
            
            // --- BATTING TABLE ---
            const batTable = document.getElementById('batting-table');
            batTable.innerHTML = '';
            
            const createRow = (p, isStriker) => {
                const sr = p.balls > 0 ? ((p.runs / p.balls) * 100).toFixed(2) : '0.00';
                const roleArg = isStriker ? 'striker' : 'nonStriker';
                
                // NEW: Floating Swap Button on the bottom border of the Striker's row
                const swapBtn = isStriker ? `
                    <button onclick="manualSwap()" class="absolute -bottom-2.5 left-10 z-10 bg-white border border-gray-200 text-blue-600 rounded-full w-5 h-5 flex items-center justify-center shadow-sm hover:scale-110 transition-transform active:scale-95 group" title="Swap Ends">
                        <svg class="w-3 h-3 group-hover:rotate-180 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path></svg>
                    </button>
                ` : '';
                
                return `
                <tr class="border-t ${isStriker ? 'bg-blue-50' : ''}">
                    <td class="p-2 font-bold text-gray-800 relative">
                        <div class="flex items-center justify-between w-full">
                            <span>${p.name} ${isStriker ? '<span class="text-red-500">*</span>' : ''}</span>
                            <button onclick="editActivePlayer('${roleArg}')" class="text-gray-400 hover:text-blue-600 px-2 text-lg">‚úé</button>
                        </div>
                        ${swapBtn}
                    </td>
                    <td class="text-center p-2 font-bold ${p.runs < 0 ? 'text-red-600' : ''}">${p.runs}</td>
                    <td class="text-center p-2 text-gray-600">${p.balls}</td>
                    <td class="text-center p-2 text-gray-600">${p.fours || 0}</td>
                    <td class="text-center p-2 text-gray-600">${p.sixes || 0}</td>
                    <td class="text-right p-2 text-gray-500 text-xs">${sr}</td>
                </tr>`;
            };
            
            if(state.striker) batTable.innerHTML += createRow(state.striker, true);
            if(state.nonStriker) batTable.innerHTML += createRow(state.nonStriker, false);

            // --- BOWLING TABLE (ROBUST FIX) ---
            const bowlingTable = document.getElementById('bowling-table');
            bowlingTable.innerHTML = ''; 

            // 1. Only show the CURRENT Active Bowler (Ignore history)
            let bowlersToShow = [];
            if (state.bowler) {
                bowlersToShow.push(state.bowler);
            }

            // 3. Render the list
            bowlersToShow.forEach(p => {
                const isActive = (state.bowler && p.id === state.bowler.id);
                
                // Safe access with defaults to prevent NaNs
                const bb = p.ballsBowled || 0;
                const rc = p.runsConceded || 0;
                const wk = p.wickets || 0;

                // DYNAMIC OVERS AND ECONOMY
                const bpo = state.ballsPerOver || 6;
                const overs = Math.floor(bb / bpo) + '.' + (bb % bpo);
                const econ = bb > 0 ? (rc / (bb/bpo)).toFixed(2) : '0.00';

                // Generate Balls Chips ONLY for Active Bowler
                let ballsHTML = '';
                if (isActive) {
                    const chips = state.currentOver.map(b => {
                        let c = 'ball-0';
                        let fontSize = 'text-[9px]'; 
                        let extraClass = '';
                        let displayEvent = b.event; 

                        const isComplexRunOut = (b.event.includes('NB') || b.event.includes('WD') || b.event.includes('LB')) && b.event.includes('W');

                        if (isComplexRunOut) {
                            c = 'ball-w'; 
                            fontSize = 'text-[5px] leading-tight font-black tracking-tighter';
                            extraClass = 'ball-square'; 
                            displayEvent = b.event.replace('W', '<span class="text-yellow-300">W</span>');
                        }
                        else if(b.runs === 4) c = 'ball-4';
                        else if(b.runs === 6) c = 'ball-6';
                        else if(b.event.includes('W') && !b.event.includes('WD')) c = 'ball-w';
                        else if(b.event.includes('WD') || b.event.includes('NB')) {
                            c = 'ball-wd';
                            if (b.event.length > 2) fontSize = 'text-[6px] leading-tight';
                        }
                        
                        return `<span class="ball-chip ${c} ${fontSize} ${extraClass}">${displayEvent}</span>`;
                    }).join('');
                    
                    ballsHTML = `<div class="mt-0.5 flex items-center overflow-x-auto gap-0.5 min-h-[1.4rem] w-full no-scrollbar">${chips}</div>`;
                }

                const editBtn = isActive 
                    ? `<button onclick="editActivePlayer('bowler')" class="text-gray-400 hover:text-blue-600 ml-2">‚úé</button>` 
                    : '';

                const rowClass = isActive ? "bg-blue-50/50" : "";

                // ALIGNMENT FIX: Used p-2 and removed small font sizes to match Batting Table
                bowlingTable.innerHTML += `
                <tr class="border-t ${rowClass}">
                    <td class="p-2 align-middle">
                        <div class="font-bold text-gray-800 text-xs leading-tight flex items-center">
                            ${p.name} ${isActive ? '<span class="text-blue-500 text-[9px] ml-1">‚óè</span>' : ''}
                            ${editBtn}
                        </div>
                        ${ballsHTML}
                    </td>
                    <td class="text-center p-2 font-medium text-gray-700 align-middle">${overs}</td>
                    <td class="text-center p-2 text-gray-400 align-middle">-</td>
                    <td class="text-center p-2 font-medium text-gray-800 align-middle">${rc}</td>
                    <td class="text-center p-2 font-bold text-red-600 align-middle">${wk}</td>
                    <td class="text-right p-2 text-gray-500 text-xs align-middle">${econ}</td>
                </tr>`;
            });
        }
        // ==========================================
        // RESUME & SYNC LOGIC (The "Google Docs" Mode)
        // ==========================================
// --- MATCH END & REMATCH LOGIC ---

        function handleMatchEndAction(action) {
            if (action === 'TOURNAMENT_RETURN') {
                // 1. Ensure Stats are Saved
                if (state.matchType === 'TOURNAMENT') {
                    updateTournamentStatsAfterMatch(); //
                }

                // 2. Hide Modal
                document.getElementById('match-summary-modal').classList.add('hidden');
                
                // 3. Switch Screens Correctly (CRITICAL FIX)
                // This hides #app and shows #setup-screen wrapper
                showScreen('setup-screen');

                // 4. Load the Dashboard content inside the setup screen
                loadTournamentDashboard();

            } else if (action === 'NEW') {
                CustomDialog.show({
                    type: 'confirm',
                    title: "Start New Match?",
                    message: "Are you sure? All current match data will be lost permanently.",
                    theme: "red",
                    icon: "üóëÔ∏è",
                    confirmText: "Start Fresh",
                    onConfirm: () => location.reload()
                });

            } else if (action === 'END') {
                CustomDialog.show({
                    type: 'confirm',
                    title: "End Session?",
                    message: "This will end the current match session and return to the main screen.",
                    theme: "blue",
                    icon: "üèÅ",
                    confirmText: "End Session",
                    onConfirm: () => location.reload()
                });

            } else if (action === 'REMATCH') {
                prepareRematch();
            }
        }

        function prepareRematch() {
            // 1. Calculate Series Stats
            if (!state.seriesStats) {
                state.seriesStats = { active: true, t1Wins: 0, t2Wins: 0, lastWinner: null, lastMargin: '' };
            }
            
            // Determine winner of the match just finished
            const t1 = state.team1;
            const t2 = state.team2;
            let winnerName = "Draw";
            let margin = "";

            if (t1.score > t2.score) {
                state.seriesStats.t1Wins++;
                winnerName = t1.name;
                margin = `${t1.score - t2.score} Runs`;
            } else if (t2.score > t1.score) {
                state.seriesStats.t2Wins++;
                winnerName = t2.name;
                const wktsLeft = (state.playersPerSide - 1) - (t2.wickets || 0);
                margin = `${wktsLeft > 0 ? wktsLeft : 1} Wickets`;
            }

            state.seriesStats.lastWinner = winnerName;
            state.seriesStats.lastMargin = margin;
            state.seriesStats.active = true;

            // 2. Preserve Essential Configuration & Squads
            const preserveConfig = {
                venue: state.venue,
                totalOvers: state.totalOvers,
                playersPerSide: state.playersPerSide,
                ballsPerOver: state.ballsPerOver,
                team1: JSON.parse(JSON.stringify(state.team1)), // Deep copy
                team2: JSON.parse(JSON.stringify(state.team2)), // Deep copy
                rules: state.rules,
                seriesStats: state.seriesStats,
                broadcastId: broadcastId // KEEP BROADCAST ID
            };

            // 3. Reset State for New Match
            resetStateForRematch(preserveConfig);

            // 4. Update Broadcast to "Waiting for Rematch"
            if (broadcastId) {
                db.collection("live_matches").doc(broadcastId).set({
                    matchStatus: "SETUP",
                    matchType: "REMATCH",
                    resultMain: "REMATCH STARTING...",
                    resultSub: "Waiting for toss"
                }, { merge: true });
            }

            // 5. Navigate to UI
            closeModal('match-summary-modal');
            document.getElementById('setup-title').textContent = "Rematch Configuration";
            
            // Pre-fill Step 1 Inputs
            ui.venueInput.value = preserveConfig.venue;
            ui.totalOversInput.value = preserveConfig.totalOvers;
            ui.playersPerSideInput.value = preserveConfig.playersPerSide;
            document.getElementById('balls-per-over').value = preserveConfig.ballsPerOver;
            document.getElementById('rule-wicket').value = preserveConfig.rules.wicketRuns;
            
            // Pre-fill Teams
            ui.team1NameInput.value = preserveConfig.team1.name;
            ui.team2NameInput.value = preserveConfig.team2.name;
            
            // Re-render Logos in Setup
            if(preserveConfig.team1.logo) document.getElementById('team1-logo-preview').src = preserveConfig.team1.logo;
            if(preserveConfig.team2.logo) document.getElementById('team2-logo-preview').src = preserveConfig.team2.logo;

            // Jump to Setup
            showScreen('setup-screen');
            goToStep(1);
        }

        function resetStateForRematch(config) {
            // Reset to clean state
            state = {
                rules: config.rules,
                team1: config.team1,
                team2: config.team2,
                battingTeam: 'team1', bowlingTeam: 'team2', // Will be reset by Toss
                striker: null, nonStriker: null, bowler: null,
                id: null, innings: 1, target: 0, 
                totalOvers: config.totalOvers, 
                playersPerSide: config.playersPerSide, 
                ballsPerOver: config.ballsPerOver,
                currentOver: [], history: [], timeline: [],
                venue: config.venue,
                seriesStats: config.seriesStats
            };
            
            // Clean player stats but keep the squad list
            ['team1', 'team2'].forEach(key => {
                state[key].playerStats = {}; 
                // We KEEP state[key].playing array from previous match to auto-check boxes
                state[key].overs = 0; state[key].balls = 0; state[key].score = 0; state[key].wickets = 0;
            });

            // Restore Global Broadcast ID
            broadcastId = config.broadcastId;
            document.getElementById('match-code-box').textContent = broadcastId;
            
            // Reset UI Elements
            document.getElementById('batting-table').innerHTML = '';
            document.getElementById('bowling-table').innerHTML = '';
            document.getElementById('team-scores-container').innerHTML = '';
            
            // Re-enable Start Button logic
            tossWinner = null; tossDecision = null;
            document.querySelectorAll('.toss-card-btn').forEach(b => b.classList.remove('selected'));
            document.querySelectorAll('.decision-btn').forEach(b => b.classList.remove('selected'));
            checkStartReady();
        }
        
        // --- MID-OVER BOWLER REPLACEMENT LOGIC ---

        function triggerMidOverChange(reason) {
            closeModal('mid-over-modal');
            
            if (!state.bowler) {
                showCustomAlert("Error", "No active bowler to replace!", "red");
                return;
            }

            // Using HTML in message for beautiful formatting
            const ballsLeft = state.ballsPerOver - (state[state.battingTeam].balls || 0);
            const confirmMsg = `
                Replace <span class="text-gray-900 font-black">${state.bowler.name}</span> mid-over?
                <br><br>
                <span class="text-xs font-bold uppercase tracking-wider text-gray-400">Reason</span><br>
                <span class="font-bold text-red-600">${reason}</span>
                <br><br>
                <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs font-bold">balls remaining: ${ballsLeft}</span>
            `;
            
            CustomDialog.show({
                type: 'confirm',
                title: "Change Bowler?",
                message: confirmMsg,
                icon: "‚ö†Ô∏è",
                theme: "red",
                confirmText: "Yes, Replace",
                onConfirm: () => {
                    addToHistory();

                    console.log(`Bowler ${state.bowler.name} removed. Reason: ${reason}`);

                    // --- NEW: UPDATE BOWLER STATUS ---
                    if (reason === 'DISQUALIFIED') {
                        state.bowler.status = 'DISQUALIFIED';
                        if (state[state.bowlingTeam].playerStats[state.bowler.id]) {
                            state[state.bowlingTeam].playerStats[state.bowler.id].status = 'DISQUALIFIED';
                        }
                    } else if (reason === 'INJURY') {
                        state.bowler.status = 'INJURED';
                        if (state[state.bowlingTeam].playerStats[state.bowler.id]) {
                            state[state.bowlingTeam].playerStats[state.bowler.id].status = 'INJURED';
                        }
                    }

                    state.timeline.push({
                        event: "BOWLER_CHANGE",
                        subType: reason,
                        over: state[state.battingTeam].overs,
                        ball: state[state.battingTeam].balls,
                        prevBowler: state.bowler.name
                    });

                    selectPlayer('bowler', () => {
                        updateUI();
                        showCustomAlert("New Bowler", `Selected: <b>${state.bowler.name}</b><br>Please bowl the remaining ${ballsLeft} balls.`, "green");
                    });
                }
            });
        }
        
        // Update handleAddExtra to look for mid-over-modal instead of extras-modal
        function handleAddExtra(type, runs) {
            if (editingBallIndex !== null) {
                // EDIT MODE
                closeModal('wide-modal'); closeModal('noball-modal'); closeModal('mid-over-modal'); // Updated ID
                let label = type.toUpperCase();
                if (type === 'wd' || type === 'nb') {
                    if (runs > 1) { label = `${type.toUpperCase()}+${runs - 1}`; }
                } else if (type === 'pen' && runs < 0) {
                    label = `${runs}`;
                } else if (type === 'ext' && runs > 0) {
                    label = `+${runs}`;
                }
                applyBallCorrection(editingBallIndex, runs, label);
                editingBallIndex = null;
            } else {
                // NORMAL MODE
                addExtra(type, runs);
            }
        }
        
        // Also update addExtra to close the correct modal
        function addExtra(type, runs) {
            addToHistory();
            closeModal('wide-modal'); closeModal('noball-modal'); closeModal('mid-over-modal'); // Updated ID
            const bt = state[state.battingTeam];
            const bwl = state.bowler; 
            
            bt.score += runs;
            if(bwl) { bwl.runsConceded += runs; }
            
            let label = type.toUpperCase();
            if (type === 'wd' || type === 'nb') {
                if (runs > 1) { label = `${type.toUpperCase()}+${runs - 1}`; }
            } else if (type === 'pen' && runs < 0) {
                label = `${runs}`;
            } else if (type === 'ext' && runs > 0) {
                label = `+${runs}`;
            }

            // --- FIX: Check for Win in Innings 2 OR Super Over Chase (Innings 4) ---
            const isChaseInning = (state.innings === 2 && state.rules.wicketRuns === 0) || state.innings === 4;

            if (isChaseInning) {
                if (bt.score >= state.target) {
                    processBall(runs, label, false); 
                    updateUI(); 
                    setTimeout(() => {
                        alert("TARGET CHASED! " + bt.name + " WINS!");
                        endInnings();
                    }, 100); 
                    return;
                }
            }

            processBall(runs, label, false); 
            updateUI();
        }

        // Also update setupExtraRunOut to close the correct modal
        function setupExtraRunOut(type) {
            // 1. Close the extra modal
            if(type === 'wd') closeModal('wide-modal');
            if(type === 'nb') closeModal('noball-modal');
            if(type === 'ext') closeModal('mid-over-modal'); // Updated ID

            // 2. Store the type (Wide, NB, or Leg Bye) and Open the Runs Modal
            tempExtraType = type;
            openModal('extra-runs-modal');
        }
        
        function resumeMatch() {
            const code = document.getElementById('resume-code').value.trim();
            if (!code) { alert("Please enter a valid Broadcast Code."); return; }

            // 1. Fetch Match Data
            db.collection("live_matches").doc(code).get().then(doc => {
                if (!doc.exists) { alert("Match not found! Check the code."); return; }
                
                const data = doc.data();
                
                // 2. Security Check
                const pin = prompt("Enter Match PIN to Score:");
                if (pin !== "2626" && pin !== data.adminPin) { 
                    alert("Incorrect PIN! Access Denied."); return; 
                }

                // 3. Load State
                broadcastId = code;
                mapRemoteDataToLocalState(data);
                
                // 4. Update UI
                updateMatchHeader();
                updateScoreboard();
                document.getElementById('match-code-box').textContent = broadcastId;
                document.getElementById('broadcast-display').classList.remove('hidden');
                
                // 5. Activate Sync Listener
                activateScorerListener(code);
                
                alert("Match Loaded! You are now synced.");
                showScreen('app');

            }).catch(err => alert("Error loading match: " + err.message));
        }

        function activateScorerListener(matchId) {
            console.log("Listening for external updates...");
            db.collection("live_matches").doc(matchId).onSnapshot(doc => {
                const remote = doc.data();
                if (!remote) return;

                // Check if update is from another device (simple timestamp check)
                // We assume if 'lastUpdatedBy' is very recent and NOT our push, we sync.
                // For simplicity in this version, we will just sync if the scores differ
                
                const localScore = state[state.battingTeam].score;
                const remoteScore = parseInt(remote.scorecard.innings1.score.split('/')[0]); // simplified check
                
                // If local state lags behind or differs, we pull (Simplistic Sync)
                // In a perfect world we check IDs, but here we just re-map if triggered externally
                // We avoid loops by checking if we just pushed.
                
                // For now, let's just log it. To make it "Google Docs" style requires
                // ignoring our own writes. 
                // Since this is a simple implementation: 
                // If the remote Timeline is longer than ours, we take it.
                
                if (remote.timeline && remote.timeline.length > (state.timeline?.length || 0)) {
                    console.log("New data detected! Syncing...");
                    mapRemoteDataToLocalState(remote);
                    updateScoreboard();
                    // Optional: Toast "Score Updated by Admin B"
                }
            });
        }

        function mapRemoteDataToLocalState(data) {
            // 1. Restore Basic Config
            state.venue = data.venue;
            state.totalOvers = 16; 
            state.playersPerSide = 8;
            
            // 2. Restore Teams
            state.team1.name = data.t1;
            state.team2.name = data.t2;
            state.team1.logo = data.t1Logo;
            state.team2.logo = data.t2Logo;

            // 3. Restore Game State (HANDOVER LOGIC)
            if (data.currentInnings) state.innings = data.currentInnings;
            if (data.target) state.target = data.target;
            
            // Set Active Batting Team based on saved key, or fallback to name check
            if (data.activeBattingTeam) {
                state.battingTeam = data.activeBattingTeam;
                state.bowlingTeam = (data.activeBattingTeam === 'team1') ? 'team2' : 'team1';
            } else {
                // Fallback for old matches
                const inn1Name = data.scorecard.innings1.name;
                if (inn1Name === state.team1.name) {
                    state.battingTeam = 'team1'; state.bowlingTeam = 'team2';
                } else {
                    state.battingTeam = 'team2'; state.bowlingTeam = 'team1';
                }
            }

            // 4. Restore Scores
            const i1Parts = data.scorecard.innings1.score.split('/');
            const i2Parts = data.scorecard.innings2.score.split('/');
            
            state.team1.score = parseInt(i1Parts[0]); state.team1.wickets = parseInt(i1Parts[1]);
            state.team2.score = parseInt(i2Parts[0]); state.team2.wickets = parseInt(i2Parts[1]);
            
            // 5. Restore Timeline & Current Over
            state.timeline = data.timeline || [];
            state.currentOver = []; 
            
            if (state.timeline.length > 0) {
                const lastBall = state.timeline[state.timeline.length - 1];
                const currentOverNum = lastBall.over;
                state.currentOver = state.timeline.filter(b => b.over === currentOverNum);
            }

            // 6. Restore Active Players
            // Note: We create dummy objects with IDs to keep UI working until new scorer selects players
            if (data.striker && data.striker.name) state.striker = { id: 'p_res_1', name: data.striker.name, runs: data.striker.runs, balls: data.striker.balls };
            if (data.nonStriker && data.nonStriker.name) state.nonStriker = { id: 'p_res_2', name: data.nonStriker.name, runs: data.nonStriker.runs, balls: data.nonStriker.balls };
            if (data.bowler && data.bowler.name) state.bowler = { id: 'p_res_3', name: data.bowler.name, runsConceded: data.bowler.runs, ballsBowled: data.bowler.balls, wickets: data.bowler.wkts };
        }
        /* =========================================
   TOURNAMENT MODE LOGIC ENGINE
   ========================================= */


/* =========================================
   PROFESSIONAL TOURNAMENT ENGINE
   ========================================= */

// 1. Define Round Constants (Scalable)
const TOURNAMENT_ROUNDS = [
    "League Match", "Super League", "Super 8", "Super 6", "Super 4",
    "Qualifier 1", "Eliminator", "Qualifier 2",
    "Pre-Quarter Final", "Quarter Final", "Semi Final", "Final",
    "Gold Final", "Silver Final", "3rd Place Playoff",
    "Warm Up", "Test Match 1", "Test Match 2"
];

let tournamentState = {
    active: false,
    id: null,
    data: null,
    inviteCode: null
};

// --- NEW TOURNAMENT SETUP LOGIC ---

// --- TOURNAMENT SETUP FUNCTIONS ---

// Global variable for pre-generated ID
let pendingTourneyId = null;

function nextTourneyStep() {
    const p1 = document.getElementById('tourney-page-1');
    const p2 = document.getElementById('tourney-page-2');
    const p3 = document.getElementById('tourney-page-3');
    const p4 = document.getElementById('tourney-page-4');

    if (!p1.classList.contains('hidden')) {
        // Step 1: Validation
        const name = document.getElementById('tourney-name').value;
        if (!name) { 
            showCustomAlert("Missing Info", "Please enter a <b>Tournament Name</b>.", "red"); 
            return; 
        }
        // Move 1 -> 2
        p1.classList.add('hidden');
        p2.classList.remove('hidden');
        window.scrollTo(0,0);
    } 
    else if (!p2.classList.contains('hidden')) {
        // Step 2: Move 2 -> 3
        p2.classList.add('hidden');
        p3.classList.remove('hidden');
        window.scrollTo(0,0);
    } 
    else if (!p3.classList.contains('hidden')) {
        // Step 3: Validation
        const tCount = document.getElementById('tourney-team-count').value;
        if(!tCount) {
             showCustomAlert("Missing Info", "Please select the number of teams.", "red");
             return;
        }
        
        // Check for duplicates
        const selects = document.querySelectorAll('.tourney-team-select');
        const selectedValues = [];
        let hasDupes = false;
        selects.forEach(s => {
            if(s.value) {
                if(selectedValues.includes(s.value)) hasDupes = true;
                selectedValues.push(s.value);
            }
        });

        if(selectedValues.length < 2) {
             showCustomAlert("Error", "Please select at least 2 teams.", "red");
             return;
        }
        if(hasDupes) {
             showCustomAlert("Error", "Duplicate teams selected.", "red");
             return;
        }

        // Move 3 -> 4
        p3.classList.add('hidden');
        p4.classList.remove('hidden');
        window.scrollTo(0,0);
        
        // Initialize Schedule
        updateScheduleDropdowns();
        
        // --- NEW: GENERATE PUBLIC ID ---
        if (!pendingTourneyId) {
            const randomPart = Math.random().toString(36).substr(2, 6).toUpperCase();
            pendingTourneyId = `TX_${randomPart}`;
        }
        
        // Update the UI Input
        const viewerUrl = `${window.location.origin}/tournament.html?id=${pendingTourneyId}`;
        document.getElementById('public-tourney-link').value = viewerUrl;
    }
}

// Helpers for the Share Link
function copyTourneyLink() {
    const el = document.getElementById('public-tourney-link');
    el.select();
    document.execCommand('copy');
    showCustomAlert("Link Copied", "Share this URL with players and fans.", "green");
}

function openTourneyLink() {
    const url = document.getElementById('public-tourney-link').value;
    if(url && !url.includes('Generating')) window.open(url, '_blank');
}

function setBallType(type, card) {
    document.getElementById('tourney-ball-type').value = type;
    
    document.querySelectorAll('.ball-card').forEach(c => {
        c.classList.remove('selected', 'bg-gradient-to-br', 'from-emerald-50', 'to-teal-50', 'border-emerald-500');
        c.classList.add('bg-white', 'border-gray-100');
        c.querySelector('.check-icon').classList.add('hidden');
        c.querySelector('.check-icon').classList.remove('flex');
    });

    card.classList.remove('bg-white', 'border-gray-100');
    card.classList.add('selected', 'bg-gradient-to-br', 'from-emerald-50', 'to-teal-50', 'border-emerald-500');
    card.querySelector('.check-icon').classList.remove('hidden');
    card.querySelector('.check-icon').classList.add('flex');
}

function renderGroundInputs() {
    const count = parseInt(document.getElementById('tourney-ground-count').value);
    const container = document.getElementById('dynamic-grounds-container');
    container.innerHTML = '';
    
    for(let i=0; i<count; i++) {
        const wrapper = document.createElement('div');
        wrapper.className = "bg-gray-50 p-3 rounded-xl border border-gray-100 animate-pop";

        const nameInput = document.createElement('input');
        nameInput.type = 'text';
        nameInput.id = `ground-${i+1}`;
        nameInput.placeholder = `Ground ${i+1} Name`;
        nameInput.className = "ground-input mobile-input bg-white mb-2";
        
        const addrInput = document.createElement('input');
        addrInput.type = 'text';
        addrInput.id = `ground-addr-${i+1}`;
        addrInput.placeholder = "Address / Google Location";
        addrInput.className = "ground-addr-input w-full p-3 bg-white border border-gray-200 rounded-xl text-xs font-medium outline-none text-gray-600 focus:border-blue-400 transition-colors";

        wrapper.appendChild(nameInput);
        wrapper.appendChild(addrInput);
        container.appendChild(wrapper);
    }
}

function renderTournamentSlots() {
    const totalTeams = parseInt(document.getElementById('tourney-team-count').value);
    const selectedCountry = document.getElementById('tourney-country').value;
    const container = document.getElementById('tournament-slots-container');
    
    // Don't render if selection is invalid/empty
    if (!totalTeams || isNaN(totalTeams)) {
        container.innerHTML = '';
        return;
    }

    container.innerHTML = '';
    
    // 1. Filter Teams by Country
    let filteredTeams = savedTeamsData;
    if (selectedCountry) {
        filteredTeams = savedTeamsData.filter(t => t.country === selectedCountry);
    }

    // 2. Build Options
    let optionsHTML = '<option value="">-- Select Team --</option>';
    filteredTeams.forEach(t => {
        optionsHTML += `<option value="${t.name}">${t.name}</option>`;
    });

    // 3. Render Cards with Logo Logic
    for (let i = 0; i < totalTeams; i++) {
        const div = document.createElement('div');
        div.className = "mobile-card flex items-center gap-3 p-4";
        div.innerHTML = `
            <div class="w-8 h-8 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center font-black text-xs border border-blue-100 shadow-sm">${i+1}</div>
            
            <img class="team-slot-logo w-10 h-10 rounded-full object-cover border border-gray-200 hidden bg-gray-100">
            
            <div class="flex-grow">
                <label class="block text-[9px] font-bold text-gray-400 uppercase mb-1">Select Team</label>
                <select onchange="updateSlotLogo(this)" class="tourney-team-select w-full bg-transparent text-sm font-bold text-gray-800 outline-none uppercase cursor-pointer">
                    ${optionsHTML}
                </select>
            </div>
            <div class="text-gray-300 text-[10px]">‚ñº</div>
        `;
        container.appendChild(div);
    }
}

// Helper to update the logo when a user picks a team
function updateSlotLogo(selectEl) {
    const card = selectEl.closest('.mobile-card');
    const imgEl = card.querySelector('.team-slot-logo');
    const teamName = selectEl.value;

    if (!teamName) {
        imgEl.classList.add('hidden');
        return;
    }

    const team = savedTeamsData.find(t => t.name === teamName);
    if (team && team.logo) {
        imgEl.src = team.logo;
        imgEl.classList.remove('hidden');
    } else {
        // Fallback if no logo
        imgEl.src = `https://placehold.co/40x40/gray/white?text=${teamName.substring(0,2)}`;
        imgEl.classList.remove('hidden');
    }
}

function shortenTeamName(name) {
    if(!name || name === "TBD") return name;
    return name
        .replace(/Cricket Club/gi, 'CC')
        .replace(/Cricket/gi, 'C.')
        .replace(/Sports/gi, 'Sp.')
        .replace(/United/gi, 'Utd')
        .substring(0, 20); // Truncate if still too long
}

// --- NEW SCHEDULING LOGIC ---

function goToTournamentSchedule() {
    // 1. Basic Validation
    const name = document.getElementById('tourney-name').value;
    if(!name) { showCustomAlert("Error", "Please enter Tournament Name", "red"); return; }

    // 2. Validate Teams
    let selectedCount = 0;
    const slots = document.querySelectorAll('.tourney-team-select');
    let hasDuplicate = false;
    let usedTeams = new Set();
    
    slots.forEach(s => {
        if(s.value) {
            selectedCount++;
            if(usedTeams.has(s.value)) hasDuplicate = true;
            usedTeams.add(s.value);
        }
    });

    if(selectedCount < 2) { showCustomAlert("Error", "Select at least 2 teams.", "red"); return; }
    if(hasDuplicate) { showCustomAlert("Error", "Duplicate teams selected.", "red"); return; }

    // 3. Switch Screens
    document.getElementById('tournament-setup').classList.add('hidden');
    document.getElementById('tournament-setup').classList.remove('active');
    
    const schedStep = document.getElementById('tournament-schedule-step');
    schedStep.classList.remove('hidden');
    setTimeout(() => schedStep.classList.add('active'), 10);

    // 4. Initialize Table
    const tbody = document.getElementById('schedule-rows');
    // Enable Drag and Drop
    new Sortable(tbody, {
        animation: 150,
        ghostClass: 'bg-blue-50',
        handle: 'tr' // Drag by entire row
    });

    updateScheduleDropdowns(); 
}

function backToTournamentSetup() {
    document.getElementById('tournament-schedule-step').classList.add('hidden');
    document.getElementById('tournament-schedule-step').classList.remove('active');
    
    const configStep = document.getElementById('tournament-setup');
    configStep.classList.remove('hidden');
    setTimeout(() => configStep.classList.add('active'), 10);
}

function autoGenerateFixtures() {
    // 1. Get Teams
    const teams = [];
    document.querySelectorAll('.tourney-team-select').forEach(sel => {
        if(sel.value) teams.push(sel.value);
    });

    if (teams.length < 2) {
        showCustomAlert("Error", "Need at least 2 teams to generate schedule.", "red");
        return;
    }

    // 2. Ask User for Balance
    const suggested = teams.length % 2 === 0 ? teams.length - 1 : teams.length;
    const input = prompt(`How many matches should each team play?\n(Enter ${suggested} for a full Round Robin)`, suggested);
    if (!input || isNaN(input)) return;
    const roundsToPlay = parseInt(input);

    if(!confirm(`This will generate ${roundsToPlay} rounds of fixtures. Existing schedule will be cleared. Continue?`)) return;

    // 3. Clear Table
    document.getElementById('schedule-rows').innerHTML = '';

    // 4. Fair Scheduling Algorithm (Circle Method)
    // Ensures equal breaks and correct distribution
    let pool = [...teams];
    if (pool.length % 2 !== 0) pool.push(null); // Add dummy for Bye

    const totalTeams = pool.length;
    const half = totalTeams / 2;

    for (let r = 0; r < roundsToPlay; r++) {
        // Generate pairs for this round
        for (let i = 0; i < half; i++) {
            const t1 = pool[i];
            const t2 = pool[totalTeams - 1 - i];

            // If neither is a dummy (Bye), schedule the match
            if (t1 && t2) {
                addScheduleRow('League Match', { t1: t1, t2: t2 });
            }
        }

        // Rotate the pool for next round (Fix 1st, rotate rest)
        // [0, 1, 2, 3] becomes [0, 3, 1, 2]
        const fixed = pool[0];
        const rotated = pool.slice(1);
        const last = rotated.pop();
        rotated.unshift(last);
        pool = [fixed, ...rotated];
    }

    // 5. Knockout Stages Logic
    if (teams.length >= 4) {
        addScheduleRow('Semi Final 1');
        addScheduleRow('Semi Final 2');
    }
    addScheduleRow('Final');
}

function addScheduleRow(defaultType = 'League Match', preFill = null) {
    const container = document.getElementById('schedule-rows');

    if (defaultType === 'Final') {
        const existingFinal = Array.from(container.querySelectorAll('.sch-type')).find(sel => sel.value === 'Final');
        if (existingFinal) {
            showCustomAlert("Info", "A Final match already exists.", "blue");
            return;
        }
    }

    const cardId = `sched-card-${Date.now()}`;
    const matchNo = container.children.length + 1;
    
    const card = document.createElement('div');
    card.id = cardId;
    card.className = "sch-card mobile-card p-0 overflow-hidden shadow-sm"; 
    
    card.innerHTML = `
        <div class="bg-gray-50 border-b border-gray-100 p-3 flex justify-between items-center handle cursor-grab active:cursor-grabbing">
            <div class="flex items-center gap-2">
                <span class="text-xs font-black text-gray-400 select-none">#${matchNo}</span>
                <select class="sch-type bg-transparent text-[10px] font-bold text-blue-600 uppercase outline-none">
                    ${TOURNAMENT_ROUNDS.map(r => `<option value="${r}" ${r===defaultType?'selected':''}>${r}</option>`).join('')}
                </select>
            </div>
            <button onclick="this.closest('.sch-card').remove()" class="text-gray-300 hover:text-red-500 font-bold p-1">‚úï</button>
        </div>
        
        <div class="p-4">
            <div class="flex items-center gap-3 mb-4">
                <div class="flex-1">
                    <label class="text-[9px] font-bold text-gray-400 uppercase block mb-1">Team A</label>
                    <div class="flex items-center gap-2">
                        <img class="sch-img-t1 w-8 h-8 rounded-full border border-gray-100 object-cover hidden bg-gray-100">
                        <select onchange="handleScheduleSelection(this)" class="sch-t1 w-full bg-gray-50 p-2 rounded-lg text-xs font-bold text-gray-800 outline-none border border-gray-200 focus:border-blue-500 transition-colors uppercase"></select>
                    </div>
                </div>
                
                <span class="text-xs font-black text-gray-300 mt-4">VS</span>
                
                <div class="flex-1">
                    <label class="text-[9px] font-bold text-gray-400 uppercase block mb-1">Team B</label>
                    <div class="flex items-center gap-2">
                        <img class="sch-img-t2 w-8 h-8 rounded-full border border-gray-100 object-cover hidden bg-gray-100">
                        <select onchange="handleScheduleSelection(this)" class="sch-t2 w-full bg-gray-50 p-2 rounded-lg text-xs font-bold text-gray-800 outline-none border border-gray-200 focus:border-red-500 transition-colors uppercase"></select>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="text-[9px] font-bold text-gray-400 uppercase block mb-1">Ground</label>
                    <select class="sch-ground w-full bg-white p-2 rounded-lg text-xs font-bold text-gray-600 outline-none border border-gray-200"></select>
                </div>
                <div>
                    <label class="text-[9px] font-bold text-gray-400 uppercase block mb-1">Time</label>
                    <input type="datetime-local" class="sch-time w-full bg-white p-2 rounded-lg text-xs font-bold text-gray-600 outline-none border border-gray-200">
                </div>
            </div>
        </div>
    `;
    container.appendChild(card);

    if(!preFill && defaultType === 'Final') {
        const teams = [];
        document.querySelectorAll('.tourney-team-select').forEach(sel => { if(sel.value) teams.push(sel.value); });
        if(teams.length === 2) { preFill = { t1: teams[0], t2: teams[1] }; }
    }

    populateRowDropdowns(card, preFill);
}

function updateScheduleDropdowns() {
    const cards = document.getElementById('schedule-rows').querySelectorAll('.sch-card');
    if(cards.length === 0) addScheduleRow(); 
    else cards.forEach(card => populateRowDropdowns(card));
}

function populateRowDropdowns(row, preFill = null) {
    // 1. Get Teams from Step 1
    const teams = [];
    document.querySelectorAll('.tourney-team-select').forEach(sel => {
        if(sel.value) teams.push(sel.value);
    });

    // 2. Get Grounds
    const grounds = [];
    document.querySelectorAll('.ground-input').forEach(inp => { if(inp.value) grounds.push(inp.value); });
    if(grounds.length === 0) grounds.push("Main Ground");

    // 3. Populate Options (Shortened Names)
    const tOptions = `<option value="">Select Team...</option><option value="TBD">TBD / Winner</option>` + teams.map(t => `<option value="${t}">${shortenTeamName(t)}</option>`).join('');
    
    const s1 = row.querySelector('.sch-t1');
    const s2 = row.querySelector('.sch-t2');
    
    // Preserve values if re-populating, unless preFill is set
    const v1 = preFill ? preFill.t1 : s1.value; 
    const v2 = preFill ? preFill.t2 : s2.value;
    
    // Reset HTML to new options
    s1.innerHTML = tOptions; 
    s2.innerHTML = tOptions;
    
    if(v1) s1.value = v1;
    if(v2) s2.value = v2;

    // Grounds
    const gSelect = row.querySelector('.sch-ground');
    if(gSelect.innerHTML === "") {
        gSelect.innerHTML = grounds.map(g => `<option value="${g}">${g}</option>`).join('');
    }

    handleScheduleSelection(s1);
}

function handleScheduleSelection(selectElement) {
    const card = selectElement.closest('.sch-card');
    const s1 = card.querySelector('.sch-t1');
    const s2 = card.querySelector('.sch-t2');
    const img1 = card.querySelector('.sch-img-t1');
    const img2 = card.querySelector('.sch-img-t2');
    
    const v1 = s1.value;
    const v2 = s2.value;

    // 1. Prevent Duplicates (Grey out opponent)
    Array.from(s2.options).forEach(opt => opt.disabled = (opt.value !== "" && opt.value !== "TBD" && opt.value === v1));
    Array.from(s1.options).forEach(opt => opt.disabled = (opt.value !== "" && opt.value !== "TBD" && opt.value === v2));

    // 2. Update Logos
    const updateLogo = (name, imgEl) => {
        if (!name || name === "TBD") {
            imgEl.classList.add('hidden');
        } else {
            const team = savedTeamsData.find(t => t.name === name);
            if (team && team.logo) {
                imgEl.src = team.logo;
                imgEl.classList.remove('hidden');
            } else {
                // Show a placeholder or hide if no logo
                imgEl.src = `https://placehold.co/40x40/gray/white?text=${name.substring(0,2)}`;
                imgEl.classList.remove('hidden');
            }
        }
    };

    updateLogo(v1, img1);
    updateLogo(v2, img2);
}

function createProfessionalTournament() {
    const name = document.getElementById('tourney-name').value;
    const startDate = document.getElementById('tourney-start-date').value || new Date().toISOString().split('T')[0];
    const country = document.getElementById('tourney-country') ? document.getElementById('tourney-country').value : "Unknown";

    if(!name) { showCustomAlert("Error", "Tournament Name is required", "red"); return; }

    const cards = document.getElementById('schedule-rows').querySelectorAll('.sch-card');
    const fixtures = [];
    
    // --- USE PRE-GENERATED ID OR FALLBACK ---
    const tourneyId = pendingTourneyId || "T_" + Math.random().toString(36).substr(2, 6).toUpperCase();

    cards.forEach((card, index) => {
        const t1 = card.querySelector('.sch-t1').value;
        const t2 = card.querySelector('.sch-t2').value;
        const type = card.querySelector('.sch-type').value;
        const ground = card.querySelector('.sch-ground').value;
        const time = card.querySelector('.sch-time').value;

        if(t1 && t2) {
            fixtures.push({
                id: `M_${tourneyId}_${Date.now()}_${index}`,
                matchNo: index + 1,
                t1: t1,
                t2: t2,
                stage: type,
                ground: ground,
                time: time.replace("T", " ") || "TBD",
                status: 'UPCOMING',
                result: null,
                statsLog: null
            });
        }
    });

    if(fixtures.length === 0) { showCustomAlert("Error", "Schedule at least one match.", "red"); return; }

    const teamsMap = [];
    const usedNames = new Set();
    document.querySelectorAll('.tourney-team-select').forEach(sel => {
        if(sel.value && !usedNames.has(sel.value)) {
            usedNames.add(sel.value);
            const fullData = savedTeamsData.find(t => t.name === sel.value);
            teamsMap.push({ name: sel.value, fullData: fullData });
        }
    });
    
    if(teamsMap.length < 2) { showCustomAlert("Error", "Need at least 2 teams.", "red"); return; }

    const optimizedTeams = teamsMap.map(t => {
        const full = t.fullData;
        return {
            name: full.name,
            shortName: shortenTeamName(full.name),
            logo: (full.logo && full.logo.length > 50000) ? null : full.logo,
            players: full.players.map(p => ({ id: generateUniqueId(), name: p.name, image: null }))
        };
    });

    // Validated Ball Type ID
    const ballTypeEl = document.getElementById('tourney-ball-type');
    const ballTypeVal = ballTypeEl ? ballTypeEl.value : 'Soft Ball';
    
    // Category
    const categoryEl = document.getElementById('tourney-category');
    const category = categoryEl ? categoryEl.value : "Open";

    const tournamentData = {
        meta: { id: tourneyId, name, country, category, organizer: document.getElementById('organizer-name').value || "Community", startDate, createdAt: Date.now() },
        rules: {
            overs: parseInt(document.getElementById('tourney-overs').value),
            players: parseInt(document.getElementById('tourney-players').value),
            ptsWin: 2, ptsTie: 1,
            ballType: ballTypeVal, // FIXED ID HERE
            matchType: "LIMITED"
        },
        teams: optimizedTeams,
        fixtures: fixtures,
        standings: teamsMap.map(t => ({
            name: t.name, p: 0, w: 0, l: 0, t: 0, pts: 0, nrr: 0, runsFor: 0, oversFor: 0, runsAgainst: 0, oversAgainst: 0
        })),
        matchStatsLog: []
    };

    const btn = document.getElementById('btn-create-tourney');
    const originalText = btn.innerHTML;
    btn.innerHTML = "Creating... ‚è≥";
    btn.disabled = true;
    
    db.collection("tournaments").doc(tourneyId).set(tournamentData)
        .then(() => {
            tournamentState.id = tourneyId;
            tournamentState.data = tournamentData;
            tournamentState.active = true;
            // Clean up old UI steps if they exist
            const schedStep = document.getElementById('tournament-schedule-step');
            if(schedStep) {
                schedStep.classList.add('hidden');
                schedStep.classList.remove('active');
            }
            loadTournamentDashboard();
        })
        .catch(err => {
            console.error(err);
            showCustomAlert("Save Failed", "Could not create tournament. Check connection.", "red");
            btn.innerHTML = originalText;
            btn.disabled = false;
        });
}

function loadTournament() {
    const id = document.getElementById('tournament-load-id').value.trim();
    if (!id) return;
    
    db.collection("tournaments").doc(id).get().then(doc => {
        if (!doc.exists) { alert("Tournament not found"); return; }
        
        tournamentState.id = id;
        tournamentState.data = doc.data();
        tournamentState.active = true;
        
        state.matchType = 'TOURNAMENT'; 
        document.getElementById('mode-selection-screen').classList.add('hidden');
        loadTournamentDashboard();
    });
}

function loadTournamentDashboard() {
    const dash = document.getElementById('tournament-dashboard');
    if (!dash) { console.error("Dashboard Element Missing!"); return; }
    
    document.querySelectorAll('.setup-step').forEach(el => {
        el.classList.add('hidden');
        el.classList.remove('active');
    });

    dash.classList.remove('hidden');
    setTimeout(() => dash.classList.add('active'), 10);

    if (tournamentState.data && tournamentState.data.meta) {
        document.getElementById('dashboard-title').textContent = tournamentState.data.meta.name;
        document.getElementById('dashboard-id').textContent = tournamentState.id;
    }

    renderFixtures();
    renderStandings();
    renderStats();
}

// --- NEW MANUAL FIXTURE LOGIC ---

// --- NEW DRAG & DROP KANBAN LOGIC ---

let editingMatchId = null;

// 1. Quick Create (One Click)
function quickCreateMatch() {
    const matchId = `M_${tournamentState.id}_${Date.now()}`;
    const newFixture = {
        id: matchId,
        t1: "TBD",
        t2: "TBD",
        stage: "League Match", // Default column
        status: 'UPCOMING',
        result: null,
        overs: tournamentState.data.rules.overs || 16
    };

    if (!tournamentState.data.fixtures) tournamentState.data.fixtures = [];
    tournamentState.data.fixtures.push(newFixture);
    
    // Save & Render
    saveTournamentData();
    renderFixtures();
}

// 2. Open Modal for Editing (Populate & Save ID)
function openEditMatchModal(matchId) {
    editingMatchId = matchId;
    const fixture = tournamentState.data.fixtures.find(f => f.id === matchId);
    if(!fixture) return;

    const teams = tournamentState.data.teams;
    const selA = document.getElementById('am-team-a');
    const selB = document.getElementById('am-team-b');
    
    // Populate Dropdowns
    [selA, selB].forEach(sel => {
        sel.innerHTML = '<option value="">Select Team</option>';
        teams.forEach(t => {
            const opt = document.createElement('option');
            opt.value = t.name;
            opt.textContent = t.name;
            sel.appendChild(opt);
        });
    });

    // Fill Data
    selA.value = fixture.t1 !== "TBD" ? fixture.t1 : "";
    selB.value = fixture.t2 !== "TBD" ? fixture.t2 : "";
    document.getElementById('am-stage').value = fixture.stage;
    document.getElementById('am-overs').value = fixture.overs;
    document.getElementById('am-group').value = fixture.group || "";

    openModal('add-match-modal');
}

// 3. Save Match (Handles both Create & Update logic)
function saveManualMatch() {
    const tA = document.getElementById('am-team-a').value;
    const tB = document.getElementById('am-team-b').value;
    const stage = document.getElementById('am-stage').value || "League Match";
    const group = document.getElementById('am-group').value;
    const overs = document.getElementById('am-overs').value;

    if (!tA || !tB || tA === tB) {
        alert("Please select two different teams.");
        return;
    }

    if(editingMatchId) {
        // UPDATE EXISTING
        const f = tournamentState.data.fixtures.find(x => x.id === editingMatchId);
        if(f) {
            f.t1 = tA; f.t2 = tB; f.stage = stage; f.group = group; f.overs = parseInt(overs);
        }
        editingMatchId = null;
    } else {
        // CREATE NEW (Fallback)
        quickCreateMatch(); 
        // Note: quickCreate makes a TBD match, we'd need to edit it immediately, 
        // but since we use Quick Create button now, this block is rarely hit directly.
    }

    saveTournamentData();
    closeModal('add-match-modal');
    renderFixtures();
}

// 4. Delete
function deleteFixture(matchId) {
    if (!confirm("Delete this match card?")) return;
    tournamentState.data.fixtures = tournamentState.data.fixtures.filter(f => f.id !== matchId);
    saveTournamentData();
    renderFixtures();
}

// 5. Open Modal Wrapper for "Add Match" button in modal (legacy support)
function openAddMatchModal() {
    editingMatchId = null; 
    // Clear inputs
    document.getElementById('am-team-a').value = "";
    document.getElementById('am-team-b').value = "";
    document.getElementById('am-stage').value = "";
    openModal('add-match-modal');
}

// 6. MAIN RENDERER (Professional Match Center)
function renderFixtures() {
    const board = document.getElementById('kanban-board');
    if(!board) return;
    board.innerHTML = '';

    const fixtures = tournamentState.data.fixtures || [];
    if(fixtures.length === 0) {
        board.innerHTML = '<div class="text-center text-gray-400 font-bold p-10 flex flex-col items-center gap-2"><span class="text-4xl">üìÖ</span><span>No matches scheduled</span></div>';
        return;
    }

    const grouped = {};
    const order = (typeof TOURNAMENT_ROUNDS !== 'undefined') ? TOURNAMENT_ROUNDS : ["League Match", "Semi Final", "Final"];
    
    // 1. Group Fixtures
    fixtures.sort((a,b) => (a.matchNo || 999) - (b.matchNo || 999));
    fixtures.forEach(f => {
        if(!grouped[f.stage]) grouped[f.stage] = [];
        grouped[f.stage].push(f);
    });

    // 2. Sort Stages Robustly
    const getStageIndex = (name) => {
        const idx = order.findIndex(o => name.includes(o));
        return idx === -1 ? 999 : idx;
    };
    const sortedKeys = Object.keys(grouped).sort((a, b) => getStageIndex(a) - getStageIndex(b));

    // 3. Render
    let knockoutHeaderAdded = false;

    sortedKeys.forEach(stage => {
        // --- SEPARATOR LOGIC ---
        const isKnockout = stage.includes('Final') || stage.includes('Semi') || stage.includes('Qualifier') || stage.includes('Eliminator');
        
        if (isKnockout && !knockoutHeaderAdded) {
            const divider = document.createElement('div');
            divider.className = "flex items-center gap-4 my-8 opacity-80";
            divider.innerHTML = `
                <div class="h-px bg-gradient-to-r from-transparent via-gray-300 to-transparent flex-1"></div>
                <div class="flex items-center gap-2 text-gray-400">
                    <span class="text-lg">üèÜ</span>
                    <span class="text-xs font-black uppercase tracking-[0.2em]">Knockout Stage</span>
                </div>
                <div class="h-px bg-gradient-to-r from-transparent via-gray-300 to-transparent flex-1"></div>
            `;
            board.appendChild(divider);
            knockoutHeaderAdded = true;
        }

        const stageGroup = document.createElement('div');
        stageGroup.className = "mb-8 animate-slide-up";
        
        // Dynamic Header Color (Blue for League, Gold for Knockout)
        const headerColor = isKnockout ? "bg-gradient-to-b from-yellow-500 to-orange-500" : "bg-gradient-to-b from-purple-600 to-blue-600";
        
        stageGroup.innerHTML = `
            <div class="flex items-center gap-3 mb-4 px-2">
                <div class="h-5 w-1.5 ${headerColor} rounded-full shadow-sm"></div>
                <h4 class="font-black text-gray-800 uppercase text-sm tracking-widest">${stage}</h4>
                <span class="text-[9px] font-bold text-gray-500 bg-white border border-gray-200 px-2 py-0.5 rounded-md shadow-sm">${grouped[stage].length} Games</span>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="group-${stage.replace(/\s/g,'-')}"></div>
        `;
        
        const container = stageGroup.querySelector('div[id^="group-"]');

        grouped[stage].forEach(f => {
            const isPlaceholder = (name) => !name || name === 'TBD' || name.includes('Winner') || name.includes('Place') || name.includes('Qualifier');

            // LOGO FINDER
            const getTeamLogo = (tName) => {
                if (isPlaceholder(tName)) {
                    return `<div class="w-10 h-10 rounded-full bg-gray-50 flex items-center justify-center font-bold text-[10px] text-gray-400 border border-gray-200 border-dashed">?</div>`;
                }
                
                let team = tournamentState.data.teams.find(t => t.name === tName);
                if (team && team.logo) return `<img src="${team.logo}" class="w-10 h-10 rounded-full border-2 border-white shadow-md object-cover bg-white">`;
                
                if (typeof savedTeamsData !== 'undefined') {
                    const saved = savedTeamsData.find(t => t.name === tName);
                    if (saved && saved.logo) return `<img src="${saved.logo}" class="w-10 h-10 rounded-full border-2 border-white shadow-md object-cover bg-white">`;
                }

                return `<div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center font-bold text-xs text-white border-2 border-white shadow-md">${tName.substring(0,2)}</div>`;
            };

            const t1Logo = getTeamLogo(f.t1);
            const t2Logo = getTeamLogo(f.t2);
            const status = f.status || 'UPCOMING';
            
            // ACTION BUTTON & STATUS
            let actionBtn = '';
            let statusBadge = '';

            if(status === 'COMPLETED') {
                statusBadge = `<span class="bg-gray-100 text-gray-500 text-[9px] font-black px-2 py-0.5 rounded uppercase tracking-wider">Finished</span>`;
                actionBtn = `<div class="mt-4 p-2 bg-green-50 rounded-lg border border-green-100 text-center"><span class="text-[10px] font-bold text-green-700 uppercase tracking-wide block">${f.result}</span></div>`;
            } 
            else if (status === 'LIVE') {
                statusBadge = `<span class="bg-red-100 text-red-600 text-[9px] font-black px-2 py-0.5 rounded uppercase tracking-wider flex items-center gap-1"><span class="w-1.5 h-1.5 bg-red-600 rounded-full animate-pulse"></span> LIVE</span>`;
                actionBtn = `
                    <div class="mt-4 w-full py-3 bg-gradient-to-r from-red-500 to-pink-600 rounded-xl shadow-lg shadow-red-200 flex items-center justify-center gap-2 animate-pulse cursor-pointer hover:scale-[1.02] transition-transform" onclick="startTournamentMatch('${f.id}')">
                        <span class="text-lg text-white">‚óè</span>
                        <span class="text-xs font-black text-white uppercase tracking-widest">Match In Progress</span>
                    </div>`;
            } 
            else {
                statusBadge = `<span class="bg-blue-50 text-blue-600 text-[9px] font-black px-2 py-0.5 rounded uppercase tracking-wider">Upcoming</span>`;
                
                // Show "Pending" if teams aren't ready
                if (isPlaceholder(f.t1) || isPlaceholder(f.t2)) {
                    actionBtn = `<div class="mt-4 w-full py-3 bg-gray-50 border border-gray-200 text-gray-400 font-bold text-[10px] rounded-xl uppercase text-center flex items-center justify-center gap-2">
                        <span>Waiting for Qualification</span>
                    </div>`;
                } else {
                    actionBtn = `<button onclick="startTournamentMatch('${f.id}')" class="mt-4 w-full py-3 bg-gray-900 text-white font-bold text-xs rounded-xl uppercase shadow-md hover:bg-black transition-all active:scale-95 flex items-center justify-center gap-2"><span>Start Match</span> <span>‚ñ∂</span></button>`;
                }
            }

            const getNameClass = (name) => isPlaceholder(name) ? "text-gray-400 italic" : "text-gray-800 group-hover/team:text-blue-600";

            const card = document.createElement('div');
            card.className = "bg-white p-5 rounded-2xl shadow-[0_2px_10px_rgba(0,0,0,0.04)] border border-gray-100 relative group transition-all hover:shadow-lg hover:border-blue-100";
            
            // Special Gold Border for Finals
            if(stage.includes('Final')) {
                card.classList.add('border-yellow-200', 'shadow-yellow-100');
            }

            card.innerHTML = `
                <div class="flex justify-between items-center mb-4 pb-3 border-b border-gray-50">
                    <div class="flex flex-col">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-[9px] font-black text-gray-400 uppercase tracking-wider">#${f.matchNo}</span>
                            ${statusBadge}
                        </div>
                        <span class="text-[10px] font-bold text-gray-500 truncate max-w-[120px]">${f.ground || 'Main Ground'}</span>
                    </div>
                    
                    ${status !== 'LIVE' && status !== 'COMPLETED' ? `
                    <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button onclick="openEditMatchModal('${f.id}')" class="p-1.5 hover:bg-blue-50 rounded text-gray-400 hover:text-blue-600 transition-colors">‚úé</button>
                        <button onclick="deleteFixture('${f.id}')" class="p-1.5 hover:bg-red-50 rounded text-gray-400 hover:text-red-600 transition-colors">√ó</button>
                    </div>` : ''}
                </div>

                <div class="flex items-center justify-between mb-2">
                    <div class="flex flex-col items-center gap-2 w-[40%] text-center group/team">
                        ${t1Logo}
                        <span class="text-[10px] font-black uppercase leading-tight transition-colors ${getNameClass(f.t1)}">${f.t1}</span>
                    </div>
                    
                    <div class="flex flex-col items-center gap-1">
                        <span class="text-xs font-black text-gray-300">VS</span>
                        <span class="text-[9px] font-bold text-gray-400 bg-gray-50 px-1.5 rounded">${f.overs || 16} Ov</span>
                    </div>

                    <div class="flex flex-col items-center gap-2 w-[40%] text-center group/team">
                        ${t2Logo}
                        <span class="text-[10px] font-black uppercase leading-tight transition-colors ${getNameClass(f.t2)}">${f.t2}</span>
                    </div>
                </div>
                
                ${actionBtn}
            `;
            container.appendChild(card);
        });

        board.appendChild(stageGroup);
    });
}

function renderStandings() {
    const tbody = document.getElementById('standings-body');
    // Sort by Points, then NRR
    const sorted = [...tournamentState.data.standings].sort((a,b) => b.pts - a.pts || b.nrr - a.nrr);
    
    tbody.innerHTML = sorted.map((t, i) => `
        <tr class="border-b last:border-0 hover:bg-gray-50">
            <td class="p-4 font-bold text-gray-800 flex items-center gap-2">
                <span class="text-gray-300 font-mono text-xs">${i+1}</span>
                ${t.name}
            </td>
            <td class="p-4 text-center text-gray-600 font-mono">${t.p}</td>
            <td class="p-4 text-center text-green-600 font-bold">${t.w}</td>
            <td class="p-4 text-center text-red-400">${t.l}</td>
            <td class="p-4 text-center font-mono text-xs">${t.nrr.toFixed(3)}</td>
            <td class="p-4 text-center font-black text-purple-700 text-lg">${t.pts}</td>
        </tr>
    `).join('');
}

function renderStats() {
    recalculatePlayerStats(); // Triggers Live + History Aggregation immediately
}

function switchDashTab(tab) {
    document.querySelectorAll('.dash-view').forEach(el => el.classList.add('hidden'));
    document.getElementById(`view-${tab}`).classList.remove('hidden');
    
    document.querySelectorAll('nav button').forEach(b => {
        b.classList.remove('bg-purple-50', 'text-purple-700');
        b.classList.add('text-gray-500');
    });
    document.getElementById(`tab-${tab}`).classList.remove('text-gray-500');
    document.getElementById(`tab-${tab}`).classList.add('bg-purple-50', 'text-purple-700');
    
    if(tab === 'stats') renderStats(); // Refresh stats on tab switch
}

function exitTournament() {
    document.getElementById('tournament-dashboard').classList.add('hidden');
    document.getElementById('mode-selection-screen').classList.remove('hidden');
}

// 4. Starting a Tournament Match (PROFESSIONAL FIX)
function startTournamentMatch(fixtureId) {
    if (!tournamentState.active || !tournamentState.data) {
        showCustomAlert("Error", "Tournament data not loaded correctly.", "red");
        return;
    }

    const fixture = tournamentState.data.fixtures.find(f => f.id === fixtureId);
    if (!fixture) {
        showCustomAlert("Error", "Fixture not found.", "red");
        return;
    }
    
    // 1. Find Basic Tournament Team Data
    const t1Tourney = tournamentState.data.teams.find(t => t.name === fixture.t1);
    const t2Tourney = tournamentState.data.teams.find(t => t.name === fixture.t2);

    if (!t1Tourney || !t2Tourney) {
        showCustomAlert("Error", "Team data missing from tournament.", "red");
        return;
    }

    // 2. Enrich Data (Fetch High-Res Images from Global Cache if available)
    const enrichTeam = (tourneyTeam) => {
        const saved = savedTeamsData.find(st => st.name === tourneyTeam.name);
        const richTeam = JSON.parse(JSON.stringify(tourneyTeam)); // Deep Copy
        
        if (saved) {
            if (!richTeam.logo && saved.logo) richTeam.logo = saved.logo;
            richTeam.players.forEach(p => {
                const savedPlayer = saved.players.find(sp => sp.id === p.id || sp.name === p.name);
                if (savedPlayer && savedPlayer.image) p.image = savedPlayer.image;
            });
        }
        return richTeam;
    };

    const t1Ready = enrichTeam(t1Tourney);
    const t2Ready = enrichTeam(t2Tourney);

    // CRITICAL FIX: Map 'players' array to 'squad' for game compatibility
    t1Ready.squad = t1Ready.players;
    t2Ready.squad = t2Ready.players;

    // 3. Reset Main State
    state.matchType = 'TOURNAMENT';
    state.tournamentId = tournamentState.id;
    state.fixtureId = fixtureId;
    
    // --- FIX: FORCE RESET GAME LOGIC VARIABLES ---
    state.innings = 1;
    state.target = 0;
    state.currentOver = [];
    state.history = [];
    state.timeline = [];
    state.isSuperOver = false;
    state.striker = null;
    state.nonStriker = null;
    state.bowler = null;
    state.battingTeam = 'team1'; // Will be confirmed after Toss
    state.bowlingTeam = 'team2';
    // ---------------------------------------------

    // 4. Load Config
    state.totalOvers = fixture.overs || tournamentState.data.rules.overs || 16;
    state.playersPerSide = tournamentState.data.rules.players || 8;
    state.ballsPerOver = 6; // Default
    state.venue = "Tournament Match";

    // Set UI Inputs so helper functions read correct values
    if(ui.totalOversInput) ui.totalOversInput.value = state.totalOvers;
    if(ui.playersPerSideInput) ui.playersPerSideInput.value = state.playersPerSide;

    // 5. Load Teams into Global State
    state.team1 = t1Ready;
    state.team2 = t2Ready;
    
    // 6. Reset Squads (Clean Slate for Step 2)
    ['team1', 'team2'].forEach(k => {
        state[k].playerStats = {};
        state[k].playing = [];
        state[k].captainId = null;
        state[k].score = 0; state[k].wickets = 0; state[k].overs = 0; state[k].balls = 0;
    });

    // 7. Transition UI
    // Hide Dashboard
    document.getElementById('tournament-dashboard').classList.add('hidden');
    document.getElementById('tournament-dashboard').classList.remove('active');
    
    // Populate Roster Screens
    ui.team1RosterTitle.textContent = state.team1.name;
    document.getElementById('team1-roster-logo').src = state.team1.logo || 'https://placehold.co/60x60/3b82f6/white?text=H';
    
    ui.team2RosterTitle.textContent = state.team2.name;
    document.getElementById('team2-roster-logo').src = state.team2.logo || 'https://placehold.co/60x60/ef4444/white?text=A';

    generateUnifiedRoster('team1');
    generateUnifiedRoster('team2');

    // 8. Update Fixture Status
    fixture.status = 'LIVE';
    saveTournamentData();

    // 9. ROUTE TO STEP 2 (Professional Flow)
    showScreen('setup-screen');
    goToStep(2);
}

// --- ROBUST TOURNAMENT ENGINE ---

function updateTournamentStatsAfterMatch() {
    if (state.matchType !== 'TOURNAMENT' || !tournamentState.active) return;

    // RULE: Only update if match is officially over (Innings 2 or 4 complete)
    if (state.innings === 1 || state.innings === 3) return;

    const fixture = tournamentState.data.fixtures.find(f => f.id === state.fixtureId);
    if (!fixture) return;

    // 1. Calculate Winner Logic
    const t1 = state.team1;
    const t2 = state.team2;
    let winner = null;
    let resultText = "Draw";

    if (t1.score > t2.score) {
        winner = t1.name;
        resultText = `${t1.name} won by ${t1.score - t2.score} runs`;
    } else if (t2.score > t1.score) {
        winner = t2.name;
        const wkts = Math.max(1, (state.playersPerSide - 1) - (t2.wickets || 0));
        resultText = `${t2.name} won by ${wkts} wickets`;
    } else {
        resultText = "Match Tied";
        if(state.isSuperOver) {
             if (t1.score > t2.score) winner = t1.name;
             else winner = t2.name;
        }
    }

    // 2. Update Fixture Status
    fixture.status = 'COMPLETED';
    fixture.result = resultText;
    fixture.winner = winner;
    
    // Save Stats
    const getDec = (o, b) => o + (b/6);
    fixture.stats = {
        t1: { name: t1.name, score: t1.score, overs: getDec(t1.overs, t1.balls) },
        t2: { name: t2.name, score: t2.score, overs: getDec(t2.overs, t2.balls) }
    };

    // 3. Extract Fielding Stats (Catches/Stumpings) before saving
    const fieldingMap = {};
    const processFielding = (fieldingTeamKey, battingTeamKey) => {
        Object.values(state[battingTeamKey].playerStats).forEach(p => {
             if (p.dismissal) {
                 const cMatch = p.dismissal.match(/^c\.\s(.*?)\sb\./);
                 const stMatch = p.dismissal.match(/^st\.\s(.*?)\sb\./);
                 if(cMatch) {
                     const fName = cMatch[1];
                     if(!fieldingMap[fName]) fieldingMap[fName] = { c: 0, st: 0 };
                     fieldingMap[fName].c++;
                 }
                 if(stMatch) {
                     const fName = stMatch[1];
                     if(!fieldingMap[fName]) fieldingMap[fName] = { c: 0, st: 0 };
                     fieldingMap[fName].st++;
                 }
             }
        });
    };
    processFielding('team1', 'team2'); // Team 1 fielders vs Team 2 batters
    processFielding('team2', 'team1'); // Team 2 fielders vs Team 1 batters

    // 4. Save Player Stats to Log
    if(!tournamentState.data.matchStatsLog) tournamentState.data.matchStatsLog = [];
    tournamentState.data.matchStatsLog = tournamentState.data.matchStatsLog.filter(log => log.matchId !== fixture.id);

    ['team1', 'team2'].forEach(key => {
        Object.values(state[key].playerStats).forEach(p => {
             // Save if played OR has fielding stats
             const fStats = fieldingMap[p.name] || { c: 0, st: 0 };
             if(p.balls > 0 || p.ballsBowled > 0 || p.dismissal || fStats.c > 0 || fStats.st > 0) {
                 tournamentState.data.matchStatsLog.push({
                     matchId: fixture.id,
                     name: p.name,
                     team: state[key].name,
                     runs: p.runs,
                     balls: p.balls,
                     wkts: p.wickets,
                     runsConceded: p.runsConceded,
                     ballsBowled: p.ballsBowled,
                     catches: fStats.c,
                     stumpings: fStats.st
                 });
             }
        });
    });

    // 5. Trigger Recalculations
    recalculateStandings();
    autoFillKnockouts(fixture);
    recalculatePlayerStats();

    // 6. Save
    saveTournamentData();
    showCustomAlert("Tournament Update", "Standings, Stats & Schedule Updated!", "green");
}

function autoFillKnockouts(completedFixture) {
    const fixtures = tournamentState.data.fixtures;
    
    // 1. Get Sorted Standings (Points Table)
    const standings = [...tournamentState.data.standings].sort((a,b) => b.pts - a.pts || b.nrr - a.nrr);
    
    // 2. Build Resolver Map (Placeholders -> Real Teams)
    const map = {};

    // League Standings Mappings
    if(standings[0]) { 
        map["1st Place"] = standings[0].name; 
        map["1st"] = standings[0].name; 
        map["Winner Group A"] = standings[0].name; 
        map["Qualifier 1"] = standings[0].name; 
        map["Top Ranked 1"] = standings[0].name; 
    }
    if(standings[1]) { 
        map["2nd Place"] = standings[1].name; 
        map["2nd"] = standings[1].name; 
        map["Winner Group B"] = standings[1].name; 
        map["Qualifier 2"] = standings[1].name; 
        map["Top Ranked 2"] = standings[1].name; 
    }
    if(standings[2]) { map["3rd Place"] = standings[2].name; map["3rd"] = standings[2].name; }
    if(standings[3]) { map["4th Place"] = standings[3].name; map["4th"] = standings[3].name; }

    // Knockout Mappings (Winners of previous stages)
    fixtures.forEach(f => {
        if(f.status === 'COMPLETED' && f.winner) {
            // Map exact stage name to Winner Key
            if(f.stage === 'Semi Final 1') map["Winner SF1"] = f.winner;
            if(f.stage === 'Semi Final 2') map["Winner SF2"] = f.winner;
            if(f.stage === 'Quarter Final 1') map["Winner QF1"] = f.winner;
            if(f.stage === 'Quarter Final 2') map["Winner QF2"] = f.winner;
            if(f.stage === 'Quarter Final 3') map["Winner QF3"] = f.winner;
            if(f.stage === 'Quarter Final 4') map["Winner QF4"] = f.winner;
            
            // Map by Match Number (Fallback)
            map[`Winner Match ${f.matchNo}`] = f.winner;
        }
    });

    // 3. Sweep Upcoming Fixtures & Replace Placeholders (With Auto-Correction Logic)
    let updatesMade = false;
    fixtures.forEach(f => {
        if(f.status !== 'COMPLETED' && f.status !== 'LIVE') {
            
            // AUTO-REPAIR: If it's a Final, force source linking to fix previous errors
            if(f.stage === 'Final') {
                if(!f.t1_source) f.t1_source = "Winner SF1";
                if(!f.t2_source) f.t2_source = "Winner SF2";
            }

            // CHECK TEAM 1 (Using Source Tag if available to allow updates)
            const t1Key = f.t1_source || f.t1;
            if(map[t1Key]) { 
                if (f.t1 !== map[t1Key]) {
                    f.t1_source = t1Key; // Save the placeholder
                    f.t1 = map[t1Key];   // Update the Team
                    updatesMade = true; 
                }
            }

            // CHECK TEAM 2
            const t2Key = f.t2_source || f.t2; 
            if(map[t2Key]) { 
                if (f.t2 !== map[t2Key]) {
                    f.t2_source = t2Key; // Save the placeholder
                    f.t2 = map[t2Key];   // Update the Team
                    updatesMade = true; 
                }
            }
        }
    });
    
    if(updatesMade) {
        console.log("Knockout fixtures updated automatically.");
        saveTournamentData(); // Save changes to DB
        renderFixtures();     // Refresh UI
    }
}

function recalculateStandings() {
    const standings = tournamentState.data.standings;
    // Reset
    standings.forEach(s => {
        s.p = 0; s.w = 0; s.l = 0; s.t = 0; s.pts = 0; 
        s.runsFor = 0; s.oversFor = 0; s.runsAgainst = 0; s.oversAgainst = 0;
    });

    // Process all completed League Matches
    tournamentState.data.fixtures.forEach(f => {
        if(f.status === 'COMPLETED' && f.stage === 'League Match' && f.stats) {
            const s1 = f.stats.t1;
            const s2 = f.stats.t2;
            const row1 = standings.find(x => x.name === s1.name);
            const row2 = standings.find(x => x.name === s2.name);

            if(row1 && row2) {
                row1.p++; row2.p++;
                
                // NRR Data
                row1.runsFor += s1.score; row1.oversFor += s1.overs;
                row1.runsAgainst += s2.score; row1.oversAgainst += s2.overs;
                
                row2.runsFor += s2.score; row2.oversFor += s2.overs;
                row2.runsAgainst += s1.score; row2.oversAgainst += s1.overs;

                // Points
                if(f.winner === s1.name) { row1.w++; row1.pts += 2; row2.l++; }
                else if(f.winner === s2.name) { row2.w++; row2.pts += 2; row1.l++; }
                else { row1.t++; row2.t++; row1.pts += 1; row2.pts += 1; }
            }
        }
    });

    // Calc NRR
    standings.forEach(s => {
        const rf = s.oversFor > 0 ? s.runsFor / s.oversFor : 0;
        const ra = s.oversAgainst > 0 ? s.runsAgainst / s.oversAgainst : 0;
        s.nrr = rf - ra;
    });
}

// 7. PROFESSIONAL STATS ENGINE (Smart Cric Theme - Full Width Fix)
function recalculatePlayerStats() {
    const logs = tournamentState.data.matchStatsLog || [];
    const aggStats = {}; 
    
    // Helper to init
    const initPlayerStat = (key, name, team) => {
        aggStats[key] = {
            name: name, team: team, matches: 0, innings: 0,
            runs: 0, balls: 0, fours: 0, sixes: 0,
            wkts: 0, rc: 0, bb: 0,
            catches: 0, stumpings: 0
        };
    };

    // 1. Process Historical Logs
    logs.forEach(log => {
        const key = `${log.name}_${log.team}`;
        if(!aggStats[key]) initPlayerStat(key, log.name, log.team);
        
        const p = aggStats[key];
        p.matches++;
        p.runs += (log.runs || 0);
        p.balls += (log.balls || 0);
        p.wkts += (log.wkts || 0);
        p.rc += (log.runsConceded || 0);
        p.bb += (log.ballsBowled || 0);
        p.catches += (log.catches || 0);
        p.stumpings += (log.stumpings || 0);
        if(log.balls > 0) p.innings++;
    });

    // 2. Process LIVE Match (Real-Time Aggregation)
    if (state.matchType === 'TOURNAMENT' && state.tournamentId === tournamentState.id && state.active) {
        ['team1', 'team2'].forEach(teamKey => {
            const teamName = state[teamKey].name;
            Object.values(state[teamKey].playerStats).forEach(liveP => {
                const key = `${liveP.name}_${teamName}`;
                if(!aggStats[key]) initPlayerStat(key, liveP.name, teamName);
                
                const p = aggStats[key];
                p.runs += (liveP.runs || 0);
                p.balls += (liveP.balls || 0);
                p.wkts += (liveP.wickets || 0);
                p.rc += (liveP.runsConceded || 0);
                p.bb += (liveP.ballsBowled || 0);
                
                p.matches++;
                if(liveP.balls > 0) p.innings++;
            });
        });

        const processLiveFielding = (fieldingTeamKey, battingTeamKey) => {
             const teamName = state[fieldingTeamKey].name;
             Object.values(state[battingTeamKey].playerStats).forEach(p => {
                 if (p.dismissal) {
                     const cMatch = p.dismissal.match(/^c\.\s(.*?)\sb\./);
                     const stMatch = p.dismissal.match(/^st\.\s(.*?)\sb\./);
                     if(cMatch) {
                         const fName = cMatch[1];
                         const key = `${fName}_${teamName}`;
                         if(!aggStats[key]) initPlayerStat(key, fName, teamName);
                         aggStats[key].catches++;
                     }
                     if(stMatch) {
                         const fName = stMatch[1];
                         const key = `${fName}_${teamName}`;
                         if(!aggStats[key]) initPlayerStat(key, fName, teamName);
                         aggStats[key].stumpings++;
                     }
                 }
             });
        };
        processLiveFielding('team1', 'team2');
        processLiveFielding('team2', 'team1');
    }
    
    // Save to global for UI interactions
    window.latestPlayerStats = Object.values(aggStats);
    renderStatsUI(window.latestPlayerStats);
}

function renderStatsUI(players) {
    // 1. Hydrate Data & State
    if (!players && window.latestPlayerStats) players = window.latestPlayerStats;
    if (!players) return;
    if (!window.statsTabState) window.statsTabState = { tab: 'batsman', team: 'All Teams' };

    const bpo = tournamentState.data.rules.ballType === 'Leather' ? 6 : (tournamentState.data.rules.ballsPerOver || 6);

    // 2. CHECK & WIPE OLD LAYOUT (Fixes Duplication & Width)
    let runsAnchor = document.getElementById('stats-runs');
    let wktsAnchor = document.getElementById('stats-wickets');
    let parentContainer = null;

    if (runsAnchor) {
        parentContainer = runsAnchor.parentNode;
        parentContainer.innerHTML = ''; 
        parentContainer.className = "w-full flex flex-col gap-4"; 
        parentContainer.id = "stats-main-wrapper";
    } else if (wktsAnchor) {
        parentContainer = wktsAnchor.parentNode;
        parentContainer.innerHTML = '';
        parentContainer.className = "w-full flex flex-col gap-4";
        parentContainer.id = "stats-main-wrapper";
    } else {
        parentContainer = document.getElementById('stats-main-wrapper');
    }

    if (!parentContainer) return; 

    // 3. Create Widget if Missing
    let widget = document.getElementById('stats-widget-container');
    if (!widget) {
        widget = document.createElement('div');
        widget.id = 'stats-widget-container';
        widget.className = "bg-white rounded-xl shadow-md border border-gray-100 overflow-hidden w-full"; 
        parentContainer.appendChild(widget);
    }

    // 4. Render Skeleton (Header, Tabs, Filter) if empty
    // UPDATED: Added 'overflow-x-auto no-scrollbar snap-x snap-mandatory' for professional sliding tabs
    if (widget.innerHTML === '') {
        widget.innerHTML = `
            <div class="p-4 border-b border-gray-100 flex flex-col md:flex-row justify-between items-center gap-3 bg-gray-50">
                <h3 class="font-black text-gray-800 uppercase tracking-wide text-sm flex items-center gap-2">
                    üèÜ Tournament Leaderboard
                </h3>
                <select id="stats-team-filter" onchange="updateStatsTeam(this.value)" class="w-full md:w-auto bg-white border border-gray-200 text-gray-700 text-xs font-bold rounded-lg focus:ring-blue-500 focus:border-blue-500 p-2 shadow-sm">
                    <option value="All Teams">All Teams</option>
                </select>
            </div>
            
            <div class="flex border-b border-gray-100 overflow-x-auto no-scrollbar snap-x snap-mandatory scroll-smooth">
                <button onclick="updateStatsTab('batsman')" id="tab-batsman" class="flex-none w-1/3 min-w-[120px] snap-start py-3 px-4 text-xs font-bold text-center border-b-2 transition-colors whitespace-nowrap">
                    üèè Best Batsman
                </button>
                <button onclick="updateStatsTab('bowler')" id="tab-bowler" class="flex-none w-1/3 min-w-[120px] snap-start py-3 px-4 text-xs font-bold text-center border-b-2 transition-colors whitespace-nowrap">
                    ü•é Best Bowler
                </button>
                <button onclick="updateStatsTab('fielder')" id="tab-fielder" class="flex-none w-1/3 min-w-[120px] snap-start py-3 px-4 text-xs font-bold text-center border-b-2 transition-colors whitespace-nowrap">
                    üß§ Best Fielder
                </button>
            </div>

            <div id="stats-table-area" class="overflow-x-auto no-scrollbar min-h-[350px] bg-white w-full custom-scroll"></div>
        `;
        
        // Attach Globals
        window.updateStatsTab = (t) => { window.statsTabState.tab = t; renderStatsUI(window.latestPlayerStats); };
        window.updateStatsTeam = (t) => { window.statsTabState.team = t; renderStatsUI(window.latestPlayerStats); };
    }

    // 5. Update Dropdown Options
    const teamSelect = document.getElementById('stats-team-filter');
    if (teamSelect) {
        const teams = [...new Set(players.map(p => p.team))].sort();
        if (teamSelect.options.length !== teams.length + 1) {
            const current = window.statsTabState.team;
            teamSelect.innerHTML = `<option value="All Teams">All Teams</option>` + 
                teams.map(t => `<option value="${t}" ${t===current?'selected':''}>${t}</option>`).join('');
        }
    }

    // 6. Update Active Tab Styling
    const tabs = {
        batsman: { color: 'border-orange-500 text-orange-600 bg-orange-50', inactive: 'border-transparent text-gray-400 hover:text-gray-600' },
        bowler: { color: 'border-indigo-500 text-indigo-600 bg-indigo-50', inactive: 'border-transparent text-gray-400 hover:text-gray-600' },
        fielder: { color: 'border-teal-500 text-teal-600 bg-teal-50', inactive: 'border-transparent text-gray-400 hover:text-gray-600' }
    };
    Object.keys(tabs).forEach(k => {
        const btn = document.getElementById(`tab-${k}`);
        if(btn) {
            btn.className = `flex-none w-1/3 min-w-[120px] snap-start py-3 px-4 text-xs font-bold text-center border-b-2 transition-colors whitespace-nowrap ${window.statsTabState.tab === k ? tabs[k].color : tabs[k].inactive}`;
        }
    });

    // 7. Filter & Process Data
    let data = window.statsTabState.team === 'All Teams' ? players : players.filter(p => p.team === window.statsTabState.team);
    const activeTab = window.statsTabState.tab;
    let html = '';

    if (activeTab === 'batsman') {
        data = data.filter(p => p.runs > 0).sort((a,b) => b.runs - a.runs || ((b.runs/b.balls)-(a.runs/a.balls))).slice(0,20);
        html = `
            <table class="w-full text-left border-collapse min-w-[350px]">
                <thead>
                    <tr class="bg-orange-600 text-white text-[10px] uppercase font-bold tracking-wider">
                        <th class="p-3 sticky left-0 bg-orange-600 z-10">#</th>
                        <th class="p-3 w-1/2 sticky left-8 bg-orange-600 z-10">Player</th>
                        <th class="p-3 text-center">Mat</th>
                        <th class="p-3 text-center">SR</th>
                        <th class="p-3 text-right">Runs</th>
                    </tr>
                </thead>
                <tbody class="text-xs divide-y divide-gray-100">
                    ${data.map((p,i) => {
                        const sr = p.balls > 0 ? ((p.runs/p.balls)*100).toFixed(0) : 0;
                        return `
                        <tr class="odd:bg-white even:bg-gray-50 hover:bg-orange-50 transition-colors">
                            <td class="p-3 font-mono text-gray-400 font-bold sticky left-0 bg-inherit z-10">${i+1}</td>
                            <td class="p-3 sticky left-8 bg-inherit z-10 border-r border-gray-100">
                                <div class="font-bold text-gray-800 text-xs">${p.name}</div>
                                <div class="text-[9px] text-gray-400 uppercase font-semibold">${p.team}</div>
                            </td>
                            <td class="p-3 text-center font-medium text-gray-500">${p.matches}</td>
                            <td class="p-3 text-center font-medium text-gray-500">${sr}</td>
                            <td class="p-3 text-right font-black text-orange-600 text-sm">${p.runs}</td>
                        </tr>`;
                    }).join('')}
                </tbody>
            </table>`;
    } 
    else if (activeTab === 'bowler') {
        data = data.filter(p => p.wkts > 0 || p.bb > 0).sort((a,b) => b.wkts - a.wkts || (a.rc/(a.bb||1))-(b.rc/(b.bb||1))).slice(0,20);
        html = `
            <table class="w-full text-left border-collapse min-w-[350px]">
                <thead>
                    <tr class="bg-indigo-600 text-white text-[10px] uppercase font-bold tracking-wider">
                        <th class="p-3 sticky left-0 bg-indigo-600 z-10">#</th>
                        <th class="p-3 w-1/2 sticky left-8 bg-indigo-600 z-10">Player</th>
                        <th class="p-3 text-center">Ov</th>
                        <th class="p-3 text-center">Econ</th>
                        <th class="p-3 text-right">Wkts</th>
                    </tr>
                </thead>
                <tbody class="text-xs divide-y divide-gray-100">
                    ${data.map((p,i) => {
                        const ov = Math.floor(p.bb/bpo) + '.' + (p.bb%bpo);
                        const ec = (p.bb>0 ? (p.rc/(p.bb/bpo)) : 0).toFixed(1);
                        return `
                        <tr class="odd:bg-white even:bg-gray-50 hover:bg-indigo-50 transition-colors">
                            <td class="p-3 font-mono text-gray-400 font-bold sticky left-0 bg-inherit z-10">${i+1}</td>
                            <td class="p-3 sticky left-8 bg-inherit z-10 border-r border-gray-100">
                                <div class="font-bold text-gray-800 text-xs">${p.name}</div>
                                <div class="text-[9px] text-gray-400 uppercase font-semibold">${p.team}</div>
                            </td>
                            <td class="p-3 text-center font-medium text-gray-500">${ov}</td>
                            <td class="p-3 text-center font-medium text-gray-500">${ec}</td>
                            <td class="p-3 text-right font-black text-indigo-600 text-sm">${p.wkts}</td>
                        </tr>`;
                    }).join('')}
                </tbody>
            </table>`;
    }
    else {
        data = data.filter(p => p.catches > 0 || p.stumpings > 0).sort((a,b) => b.catches - a.catches).slice(0,20);
        html = `
            <table class="w-full text-left border-collapse min-w-[350px]">
                <thead>
                    <tr class="bg-teal-600 text-white text-[10px] uppercase font-bold tracking-wider">
                        <th class="p-3 sticky left-0 bg-teal-600 z-10">#</th>
                        <th class="p-3 w-1/2 sticky left-8 bg-teal-600 z-10">Player</th>
                        <th class="p-3 text-center">Mat</th>
                        <th class="p-3 text-center">St</th>
                        <th class="p-3 text-right">Catches</th>
                    </tr>
                </thead>
                <tbody class="text-xs divide-y divide-gray-100">
                    ${data.map((p,i) => {
                        return `
                        <tr class="odd:bg-white even:bg-gray-50 hover:bg-teal-50 transition-colors">
                            <td class="p-3 font-mono text-gray-400 font-bold sticky left-0 bg-inherit z-10">${i+1}</td>
                            <td class="p-3 sticky left-8 bg-inherit z-10 border-r border-gray-100">
                                <div class="font-bold text-gray-800 text-xs">${p.name}</div>
                                <div class="text-[9px] text-gray-400 uppercase font-semibold">${p.team}</div>
                            </td>
                            <td class="p-3 text-center font-medium text-gray-500">${p.matches}</td>
                            <td class="p-3 text-center font-medium text-gray-500">${p.stumpings}</td>
                            <td class="p-3 text-right font-black text-teal-600 text-sm">${p.catches}</td>
                        </tr>`;
                    }).join('')}
                </tbody>
            </table>`;
    }

    if(data.length === 0) {
        html = `<div class="p-8 text-center text-gray-400 text-xs italic">No stats available for ${window.statsTabState.team} yet.</div>`;
    }

    document.getElementById('stats-table-area').innerHTML = html;
}

function saveTournamentData() {
    if (tournamentState.id) {
        db.collection("tournaments").doc(tournamentState.id).set(tournamentState.data, { merge: true });
    }
}
    </script>
</body>
</html>
