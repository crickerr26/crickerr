<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Cricker - Indoor Match Controller</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb"/>
    <link rel="apple-touch-icon" href="icon-512.png">

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    
<style>
    /* --- Base Styles --- */
    body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
    
    @media (max-width: 768px) {
        body { font-size: 14px; }
        #setup-screen, #choice-screen { padding: 0; }
        .setup-card, .choice-card { max-width: 100%; min-height: 100vh; border-radius: 0; box-shadow: none; border: none; }
        #app { overflow: hidden; }
        #app > .flex-grow { padding: 8px; display: flex; flex-direction: column; }
        #match-header h1 { font-size: 1.25rem; }
        #scoreboard { padding: 0; }
        #batting-table th, #batting-table td, #bowling-table th, #bowling-table td { padding: 4px 2px; font-size: 0.75rem; }
    }

    /* --- Setup & UI Components --- */
    .setup-bg { background-color:#f3f4f6; }
    .setup-card { background: #ffffff; border: 1px solid #e5e7eb; border-radius: 1rem; }
    .setup-step { transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out; }
    .setup-step.hidden { opacity: 0; transform: translateX(30px) scale(0.98); position: absolute; pointer-events: none; }
    .setup-step.active { opacity: 1; transform: translateX(0) scale(1); }
    .progress-bar-fill { background-color: #2563eb; transition: width 0.5s ease-in-out; }
    
    /* Toss Buttons (NEW STYLE) */
    .toss-card-btn { 
        border-radius: 1rem; 
        background-color: white; 
        border: 2px solid #e5e7eb; 
        transition: all 0.2s ease-out; 
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 2rem;
        cursor: pointer;
    }
    .toss-card-btn:hover { border-color: #93c5fd; }
    .toss-card-btn.selected { 
        background-color: #eff6ff; 
        border-color: #2563eb; 
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2); 
    }

    .decision-btn {
        border-radius: 0.75rem;
        background-color: white;
        border: 1px solid #d1d5db;
        padding: 0.75rem 2rem;
        font-weight: bold;
        transition: all 0.2s;
    }
    .decision-btn.selected {
        background-color: #2563eb;
        color: white;
        border-color: #2563eb;
        box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.3);
    }
    
    /* --- Scoring Grid - Apple Watery Theme --- */
    .scoring-grid { 
        display: grid; 
        grid-template-columns: repeat(4, 1fr); 
        grid-template-rows: 1fr 1fr 0.7fr; 
        flex-grow: 1; 
        gap: 6px; 
        padding: 6px;
        background: #f0f2f5;
    }

    .watery-btn {
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.3);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.4);
        font-family: 'Inter', sans-serif;
        transition: transform 0.1s active, filter 0.2s;
        backdrop-filter: blur(4px);
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
    }
    
    .watery-btn:active { transform: scale(0.96); }

    /* Gradients */
    .btn-grey { background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%); color: #374151; }
    .btn-dark-grey { background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%); color: #ffffff; text-shadow: 0 1px 2px rgba(0,0,0,0.3); }
    .btn-sky { background: linear-gradient(135deg, #7dd3fc 0%, #0ea5e9 100%); color: #ffffff; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }
    .btn-green { background: linear-gradient(135deg, #86efac 0%, #16a34a 100%); color: #ffffff; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }
    .btn-red { background: linear-gradient(135deg, #fca5a5 0%, #dc2626 100%); color: #ffffff; text-shadow: 0 1px 2px rgba(0,0,0,0.3); }
    .btn-yellow { background: linear-gradient(135deg, #fde047 0%, #eab308 100%); color: #713f12; }

    /* Animation Classes */
    @keyframes popIn {
        0% { transform: scale(0); opacity: 0; }
        50% { transform: scale(1.3); opacity: 1; }
        100% { transform: scale(1); opacity: 1; }
    }
    .animate-pop { animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
    
    /* Modals */
    .modal-overlay { transition: opacity 0.3s ease-in-out; }
    
    /* --- Roster Table Styles --- */
    .roster-row {
        display: grid;
        grid-template-columns: auto 1fr auto;
        gap: 0.75rem;
        align-items: center;
        padding: 0.5rem;
        background-color: white;
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        transition: all 0.2s;
    }
    .roster-row.selected { background-color: #eff6ff; border-color: #3b82f6; }
    .roster-input { width: 100%; font-weight: 600; color: #374151; background: transparent; border: none; outline: none; text-transform: uppercase; font-size: 0.85rem; }
    .roster-input:focus { border-bottom: 2px solid #3b82f6; }
    
    /* Ball Chips (Smaller Size) */
    .ball-chip {
        display: inline-flex; justify-content: center; align-items: center;
        width: 1.2rem; height: 1.2rem; font-size: 0.6rem; font-weight: bold;
        border-radius: 9999px; margin-right: 0.1rem; background-color: #e5e7eb; color: #374151;
        flex-shrink: 0;
    }
    .ball-4 { background-color: #3b82f6; color: white; }
    .ball-6 { background-color: #22c55e; color: white; }
    .ball-w { background-color: #ef4444; color: white; }
    .ball-wd, .ball-nb { background-color: #f59e0b; color: white; }

    /* Custom Scrollbar for Setup */
    .custom-scroll::-webkit-scrollbar { width: 6px; }
    .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
    .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

    /* Scoreboard Specifics */
    .opacity-60 { filter: grayscale(100%); opacity: 0.6; }

    /* --- iOS Toggle Switch --- */
    .ios-toggle {
        appearance: none;
        width: 50px;
        height: 30px;
        background: #e5e7eb;
        border-radius: 9999px;
        position: relative;
        cursor: pointer;
        outline: none;
        transition: background-color 0.3s ease;
    }
    .ios-toggle::after {
        content: '';
        position: absolute;
        top: 2px;
        left: 2px;
        width: 26px;
        height: 26px;
        background: white;
        border-radius: 50%;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
    }
    .ios-toggle:checked {
        background-color: #34c759; /* Apple Green */
    }
    .ios-toggle:checked::after {
        transform: translateX(20px);
    }
</style>
</head>
<body class="bg-gray-100 antialiased text-gray-800">

    <div id="splash-screen" class="fixed inset-0 z-[9999] flex flex-col items-center justify-center bg-gray-50 transition-opacity duration-700" style="display: none;">
        <img src="my-logo.png" alt="App Logo" class="w-24 h-24 mb-4 animate-pulse">
        <h1 class="text-xl font-bold text-blue-700">INDOOR CRICKET</h1>
    </div>

    <div id="event-animation-overlay" class="fixed inset-0 flex items-center justify-center bg-black/60 backdrop-blur-sm pointer-events-none hidden z-50 transition-opacity duration-300">
        <h1 id="event-animation-text" class="text-8xl font-black uppercase drop-shadow-2xl text-center"></h1>
    </div>

    <div id="setup-screen" class="min-h-screen w-full flex flex-col items-center justify-center setup-bg">
        <div class="w-full max-w-6xl shadow-xl rounded-2xl p-4 md:p-8 setup-card overflow-hidden">
            <div id="progress-container" class="mb-8 max-w-2xl mx-auto">
                <div class="w-full h-2 bg-gray-200 rounded-full">
                    <div id="progress-bar" class="progress-bar-fill h-2 rounded-full" style="width: 33%;"></div>
                </div>
                <div class="flex justify-between text-xs sm:text-sm text-gray-500 mt-2 font-medium">
                    <span>Config</span><span>Squad Review</span><span>Toss</span>
                </div>
            </div>

            <div class="relative">
                <div id="setup-step-1" class="setup-step active max-w-2xl mx-auto">
                    <header class="text-center mb-6">
                        <h1 class="text-3xl font-bold text-gray-800">Indoor Match Setup</h1>
                        <p class="text-gray-500 mt-1">Configure format and specific rules</p>
                    </header>
                    <div class="space-y-6 h-[60vh] overflow-y-auto pr-2 custom-scroll">
                        <div class="bg-gray-50 p-4 rounded-xl border border-gray-200 space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><label class="block text-sm font-bold mb-1">Ground</label><input type="text" id="venue" placeholder="ARENA NAME" class="w-full p-2 border rounded uppercase"></div>
                                <div><label class="block text-sm font-bold mb-1">Date</label><input type="date" id="match-date-input" class="w-full p-2 border rounded"></div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-bold mb-1">Overs (3-15)</label>
                                    <select id="total-overs" class="w-full p-2 border rounded">
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-bold mb-1">Players/Side (4-11)</label>
                                    <select id="players-per-side" class="w-full p-2 border rounded">
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 space-y-4">
                            <h3 class="text-sm font-bold text-blue-500 uppercase tracking-wider">Indoor Rules</h3>
                            <div class="grid grid-cols-3 gap-2">
                                <div>
                                    <label class="block text-xs font-bold mb-1">Wicket Penalty <span class="text-red-500 text-lg">*</span></label>
                                    <select id="rule-wicket" class="w-full p-2 border rounded text-sm text-red-600 font-bold border-red-300 focus:ring-2 focus:ring-red-500 outline-none">
                                        <option value="" selected disabled>Select...</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold mb-1">Wide <span class="text-red-500 text-lg">*</span></label>
                                    <select id="rule-wide" class="w-full p-2 border rounded text-sm border-red-300 focus:ring-2 focus:ring-red-500 outline-none">
                                        <option value="" selected disabled>Select...</option>
                                        <option value="2">2 Runs</option>
                                        <option value="3">3 Runs</option>
                                        <option value="1">1 Run</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold mb-1">No Ball <span class="text-red-500 text-lg">*</span></label>
                                    <select id="rule-noball" class="w-full p-2 border rounded text-sm border-red-300 focus:ring-2 focus:ring-red-500 outline-none">
                                        <option value="" selected disabled>Select...</option>
                                        <option value="2">2 Runs</option>
                                        <option value="3">3 Runs</option>
                                        <option value="1">1 Run</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-4">
                             <div class="p-3 bg-gray-50 rounded border"><label class="block text-xs font-bold mb-1">Home Team</label><select id="team1-select" class="w-full p-2 mb-2 border rounded text-sm"><option value="">+ Load Saved Team</option></select><input type="text" id="team1-name-input" placeholder="Home Team Name" class="w-full p-2 border rounded font-bold uppercase"><input type="file" id="team1-logo-input" class="mt-2 text-xs"></div>
                             <div class="p-3 bg-gray-50 rounded border"><label class="block text-xs font-bold mb-1">Away Team</label><select id="team2-select" class="w-full p-2 mb-2 border rounded text-sm"><option value="">+ Load Saved Team</option></select><input type="text" id="team2-name-input" placeholder="Away Team Name" class="w-full p-2 border rounded font-bold uppercase"><input type="file" id="team2-logo-input" class="mt-2 text-xs"></div>
                        </div>
                    </div>
                    <div class="mt-4 text-right"><button onclick="goToStep(2)" class="px-6 py-3 bg-blue-600 text-white font-bold rounded-lg shadow">Next Step ‚Üí</button></div>
                </div>

                <div id="setup-step-2" class="setup-step hidden w-full">
                    <header class="text-center mb-6"><h1 class="text-2xl font-bold">Select Playing Squad</h1><p class="text-xs text-gray-500">Tick the players for today's match</p></header>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-white rounded-xl shadow-sm border border-blue-200 h-full flex flex-col">
                            <div class="bg-blue-50 p-4 border-b flex items-center gap-3"><img id="team1-roster-logo" class="w-10 h-10 rounded-full object-cover"><h2 id="team1-roster-title" class="font-bold text-lg text-blue-900">HOME</h2><span id="team1-count-badge" class="ml-auto text-xs bg-white px-2 py-1 rounded border">0/0</span></div>
                            <div id="team1-player-inputs" class="flex-grow overflow-y-auto max-h-[50vh] p-2 space-y-1 custom-scroll"></div>
                            <div class="p-2 border-t"><button onclick="addNewPlayerToRoster('team1')" class="w-full py-2 border-dashed border-2 text-sm font-bold text-gray-500 rounded hover:text-blue-600">+ Add New Player</button></div>
                        </div>
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 h-full flex flex-col">
                            <div class="bg-gray-100 p-4 border-b flex items-center gap-3"><img id="team2-roster-logo" class="w-10 h-10 rounded-full object-cover"><h2 id="team2-roster-title" class="font-bold text-lg text-gray-800">AWAY</h2><span id="team2-count-badge" class="ml-auto text-xs bg-white px-2 py-1 rounded border">0/0</span></div>
                            <div id="team2-player-inputs" class="flex-grow overflow-y-auto max-h-[50vh] p-2 space-y-1 custom-scroll"></div>
                            <div class="p-2 border-t"><button onclick="addNewPlayerToRoster('team2')" class="w-full py-2 border-dashed border-2 text-sm font-bold text-gray-500 rounded hover:text-gray-800">+ Add New Player</button></div>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-between"><button onclick="goToStep(1)" class="text-gray-500 font-bold px-4">‚Üê Back</button><button onclick="proceedFromUnifiedRoster()" class="px-8 py-3 bg-blue-600 text-white font-bold rounded-xl shadow">Confirm & Toss ‚Üí</button></div>
                </div>

                <div id="setup-step-4" class="setup-step hidden text-center max-w-md mx-auto pb-20 pt-4">
                    
                    <div class="mb-10">
                        <h1 class="text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-600 via-purple-600 to-pink-600 tracking-tight drop-shadow-sm">Toss Time</h1>
                        <p class="text-gray-500 font-bold text-xs uppercase tracking-[0.2em] mt-2">Who won the coin toss?</p>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-5 mb-10">
                        <div id="toss-winner-team1" onclick="selectTossWinner('team1')" 
                             class="toss-card-btn group relative flex flex-col items-center justify-center p-5 bg-white border-2 border-transparent rounded-3xl shadow-[0_10px_30px_-10px_rgba(0,0,0,0.1)] cursor-pointer transition-all duration-300 hover:scale-[1.03] active:scale-95 h-48">
                            <div class="absolute inset-0 bg-gradient-to-br from-blue-50 to-purple-50 opacity-0 group-hover:opacity-100 rounded-3xl transition-opacity"></div>
                            <div id="toss-team1-logo-container" class="relative z-10 w-20 h-20 rounded-full shadow-lg mb-4 overflow-hidden bg-white flex items-center justify-center border-4 border-white"></div>
                            <span id="toss-team1-name" class="relative z-10 font-black text-gray-800 text-sm uppercase tracking-wide truncate w-full px-2">Home</span>
                            
                            <div class="absolute -top-3 -right-3 w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white shadow-lg opacity-0 check-icon transition-all duration-300 transform scale-50"><svg class="w-5 h-5 fill-current" viewBox="0 0 20 20"><path d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"/></svg></div>
                        </div>

                        <div id="toss-winner-team2" onclick="selectTossWinner('team2')" 
                             class="toss-card-btn group relative flex flex-col items-center justify-center p-5 bg-white border-2 border-transparent rounded-3xl shadow-[0_10px_30px_-10px_rgba(0,0,0,0.1)] cursor-pointer transition-all duration-300 hover:scale-[1.03] active:scale-95 h-48">
                            <div class="absolute inset-0 bg-gradient-to-br from-orange-50 to-red-50 opacity-0 group-hover:opacity-100 rounded-3xl transition-opacity"></div>
                            <div id="toss-team2-logo-container" class="relative z-10 w-20 h-20 rounded-full shadow-lg mb-4 overflow-hidden bg-white flex items-center justify-center border-4 border-white"></div>
                            <span id="toss-team2-name" class="relative z-10 font-black text-gray-800 text-sm uppercase tracking-wide truncate w-full px-2">Away</span>
                            
                            <div class="absolute -top-3 -right-3 w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white shadow-lg opacity-0 check-icon transition-all duration-300 transform scale-50"><svg class="w-5 h-5 fill-current" viewBox="0 0 20 20"><path d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"/></svg></div>
                        </div>
                    </div>

                    <p class="mb-4 text-gray-400 text-xs font-bold uppercase tracking-widest">Decision</p>
                    <div class="grid grid-cols-2 gap-4 mb-10">
                        <button id="toss-choice-bat" onclick="selectTossChoice('bat')" class="decision-btn relative overflow-hidden py-4 rounded-2xl border-2 border-gray-100 hover:border-orange-200 bg-white transition-all duration-300 group">
                            <div class="absolute inset-0 bg-gradient-to-r from-yellow-100 to-orange-100 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                            <span class="relative z-10 flex items-center justify-center gap-2 text-gray-500 group-hover:text-orange-600 font-black text-lg uppercase">
                                <span>üèè</span> Bat
                            </span>
                        </button>
                        <button id="toss-choice-bowl" onclick="selectTossChoice('bowl')" class="decision-btn relative overflow-hidden py-4 rounded-2xl border-2 border-gray-100 hover:border-blue-200 bg-white transition-all duration-300 group">
                            <div class="absolute inset-0 bg-gradient-to-r from-blue-100 to-cyan-100 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                            <span class="relative z-10 flex items-center justify-center gap-2 text-gray-500 group-hover:text-blue-600 font-black text-lg uppercase">
                                <span>‚öæ</span> Bowl
                            </span>
                        </button>
                    </div>

                    <div class="mb-8">
                         <button id="btn-broadcast-enable" onclick="generateBroadcastCode()" class="group relative w-full py-5 bg-white border-2 border-gray-100 text-gray-600 rounded-2xl shadow-sm hover:shadow-xl hover:border-green-400 transition-all duration-300 active:scale-95 flex flex-col items-center justify-center overflow-hidden">
                            <div class="absolute inset-0 bg-gradient-to-r from-emerald-50 to-teal-50 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                            <div class="relative z-10 flex items-center gap-3">
                                <span class="text-3xl filter grayscale group-hover:grayscale-0 transition-all">üì°</span>
                                <div class="text-left">
                                    <span class="block text-base font-black tracking-wide group-hover:text-green-700 uppercase">Enable Live Broadcast</span>
                                    <span class="block text-[10px] text-gray-400 font-bold group-hover:text-green-600 uppercase tracking-wider">Required to start</span>
                                </div>
                            </div>
                        </button>
                        
                        <div id="broadcast-display" class="hidden mt-6 animate-pop">
                            <div class="bg-gradient-to-br from-gray-900 to-black rounded-3xl p-6 shadow-2xl flex flex-col items-center border border-gray-800 ring-4 ring-gray-100">
                                <p class="text-[10px] text-emerald-400 font-bold uppercase mb-2 tracking-[0.3em]">Camera Code</p>
                                <div id="match-code-box" class="text-6xl font-mono font-black text-white tracking-widest cursor-pointer hover:text-emerald-300 transition-colors drop-shadow-[0_0_10px_rgba(52,211,153,0.5)]" onclick="copyBroadcastLink()">0000</div>
                                <p id="copy-feedback" class="text-xs text-gray-500 font-bold mt-3 hidden">Copied to clipboard!</p>
                            </div>
                        </div>
                    </div>

                    <button id="start-match-btn" disabled class="w-full py-6 bg-gray-200 text-gray-400 font-black rounded-3xl text-xl shadow-none transition-all duration-300 cursor-not-allowed uppercase tracking-widest mb-12" onclick="startMatch()">
                        Start Match
                    </button>

                    <style>
                        /* Selected Team Card */
                        .toss-card-btn.selected { 
                            border-color: #3b82f6 !important; 
                            background: linear-gradient(135deg, #eff6ff 0%, #ffffff 100%) !important;
                            box-shadow: 0 20px 40px -10px rgba(59, 130, 246, 0.25) !important;
                        }
                        .toss-card-btn.selected .check-icon { opacity: 1; transform: scale(1); }
                        .toss-card-btn.selected #toss-team1-name, .toss-card-btn.selected #toss-team2-name { color: #1d4ed8; }

                        /* Selected Decision Buttons */
                        #toss-choice-bat.selected {
                            background: linear-gradient(135deg, #fff7ed 0%, #ffedd5 100%) !important;
                            border-color: #f97316 !important;
                            box-shadow: 0 10px 20px -5px rgba(249, 115, 22, 0.3) !important;
                        }
                        #toss-choice-bat.selected span { color: #c2410c !important; }

                        #toss-choice-bowl.selected {
                            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%) !important;
                            border-color: #2563eb !important;
                            box-shadow: 0 10px 20px -5px rgba(37, 99, 235, 0.3) !important;
                        }
                        #toss-choice-bowl.selected span { color: #1e40af !important; }

                        /* Active Start Button */
                        #start-match-btn:not([disabled]) { 
                            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%) !important; 
                            color: white !important; 
                            box-shadow: 0 20px 40px -10px rgba(124, 58, 237, 0.5) !important; 
                            cursor: pointer; 
                            transform: translateY(-2px);
                        }
                        #start-match-btn:not([disabled]):active { transform: scale(0.98); }
                    </style>
                </div>
            </div>
        </div>
    </div>

    <div id="app" class="h-screen w-full flex flex-col hidden bg-gray-100">
        <div id="match-header" class="bg-white border-b border-gray-200 p-2 text-center shadow-sm z-10"></div>

        <div class="flex-grow flex flex-col lg:flex-row overflow-hidden">
            <div class="flex-grow flex flex-col p-2 lg:p-4 gap-2 overflow-y-auto">
                <div id="scoreboard" class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden">
                    <div id="team-scores-container" class="flex flex-col"></div>
                </div>

                <div class="bg-white rounded-lg shadow border border-gray-100 overflow-hidden">
                    <table class="w-full text-left text-xs">
                        <thead class="bg-gray-100 text-gray-600 border-b">
                            <tr>
                                <th class="p-2 w-1/2 flex items-center justify-between">
                                    <span>Batting</span>
                                    <button onclick="manualSwap()" class="bg-blue-100 hover:bg-blue-200 text-blue-700 text-[10px] px-2 py-1 rounded border border-blue-300 font-bold shadow-sm transition-transform active:scale-95">‚áÑ Swap</button>
                                </th>
                                <th class="p-2 text-center">R</th>
                                <th class="p-2 text-center">B</th>
                                <th class="p-2 text-center">4s</th>
                                <th class="p-2 text-center">6s</th>
                                <th class="p-2 text-right">SR</th>
                            </tr>
                        </thead>
                        <tbody id="batting-table" class="divide-y divide-gray-50"></tbody>
                    </table>
                </div>
                
                <div class="bg-white rounded-lg shadow border border-gray-100 overflow-hidden">
                    <table class="w-full text-left text-xs">
                        <thead class="bg-gray-100 text-gray-500 border-b">
                            <tr class="text-[10px] uppercase tracking-wider">
                                <th class="py-1 px-2 w-1/2">Bowling</th>
                                <th class="py-1 text-center">O</th>
                                <th class="py-1 text-center">M</th>
                                <th class="py-1 text-center">R</th>
                                <th class="py-1 text-center">W</th>
                                <th class="py-1 text-right pr-2">Eco</th>
                            </tr>
                        </thead>
                        <tbody id="bowling-table" class="divide-y divide-gray-50"></tbody>
                    </table>
                </div>
            </div>

            <div class="flex-shrink-0 lg:w-96 bg-white border-t lg:border-l border-gray-200 flex flex-col z-20">

                <div class="scoring-grid h-64 lg:h-auto lg:flex-grow">
                    <button onclick="addRuns(0)" class="watery-btn btn-grey font-bold text-xl">0</button>
                    <button onclick="addRuns(1)" class="watery-btn btn-grey font-bold text-xl">1</button>
                    <button onclick="addRuns(2)" class="watery-btn btn-grey font-bold text-xl">2</button>
                    <button onclick="addRuns(3)" class="watery-btn btn-grey font-bold text-xl">3</button>

                    <button onclick="undoLastAction()" id="undo-btn" class="watery-btn btn-yellow font-bold text-sm">UNDO</button>
                    <button onclick="addRuns(4)" class="watery-btn btn-sky font-bold text-2xl">4</button>
                    <button onclick="addRuns(6)" class="watery-btn btn-green font-bold text-2xl">6</button>
                    <button onclick="addRuns(5)" class="watery-btn btn-grey font-bold text-xl">5</button>

                    <button id="btn-wicket" onclick="openWicketModal()" class="watery-btn btn-red font-bold text-lg col-span-1">WKT</button>
                    <button onclick="openModal('wide-modal')" class="watery-btn btn-dark-grey font-bold text-sm">WD</button>
                    <button onclick="openModal('noball-modal')" class="watery-btn btn-dark-grey font-bold text-sm">NB</button>
                    <button onclick="openModal('extras-modal')" class="watery-btn btn-dark-grey font-bold text-sm">EXT</button>
                </div>

                <div class="p-2 bg-gray-50 flex justify-around border-t">
                    <button onclick="confirmExit()" class="text-xs font-bold uppercase tracking-wider text-red-600">Exit Match</button>
<button onclick="openViewControlModal()" class="text-xs font-bold uppercase tracking-wider text-white bg-indigo-600 px-4 py-2 rounded-full border border-indigo-700 shadow-lg hover:bg-indigo-700">üì∫ BROADCAST VIEWS</button>                </div>
            </div>
        </div>
    </div>

    <div id="opening-pair-modal" class="modal-overlay fixed inset-0 bg-black/80 backdrop-blur-sm hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-2xl p-6 w-full max-w-lg shadow-2xl m-4">
            <h3 class="text-xl font-bold mb-6 text-center text-blue-900">Select Batting Pair</h3>
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1 uppercase text-center">Striker</label>
                    <select id="pair-striker-select" class="w-full p-3 bg-blue-50 border border-blue-200 rounded-xl font-bold text-gray-800 focus:ring-2 focus:ring-blue-500 outline-none text-sm text-center" onchange="updatePairExclusions()"></select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1 uppercase text-center">Non-Striker</label>
                    <select id="pair-nonstriker-select" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl font-bold text-gray-800 focus:ring-2 focus:ring-blue-500 outline-none text-sm text-center" onchange="updatePairExclusions()"></select>
                </div>
            </div>
            <button onclick="confirmOpeningPair()" class="w-full py-4 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl shadow-lg transition-all transform active:scale-95">Confirm Batting Pair</button>
        </div>
    </div>

    <div id="player-modal" class="modal-overlay fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-50 flex items-center justify-center">
    <div class="modal-content bg-white rounded-2xl p-6 w-80 shadow-2xl relative">
        <button onclick="cancelPlayerSelection()" class="absolute top-3 right-4 text-red-600 hover:text-red-800 font-black text-xl transition-transform hover:scale-110">
            ‚úï
        </button>

        <h3 id="modal-title" class="text-lg font-bold mb-4 text-center mt-2">Select Player</h3>
        <select id="player-select" class="w-full p-3 bg-gray-50 border rounded-xl mb-4 text-lg outline-none focus:ring-2 focus:ring-blue-500"></select>
        <button id="player-save-btn" class="w-full py-3 bg-blue-600 text-white font-bold rounded-xl shadow-lg active:scale-95 transition-transform">Confirm</button>
    </div>
</div>

    <div id="wicket-type-modal" class="modal-overlay fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-50 flex items-center justify-center">
    <div class="modal-content bg-white rounded-2xl p-6 w-80 shadow-2xl text-center max-h-[90vh] overflow-y-auto">
        <h3 id="wicket-modal-title" class="text-xl font-black text-red-600 mb-4 uppercase tracking-wider">Wicket Type</h3>
        
        <div class="grid grid-cols-2 gap-3 text-sm">
            <button onclick="processIndoorWicket('Bowled')" class="p-4 bg-red-50 hover:bg-red-100 text-red-900 font-bold rounded-xl border border-red-200">BOWLED</button>
            <button onclick="setupFielderSelect('Catch')" class="p-4 bg-blue-50 hover:bg-blue-100 text-blue-900 font-bold rounded-xl border border-blue-200">CATCH</button>
            
            <button onclick="processIndoorWicket('LBW')" class="p-3 bg-gray-50 hover:bg-gray-100 font-bold rounded-xl border border-gray-200">LBW</button>
            <button onclick="processIndoorWicket('Run Out')" class="p-3 bg-orange-50 hover:bg-orange-100 text-orange-900 font-bold rounded-xl border border-orange-200">RUN OUT</button>
            
            <button onclick="setupFielderSelect('Stumped')" class="p-3 bg-purple-50 hover:bg-purple-100 text-purple-900 font-bold rounded-xl border border-purple-200">STUMPED</button>
            <button onclick="processIndoorWicket('Hit Wicket')" class="p-3 bg-gray-50 hover:bg-gray-100 font-bold rounded-xl border border-gray-200">HIT WKT</button>
            
            <button onclick="processIndoorWicket('Retired Out')" class="p-3 bg-gray-50 hover:bg-gray-100 font-bold rounded-xl border border-gray-200">Retired</button>
            <button onclick="processIndoorWicket('Other')" class="p-3 bg-gray-50 hover:bg-gray-100 font-bold rounded-xl border border-gray-200">Other</button>
        </div>
        
        <button onclick="closeModal('wicket-type-modal')" class="mt-5 text-gray-400 text-xs font-bold uppercase tracking-widest hover:text-gray-600">Cancel</button>
    </div>
</div>

<div id="fielder-modal" class="modal-overlay fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-[60] flex items-center justify-center">
    <div class="modal-content bg-white rounded-2xl p-6 w-80 shadow-2xl relative">
        <button onclick="closeModal('fielder-modal')" class="absolute top-3 right-4 text-gray-400 hover:text-gray-600 font-bold text-xl">‚úï</button>
        
        <h3 id="fielder-modal-title" class="text-lg font-bold mb-4 text-center text-blue-900">Select Fielder</h3>
        <select id="fielder-select" class="w-full p-3 bg-gray-50 border rounded-xl mb-4 text-lg outline-none focus:ring-2 focus:ring-blue-500"></select>
        
        <button onclick="confirmFielder()" class="w-full py-3 bg-blue-600 text-white font-bold rounded-xl shadow-lg active:scale-95 transition-transform">Confirm</button>
    </div>
</div>

    <div id="runout-modal" class="modal-overlay fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-50 flex items-center justify-center">
        <div class="modal-content bg-white rounded-2xl p-6 w-80 shadow-2xl text-center">
            <h3 class="text-xl font-bold text-red-600 mb-4">Who is Out?</h3>
            <div class="grid grid-cols-1 gap-3">
                <button id="btn-ro-striker" onclick="finalizeRunOut('striker')" class="p-4 bg-gray-100 font-bold rounded-xl text-md hover:bg-red-50 border border-gray-200 text-gray-800">Striker</button>
                <button id="btn-ro-nonstriker" onclick="finalizeRunOut('nonstriker')" class="p-4 bg-gray-100 font-bold rounded-xl text-md hover:bg-red-50 border border-gray-200 text-gray-800">Non-Striker</button>
            </div>
            <button onclick="closeModal('runout-modal')" class="mt-4 text-gray-400 text-sm">Cancel</button>
        </div>
    </div>

    <div id="broadcast-control-modal" class="modal-overlay fixed inset-0 bg-black/80 backdrop-blur-sm hidden z-[100] flex items-center justify-center">
        <div class="bg-white rounded-3xl p-6 w-80 shadow-2xl text-center border border-gray-200">
            <h3 class="text-lg font-bold text-gray-900 mb-2 uppercase tracking-wide">Broadcast Views</h3>
            <p class="text-[10px] text-gray-400 mb-6 font-semibold uppercase tracking-wider">Toggle to Show on Stream</p>
            
            <div class="space-y-4 bg-gray-50 p-4 rounded-2xl">
                <div class="flex items-center justify-between">
                    <span class="text-sm font-bold text-gray-700">Playing Squad</span>
                    <input type="checkbox" class="ios-toggle" id="toggle-squad" onchange="toggleView('SQUAD', this)">
                </div>
                
                <div class="flex items-center justify-between border-t border-gray-200 pt-4">
                    <span class="text-sm font-bold text-gray-700">Batting Card</span>
                    <input type="checkbox" class="ios-toggle" id="toggle-batting" onchange="toggleView('BATTING', this)">
                </div>

                <div class="flex items-center justify-between border-t border-gray-200 pt-4">
                    <span class="text-sm font-bold text-gray-700">Bowling Card</span>
                    <input type="checkbox" class="ios-toggle" id="toggle-bowling" onchange="toggleView('BOWLING', this)">
                </div>
            </div>
            
            <button onclick="closeModal('broadcast-control-modal')" class="mt-6 w-full py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold rounded-xl text-sm transition-colors">Close Menu</button>
        </div>
    </div>

    <div id="wide-modal" class="modal-overlay fixed inset-0 bg-black/50 hidden z-50 flex items-end justify-center" onclick="closeModal('wide-modal')">
        <div class="bg-white w-full max-w-md p-6 rounded-t-2xl shadow-xl mb-0" onclick="event.stopPropagation()">
            <h3 class="font-bold text-center mb-4">Wide Ball</h3>
            <div class="grid grid-cols-3 gap-3" id="wide-options"></div>
        </div>
    </div>

    <div id="noball-modal" class="modal-overlay fixed inset-0 bg-black/50 hidden z-50 flex items-end justify-center" onclick="closeModal('noball-modal')">
        <div class="bg-white w-full max-w-md p-6 rounded-t-2xl shadow-xl mb-0" onclick="event.stopPropagation()">
            <h3 class="font-bold text-center mb-4">No Ball</h3>
            <div class="grid grid-cols-3 gap-3" id="noball-options"></div>
        </div>
    </div>
    
    <div id="extras-modal" class="modal-overlay fixed inset-0 bg-black/50 hidden z-50 flex items-end justify-center" onclick="closeModal('extras-modal')">
        <div class="bg-white w-full max-w-md p-6 rounded-t-2xl shadow-xl mb-0" onclick="event.stopPropagation()">
            <h3 class="font-bold text-center mb-4">Extras</h3>
            <div class="grid grid-cols-3 gap-3">
                <button onclick="addExtra('ext', 1)" class="p-4 bg-gray-100 font-bold rounded-xl text-lg">1</button>
                <button onclick="addExtra('ext', 2)" class="p-4 bg-gray-100 font-bold rounded-xl text-lg">2</button>
                <button onclick="addExtra('ext', 3)" class="p-4 bg-gray-100 font-bold rounded-xl text-lg">3</button>
                <button onclick="addExtra('ext', 4)" class="p-4 bg-gray-100 font-bold rounded-xl text-lg">4</button>
                <button onclick="addExtra('ext', 5)" class="p-4 bg-gray-100 font-bold rounded-xl text-lg">5</button>
                <button onclick="addExtra('ext', 6)" class="p-4 bg-gray-100 font-bold rounded-xl text-lg">6</button>
            </div>
        </div>
    </div>

    <div id="pair-change-modal" class="modal-overlay fixed inset-0 bg-black/70 hidden z-50 flex items-center justify-center">
        <div class="modal-content bg-white rounded-xl p-6 w-80 text-center">
            <h3 class="text-xl font-bold text-blue-800 mb-2">Skin Complete!</h3>
            <p class="text-sm text-gray-600 mb-4">Time to swap the batting pair.</p>
            <button onclick="performPairSwap()" class="w-full py-3 bg-blue-600 text-white font-bold rounded-lg shadow-lg">Select New Pair</button>
        </div>
    </div>

    <div id="innings-break-modal" class="modal-overlay fixed inset-0 bg-slate-900/95 hidden z-[100] flex items-center justify-center text-white backdrop-blur-sm">
        <div class="text-center w-full max-w-3xl p-4">
            <h2 class="text-sm font-bold tracking-[0.3em] text-blue-400 mb-8 uppercase animate-pulse">Innings Break</h2>
            
            <div class="bg-gradient-to-b from-blue-800 to-blue-900 rounded-3xl p-8 md:p-12 border border-blue-700 shadow-2xl relative overflow-hidden">
                <div class="absolute top-0 left-1/2 -translate-x-1/2 w-64 h-64 bg-blue-500/20 rounded-full blur-3xl pointer-events-none"></div>

                <div class="relative z-10">
                    <div class="mb-2 text-blue-200 text-xs font-bold uppercase tracking-wider">First Innings Score</div>
                    <h1 id="ib-batting-team" class="text-3xl md:text-5xl font-black mb-2 uppercase text-white drop-shadow-md tracking-tight">TEAM NAME</h1>
                    
                    <div class="text-6xl md:text-8xl font-black text-white mb-2 tracking-tighter" style="text-shadow: 0 4px 0px rgba(0,0,0,0.3);">
                        <span id="ib-score">0</span><span class="text-4xl text-blue-400 mx-1">/</span><span id="ib-wickets">0</span>
                    </div>
                    
                    <div class="inline-flex items-center gap-2 bg-blue-950/50 px-4 py-1.5 rounded-full border border-blue-800 mb-8">
                        <span class="text-blue-300 text-xs font-bold uppercase">Overs Bowled</span>
                        <span id="ib-overs" class="text-white font-mono font-bold">0.0</span>
                    </div>

                    <div class="w-full h-px bg-gradient-to-r from-transparent via-blue-400/30 to-transparent my-6"></div>

                    <div class="flex flex-col items-center">
                        <span class="text-xs font-bold text-yellow-400 uppercase tracking-[0.2em] mb-1">Target to Win</span>
                        <span id="ib-target" class="text-5xl md:text-7xl font-black text-white">0</span>
                    </div>
                </div>
            </div>

            <button onclick="startSecondInnings()" class="mt-8 px-12 py-4 bg-white text-blue-900 font-black text-lg rounded-full shadow-[0_0_20px_rgba(255,255,255,0.3)] hover:scale-105 active:scale-95 transition-all uppercase tracking-wider">
                Start 2nd Innings ‚Üí
            </button>
        </div>
    </div>

    <div id="match-summary-modal" class="fixed inset-0 z-[100] hidden bg-gradient-to-br from-indigo-900 via-purple-900 to-blue-900 overflow-y-auto">
    <div class="absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none">
        <div class="absolute top-[-10%] left-[-10%] w-96 h-96 bg-purple-500 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob"></div>
        <div class="absolute top-[-10%] right-[-10%] w-96 h-96 bg-yellow-500 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob animation-delay-2000"></div>
        <div class="absolute bottom-[-20%] left-[20%] w-96 h-96 bg-pink-500 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob animation-delay-4000"></div>
    </div>

    <div class="relative z-10 min-h-screen flex flex-col items-center justify-center p-4 md:p-8">
        
        <div class="text-center mb-8 animate-pop">
            <h2 class="text-xs font-bold text-yellow-300 tracking-[0.3em] uppercase mb-2">Match Result</h2>
            <h1 id="summary-winner-text" class="text-5xl md:text-7xl font-black text-transparent bg-clip-text bg-gradient-to-r from-yellow-200 via-yellow-400 to-yellow-200 drop-shadow-sm uppercase leading-tight">
                WINNER
            </h1>
            <div id="summary-margin-text" class="inline-block mt-2 px-4 py-1 bg-white/10 backdrop-blur-md rounded-full border border-white/20 text-white font-bold tracking-wider text-sm">
                WON BY ...
            </div>
        </div>

        <div class="w-full max-w-4xl grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
            <div id="card-t1" class="bg-white/10 backdrop-blur-lg border border-white/20 rounded-2xl p-6 flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div id="sum-t1-logo" class="w-16 h-16 rounded-full bg-white/20 shadow-lg flex items-center justify-center text-xl font-black text-white overflow-hidden"></div>
                    <div>
                        <h3 id="sum-t1-name" class="text-white/70 font-bold uppercase text-xs tracking-widest">TEAM 1</h3>
                        <div id="sum-t1-score" class="text-3xl font-black text-white">0/0</div>
                    </div>
                </div>
                <div id="sum-t1-overs" class="text-right text-white/50 font-mono font-bold">0.0</div>
            </div>

            <div id="card-t2" class="bg-white/10 backdrop-blur-lg border border-white/20 rounded-2xl p-6 flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div id="sum-t2-logo" class="w-16 h-16 rounded-full bg-white/20 shadow-lg flex items-center justify-center text-xl font-black text-white overflow-hidden"></div>
                    <div>
                        <h3 id="sum-t2-name" class="text-white/70 font-bold uppercase text-xs tracking-widest">TEAM 2</h3>
                        <div id="sum-t2-score" class="text-3xl font-black text-white">0/0</div>
                    </div>
                </div>
                <div id="sum-t2-overs" class="text-right text-white/50 font-mono font-bold">0.0</div>
            </div>
        </div>

        <div class="w-full max-w-4xl grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            
            <div class="bg-black/20 backdrop-blur-md rounded-2xl p-5 border border-white/10">
                <h4 class="text-yellow-400 font-black uppercase text-xs tracking-widest mb-4 flex items-center gap-2">
                    <span>üèè</span> Top Batters
                </h4>
                <div id="sum-top-batters" class="space-y-3"></div>
            </div>

            <div class="bg-black/20 backdrop-blur-md rounded-2xl p-5 border border-white/10">
                <h4 class="text-blue-400 font-black uppercase text-xs tracking-widest mb-4 flex items-center gap-2">
                    <span>‚öæ</span> Top Bowlers
                </h4>
                <div id="sum-top-bowlers" class="space-y-3"></div>
            </div>

            <div class="bg-gradient-to-b from-yellow-500/20 to-orange-500/20 backdrop-blur-md rounded-2xl p-5 border border-yellow-500/30">
                <h4 class="text-white font-black uppercase text-xs tracking-widest mb-4 flex items-center gap-2">
                    <span>üèÜ</span> Man of the Match
                </h4>
                <div id="sum-pom-list" class="space-y-2 max-h-48 overflow-y-auto custom-scroll"></div>
            </div>
        </div>

        <div class="flex flex-col md:flex-row gap-4 w-full max-w-xl">
            <button onclick="broadcastMatchResult()" class="flex-1 py-4 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-400 hover:to-emerald-500 text-white font-black uppercase tracking-wider rounded-xl shadow-lg shadow-green-900/50 transition-all active:scale-95 flex items-center justify-center gap-2">
                <span>üì° Broadcast Result</span>
            </button>
            <div class="flex gap-2 flex-1">
                <button onclick="closeModal('match-summary-modal')" class="flex-1 py-4 bg-white/10 hover:bg-white/20 text-white font-bold uppercase rounded-xl border border-white/10">
                    Close
                </button>
                <button onclick="location.reload()" class="flex-1 py-4 bg-blue-600 hover:bg-blue-500 text-white font-bold uppercase rounded-xl shadow-lg">
                    New Match
                </button>
            </div>
        </div>

    </div>
</div>

    <script>
        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyBqcD59IAPpKqk98oDZkgzgkoVZ8b8LGgY",
            authDomain: "livecricketscoring-92087.firebaseapp.com",
            databaseURL: "https://livecricketscoring-92087-default-rtdb.firebaseio.com",
            projectId: "livecricketscoring-92087",
            storageBucket: "livecricketscoring-92087.firebasestorage.app",
            messagingSenderId: "522927197627",
            appId: "1:522927197627:web:f1df5db736cae96893089e"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- DOM Elements ---
        const ui = {
            venueInput: document.getElementById('venue'),
            matchDateInput: document.getElementById('match-date-input'),
            totalOversInput: document.getElementById('total-overs'),
            playersPerSideInput: document.getElementById('players-per-side'),
            team1NameInput: document.getElementById('team1-name-input'),
            team2NameInput: document.getElementById('team2-name-input'),
            team1LogoInput: document.getElementById('team1-logo-input'),
            team2LogoInput: document.getElementById('team2-logo-input'),
            team1RosterTitle: document.getElementById('team1-roster-title'),
            team2RosterTitle: document.getElementById('team2-roster-title'),
            progressBar: document.getElementById('progress-bar'),
            tossTeam1Name: document.getElementById('toss-team1-name'),
            tossTeam2Name: document.getElementById('toss-team2-name'),
            tossTeam1LogoContainer: document.getElementById('toss-team1-logo-container'),
            tossTeam2LogoContainer: document.getElementById('toss-team2-logo-container'),
            tossWinnerTeam1: document.getElementById('toss-winner-team1'),
            tossWinnerTeam2: document.getElementById('toss-winner-team2'),
            tossChoiceBat: document.getElementById('toss-choice-bat'),
            tossChoiceBowl: document.getElementById('toss-choice-bowl'),
            startMatchBtn: document.getElementById('start-match-btn')
        };

        // --- STATE & HISTORY ---
        let state = {
            rules: { wicketRuns: 5, wideRuns: 2, noBallRuns: 2, skins: false },
            team1: { name: "", logo: "", squad: [], playing: [], playerStats: {}, isLoaded: false },
            team2: { name: "", logo: "", squad: [], playing: [], playerStats: {}, isLoaded: false },
            battingTeam: 'team1', bowlingTeam: 'team2',
            striker: null, nonStriker: null, bowler: null,
            id: null, innings: 1, target: 0, totalOvers: 16, playersPerSide: 8,
            currentOver: [], history: []
        };
        
        let undoStack = []; 

        let tossWinner = null, tossDecision = null;
        let broadcastId = null;
        let savedTeamsData = [];

        // --- INITIALIZATION ---
        window.onload = function() {
            const today = new Date();
            ui.matchDateInput.value = today.toISOString().split('T')[0];
            
            // Populate Range Options (Strict)
            const oversSelect = document.getElementById('total-overs');
            const defOvers = document.createElement('option'); defOvers.value = ""; defOvers.text = "Select Overs..."; defOvers.selected = true; defOvers.disabled = true;
            oversSelect.appendChild(defOvers);
            for(let i=3; i<=15; i++) {
                const opt = document.createElement('option'); opt.value = i; opt.text = i + ' Overs';
                oversSelect.appendChild(opt);
            }

            const playersSelect = document.getElementById('players-per-side');
            const defPlayers = document.createElement('option'); defPlayers.value = ""; defPlayers.text = "Select Players..."; defPlayers.selected = true; defPlayers.disabled = true;
            playersSelect.appendChild(defPlayers);
            for(let i=4; i<=11; i++) {
                const opt = document.createElement('option'); opt.value = i; opt.text = i + ' Players';
                playersSelect.appendChild(opt);
            }
            
            // Wicket Options (Updated: Includes 0)
            const wicketSelect = document.getElementById('rule-wicket');
            for(let i=0; i<=6; i++) {
                const opt = document.createElement('option'); 
                opt.value = i; 
                opt.text = (i === 0) ? "No Penalty (0)" : `-${i} Runs`;
                wicketSelect.appendChild(opt);
            }

            loadSavedTeams();
            showScreen('setup-screen');
        };

        function showScreen(id) {
            document.querySelectorAll('body > div').forEach(d => {
                if(d.id !== 'splash-screen' && !d.classList.contains('modal-overlay')) d.classList.add('hidden');
            });
            const el = document.getElementById(id);
            if(el) { el.classList.remove('hidden'); if(id==='app') el.classList.add('flex'); }
        }
        function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        
        function openWicketModal() { openModal('wicket-type-modal'); }

        function generateUniqueId() { return 'p_' + Math.random().toString(36).substr(2, 9); }

        function getTeamInitials(name) {
            if (!name) return '??';
            const parts = name.trim().split(/\s+/);
            if (parts.length === 1) return name.substring(0, 2).toUpperCase();
            return parts.map(p => p[0]).join('').substring(0, 3).toUpperCase();
        }

        // --- DATA LOADING & SETUP LOGIC ---
        function loadSavedTeams() {
            db.collection("teams").orderBy("updatedAt", "desc").get().then((querySnapshot) => {
                savedTeamsData = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const players = (data.players || []).map(p => typeof p === 'string' ? { name: p } : p);
                    savedTeamsData.push({ id: doc.id, name: data.name, logo: data.logo, players: players });
                });
                populateTeamDropdowns();
            });
        }
        function populateTeamDropdowns() {
            ['team1-select', 'team2-select'].forEach(id => {
                const select = document.getElementById(id);
                select.innerHTML = '<option value="">+ Load Saved Team</option>';
                savedTeamsData.forEach(team => {
                    const opt = document.createElement('option');
                    opt.value = team.name;
                    opt.textContent = team.name;
                    select.appendChild(opt);
                });
                select.onchange = (e) => handleTeamSelection(e.target.value, id.includes('team1') ? 'team1' : 'team2');
            });
        }
        function handleTeamSelection(teamName, teamKey) {
            if(!teamName) return;
            const teamData = savedTeamsData.find(t => t.name === teamName);
            if(!teamData) return;
            document.getElementById(`${teamKey}-name-input`).value = teamData.name;
            state[teamKey].name = teamData.name;
            state[teamKey].logo = teamData.logo || '';
            state[teamKey].squad = teamData.players.map(p => ({...p, id: generateUniqueId()}));
            state[teamKey].isLoaded = true;
        }
        function handleLogoUpload(file, teamKey) {
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => { state[teamKey].logo = e.target.result; };
                reader.readAsDataURL(file);
            }
        }

        function goToStep(step) {
            // --- VALIDATION FOR STEP 2 ---
            if (step === 2) {
                const overs = document.getElementById('total-overs').value;
                const players = document.getElementById('players-per-side').value;
                const w = document.getElementById('rule-wicket').value;
                const wd = document.getElementById('rule-wide').value;
                const nb = document.getElementById('rule-noball').value;

                if (!overs || !players) {
                    alert("‚ö†Ô∏è MANDATORY: Please select Overs and Players per Side.");
                    return;
                }
                if (!w || !wd || !nb) {
                    alert("‚ö†Ô∏è MANDATORY: Please select Wicket Penalty, Wide, and No Ball rules to proceed.");
                    return;
                }

                state.rules.wicketRuns = parseInt(w);
                state.rules.wideRuns = parseInt(wd);
                state.rules.noBallRuns = parseInt(nb);
                state.rules.skins = false; 

                const t1Name = ui.team1NameInput.value.trim() || 'HOME TEAM';
                const t2Name = ui.team2NameInput.value.trim() || 'AWAY TEAM';

                if (!state.team1.isLoaded) {
                    state.team1.name = t1Name.toUpperCase();
                    handleLogoUpload(ui.team1LogoInput.files[0], 'team1');
                }
                if (!state.team2.isLoaded) {
                    state.team2.name = t2Name.toUpperCase();
                    handleLogoUpload(ui.team2LogoInput.files[0], 'team2');
                }

                ui.team1RosterTitle.textContent = state.team1.name;
                document.getElementById('team1-roster-logo').src = state.team1.logo || 'https://placehold.co/60x60/3b82f6/white?text=H';
                ui.team2RosterTitle.textContent = state.team2.name;
                document.getElementById('team2-roster-logo').src = state.team2.logo || 'https://placehold.co/60x60/64748b/white?text=A';
                generateUnifiedRoster('team1');
                generateUnifiedRoster('team2');
            }

            document.querySelectorAll('.setup-step').forEach(s => { s.classList.remove('active'); s.classList.add('hidden'); });
            const next = document.getElementById(`setup-step-${step}`);
            next.classList.remove('hidden');
            setTimeout(() => next.classList.add('active'), 10);
            
            ui.progressBar.style.width = `${step * 33}%`;

            if(step === 4) {
                //prepareTossStep(); // REMOVED: Button is now controlled by checkStartReady
                ui.tossTeam1Name.textContent = state.team1.name;
                if (state.team1.logo) {
                    ui.tossTeam1LogoContainer.innerHTML = `<img src="${state.team1.logo}" class="w-full h-full object-cover rounded-full border-2 border-white shadow-sm">`;
                    ui.tossTeam1LogoContainer.style.backgroundColor = 'transparent';
                } else {
                    ui.tossTeam1LogoContainer.style.backgroundColor = '#3b82f6';
                    ui.tossTeam1LogoContainer.innerHTML = `<span class="text-xl font-bold text-white tracking-wider">${getTeamInitials(state.team1.name)}</span>`;
                }
                ui.tossTeam2Name.textContent = state.team2.name;
                if (state.team2.logo) {
                    ui.tossTeam2LogoContainer.innerHTML = `<img src="${state.team2.logo}" class="w-full h-full object-cover rounded-full border-2 border-white shadow-sm">`;
                    ui.tossTeam2LogoContainer.style.backgroundColor = 'transparent';
                } else {
                    ui.tossTeam2LogoContainer.style.backgroundColor = '#ef4444'; 
                    ui.tossTeam2LogoContainer.innerHTML = `<span class="text-xl font-bold text-white tracking-wider">${getTeamInitials(state.team2.name)}</span>`;
                }
            }
        }

        function generateUnifiedRoster(teamKey) {
            const container = document.getElementById(`${teamKey}-player-inputs`);
            const countBadge = document.getElementById(`${teamKey}-count-badge`);
            container.innerHTML = '';
            const required = parseInt(ui.playersPerSideInput.value);
            
            if (state[teamKey].squad.length < required) {
                for(let i = state[teamKey].squad.length; i < required; i++) {
                    state[teamKey].squad.push({ id: generateUniqueId(), name: '', image: '' });
                }
            }

            let selectedCount = 0;
            
            state[teamKey].squad.forEach((player, index) => {
                const isSelected = state[teamKey].playing.length > 0 ? state[teamKey].playing.includes(player.id) : index < required;
                
                if (isSelected) {
                    if (!state[teamKey].playing.includes(player.id)) state[teamKey].playing.push(player.id);
                    selectedCount++;
                }

                const isCaptain = state[teamKey].captainId === player.id;

                const row = document.createElement('div');
                row.className = `roster-row ${isSelected ? 'selected' : ''}`;
                
                row.innerHTML = `
                    <div class="flex items-center gap-2">
                        <input type="checkbox" class="w-5 h-5 text-blue-600 rounded" 
                            onchange="togglePlayerSelection(this, '${teamKey}', '${player.id}')" ${isSelected ? 'checked' : ''}>
                        
                        <button onclick="setCaptain('${teamKey}', '${player.id}')" 
                            class="w-6 h-6 rounded-full text-[10px] font-bold border flex items-center justify-center transition-colors ${isCaptain ? 'bg-yellow-400 text-black border-yellow-500' : 'bg-gray-100 text-gray-400 border-gray-300'}" 
                            title="Set as Captain">
                            C
                        </button>
                    </div>

                    <div class="flex items-center gap-2 overflow-hidden">
                        <div class="relative group cursor-pointer" onclick="triggerImageUpload('${teamKey}', '${player.id}')">
                            <img id="img-${player.id}" src="${player.image || 'https://placehold.co/40x40/e2e8f0/gray?text=P'}" class="w-8 h-8 rounded-full border object-cover">
                            <div class="absolute inset-0 bg-black/50 hidden group-hover:flex items-center justify-center rounded-full">
                                <span class="text-[8px] text-white">üì∑</span>
                            </div>
                        </div>
                        
                        <input type="text" value="${player.name}" class="roster-input" 
                            onchange="updatePlayerName(this.value, '${teamKey}', '${player.id}')" placeholder="Player Name">
                    </div>

                    <button onclick="deletePlayerFromRoster('${teamKey}', '${player.id}')" class="text-gray-400 hover:text-red-500">üóëÔ∏è</button>
                    
                    <input type="file" id="file-${player.id}" class="hidden" accept="image/*" onchange="uploadPlayerImage(this, '${teamKey}', '${player.id}')">
                `;
                container.appendChild(row);
            });
            countBadge.textContent = `${selectedCount} / ${required} Playing`;
        }

        function updatePlayerName(newName, teamKey, playerId) {
            const player = state[teamKey].squad.find(p => p.id === playerId);
            if(player) player.name = newName.toUpperCase();
        }

        function togglePlayerSelection(checkbox, teamKey, playerId) {
            const row = checkbox.closest('.roster-row');
            const limit = parseInt(ui.playersPerSideInput.value); 

            if (checkbox.checked) {
                if (state[teamKey].playing.length >= limit) {
                    checkbox.checked = false; 
                    row.classList.add('bg-red-100', 'border-red-500'); 
                    setTimeout(() => {
                        row.classList.remove('bg-red-100', 'border-red-500');
                    }, 800);
                    return; 
                }
                row.classList.add('selected');
                if (!state[teamKey].playing.includes(playerId)) state[teamKey].playing.push(playerId);
            } else {
                row.classList.remove('selected');
                state[teamKey].playing = state[teamKey].playing.filter(id => id !== playerId);
            }
            generateUnifiedRoster(teamKey); 
        }

        function deletePlayerFromRoster(teamKey, playerId) {
            if(confirm("Delete player?")) {
                state[teamKey].squad = state[teamKey].squad.filter(p => p.id !== playerId);
                state[teamKey].playing = state[teamKey].playing.filter(id => id !== playerId);
                generateUnifiedRoster(teamKey);
            }
        }
        function addNewPlayerToRoster(teamKey) {
            const newId = generateUniqueId();
            state[teamKey].squad.push({ id: newId, name: '', image: '' });
            generateUnifiedRoster(teamKey);
        }
        function proceedFromUnifiedRoster() {
            const required = parseInt(ui.playersPerSideInput.value);
            if (state.team1.playing.length !== required) { alert(`Home Team needs exactly ${required} players.`); return; }
            if (state.team2.playing.length !== required) { alert(`Away Team needs exactly ${required} players.`); return; }
            
            ['team1', 'team2'].forEach(key => {
                state[key].playerStats = {};
                state[key].playing.forEach(pid => {
                    const p = state[key].squad.find(sq => sq.id === pid);
                    const pName = p && p.name ? p.name : "Player " + pid.substr(0,4);
                    state[key].playerStats[pid] = { id: pid, name: pName, runs: 0, balls: 0, wickets: 0, runsConceded: 0, ballsBowled: 0 };
                });
            });
            goToStep(4);
        }

        // --- TOSS & BROADCAST LOGIC (UPDATED) ---
        
        function selectTossWinner(w) {
            tossWinner = w;
            document.querySelectorAll('.toss-card-btn').forEach(b => b.classList.remove('selected'));
            document.getElementById(`toss-winner-${w}`).classList.add('selected');
            checkStartReady();
        }

        function selectTossChoice(c) {
            tossDecision = c;
            document.querySelectorAll('.decision-btn').forEach(b => b.classList.remove('selected'));
            document.getElementById(`toss-choice-${c}`).classList.add('selected');
            checkStartReady();
        }

        function generateBroadcastCode() {
            broadcastId = Math.floor(1000 + Math.random() * 9000).toString();
            const display = document.getElementById('broadcast-display');
            const codeBox = document.getElementById('match-code-box');
            display.classList.remove('hidden');
            codeBox.textContent = broadcastId;
            
            // Mark broadcast as enabled visually
            const btn = document.getElementById('btn-broadcast-enable');
            btn.classList.remove('bg-blue-50', 'text-blue-700');
            btn.classList.add('bg-green-100', 'text-green-800', 'border-green-300');
            btn.innerHTML = `<span class="text-lg">‚úÖ BROADCAST LIVE</span><span class="text-xs font-normal">Code: ${broadcastId}</span>`;
            
            syncToLiveDB();
            checkStartReady();
        }
        
        function checkStartReady() {
            const btn = document.getElementById('start-match-btn');
            if(tossWinner && tossDecision && broadcastId) {
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed', 'bg-gray-300');
                btn.classList.add('bg-blue-600', 'hover:bg-blue-700', 'shadow-lg');
            } else {
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed', 'bg-gray-300');
                btn.classList.remove('bg-blue-600', 'hover:bg-blue-700', 'shadow-lg');
            }
        }

        function copyBroadcastLink() {
            const code = document.getElementById('match-code-box').textContent;
            navigator.clipboard.writeText(code).then(() => {
                const fb = document.getElementById('copy-feedback');
                fb.classList.remove('hidden');
                setTimeout(() => fb.classList.add('hidden'), 2000);
            });
        }

        function syncToLiveDB(lastAction = null) {
            if (!broadcastId) return;

            const bt = state[state.battingTeam];
            const bl = state[state.bowlingTeam];
            const striker = state.striker || { name: "", runs: 0, balls: 0 };
            const nonStriker = state.nonStriker || { name: "", runs: 0, balls: 0 };
            const bowler = state.bowler || { name: "", wickets: 0, runsConceded: 0, ballsBowled: 0 };

            const t1Obj = state.team1;
            const t2Obj = state.team2;
            const t1CapPlayer = t1Obj.squad.find(p => p.id === t1Obj.captainId);
            const t2CapPlayer = t2Obj.squad.find(p => p.id === t2Obj.captainId);

            const payload = {
                venue: state.venue || document.getElementById('venue').value || "Unknown Ground",
                matchDate: document.getElementById('match-date-input').value || new Date().toDateString(),
                t1: t1Obj.name,
                t1Logo: t1Obj.logo || null,
                t1CaptainImg: t1CapPlayer ? t1CapPlayer.image : null, 
                t2: t2Obj.name,
                t2Logo: t2Obj.logo || null,
                t2CaptainImg: t2CapPlayer ? t2CapPlayer.image : null,
                score: bt.score || 0,
                wickets: bt.wickets || 0,
                overs: bt.overs || 0,
                balls: bt.balls || 0,
                target: state.target || 0, 
                totalOvers: state.totalOvers || 0,
                striker: { name: striker.name, runs: striker.runs, balls: striker.balls },
                nonStriker: { name: nonStriker.name, runs: nonStriker.runs, balls: nonStriker.balls },
                bowler: { 
                    name: bowler.name, 
                    wkts: bowler.wickets, 
                    runs: bowler.runsConceded,
                    balls: bowler.ballsBowled 
                }, 
                currentOver: state.currentOver.map(b => b.event), 
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };

            if (lastAction) {
                payload.lastAction = { id: Date.now(), type: lastAction };
            }

            db.collection("live_matches").doc(broadcastId).set(payload, { merge: true })
                .catch(err => console.error("Sync Error:", err));
        }

        function startMatch() {
            state.totalOvers = parseInt(ui.totalOversInput.value);
            state.playersPerSide = parseInt(ui.playersPerSideInput.value);
            state.venue = ui.venueInput.value;

            state.team1.score = 0; state.team1.wickets = 0; state.team1.overs = 0; state.team1.balls = 0;
            state.team2.score = 0; state.team2.wickets = 0; state.team2.overs = 0; state.team2.balls = 0;

            if ((tossWinner === 'team1' && tossDecision === 'bat') || (tossWinner === 'team2' && tossDecision === 'bowl')) {
                state.battingTeam = 'team1'; state.bowlingTeam = 'team2';
            } else {
                state.battingTeam = 'team2'; state.bowlingTeam = 'team1';
            }

            syncToLiveDB();

            state.rules.wicketRuns = parseInt(document.getElementById('rule-wicket').value); 
            
            document.getElementById('btn-wicket').textContent = `WKT (-${state.rules.wicketRuns})`;
            document.getElementById('wicket-modal-title').textContent = `WICKET! (-${state.rules.wicketRuns} Runs)`;
            
            const wVal = state.rules.wideRuns;
            const nbVal = state.rules.noBallRuns;

            let wButtons = `<button onclick="addExtra('wd', ${wVal})" class="col-span-3 p-4 bg-blue-100 text-blue-900 font-bold rounded-xl mb-1">Standard (+${wVal})</button>`;
            [3, 4, 5, 6].forEach(r => {
                if (r !== wVal) wButtons += `<button onclick="addExtra('wd', ${r})" class="p-4 bg-gray-100 font-bold rounded-xl">+${r}</button>`;
            });
            document.getElementById('wide-options').innerHTML = wButtons;

            let nbButtons = `<button onclick="addExtra('nb', ${nbVal})" class="col-span-3 p-4 bg-blue-100 text-blue-900 font-bold rounded-xl mb-1">Standard (+${nbVal})</button>`;
            [3, 4, 5, 6].forEach(r => {
                if (r !== nbVal) nbButtons += `<button onclick="addExtra('nb', ${r})" class="p-4 bg-gray-100 font-bold rounded-xl">+${r}</button>`;
            });
            document.getElementById('noball-options').innerHTML = nbButtons;

            updateMatchHeader();
            updateScoreboard();
            showScreen('app');
            initInnings();
        }

        function updateMatchHeader() {
            const t1 = state.team1.name;
            const t2 = state.team2.name;
            const venue = (state.venue || 'Unknown Venue').toUpperCase();
            const dateObj = state.matchDate ? new Date(state.matchDate) : new Date();
            const dateStr = dateObj.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
            const subTitle = `${venue} | ${dateStr} | ${state.totalOvers} Overs | ${state.playersPerSide}-a-side`;

            let codeDisplay = "";
            if (typeof broadcastId !== 'undefined' && broadcastId) {
                codeDisplay = `<div class="absolute top-0 left-0 bg-blue-600 text-white text-[10px] font-bold px-2 py-1 rounded-br-lg shadow-sm z-50">üì° CODE: ${broadcastId}</div>`;
            }

            const headerHTML = `
                <div class="py-2 relative">
                    ${codeDisplay} <h1 class="text-xl sm:text-2xl font-black text-gray-900 uppercase tracking-tight leading-tight">${t1} <span class="text-gray-400 font-medium text-lg px-1">vs</span> ${t2}</h1>
                    <p class="text-xs sm:text-sm text-gray-500 font-medium mt-1 tracking-wide">${subTitle}</p>
                </div>
            `;
            document.getElementById('match-header').innerHTML = headerHTML;
        }

        function updateScoreboard() {
            const battingTeamKey = state.battingTeam;
            const bowlingTeamKey = state.bowlingTeam;
            const battingTeam = state[battingTeamKey];
            const bowlingTeam = state[bowlingTeamKey];

            const createTeamRow = (team, isBatting, isFirstInnings) => {
                const logoSrc = team.logo || '';
                const logoHTML = logoSrc ? `<img src="${logoSrc}" class="w-8 h-8 rounded-full object-cover border border-gray-200">` : `<div class="w-8 h-8 rounded-full flex items-center justify-center font-bold text-white text-xs" style="background-color: #3b82f6;">${getTeamInitials(team.name)}</div>`;
                let rightSideHTML = '';
                
                const score = team.score || 0;
                const wkts = team.wickets || 0;
                const overs = team.overs || 0;
                const balls = team.balls || 0;
                
                if (isBatting) {
                    rightSideHTML = `<div class="text-right"><div class="text-xl font-bold text-gray-900 leading-none">${score}/${wkts}</div><div class="text-xs text-gray-500 font-medium mt-0.5">(${overs}.${balls} / ${state.totalOvers} ov)</div></div>`;
                } else {
                    if (isFirstInnings) rightSideHTML = `<div class="text-sm font-bold text-gray-400 uppercase tracking-wide">Yet to bat</div>`;
                    else rightSideHTML = `<div class="text-right"><div class="text-lg font-bold text-gray-700 leading-none">${score}/${wkts}</div><div class="text-xs text-gray-400">(${overs}.${balls} ov)</div></div>`;
                }

                const containerClass = isBatting ? "flex items-center justify-between py-3 border-b border-gray-100 bg-white px-2" : "flex items-center justify-between py-3 bg-gray-50/50 opacity-60 px-2";
                const nameClass = isBatting ? "text-base font-black text-gray-800 uppercase tracking-tight" : "text-base font-bold text-gray-500 uppercase tracking-tight";

                return `<div class="${containerClass}"><div class="flex items-center gap-3">${logoHTML}<span class="${nameClass}">${team.name}</span></div>${rightSideHTML}</div>`;
            };

            const row1 = createTeamRow(battingTeam, true, state.innings === 1);
            const row2 = createTeamRow(bowlingTeam, false, state.innings === 1);
            document.getElementById('team-scores-container').innerHTML = row1 + row2;
        }

        function selectOpeningPair(callback) {
            const team = state.battingTeam;
            const sSelect = document.getElementById('pair-striker-select');
            const nsSelect = document.getElementById('pair-nonstriker-select');
            
            sSelect.innerHTML = '<option value="">Select Striker...</option>';
            nsSelect.innerHTML = '<option value="">Select Non-Striker...</option>';
            
            Object.keys(state[team].playerStats).forEach(pid => {
                const p = state[team].playerStats[pid];
                const optS = document.createElement('option');
                optS.value = p.id;
                optS.textContent = p.name;
                sSelect.appendChild(optS);

                const optNS = document.createElement('option');
                optNS.value = p.id;
                optNS.textContent = p.name;
                nsSelect.appendChild(optNS);
            });

            openModal('opening-pair-modal');
            state.pairSelectionCallback = callback;
        }

        function updatePairExclusions() {
            const sSelect = document.getElementById('pair-striker-select');
            const nsSelect = document.getElementById('pair-nonstriker-select');
            
            const sVal = sSelect.value;
            const nsVal = nsSelect.value;

            Array.from(nsSelect.options).forEach(opt => {
                if (opt.value === "") return;
                opt.disabled = (opt.value === sVal);
            });

            Array.from(sSelect.options).forEach(opt => {
                if (opt.value === "") return;
                opt.disabled = (opt.value === nsVal);
            });
        }

        function confirmOpeningPair() {
            const sVal = document.getElementById('pair-striker-select').value;
            const nsVal = document.getElementById('pair-nonstriker-select').value;
            
            if(!sVal || !nsVal || sVal === nsVal) {
                alert("Please select two different players.");
                return;
            }

            const team = state.battingTeam;
            state.striker = state[team].playerStats[sVal];
            state.nonStriker = state[team].playerStats[nsVal];
            
            closeModal('opening-pair-modal');
            if (state.pairSelectionCallback) state.pairSelectionCallback();
        }

        let pendingSelection = null; 

        function selectPlayer(role, callback) {
            pendingSelection = { role, callback };
            
            const select = document.getElementById('player-select');
            const title = document.getElementById('modal-title');
            select.innerHTML = ''; 

            let teamKey;
            let excludeIds = [];
            let previousBowlerId = null; // Track who just finished bowling

            if (role === 'bowler') {
                teamKey = state.bowlingTeam;
                title.textContent = "Select Next Bowler";
                // If there is a current bowler set, mark them as the previous one
                if (state.bowler) {
                    previousBowlerId = state.bowler.id;
                }
            } else {
                teamKey = state.battingTeam;
                title.textContent = "Select New Batter";
                
                if (role === 'striker' && state.nonStriker) excludeIds.push(state.nonStriker.id);
                if (role === 'nonStriker' && state.striker) excludeIds.push(state.striker.id);
            }

            const roster = state[teamKey].playerStats;
            let count = 0;
            
            Object.values(roster).forEach(player => {
                if (!excludeIds.includes(player.id)) {
                    const opt = document.createElement('option');
                    opt.value = player.id;
                    opt.textContent = player.name;

                    // Disable Batters who are out
                    if ((role === 'striker' || role === 'nonStriker') && player.dismissal) {
                        opt.disabled = true; 
                        opt.textContent += " (OUT)"; 
                        opt.style.color = "#9ca3af"; 
                        opt.style.backgroundColor = "#f3f4f6"; 
                    }

                    // Disable Previous Bowler (Prevent consecutive overs)
                    if (role === 'bowler' && player.id === previousBowlerId) {
                        opt.disabled = true;
                        opt.textContent += " (Just Bowled)";
                        opt.style.color = "#9ca3af";
                        opt.style.backgroundColor = "#f3f4f6";
                    }
                    
                    select.appendChild(opt);
                    count++;
                }
            });

            if (count === 0) {
                const opt = document.createElement('option');
                opt.textContent = "No players available";
                select.appendChild(opt);
            }

            const closeBtn = document.querySelector('#player-modal button[onclick="cancelPlayerSelection()"]');
            if(closeBtn) {
                if (window.correctionMode === true) {
                    closeBtn.style.display = 'block'; 
                } else {
                    closeBtn.style.display = 'none';  
                }
            }

            openModal('player-modal');
        }

        document.getElementById('player-save-btn').onclick = function() {
            if (!pendingSelection) return;

            const selectedId = document.getElementById('player-select').value;
            if (!selectedId || selectedId === "No players available") {
                closeModal('player-modal');
                return; 
            }

            const role = pendingSelection.role;
            const teamKey = (role === 'bowler') ? state.bowlingTeam : state.battingTeam;
            
            const newPlayer = state[teamKey].playerStats[selectedId];

            if (window.correctionMode) {
                const oldPlayer = state[role]; 
                
                if (oldPlayer && newPlayer.id !== oldPlayer.id) {
                    newPlayer.runs = (newPlayer.runs || 0) + (oldPlayer.runs || 0);
                    newPlayer.balls = (newPlayer.balls || 0) + (oldPlayer.balls || 0);
                    
                    newPlayer.wickets = (newPlayer.wickets || 0) + (oldPlayer.wickets || 0);
                    newPlayer.runsConceded = (newPlayer.runsConceded || 0) + (oldPlayer.runsConceded || 0);
                    newPlayer.ballsBowled = (newPlayer.ballsBowled || 0) + (oldPlayer.ballsBowled || 0);

                    oldPlayer.runs = 0; oldPlayer.balls = 0;
                    oldPlayer.wickets = 0; oldPlayer.runsConceded = 0; oldPlayer.ballsBowled = 0;
                }
                window.correctionMode = false; 
            }

            if (role === 'bowler') {
                state.bowler = newPlayer;
            } else if (role === 'striker') {
                state.striker = newPlayer;
            } else if (role === 'nonStriker') {
                state.nonStriker = newPlayer;
            }

            closeModal('player-modal');
            if (pendingSelection.callback) pendingSelection.callback();
            
            pendingSelection = null;
            updateUI(); 
        };

        function initInnings() {
            selectOpeningPair(() => {
                selectPlayer('bowler', updateUI);
            });
        }

        let tempWicketType = null;

        function processIndoorWicket(type) {
            closeModal('wicket-type-modal');
            
            if (type === 'Run Out') {
                const btnS = document.getElementById('btn-ro-striker');
                const btnNS = document.getElementById('btn-ro-nonstriker');
                
                btnS.textContent = state.striker ? `${state.striker.name} (Striker)` : "Striker";
                btnNS.textContent = state.nonStriker ? `${state.nonStriker.name} (Non-Striker)` : "Non-Striker";
                
                openModal('runout-modal');
            } else {
                applyWicketPenalty('striker', type);
            }
        }

        function setupFielderSelect(type) {
            closeModal('wicket-type-modal');
            tempWicketType = type; 
            
            const select = document.getElementById('fielder-select');
            select.innerHTML = '';
            const title = document.getElementById('fielder-modal-title');
            
            title.textContent = (type === 'Catch') ? "Who took the Catch?" : "Who is the Keeper?";
            
            const roster = state[state.bowlingTeam].playerStats;
            Object.values(roster).forEach(player => {
                const opt = document.createElement('option');
                opt.value = player.name; 
                opt.textContent = player.name;
                select.appendChild(opt);
            });
            
            openModal('fielder-modal');
        }

        function confirmFielder() {
            const fielderName = document.getElementById('fielder-select').value;
            if(!fielderName) return;
            
            closeModal('fielder-modal');
            applyWicketPenalty('striker', tempWicketType, fielderName);
        }

        function finalizeRunOut(who) {
            closeModal('runout-modal');
            applyWicketPenalty(who, 'Run Out');
        }

        function applyWicketPenalty(who, type, fielder = null) {
            addToHistory();
            const penalty = state.rules.wicketRuns;
            const bt = state[state.battingTeam];
            const bwl = state.bowler; 
            
            const roleKey = (who === 'nonstriker' || who === 'nonStriker') ? 'nonStriker' : 'striker';
            const victim = state[roleKey];

            let dismissalText = type; 
            
            if (victim) {
                if (type === 'Bowled' && bwl) {
                    dismissalText = `b. ${bwl.name}`;
                } else if (type === 'LBW' && bwl) {
                    dismissalText = `lbw b. ${bwl.name}`;
                } else if (type === 'Catch' && bwl) {
                    dismissalText = `c. ${fielder || 'Sub'} b. ${bwl.name}`;
                } else if (type === 'Stumped' && bwl) {
                    dismissalText = `st. ${fielder || 'Keeper'} b. ${bwl.name}`;
                } else if (type === 'Hit Wicket' && bwl) {
                    dismissalText = `hit wkt b. ${bwl.name}`;
                }
                
                victim.dismissal = dismissalText; 
                victim.runs -= penalty; 
            }

            bt.score -= penalty;
            if (state.striker) { state.striker.balls++; }
            
            bt.wickets = (bt.wickets || 0) + 1;
            
            if (bwl && type !== 'Run Out' && type !== 'Retired Out' && type !== 'Other') { 
                bwl.wickets++; 
            }
            if (bwl) { bwl.ballsBowled++; }

            showEventPopup("OUT", "text-red-600");
            processBall(0, 'W', true);
            updateUI();

            if (victim && broadcastId) {
                setTimeout(() => {
                    const cardData = {
                        name: victim.name,
                        score: victim.runs,
                        balls: victim.balls,
                        howOut: dismissalText.toUpperCase(),
                        teamLogo: state[state.battingTeam].logo
                    };
                    db.collection("live_matches").doc(broadcastId).set({
                        showDismissalCard: true, dismissalData: cardData
                    }, { merge: true });
                    setTimeout(() => {
                        db.collection("live_matches").doc(broadcastId).set({
                            showDismissalCard: false
                        }, { merge: true });
                    }, 7000);
                }, 1500);
            }

            setTimeout(() => {
                selectPlayer(roleKey, updateUI); 
            }, 1200);
        }

        function addToHistory() {
            undoStack.push(JSON.parse(JSON.stringify(state)));
        }

        function undoLastAction() {
            if (undoStack.length === 0) {
                alert("Nothing to undo!");
                return;
            }
            state = undoStack.pop();
            closeModal('wicket-type-modal');
            closeModal('wide-modal');
            closeModal('noball-modal');
            closeModal('extras-modal');
            closeModal('runout-modal'); 
            updateScoreboard();
            updateUI();
        }

        function addRuns(runs) {
            addToHistory();
            const bt = state[state.battingTeam];
            const str = state.striker;
            const bwl = state.bowler; 

            bt.score = (bt.score || 0) + runs;
            if (str) { str.runs += runs; str.balls++; }
            if (bwl) { bwl.runsConceded += runs; bwl.ballsBowled++; }

            if (state.innings === 2 && state.rules.wicketRuns === 0) {
                if (bt.score >= state.target) {
                    processBall(runs, `${runs}`, true);
                    updateUI(); 
                    setTimeout(endInnings, 100); 
                    return;
                }
            }

            if (runs === 4) showEventPopup("4", "text-blue-500");
            if (runs === 6) showEventPopup("6", "text-green-500");

            processBall(runs, `${runs}`, true);
            if(runs % 2 !== 0) swapStrikers();
            updateUI();
        }

        function showEventPopup(text, colorClass) {
            let animType = null;
            if (text === "4") animType = "4";
            if (text === "6") animType = "6";
            if (text === "OUT") animType = "W";
            
            if (animType) syncToLiveDB(animType); 

            const overlay = document.getElementById('event-animation-overlay');
            const textEl = document.getElementById('event-animation-text');
            textEl.textContent = text;
            textEl.className = `text-9xl font-black drop-shadow-2xl animate-pop ${colorClass}`;
            overlay.classList.remove('hidden');
            setTimeout(() => { overlay.classList.add('hidden'); }, 1200);
        }

        function addExtra(type, runs) {
            addToHistory();
            closeModal('wide-modal'); closeModal('noball-modal'); closeModal('extras-modal');
            const bt = state[state.battingTeam];
            const bwl = state.bowler; 
            
            bt.score += runs;
            if(bwl) { bwl.runsConceded += runs; }
            
            let label = type.toUpperCase();
            if (type === 'wd' || type === 'nb') {
                if (runs > 1) {
                    label = `${type.toUpperCase()}+${runs - 1}`;
                }
            }

            if (state.innings === 2 && state.rules.wicketRuns === 0) {
                if (bt.score >= state.target) {
                    processBall(runs, label, false); 
                    updateUI();
                    setTimeout(endInnings, 100); 
                    return;
                }
            }

            processBall(runs, label, false); 
            updateUI();
        }

        function processBall(runs, eventLabel, isLegal) {
            const bt = state[state.battingTeam];
            
            if (isLegal) {
                bt.balls = (bt.balls || 0) + 1;
            }
            
            state.currentOver.push({ event: eventLabel, runs: runs, isLegal: isLegal });

            if(bt.balls === 6) {
                bt.overs = (bt.overs || 0) + 1;
                bt.balls = 0;
                
                if(bt.overs >= state.totalOvers) {
                    endInnings();
                } else if (state.rules.skins && bt.overs % 4 === 0) {
                    setTimeout(() => {
                        state.currentOver = []; 
                        openModal('pair-change-modal');
                    }, 500);
                } else {
                    setTimeout(() => { 
                        swapStrikers(); 
                        state.currentOver = []; 
                        selectPlayer('bowler', updateUI); 
                    }, 200);
                }
            }
        }

        function swapStrikers() { const t = state.striker; state.striker = state.nonStriker; state.nonStriker = t; }
        
        function performPairSwap() { 
            closeModal('pair-change-modal'); 
            selectOpeningPair(() => {
                selectPlayer('bowler', updateUI);
            });
        }

        function endInnings() {
            if(state.innings === 1) {
                const battingTeam = state[state.battingTeam];
                state.target = battingTeam.score + 1;

                document.getElementById('ib-batting-team').textContent = battingTeam.name;
                document.getElementById('ib-score').textContent = battingTeam.score;
                document.getElementById('ib-wickets').textContent = battingTeam.wickets || 0;
                document.getElementById('ib-overs').textContent = `${battingTeam.overs}.${battingTeam.balls}`;
                document.getElementById('ib-target').textContent = state.target;

                document.getElementById('innings-break-modal').classList.remove('hidden');
            } else {
                generateMatchSummary();
                document.getElementById('match-summary-modal').classList.remove('hidden');
            }
        }

        function generateMatchSummary() {
            const t1 = state.team1;
            const t2 = state.team2;
            
            let winnerText = "MATCH TIED";
            let marginText = "Scores Level";
            let winnerKey = null;

            if (t1.score > t2.score) {
                winnerText = `${t1.name} WINS!`;
                marginText = `WON BY ${t1.score - t2.score} RUNS`;
                winnerKey = 'team1';
                document.getElementById('card-t1').className = "bg-gradient-to-r from-green-500/20 to-emerald-500/20 backdrop-blur-lg border border-green-500/50 rounded-2xl p-6 flex items-center justify-between shadow-[0_0_30px_rgba(16,185,129,0.2)]";
                document.getElementById('card-t2').className = "bg-white/5 backdrop-blur-lg border border-white/10 rounded-2xl p-6 flex items-center justify-between opacity-70 grayscale";
            } else if (t2.score > t1.score) {
                winnerText = `${t2.name} WINS!`;
                const wicketsLeft = (state.playersPerSide - 1) - (t2.wickets || 0); 
                marginText = `WON BY ${wicketsLeft > 0 ? wicketsLeft : 1} WICKETS`;
                winnerKey = 'team2';
                document.getElementById('card-t2').className = "bg-gradient-to-r from-green-500/20 to-emerald-500/20 backdrop-blur-lg border border-green-500/50 rounded-2xl p-6 flex items-center justify-between shadow-[0_0_30px_rgba(16,185,129,0.2)]";
                document.getElementById('card-t1').className = "bg-white/5 backdrop-blur-lg border border-white/10 rounded-2xl p-6 flex items-center justify-between opacity-70 grayscale";
            }

            document.getElementById('summary-winner-text').textContent = winnerText;
            document.getElementById('summary-margin-text').textContent = marginText;

            document.getElementById('sum-t1-name').textContent = t1.name;
            if(t1.logo) document.getElementById('sum-t1-logo').innerHTML = `<img src="${t1.logo}" class="w-full h-full object-cover">`;
            else document.getElementById('sum-t1-logo').textContent = getTeamInitials(t1.name);
            document.getElementById('sum-t1-score').textContent = `${t1.score}/${t1.wickets||0}`;
            document.getElementById('sum-t1-overs').textContent = `${t1.overs}.${t1.balls} ov`;

            document.getElementById('sum-t2-name').textContent = t2.name;
            if(t2.logo) document.getElementById('sum-t2-logo').innerHTML = `<img src="${t2.logo}" class="w-full h-full object-cover">`;
            else document.getElementById('sum-t2-logo').textContent = getTeamInitials(t2.name);
            document.getElementById('sum-t2-score').textContent = `${t2.score}/${t2.wickets||0}`;
            document.getElementById('sum-t2-overs').textContent = `${t2.overs}.${t2.balls} ov`;

            const allPlayers = [];
            ['team1', 'team2'].forEach(tk => {
                Object.values(state[tk].playerStats).forEach(p => {
                    p.teamName = state[tk].name;
                    allPlayers.push(p);
                });
            });

            const topBatters = [...allPlayers].sort((a,b) => b.runs - a.runs).slice(0, 3);
            document.getElementById('sum-top-batters').innerHTML = topBatters.map(p => `
                <div class="flex justify-between items-center border-b border-white/10 pb-2 last:border-0">
                    <div>
                        <div class="font-bold text-white text-sm">${p.name}</div>
                        <div class="text-[10px] text-white/50">${p.teamName}</div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-yellow-400 text-lg">${p.runs}</div>
                        <div class="text-[9px] text-white/50">${p.balls} balls</div>
                    </div>
                </div>
            `).join('');

            const topBowlers = [...allPlayers].sort((a,b) => (b.wickets - a.wickets) || (a.runsConceded - b.runsConceded)).slice(0, 3);
            document.getElementById('sum-top-bowlers').innerHTML = topBowlers.map(p => `
                <div class="flex justify-between items-center border-b border-white/10 pb-2 last:border-0">
                    <div>
                        <div class="font-bold text-white text-sm">${p.name}</div>
                        <div class="text-[10px] text-white/50">${p.teamName}</div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-blue-400 text-lg">${p.wickets}<span class="text-white/50 text-xs">/${p.runsConceded}</span></div>
                        <div class="text-[9px] text-white/50">${p.ballsBowled} balls</div>
                    </div>
                </div>
            `).join('');

            const pomCandidates = [...new Set([...topBatters.slice(0,2), ...topBowlers.slice(0,2)])];
            document.getElementById('sum-pom-list').innerHTML = pomCandidates.map((p, i) => `
                <label class="flex items-center gap-3 p-3 bg-white/5 rounded-xl cursor-pointer hover:bg-white/10 transition border border-transparent hover:border-yellow-500/50">
                    <input type="radio" name="pom" value="${p.id}" ${i===0?'checked':''} class="w-5 h-5 accent-yellow-500">
                    <div class="flex-grow">
                        <div class="font-bold text-sm text-white">${p.name}</div>
                        <div class="text-[10px] text-white/60">${p.runs} Runs ‚Ä¢ ${p.wickets} Wickets</div>
                    </div>
                </label>
            `).join('');
        }

        function startSecondInnings() {
            document.getElementById('innings-break-modal').classList.add('hidden');
            state.innings = 2;
            const t = state.battingTeam; state.battingTeam = state.bowlingTeam; state.bowlingTeam = t;
            state.currentOver = []; 
            state.bowler = null; 
            alert(`2nd Innings Starting!\nBatting: ${state[state.battingTeam].name}\nTarget: ${state.target}`);
            initInnings();
        }

        function manualSwap() {
            addToHistory();
            swapStrikers();
            updateUI();
        }

        function confirmExit() {
            if(confirm("‚ö†Ô∏è Are you sure you want to EXIT?\n\nCurrent match data will be lost.")) {
                location.reload();
            }
        }

        function updateUI() {
            syncToLiveDB(); 
            updateScoreboard(); 
            
            const batTable = document.getElementById('batting-table');
            batTable.innerHTML = '';
            
            const createRow = (p, isStriker) => {
                const sr = p.balls > 0 ? ((p.runs / p.balls) * 100).toFixed(2) : '0.00';
                const roleArg = isStriker ? 'striker' : 'nonStriker';
                
                return `
                <tr class="border-t ${isStriker ? 'bg-blue-50' : ''}">
                    <td class="p-2 font-bold text-gray-800">
                        <div class="flex items-center justify-between w-full">
                            <span>${p.name} ${isStriker ? '<span class="text-red-500">*</span>' : ''}</span>
                            <button onclick="editActivePlayer('${roleArg}')" class="text-gray-400 hover:text-blue-600 px-2 text-lg">‚úé</button>
                        </div>
                    </td>
                    <td class="text-center p-2 font-bold ${p.runs < 0 ? 'text-red-600' : ''}">${p.runs}</td>
                    <td class="text-center p-2 text-gray-600">${p.balls}</td>
                    <td class="text-center p-2 text-gray-400">-</td>
                    <td class="text-center p-2 text-gray-400">-</td>
                    <td class="text-right p-2 text-gray-500 text-xs">${sr}</td>
                </tr>`;
            };
            
            if(state.striker) batTable.innerHTML += createRow(state.striker, true);
            if(state.nonStriker) batTable.innerHTML += createRow(state.nonStriker, false);

            if(state.bowler) {
                const ballsHTML = state.currentOver.map(b => {
                    let c = 'ball-0';
                    let fontSize = 'text-[9px]'; 
                    
                    if(b.runs === 4) c = 'ball-4';
                    else if(b.runs === 6) c = 'ball-6';
                    else if(b.event.includes('W') && !b.event.includes('WD')) c = 'ball-w';
                    else if(b.event.includes('WD') || b.event.includes('NB')) {
                        c = 'ball-wd';
                        if (b.event.length > 2) fontSize = 'text-[6px] leading-tight';
                    }
                    
                    return `<span class="ball-chip ${c} ${fontSize}">${b.event}</span>`;
                }).join('');

                const overs = Math.floor(state.bowler.ballsBowled / 6) + '.' + (state.bowler.ballsBowled % 6);
                const econ = state.bowler.ballsBowled > 0 ? (state.bowler.runsConceded / (state.bowler.ballsBowled/6)).toFixed(2) : '0.00';

                document.getElementById('bowling-table').innerHTML = `
                <tr class="border-t">
                    <td class="py-1 px-2 align-middle">
                        <div class="font-bold text-gray-800 text-[11px] leading-tight flex items-center gap-2">
                            ${state.bowler.name}
                            <button onclick="editActivePlayer('bowler')" class="text-gray-400 hover:text-blue-600">‚úé</button>
                        </div>
                        <div class="mt-0.5 flex items-center overflow-x-auto gap-0.5 min-h-[1.4rem] w-full no-scrollbar">${ballsHTML}</div>
                    </td>
                    <td class="text-center py-1 font-medium text-gray-700 text-[10px] align-middle">${overs}</td>
                    <td class="text-center py-1 text-gray-400 text-[10px] align-middle">0</td>
                    <td class="text-center py-1 font-medium text-gray-800 text-[10px] align-middle">${state.bowler.runsConceded}</td>
                    <td class="text-center py-1 font-bold text-red-600 text-[10px] align-middle">${state.bowler.wickets}</td>
                    <td class="text-right py-1 pr-2 text-gray-500 text-[9px] align-middle">${econ}</td>
                </tr>`;
            }
        }

        function broadcastMatchResult() {
            // 1. Validate Man of the Match Selection
            const selectedPomInput = document.querySelector('input[name="pom"]:checked');
            if (!selectedPomInput) {
                alert("‚ö†Ô∏è Please select a Man of the Match first!");
                return;
            }
            const selectedPomId = selectedPomInput.value;

            // 2. Determine Winner & Margin
            let winnerText = "MATCH TIED";
            let marginText = "Scores Level";
            const t1 = state.team1; 
            const t2 = state.team2;

            if (t1.score > t2.score) {
                winnerText = `${t1.name} WINS!`;
                marginText = `WON BY ${t1.score - t2.score} RUNS`;
            } else if (t2.score > t1.score) {
                winnerText = `${t2.name} WINS!`;
                const wicketsLeft = (state.playersPerSide - 1) - (t2.wickets || 0);
                marginText = `WON BY ${wicketsLeft > 0 ? wicketsLeft : 1} WICKETS`;
            }

            // 3. Get POM Details
            let pomData = { name: "PLAYER", stats: "" };
            [t1, t2].forEach(team => {
                if(team.playerStats[selectedPomId]) {
                    const p = team.playerStats[selectedPomId];
                    pomData.name = p.name;
                    pomData.stats = `${p.runs} Runs ‚Ä¢ ${p.wickets} Wickets`;
                    pomData.team = team.name; // Helper for color if needed
                }
            });

            // 4. Calculate Top Performers (Live Calculation)
            const allPlayers = [];
            [t1, t2].forEach(team => {
                Object.values(team.playerStats).forEach(p => {
                    p.teamName = team.name; 
                    allPlayers.push(p);
                });
            });

            // Top Batters (Sort by runs desc)
            const topBatters = [...allPlayers]
                .sort((a,b) => b.runs - a.runs)
                .slice(0, 3)
                .map(p => ({ 
                    name: p.name, 
                    team: p.teamName,
                    runs: p.runs.toString(), 
                    balls: p.balls.toString() 
                }));

            // Top Bowlers (Sort by wickets desc, then runs conceded asc)
            const topBowlers = [...allPlayers]
                .sort((a,b) => (b.wickets - a.wickets) || (a.runsConceded - b.runsConceded))
                .slice(0, 3)
                .map(p => ({ 
                    name: p.name, 
                    team: p.teamName,
                    wickets: p.wickets.toString(), 
                    runs: p.runsConceded.toString(),
                    balls: p.ballsBowled.toString()
                }));

            // 5. Construct & Send Payload
            const payload = {
                summaryType: "MATCH_RESULT", // Tells OBS to switch to Result View
                matchStatus: "COMPLETE",
                
                // Header Info
                resultMain: winnerText,
                resultSub: marginText,
                
                // Detailed Team Scores
                t1: { name: t1.name, score: `${t1.score}/${t1.wickets||0}`, overs: `${t1.overs}.${t1.balls}`, logo: t1.logo },
                t2: { name: t2.name, score: `${t2.score}/${t2.wickets||0}`, overs: `${t2.overs}.${t2.balls}`, logo: t2.logo },
                
                // Lists
                topBatters: topBatters,
                topBowlers: topBowlers,
                pom: pomData,
                
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };

            db.collection("live_matches").doc(broadcastId).set(payload, { merge: true })
                .then(() => alert("‚úÖ Match Result Broadcasted to Overlay!"))
                .catch(err => console.error(err));
        }

        // --- NEW BROADCAST CONTROL & LOCKING LOGIC ---

        function openViewControlModal() {
            if (!broadcastId) {
                alert("‚ö†Ô∏è Please Enable Live Broadcast first!");
                return;
            }
            openModal('broadcast-control-modal');
        }

        function toggleView(type, checkbox) {
            // Uncheck other toggles
            const toggles = ['toggle-squad', 'toggle-batting', 'toggle-bowling'];
            const mapping = { 'SQUAD': 'toggle-squad', 'BATTING': 'toggle-batting', 'BOWLING': 'toggle-bowling' };
            const currentId = mapping[type];

            toggles.forEach(id => {
                if(id !== currentId) document.getElementById(id).checked = false;
            });

            if(checkbox.checked) {
                // ACTIVATE VIEW
                const grid = document.querySelector('.scoring-grid');
                grid.classList.add('opacity-50', 'pointer-events-none', 'grayscale');
                
                let payload = { showSummaryOverlay: true };

                if (type === 'SQUAD') {
                    // Gather Squad Lists
                    // IMPORTANT: We use state.team1.playing to get the IDs of the active players
                    // Then map those IDs to names from the squad list.
                    const getNames = (tk) => {
                        return state[tk].playing.map(pid => {
                            const player = state[tk].squad.find(sq => sq.id === pid);
                            return player ? player.name : "PLAYER";
                        });
                    };

                    payload.summaryType = 'SQUAD';
                    payload.squad1 = getNames('team1');
                    payload.squad2 = getNames('team2');
                    payload.t1 = state.team1.name;
                    payload.t2 = state.team2.name;
                    // Send logos too for the squad card
                    payload.t1Logo = state.team1.logo;
                    payload.t2Logo = state.team2.logo;
                }
                else if (type === "BATTING") {
                    const teamKey = state.battingTeam;
                    const currentTeam = state[teamKey];
                    let battingList = [];
                    Object.values(currentTeam.playerStats).forEach(p => {
                        const isStriker = state.striker && state.striker.id === p.id;
                        const isNonStriker = state.nonStriker && state.nonStriker.id === p.id;
                        
                        if (p.balls > 0 || isStriker || isNonStriker) {
                            let status = "Did not bat";
                            if (p.dismissal) status = p.dismissal.toUpperCase();
                            else if (isStriker || isNonStriker) status = "NOT OUT";
                            else status = "OUT";

                            battingList.push({ name: p.name, runs: p.runs, balls: p.balls, status: status });
                        }
                    });
                    payload.summaryType = "BATTING";
                    payload.battingCard = battingList;
                    payload.t1 = currentTeam.name;
                    payload.t1Logo = currentTeam.logo;
                    payload.score = currentTeam.score;
                    payload.wickets = currentTeam.wickets;
                    payload.overs = currentTeam.overs;
                    payload.balls = currentTeam.balls;
                    payload.extras = currentTeam.extras || 0;
                } 
                else if (type === "BOWLING") {
                    const teamKey = state.bowlingTeam;
                    const currentTeam = state[teamKey];
                    let bowlingList = [];
                    Object.values(currentTeam.playerStats).forEach(p => {
                        if (p.ballsBowled > 0) {
                            const oversBowled = Math.floor(p.ballsBowled / 6) + "." + (p.ballsBowled % 6);
                            const totalOvers = p.ballsBowled / 6;
                            const econ = totalOvers > 0 ? (p.runsConceded / totalOvers).toFixed(1) : "0.0";
                            bowlingList.push({ name: p.name, o: oversBowled, m: 0, r: p.runsConceded, w: p.wickets, e: econ });
                        }
                    });
                    payload.summaryType = "BOWLING";
                    payload.bowlingCard = bowlingList;
                    payload.t1 = currentTeam.name;
                    payload.t1Logo = currentTeam.logo;
                    payload.score = state[state.battingTeam].score;
                    payload.wickets = state[state.battingTeam].wickets;
                    payload.overs = state[state.battingTeam].overs;
                    payload.balls = state[state.battingTeam].balls;
                    payload.extras = state[state.battingTeam].extras || 0;
                }

                db.collection("live_matches").doc(broadcastId).set(payload, { merge: true })
                    .then(() => console.log(type + " VIEW ACTIVATED"));

            } else {
                // TURN OFF
                const grid = document.querySelector('.scoring-grid');
                grid.classList.remove('opacity-50', 'pointer-events-none', 'grayscale');
                db.collection("live_matches").doc(broadcastId).set({ showSummaryOverlay: false }, { merge: true });
            }
        }

        // DEPRECATED FUNCTIONS REPLACED BY TOGGLE LOGIC, KEEPING FOR SAFETY
        function activateView(type) { toggleView(type, {checked: true}); }
        function turnOffView() { 
            document.querySelectorAll('.ios-toggle').forEach(el => el.checked = false);
            toggleView('OFF', {checked: false});
        }

        function editActivePlayer(role) {
            window.correctionMode = true; 
            selectPlayer(role, updateUI);
        }
        function cancelPlayerSelection() {
            window.correctionMode = false;
            pendingSelection = null;
            closeModal('player-modal');
        }
    </script>
</body>
</html>
