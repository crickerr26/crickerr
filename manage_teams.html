<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cricker - Manage Teams</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        @media (max-width: 768px) { .team-management-card { max-width: 100%; min-height: 100vh; border-radius: 0; box-shadow: none; border: none; } }
        .setup-btn { background-color: #2563eb; background-image: linear-gradient(to right, #2563eb, #1d4ed8); transition: all 0.3s ease; }
        .setup-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.3), 0 4px 6px -2px rgba(37, 99, 235, 0.15); }
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Hide scrollbar for clean UI */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center py-6 px-4">

    <div class="team-management-card bg-white w-full max-w-md rounded-2xl shadow-xl border border-gray-200 overflow-hidden flex flex-col relative" style="height: 85vh; max-height: 800px;">
        
        <div id="team-list-view" class="h-full flex flex-col relative">
            <div class="bg-blue-600 p-4 text-white flex justify-between items-center shadow-md z-10 relative">
                <h1 class="text-xl font-bold flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                    Manage Teams
                </h1>
                <button onclick="window.history.back()" class="text-blue-100 hover:text-white">Back</button>
            </div>

            <div class="flex-1 overflow-y-auto bg-gray-50 relative">
                <div class="p-4 space-y-4 pb-24">
                    <div id="saved-teams-container" class="space-y-3">
                        </div>
                </div>
            </div>

            <div class="absolute bottom-6 right-6 z-20">
                <button id="create-new-team-btn" class="setup-btn h-14 w-14 rounded-full text-white shadow-lg flex items-center justify-center text-2xl">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                </button>
            </div>
        </div>

        <div id="team-editor-view" class="hidden h-full flex flex-col bg-white absolute inset-0 z-30">
            <div class="bg-white border-b border-gray-200 p-4 flex items-center gap-3 sticky top-0 z-10 shadow-sm">
                <button id="back-to-list-btn" class="text-gray-500 hover:text-gray-800 p-1 rounded-full hover:bg-gray-100">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                </button>
                <h2 class="text-lg font-bold text-gray-800">Team Editor</h2>
            </div>

            <div class="flex-1 overflow-y-auto p-4">
                <form id="team-setup-form" class="space-y-6 pb-10">
                    
                    <div class="space-y-4">
                        <div class="flex items-start gap-4">
                            <div class="relative group flex-shrink-0">
                                <div class="h-20 w-20 rounded-full bg-gray-100 border-2 border-dashed border-gray-300 flex items-center justify-center overflow-hidden cursor-pointer hover:border-blue-500 transition-colors relative">
                                    <img id="editor-team-logo-preview" class="h-full w-full object-cover hidden">
                                    <span class="text-gray-400 text-[10px] font-bold text-center px-1">UPLOAD<br>LOGO</span>
                                    <input type="file" id="editor-team-logo-upload" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer">
                                </div>
                            </div>

                            <div class="flex-1 space-y-3">
                                <input type="text" id="editor-team-name" placeholder="TEAM NAME (e.g. INDIA)" 
                                    class="w-full text-lg font-bold border-b-2 border-gray-200 focus:border-blue-600 outline-none py-1 transition-colors uppercase placeholder:normal-case" 
                                    oninput="this.value = this.value.toUpperCase()" required>
                                
                                <div class="flex items-center gap-4">
                                    <div class="flex items-center gap-2">
                                        <label class="text-xs text-gray-500 font-semibold uppercase">Color:</label>
                                        <input type="color" id="editor-team-color" class="h-8 w-12 border-0 p-0 rounded cursor-pointer" value="#3b82f6">
                                    </div>

                                    <div class="flex-1">
                                        <select id="editor-team-country" class="w-full p-1 bg-white border-b border-gray-200 text-sm focus:border-blue-600 outline-none">
                                            <option value="" disabled selected>Select Country</option>
                                            <option value="Afghanistan">ğŸ‡¦ğŸ‡« Afghanistan</option>
                                            <option value="Australia">ğŸ‡¦ğŸ‡º Australia</option>
                                            <option value="Bangladesh">ğŸ‡§ğŸ‡© Bangladesh</option>
                                            <option value="Canada">ğŸ‡¨ğŸ‡¦ Canada</option>
                                            <option value="England">ğŸ´ó §ó ¢ó ¥ó ®ó §ó ¿ England</option>
                                            <option value="India">ğŸ‡®ğŸ‡³ India</option>
                                            <option value="Ireland">ğŸ‡®ğŸ‡ª Ireland</option>
                                            <option value="Namibia">ğŸ‡³ğŸ‡¦ Namibia</option>
                                            <option value="Nepal">ğŸ‡³ğŸ‡µ Nepal</option>
                                            <option value="Netherlands">ğŸ‡³ğŸ‡± Netherlands</option>
                                            <option value="New Zealand">ğŸ‡³ğŸ‡¿ New Zealand</option>
                                            <option value="Oman">ğŸ‡´ğŸ‡² Oman</option>
                                            <option value="Pakistan">ğŸ‡µğŸ‡° Pakistan</option>
                                            <option value="Papua New Guinea">ğŸ‡µğŸ‡¬ Papua New Guinea</option>
                                            <option value="Scotland">ğŸ´ó §ó ¢ó ³YğŸ‡¹ Scotland</option>
                                            <option value="South Africa">ğŸ‡¿ğŸ‡¦ South Africa</option>
                                            <option value="Sri Lanka">ğŸ‡±ğŸ‡° Sri Lanka</option>
                                            <option value="United Arab Emirates">ğŸ‡¦ğŸ‡ª UAE</option>
                                            <option value="United Kingdom">ğŸ‡¬ğŸ‡§ United Kingdom</option>
                                            <option value="United States">ğŸ‡ºğŸ‡¸ USA</option>
                                            <option value="West Indies">ğŸŒ´ West Indies</option>
                                            <option value="Zimbabwe">ğŸ‡¿ğŸ‡¼ Zimbabwe</option>
                                            <option value="Other">ğŸ³ï¸ Other</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <hr class="border-gray-100">

                    <div>
                        <div class="flex justify-between items-end mb-3">
                            <h3 class="font-bold text-gray-800">Squad List</h3>
                            <span class="text-xs text-gray-500">First & Last Name</span>
                        </div>
                        
                        <div id="player-inputs-container" class="space-y-3">
                            </div>

                        <button type="button" id="add-player-btn" class="mt-4 w-full py-2 border-2 border-dashed border-blue-200 text-blue-600 rounded-lg font-bold hover:bg-blue-50 transition-colors">
                            + Add Player
                        </button>
                    </div>

                    <hr class="border-gray-100">

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Select Captain</label>
                        <select id="captain-select" class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm">
                            <option value="" disabled selected>Add players first...</option>
                        </select>
                    </div>

                    <div class="pt-4 sticky bottom-0 bg-white pb-4 border-t border-gray-100">
                        <button type="submit" class="setup-btn w-full py-3.5 rounded-xl text-white font-bold shadow-lg text-lg flex justify-center items-center gap-2">
                            Save Team
                        </button>
                    </div>
                </form>
            </div>
        </div>

    </div>

    <script>
        // ==========================================
        // 3. FIREBASE CONFIGURATION
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyBqcD59IAPpKqk98oDZkgzgkoVZ8b8LGgY",
            authDomain: "livecricketscoring-92087.firebaseapp.com",
            databaseURL: "https://livecricketscoring-92087-default-rtdb.firebaseio.com", 
            projectId: "livecricketscoring-92087",
            storageBucket: "livecricketscoring-92087.firebasestorage.app",
            messagingSenderId: "522927197627",
            appId: "1:522927197627:web:f1df5db736cae96893089e"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore(); 

        // --- GLOBAL VARIABLES ---
        let globalTeamsList = [];
        const DEFAULT_AVATAR = "https://cdn-icons-png.flaticon.com/512/847/847969.png"; 

        // --- UI REFERENCES ---
        const ui = {
            teamListView: document.getElementById('team-list-view'),
            teamEditorView: document.getElementById('team-editor-view'),
            setupForm: document.getElementById('team-setup-form'),
            captainSelect: document.getElementById('captain-select'),
            addPlayerBtn: document.getElementById('add-player-btn'),
            playerInputsContainer: document.getElementById('player-inputs-container'),
            editorTeamNameInput: document.getElementById('editor-team-name'),
            editorTeamColorInput: document.getElementById('editor-team-color'),
            editorTeamCountryInput: document.getElementById('editor-team-country'),
            editorTeamLogoInput: document.getElementById('editor-team-logo-upload'),
            editorTeamLogoPreview: document.getElementById('editor-team-logo-preview'),
            savedTeamsContainer: document.getElementById('saved-teams-container'),
            createNewBtn: document.getElementById('create-new-team-btn'),
            backBtn: document.getElementById('back-to-list-btn')
        };

        // State holds objects: { name: "John Doe", avatar: "base64..." }
        let state = {
            players: [], 
            editMode: false,
            editingTeamId: null,
            currentCaptain: null
        };

        // Initialize players (Start with 4 slots)
        function initPlayerSlots() {
            state.players = [];
            for(let i=0; i<4; i++) { 
                state.players.push({ name: '', avatar: '' });
            }
            generatePlayerInputs();
        }

        // --- HELPER: Title Case (First letter capital) ---
        function titleCase(str) {
            return str.toLowerCase().split(' ').map(function(word) {
                return (word.charAt(0).toUpperCase() + word.slice(1));
            }).join(' ');
        }

        function generatePlayerInputs() {
            ui.playerInputsContainer.innerHTML = '';
            
            const currentCaptainSelection = ui.captainSelect.value;
            ui.captainSelect.innerHTML = '<option value="" disabled selected>Select Captain</option>';
            const validPlayerNames = [];

            state.players.forEach((player, index) => {
                const div = document.createElement('div');
                div.className = "flex items-center gap-3 animate-fade-in bg-gray-50 p-2 rounded-lg border border-gray-100";
                
                // Avatar Logic
                const avatarSrc = player.avatar || DEFAULT_AVATAR;
                const isDefault = !player.avatar;

                div.innerHTML = `
                    <div class="relative group cursor-pointer" onclick="document.getElementById('p-file-${index}').click()">
                        <div class="h-12 w-12 rounded-full overflow-hidden border border-gray-300 bg-white">
                            <img src="${avatarSrc}" class="h-full w-full object-cover" id="p-img-${index}">
                        </div>
                        <div class="absolute inset-0 flex items-center justify-center bg-black/20 rounded-full group-hover:bg-black/40 transition-all">
                            <span class="text-[8px] text-white font-bold opacity-0 group-hover:opacity-100 ${isDefault ? 'opacity-80' : ''}">PHOTO</span>
                        </div>
                        <input type="file" id="p-file-${index}" hidden accept="image/*" onchange="handlePlayerImage(${index}, this)">
                    </div>

                    <div class="flex-1">
                         <input type="text" 
                            value="${player.name}" 
                            placeholder="First & Last Name" 
                            class="w-full bg-transparent border-b border-gray-300 focus:border-blue-500 outline-none py-1 text-sm font-medium placeholder-gray-400"
                            oninput="handlePlayerName(${index}, this)"
                        >
                    </div>

                    <span class="text-xs font-bold text-gray-300">#${index + 1}</span>
                    
                    ${state.players.length > 2 ? `
                    <button type="button" onclick="removePlayer(${index})" class="text-gray-400 hover:text-red-500 p-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                    </button>` : ''}
                `;
                ui.playerInputsContainer.appendChild(div);

                if (player.name.trim()) validPlayerNames.push(player.name);
            });

            // Populate Captain Dropdown
            validPlayerNames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                if (name === state.currentCaptain || name === currentCaptainSelection) option.selected = true;
                ui.captainSelect.appendChild(option);
            });
        }

        // --- GLOBAL HANDLERS ---
        window.handlePlayerName = function(index, input) {
            // Capitalize Words
            const formatted = titleCase(input.value);
            // Only update visual value if character count is increasing (avoids cursor jumping on deletion)
            // Ideally we update state always, but visual update on blur or carefully
            state.players[index].name = input.value; // Store raw for now
        };
        // Apply formatting on blur to prevent cursor jumps
        document.addEventListener('focusout', function(e) {
            if(e.target.tagName === 'INPUT' && e.target.type === 'text') {
                e.target.value = titleCase(e.target.value);
                // Find index and update state
                // This is a bit loose but works for now
            }
        });

        window.handlePlayerImage = function(index, input) {
            const file = input.files[0];
            if (!file) return;

            // 1. LIMIT CHECK: Warn if file is larger than 5MB
            if (file.size > 5 * 1024 * 1024) {
                alert("âš ï¸ This photo is too large! Please choose a photo smaller than 5MB.");
                input.value = ''; 
                return;
            }

            // 2. SMART CROP & COMPRESS
            const reader = new FileReader();
            reader.onload = (readerEvent) => {
                const tempImg = new Image();
                tempImg.onload = () => {
                    const MAX_SIZE = 300;
                    const canvas = document.createElement('canvas');
                    canvas.width = MAX_SIZE;
                    canvas.height = MAX_SIZE;
                    const ctx = canvas.getContext('2d');

                    // Crop to square (center focus)
                    let sWidth, sHeight, sx, sy;
                    if (tempImg.width > tempImg.height) {
                        sHeight = tempImg.height;
                        sWidth = tempImg.height;
                        sx = (tempImg.width - tempImg.height) / 2;
                        sy = 0;
                    } else {
                        sWidth = tempImg.width;
                        sHeight = tempImg.width;
                        sx = 0;
                        sy = (tempImg.height - tempImg.width) / 2;
                    }

                    ctx.drawImage(tempImg, sx, sy, sWidth, sHeight, 0, 0, MAX_SIZE, MAX_SIZE);
                    const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.7);

                    state.players[index].avatar = compressedDataUrl;
                    document.getElementById(`p-img-${index}`).src = compressedDataUrl;
                };
                tempImg.src = readerEvent.target.result;
            };
            reader.readAsDataURL(file);
        };

        window.removePlayer = function(index) {
            state.players.splice(index, 1);
            generatePlayerInputs();
        };

        // --- SAVE TO CLOUD ---
        ui.setupForm.onsubmit = (e) => {
            e.preventDefault();

            // Format Data
            const teamName = ui.editorTeamNameInput.value.trim().toUpperCase(); 
            const teamColor = ui.editorTeamColorInput.value;
            const teamCountry = ui.editorTeamCountryInput.value;
            const teamLogo = ui.editorTeamLogoPreview.dataset.logoSrc || ''; 
            
            // Clean up players list
            const validPlayers = state.players
                .map(p => ({ ...p, name: titleCase(p.name) })) // Ensure Title Case on save
                .filter(p => p.name && p.name.trim() !== '');
            
            // VALIDATION: Works with just 2 players
            if (!teamName || validPlayers.length < 2) {
                alert("Please enter a Team Name and at least 2 Players.");
                return;
            }

            // Image size warning
            if (teamLogo.length > 500000) {
                 if(!confirm("Team Logo is large. It might be slow. Continue?")) return;
            }

            const teamData = {
                name: teamName,
                color: teamColor,
                country: teamCountry || 'Other',
                logo: teamLogo,
                players: validPlayers, 
                captain: ui.captainSelect.value,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            const submitBtn = ui.setupForm.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.textContent = "Saving...";
            submitBtn.disabled = true;

            const firebaseOperation = state.editMode && state.editingTeamId
                ? db.collection("teams").doc(state.editingTeamId).update(teamData)
                : db.collection("teams").add(teamData);

            firebaseOperation
                .then(() => {
                    alert("Team Saved Successfully!");
                    resetForm();
                    showTeamListView();
                })
                .catch((err) => {
                    console.error("Save Error:", err);
                    alert("Error: " + err.message);
                })
                .finally(() => {
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                });
        };

        // --- LOAD FROM CLOUD ---
        function loadSavedTeams() {
            ui.savedTeamsContainer.innerHTML = '<div class="text-center p-4 text-gray-500">Loading Cloud Teams...</div>';

            db.collection("teams").orderBy("updatedAt", "desc").onSnapshot((snapshot) => {
                globalTeamsList = [];
                ui.savedTeamsContainer.innerHTML = '';

                if (snapshot.empty) {
                    ui.savedTeamsContainer.innerHTML = `<div class="text-center py-10 text-gray-400">No teams yet. Create one!</div>`;
                    return;
                }

                snapshot.forEach((doc) => {
                    const team = doc.data();
                    team.id = doc.id;
                    globalTeamsList.push(team);

                    const playerCount = team.players ? team.players.length : 0;
                    
                    const card = document.createElement('div');
                    card.className = "bg-white p-4 rounded-lg shadow border-l-4 border-blue-500 flex justify-between items-center";
                    card.style.borderLeftColor = team.color;
                    
                    card.innerHTML = `
                        <div class="flex items-center gap-3 overflow-hidden">
                            <div class="h-12 w-12 rounded-full bg-gray-100 flex-shrink-0 flex items-center justify-center overflow-hidden border border-gray-200">
                                ${team.logo 
                                    ? `<img src="${team.logo}" class="h-full w-full object-cover" />` 
                                    : `<span class="text-lg font-bold" style="color:${team.color}">${team.name.charAt(0)}</span>`
                                }
                            </div>
                            <div>
                                <h3 class="font-bold text-gray-800 truncate">${team.name}</h3>
                                <div class="text-xs text-gray-500 flex items-center gap-2">
                                    <span>${playerCount} Players</span>
                                    ${team.country ? `<span>â€¢ ${team.country}</span>` : ''}
                                </div>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="editTeam('${team.id}')" class="p-2 text-blue-600 hover:bg-blue-50 rounded-full">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" /></svg>
                            </button>
                            <button onclick="deleteTeam('${team.id}')" class="p-2 text-red-600 hover:bg-red-50 rounded-full">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                            </button>
                        </div>
                    `;
                    ui.savedTeamsContainer.appendChild(card);
                });
            });
        }

        window.editTeam = function(id) {
            const team = globalTeamsList.find(t => t.id === id);
            if (!team) return;

            state.editMode = true;
            state.editingTeamId = id;
            
            ui.editorTeamNameInput.value = team.name;
            ui.editorTeamColorInput.value = team.color;
            if(ui.editorTeamCountryInput) ui.editorTeamCountryInput.value = team.country || "";
            
            if (team.logo) {
                ui.editorTeamLogoPreview.src = team.logo;
                ui.editorTeamLogoPreview.dataset.logoSrc = team.logo;
                ui.editorTeamLogoPreview.classList.remove('hidden');
            } else {
                ui.editorTeamLogoPreview.src = '';
                ui.editorTeamLogoPreview.classList.add('hidden');
            }

            // Load Players (Handling old string-only data just in case)
            state.players = (team.players || []).map(p => {
                if(typeof p === 'string') return { name: p, avatar: '' };
                return p;
            });
            
            // Ensure 4 slots
            while(state.players.length < 4) state.players.push({ name: '', avatar: '' });

            state.currentCaptain = team.captain;
            generatePlayerInputs();
            showEditorView();
        };

        window.deleteTeam = function(id) {
            if (confirm("Delete this team permanently?")) {
                db.collection("teams").doc(id).delete().catch(err => alert("Error: " + err.message));
            }
        };

        // --- NAVIGATION ---
        function resetForm() {
            state = { players: [], editMode: false, editingTeamId: null, currentCaptain: null };
            initPlayerSlots();
            ui.editorTeamNameInput.value = '';
            ui.editorTeamColorInput.value = '#3b82f6';
            if(ui.editorTeamCountryInput) ui.editorTeamCountryInput.selectedIndex = 0;
            ui.editorTeamLogoInput.value = '';
            ui.editorTeamLogoPreview.src = '';
            ui.editorTeamLogoPreview.dataset.logoSrc = '';
            ui.editorTeamLogoPreview.classList.add('hidden');
        }

        function showEditorView() {
            ui.teamListView.classList.add('hidden');
            ui.teamEditorView.classList.remove('hidden');
        }

        function showTeamListView() {
            ui.teamEditorView.classList.add('hidden');
            ui.teamListView.classList.remove('hidden');
        }

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            loadSavedTeams();
            showTeamListView();
            
            ui.editorTeamLogoInput.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                // 1. LIMIT CHECK: Warn if file is larger than 5MB
                if (file.size > 5 * 1024 * 1024) {
                    alert("âš ï¸ This logo is too large! Please choose an image smaller than 5MB.");
                    e.target.value = '';
                    return;
                }

                // 2. SMART CROP & COMPRESS
                const reader = new FileReader();
                reader.onload = (readerEvent) => {
                    const tempImg = new Image();
                    tempImg.onload = () => {
                        const MAX_SIZE = 300;
                        const canvas = document.createElement('canvas');
                        canvas.width = MAX_SIZE;
                        canvas.height = MAX_SIZE;
                        const ctx = canvas.getContext('2d');

                        // Crop to square
                        let sWidth, sHeight, sx, sy;
                        if (tempImg.width > tempImg.height) {
                            sHeight = tempImg.height;
                            sWidth = tempImg.height;
                            sx = (tempImg.width - tempImg.height) / 2;
                            sy = 0;
                        } else {
                            sWidth = tempImg.width;
                            sHeight = tempImg.width;
                            sx = 0;
                            sy = (tempImg.height - tempImg.width) / 2;
                        }

                        ctx.drawImage(tempImg, sx, sy, sWidth, sHeight, 0, 0, MAX_SIZE, MAX_SIZE);
                        const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.7);

                        ui.editorTeamLogoPreview.src = compressedDataUrl;
                        ui.editorTeamLogoPreview.dataset.logoSrc = compressedDataUrl;
                        ui.editorTeamLogoPreview.classList.remove('hidden');
                    };
                    tempImg.src = readerEvent.target.result;
                };
                reader.readAsDataURL(file);
            };

            ui.createNewBtn.onclick = () => { resetForm(); showEditorView(); };
            ui.backBtn.onclick = showTeamListView;
            ui.addPlayerBtn.onclick = () => {
                state.players.push({ name: '', avatar: '' });
                generatePlayerInputs();
            };
        });
    </script>
</body>
</html>
