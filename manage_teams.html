<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cricker - Team Manager</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;500;600;700&display=swap');
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #F2F2F7; /* iOS System Gray 6 */
            margin: 0; padding: 0;
            width: 100vw; height: 100vh;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- iOS HEADER --- */
        .ios-header {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(0,0,0,0.1);
            position: sticky; top: 0; z-index: 50;
        }

        /* --- SEGMENTED CONTROL (TABS) --- */
        .segmented-control {
            background-color: #E3E3E8; /* iOS Segment bg */
            border-radius: 9px;
            padding: 2px;
            display: flex;
            margin: 0 16px 8px 16px;
        }
        
        .segment-btn {
            flex: 1;
            text-align: center;
            padding: 6px 0;
            font-size: 13px;
            font-weight: 500;
            border-radius: 7px;
            color: #000;
            transition: all 0.2s ease;
        }
        
        .segment-btn.active {
            background-color: #FFFFFF;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 0.5px 1px rgba(0,0,0,0.08);
            font-weight: 600;
        }

        /* --- iOS LIST STYLES --- */
        .sticky-letter-header {
            position: sticky;
            top: 0;
            background-color: #F2F2F7;
            color: #8E8E93;
            font-weight: 700;
            font-size: 13px;
            padding: 6px 16px;
            z-index: 10;
            border-bottom: 1px solid #E5E5EA;
        }

        .team-row {
            display: flex;
            align-items: center;
            padding: 10px 16px;
            background: white;
            transition: background 0.2s;
        }
        .team-row:active { background-color: #E5E5EA; }

        .team-row-content {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 12px;
            padding-right: 10px;
        }

        .team-row-divider {
            height: 1px;
            background-color: #E5E5EA;
            margin-left: 64px; /* Align with text start */
        }

        .team-avatar {
            width: 42px; height: 42px;
            border-radius: 50%; 
            object-fit: cover;
            box-shadow: inset 0 0 0 1px rgba(0,0,0,0.1);
        }

        /* --- BUTTONS --- */
        .ios-btn {
            padding: 6px 14px;
            border-radius: 100px;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
        }
        .btn-edit { background: #E9F0FD; color: #007AFF; }
        .btn-delete { background: #FDE8E8; color: #FF3B30; }
        
        /* --- MODALS --- */
        .ios-modal-bg {
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(5px);
        }

        /* --- KEYPAD --- */
        .keypad-btn {
            width: 70px; height: 70px; border-radius: 50%; 
            background-color: #FFFFFF;
            color: #000; font-size: 24px; font-weight: 400;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            transition: background 0.1s;
        }
        .keypad-btn:active { background-color: #E5E5EA; }
        .dot { width: 12px; height: 12px; border-radius: 50%; border: 1px solid #000; transition: all 0.2s; }
        .dot.filled { background-color: #000; }

        /* Animation */
        .animate-scale-in { animation: scaleIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes scaleIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* Hide scrollbar */
        ::-webkit-scrollbar { width: 0px; background: transparent; }
    </style>
</head>
<body>

    <div class="flex flex-col h-full relative">
        
        <div class="ios-header pt-3 pb-2 px-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold tracking-tight text-black">Teams</h1>
            <div class="flex items-center gap-3">
                <span id="connection-status" class="text-[10px] font-bold text-gray-400 uppercase">...</span>
                <button onclick="openEditor()" class="text-[#007AFF] text-2xl font-light hover:opacity-70">
                    <svg class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                </button>
            </div>
        </div>

        <div class="px-4 pb-2 bg-[#F2F2F7]">
            <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <svg class="h-4 w-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                </div>
                <input type="text" id="search-teams" class="block w-full pl-9 pr-3 py-2 border-none rounded-xl leading-5 bg-[#E3E3E8] text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-0 focus:bg-[#D1D1D6] sm:text-sm transition-colors" placeholder="Search">
            </div>
        </div>

        <div class="bg-[#F2F2F7] pb-2">
            <div class="segmented-control">
                <button id="tab-all" onclick="switchTab('all')" class="segment-btn active">Community</button>
                <button id="tab-my" onclick="switchTab('my')" class="segment-btn">My Teams</button>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto" id="main-scroll-area">
            <div id="saved-teams-container" class="pb-20 bg-white">
                </div>
        </div>

    </div>

    <div id="team-editor-view" class="fixed inset-0 z-50 bg-[#F2F2F7] transform translate-y-full transition-transform duration-300 flex flex-col">
        <div class="ios-header px-4 py-3 flex justify-between items-center">
            <button onclick="closeEditor()" class="text-[#007AFF] font-medium text-base">Cancel</button>
            <h2 class="text-base font-semibold text-black" id="editor-title">New Team</h2>
            <button onclick="submitForm()" class="text-[#007AFF] font-bold text-base opacity-50" id="save-btn" disabled>Done</button>
        </div>

        <div class="flex-1 overflow-y-auto p-4">
            <form id="team-setup-form" class="space-y-6">
                
                <div class="flex flex-col items-center gap-4">
                    <div class="relative group cursor-pointer" onclick="document.getElementById('editor-team-logo-upload').click()">
                        <div class="h-24 w-24 rounded-full bg-gray-200 overflow-hidden shadow-sm border-2 border-white flex items-center justify-center">
                            <img id="editor-team-logo-preview" class="h-full w-full object-cover hidden">
                            <span class="text-gray-400 text-xs font-bold text-center px-1" id="logo-placeholder">add<br>photo</span>
                        </div>
                        <div class="absolute bottom-0 right-0 bg-[#007AFF] text-white rounded-full p-1 border-2 border-white">
                            <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 4v16m8-8H4"/></svg>
                        </div>
                        <input type="file" id="editor-team-logo-upload" accept="image/*" class="hidden">
                    </div>
                    <input type="text" id="editor-team-name" placeholder="Team Name" class="text-center text-xl font-semibold bg-transparent border-b border-gray-300 focus:border-[#007AFF] outline-none w-3/4 pb-1" oninput="checkFormValidity()">
                </div>

                <div class="bg-white rounded-xl overflow-hidden shadow-sm">
                    <div class="flex items-center p-3 border-b border-gray-100">
                        <label class="w-24 text-sm font-medium text-black">Country</label>
                        <select id="editor-team-country" class="flex-1 bg-transparent text-right text-sm text-[#007AFF] outline-none">
                            <option value="Afghanistan">ğŸ‡¦ğŸ‡« Afghanistan</option><option value="Australia">ğŸ‡¦ğŸ‡º Australia</option><option value="Bangladesh">ğŸ‡§ğŸ‡© Bangladesh</option><option value="Canada">ğŸ‡¨ğŸ‡¦ Canada</option><option value="England">ğŸ´ó §ó ¢ó ¥ó ®ó §ó ¿ England</option><option value="India">ğŸ‡®ğŸ‡³ India</option><option value="Ireland">ğŸ‡®ğŸ‡ª Ireland</option><option value="Namibia">ğŸ‡³ğŸ‡¦ Namibia</option><option value="Nepal">ğŸ‡³ğŸ‡µ Nepal</option><option value="Netherlands">ğŸ‡³ğŸ‡± Netherlands</option><option value="New Zealand">ğŸ‡³ğŸ‡¿ New Zealand</option><option value="Oman">ğŸ‡´ğŸ‡² Oman</option><option value="Pakistan">ğŸ‡µğŸ‡° Pakistan</option><option value="Papua New Guinea">ğŸ‡µğŸ‡¬ Papua New Guinea</option><option value="Scotland">ğŸ´ó §ó ¢ó ³YğŸ‡¹ Scotland</option><option value="South Africa">ğŸ‡¿ğŸ‡¦ South Africa</option><option value="Sri Lanka">ğŸ‡±ğŸ‡° Sri Lanka</option><option value="United Arab Emirates">ğŸ‡¦ğŸ‡ª UAE</option><option value="United Kingdom">ğŸ‡¬ğŸ‡§ United Kingdom</option><option value="United States">ğŸ‡ºğŸ‡¸ USA</option><option value="West Indies">ğŸŒ´ West Indies</option><option value="Zimbabwe">ğŸ‡¿ğŸ‡¼ Zimbabwe</option><option value="Other">ğŸ³ï¸ Other</option>
                        </select>
                    </div>
                    <div class="flex items-center p-3">
                        <label class="w-24 text-sm font-medium text-black">Theme</label>
                        <input type="color" id="editor-team-color" class="ml-auto h-8 w-12 border-none rounded bg-transparent" value="#007AFF">
                    </div>
                </div>

                <div class="bg-white rounded-xl overflow-hidden shadow-sm p-4">
                    <h3 class="text-xs font-bold text-gray-500 uppercase mb-3">Creator Security</h3>
                    
                    <div class="flex flex-col gap-4">
                        <div>
                            <label class="text-sm font-medium text-black mb-1 block">Creator Code (PIN)</label>
                            <input type="tel" id="editor-team-pin" maxlength="4" placeholder="4-digit PIN" class="w-full bg-gray-50 p-2.5 rounded-lg text-center tracking-[8px] font-mono text-lg outline-none focus:ring-2 focus:ring-[#007AFF]" oninput="checkFormValidity()">
                            <p class="text-[10px] text-gray-400 mt-1">Don't forget this! You need it to edit.</p>
                        </div>
                        
                        <div>
                            <label class="text-sm font-medium text-black mb-1 block">Mobile Number (Recovery)</label>
                            <input type="tel" id="editor-team-mobile" placeholder="+1 234 567 8900" class="w-full bg-gray-50 p-2.5 rounded-lg text-sm outline-none focus:ring-2 focus:ring-[#007AFF]">
                            <p class="text-[10px] text-gray-400 mt-1">Used for verification if you lose your code.</p>
                        </div>
                    </div>
                </div>

                <div>
                    <div class="flex justify-between items-end mb-2 px-1">
                        <h3 class="text-xs font-bold text-gray-500 uppercase">Squad</h3>
                        <div class="flex gap-3 text-[10px] font-bold text-gray-400">
                            <span>Bat</span><span>Bowl</span><span>WK</span>
                        </div>
                    </div>
                    <div id="player-inputs-container" class="space-y-2"></div>
                    
                    <div class="flex gap-2 mt-3">
                        <button type="button" onclick="addPlayerSlot()" class="flex-1 py-2 bg-white text-[#007AFF] text-sm font-semibold rounded-lg shadow-sm">Add Player</button>
                        <button type="button" onclick="openBulkModal()" class="px-4 py-2 bg-white text-[#007AFF] text-sm font-semibold rounded-lg shadow-sm">Paste List</button>
                    </div>
                </div>

                <div class="bg-white rounded-xl overflow-hidden shadow-sm p-3">
                    <label class="block text-xs font-medium text-gray-500 uppercase mb-1">Captain</label>
                    <select id="captain-select" class="w-full bg-transparent text-sm text-black outline-none font-medium">
                        <option value="" disabled selected>Add players first...</option>
                    </select>
                </div>

            </form>
            <div class="h-20"></div> </div>
    </div>

    <div id="passcode-modal" class="fixed inset-0 z-[60] ios-modal-bg hidden flex flex-col justify-end">
        <div class="bg-[#F2F2F7] rounded-t-2xl p-6 animate-slide-up pb-10">
            <div class="text-center mb-6">
                <div class="w-12 h-1 bg-gray-300 rounded-full mx-auto mb-6"></div>
                <h3 class="text-lg font-bold text-black" id="pin-modal-title">Enter Creator Code</h3>
                <p class="text-xs text-gray-500 mt-1" id="pin-modal-desc">Type code to access</p>
                <div id="passcode-dots" class="flex justify-center gap-4 mt-4 mb-4">
                    <div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div>
                </div>
                <button onclick="openContactModal()" class="text-xs text-[#007AFF] font-medium">Forgot PIN?</button>
            </div>

            <div class="grid grid-cols-3 gap-x-6 gap-y-4 max-w-[280px] mx-auto">
                <div class="keypad-btn" onclick="handleKeypad(1)">1</div>
                <div class="keypad-btn" onclick="handleKeypad(2)">2</div>
                <div class="keypad-btn" onclick="handleKeypad(3)">3</div>
                <div class="keypad-btn" onclick="handleKeypad(4)">4</div>
                <div class="keypad-btn" onclick="handleKeypad(5)">5</div>
                <div class="keypad-btn" onclick="handleKeypad(6)">6</div>
                <div class="keypad-btn" onclick="handleKeypad(7)">7</div>
                <div class="keypad-btn" onclick="handleKeypad(8)">8</div>
                <div class="keypad-btn" onclick="handleKeypad(9)">9</div>
                <div class="keypad-btn opacity-0 cursor-default"></div> 
                <div class="keypad-btn" onclick="handleKeypad(0)">0</div>
                <div class="keypad-btn bg-transparent shadow-none" onclick="handleKeypad('back')">
                    <svg class="h-6 w-6 text-black" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2M3 12l6.414 6.414a2 2 0 001.414.586H19a2 2 0 002-2V7a2 2 0 00-2-2h-8.172a2 2 0 00-1.414.586L3 12z" /></svg>
                </div>
            </div>
            
            <button onclick="closePasscodeModal()" class="w-full mt-8 text-[#007AFF] font-semibold text-lg">Cancel</button>
        </div>
    </div>

    <div id="contact-modal" class="fixed inset-0 z-[80] ios-modal-bg hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-sm overflow-hidden text-center p-6 animate-scale-in">
            <div class="w-14 h-14 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4 text-green-600">
                <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                </svg>
            </div>
            <h3 class="text-xl font-bold text-black mb-2">Forgot PIN?</h3>
            <p class="text-gray-500 text-sm mb-6 leading-relaxed">
                Please contact the Admin to retrieve your code.
                <br><span class="font-semibold text-gray-700">+1 416-474-4994</span>
            </p>
            <a href="https://wa.me/14164744994" target="_blank" class="block w-full py-3.5 bg-[#25D366] text-white font-bold rounded-xl mb-3 shadow-lg transform active:scale-95 transition-transform flex items-center justify-center gap-2">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                Chat on WhatsApp
            </a>
            <button onclick="closeContactModal()" class="text-gray-400 font-medium text-sm hover:text-gray-600 p-2">Close</button>
        </div>
    </div>

    <div id="bulk-paste-modal" class="fixed inset-0 z-[70] ios-modal-bg hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-sm overflow-hidden">
            <div class="p-4 border-b border-gray-100 flex justify-between items-center">
                <h3 class="font-bold text-gray-800">Paste List</h3>
                <button onclick="document.getElementById('bulk-paste-modal').classList.add('hidden')" class="text-gray-400">âœ•</button>
            </div>
            <div class="p-4">
                <textarea id="bulk-paste-area" class="w-full h-32 p-3 bg-gray-50 rounded-lg text-sm border-none focus:ring-2 focus:ring-[#007AFF]" placeholder="Paste names..."></textarea>
                <button onclick="processBulkPaste()" class="mt-3 w-full py-3 bg-[#007AFF] text-white font-bold rounded-xl">Import</button>
            </div>
        </div>
    </div>

    <div class="toast-container"></div>

    <script>
        // ==========================================
        // CONFIG
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyBqcD59IAPpKqk98oDZkgzgkoVZ8b8LGgY",
            authDomain: "livecricketscoring-92087.firebaseapp.com",
            databaseURL: "https://livecricketscoring-92087-default-rtdb.firebaseio.com", 
            projectId: "livecricketscoring-92087",
            storageBucket: "livecricketscoring-92087.firebasestorage.app",
            messagingSenderId: "522927197627",
            appId: "1:522927197627:web:f1df5db736cae96893089e"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(); 
        const auth = firebase.auth();

        // Global State
        let globalTeamsList = [];
        let state = {
            players: [], 
            editMode: false,
            editingTeamId: null,
            passcode: "",
            targetTeamForPin: null, 
            pendingAction: null,
            activeTab: 'all', // 'all' or 'my'
            currentUserUid: null
        };

        const countryFlags = { "Afghanistan": "ğŸ‡¦ğŸ‡«", "Australia": "ğŸ‡¦ğŸ‡º", "Bangladesh": "ğŸ‡§ğŸ‡©", "Canada": "ğŸ‡¨ğŸ‡¦", "England": "ğŸ´ó §ó ¢ó ¥ó ®ó §ó ¿", "India": "ğŸ‡®ğŸ‡³", "Ireland": "ğŸ‡®ğŸ‡ª", "Namibia": "ğŸ‡³ğŸ‡¦", "Nepal": "ğŸ‡³ğŸ‡µ", "Netherlands": "ğŸ‡³ğŸ‡±", "New Zealand": "ğŸ‡³ğŸ‡¿", "Oman": "ğŸ‡´ğŸ‡²", "Pakistan": "ğŸ‡µğŸ‡°", "Papua New Guinea": "ğŸ‡µğŸ‡¬", "Scotland": "ğŸ´ó §ó ¢ó ³YğŸ‡¹", "South Africa": "ğŸ‡¿ğŸ‡¦", "Sri Lanka": "ğŸ‡±ğŸ‡°", "United Arab Emirates": "ğŸ‡¦ğŸ‡ª", "United Kingdom": "ğŸ‡¬ğŸ‡§", "United States": "ğŸ‡ºğŸ‡¸", "West Indies": "ğŸŒ´", "Zimbabwe": "ğŸ‡¿ğŸ‡¼", "Other": "ğŸ³ï¸" };

        // ==========================================
        // INIT & LOAD
        // ==========================================
        document.addEventListener('DOMContentLoaded', () => {
            // Anonymous Auth to ensure Firestore access and "My Teams" logic
            auth.signInAnonymously().then((userCred) => {
                state.currentUserUid = userCred.user.uid;
                document.getElementById('connection-status').textContent = "ONLINE";
                document.getElementById('connection-status').className = "text-[10px] font-bold text-green-500 uppercase";
                loadTeams();
            }).catch(e => {
                console.error(e);
                loadTeams(); // Try load anyway
            });

            document.getElementById('search-teams').addEventListener('input', renderTeams);
            document.getElementById('editor-team-logo-upload').onchange = handleImageUpload;
        });

        function loadTeams() {
            db.collection("teams").onSnapshot(snapshot => {
                globalTeamsList = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    data.id = doc.id;
                    if(!data.name) data.name = "Untitled";
                    globalTeamsList.push(data);
                });
                // Sort alphabetically for Apple Contacts style
                globalTeamsList.sort((a, b) => a.name.localeCompare(b.name));
                renderTeams();
            });
        }

        function switchTab(tab) {
            state.activeTab = tab;
            
            // UI Toggle
            document.getElementById('tab-all').classList.remove('active');
            document.getElementById('tab-my').classList.remove('active');
            document.getElementById(`tab-${tab}`).classList.add('active');
            
            renderTeams();
        }

        // ==========================================
        // RENDER (APPLE CONTACTS STYLE)
        // ==========================================
        function renderTeams() {
            const container = document.getElementById('saved-teams-container');
            container.innerHTML = '';
            
            const searchTerm = document.getElementById('search-teams').value.toLowerCase();
            
            let filtered = globalTeamsList.filter(t => t.name.toLowerCase().includes(searchTerm) || (t.country || "").toLowerCase().includes(searchTerm));

            // FILTER BY TAB
            if (state.activeTab === 'my') {
                if (state.currentUserUid) {
                    filtered = filtered.filter(t => t.ownerId === state.currentUserUid);
                } else {
                    filtered = []; // If not logged in properly, show empty
                }
            }

            if(filtered.length === 0) {
                const msg = state.activeTab === 'my' ? "You haven't created any teams yet." : "No teams found";
                container.innerHTML = `<div class="text-center py-10 text-gray-400 text-sm">${msg}</div>`;
                return;
            }

            let currentLetter = '';

            filtered.forEach(team => {
                const firstLetter = team.name.charAt(0).toUpperCase();
                
                // Sticky Header logic
                if (firstLetter !== currentLetter) {
                    currentLetter = firstLetter;
                    const header = document.createElement('div');
                    header.className = 'sticky-letter-header';
                    header.textContent = currentLetter;
                    container.appendChild(header);
                }

                const row = document.createElement('div');
                row.className = 'team-row';
                
                const initial = team.name.charAt(0).toUpperCase();
                const logoHtml = team.logo 
                    ? `<img src="${team.logo}" class="team-avatar">`
                    : `<div class="team-avatar flex items-center justify-center bg-gray-200 text-gray-500 font-bold text-lg">${initial}</div>`;

                row.innerHTML = `
                    <div class="team-row-content">
                        ${logoHtml}
                        <div class="flex flex-col">
                            <span class="text-[17px] font-semibold text-black leading-tight">${team.name}</span>
                            <span class="text-[13px] text-gray-500">${countryFlags[team.country] || 'ğŸ³ï¸'} ${team.country || 'Other'}</span>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="initiateAction('${team.id}', 'edit')" class="ios-btn btn-edit">Edit</button>
                        <button onclick="initiateAction('${team.id}', 'delete')" class="ios-btn btn-delete">Delete</button>
                    </div>
                `;
                
                container.appendChild(row);
                
                // Divider
                const divider = document.createElement('div');
                divider.className = 'team-row-divider';
                container.appendChild(divider);
            });
        }

        // ==========================================
        // SECURITY & ACTIONS
        // ==========================================
        function initiateAction(teamId, action) {
            state.targetTeamForPin = globalTeamsList.find(t => t.id === teamId);
            state.pendingAction = action;
            state.passcode = "";
            
            // UI Update
            document.getElementById('pin-modal-title').textContent = action === 'delete' ? "Delete Team?" : "Edit Team";
            document.getElementById('pin-modal-desc').textContent = `Enter Creator Code for ${state.targetTeamForPin.name}`;
            updatePasscodeUI();
            
            document.getElementById('passcode-modal').classList.remove('hidden');
        }

        function closePasscodeModal() {
            document.getElementById('passcode-modal').classList.add('hidden');
            state.passcode = "";
        }

        function handleKeypad(key) {
            if (key === 'back') {
                state.passcode = state.passcode.slice(0, -1);
            } else if (state.passcode.length < 4) {
                state.passcode += key;
            }
            updatePasscodeUI();

            if (state.passcode.length === 4) {
                setTimeout(verifyPin, 100);
            }
        }

        function verifyPin() {
            const entered = state.passcode;
            const correctPin = state.targetTeamForPin.pin;
            const adminCode = "2626";

            if (entered === correctPin || entered === adminCode) {
                // Success
                closePasscodeModal();
                if (state.pendingAction === 'edit') {
                    openEditor(state.targetTeamForPin);
                } else if (state.pendingAction === 'delete') {
                    if(confirm("Are you sure? This cannot be undone.")) {
                        db.collection("teams").doc(state.targetTeamForPin.id).delete()
                        .then(() => showToast("Team deleted", "success"));
                    }
                }
            } else {
                // Fail
                document.getElementById('passcode-dots').classList.add('animate-pulse');
                setTimeout(() => {
                    document.getElementById('passcode-dots').classList.remove('animate-pulse');
                    state.passcode = "";
                    updatePasscodeUI();
                    showToast("Wrong Code", "error");
                }, 200);
            }
        }

        function updatePasscodeUI() {
            const dots = document.getElementById('passcode-dots').children;
            for(let i=0; i<4; i++) {
                if (i < state.passcode.length) dots[i].classList.add('filled');
                else dots[i].classList.remove('filled');
            }
        }

        // ==========================================
        // CONTACT MODAL (WHATSAPP)
        // ==========================================
        function openContactModal() {
            document.getElementById('contact-modal').classList.remove('hidden');
        }
        function closeContactModal() {
            document.getElementById('contact-modal').classList.add('hidden');
        }

        // ==========================================
        // EDITOR LOGIC
        // ==========================================
        function openEditor(team = null) {
            const modal = document.getElementById('team-editor-view');
            const title = document.getElementById('editor-title');
            
            if (team) {
                state.editMode = true;
                state.editingTeamId = team.id;
                title.textContent = "Edit Team";
                
                document.getElementById('editor-team-name').value = team.name;
                document.getElementById('editor-team-color').value = team.color || '#007AFF';
                document.getElementById('editor-team-country').value = team.country || 'Other';
                document.getElementById('editor-team-pin').value = team.pin || '';
                document.getElementById('editor-team-mobile').value = team.mobile || ''; // Load mobile
                
                if (team.logo) {
                    const img = document.getElementById('editor-team-logo-preview');
                    img.src = team.logo;
                    img.dataset.logoSrc = team.logo;
                    img.classList.remove('hidden');
                    document.getElementById('logo-placeholder').classList.add('hidden');
                }

                state.players = (team.players || []).map(p => ({
                    name: p.name || p, 
                    avatar: p.avatar || '', 
                    roles: p.roles || {bat:false, bowl:false, wk:false}
                }));
            } else {
                state.editMode = false;
                title.textContent = "New Team";
                resetEditor();
            }

            // Ensure min players
            while(state.players.length < 4) state.players.push({name:'', avatar:'', roles:{bat:false, bowl:false, wk:false}});
            
            renderPlayerInputs();
            modal.classList.remove('translate-y-full');
            checkFormValidity();
        }

        function closeEditor() {
            document.getElementById('team-editor-view').classList.add('translate-y-full');
        }

        function resetEditor() {
            document.getElementById('team-setup-form').reset();
            state.players = [];
            document.getElementById('editor-team-logo-preview').classList.add('hidden');
            document.getElementById('logo-placeholder').classList.remove('hidden');
            document.getElementById('editor-team-logo-preview').dataset.logoSrc = "";
        }

        function renderPlayerInputs() {
            const container = document.getElementById('player-inputs-container');
            container.innerHTML = '';
            
            const currentCap = document.getElementById('captain-select').value;
            const capSelect = document.getElementById('captain-select');
            capSelect.innerHTML = '<option value="" disabled selected>Select Captain</option>';

            state.players.forEach((player, idx) => {
                const div = document.createElement('div');
                div.className = "flex items-center gap-2 bg-white p-2 rounded-lg border border-gray-100";
                
                const roleBat = player.roles.bat ? 'bg-blue-100 text-blue-600 border-blue-200' : 'opacity-30 grayscale';
                const roleBowl = player.roles.bowl ? 'bg-green-100 text-green-600 border-green-200' : 'opacity-30 grayscale';
                const roleWk = player.roles.wk ? 'bg-orange-100 text-orange-600 border-orange-200' : 'opacity-30 grayscale';

                div.innerHTML = `
                    <input type="text" value="${player.name}" placeholder="Player ${idx + 1}" 
                        class="flex-1 bg-transparent text-sm font-medium outline-none"
                        oninput="updatePlayerName(${idx}, this.value)">
                    
                    <div class="flex gap-1">
                        <button type="button" onclick="toggleRole(${idx}, 'bat')" class="w-6 h-6 rounded border flex items-center justify-center text-xs ${roleBat}">ğŸ</button>
                        <button type="button" onclick="toggleRole(${idx}, 'bowl')" class="w-6 h-6 rounded border flex items-center justify-center text-xs ${roleBowl}">âš¾</button>
                        <button type="button" onclick="toggleRole(${idx}, 'wk')" class="w-6 h-6 rounded border flex items-center justify-center text-xs ${roleWk}">ğŸ§¤</button>
                    </div>
                    <button type="button" onclick="removePlayer(${idx})" class="text-red-400 pl-2">Ã—</button>
                `;
                container.appendChild(div);

                // Populate Captain Select
                if (player.name) {
                    const opt = document.createElement('option');
                    opt.value = player.name;
                    opt.textContent = player.name;
                    if(player.name === currentCap) opt.selected = true;
                    capSelect.appendChild(opt);
                }
            });
        }

        function updatePlayerName(idx, val) {
            state.players[idx].name = val;
            renderPlayerInputs(); // Re-render to update captain list real-time
            checkFormValidity();
        }

        function toggleRole(idx, role) {
            state.players[idx].roles[role] = !state.players[idx].roles[role];
            renderPlayerInputs();
        }

        function addPlayerSlot() {
            state.players.push({name:'', avatar:'', roles:{bat:false, bowl:false, wk:false}});
            renderPlayerInputs();
        }

        function removePlayer(idx) {
            state.players.splice(idx, 1);
            renderPlayerInputs();
        }

        function handleImageUpload(e) {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                // Simple canvas compression logic could go here, simplified for brevity
                const img = document.getElementById('editor-team-logo-preview');
                img.src = ev.target.result;
                img.dataset.logoSrc = ev.target.result;
                img.classList.remove('hidden');
                document.getElementById('logo-placeholder').classList.add('hidden');
            };
            reader.readAsDataURL(file);
        }

        function checkFormValidity() {
            const name = document.getElementById('editor-team-name').value.trim();
            const pin = document.getElementById('editor-team-pin').value;
            const validPlayers = state.players.filter(p => p.name.trim() !== "").length;
            
            const btn = document.getElementById('save-btn');
            if (name && pin.length === 4 && validPlayers >= 2) {
                btn.disabled = false;
                btn.classList.remove('opacity-50');
            } else {
                btn.disabled = true;
                btn.classList.add('opacity-50');
            }
        }

        function submitForm() {
            const name = document.getElementById('editor-team-name').value.trim().toUpperCase();
            const pin = document.getElementById('editor-team-pin').value;
            const mobile = document.getElementById('editor-team-mobile').value;
            const country = document.getElementById('editor-team-country').value;
            const color = document.getElementById('editor-team-color').value;
            const logo = document.getElementById('editor-team-logo-preview').dataset.logoSrc || "";
            const captain = document.getElementById('captain-select').value;

            const validPlayers = state.players.filter(p => p.name.trim() !== "").map(p => ({
                ...p, name: titleCase(p.name)
            }));

            const data = { 
                name, pin, mobile, country, color, logo, captain, 
                players: validPlayers, 
                updatedAt: firebase.firestore.FieldValue.serverTimestamp() 
            };

            // If creating new, assign owner
            if (!state.editMode && state.currentUserUid) {
                data.ownerId = state.currentUserUid;
            }

            const saveBtn = document.getElementById('save-btn');
            saveBtn.textContent = "...";

            const promise = state.editMode 
                ? db.collection("teams").doc(state.editingTeamId).update(data)
                : db.collection("teams").add(data);

            promise.then(() => {
                showToast("Saved!", "success");
                closeEditor();
            }).catch(err => {
                showToast("Error: " + err.message, "error");
            }).finally(() => {
                saveBtn.textContent = "Done";
            });
        }

        // --- UTILS ---
        function titleCase(str) { return str.toLowerCase().split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' '); }
        function showToast(msg, type) {
            const t = document.createElement('div'); t.className = 'toast';
            t.innerHTML = `<span>${msg}</span>`;
            document.querySelector('.toast-container').appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }

        // Bulk Logic
        function openBulkModal() { document.getElementById('bulk-paste-modal').classList.remove('hidden'); }
        function processBulkPaste() {
            const txt = document.getElementById('bulk-paste-area').value;
            const names = txt.split(/\r?\n/).map(l => l.replace(/^[\d\W]+/, '').trim()).filter(n => n);
            names.forEach(n => state.players.push({name: titleCase(n), roles:{bat:false,bowl:false,wk:false}}));
            renderPlayerInputs();
            document.getElementById('bulk-paste-modal').classList.add('hidden');
        }
    </script>
</body>
</html>
