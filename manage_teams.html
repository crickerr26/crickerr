<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cricker - Team Manager</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;500;600;700&display=swap');
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #F2F2F7; /* iOS System Gray 6 */
            margin: 0; padding: 0;
            width: 100vw; height: 100vh;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- iOS HEADER & GLASS EFFECTS --- */
        .ios-header {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(0,0,0,0.1);
            position: sticky; top: 0; z-index: 50;
        }

        /* --- SEGMENTED CONTROL (TABS) --- */
        .segmented-control {
            background-color: rgba(118, 118, 128, 0.12);
            border-radius: 9px;
            padding: 2px;
            display: flex;
            margin: 0 16px 8px 16px;
        }
        
        .segment-btn {
            flex: 1; text-align: center; padding: 6px 0;
            font-size: 13px; font-weight: 500;
            border-radius: 7px; color: #000;
            transition: all 0.2s ease;
        }
        
        .segment-btn.active {
            background-color: #FFFFFF;
            box-shadow: 0 3px 8px rgba(0,0,0,0.12), 0 3px 1px rgba(0,0,0,0.04);
            font-weight: 600;
        }

        /* --- SEARCH --- */
        .ios-search-container {
            position: relative;
            background: rgba(118, 118, 128, 0.12);
            border-radius: 10px;
            display: flex; align-items: center;
        }
        
        /* --- LIST STYLES --- */
        .sticky-letter-header {
            position: sticky; top: 0;
            background-color: rgba(242, 242, 247, 0.95);
            backdrop-filter: blur(10px);
            color: #8E8E93; font-weight: 700; font-size: 13px;
            padding: 6px 16px; z-index: 10;
            border-bottom: 1px solid #E5E5EA;
        }

        .team-row {
            display: flex; align-items: center;
            padding: 10px 16px; background: white;
            transition: background 0.2s;
        }
        .team-row:active { background-color: #E5E5EA; }

        .team-row-content { flex: 1; display: flex; align-items: center; gap: 12px; padding-right: 10px; }
        .team-row-divider { height: 1px; background-color: #E5E5EA; margin-left: 64px; }
        .team-avatar { width: 42px; height: 42px; border-radius: 50%; object-fit: cover; box-shadow: inset 0 0 0 1px rgba(0,0,0,0.1); }

        /* --- BUTTONS --- */
        .ios-btn { padding: 6px 14px; border-radius: 100px; font-size: 13px; font-weight: 600; transition: all 0.2s; }
        .btn-edit { background: #E9F0FD; color: #007AFF; }
        .btn-delete { background: #FDE8E8; color: #FF3B30; }
        
        /* --- MODALS --- */
        .ios-modal-bg { background: rgba(0,0,0,0.4); backdrop-filter: blur(5px); }
        
        /* --- ALERTS --- */
        .ios-alert-box {
            background: rgba(245, 245, 245, 0.85); backdrop-filter: blur(25px);
            border-radius: 14px; width: 270px; text-align: center; overflow: hidden;
            animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* --- KEYPAD --- */
        .keypad-btn {
            width: 70px; height: 70px; border-radius: 50%; 
            background-color: #FFFFFF; color: #000; font-size: 24px; font-weight: 400;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            transition: background 0.1s;
        }
        .keypad-btn:active { background-color: #E5E5EA; }
        .dot { width: 12px; height: 12px; border-radius: 50%; border: 1px solid #000; transition: all 0.2s; }
        .dot.filled { background-color: #000; }

        /* --- WATERY INPUTS --- */
        .watery-input {
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.02);
        }
        
        .captain-badge {
            background: linear-gradient(135deg, #FFD700, #FDB931);
            color: white; font-size: 10px; font-weight: 900;
            width: 16px; height: 16px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        /* Hide scrollbar */
        ::-webkit-scrollbar { width: 0px; background: transparent; }
    </style>
</head>
<body>

    <div class="flex flex-col h-full relative">
        
        <div class="ios-header pt-3 pb-2 px-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold tracking-tight text-black">Team Management</h1>
            <div class="flex items-center gap-3">
                <span id="connection-status" class="text-[10px] font-bold text-gray-400 uppercase">...</span>
                <button onclick="openEditor()" class="text-[#007AFF] text-2xl font-light hover:opacity-70">
                    <svg class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                </button>
            </div>
        </div>

        <div class="px-4 pb-2 bg-[#F2F2F7]">
            <div class="ios-search-container">
                <div class="pl-3 text-gray-500">
                    <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                </div>
                <input type="text" id="search-teams" class="w-full py-2 pl-2 pr-2 bg-transparent text-gray-900 placeholder-gray-500 focus:outline-none sm:text-sm" placeholder="Search">
                
                <button onclick="openFilterModal()" class="pr-2 text-[#007AFF] hover:text-[#0056b3] transition-colors p-2">
                    <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
                    </svg>
                </button>
            </div>
        </div>

        <div class="bg-[#F2F2F7] pb-2">
            <div class="segmented-control">
                <button id="tab-all" onclick="switchTab('all')" class="segment-btn active">All Teams</button>
                <button id="tab-my" onclick="switchTab('my')" class="segment-btn">My Teams</button>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto" id="main-scroll-area">
            <div id="saved-teams-container" class="pb-20 bg-white">
                </div>
        </div>

    </div>

    <div id="team-editor-view" class="fixed inset-0 z-50 bg-[#F2F2F7] transform translate-y-full transition-transform duration-300 flex flex-col">
        <div class="ios-header px-4 py-3 flex justify-between items-center">
            <button onclick="closeEditor()" class="text-[#007AFF] font-medium text-base">Cancel</button>
            <h2 class="text-base font-semibold text-black" id="editor-title">New Team</h2>
            <button onclick="submitForm()" class="text-[#007AFF] font-bold text-base opacity-50 transition-opacity" id="save-btn" disabled>Done</button>
        </div>

        <div class="flex-1 overflow-y-auto p-4">
            <form id="team-setup-form" class="space-y-6">
                
                <div class="flex flex-col items-center gap-4">
                    <div class="relative group cursor-pointer" onclick="document.getElementById('editor-team-logo-upload').click()">
                        <div class="h-24 w-24 rounded-full bg-gray-200 overflow-hidden shadow-sm border-2 border-white flex items-center justify-center">
                            <img id="editor-team-logo-preview" class="h-full w-full object-cover hidden">
                            <span class="text-gray-400 text-xs font-bold text-center px-1" id="logo-placeholder">add<br>photo</span>
                        </div>
                        <div class="absolute bottom-0 right-0 bg-[#007AFF] text-white rounded-full p-1 border-2 border-white shadow-md">
                            <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 4v16m8-8H4"/></svg>
                        </div>
                        <input type="file" id="editor-team-logo-upload" accept="image/*" class="hidden">
                    </div>
                    <input type="text" id="editor-team-name" placeholder="Team Name" class="text-center text-base md:text-xl font-semibold bg-transparent border-b border-gray-300 focus:border-[#007AFF] outline-none w-3/4 pb-1" oninput="checkFormValidity()">
                </div>

                <div class="bg-white rounded-xl overflow-hidden shadow-sm">
                    <div class="flex items-center p-3 border-b border-gray-100">
                        <label class="w-24 text-sm font-medium text-black">Country</label>
                        <select id="editor-team-country" class="flex-1 bg-transparent text-right text-sm text-[#007AFF] outline-none">
                            <option value="Afghanistan">ğŸ‡¦ğŸ‡« Afghanistan</option><option value="Australia">ğŸ‡¦ğŸ‡º Australia</option><option value="Bangladesh">ğŸ‡§ğŸ‡© Bangladesh</option><option value="Canada">ğŸ‡¨ğŸ‡¦ Canada</option><option value="England">ğŸ´ó §ó ¢ó ¥ó ®ó §ó ¿ England</option><option value="India">ğŸ‡®ğŸ‡³ India</option><option value="Ireland">ğŸ‡®ğŸ‡ª Ireland</option><option value="Namibia">ğŸ‡³ğŸ‡¦ Namibia</option><option value="Nepal">ğŸ‡³ğŸ‡µ Nepal</option><option value="Netherlands">ğŸ‡³ğŸ‡± Netherlands</option><option value="New Zealand">ğŸ‡³ğŸ‡¿ New Zealand</option><option value="Oman">ğŸ‡´ğŸ‡² Oman</option><option value="Pakistan">ğŸ‡µğŸ‡° Pakistan</option><option value="Papua New Guinea">ğŸ‡µğŸ‡¬ Papua New Guinea</option><option value="Scotland">ğŸ´ó §ó ¢ó ³YğŸ‡¹ Scotland</option><option value="South Africa">ğŸ‡¿ğŸ‡¦ South Africa</option><option value="Sri Lanka">ğŸ‡±ğŸ‡° Sri Lanka</option><option value="United Arab Emirates">ğŸ‡¦ğŸ‡ª UAE</option><option value="United Kingdom">ğŸ‡¬ğŸ‡§ United Kingdom</option><option value="United States">ğŸ‡ºğŸ‡¸ USA</option><option value="West Indies">ğŸŒ´ West Indies</option><option value="Zimbabwe">ğŸ‡¿ğŸ‡¼ Zimbabwe</option><option value="Other">ğŸ³ï¸ Other</option>
                        </select>
                    </div>
                    <div class="flex items-center p-3">
                        <label class="w-24 text-sm font-medium text-black">Theme</label>
                        <input type="color" id="editor-team-color" class="ml-auto h-8 w-12 border-none rounded bg-transparent" value="#007AFF">
                    </div>
                </div>

                <div class="bg-white rounded-xl overflow-hidden shadow-sm p-4">
                    <h3 class="text-xs font-bold text-gray-500 uppercase mb-3">Creator Details</h3>
                    
                    <div class="flex flex-col gap-4">
                        <div>
                            <label class="text-sm font-medium text-black mb-1 block">Your Name (Creator)</label>
                            <input type="text" id="editor-creator-name" placeholder="Who is creating this?" class="watery-input w-full p-2.5 rounded-lg text-sm outline-none focus:ring-2 focus:ring-[#007AFF]" oninput="checkFormValidity()">
                        </div>

                        <div>
                            <label class="text-sm font-medium text-black mb-1 block">Creator Code (PIN)</label>
                            <input type="tel" id="editor-team-pin" maxlength="4" placeholder="4-digit PIN" class="watery-input w-full p-2.5 rounded-lg text-center tracking-[8px] font-mono text-lg outline-none focus:ring-2 focus:ring-[#007AFF]" oninput="checkFormValidity()">
                        </div>
                        
                        <div>
                            <label class="text-sm font-medium text-black mb-1 block">Mobile Number <span class="text-red-500">*</span></label>
                            <div class="flex gap-2">
                                <div class="relative w-28">
                                    <select id="country-code-select" class="watery-input w-full p-2.5 rounded-lg text-sm appearance-none outline-none font-medium text-gray-700 focus:ring-2 focus:ring-[#007AFF]">
                                        <option value="+1">ğŸ‡¨ğŸ‡¦ +1</option><option value="+93">ğŸ‡¦ğŸ‡« +93</option><option value="+61">ğŸ‡¦ğŸ‡º +61</option><option value="+880">ğŸ‡§ğŸ‡© +880</option><option value="+44">ğŸ´ó §ó ¢ó ¥ó ®ó §ó ¿ +44</option><option value="+91">ğŸ‡®ğŸ‡³ +91</option><option value="+353">ğŸ‡®ğŸ‡ª +353</option><option value="+264">ğŸ‡³ğŸ‡¦ +264</option><option value="+977">ğŸ‡³ğŸ‡µ +977</option><option value="+31">ğŸ‡³ğŸ‡± +31</option><option value="+64">ğŸ‡³ğŸ‡¿ +64</option><option value="+968">ğŸ‡´ğŸ‡² +968</option><option value="+92">ğŸ‡µğŸ‡° +92</option><option value="+675">ğŸ‡µğŸ‡¬ +675</option><option value="+44">ğŸ´ó §ó ¢ó ³YğŸ‡¹ +44</option><option value="+27">ğŸ‡¿ğŸ‡¦ +27</option><option value="+94">ğŸ‡±ğŸ‡° +94</option><option value="+971">ğŸ‡¦ğŸ‡ª +971</option><option value="+44">ğŸ‡¬ğŸ‡§ +44</option><option value="+1">ğŸ‡ºğŸ‡¸ +1</option><option value="+1">ğŸŒ´ +1</option><option value="+263">ğŸ‡¿ğŸ‡¼ +263</option>
                                    </select>
                                    <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none">
                                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                    </div>
                                </div>
                                <input type="tel" id="mobile-number-input" placeholder="Phone Number" class="watery-input flex-1 p-2.5 rounded-lg text-sm outline-none focus:ring-2 focus:ring-[#007AFF]" oninput="checkFormValidity()">
                            </div>
                            <p class="text-[10px] text-gray-400 mt-1">We'll use this if you forget your code.</p>
                        </div>
                    </div>
                </div>

                <div>
                    <div class="flex justify-between items-end mb-2 px-1">
                        <h3 class="text-xs font-bold text-gray-500 uppercase">Squad</h3>
                        <div class="flex gap-3 text-[10px] font-bold text-gray-400">
                            <span>Bat</span><span>Bowl</span><span>WK</span>
                        </div>
                    </div>
                    <div id="player-inputs-container" class="space-y-3"></div>
                    
                    <div class="flex gap-2 mt-3">
                        <button type="button" onclick="addPlayerSlot()" class="flex-1 py-2 bg-white text-[#007AFF] text-sm font-semibold rounded-lg shadow-sm">Add Player</button>
                        <button type="button" onclick="openBulkModal()" class="px-4 py-2 bg-white text-[#007AFF] text-sm font-semibold rounded-lg shadow-sm">Paste List</button>
                    </div>
                </div>

                <div class="bg-white rounded-xl overflow-hidden shadow-sm p-3">
                    <label class="block text-xs font-medium text-gray-500 uppercase mb-1">Captain</label>
                    <select id="captain-select" class="w-full bg-transparent text-sm text-black outline-none font-medium" onchange="updateCaptainIcon()">
                        <option value="" disabled selected>Add players first...</option>
                    </select>
                </div>

            </form>
            <div class="h-20"></div>
        </div>
    </div>

    <div id="ios-alert-modal" class="fixed inset-0 z-[100] ios-modal-bg hidden flex items-center justify-center p-6">
        <div class="ios-alert-box">
            <div class="p-4">
                <h3 class="text-[17px] font-bold text-black mb-1" id="alert-title">Alert</h3>
                <p class="text-[13px] text-black leading-relaxed" id="alert-message">Message</p>
            </div>
            <div class="border-t border-gray-300/50 flex">
                <button onclick="closeiOSAlert()" class="flex-1 py-3 text-[17px] text-[#007AFF] font-semibold active:bg-gray-100" id="alert-btn">OK</button>
            </div>
        </div>
    </div>

    <div id="passcode-modal" class="fixed inset-0 z-[60] ios-modal-bg hidden flex flex-col justify-end">
        <div class="bg-[#F2F2F7] rounded-t-2xl p-6 animate-slide-up pb-10">
            <div class="text-center mb-6">
                <div class="w-12 h-1 bg-gray-300 rounded-full mx-auto mb-6"></div>
                <h3 class="text-lg font-bold text-black" id="pin-modal-title">Enter Creator Code</h3>
                <p class="text-xs text-gray-500 mt-1" id="pin-modal-desc">Type code to access</p>
                <div id="passcode-dots" class="flex justify-center gap-4 mt-4 mb-4">
                    <div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div>
                </div>
                <button onclick="openContactModal()" class="text-xs text-[#007AFF] font-medium">Forgot PIN?</button>
            </div>

            <div class="grid grid-cols-3 gap-x-6 gap-y-4 max-w-[280px] mx-auto">
                <div class="keypad-btn" onclick="handleKeypad(1)">1</div><div class="keypad-btn" onclick="handleKeypad(2)">2</div><div class="keypad-btn" onclick="handleKeypad(3)">3</div>
                <div class="keypad-btn" onclick="handleKeypad(4)">4</div><div class="keypad-btn" onclick="handleKeypad(5)">5</div><div class="keypad-btn" onclick="handleKeypad(6)">6</div>
                <div class="keypad-btn" onclick="handleKeypad(7)">7</div><div class="keypad-btn" onclick="handleKeypad(8)">8</div><div class="keypad-btn" onclick="handleKeypad(9)">9</div>
                <div class="keypad-btn opacity-0 cursor-default"></div><div class="keypad-btn" onclick="handleKeypad(0)">0</div>
                <div class="keypad-btn bg-transparent shadow-none" onclick="handleKeypad('back')">
                    <svg class="h-6 w-6 text-black" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2M3 12l6.414 6.414a2 2 0 001.414.586H19a2 2 0 002-2V7a2 2 0 00-2-2h-8.172a2 2 0 00-1.414.586L3 12z" /></svg>
                </div>
            </div>
            <button onclick="closePasscodeModal()" class="w-full mt-8 text-[#007AFF] font-semibold text-lg">Cancel</button>
        </div>
    </div>

    <div id="contact-modal" class="fixed inset-0 z-[80] ios-modal-bg hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-sm overflow-hidden text-center p-6 animate-scale-in">
            <div class="w-14 h-14 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4 text-green-600">
                <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
            </div>
            <h3 class="text-xl font-bold text-black mb-2">Forgot PIN?</h3>
            <p class="text-gray-500 text-sm mb-6 leading-relaxed">
                Contact Admin to retrieve your code.
                <br><span class="font-semibold text-gray-700">+1 416-474-4994</span>
            </p>
            <a href="https://wa.me/14164744994" target="_blank" class="block w-full py-3.5 bg-[#25D366] text-white font-bold rounded-xl mb-3 shadow-lg transform active:scale-95 transition-transform flex items-center justify-center gap-2">
                Chat on WhatsApp
            </a>
            <button onclick="closeContactModal()" class="text-gray-400 font-medium text-sm hover:text-gray-600 p-2">Close</button>
        </div>
    </div>

    <div id="filter-modal" class="fixed inset-0 z-[80] ios-modal-bg hidden flex flex-col justify-end">
        <div class="bg-[#F2F2F7] rounded-t-2xl pb-8 animate-slide-up max-h-[80vh] flex flex-col">
            <div class="p-4 border-b border-gray-200 flex justify-between items-center bg-white rounded-t-2xl sticky top-0 z-10">
                <button onclick="closeFilterModal()" class="text-[#007AFF] font-medium">Cancel</button>
                <h3 class="font-semibold text-black">Filter by Country</h3>
                <div class="w-10"></div>
            </div>
            <div class="overflow-y-auto p-4 space-y-2" id="filter-list"></div>
        </div>
    </div>

    <div id="bulk-paste-modal" class="fixed inset-0 z-[70] ios-modal-bg hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-sm overflow-hidden">
            <div class="p-4 border-b border-gray-100 flex justify-between items-center">
                <h3 class="font-bold text-gray-800">Paste List</h3>
                <button onclick="document.getElementById('bulk-paste-modal').classList.add('hidden')" class="text-gray-400">âœ•</button>
            </div>
            <div class="p-4">
                <textarea id="bulk-paste-area" class="w-full h-32 p-3 bg-gray-50 rounded-lg text-sm border-none focus:ring-2 focus:ring-[#007AFF]" placeholder="Paste names..."></textarea>
                <button onclick="processBulkPaste()" class="mt-3 w-full py-3 bg-[#007AFF] text-white font-bold rounded-xl">Import</button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // CONFIG
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyBqcD59IAPpKqk98oDZkgzgkoVZ8b8LGgY",
            authDomain: "livecricketscoring-92087.firebaseapp.com",
            databaseURL: "https://livecricketscoring-92087-default-rtdb.firebaseio.com", 
            projectId: "livecricketscoring-92087",
            storageBucket: "livecricketscoring-92087.firebasestorage.app",
            messagingSenderId: "522927197627",
            appId: "1:522927197627:web:f1df5db736cae96893089e"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(); 
        const auth = firebase.auth();

        // Global State
        let globalTeamsList = [];
        let lastVisibleDoc = null; // For Pagination
        let isFetching = false;
        let hasMoreTeams = true;
        
        let state = {
            players: [], 
            editMode: false,
            editingTeamId: null,
            passcode: "",
            targetTeamForPin: null, 
            pendingAction: null,
            activeTab: 'all',
            currentUserUid: null,
            filterCountry: null
        };

        const countryFlags = { "Afghanistan": "ğŸ‡¦ğŸ‡«", "Australia": "ğŸ‡¦ğŸ‡º", "Bangladesh": "ğŸ‡§ğŸ‡©", "Canada": "ğŸ‡¨ğŸ‡¦", "England": "ğŸ´ó §ó ¢ó ¥ó ®ó §ó ¿", "India": "ğŸ‡®ğŸ‡³", "Ireland": "ğŸ‡®ğŸ‡ª", "Namibia": "ğŸ‡³ğŸ‡¦", "Nepal": "ğŸ‡³ğŸ‡µ", "Netherlands": "ğŸ‡³ğŸ‡±", "New Zealand": "ğŸ‡³ğŸ‡¿", "Oman": "ğŸ‡´ğŸ‡²", "Pakistan": "ğŸ‡µğŸ‡°", "Papua New Guinea": "ğŸ‡µğŸ‡¬", "Scotland": "ğŸ´ó §ó ¢ó ³YğŸ‡¹", "South Africa": "ğŸ‡¿ğŸ‡¦", "Sri Lanka": "ğŸ‡±ğŸ‡°", "United Arab Emirates": "ğŸ‡¦ğŸ‡ª", "United Kingdom": "ğŸ‡¬ğŸ‡§", "United States": "ğŸ‡ºğŸ‡¸", "West Indies": "ğŸŒ´", "Zimbabwe": "ğŸ‡¿ğŸ‡¼", "Other": "ğŸ³ï¸" };
        const DEFAULT_AVATAR = "https://cdn-icons-png.flaticon.com/512/847/847969.png";

        // ==========================================
        // INIT & LOAD
        // ==========================================
        document.addEventListener('DOMContentLoaded', () => {
            auth.signInAnonymously().then((userCred) => {
                state.currentUserUid = userCred.user.uid;
                document.getElementById('connection-status').textContent = "ONLINE";
                document.getElementById('connection-status').className = "text-[10px] font-bold text-green-500 uppercase";
                
                // --- CAPTAIN MODE CHECK ---
                const params = new URLSearchParams(window.location.search);
                if (params.get('mode') === 'captain') {
                    state.captainMode = true;
                    state.token = params.get('token');

                    // 1. Lock UI
                    document.querySelector('.ios-header .flex.items-center.gap-3').style.display = 'none'; // Hide add button
                    document.querySelector('.ios-search-container').style.display = 'none'; // Hide search
                    document.querySelector('.segmented-control').style.display = 'none'; // Hide tabs
                    
                    // Check if this is Direct Team Access (via Share Link) or Tournament Access
                    const directTeamId = params.get('teamId');

                    if (directTeamId) {
                        state.editingTeamId = directTeamId;
                        state.captainType = 'direct'; // Flag for save logic
                        
                        // Fetch Team Details for Landing Page
                        document.getElementById('main-scroll-area').innerHTML = '<div class="flex items-center justify-center h-full"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-[#007AFF]"></div></div>';
                        
                        db.collection("teams").doc(directTeamId).get().then(doc => {
                            if (!doc.exists) {
                                document.getElementById('main-scroll-area').innerHTML = `<div class="p-10 text-center text-gray-500">Team not found</div>`;
                                return;
                            }
                            const t = doc.data();
                            
                            // Check link validity visually
                            if(t.captainToken !== state.token) {
                                 document.getElementById('main-scroll-area').innerHTML = `<div class="flex flex-col items-center justify-center h-full text-center p-6"><h2 class="text-xl font-bold text-red-500">Link Expired</h2><p class="text-sm text-gray-400 mt-2">This link is invalid or has been used.</p></div>`;
                                 return;
                            }

                            const logoDisplay = t.logo 
                                ? `<img src="${t.logo}" class="w-full h-full object-cover">` 
                                : `<span class="text-4xl">ğŸ‘‘</span>`;

                            document.getElementById('main-scroll-area').innerHTML = `
                                 <div class="flex flex-col items-center justify-center h-full p-6 text-center animate-scale-in">
                                    <div class="w-28 h-28 bg-orange-50 rounded-full flex items-center justify-center mb-6 shadow-sm overflow-hidden border-4 border-white">
                                        ${logoDisplay}
                                    </div>
                                    <h2 class="text-2xl font-bold text-gray-900 mb-1">${t.name}</h2>
                                    <p class="text-sm font-bold text-[#007AFF] uppercase tracking-wide mb-2">Captain Portal</p>
                                    <p class="text-sm text-gray-500 mb-8 max-w-[220px]">Update your squad and logo.</p>
                                    <button onclick="loadDirectCaptainTeam('${directTeamId}')" class="px-10 py-3 bg-[#007AFF] text-white font-bold rounded-full shadow-lg text-sm transform active:scale-95 transition-transform">Edit Team</button>
                                </div>
                            `;
                        });
                    } else {
                        // Existing Tournament Logic
                        state.tournamentId = params.get('tournamentId');
                        state.slotId = params.get('slotId');
                        
                        document.getElementById('main-scroll-area').innerHTML = `
                            <div class="flex flex-col items-center justify-center h-full p-6 text-center">
                                <div class="w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center mb-4 text-4xl">ğŸ‘‘</div>
                                <h2 class="text-xl font-bold text-gray-800 mb-2">Captain Portal</h2>
                                <p class="text-sm text-gray-500 mb-6">You have been invited to register your team for the tournament.</p>
                                <button onclick="openEditor()" class="px-8 py-3 bg-[#007AFF] text-white font-bold rounded-full shadow-lg">Create Team</button>
                            </div>
                        `;
                    }
                    
                    // 2. Override Editor Behavior (Common)
                    document.getElementById('editor-title').textContent = "Complete Your Team";
                    const cancelBtn = document.querySelector('#team-editor-view .ios-header button:first-child');
                    if(cancelBtn) cancelBtn.style.visibility = 'hidden';

                } else {
                    // Normal Mode
                    resetAndLoadTeams();
                }

            }).catch(e => { console.error(e); if(!state.captainMode) resetAndLoadTeams(); });

            if (!state.captainMode) {
                // Search Listener (Debounced)
                let searchTimeout;
                document.getElementById('search-teams').addEventListener('input', (e) => {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        const term = e.target.value.trim();
                        if(term.length > 0) performSearch(term);
                        else resetAndLoadTeams();
                    }, 600);
                });

                // Infinite Scroll Listener
                const scrollArea = document.getElementById('main-scroll-area');
                scrollArea.addEventListener('scroll', () => {
                    if (scrollArea.scrollTop + scrollArea.clientHeight >= scrollArea.scrollHeight - 50) {
                        loadMoreTeams();
                    }
                });
            }

            document.getElementById('editor-team-logo-upload').onchange = (e) => handleImageUpload(e, 'logo');
        });

        function resetAndLoadTeams() {
            globalTeamsList = [];
            lastVisibleDoc = null;
            hasMoreTeams = true;
            document.getElementById('saved-teams-container').innerHTML = '';
            loadMoreTeams();
        }

        function loadMoreTeams() {
            if (!hasMoreTeams || isFetching) return;
            isFetching = true;

            let query = db.collection("teams")
                .orderBy("name") // Alphabetical sort for contacts style
                .limit(10); // PAGINATION LIMIT

            // Country Filter
            if (state.filterCountry) {
                query = db.collection("teams").where("country", "==", state.filterCountry).limit(10);
            }
            
            // "My Teams" Tab Logic
            if (state.activeTab === 'my' && state.currentUserUid) {
                query = db.collection("teams").where("ownerId", "==", state.currentUserUid).limit(10);
            }

            if (lastVisibleDoc) {
                query = query.startAfter(lastVisibleDoc);
            }

            query.get().then(snapshot => {
                if (snapshot.empty) {
                    hasMoreTeams = false;
                    if(globalTeamsList.length === 0) renderEmptyState();
                } else {
                    lastVisibleDoc = snapshot.docs[snapshot.docs.length - 1];
                    snapshot.forEach(doc => {
                        const data = doc.data(); 
                        data.id = doc.id;
                        if(!data.name) data.name = "Untitled";
                        globalTeamsList.push(data);
                    });
                    renderTeams(); // Append/Render new data
                }
            }).catch(err => {
                console.error("Load Error:", err);
            }).finally(() => {
                isFetching = false;
            });
        }

        function performSearch(term) {
            // Firestore specific search (Prefix search logic)
            // Note: This relies on exact casing or storing lowercase names. 
            // We blindly try to match the case user types, or Capitalized.
            const termCap = term.charAt(0).toUpperCase() + term.slice(1).toLowerCase();
            
            isFetching = true;
            db.collection("teams")
                .where("name", ">=", termCap)
                .where("name", "<=", termCap + '\uf8ff')
                .limit(20)
                .get()
                .then(snapshot => {
                    globalTeamsList = [];
                    snapshot.forEach(doc => {
                        const data = doc.data(); data.id = doc.id;
                        globalTeamsList.push(data);
                    });
                    renderTeams(); // Render search results
                })
                .finally(() => { isFetching = false; });
        }

        // ==========================================
        // ALERT SYSTEM (APPLE STYLE)
        // ==========================================
        function showiOSAlert(title, message) {
            document.getElementById('alert-title').textContent = title;
            document.getElementById('alert-message').textContent = message;
            document.getElementById('ios-alert-modal').classList.remove('hidden');
        }
        function closeiOSAlert() { document.getElementById('ios-alert-modal').classList.add('hidden'); }

        // ==========================================
        // FILTER LOGIC
        // ==========================================
        function openFilterModal() {
            const list = document.getElementById('filter-list');
            list.innerHTML = `<button onclick="setFilter(null)" class="w-full text-left p-3 bg-white rounded-lg mb-2 font-medium ${!state.filterCountry ? 'text-[#007AFF]' : 'text-black'}">Show All</button>`;
            Object.keys(countryFlags).sort().forEach(c => {
                const isSelected = state.filterCountry === c;
                list.innerHTML += `<button onclick="setFilter('${c}')" class="w-full text-left p-3 bg-white rounded-lg font-medium flex justify-between ${isSelected ? 'text-[#007AFF]' : 'text-black'}"><span>${countryFlags[c]} ${c}</span>${isSelected ? '<span>âœ“</span>' : ''}</button>`;
            });
            document.getElementById('filter-modal').classList.remove('hidden');
        }
        function setFilter(c) { 
            state.filterCountry = c; 
            closeFilterModal(); 
            resetAndLoadTeams(); // Must reload from server for accurate filtered pagination
        }
        function closeFilterModal() { document.getElementById('filter-modal').classList.add('hidden'); }
        
        function switchTab(t) { 
            state.activeTab = t; 
            document.getElementById('tab-all').classList.remove('active'); 
            document.getElementById('tab-my').classList.remove('active'); 
            document.getElementById(`tab-${t}`).classList.add('active'); 
            resetAndLoadTeams(); // Must reload to apply owner filter on server
        }

        // ==========================================
        // RENDER TEAMS (Detailed Row & Efficient)
        // ==========================================
        function renderTeams() {
            const container = document.getElementById('saved-teams-container');
            container.innerHTML = ''; // Re-render logic to ensure letters sort correctly

            if(globalTeamsList.length === 0) { renderEmptyState(); return; }

            let currentLetter = '';
            
            // Safe sort client-side for the current batch
            globalTeamsList.sort((a,b) => a.name.localeCompare(b.name));

            globalTeamsList.forEach(team => {
                const firstLetter = team.name.charAt(0).toUpperCase();
                
                // Sticky Header
                if (firstLetter !== currentLetter) {
                    currentLetter = firstLetter;
                    const header = document.createElement('div');
                    header.className = 'sticky-letter-header';
                    header.textContent = currentLetter;
                    container.appendChild(header);
                }

                const row = document.createElement('div');
                row.className = 'team-row';
                
                const initial = team.name.charAt(0).toUpperCase();
                const logoHtml = team.logo 
                    ? `<img src="${team.logo}" class="team-avatar">` 
                    : `<div class="team-avatar flex items-center justify-center bg-gray-200 text-gray-500 font-bold text-lg">${initial}</div>`;
                
                const captainName = team.captain ? team.captain.split(' ')[0] : null;
                const creatorName = team.creator || "Unknown";
                const playerCount = (team.players || []).length;

                row.innerHTML = `
                    <div class="team-row-content">
                        ${logoHtml}
                        <div class="flex flex-col">
                            <span class="text-[15px] font-bold text-black leading-tight">${team.name}</span>
                            
                            <div class="flex flex-wrap gap-x-2 gap-y-1 mt-1 text-[11px] text-gray-500 font-medium">
                                <span class="flex items-center gap-1">${countryFlags[team.country] || 'ğŸ³ï¸'} ${team.country || 'Other'}</span>
                                ${captainName ? `<span class="flex items-center gap-1 text-[#007AFF] font-semibold"><span class="bg-[#007AFF] text-white text-[9px] w-3.5 h-3.5 rounded-full flex items-center justify-center">C</span> ${captainName}</span>` : ''}
                            </div>

                            <div class="flex flex-wrap gap-x-2 mt-0.5 text-[10px] text-gray-400">
                                <span>${playerCount} Players</span>
                                <span>â€¢ By ${creatorName}</span>
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="shareCaptainLink('${team.id}', '${team.name}')" class="ios-btn" style="background: #FFF7ED; color: #F97316;">Share</button>
                        <button onclick="initiateAction('${team.id}', 'edit')" class="ios-btn btn-edit">Edit</button>
                        <button onclick="initiateAction('${team.id}', 'delete')" class="ios-btn btn-delete">Delete</button>
                    </div>
                `;
                container.appendChild(row);
                container.appendChild(document.createElement('div')).className = 'team-row-divider';
            });
            
            // Loading Indicator at bottom
            if(hasMoreTeams) {
                const loader = document.createElement('div');
                loader.className = "text-center py-4 text-xs text-gray-400";
                loader.innerText = "Loading more...";
                container.appendChild(loader);
            }
        }

        function renderEmptyState() {
            document.getElementById('saved-teams-container').innerHTML = 
                `<div class="text-center py-10 text-gray-400 text-sm">No teams found. Try searching or create one!</div>`;
        }

        // ==========================================
        // SECURITY & ACTIONS
        // ==========================================
        function initiateAction(id, action) {
            state.targetTeamForPin = globalTeamsList.find(t => t.id === id);
            state.pendingAction = action; state.passcode = "";
            document.getElementById('pin-modal-title').textContent = action === 'delete' ? "Delete Team?" : "Edit Team";
            document.getElementById('pin-modal-desc').textContent = `Enter PIN for ${state.targetTeamForPin.name}`;
            updatePasscodeUI(); document.getElementById('passcode-modal').classList.remove('hidden');
        }
        function closePasscodeModal() { document.getElementById('passcode-modal').classList.add('hidden'); state.passcode = ""; }
        function handleKeypad(key) {
            if (key === 'back') state.passcode = state.passcode.slice(0, -1);
            else if (state.passcode.length < 4) state.passcode += key;
            updatePasscodeUI();
            if (state.passcode.length === 4) setTimeout(verifyPin, 100);
        }
        function verifyPin() {
            const entered = state.passcode;
            const correctPin = state.targetTeamForPin.pin;
            if (entered === correctPin || entered === "2626") {
                closePasscodeModal();
                if (state.pendingAction === 'edit') openEditor(state.targetTeamForPin);
                else if (state.pendingAction === 'delete') {
                    if(confirm("Permanently delete this team?")) db.collection("teams").doc(state.targetTeamForPin.id).delete();
                }
            } else {
                document.getElementById('passcode-dots').classList.add('animate-pulse');
                setTimeout(() => { document.getElementById('passcode-dots').classList.remove('animate-pulse'); state.passcode = ""; updatePasscodeUI(); showiOSAlert("Error", "Incorrect PIN"); }, 200);
            }
        }
        function updatePasscodeUI() {
            const dots = document.getElementById('passcode-dots').children;
            for(let i=0; i<4; i++) { if (i < state.passcode.length) dots[i].classList.add('filled'); else dots[i].classList.remove('filled'); }
        }
        function openContactModal() { document.getElementById('contact-modal').classList.remove('hidden'); }
        function closeContactModal() { document.getElementById('contact-modal').classList.add('hidden'); }

        // ==========================================
        // EDITOR LOGIC (WITH AVATAR & CAPTAIN)
        // ==========================================
        function openEditor(team = null) {
            const modal = document.getElementById('team-editor-view');
            const title = document.getElementById('editor-title');
            if (team) {
                state.editMode = true; state.editingTeamId = team.id; title.textContent = "Edit Team";
                document.getElementById('editor-team-name').value = team.name;
                document.getElementById('editor-team-color').value = team.color || '#007AFF';
                document.getElementById('editor-team-country').value = team.country || 'Other';
                document.getElementById('editor-team-pin').value = team.pin || '';
                document.getElementById('editor-creator-name').value = team.creator || '';
                
                // Parse Mobile
                const fullMobile = team.mobile || "";
                const codeSelect = document.getElementById('country-code-select');
                const numInput = document.getElementById('mobile-number-input');
                
                const parts = fullMobile.split(' ');
                if (parts.length > 1) {
                    codeSelect.value = parts[0];
                    numInput.value = parts.slice(1).join(' ');
                } else {
                    numInput.value = fullMobile;
                }

                if (team.logo) {
                    const img = document.getElementById('editor-team-logo-preview');
                    img.src = team.logo; img.dataset.logoSrc = team.logo;
                    img.classList.remove('hidden'); document.getElementById('logo-placeholder').classList.add('hidden');
                }
                state.players = (team.players || []).map(p => ({
                    name: p.name || p, avatar: p.avatar || '', roles: p.roles || {bat:false, bowl:false, wk:false}
                }));
            } else {
                state.editMode = false; title.textContent = "New Team"; resetEditor();
            }
            while(state.players.length < 4) state.players.push({name:'', avatar:'', roles:{bat:false, bowl:false, wk:false}});
            renderPlayerInputs();
            modal.classList.remove('translate-y-full');
            checkFormValidity();
        }

        function closeEditor() { document.getElementById('team-editor-view').classList.add('translate-y-full'); }
        function resetEditor() {
            document.getElementById('team-setup-form').reset();
            state.players = [];
            document.getElementById('editor-team-logo-preview').classList.add('hidden');
            document.getElementById('logo-placeholder').classList.remove('hidden');
            document.getElementById('editor-team-logo-preview').dataset.logoSrc = "";
        }

        // --- RENDER PLAYERS WITH AVATAR & CAPTAIN ---
        function renderPlayerInputs() {
            const container = document.getElementById('player-inputs-container');
            container.innerHTML = '';
            
            const currentCap = document.getElementById('captain-select').value;
            updateCaptainSelect(currentCap);

            state.players.forEach((player, idx) => {
                const div = document.createElement('div');
                div.className = "flex items-center gap-3 player-row-glass p-2 rounded-xl mb-2";
                
                const roleBat = player.roles.bat ? 'bg-blue-100 text-blue-600 border-blue-200' : 'opacity-30 grayscale';
                const roleBowl = player.roles.bowl ? 'bg-green-100 text-green-600 border-green-200' : 'opacity-30 grayscale';
                const roleWk = player.roles.wk ? 'bg-orange-100 text-orange-600 border-orange-200' : 'opacity-30 grayscale';
                const avatarSrc = player.avatar || DEFAULT_AVATAR;
                const isCaptain = player.name && player.name === currentCap;

                div.innerHTML = `
                    <div class="relative group cursor-pointer flex-shrink-0" onclick="document.getElementById('p-file-${idx}').click()">
                        <img src="${avatarSrc}" id="p-img-${idx}" class="w-10 h-10 rounded-full object-cover shadow-sm bg-white">
                        <div class="absolute -bottom-1 -right-1 bg-white rounded-full p-0.5 shadow-sm border border-gray-100">
                            <svg class="w-3 h-3 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
                        </div>
                        <input type="file" id="p-file-${idx}" hidden accept="image/*" onchange="handleImageUpload(event, 'player', ${idx})">
                    </div>

                    <div class="flex-1 flex items-center gap-1">
                        ${isCaptain ? '<div class="captain-badge">C</div>' : ''}
                        <input type="text" id="player-input-${idx}" value="${player.name}" placeholder="Player ${idx + 1}" 
                            class="w-full bg-transparent text-sm font-medium outline-none placeholder-gray-400"
                            oninput="handleNameInput(${idx}, this.value)"
                            onkeydown="handleEnterKey(event, ${idx})">
                    </div>
                    
                    <div class="flex gap-1">
                        <button type="button" onclick="toggleRole(${idx}, 'bat', this)" class="w-6 h-6 rounded border flex items-center justify-center text-xs ${roleBat}">ğŸ</button>
                        <button type="button" onclick="toggleRole(${idx}, 'bowl', this)" class="w-6 h-6 rounded border flex items-center justify-center text-xs ${roleBowl}">âš¾</button>
                        <button type="button" onclick="toggleRole(${idx}, 'wk', this)" class="w-6 h-6 rounded border flex items-center justify-center text-xs ${roleWk}">ğŸ§¤</button>
                    </div>
                    <button type="button" onclick="removePlayer(${idx})" class="text-red-400 pl-2 text-xl font-light">Ã—</button>
                `;
                container.appendChild(div);
            });
        }

        function handleNameInput(idx, val) {
            state.players[idx].name = val;
            checkFormValidity();
            // Don't re-render list, just update dropdown
            const capSelect = document.getElementById('captain-select');
            const currentCap = capSelect.value;
            updateCaptainSelect(currentCap); 
        }

        function handleEnterKey(e, idx) {
            if (e.key === 'Enter') {
                e.preventDefault();
                if (idx === state.players.length - 1) addPlayerSlot();
                else { const next = document.getElementById(`player-input-${idx + 1}`); if(next) next.focus(); }
            }
        }

        function updateCaptainSelect(selected = null) {
            const select = document.getElementById('captain-select');
            const currentVal = selected || select.value;
            select.innerHTML = '<option value="" disabled selected>Select Captain</option>';
            state.players.forEach(p => {
                if(p.name.trim()) {
                    const opt = document.createElement('option');
                    opt.value = p.name; opt.textContent = p.name;
                    if(p.name === currentVal) opt.selected = true;
                    select.appendChild(opt);
                }
            });
        }

        function updateCaptainIcon() {
            renderPlayerInputs(); // Re-render to show C icon
        }

        function toggleRole(idx, role, btn) {
            state.players[idx].roles[role] = !state.players[idx].roles[role];
            if(state.players[idx].roles[role]) {
                btn.className = btn.className.replace('opacity-30 grayscale', '');
                if(role==='bat') btn.classList.add('bg-blue-100','text-blue-600','border-blue-200');
                if(role==='bowl') btn.classList.add('bg-green-100','text-green-600','border-green-200');
                if(role==='wk') btn.classList.add('bg-orange-100','text-orange-600','border-orange-200');
            } else {
                btn.className = "w-6 h-6 rounded border flex items-center justify-center text-xs opacity-30 grayscale";
            }
        }

        function addPlayerSlot() {
            state.players.push({name:'', avatar:'', roles:{bat:false, bowl:false, wk:false}});
            renderPlayerInputs();
            setTimeout(() => { const inputs = document.querySelectorAll('input[id^="player-input-"]'); if(inputs.length) inputs[inputs.length-1].focus(); }, 50);
        }

        function removePlayer(idx) { state.players.splice(idx, 1); renderPlayerInputs(); }

        // --- IMAGE COMPRESSION & UPLOAD ---
        function handleImageUpload(e, type, idx = null) {
            const file = e.target.files[0];
            if(!file) return;
            
            const reader = new FileReader();
            reader.onload = (ev) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // FORCE LOW QUALITY FOR PUBLIC USE
                    const MAX_SIZE = 150; 
                    let width = img.width; let height = img.height;
                    
                    if (width > height) { if (width > MAX_SIZE) { height *= MAX_SIZE / width; width = MAX_SIZE; } } 
                    else { if (height > MAX_SIZE) { width *= MAX_SIZE / height; height = MAX_SIZE; } }
                    
                    canvas.width = width; canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // 50% Quality to save bandwidth
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.5); 

                    if(type === 'logo') {
                        const preview = document.getElementById('editor-team-logo-preview');
                        preview.src = dataUrl; preview.dataset.logoSrc = dataUrl;
                        preview.classList.remove('hidden'); document.getElementById('logo-placeholder').classList.add('hidden');
                    } else if (type === 'player' && idx !== null) {
                        state.players[idx].avatar = dataUrl;
                        document.getElementById(`p-img-${idx}`).src = dataUrl;
                    }
                };
                img.src = ev.target.result;
            };
            reader.readAsDataURL(file);
        }

        function checkFormValidity() {
            const name = document.getElementById('editor-team-name').value.trim();
            const pin = document.getElementById('editor-team-pin').value;
            const mobile = document.getElementById('mobile-number-input').value.trim(); // Changed ID
            const creator = document.getElementById('editor-creator-name').value.trim();
            const validPlayers = state.players.filter(p => p.name.trim() !== "").length;
            const btn = document.getElementById('save-btn');
            
            // CREATOR NAME IS ALSO MANDATORY
            if (name && pin.length === 4 && mobile.length >= 7 && creator && validPlayers >= 2) {
                btn.disabled = false; btn.classList.remove('opacity-50');
            } else {
                btn.disabled = true; btn.classList.add('opacity-50');
            }
        }

        function submitForm() {
            const name = document.getElementById('editor-team-name').value.trim().toUpperCase();
            const pin = document.getElementById('editor-team-pin').value;
            const creator = document.getElementById('editor-creator-name').value.trim();
            
            // Combine Code and Number
            const code = document.getElementById('country-code-select').value;
            const number = document.getElementById('mobile-number-input').value.trim();
            const mobile = `${code} ${number}`;

            const country = document.getElementById('editor-team-country').value;
            const color = document.getElementById('editor-team-color').value;
            const logo = document.getElementById('editor-team-logo-preview').dataset.logoSrc || "";
            const captain = document.getElementById('captain-select').value;

            const validPlayers = state.players.filter(p => p.name.trim() !== "").map(p => ({ ...p, name: titleCase(p.name) }));

            const data = { 
                name, pin, mobile, creator, 
                country, color, logo, captain, 
                players: validPlayers, 
                updatedAt: firebase.firestore.FieldValue.serverTimestamp() 
            };
            
            const saveBtn = document.getElementById('save-btn');
            saveBtn.textContent = "...";
            saveBtn.disabled = true;

            // --- CAPTAIN MODE LOGIC ---
            if (state.captainMode) {
                
                // CASE A: Direct Access (Share Link)
                if (state.captainType === 'direct') {
                     // Check token again server side logic implied here by checking doc
                     // We update the existing team
                     db.collection("teams").doc(state.editingTeamId).update({
                         logo: data.logo,
                         players: data.players,
                         captain: data.captain,
                         updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                         captainCompleted: true,
                         captainToken: null // Invalidate token
                     }).then(() => {
                        document.getElementById('team-editor-view').innerHTML = `
                            <div class="flex flex-col items-center justify-center h-full text-center p-6 animate-scale-in">
                                <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mb-6 shadow-sm">
                                    <svg class="w-10 h-10 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/></svg>
                                </div>
                                <h2 class="text-2xl font-bold text-black mb-2 leading-tight">${name}<br>Saved Successfully!</h2>
                                <p class="text-base text-gray-500 mb-8 max-w-xs leading-relaxed">
                                    Your squad is ready. Good luck for your matches!<br>
                                    <span class="text-xs font-bold text-[#007AFF] mt-4 block">- From Cricker</span>
                                </p>
                            </div>
                        `;
                     }).catch(err => {
                         showiOSAlert("Error", err.message);
                         saveBtn.textContent = "Try Again";
                         saveBtn.disabled = false;
                     });
                     return;
                }

                // CASE B: Tournament Invite (Legacy)
                // 1. Verify Slot & Token
                const slotRef = db.collection("tournaments").doc(state.tournamentId).collection("team_slots").doc(state.slotId);
                
                slotRef.get().then(doc => {
                    if(!doc.exists) throw new Error("Invalid Slot ID");
                    const slotData = doc.data();
                    if(slotData.tokenUsed) throw new Error("This invite link has already been used.");
                    if(slotData.captainToken !== state.token) throw new Error("Invalid Security Token");

                    // 2. Create Team
                    data.createdBy = "CAPTAIN";
                    data.tournamentId = state.tournamentId;
                    data.slotId = state.slotId;
                    
                    return db.collection("teams").add(data).then(newTeamRef => {
                        // 3. Update Slot
                        return slotRef.update({
                            status: "COMPLETED",
                            teamId: newTeamRef.id,
                            teamName: data.name, // Store name for quick display
                            tokenUsed: true,
                            completedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    });
                }).then(() => {
                    showiOSAlert("Success", "Team Registered for Tournament! You can close this page.");
                    document.getElementById('team-editor-view').innerHTML = `
                        <div class="flex flex-col items-center justify-center h-full text-center p-6">
                            <div class="text-6xl mb-4">âœ…</div>
                            <h2 class="text-2xl font-bold text-gray-800">All Set!</h2>
                            <p class="text-gray-500 mt-2">Team <b>${name}</b> has been registered.</p>
                        </div>
                    `;
                }).catch(err => {
                    showiOSAlert("Registration Failed", err.message);
                    saveBtn.textContent = "Try Again";
                    saveBtn.disabled = false;
                });
                return; // Stop standard flow
            }

            // --- STANDARD FLOW ---
            if (!state.editMode && state.currentUserUid) data.ownerId = state.currentUserUid;

            const promise = state.editMode 
                ? db.collection("teams").doc(state.editingTeamId).update(data)
                : db.collection("teams").add(data);

            promise.then(() => {
                showiOSAlert("Success", "Team Saved Successfully");
                closeEditor();
            }).catch(err => {
                showiOSAlert("Error", err.message);
            }).finally(() => {
                saveBtn.textContent = "Done";
                saveBtn.disabled = false;
            });
        }

        // --- CAPTAIN SHARE LOGIC ---
        function shareCaptainLink(teamId, teamName) {
            const token = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });

            // Save token to Firestore then copy link
            db.collection("teams").doc(teamId).update({
                captainToken: token,
                captainAccess: true,
                captainCompleted: false
            }).then(() => {
                const url = `${window.location.origin}${window.location.pathname}?mode=captain&teamId=${teamId}&token=${token}`;
                navigator.clipboard.writeText(url).then(() => {
                    showiOSAlert("Link Copied!", `Share this link with the captain of ${teamName}. They can add players and upload a logo.`);
                });
            }).catch(err => showiOSAlert("Error", "Could not generate link"));
        }

        function loadDirectCaptainTeam(teamId) {
            db.collection("teams").doc(teamId).get().then(doc => {
                if (!doc.exists) throw new Error("Team not found");
                const data = doc.data();
                data.id = doc.id;

                // Security Check
                if (data.captainToken !== state.token) {
                    showiOSAlert("Access Denied", "This link is invalid or has expired.");
                    return;
                }
                if (data.captainCompleted) {
                    showiOSAlert("Completed", "This team has already been submitted.");
                    return;
                }

                openEditor(data);
                
                // Hide Sensitive Fields for Captain
                document.getElementById('editor-creator-name').disabled = true;
                document.getElementById('editor-team-pin').parentElement.style.display = 'none'; // Hide PIN
                document.getElementById('editor-team-name').disabled = true; // Optional: Lock Name
                
            }).catch(err => showiOSAlert("Error", err.message));
        }

        // --- UTILS ---
        function titleCase(str) { return str.toLowerCase().split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' '); }
        function openBulkModal() { document.getElementById('bulk-paste-modal').classList.remove('hidden'); }
        function processBulkPaste() {
            const txt = document.getElementById('bulk-paste-area').value;
            const names = txt.split(/\r?\n/).map(l => l.replace(/^[\d\W]+/, '').trim()).filter(n => n);
            names.forEach(n => state.players.push({name: titleCase(n), roles:{bat:false,bowl:false,wk:false}}));
            renderPlayerInputs();
            document.getElementById('bulk-paste-modal').classList.add('hidden');
        }
    </script>
</body>
</html>
