<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cricker - Professional Team Manager</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* =========================================
           CORE STYLES
           ========================================= */
        body { 
            font-family: 'Inter', sans-serif; 
            overflow: hidden; 
            background-color: #f3f4f6;
            margin: 0; padding: 0;
            width: 100vw; height: 100vh;
        }

        /* --- AURORA ANIMATED BACKGROUND --- */
        .aurora-container {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            z-index: -2; background: #ffffff; overflow: hidden;
        }
        .aurora-blob {
            position: absolute; border-radius: 50%; filter: blur(80px); opacity: 0.8;
            animation: drift 25s infinite alternate linear;
        }
        .blob-1 { top: -10%; left: -10%; width: 70vw; height: 70vw; background: #a78bfa; animation-delay: 0s; }
        .blob-2 { bottom: -20%; right: -10%; width: 80vw; height: 80vw; background: #60a5fa; animation-delay: -5s; animation-direction: alternate-reverse; }
        .blob-3 { top: 30%; left: 20%; width: 60vw; height: 60vw; background: #2dd4bf; opacity: 0.6; animation-duration: 30s; animation-delay: -10s; }

        @keyframes drift {
            0% { transform: translate(0, 0) scale(1); }
            33% { transform: translate(30px, -50px) scale(1.1); }
            66% { transform: translate(-20px, 20px) scale(0.9); }
            100% { transform: translate(50px, 50px) scale(1); }
        }

        /* --- HEADER & GLASS EFFECTS --- */
        .animated-glass-header {
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.85), rgba(59, 130, 246, 0.85), rgba(29, 78, 216, 0.9));
            background-size: 200% 200%;
            animation: headerShimmer 8s ease-in-out infinite;
            backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }
        @keyframes headerShimmer {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .noise-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: -1; opacity: 0.05; 
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
        }

        .glass-app-container {
            width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.4); 
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
        }

        /* --- BUTTONS & ANIMATIONS --- */
        .setup-btn { 
            background-color: #2563eb; background-image: linear-gradient(to right, #2563eb, #1d4ed8); transition: all 0.3s ease; 
        }
        .setup-btn:hover { 
            transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.3), 0 4px 6px -2px rgba(37, 99, 235, 0.15); 
        }
        
        .animate-fade-in { animation: fadeIn 0.2s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .content-width-limiter { max-width: 800px; margin: 0 auto; width: 100%; }
        
        /* --- TOAST NOTIFICATIONS (Professional Replacement for Alerts) --- */
        .toast-container {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            z-index: 100; display: flex; flex-direction: column; gap: 10px; pointer-events: none;
        }
        .toast {
            background: rgba(30, 41, 59, 0.95); color: white; padding: 12px 24px;
            border-radius: 50px; font-size: 14px; font-weight: 600;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
            backdrop-filter: blur(4px); display: flex; align-items: center; gap: 8px;
            animation: toastSlideUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            opacity: 0; transform: translateY(20px);
        }
        @keyframes toastSlideUp { to { opacity: 1; transform: translateY(0); } }

        /* --- SKELETON LOADING ANIMATION --- */
        .skeleton { background: #e5e7eb; border-radius: 8px; overflow: hidden; position: relative; }
        .skeleton::after {
            content: ""; position: absolute; inset: 0; transform: translateX(-100%);
            background-image: linear-gradient( 90deg, rgba(255, 255, 255, 0) 0, rgba(255, 255, 255, 0.4) 20%, rgba(255, 255, 255, 0.6) 60%, rgba(255, 255, 255, 0) );
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer { 100% { transform: translateX(100%); } }

        /* --- FILTER DROPDOWN --- */
        .filter-dropdown {
            position: absolute; top: 100%; right: 0; margin-top: 8px;
            width: 220px; max-height: 300px; overflow-y: auto;
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px);
            border-radius: 12px; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            z-index: 50; border: 1px solid rgba(255,255,255,0.8); display: none; 
        }
        .filter-dropdown.show { display: block; animation: fadeIn 0.2s ease-out; }
        .filter-item {
            padding: 10px 16px; display: flex; align-items: center; gap: 10px;
            font-size: 14px; font-weight: 500; color: #374151; cursor: pointer; transition: background 0.1s;
        }
        .filter-item:hover { background-color: #f3f4f6; }
        .filter-item.active { background-color: #eff6ff; color: #2563eb; }

        /* --- PLAYER ROLE TOGGLES (Bat/Bowl/WK) --- */
        .role-btn {
            width: 28px; height: 28px; border-radius: 6px;
            display: flex; align-items: center; justify-content: center;
            font-size: 14px; transition: all 0.2s; border: 1px solid transparent; cursor: pointer;
        }
        .role-btn.inactive { background-color: transparent; filter: grayscale(100%); opacity: 0.4; }
        .role-btn.inactive:hover { background-color: rgba(0,0,0,0.05); opacity: 0.7; }
        .role-btn.active-bat { background-color: #dbeafe; border-color: #bfdbfe; color: #1e40af; opacity: 1; filter: none; }
        .role-btn.active-bowl { background-color: #d1fae5; border-color: #a7f3d0; color: #065f46; opacity: 1; filter: none; }
        .role-btn.active-wk { background-color: #ffedd5; border-color: #fed7aa; color: #9a3412; opacity: 1; filter: none; }

        /* --- KEYPAD (Delete Security) --- */
        .keypad-btn {
            width: 70px; height: 70px; border-radius: 50%; background-color: rgba(255, 255, 255, 0.9);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); font-size: 28px; font-weight: 400; color: #1f2937;
            display: flex; align-items: center; justify-content: center; transition: background-color 0.2s; cursor: pointer; user-select: none;
        }
        .keypad-btn:active { background-color: #d1d5db; }
        .dot { width: 14px; height: 14px; border-radius: 50%; border: 1px solid #9ca3af; transition: all 0.2s; }
        .dot.filled { background-color: #1f2937; border-color: #1f2937; }

    </style>
</head>
<body>

    <div class="aurora-container">
        <div class="aurora-blob blob-1"></div>
        <div class="aurora-blob blob-2"></div>
        <div class="aurora-blob blob-3"></div>
    </div>
    
    <div class="noise-overlay"></div>

    <div class="glass-app-container flex flex-col relative">
        
        <div id="team-list-view" class="h-full flex flex-col relative w-full">
            
            <div class="animated-glass-header p-4 text-white flex justify-between items-center z-10 relative">
                <div class="content-width-limiter flex justify-between items-center w-full">
                    <h1 class="text-xl font-bold flex items-center gap-3">
                        <img src="icon-512.png" alt="Logo" class="h-8 w-8 rounded-full shadow-sm ring-2 ring-white/30" onerror="this.style.display='none'">
                        <span class="tracking-wide">Manage Teams</span>
                    </h1>
                    <button onclick="window.history.back()" class="text-blue-100 hover:text-white px-3 py-1 rounded-md hover:bg-white/10 transition-colors font-medium">Back</button>
                </div>
            </div>

            <div class="p-4 pb-0 z-10">
                <div class="content-width-limiter">
                    <div class="flex gap-2 relative">
                        <div class="relative flex-1">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <svg class="h-5 w-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                </svg>
                            </div>
                            <input type="text" id="search-teams" 
                                class="block w-full pl-10 pr-3 py-3 border-0 rounded-xl leading-5 bg-white shadow-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 sm:text-sm transition duration-150 ease-in-out text-gray-800" 
                                placeholder="Search teams...">
                        </div>

                        <button id="filter-btn" class="bg-white px-4 rounded-xl shadow-sm text-gray-600 hover:bg-gray-50 focus:ring-2 focus:ring-blue-500 transition-colors flex items-center justify-center">
                            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
                            </svg>
                        </button>

                        <div id="filter-menu" class="filter-dropdown">
                            </div>
                    </div>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto relative bg-transparent w-full">
                <div class="p-4 space-y-4 pb-24 content-width-limiter">
                    <div id="saved-teams-container" class="space-y-1">
                        </div>
                </div>
            </div>

            <div class="absolute bottom-8 right-8 z-20">
                <button id="create-new-team-btn" class="setup-btn h-16 w-16 rounded-full text-white shadow-xl flex items-center justify-center text-3xl transform hover:scale-110 transition-transform">
                    <svg class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                </button>
            </div>
        </div>

        <div id="team-editor-view" class="hidden h-full flex flex-col bg-white/95 backdrop-blur-xl absolute inset-0 z-30">
            <div class="animated-glass-header border-b border-white/20 p-4 flex items-center gap-3 sticky top-0 z-10 shadow-sm">
                <div class="content-width-limiter flex items-center gap-3 w-full">
                    <button id="back-to-list-btn" class="text-blue-100 hover:text-white p-1 rounded-full hover:bg-white/10">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                    </button>
                    <h2 class="text-lg font-bold text-white">Team Editor</h2>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-4 w-full">
                <div class="content-width-limiter">
                    <form id="team-setup-form" class="space-y-6 pb-10">
                        
                        <div class="space-y-4">
                            <div class="flex items-start gap-4">
                                <div class="relative group flex-shrink-0">
                                    <div class="h-24 w-24 rounded-full bg-gray-50 border-2 border-dashed border-gray-300 flex items-center justify-center overflow-hidden cursor-pointer hover:border-blue-500 transition-colors relative shadow-inner">
                                        <img id="editor-team-logo-preview" class="h-full w-full object-cover hidden">
                                        <span class="text-gray-400 text-[10px] font-bold text-center px-1">UPLOAD<br>LOGO</span>
                                        <input type="file" id="editor-team-logo-upload" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer">
                                    </div>
                                </div>

                                <div class="flex-1 space-y-3 pt-2">
                                    <input type="text" id="editor-team-name" placeholder="TEAM NAME" 
                                        class="w-full text-2xl font-black border-b-2 border-gray-200 bg-transparent focus:border-blue-600 outline-none py-1 transition-colors uppercase placeholder:normal-case placeholder:text-gray-300 placeholder:font-bold" 
                                        oninput="this.value = this.value.toUpperCase()" required>
                                    
                                    <div class="flex items-center gap-4">
                                        <div class="flex items-center gap-2">
                                            <label class="text-xs text-gray-500 font-semibold uppercase">Color:</label>
                                            <input type="color" id="editor-team-color" class="h-8 w-12 border-0 p-0 rounded cursor-pointer shadow-sm" value="#3b82f6">
                                        </div>

                                        <div class="flex-1">
                                            <select id="editor-team-country" class="w-full p-1 bg-transparent border-b border-gray-200 text-sm focus:border-blue-600 outline-none font-medium text-gray-700">
                                                <option value="" disabled selected>Select Country</option>
                                                <option value="Afghanistan">üá¶üá´ Afghanistan</option><option value="Australia">üá¶üá∫ Australia</option><option value="Bangladesh">üáßüá© Bangladesh</option><option value="Canada">üá®üá¶ Canada</option><option value="England">üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø England</option><option value="India">üáÆüá≥ India</option><option value="Ireland">üáÆüá™ Ireland</option><option value="Namibia">üá≥üá¶ Namibia</option><option value="Nepal">üá≥üáµ Nepal</option><option value="Netherlands">üá≥üá± Netherlands</option><option value="New Zealand">üá≥üáø New Zealand</option><option value="Oman">üá¥üá≤ Oman</option><option value="Pakistan">üáµüá∞ Pakistan</option><option value="Papua New Guinea">üáµüá¨ Papua New Guinea</option><option value="Scotland">üè¥Û†ÅßÛ†Å¢Û†Å≥Yüáπ Scotland</option><option value="South Africa">üáøüá¶ South Africa</option><option value="Sri Lanka">üá±üá∞ Sri Lanka</option><option value="United Arab Emirates">üá¶üá™ UAE</option><option value="United Kingdom">üá¨üáß United Kingdom</option><option value="United States">üá∫üá∏ USA</option><option value="West Indies">üå¥ West Indies</option><option value="Zimbabwe">üáøüáº Zimbabwe</option><option value="Other">üè≥Ô∏è Other</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <hr class="border-gray-200">

                        <div>
                            <div class="flex justify-between items-end mb-3">
                                <h3 class="font-bold text-gray-800 text-lg">Squad List</h3>
                                <div class="flex gap-2 text-[10px] font-bold text-gray-400 uppercase tracking-wider">
                                    <span class="w-[28px] text-center">Bat</span>
                                    <span class="w-[28px] text-center">Bowl</span>
                                    <span class="w-[28px] text-center">WK</span>
                                </div>
                            </div>
                            
                            <div id="player-inputs-container" class="space-y-3">
                                </div>

                            <div class="flex gap-3 mt-4">
                                <button type="button" id="add-player-btn" class="flex-1 py-3 border-2 border-dashed border-blue-200 text-blue-600 rounded-xl font-bold hover:bg-blue-50 transition-colors bg-white/50">
                                    + Add One
                                </button>
                                <button type="button" onclick="openBulkModal()" class="px-6 py-3 bg-white border border-gray-200 text-gray-600 rounded-xl font-bold hover:bg-gray-50 shadow-sm transition-colors flex items-center gap-2">
                                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
                                    Paste List
                                </button>
                            </div>
                        </div>

                        <hr class="border-gray-200">

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Select Captain</label>
                            <select id="captain-select" class="w-full p-3 bg-gray-50/50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-sm font-medium">
                                <option value="" disabled selected>Add players first...</option>
                            </select>
                        </div>

                        <div class="pt-6 pb-4">
                            <button type="submit" class="setup-btn w-full py-4 rounded-xl text-white font-bold shadow-lg text-lg flex justify-center items-center gap-2 transform active:scale-95 transition-transform">
                                Save Team
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <div id="passcode-modal" class="hidden absolute inset-0 z-50 bg-white/80 backdrop-blur-xl flex flex-col items-center justify-center animate-fade-in">
            <div class="w-full max-w-sm flex flex-col items-center">
                <div class="mb-10 text-center">
                    <div class="bg-white shadow-md w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="h-8 w-8 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800">Enter Admin Passcode</h3>
                </div>

                <div id="passcode-dots" class="flex gap-6 mb-12">
                    <div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div>
                </div>

                <div class="grid grid-cols-3 gap-x-8 gap-y-6 mb-10">
                    <div class="keypad-btn" onclick="handleKeypad(1)">1</div>
                    <div class="keypad-btn" onclick="handleKeypad(2)">2</div>
                    <div class="keypad-btn" onclick="handleKeypad(3)">3</div>
                    <div class="keypad-btn" onclick="handleKeypad(4)">4</div>
                    <div class="keypad-btn" onclick="handleKeypad(5)">5</div>
                    <div class="keypad-btn" onclick="handleKeypad(6)">6</div>
                    <div class="keypad-btn" onclick="handleKeypad(7)">7</div>
                    <div class="keypad-btn" onclick="handleKeypad(8)">8</div>
                    <div class="keypad-btn" onclick="handleKeypad(9)">9</div>
                    <div class="keypad-btn opacity-0 cursor-default"></div> 
                    <div class="keypad-btn" onclick="handleKeypad(0)">0</div>
                    <div class="keypad-btn text-base font-bold text-gray-500 bg-transparent shadow-none hover:bg-transparent" onclick="handleKeypad('back')">
                        <svg class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2M3 12l6.414 6.414a2 2 0 001.414.586H19a2 2 0 002-2V7a2 2 0 00-2-2h-8.172a2 2 0 00-1.414.586L3 12z" /></svg>
                    </div>
                </div>

                <button onclick="closePasscodeModal()" class="text-blue-600 font-semibold text-base mt-4 hover:underline">Cancel</button>
            </div>
        </div>

        <div id="bulk-paste-modal" class="hidden absolute inset-0 z-50 bg-white/90 backdrop-blur-xl flex flex-col items-center justify-center animate-fade-in p-6">
            <div class="w-full max-w-md bg-white rounded-2xl shadow-2xl border border-gray-100 overflow-hidden">
                <div class="bg-gray-50 p-4 border-b border-gray-100 flex justify-between items-center">
                    <h3 class="font-bold text-gray-800">Paste Player List</h3>
                    <button onclick="closeBulkModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                    </button>
                </div>
                <div class="p-4">
                    <p class="text-sm text-gray-500 mb-3">Paste names from WhatsApp or Notes. Each name on a new line.</p>
                    <textarea id="bulk-paste-area" class="w-full h-48 p-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-sm font-medium resize-none" placeholder="Rohit Sharma&#10;Shubman Gill&#10;Virat Kohli..."></textarea>
                    <button onclick="processBulkPaste()" class="mt-4 w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl shadow-lg transition-all active:scale-95">
                        Import Players
                    </button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // ==========================================
        // FIREBASE & CONFIG
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyBqcD59IAPpKqk98oDZkgzgkoVZ8b8LGgY",
            authDomain: "livecricketscoring-92087.firebaseapp.com",
            databaseURL: "https://livecricketscoring-92087-default-rtdb.firebaseio.com", 
            projectId: "livecricketscoring-92087",
            storageBucket: "livecricketscoring-92087.firebasestorage.app",
            messagingSenderId: "522927197627",
            appId: "1:522927197627:web:f1df5db736cae96893089e"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore(); 

        // --- GLOBAL STATE ---
        let globalTeamsList = [];
        const DEFAULT_AVATAR = "https://cdn-icons-png.flaticon.com/512/847/847969.png"; 

        const countryFlags = {
            "Afghanistan": "üá¶üá´", "Australia": "üá¶üá∫", "Bangladesh": "üáßüá©", "Canada": "üá®üá¶",
            "England": "üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø", "India": "üáÆüá≥", "Ireland": "üáÆüá™", "Namibia": "üá≥üá¶",
            "Nepal": "üá≥üáµ", "Netherlands": "üá≥üá±", "New Zealand": "üá≥üáø", "Oman": "üá¥üá≤",
            "Pakistan": "üáµüá∞", "Papua New Guinea": "üáµüá¨", "Scotland": "üè¥Û†ÅßÛ†Å¢Û†Å≥Yüáπ",
            "South Africa": "üáøüá¶", "Sri Lanka": "üá±üá∞", "United Arab Emirates": "üá¶üá™",
            "United Kingdom": "üá¨üáß", "United States": "üá∫üá∏", "West Indies": "üå¥",
            "Zimbabwe": "üáøüáº", "Other": "üè≥Ô∏è"
        };

        const getFlag = (countryName) => countryFlags[countryName] || "üè≥Ô∏è";
        const getInitials = (name) => {
            if(!name) return "";
            const words = name.split(' ');
            if (words.length === 1) return words[0].substring(0, 2).toUpperCase();
            return (words[0][0] + words[words.length - 1][0]).toUpperCase();
        };

        // --- UI REFS ---
        const ui = {
            teamListView: document.getElementById('team-list-view'),
            teamEditorView: document.getElementById('team-editor-view'),
            setupForm: document.getElementById('team-setup-form'),
            captainSelect: document.getElementById('captain-select'),
            addPlayerBtn: document.getElementById('add-player-btn'),
            playerInputsContainer: document.getElementById('player-inputs-container'),
            editorTeamNameInput: document.getElementById('editor-team-name'),
            editorTeamColorInput: document.getElementById('editor-team-color'),
            editorTeamCountryInput: document.getElementById('editor-team-country'),
            editorTeamLogoInput: document.getElementById('editor-team-logo-upload'),
            editorTeamLogoPreview: document.getElementById('editor-team-logo-preview'),
            savedTeamsContainer: document.getElementById('saved-teams-container'),
            createNewBtn: document.getElementById('create-new-team-btn'),
            backBtn: document.getElementById('back-to-list-btn'),
            searchInput: document.getElementById('search-teams'),
            filterBtn: document.getElementById('filter-btn'),
            filterMenu: document.getElementById('filter-menu'),
            passcodeModal: document.getElementById('passcode-modal'),
            passcodeDots: document.getElementById('passcode-dots').children
        };

        // --- STATE MANAGMENT ---
        let state = {
            players: [], 
            editMode: false,
            editingTeamId: null,
            currentCaptain: null,
            passcode: "",
            pendingDeleteId: null,
            filterCountry: null
        };

        // ==========================================
        // UTILITIES
        // ==========================================
        function showToast(message, type = 'success') {
            let container = document.querySelector('.toast-container');
            if (!container) {
                container = document.createElement('div');
                container.className = 'toast-container';
                document.body.appendChild(container);
            }
            const toast = document.createElement('div');
            toast.className = 'toast';
            const icon = type === 'success' 
                ? '<svg class="w-5 h-5 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>'
                : '<svg class="w-5 h-5 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>';
            toast.innerHTML = `${icon}<span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0'; toast.style.transform = 'translateY(10px)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function renderSkeletons() {
            const container = ui.savedTeamsContainer;
            let html = '';
            for(let i=0; i<3; i++) {
                html += `<div class="bg-white p-4 mb-4 rounded-xl shadow-sm border border-gray-100 flex items-center gap-3"><div class="skeleton h-12 w-12 rounded-full flex-shrink-0"></div><div class="flex-1 space-y-2"><div class="skeleton h-4 w-32"></div><div class="skeleton h-3 w-20"></div></div></div>`;
            }
            container.innerHTML = html;
        }

        function titleCase(str) {
            return str.toLowerCase().split(' ').map(function(word) {
                return (word.charAt(0).toUpperCase() + word.slice(1));
            }).join(' ');
        }

        // ==========================================
        // FILTER LOGIC
        // ==========================================
        function initFilterMenu() {
            ui.filterMenu.innerHTML = '';
            const allOption = document.createElement('div');
            allOption.className = `filter-item ${state.filterCountry === null ? 'active' : ''}`;
            allOption.innerHTML = `<span>Select Country (Show All)</span>`;
            allOption.onclick = () => selectFilter(null);
            ui.filterMenu.appendChild(allOption);

            Object.keys(countryFlags).sort().forEach(country => {
                const item = document.createElement('div');
                const isActive = state.filterCountry === country;
                item.className = `filter-item ${isActive ? 'active' : ''}`;
                const checkmark = isActive ? `<svg class="w-4 h-4 ml-auto text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>` : ``;
                item.innerHTML = `<span>${countryFlags[country]}</span> <span>${country}</span> ${checkmark}`;
                item.onclick = () => selectFilter(country);
                ui.filterMenu.appendChild(item);
            });
        }

        function selectFilter(country) {
            state.filterCountry = country;
            ui.filterMenu.classList.remove('show');
            if(country) { ui.filterBtn.classList.add('text-blue-600', 'bg-blue-50'); } 
            else { ui.filterBtn.classList.remove('text-blue-600', 'bg-blue-50'); }
            renderTeams();
        }

        ui.filterBtn.onclick = (e) => { e.stopPropagation(); initFilterMenu(); ui.filterMenu.classList.toggle('show'); };
        window.onclick = (e) => { if (!ui.filterMenu.contains(e.target) && e.target !== ui.filterBtn) { ui.filterMenu.classList.remove('show'); } };

        // ==========================================
        // PLAYER LOGIC (With Roles & Bulk)
        // ==========================================
        function initPlayerSlots() {
            state.players = [];
            // Initialize with empty players containing role flags
            for(let i=0; i<4; i++) { 
                state.players.push({ name: '', avatar: '', roles: { bat:false, bowl:false, wk:false } });
            }
            generatePlayerInputs();
        }

        function toggleRole(index, role) {
            // Safety check for legacy data
            if(!state.players[index].roles) state.players[index].roles = { bat:false, bowl:false, wk:false };
            
            state.players[index].roles[role] = !state.players[index].roles[role];
            
            // Visual update without full re-render
            const btn = document.getElementById(`btn-${role}-${index}`);
            if(state.players[index].roles[role]) {
                btn.classList.remove('inactive');
                btn.classList.add(`active-${role}`);
            } else {
                btn.classList.add('inactive');
                btn.classList.remove(`active-${role}`);
            }
        }

        function generatePlayerInputs() {
            ui.playerInputsContainer.innerHTML = '';
            
            const currentCaptainSelection = ui.captainSelect.value;
            ui.captainSelect.innerHTML = '<option value="" disabled selected>Select Captain</option>';
            const validPlayerNames = [];

            state.players.forEach((player, index) => {
                const div = document.createElement('div');
                div.className = "flex items-center gap-2 animate-fade-in bg-white/60 p-2 rounded-xl border border-gray-100 shadow-sm";
                
                const avatarSrc = player.avatar || DEFAULT_AVATAR;
                if(!player.roles) player.roles = { bat:false, bowl:false, wk:false }; // Safe defaults

                div.innerHTML = `
                    <div class="relative group cursor-pointer flex-shrink-0" onclick="document.getElementById('p-file-${index}').click()">
                        <div class="h-10 w-10 rounded-full overflow-hidden border border-gray-200 bg-white shadow-sm">
                            <img src="${avatarSrc}" class="h-full w-full object-cover" id="p-img-${index}">
                        </div>
                        <input type="file" id="p-file-${index}" hidden accept="image/*" onchange="handlePlayerImage(${index}, this)">
                    </div>

                    <div class="flex-1 min-w-0">
                         <input type="text" 
                            value="${player.name}" 
                            placeholder="Player Name" 
                            class="w-full bg-transparent border-b border-gray-300 focus:border-blue-500 outline-none py-1 text-sm font-medium placeholder-gray-400"
                            oninput="handlePlayerName(${index}, this)"
                        >
                    </div>

                    <div class="flex items-center gap-1">
                        <button type="button" id="btn-bat-${index}" onclick="toggleRole(${index}, 'bat')" class="role-btn ${player.roles.bat ? 'active-bat' : 'inactive'}" title="Batsman">üèè</button>
                        <button type="button" id="btn-bowl-${index}" onclick="toggleRole(${index}, 'bowl')" class="role-btn ${player.roles.bowl ? 'active-bowl' : 'inactive'}" title="Bowler">‚öæ</button>
                        <button type="button" id="btn-wk-${index}" onclick="toggleRole(${index}, 'wk')" class="role-btn ${player.roles.wk ? 'active-wk' : 'inactive'}" title="Wicket Keeper">üß§</button>
                    </div>
                    
                    ${state.players.length > 2 ? `
                    <button type="button" onclick="removePlayer(${index})" class="text-gray-400 hover:text-red-500 p-1 ml-1">
                        <svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                    </button>` : ''}
                `;
                ui.playerInputsContainer.appendChild(div);

                if (player.name.trim()) validPlayerNames.push(player.name);
            });

            validPlayerNames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                if (name === state.currentCaptain || name === currentCaptainSelection) option.selected = true;
                ui.captainSelect.appendChild(option);
            });
        }

        window.handlePlayerName = function(index, input) { state.players[index].name = input.value; };
        document.addEventListener('focusout', function(e) {
            if(e.target.tagName === 'INPUT' && e.target.type === 'text') { e.target.value = titleCase(e.target.value); }
        });

        window.handlePlayerImage = function(index, input) {
            const file = input.files[0];
            if (!file) return;
            if (file.size > 5 * 1024 * 1024) { showToast("‚ö†Ô∏è Photo too large (max 5MB)", "error"); input.value = ''; return; }
            const reader = new FileReader();
            reader.onload = (readerEvent) => {
                const tempImg = new Image();
                tempImg.onload = () => {
                    const MAX_SIZE = 300; const canvas = document.createElement('canvas'); canvas.width = MAX_SIZE; canvas.height = MAX_SIZE;
                    const ctx = canvas.getContext('2d');
                    let sWidth, sHeight, sx, sy;
                    if (tempImg.width > tempImg.height) { sHeight = tempImg.height; sWidth = tempImg.height; sx = (tempImg.width - tempImg.height) / 2; sy = 0; } else { sWidth = tempImg.width; sHeight = tempImg.width; sx = 0; sy = (tempImg.height - tempImg.width) / 2; }
                    ctx.drawImage(tempImg, sx, sy, sWidth, sHeight, 0, 0, MAX_SIZE, MAX_SIZE);
                    const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.7);
                    state.players[index].avatar = compressedDataUrl;
                    document.getElementById(`p-img-${index}`).src = compressedDataUrl;
                }; tempImg.src = readerEvent.target.result;
            }; reader.readAsDataURL(file);
        };

        window.removePlayer = function(index) { state.players.splice(index, 1); generatePlayerInputs(); };

        // --- BULK PASTE LOGIC ---
        function openBulkModal() {
            document.getElementById('bulk-paste-modal').classList.remove('hidden');
            document.getElementById('bulk-paste-area').value = '';
            document.getElementById('bulk-paste-area').focus();
        }
        function closeBulkModal() { document.getElementById('bulk-paste-modal').classList.add('hidden'); }
        
        function processBulkPaste() {
            const rawText = document.getElementById('bulk-paste-area').value;
            if (!rawText.trim()) { closeBulkModal(); return; }

            // Regex strips "1.", "2)", etc.
            const names = rawText.split(/\r?\n/).map(line => line.replace(/^[\d\W]+/, '').trim()).filter(name => name.length > 0);
            if (names.length === 0) return;

            // Clear empty slots if the team is currently empty
            if(state.players.every(p => !p.name)) state.players = [];

            names.forEach(name => {
                state.players.push({ name: titleCase(name), avatar: '', roles: { bat:false, bowl:false, wk:false } });
            });

            generatePlayerInputs();
            showToast(`Imported ${names.length} players`, 'success');
            closeBulkModal();
        }

        // ==========================================
        // MAIN FORM SUBMIT
        // ==========================================
        ui.setupForm.onsubmit = (e) => {
            e.preventDefault();

            const teamName = ui.editorTeamNameInput.value.trim().toUpperCase(); 
            const teamColor = ui.editorTeamColorInput.value;
            const teamCountry = ui.editorTeamCountryInput.value;
            const teamLogo = ui.editorTeamLogoPreview.dataset.logoSrc || ''; 
            
            const validPlayers = state.players.map(p => ({ ...p, name: titleCase(p.name) })).filter(p => p.name && p.name.trim() !== '');
            
            if (!teamName || validPlayers.length < 2) {
                showToast("Enter Team Name and 2+ Players", "error"); return;
            }

            const teamData = {
                name: teamName, color: teamColor, country: teamCountry || 'Other', logo: teamLogo,
                players: validPlayers, captain: ui.captainSelect.value, updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            const submitBtn = ui.setupForm.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.textContent = "Saving..."; submitBtn.disabled = true;

            const firebaseOperation = state.editMode && state.editingTeamId
                ? db.collection("teams").doc(state.editingTeamId).update(teamData)
                : db.collection("teams").add(teamData);

            firebaseOperation.then(() => {
                showToast("Team Saved Successfully!", "success");
                resetForm(); showTeamListView();
            }).catch((err) => {
                showToast("Error: " + err.message, "error");
            }).finally(() => {
                submitBtn.innerHTML = originalText; submitBtn.disabled = false;
            });
        };

        // ==========================================
        // DATA LOADING & RENDERING
        // ==========================================
        function loadSavedTeams() {
            renderSkeletons();
            db.collection("teams").onSnapshot((snapshot) => {
                globalTeamsList = [];
                if (snapshot.empty) {
                    ui.savedTeamsContainer.innerHTML = `<div class="text-center py-10 text-gray-400">No teams yet. Create one!</div>`; return;
                }
                snapshot.forEach((doc) => {
                    const team = doc.data(); team.id = doc.id; globalTeamsList.push(team);
                });
                renderTeams();
            });
        }

        function renderTeams() {
            const container = ui.savedTeamsContainer;
            container.innerHTML = '';
            
            const searchTerm = ui.searchInput.value.toLowerCase().trim();
            const filteredTeams = globalTeamsList.filter(team => {
                const matchesSearch = team.name.toLowerCase().includes(searchTerm);
                const matchesCountry = state.filterCountry ? (team.country === state.filterCountry) : true;
                return matchesSearch && matchesCountry;
            });

            if (filteredTeams.length === 0) {
                if (globalTeamsList.length > 0) {
                    const emptyMsg = state.filterCountry ? `No teams found in ${state.filterCountry}` : "No teams match your search.";
                    container.innerHTML = `<div class="text-center py-10 text-gray-400 flex flex-col items-center gap-2"><svg class="w-10 h-10 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg><span>${emptyMsg}</span></div>`;
                }
                return;
            }

            const groupedTeams = {};
            filteredTeams.forEach(team => {
                const country = team.country || 'Other';
                if (!groupedTeams[country]) groupedTeams[country] = [];
                groupedTeams[country].push(team);
            });

            const sortedCountries = Object.keys(groupedTeams).sort();

            sortedCountries.forEach(country => {
                const countryHeader = document.createElement('div');
                countryHeader.className = "flex items-center gap-2 mt-6 mb-3 px-1";
                countryHeader.innerHTML = `<span class="text-xs font-bold text-gray-500 uppercase tracking-wider">${country}</span><div class="h-[1px] flex-1 bg-gray-200"></div>`;
                container.appendChild(countryHeader);

                const teamsInCountry = groupedTeams[country].sort((a, b) => a.name.localeCompare(b.name));

                teamsInCountry.forEach(team => {
                    const playerCount = team.players ? team.players.length : 0;
                    const captainName = team.captain ? team.captain.split(' ')[0] : 'No Captain'; 
                    const teamColor = team.color || '#3b82f6';
                    const initials = getInitials(team.name);
                    
                    const card = document.createElement('div');
                    card.className = "bg-white p-3 mb-4 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center relative overflow-hidden transition-all active:scale-[0.99]";
                    card.style.borderLeft = `4px solid ${teamColor}`;

                    let logoHtml = team.logo 
                        ? `<img src="${team.logo}" class="h-full w-full object-cover">` 
                        : `<div class="w-full h-full flex items-center justify-center text-white font-bold text-sm tracking-widest" style="background-color: ${teamColor}">${initials}</div>`;

                    card.innerHTML = `
                        <div class="flex-1 min-w-0 flex items-center gap-3">
                            <div class="h-12 w-12 rounded-lg flex-shrink-0 overflow-hidden shadow-sm bg-gray-50">
                                ${logoHtml}
                            </div>
                            <div class="flex-1 min-w-0 flex flex-col justify-center">
                                <div class="flex items-center gap-2">
                                    <h3 class="font-bold text-gray-800 text-base leading-none truncate">${team.name}</h3>
                                    <span class="text-lg leading-none">${getFlag(team.country)}</span>
                                </div>
                                <div class="flex items-center gap-3 mt-1.5">
                                    <div class="flex items-center gap-1 text-xs text-gray-500 bg-gray-50 px-2 py-0.5 rounded-md border border-gray-100">
                                        <svg class="w-3 h-3 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
                                        <span class="font-medium">${playerCount}</span>
                                    </div>
                                    ${team.captain ? `<div class="flex items-center gap-1 text-xs text-blue-600 bg-blue-50 px-2 py-0.5 rounded-md border border-blue-100"><span class="font-bold">C</span><span class="truncate max-w-[80px]">${captainName}</span></div>` : ''}
                                </div>
                            </div>
                        </div>

                        <div class="flex items-center gap-1 pl-2">
                            <button onclick="editTeam('${team.id}')" class="p-2 text-gray-400 hover:text-blue-600 bg-transparent hover:bg-blue-50 rounded-full transition-all">
                                <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" /></svg>
                            </button>
                            <button onclick="initiateDelete('${team.id}')" class="p-2 text-gray-400 hover:text-red-600 bg-transparent hover:bg-red-50 rounded-full transition-all">
                                <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                            </button>
                        </div>
                    `;
                    container.appendChild(card);
                });
            });
        }

        // ==========================================
        // DELETE & PASSCODE
        // ==========================================
        window.initiateDelete = function(id) {
            state.pendingDeleteId = id; state.passcode = ""; updatePasscodeUI(); ui.passcodeModal.classList.remove('hidden');
        };

        window.closePasscodeModal = function() {
            ui.passcodeModal.classList.add('hidden'); state.pendingDeleteId = null; state.passcode = "";
        };

        window.handleKeypad = function(key) {
            if (key === 'back') {
                if(state.passcode.length > 0) { state.passcode = state.passcode.slice(0, -1); updatePasscodeUI(); } return;
            }
            if (state.passcode.length < 4) {
                state.passcode += key; updatePasscodeUI();
                if (state.passcode.length === 4) {
                    setTimeout(() => {
                        if (state.passcode === "2626") { performDelete(); } else {
                            ui.passcodeDots.parentElement.classList.add('animate-pulse');
                            setTimeout(() => { ui.passcodeDots.parentElement.classList.remove('animate-pulse'); state.passcode = ""; updatePasscodeUI(); }, 200);
                        }
                    }, 100); 
                }
            }
        };

        function updatePasscodeUI() {
            const dots = ui.passcodeDots;
            for(let i=0; i<4; i++) {
                if(i < state.passcode.length) { dots[i].classList.add('filled'); } else { dots[i].classList.remove('filled'); }
            }
        }

        function performDelete() {
            if (state.pendingDeleteId) {
                db.collection("teams").doc(state.pendingDeleteId).delete()
                    .then(() => { closePasscodeModal(); showToast("Team Deleted", "success"); })
                    .catch(err => showToast("Error: " + err.message, "error"));
            }
        }

        // ==========================================
        // EDIT MODE HANDLING
        // ==========================================
        window.editTeam = function(id) {
            const team = globalTeamsList.find(t => t.id === id); if (!team) return;
            state.editMode = true; state.editingTeamId = id;
            ui.editorTeamNameInput.value = team.name; ui.editorTeamColorInput.value = team.color;
            if(ui.editorTeamCountryInput) ui.editorTeamCountryInput.value = team.country || "";
            if (team.logo) {
                ui.editorTeamLogoPreview.src = team.logo; ui.editorTeamLogoPreview.dataset.logoSrc = team.logo; ui.editorTeamLogoPreview.classList.remove('hidden');
            } else {
                ui.editorTeamLogoPreview.src = ''; ui.editorTeamLogoPreview.classList.add('hidden');
            }
            
            // Map players and ensure role object exists for legacy data
            state.players = (team.players || []).map(p => { 
                if(typeof p === 'string') return { name: p, avatar: '', roles: {bat:false, bowl:false, wk:false} };
                if(!p.roles) p.roles = {bat:false, bowl:false, wk:false};
                return p;
            });

            while(state.players.length < 4) state.players.push({ name: '', avatar: '', roles: {bat:false, bowl:false, wk:false} });
            state.currentCaptain = team.captain; generatePlayerInputs(); showEditorView();
        };

        function resetForm() {
            state = { players: [], editMode: false, editingTeamId: null, currentCaptain: null, passcode: "", filterCountry: state.filterCountry, pendingDeleteId: null };
            initPlayerSlots();
            ui.editorTeamNameInput.value = ''; ui.editorTeamColorInput.value = '#3b82f6';
            if(ui.editorTeamCountryInput) ui.editorTeamCountryInput.selectedIndex = 0;
            ui.editorTeamLogoInput.value = ''; ui.editorTeamLogoPreview.src = ''; ui.editorTeamLogoPreview.dataset.logoSrc = ''; ui.editorTeamLogoPreview.classList.add('hidden');
        }

        function showEditorView() { ui.teamListView.classList.add('hidden'); ui.teamEditorView.classList.remove('hidden'); }
        function showTeamListView() { ui.teamEditorView.classList.add('hidden'); ui.teamListView.classList.remove('hidden'); }

        // ==========================================
        // INIT
        // ==========================================
        document.addEventListener('DOMContentLoaded', () => {
            loadSavedTeams(); showTeamListView();
            ui.searchInput.addEventListener('input', renderTeams);

            ui.editorTeamLogoInput.onchange = (e) => {
                const file = e.target.files[0]; if (!file) return;
                if (file.size > 5 * 1024 * 1024) { showToast("‚ö†Ô∏è Logo too large (max 5MB)", "error"); e.target.value = ''; return; }
                const reader = new FileReader();
                reader.onload = (readerEvent) => {
                    const tempImg = new Image();
                    tempImg.onload = () => {
                        const MAX_SIZE = 300; const canvas = document.createElement('canvas'); canvas.width = MAX_SIZE; canvas.height = MAX_SIZE;
                        const ctx = canvas.getContext('2d');
                        let sWidth, sHeight, sx, sy;
                        if (tempImg.width > tempImg.height) { sHeight = tempImg.height; sWidth = tempImg.height; sx = (tempImg.width - tempImg.height) / 2; sy = 0; } else { sWidth = tempImg.width; sHeight = tempImg.width; sx = 0; sy = (tempImg.height - tempImg.width) / 2; }
                        ctx.drawImage(tempImg, sx, sy, sWidth, sHeight, 0, 0, MAX_SIZE, MAX_SIZE);
                        const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.7);
                        ui.editorTeamLogoPreview.src = compressedDataUrl; ui.editorTeamLogoPreview.dataset.logoSrc = compressedDataUrl; ui.editorTeamLogoPreview.classList.remove('hidden');
                    }; tempImg.src = readerEvent.target.result;
                }; reader.readAsDataURL(file);
            };

            ui.createNewBtn.onclick = () => { resetForm(); showEditorView(); };
            ui.backBtn.onclick = showTeamListView;
            ui.addPlayerBtn.onclick = () => { state.players.push({ name: '', avatar: '', roles: {bat:false, bowl:false, wk:false} }); generatePlayerInputs(); };
        });
    </script>
</body>
</html>
