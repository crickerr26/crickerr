<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Cricker - Tournament & Scoring</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f8fafc; /* slate-50 */
            --card-bg: rgba(255, 255, 255, 0.65);
            --card-border: rgba(255, 255, 255, 0.4);
            --text-primary: #1e293b; /* slate-800 */
            --text-secondary: #475569; /* slate-600 */
            --text-tertiary: #94a3b8; /* slate-400 */
            --accent-color: #4f46e5; /* indigo-600 */
            --shadow-color: rgba(71, 85, 105, 0.1);
        }
        html {
            scroll-behavior: smooth;
        }
        .section-anchor {
            scroll-margin-top: 120px; /* Adjust based on header height */
        }
        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 50;
            transition: all 0.2s ease-in-out;
        }
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-primary);
        }
        .glass-card {
            background: var(--card-bg);
            -webkit-backdrop-filter: blur(14px);
            backdrop-filter: blur(14px);
            border: 1px solid var(--card-border);
            box-shadow: 0 4px 12px var(--shadow-color);
            border-radius: 1.25rem; /* rounded-2xl */
            transition: transform 150ms ease, box-shadow 150ms ease;
            position: relative;
            overflow: hidden;
        }
        .glass-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px var(--shadow-color);
        }
        .glass-card::before { /* Ripple effect */
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.4s ease, height 0.4s ease;
            opacity: 0;
        }
        .glass-card:active::before {
            width: 300px;
            height: 300px;
            opacity: 1;
            transition: 0s;
        }
        @media (prefers-reduced-motion: reduce) {
            .glass-card, .glass-card:hover, .setup-btn {
                transition: none;
                animation: none;
            }
        }
        .setup-btn { background-color: var(--accent-color); transition: all 150ms ease; }
        .setup-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(79, 70, 229, 0.2); }
        .setup-step { transition: opacity 0.3s ease, transform 0.3s ease; }
        .setup-step.hidden { opacity: 0; transform: translateX(20px); position: absolute; pointer-events: none; }
        .modal-overlay { transition: opacity 0.2s ease; }
        .modal-content { transition: transform 0.2s ease, opacity 0.2s ease; }
        h1 { font-size: clamp(1.8rem, 3vw, 2.25rem); }
        h2 { font-size: clamp(1.4rem, 2.5vw, 1.875rem); }
        h3 { font-size: clamp(1.1rem, 2vw, 1.25rem); }
        p, span, div { font-size: clamp(0.8rem, 1.5vw, 0.95rem); }
        .text-xs { font-size: clamp(0.7rem, 1.2vw, 0.75rem); }

        .player-avatar {
            border-radius: 9999px;
            border: 1px solid rgba(255, 255, 255, 0.75);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: white;
            flex-shrink: 0;
            overflow: hidden;
        }
        .player-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .avatar-sm { width: 24px; height: 24px; font-size: 0.7rem; }
        .avatar-md { width: 32px; height: 32px; font-size: 0.85rem; }
        .avatar-lg { width: 48px; height: 48px; font-size: 1.2rem; }
        .avatar-xl { width: 64px; height: 64px; font-size: 1.75rem; border-width: 2px; }

        #tournament-dashboard .team-logo-compact {
            width: 28px;
            height: 28px;
            font-size: 0.8rem;
            border: 2px solid rgba(255,255,255,0.5);
            flex-shrink: 0;
        }
        #tournament-dashboard .points-table thead {
            position: sticky;
            top: 0;
            background: rgba(248, 250, 252, 0.7);
            backdrop-filter: blur(8px);
        }
        #tournament-dashboard .points-table tbody tr:nth-child(even) {
            background-color: rgba(241, 245, 249, 0.5);
        }
        #tournament-dashboard .points-table td, #tournament-dashboard .points-table th {
            padding: 0.6rem 0.5rem;
            border-bottom: 1px solid rgba(0,0,0,0.06);
        }
        
        /* Mobile and Responsive Styles */
        @media (max-width: 1023px) {
            #tournament-dashboard .grid { grid-template-columns: 1fr; }
        }

        @media (max-width: 768px) {
            body { -webkit-tap-highlight-color: transparent; }
            body.modal-open { overflow: hidden; }

            #scorer-app { height: 100svh; }
            #scorer-app > .grid { display: flex; flex-direction: column; }
            #main-content-area { padding-bottom: 260px; }
            #scoring-controls-container {
                position: fixed; bottom: 0; left: 0; right: 0;
                background: #f8fafc;
                padding: 0.5rem;
                border-top: 1px solid #e2e8f0;
                padding-bottom: calc(0.5rem + env(safe-area-inset-bottom));
                z-index: 40;
            }
            .scoring-grid { height: 220px; }
        }

        @media (max-width: 640px) {
            .modal-overlay { align-items: flex-end; }
            .modal-content {
                width: 100%; max-width: 100%; margin: 0;
                border-radius: 1.25rem 1.25rem 0 0;
                transform: translateY(100%);
                animation: bottom-sheet-enter 0.3s ease forwards;
                padding-bottom: calc(1rem + env(safe-area-inset-bottom));
            }
            .modal-overlay.hidden .modal-content { animation: bottom-sheet-leave 0.3s ease forwards; }
            #alert-modal, #confirm-modal { align-items: center; }
            #alert-modal .modal-content, #confirm-modal .modal-content {
                 width: 90%; max-width: 320px;
                 border-radius: 1.25rem; animation: none; transform: translateY(0);
            }
            .modal-content button, .modal-content select { min-height: 44px; }
            
            @keyframes bottom-sheet-enter { from { transform: translateY(100%); } to { transform: translateY(0); } }
            @keyframes bottom-sheet-leave { from { transform: translateY(0); } to { transform: translateY(100%); } }
        }
    </style>
</head>
<body class="antialiased">

    <div id="tournament-choice-screen" class="min-h-screen w-full flex flex-col items-center justify-center p-4">
        <div class="w-full max-w-4xl bg-white/50 backdrop-blur-sm border border-gray-200/80 shadow-xl rounded-2xl p-6 md:p-8 flex flex-col">
            <header class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800">Tournament Dashboard</h1>
                <p class="text-gray-500 mt-1">Choose an option to get started</p>
            </header>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div onclick="showSetupScreen()" class="apple-card cursor-pointer p-6 rounded-2xl flex flex-col justify-center items-center text-center">
                    <div class="bg-gray-200 p-3 rounded-full">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                        </svg>
                    </div>
                    <h2 class="text-xl font-bold text-gray-800 mt-4">Create New Tournament</h2>
                    <p class="text-gray-500 text-sm mt-1">Set up a new tournament from scratch.</p>
                </div>
                <a href="upcoming_tournaments.html" class="apple-card block p-6 rounded-2xl flex flex-col justify-center items-center text-center">
                    <div class="bg-gray-200 p-3 rounded-full">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                    </div>
                    <h2 class="text-xl font-bold text-gray-800 mt-4">Upcoming Tournaments</h2>
                    <p class="text-gray-500 text-sm mt-1">View or start tournaments scheduled for a future date.</p>
                </a>
                <a href="tournament_history.html" class="apple-card block p-6 rounded-2xl flex flex-col justify-center items-center text-center">
                     <div class="bg-gray-200 p-3 rounded-full">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                    </div>
                    <h2 class="text-xl font-bold text-gray-800 mt-4">Tournament History</h2>
                    <p class="text-gray-500 text-sm mt-1">Review results and stats from completed tournaments.</p>
                </a>
            </div>
            <div class="mt-8 text-center">
                <a href="index.html" class="text-sm font-semibold text-gray-600 hover:text-gray-800">← Back to Home</a>
            </div>
        </div>
    </div>

    <div id="app-container" class="hidden">
        <div id="event-animation-overlay" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 pointer-events-none hidden z-[80]">
            <h1 id="event-animation-text" class="text-8xl font-black uppercase" style="text-shadow: 3px 3px 6px rgba(0,0,0,0.5);"></h1>
        </div>

        <div id="tournament-flow">
            <div id="tournament-setup" class="min-h-screen flex items-center justify-center p-4">
                <div class="w-full max-w-4xl bg-white shadow-xl rounded-2xl p-8 overflow-hidden">
                     <div class="absolute top-4 left-4 hidden md:block">
                        <button onclick="window.history.back()" class="px-4 py-2 text-sm font-semibold text-gray-600 hover:text-gray-800">&larr; Back</button>
                    </div>
                    <div id="progress-container" class="mb-8">
                        <div class="w-full bg-gray-200 h-2 rounded-full"><div id="progress-bar" class="progress-bar-fill h-2 rounded-full" style="width: 25%;"></div></div>
                        <div class="flex justify-between text-xs sm:text-sm text-gray-500 mt-2"><span>Details</span><span>Teams</span><span>Groups & Fixtures</span><span>Dashboard</span></div>
                    </div>
                    <div class="relative">
                        <div id="setup-step-1" class="setup-step active">
    <header class="text-center mb-8"><h1 class="text-3xl font-bold text-gray-800">Tournament Setup</h1><p class="text-gray-500 mt-1">Enter the basic details for your tournament.</p></header>
    <div class="space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div><label for="tournament-name" class="block text-sm font-bold text-gray-700 mb-1 required-field">Tournament Name</label><input type="text" id="tournament-name" placeholder="e.g., Summer Cup 2025" class="w-full p-3 border-gray-300 border rounded-md uppercase"></div>
            <div class="relative">
                <label for="start-date" class="block text-sm font-bold text-gray-700 mb-1 required-field">Start Date</label>
                <div class="relative"><input type="date" id="start-date" class="w-full p-3 border-gray-300 border rounded-md"><span class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none text-gray-400">📅</span></div>
            </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <label for="tournament-teams" class="block text-sm font-bold text-gray-700 mb-1 required-field">Number of Teams</label>
                <input type="number" id="tournament-teams" placeholder="e.g., 8" class="w-full p-3 border-gray-300 border rounded-md">
            </div>
            <div>
                <label for="tournament-players" class="block text-sm font-bold text-gray-700 mb-1 required-field">Max Players per Side</label>
                <select id="tournament-players" class="w-full p-3 border-gray-300 border rounded-md"><option value="" disabled selected>Select Players</option><option value="6">6 Players</option><option value="7">7 Players</option><option value="8">8 Players</option><option value="9">9 Players</option><option value="10">10 Players</option><option value="11" selected>11 Players</option></select>
            </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <label for="tournament-overs" class="block text-sm font-bold text-gray-700 mb-1 required-field">Max Overs per Innings</label>
                <select id="tournament-overs" class="w-full p-3 border-gray-300 border rounded-md"><option value="" disabled selected>Select Overs</option><script>for(let i = 1; i <= 20; i++) { document.write(`<option value="${i}">${i} Over${i > 1 ? 's' : ''}</option>`); }</script><option value="50">50 Overs</option></select>
            </div>
            <div>
                <label for="balls-per-over" class="block text-sm font-bold text-gray-700 mb-1 required-field">Balls per Over</label>
                <select id="balls-per-over" class="w-full p-3 border-gray-300 border rounded-md"><option value="" disabled selected>Select Balls</option><option value="6">6 Balls</option><option value="5">5 Balls</option><option value="7">7 Balls</option><option value="8">8 Balls</option></select>
            </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <label for="free-hit-enabled" class="block text-sm font-bold text-gray-700 mb-1">Free Hit Enabled?</label>
                <select id="free-hit-enabled" class="w-full p-3 border-gray-300 border rounded-md" onchange="toggleFreeHitRules()"><option value="" disabled selected>Select Option</option><option value="no">No</option><option value="yes">Yes</option></select>
            </div>
            <div id="free-hit-rules-container" class="hidden">
                <label for="free-hit-rules" class="block text-sm font-bold text-gray-700 mb-1">Free Hit on:</label>
                <select id="free-hit-rules" class="w-full p-3 border-gray-300 border rounded-md"><option value="overstep_only">Overstepping No-ball Only</option><option value="all">All No-balls</option></select>
            </div>
        </div>

        <div class="pt-6 border-t mt-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Groups & Fixtures Settings</h2>
            <div class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="tournament-format" class="block text-sm font-bold text-gray-700 mb-1 required-field">Tournament Format</label>
                        <select id="tournament-format" class="w-full p-3 border-gray-300 border rounded-md">
                            <option value="" disabled selected>Select Format</option>
                            <option value="round-robin">Round Robin</option>
                            <option value="double_round_robin">Double Round Robin</option>
                            <option value="knockout">Knockout</option>
                            <option value="group_knockout">Group Stage & Knockout</option>
                            <option value="playoffs">Playoffs (IPL Style)</option>
                            <option value="super_stage">Super Six/Eight</option>
                        </select>
                    </div>
                    <div id="group-selection-container">
                        <label for="number-of-groups" class="block text-sm font-bold text-gray-700 mb-1 required-field">Number of Groups</label>
                        <select id="number-of-groups" class="w-full p-3 border-gray-300 border rounded-md">
                            <option value="" disabled selected>Select Groups</option>
                            <option value="1">1 Group</option>
                            <option value="2">2 Groups</option>
                            <option value="4">4 Groups</option>
                        </select>
                    </div>
                    <div>
                        <label for="matches-per-team" class="block text-sm font-bold text-gray-700 mb-1 required-field">Matches Per Team (in Group)</label>
                        <input type="number" id="matches-per-team" placeholder="e.g., 1" class="w-full p-3 border-gray-300 border rounded-md">
                    </div>
                    <div id="knockout-teams-per-group-container" class="hidden">
                        <label for="knockout-teams-per-group" class="block text-sm font-bold text-gray-700 mb-1 required-field">Teams Advancing per Group</label>
                        <input type="number" id="knockout-teams-per-group" placeholder="e.g., 2" class="w-full p-3 border-gray-300 border rounded-md">
                    </div>
                </div>
                <div id="points-rules-container" class="p-4 bg-slate-50 rounded-lg">
                    <h3 class="font-bold text-lg text-indigo-600 mb-2">Points Rules</h3>
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                        <div><label class="block text-sm font-medium text-gray-700">Win</label><input type="number" id="points-win" value="2" class="w-full p-2 border-gray-300 border rounded-md"></div>
                        <div><label class="block text-sm font-medium text-gray-700">Loss</label><input type="number" id="points-loss" value="0" class="w-full p-2 border-gray-300 border rounded-md"></div>
                        <div><label class="block text-sm font-medium text-gray-700">Tie</label><input type="number" id="points-tie" value="1" class="w-full p-2 border-gray-300 border rounded-md"></div>
                        <div><label class="block text-sm font-medium text-gray-700">No Result</label><input type="number" id="points-no-result" value="1" class="w-full p-2 border-gray-300 border rounded-md"></div>
                    </div>
                </div>
            </div>
        </div>

    </div>
    <div class="mt-8 flex justify-end items-center"><button onclick="goToStep(2)" class="px-6 py-3 text-white font-bold rounded-lg setup-btn">Next: Add Teams</button></div>
</div>
    <div id="setup-step-2" class="setup-step hidden">
     <div class="absolute top-4 left-4">
        <button onclick="goToStep(1)" class="font-semibold text-gray-600 hover:text-gray-800">&larr; Back</button>
    </div>
    <header class="text-center mb-8"><h1 class="text-3xl font-bold header-gradient">Enter Team Details</h1><p class="text-gray-500 mt-1">Enter the name and players for each team.</p></header>
    <div id="team-entry-container" class="space-y-4 max-h-[50vh] overflow-y-auto pr-2"></div>
    <div class="mt-8 flex justify-between items-center"><button onclick="goToStep(1)" class="font-semibold text-gray-600 hover:text-gray-800">Back</button><button onclick="goToStep(3)" class="px-6 py-3 text-white font-bold rounded-lg setup-btn">Next: Groups & Fixtures</button></div>
</div>
    <div id="setup-step-3" class="setup-step hidden">
    <div class="absolute top-4 left-4">
        <button onclick="goToStep(2)" class="font-semibold text-gray-600 hover:text-gray-800">&larr; Back</button>
    </div>
     <header class="text-center mb-8"><h1 class="text-3xl font-bold text-gray-800">Assign Teams to Groups</h1><p class="text-gray-500 mt-1">Select teams to assign them to their respective groups.</p></header>
     
     <div id="group-assignment-container" class="mt-6 space-y-4 max-h-[50vh] overflow-y-auto pr-2"></div>
     
     <div class="mt-8 flex justify-between items-center"><button onclick="goToStep(2)" class="font-semibold text-gray-600 hover:text-gray-800">Back</button><button onclick="finalizeTeamsAndGoToDashboard()" class="px-6 py-3 text-white font-bold rounded-lg setup-btn">Confirm & Create Tournament</button></div>
</div>
                    </div>
                </div>
            </div>
            
            <div id="tournament-dashboard" class="hidden">
                <div id="dashboard-sticky-header" class="sticky-header bg-slate-50/80 backdrop-blur-lg border-b border-slate-200/80">
                    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div class="flex items-center justify-between h-16">
                            <div class="flex-shrink-0">
                                <h1 id="dashboard-sticky-title" class="text-lg font-bold text-slate-800 truncate"></h1>
                            </div>
                            <div class="flex items-center space-x-4 sm:space-x-6 text-sm font-semibold">
                                <a href="#fixtures-section" class="text-slate-600 hover:text-indigo-600">Fixtures</a>
                                <a href="#points-section" class="text-slate-600 hover:text-indigo-600">Points</a>
                                <a href="#leaders-section" class="text-slate-600 hover:text-indigo-600">Leaders</a>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="max-w-6xl mx-auto p-4 md:p-8">
                    <header class="mb-8 text-center">
                        <h1 id="dashboard-title" class="text-4xl font-extrabold text-gray-800"></h1>
                        <p id="dashboard-subtitle" class="text-gray-500 mt-1"></p>
                    </header>
                    
                    <div class="flex flex-col gap-8">
                        <section id="fixtures-section" class="section-anchor">
                            <h2 class="text-2xl font-bold text-slate-800 mb-4">Fixtures</h2>
                            <div id="fixtures-list" class="space-y-3"></div>
                        </section>

                        <section id="points-section" class="section-anchor">
                             <h2 class="text-2xl font-bold text-slate-800 mb-4">Points Table</h2>
                            <div id="points-table-container" class="glass-card p-4"></div>
                        </section>

                        <section id="leaders-section" class="section-anchor">
                            <h2 class="text-2xl font-bold text-slate-800 mb-4">Leaderboards</h2>
                            <div id="leaderboards-container" class="space-y-6"></div>
                        </section>
                    </div>

                    <div class="text-center mt-12">
                        <a href="index.html" class="px-6 py-3 bg-slate-600 text-white font-bold rounded-lg hover:bg-slate-700 transition-colors">Back to Home</a>
                    </div>
                </div>
            </div>
        </div>

        <div id="scorer-section" class="hidden">
             <div class="fixed top-4 left-4 z-50">
                <button onclick="showConfirm('Are you sure you want to quit the match?', () => returnToDashboard(false))" class="px-4 py-2 bg-gray-500 text-white rounded-lg">Back to Dashboard</button>
            </div>
            <div id="toss-screen" class="min-h-screen w-full flex flex-col items-center justify-center bg-slate-200 p-4">
                <div class="w-full max-w-lg mx-auto text-slate-800">
                    <header class="text-center mb-8"><h1 class="text-3xl font-bold">Toss Result</h1><p class="text-slate-600 mt-1">Select the toss winner and their choice</p></header>
                    <div class="space-y-8">
                        <div>
                            <p class="text-center font-semibold mb-4">Who won the toss?</p>
                            <div class="flex justify-center gap-6">
                                <button id="toss-winner-team1" class="toss-3d-button flex flex-col items-center gap-3 w-32 p-4"><div id="toss-team1-logo-container" class="w-16 h-16 rounded-full flex items-center justify-center text-2xl font-bold bg-cover bg-center text-white"></div><span id="toss-team1-name" class="truncate w-full"></span></button>
                                <button id="toss-winner-team2" class="toss-3d-button flex flex-col items-center gap-3 w-32 p-4"><div id="toss-team2-logo-container" class="w-16 h-16 rounded-full flex items-center justify-center text-2xl font-bold bg-cover bg-center text-white"></div><span id="toss-team2-name" class="truncate w-full"></span></button>
                            </div>
                        </div>
                        <div id="toss-decision-container" class="hidden text-center">
                            <p class="font-semibold mb-4">...and elected to:</p>
                            <div class="flex justify-center gap-6">
                                <button id="toss-choice-bat" class="toss-3d-button w-32 py-3">Bat First</button><button id="toss-choice-bowl" class="toss-3d-button w-32 py-3">Field First</button>
                            </div>
                        </div>
                    </div>
                    <div class="mt-12 flex justify-between items-center">
                        <button onclick="returnToDashboard(false)" class="font-semibold text-gray-600 hover:text-gray-800">Back to Dashboard</button>
                        <button id="start-match-btn" class="px-6 py-2 text-white font-bold rounded-lg setup-btn opacity-50 cursor-not-allowed" disabled>Start Scoring</button>
                    </div>
                </div>
            </div>
            
            <div id="scorer-app" class="h-screen w-full flex-col hidden">
                <div id="match-header" class="text-center py-2 px-4 bg-white border-b"></div>
                <div class="flex-grow w-full grid lg:grid-cols-3 gap-4 p-4">
                    <div id="main-content-area" class="lg:col-span-2 space-y-3 flex flex-col">
                        <div id="scoreboard" class="bg-white rounded-lg p-4 border shadow-sm">
                            <div id="team-scores-container" class="space-y-2"></div>
                            <div id="free-hit-indicator" class="hidden text-center p-2 mt-2 bg-red-100 text-red-800 font-bold rounded-lg">FREE HIT</div>
                            <div class="grid grid-cols-2 gap-2 mt-4 text-xs font-semibold text-gray-600">
                                <div class="p-2 bg-gray-100 rounded-md text-center">CRR: <span id="crr-display">0.00</span></div>
                                <div class="p-2 bg-gray-100 rounded-md text-center">RRR: <span id="rrr-display">0.00</span></div>
                            </div>
                        </div>
                        <div id="target-info-container" class="hidden bg-blue-100 text-blue-800 rounded-lg p-2 shadow-sm text-center font-semibold"></div>
                        <div class="space-y-3 flex-grow flex flex-col">
                            <div class="bg-white rounded-lg shadow-sm border overflow-hidden">
                                <table class="table-fixed w-full text-left text-sm"><thead><tr class="bg-slate-50"><th class="p-2 font-semibold text-slate-600 w-2/5">Batting</th><th class="text-center p-2 font-semibold text-slate-600">R</th><th class="text-center p-2 font-semibold text-slate-600">B</th><th class="text-center p-2 font-semibold text-slate-600">4s</th><th class="text-center p-2 font-semibold text-slate-600">6s</th><th class="text-right p-2 font-semibold text-slate-600">SR</th></tr></thead><tbody id="batting-table"></tbody></table>
                            </div>
                            <div class="bg-white rounded-lg shadow-sm border overflow-hidden flex-grow">
                                <table class="table-fixed w-full text-left text-sm h-full"><thead><tr class="bg-slate-50"><th class="p-2 font-semibold text-slate-600 w-2/5">Bowling</th><th class="text-center p-2 font-semibold text-slate-600">O</th><th class="text-center p-2 font-semibold text-slate-600">M</th><th class="text-center p-2 font-semibold text-slate-600">R</th><th class="text-center p-2 font-semibold text-slate-600">W</th><th class="text-right p-2 font-semibold text-slate-600">Econ</th></tr></thead><tbody id="bowling-table"></tbody></table>
                            </div>
                        </div>
                    </div>
                    <div id="scoring-controls-container" class="lg:col-span-1 flex flex-col space-y-3">
                        <div id="live-commentary-box" class="bg-blue-50 rounded-lg p-3 shadow-sm border">
                            <div class="flex justify-between items-center cursor-pointer" id="toggle-commentary-btn">
                                <p class="text-xs font-semibold text-blue-800 uppercase tracking-wider">LIVE COMMENTARY</p>
                                <svg id="commentary-chevron" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-600 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                </svg>
                            </div>
                            <div id="live-commentary-content" class="hidden">
                                 <div id="live-commentary" class="text-sm text-gray-800 font-medium mt-2 pt-2 border-t border-blue-200"></div>
                            </div>
                        </div>
                        <footer id="scoring-controls" class="bg-white rounded-lg shadow-sm border relative flex-grow flex flex-col overflow-hidden">
                            <div id="bowler-prompt-overlay" class="absolute inset-0 bg-slate-100 bg-opacity-90 flex items-center justify-center hidden rounded-lg cursor-pointer z-10"><p class="font-bold text-blue-800 text-lg animate-pulse">Choose Next Bowler</p></div>
                            <div class="grid grid-cols-4 grid-rows-4 flex-grow scoring-grid">
                                <button onclick="addRuns(0)" class="bg-yellow-300 hover:bg-yellow-400 flex flex-col items-center justify-center"><span class="font-bold text-xl text-yellow-900">0</span><span class="text-xs text-yellow-800">Dot</span></button>
                                <button onclick="addRuns(1)" class="bg-sky-300 hover:bg-sky-400 flex flex-col items-center justify-center"><span class="font-bold text-xl text-sky-900">1</span><span class="text-xs text-sky-800">Single</span></button>
                                <button onclick="addRuns(2)" class="bg-slate-200 hover:bg-slate-300 flex flex-col items-center justify-center"><span class="font-bold text-xl text-slate-800">2</span><span class="text-xs text-slate-600">Double</span></button>
                                <button onclick="undo()" class="bg-orange-300 hover:bg-orange-400 flex flex-col items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg><span class="text-sm font-semibold mt-1">Undo</span></button>
                                <button onclick="addRuns(3)" class="bg-slate-200 hover:bg-slate-300 flex flex-col items-center justify-center"><span class="font-bold text-xl text-slate-800">3</span><span class="text-xs text-slate-600">Triple</span></button>
                                <button onclick="addRuns(4)" class="bg-blue-600 hover:bg-blue-700 flex flex-col items-center justify-center"><span class="font-bold text-xl text-white">4</span><span class="text-xs text-blue-100">Four</span></button>
                                <button onclick="addRuns(6)" class="bg-green-500 hover:bg-green-600 flex flex-col items-center justify-center"><span class="font-bold text-xl text-white">6</span><span class="text-xs text-green-100">Six</span></button>
                                <button onclick="openWicketModal()" class="bg-red-600 hover:bg-red-700 text-white font-bold text-lg">WICKET</button>
                                <button onclick="openModal('wide-modal')" class="col-span-2 bg-slate-100 hover:bg-slate-200 font-semibold text-slate-700">Wide</button>
                                <button onclick="openNoBallModal()" class="col-span-2 bg-slate-100 hover:bg-slate-200 font-semibold text-slate-700">NB</button>
                                <button onclick="openModal('byes-modal')" class="col-span-2 bg-slate-100 hover:bg-slate-200 font-semibold text-slate-700">Byes</button>
                                <button onclick="openModal('legbyes-modal')" class="col-span-2 bg-slate-100 hover:bg-slate-200 font-semibold text-slate-700">LB</button>
                            </div>
                        </footer>
                    </div>
                </div>
                <header class="bg-slate-200 text-black p-1 flex justify-between items-center shadow-inner w-full">
                    <button onclick="returnToDashboard(true)" class="text-sm font-semibold py-2 px-3 rounded-md text-red-600 hover:bg-red-100">End Match</button>
                    <button id="lock-btn" onclick="toggleScoringLock()" class="p-2 rounded-md hover:bg-slate-300"></button>
                </header>
            </div>
        </div>
    </div>

    <div id="alert-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-[60]"><div class="modal-content bg-white rounded-lg shadow-xl p-6 w-11/12 max-w-sm text-center"><p id="alert-message" class="mb-4"></p><button id="alert-ok-btn" class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">OK</button></div></div>
    <div id="confirm-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-[60]"><div class="modal-content bg-white rounded-lg shadow-xl p-6 w-11/12 max-w-sm text-center"><p id="confirm-message" class="mb-6"></p><div class="flex justify-center space-x-4"><button id="confirm-cancel-btn" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancel</button><button id="confirm-ok-btn" class="px-6 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Confirm</button></div></div></div>
    <div id="add-players-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50"><div class="modal-content bg-white rounded-lg shadow-xl w-11/12 max-w-md"><div class="p-4 bg-slate-50 border-b rounded-t-lg"><h3 id="add-players-modal-title" class="text-xl font-bold">Add Players</h3></div><div id="player-input-container" class="p-6 space-y-2 max-h-80 overflow-y-auto"></div><div class="p-4 bg-slate-50 border-t rounded-b-lg flex justify-end space-x-3"><button onclick="closeModal('add-players-modal')" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancel</button><button id="save-players-btn" class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Save</button></div></div></div>
    <div id="create-match-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50"><div class="modal-content bg-white rounded-lg shadow-xl w-11/12 max-w-md"><div class="p-4 bg-slate-50 border-b rounded-t-lg"><h3 class="text-xl font-bold">Create a New Match</h3></div><div class="p-6 space-y-4"><div><label class="block text-sm font-medium text-gray-700">Team A</label><select id="team-a-select" class="w-full p-3 border-gray-300 border rounded-md mt-1"></select></div><div><label class="block text-sm font-medium text-gray-700">Team B</label><select id="team-b-select" class="w-full p-3 border-gray-300 border rounded-md mt-1"></select></div></div><div class="p-4 bg-slate-50 border-t rounded-b-lg flex justify-end space-x-3"><button onclick="closeModal('create-match-modal')" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancel</button><button id="confirm-create-match-btn" class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Create</button></div></div></div>
    <div id="player-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50"><div class="modal-content bg-white rounded-lg shadow-xl p-6 w-11/12 max-w-sm"><h3 id="modal-title" class="text-lg font-bold mb-4">Select Player</h3><select id="player-select" class="w-full p-2 border rounded-md mb-4"></select><div class="flex justify-end"><button id="player-save-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Select</button></div></div></div>
    <div id="wicket-type-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50"><div class="modal-content bg-white rounded-lg shadow-xl p-6 w-11/12 max-w-sm"><h3 class="text-lg font-bold text-center mb-4 text-red-600">How Out?</h3><div class="grid grid-cols-2 gap-3"><button onclick="handleWicket('Catch')" class="p-3 bg-gray-100 rounded-lg hover:bg-gray-200">Catch</button><button onclick="handleWicket('Bowled')" class="p-3 bg-gray-100 rounded-lg hover:bg-gray-200">Bowled</button><button onclick="handleWicket('Stumped')" class="p-3 bg-gray-100 rounded-lg hover:bg-gray-200">Stumped</button><button onclick="handleWicket('Run Out')" class="p-3 bg-gray-100 rounded-lg hover:bg-gray-200">Run Out</button></div></div></div>
    <div id="run-out-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50"><div class="modal-content bg-white rounded-lg shadow-xl p-6 w-11/12 max-w-sm"><h3 class="text-lg font-bold text-center mb-4">Who was Run Out?</h3><div id="run-out-options" class="grid grid-cols-1 gap-3"></div></div></div>
    <div id="run-out-extra-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50"><div class="modal-content bg-white rounded-lg shadow-xl p-6 w-11/12 max-w-sm"><h3 class="text-lg font-bold text-center mb-4">Run Out!</h3><p class="text-sm text-gray-600 text-center mb-4">Who was out and how many runs were taken?</p><div class="flex flex-col gap-4"><div><label class="block text-sm font-medium text-gray-700">Player Out</label><select id="run-out-player-select" class="w-full p-2 border rounded-md"></select></div><div><label class="block text-sm font-medium text-gray-700">Runs taken</label><input type="number" id="run-out-runs-input" class="w-full p-2 border rounded-md" value="0" min="0"></div><button onclick="finalizeRunOutExtra()" class="w-full px-4 py-2 bg-red-600 text-white font-semibold rounded-md hover:bg-red-700">Confirm Run Out</button></div></div></div>
    <div id="wide-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex justify-center items-end hidden z-50" onclick="closeModal('wide-modal')"><div class="modal-content bg-white rounded-t-2xl shadow-xl w-full max-w-md p-6" onclick="event.stopPropagation()"><div class="flex justify-end"><button onclick="closeModal('wide-modal')" class="text-gray-400 hover:text-gray-600">&times;</button></div><h3 class="text-lg font-bold text-center mb-6">Wide (+1 run) & Extras</h3><div class="grid grid-cols-4 gap-3"><button onclick="addExtra('wd', 0)" class="p-3 bg-gray-100 rounded-lg">WD</button><button onclick="addExtra('wd', 1)" class="p-3 bg-gray-100 rounded-lg">WD+1</button><button onclick="addExtra('wd', 2)" class="p-3 bg-gray-100 rounded-lg">WD+2</button><button onclick="addExtra('wd', 4)" class="p-3 bg-gray-100 rounded-lg">WD+4</button></div><div class="mt-4 text-center"><button onclick="openRunOutExtraModal('wd', 'Wide + Run Out')" class="px-4 py-2 bg-red-100 text-red-700 rounded-md font-semibold hover:bg-red-200">Run Out</button></div></div></div>
    <div id="no-ball-sub-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50"><div class="modal-content bg-white rounded-t-2xl shadow-xl w-full max-w-md p-6" onclick="event.stopPropagation()"><div class="flex justify-end"><button onclick="closeModal('no-ball-sub-modal')" class="text-gray-400 hover:text-gray-600">&times;</button></div><h3 class="text-lg font-bold text-center mb-6">No Ball Type</h3><div class="space-y-4"><div class="grid grid-cols-2 gap-3"><button onclick="handleNoBall('overstep')" class="p-3 bg-gray-100 rounded-lg hover:bg-gray-200">Overstep</button><button onclick="handleNoBall('high_full_toss')" class="p-3 bg-gray-100 rounded-lg hover:bg-gray-200">High Full Toss</button></div><div id="noball-runs-container" class="space-y-2 hidden"><p class="text-sm font-semibold text-gray-700">Runs off the bat:</p><div class="grid grid-cols-4 gap-2"><button onclick="addExtra('nb', 0)" class="p-3 bg-gray-100 rounded-lg">0</button><button onclick="addExtra('nb', 1)" class="p-3 bg-gray-100 rounded-lg">1</button><button onclick="addExtra('nb', 2)" class="p-3 bg-gray-100 rounded-lg">2</button><button onclick="addExtra('nb', 3)" class="p-3 bg-gray-100 rounded-lg">3</button><button onclick="addExtra('nb', 4)" class="p-3 bg-gray-100 rounded-lg">4</button><button onclick="addExtra('nb', 5)" class="p-3 bg-gray-100 rounded-lg">5</button><button onclick="addExtra('nb', 6)" class="p-3 bg-gray-100 rounded-lg">6</button></div></div></div></div></div>
    <div id="byes-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex justify-center items-end hidden z-50" onclick="closeModal('byes-modal')"><div class="modal-content bg-white rounded-t-2xl shadow-xl w-full max-w-md p-6" onclick="event.stopPropagation()"><div class="flex justify-end"><button onclick="closeModal('byes-modal')" class="text-gray-400 hover:text-gray-600">&times;</button></div><h3 class="text-lg font-bold text-center mb-6">Byes</h3><div class="grid grid-cols-4 gap-3"><button onclick="addExtra('b', 1)" class="p-3 bg-gray-100 rounded-lg">1 Bye</button><button onclick="addExtra('b', 2)" class="p-3 bg-gray-100 rounded-lg">2 Byes</button><button onclick="addExtra('b', 3)" class="p-3 bg-gray-100 rounded-lg">3 Byes</button><button onclick="addExtra('b', 4)" class="p-3 bg-gray-100 rounded-lg">4 Byes</button></div></div></div>
    <div id="legbyes-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex justify-center items-end hidden z-50" onclick="closeModal('legbyes-modal')"><div class="modal-content bg-white rounded-t-2xl shadow-xl w-full max-w-md p-6" onclick="event.stopPropagation()"><div class="flex justify-end"><button onclick="closeModal('legbyes-modal')" class="text-gray-400 hover:text-gray-600">&times;</button></div><h3 class="text-lg font-bold text-center mb-6">Leg Byes</h3><div class="grid grid-cols-4 gap-3"><button onclick="addExtra('lb', 1)" class="p-3 bg-gray-100 rounded-lg">1 LB</button><button onclick="addExtra('lb', 2)" class="p-3 bg-gray-100 rounded-lg">2 LBs</button><button onclick="addExtra('lb', 3)" class="p-3 bg-gray-100 rounded-lg">3 LBs</button><button onclick="addExtra('lb', 4)" class="p-3 bg-gray-100 rounded-lg">4 LBs</button></div></div></div>
    <div id="gemini-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-[70]"><div class="modal-content bg-white rounded-lg shadow-xl p-6 w-11/12 max-w-md"><h3 id="gemini-modal-title" class="text-xl font-bold mb-4">✨ AI Suggestions</h3><div id="gemini-modal-content"></div><div class="mt-6 text-right"><button onclick="closeModal('gemini-modal')" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Close</button></div></div></div>
    <div id="squad-selection-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl w-11/12 max-w-lg">
            <div class="p-4 bg-slate-50 border-b rounded-t-lg flex justify-between items-center">
                <h3 id="squad-selection-modal-title" class="text-xl font-bold">Select Squad</h3>
                <p id="squad-selection-counter" class="text-sm font-semibold text-gray-600 bg-gray-200 px-3 py-1 rounded-full"></p>
            </div>
            <div id="squad-player-list-container" class="p-6 grid grid-cols-2 md:grid-cols-3 gap-4 max-h-80 overflow-y-auto">
                </div>
            <div class="p-4 bg-slate-50 border-t rounded-b-lg flex justify-end space-x-3">
                <button id="squad-selection-cancel-btn" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancel</button>
                <button id="squad-selection-confirm-btn" class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed" disabled>Confirm</button>
            </div>
        </div>
    </div>
    <div id="full-screen-message-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center hidden z-[70] p-4">
        <div id="full-screen-message-content" class="modal-content-container w-full max-w-2xl">
            </div>
    </div>

     <div id="innings-break-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center hidden z-[70] p-4">
        <div id="innings-break-content" class="modal-content bg-slate-800 text-white rounded-2xl shadow-xl w-full max-w-lg overflow-hidden scale-95 opacity-0">
            <div id="innings-break-header" class="p-6 text-center border-b border-slate-700">
                <h2 class="text-3xl font-extrabold tracking-tight">END OF INNINGS</h2>
            </div>
            <div class="p-6 space-y-6">
                <div id="innings-break-score-summary" class="text-center">
                    </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="font-bold text-lg text-amber-400 mb-2">TOP BATTERS</h3>
                        <div id="innings-break-top-batters" class="space-y-2 text-sm">
                            </div>
                    </div>
                    <div>
                        <h3 class="font-bold text-lg text-cyan-400 mb-2">TOP BOWLERS</h3>
                        <div id="innings-break-top-bowlers" class="space-y-2 text-sm">
                            </div>
                    </div>
                </div>
                <div id="innings-break-target" class="text-center bg-slate-900 p-4 rounded-lg">
                     </div>
            </div>
            <div class="p-6 bg-slate-900/50">
                <button id="start-second-innings-btn" class="w-full px-6 py-4 text-white font-bold rounded-lg text-lg setup-btn">Start Second Innings</button>
            </div>
        </div>
    </div>
<div id="leaderboard-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center hidden z-[70] p-4">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-4xl h-[90vh] flex flex-col">
            <div class="p-4 bg-slate-50 border-b rounded-t-lg flex justify-between items-center">
                <h3 id="leaderboard-modal-title" class="text-xl font-bold">Full Report</h3>
                <button onclick="closeModal('leaderboard-modal')" class="text-gray-500 hover:text-gray-800 font-bold">&times;</button>
            </div>
            <div class="p-4 flex flex-wrap gap-4 border-b">
                <input type="text" id="leaderboard-search" placeholder="Search players..." class="p-2 border rounded-md flex-grow">
                <select id="leaderboard-team-filter" class="p-2 border rounded-md"></select>
                <button id="leaderboard-export-csv" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-md hover:bg-green-700">Export CSV</button>
            </div>
            <div class="flex-grow overflow-auto">
                <table class="w-full text-sm text-left">
                    <thead id="leaderboard-modal-header" class="sticky top-0 bg-slate-100"></thead>
                    <tbody id="leaderboard-modal-body"></tbody>
                </table>
            </div>
        </div>
    </div>
    <script>
        // --- GLOBAL STATE & SETUP ---
        let currentTournamentState = {};
        let teamDataStore = {};
        let liveMatchState = {};
        let tossWinnerKey = null;
        let tossDecision = null;
        let matchHistory = [];
        let savedTeams = {};
        let alertCallback = null;
        let confirmCallback = null;
        let pendingRunOutDetails = null;
        let tournamentStatsCache = null;

        const darkColors = [
            '#0f172a', // slate-900
            '#4c0519', // rose-950
            '#4a044e', // fuchsia-950
            '#2e1065', // violet-950
            '#1e3a8a', // blue-900
            '#14532d', // green-900
            '#451a03', // amber-950
            '#422006'  // orange-950
        ];

        const commentaryTemplates = {
            '0': [
                "No run, a watchful defense from {batsman}.",
                "Good length from {bowler}, {batsman} is happy to leave that one alone.",
                "A dot ball to start the over. Excellent line from {bowler}.",
                "{batsman} plays it straight to the fielder, no run.",
                "Well bowled, {bowler} gives the batsman no room to score.",
                "Solid defensive shot from {batsman}.",
                "Pitched up, and {batsman} drives it firmly, but straight to cover.",
                "A swing and a miss! {batsman} was looking for a big shot there.",
                "Through to the keeper, no run.",
                "{bowler} keeping the pressure on with another dot.",
                "A textbook forward defense from {batsman}.",
                "Beaten! That one jagged back and just missed the off-stump.",
                "{batsman} unable to get it past the infield.",
                "Another dot. The pressure is building.",
                "Sharp fielding at point prevents any run."
            ],
            '1': [
                "Quick single taken to point.",
                "Just a gentle push into the covers and they'll come back for one.",
                "{batsman} gets off the mark with a single.",
                "Nudged away to fine leg for a single.",
                "They scamper through for a quick single, good running.",
                "Tucked off the pads, easy single for {batsman}.",
                "Rotates the strike with a push to long-on.",
                "Dabbed down to third man for a single.",
                "Easy as you like, just a single to keep the scoreboard ticking.",
                "Works it into the gap on the on-side for one.",
                "Good cricket all around, a single to the sweeper.",
                "He's off the mark, turning that one to square leg.",
                "A comfortable single brings the other batsman on strike.",
                "Finds the gap and they'll get a single.",
                "{batsman} is happy to rotate the strike."
            ],
            '2': [
                "Good placement, into the gap for a couple of runs.",
                "Excellent running between the wickets, they'll come back for a second.",
                "Driven through the covers, and they'll pick up two.",
                "Cut away behind point, and that's two more to the total.",
                "Clipped off the toes, and they run hard for the second.",
                "Finds the gap in the outfield, two runs.",
                "Well-judged second run there.",
                "Pulled away to deep mid-wicket for a brace.",
                "Punched down the ground, past the bowler, for two runs.",
                "A little bit of width and {batsman} helps it on its way for two.",
                "Great effort in the deep saves a boundary, they get two.",
                "That's a confident shot for two.",
                "They convert the one into two, fantastic running.",
                "Gets it over the infield and they'll come back for the second.",
                "A flick of the wrists and that's two more."
            ],
            '4': [
                "FOUR! Exquisite timing on that cover drive.",
                "CRUNCHED! {batsman} smashes that through point for a boundary.",
                "Beautifully played, guided down to the third man fence for FOUR.",
                "That's a glorious shot! Races away to the boundary.",
                "FOUR! Poor delivery from {bowler} and it gets the treatment it deserves.",
                "Elegant stroke-play from {batsman}, that's a boundary.",
                "Finds the gap perfectly! That's four runs.",
                "FOUR! A powerful pull shot from {batsman}.",
                "Up and over the infield, one bounce and into the rope for FOUR.",
                "A delicate late cut, and that will be four.",
                "FOUR! He's picked the bones out of that one!",
                "Pierces the field with surgical precision. FOUR!",
                "No stopping that one! A classic boundary for {batsman}.",
                "What a shot! That's four from the moment it left the bat.",
                "{bowler} misses the mark and {batsman} cashes in with a boundary."
            ],
            '6': [
                "SIX! That is out of the park! A monstrous hit from {batsman}!",
                "CLEARED THE ROPES! A magnificent strike for SIX!",
                "That's gone the distance! A huge maximum!",
                "Into the stands! {batsman} sends it sailing for SIX!",
                "SIX! Right out of the middle of the bat!",
                "A colossal blow! That's a massive six!",
                "He's launched it! That's six more to the total.",
                "High and handsome! A beautiful shot for SIX.",
                "That is a spectator's catch! All the way for SIX!",
                "Dispatched with disdain! {batsman} hits a mighty SIX!",
                "{bowler} can only watch as that sails over the boundary for six.",
                "Maximum! A display of pure power from {batsman}.",
                "That's disappeared into the crowd! SIX!",
                "He got all of that! Absolutely smashes it for six.",
                "It's a bird, it's a plane... no, it's a cricket ball, flying for SIX!"
            ],
            'wd': [
                "Wide ball. An extra run for the batting side.",
                "{bowler} strays down the leg side, that'll be a wide.",
                "The umpire signals a wide. {bowler} will have to reload.",
                "Too far outside the off stump, a clear wide.",
                "Just a little wayward from {bowler}, and that's a wide."
            ],
            'nb': [
                "No-ball! {bowler} has overstepped. And it's a free hit to follow!",
                "That's a no-ball for height. The next delivery will be a free hit.",
                "The umpire calls a no-ball. A costly error from the bowler.",
                "Overstepping from {bowler}, and the batting side gets a free hit.",
                "No-ball called. A bonus run and an extra delivery."
            ],
            'wicket': {
                'Bowled': [
                    "BOWLED HIM! A peach of a delivery from {bowler} castles the stumps!",
                    "Cleaned him up! Right through the gate, {batsman} is out!",
                    "A perfect yorker! That's the end of {batsman}.",
                    "Played all around it! The stumps are in a mess. Bowled!",
                    "Gone! {bowler} hits the timber. A huge wicket."
                ],
                'Catch': [
                    "CAUGHT! A sharp chance taken in the slips!",
                    "In the air... and taken! A brilliant catch in the outfield.",
                    "Gone! {batsman} skies it and the fielder makes no mistake.",
                    "A top edge, and the keeper takes a simple catch. {batsman} has to go.",
                    "Edged and taken! {bowler} has his man."
                ],
                'Run Out': [
                    "RUN OUT! A disaster for the batting side. A direct hit!",
                    "Is he short? Yes, he is! Brilliant piece of fielding results in a run out.",
                    "A mix-up in the middle and {batsman} is well short of his ground. Run out!",
                    "Gone! They went for a run that was never there. Run out.",
                    "A bullet throw from the deep and that's a run out."
                ]
            }
        };

        function generateCommentary(event, details = {}) {
            const { batsmanName = '', bowlerName = '', runs, dismissalType } = details;
            let templates = [];

            if (event === 'wicket' && dismissalType) {
                templates = commentaryTemplates.wicket[dismissalType] || [`{batsman} is out, dismissed ${dismissalType}.`];
            } else if (commentaryTemplates[event]) {
                templates = commentaryTemplates[event];
            } else {
                return ''; // No template found
            }
            
            const randomTemplate = templates[Math.floor(Math.random() * templates.length)];

            return randomTemplate
                .replace(/{batsman}/g, batsmanName)
                .replace(/{bowler}/g, bowlerName)
                .replace(/{runs}/g, runs);
        }

        // --- AVATAR HELPER FUNCTIONS ---
        function getDeterministicColor(name) {
            if (!name) return `hsl(220, 10%, 80%)`;
            let hash = 0;
            for (let i = 0; i < name.length; i++) {
                hash = name.charCodeAt(i) + ((hash << 5) - hash);
            }
            const h = hash % 360;
            return `hsl(${h}, 50%, 65%)`;
        }

        function getInitials(name) {
            if (!name || typeof name !== 'string') return null;
            const parts = name.split(' ').filter(p => p);
            if (parts.length === 0) return null;
            if (parts.length === 1) return parts[0].charAt(0).toUpperCase();
            return (parts[0].charAt(0) + parts[parts.length - 1].charAt(0)).toUpperCase();
        }

        function getPlayerAvatar(player, size = 'md') {
            const sizeClass = `avatar-${size}`;
            const playerName = player.name || 'Unknown Player';
            const initials = getInitials(playerName);
            const bgColor = getDeterministicColor(playerName);
            
            const silhouetteSVG = `<svg class="w-full h-full text-white" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>`;
            
            const fallbackHTML = initials
                ? `<div class="player-avatar ${sizeClass}" style="background-color: ${bgColor};">${initials}</div>`
                : `<div class="player-avatar ${sizeClass}" style="background-color: ${bgColor};">${silhouetteSVG}</div>`;
            
            if (player.photoUrl) {
                return `<img class="player-avatar ${sizeClass}" src="${player.photoUrl}" alt="${playerName} avatar" loading="lazy" decoding="async" onerror="this.outerHTML = \`${fallbackHTML}\`">`;
            }
            
            return fallbackHTML;
        }

        // --- TEAM & DATA MANAGEMENT ---
        function loadSavedTeams() {
            try {
                const teamsJSON = localStorage.getItem('savedTeams');
                if (teamsJSON) {
                    let parsedData = JSON.parse(teamsJSON);
                    // Check if data from localStorage is an array and convert it to an object keyed by team name.
                    if (Array.isArray(parsedData)) {
                        savedTeams = parsedData.reduce((acc, team) => {
                            // Ensure team object and team name exist to prevent errors
                            if (team && team.name) {
                                acc[team.name] = team;
                            }
                            return acc;
                        }, {});
                    } else {
                        // Assume it's already the correct object format
                        savedTeams = parsedData;
                    }
                } else {
                    savedTeams = {};
                }
            } catch (e) { 
                console.error("Could not load saved teams.", e); 
                savedTeams = {}; 
            }
        }

        function importTeam(dropdownElement) {
            const teamName = dropdownElement.value;
            const teamIndex = dropdownElement.dataset.teamIndex;
            if (!teamName || !savedTeams[teamName]) return;

            const teamData = savedTeams[teamName];
            const teamRow = dropdownElement.closest('.grid');

            // Populate name and color immediately
            teamRow.querySelector('.team-name-input').value = teamData.name;
            teamRow.querySelector('.team-color-input').value = teamData.color;
            teamDataStore[teamIndex].name = teamData.name;
            teamDataStore[teamIndex].color = teamData.color;
            teamDataStore[teamIndex].logoUrl = teamData.logoUrl;
            updateTeamLogoPreview(teamIndex);

            // Check if squad selection is needed
            const playersPerSide = parseInt(document.getElementById('tournament-players').value);
            if (!playersPerSide) {
                showAlert("Please select 'Max Players per Side' on the 'Details' tab first.");
                dropdownElement.value = '';
                return;
            }
            const requiredPlayers = playersPerSide + 1; // 1 impact player
            const savedPlayers = teamData.players.map(p => p.name).filter(n => n);

            if (savedPlayers.length > requiredPlayers) {
                openSquadSelectionModal(teamData, teamIndex, requiredPlayers, dropdownElement);
            } else {
                teamDataStore[teamIndex].players = savedPlayers;
                showAlert(`Imported ${teamData.name} and its ${savedPlayers.length} players!`);
                updatePlayerButtonStatus(teamIndex);
            }
        }

        // --- UI & MODALS ---
        function openModal(modalId) { 
            document.getElementById(modalId)?.classList.remove('hidden');
            document.body.classList.add('modal-open');
        }
        function closeModal(modalId) { 
            document.getElementById(modalId)?.classList.add('hidden');
            if (document.querySelectorAll('.modal-overlay:not(.hidden)').length === 0) {
                document.body.classList.remove('modal-open');
            }
        }
        function showAlert(message, onOk) {
            document.getElementById('alert-message').textContent = message;
            alertCallback = onOk;
            openModal('alert-modal');
        }
        function showConfirm(message, onConfirm) {
            document.getElementById('confirm-message').textContent = message;
            confirmCallback = onConfirm;
            openModal('confirm-modal');
        }
        function triggerEventAnimation(text, colorClass) {
            const overlay = document.getElementById('event-animation-overlay');
            const textEl = document.getElementById('event-animation-text');
            textEl.textContent = text;
            textEl.className = `text-8xl font-black uppercase ${colorClass}`;
            overlay.classList.remove('hidden');
            textEl.classList.add('event-text-animation');
            setTimeout(() => {
                overlay.classList.add('hidden');
                textEl.classList.remove('event-text-animation');
            }, 1500);
        }
        
        function showInningsBreakModal(battingTeam, bowlingTeam, target) {
            // Set header gradient based on team colors
            const header = document.getElementById('innings-break-header');
            header.style.background = `linear-gradient(135deg, ${bowlingTeam.color}, ${battingTeam.color})`;
            
            // Populate score summary
            const scoreSummaryEl = document.getElementById('innings-break-score-summary');
            const overs = Math.floor(battingTeam.balls / liveMatchState.ballsPerOver);
            const ballsThisOver = battingTeam.balls % liveMatchState.ballsPerOver;
            scoreSummaryEl.innerHTML = `
                <p class="text-xl font-semibold">${battingTeam.name}</p>
                <p class="text-5xl font-bold my-1">${battingTeam.score} / ${battingTeam.wickets}</p>
                <p class="text-slate-400">(${overs}.${ballsThisOver} Overs)</p>
            `;

            // Get player stats from the innings summary
            const firstInningsSummary = liveMatchState.inningsSummary[0];
            const battingStats = Object.values(firstInningsSummary.playerStats).filter(p => p.balls > 0 || p.isOut);
            const bowlingStats = Object.values(firstInningsSummary.bowlingStats).filter(p => p.ballsBowled > 0);

            // Sort and get top 3 batters
            const topBatters = battingStats.sort((a, b) => b.runs - a.runs).slice(0, 3);
            const topBattersEl = document.getElementById('innings-break-top-batters');
            topBattersEl.innerHTML = topBatters.map(p => `
                <div class="flex justify-between items-center bg-slate-700/50 p-2 rounded">
                    <span class="font-medium">${p.name}</span>
                    <span class="font-bold">${p.runs} <span class="text-xs font-normal text-slate-400">(${p.balls})</span></span>
                </div>
            `).join('');
            if (topBatters.length === 0) topBattersEl.innerHTML = `<p class="text-slate-400">No batters faced a ball.</p>`;

            // Sort and get top 3 bowlers
            const topBowlers = bowlingStats.sort((a, b) => b.wickets - a.wickets || a.runsConceded - b.runsConceded).slice(0, 3);
            const topBowlersEl = document.getElementById('innings-break-top-bowlers');
            const ballsPerOver = liveMatchState.ballsPerOver;
            topBowlersEl.innerHTML = topBowlers.map(p => {
                 const overs = `${Math.floor(p.ballsBowled / ballsPerOver)}.${p.ballsBowled % ballsPerOver}`;
                 return `
                    <div class="flex justify-between items-center bg-slate-700/50 p-2 rounded">
                        <span class="font-medium">${p.name}</span>
                        <span class="font-bold">${p.wickets}/${p.runsConceded} <span class="text-xs font-normal text-slate-400">(${overs})</span></span>
                    </div>
                `}).join('');
             if (topBowlers.length === 0) topBowlersEl.innerHTML = `<p class="text-slate-400">No bowlers bowled an over.</p>`;

            // Populate target
            const targetEl = document.getElementById('innings-break-target');
            targetEl.innerHTML = `
                <p class="text-slate-300 uppercase text-sm tracking-wider">Target for ${bowlingTeam.name}</p>
                <p class="text-4xl font-extrabold text-white">${target}</p>
            `;

            // Set up button
            const startBtn = document.getElementById('start-second-innings-btn');
            startBtn.onclick = () => {
                const modal = document.getElementById('innings-break-modal');
                modal.querySelector('.modal-content').style.animation = 'none'; // Prevent re-animation on close
                modal.classList.remove('active');
                closeModal('innings-break-modal');
                startSecondInnings();
            };
            
            // Show modal with animation
            const modal = document.getElementById('innings-break-modal');
            modal.querySelector('.modal-content').style.animation = ''; // Reset any inline style
            openModal('innings-break-modal');
            setTimeout(() => modal.classList.add('active'), 10); // Timeout to allow CSS to apply
        }

        function openSquadSelectionModal(teamData, teamIndex, requiredPlayers, dropdownElement) {
            const modal = document.getElementById('squad-selection-modal');
            const titleEl = document.getElementById('squad-selection-modal-title');
            const counterEl = document.getElementById('squad-selection-counter');
            const playerListContainer = document.getElementById('squad-player-list-container');
            const confirmBtn = document.getElementById('squad-selection-confirm-btn');
            const cancelBtn = document.getElementById('squad-selection-cancel-btn');

            const fullRoster = teamData.players.map(p => p.name).filter(n => n);
            titleEl.textContent = `Select Squad for ${teamData.name}`;
            playerListContainer.innerHTML = fullRoster.map(playerName => `
                <label class="flex items-center space-x-2 p-2 rounded-md hover:bg-gray-100 cursor-pointer">
                    <input type="checkbox" value="${playerName}" class="form-checkbox h-5 w-5 text-blue-600 squad-player-checkbox">
                    <span class="text-gray-700">${playerName}</span>
                </label>
            `).join('');

            function updateSelectionState() {
                const selectedCount = playerListContainer.querySelectorAll('.squad-player-checkbox:checked').length;
                counterEl.textContent = `${selectedCount} / ${requiredPlayers} selected`;
                confirmBtn.disabled = selectedCount !== requiredPlayers;
            }

            updateSelectionState();

            playerListContainer.querySelectorAll('.squad-player-checkbox').forEach(cb => {
                cb.addEventListener('change', updateSelectionState);
            });

            confirmBtn.onclick = () => {
                const selectedPlayers = Array.from(playerListContainer.querySelectorAll('.squad-player-checkbox:checked')).map(cb => cb.value);
                teamDataStore[teamIndex].players = selectedPlayers;
                showAlert(`Selected a squad of ${selectedPlayers.length} for ${teamData.name}.`);
                updatePlayerButtonStatus(teamIndex);
                closeModal('squad-selection-modal');
            };

            cancelBtn.onclick = () => {
                const teamRow = dropdownElement.closest('.grid');
                dropdownElement.value = '';
                teamRow.querySelector('.team-name-input').value = '';
                teamDataStore[teamIndex].name = '';
                teamDataStore[teamIndex].color = darkColors[teamIndex % darkColors.length]; // Reset color
                teamDataStore[teamIndex].logoUrl = null;
                teamDataStore[teamIndex].players = [];
                updatePlayerButtonStatus(teamIndex);
                updateTeamLogoPreview(teamIndex);
                closeModal('squad-selection-modal');
            };

            openModal('squad-selection-modal');
        }

        // --- TOURNAMENT SETUP FLOW ---
        function showSetupScreen() {
            document.getElementById('tournament-choice-screen').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            localStorage.setItem('cricker_current_view', 'tournament-setup');
        }

        function goToStep(step) {
    const currentStep = document.querySelector('.setup-step.active');
    const nextStep = document.getElementById(`setup-step-${step}`);
    
    // Validation for current step before proceeding
    if (step > 1) {
        const requiredLabels = currentStep.querySelectorAll('.required-field');
        for (const label of requiredLabels) {
            const input = document.getElementById(label.htmlFor);
            if (input) {
                // An element is visible if its offsetParent is not null. This reliably
                // checks for elements hidden with 'display: none'.
                const isVisible = input.offsetParent !== null;

                if (isVisible && !input.value) {
                    showAlert('Please fill out all required fields.');
                    return;
                }
            }
        }
    }

    if (step === 2) {
        generateTeamInputs();
    }

    if (step === 3) {
         if (Object.values(teamDataStore).length < 2 || Object.values(teamDataStore).some(team => !team.name)) {
             showAlert('Please enter names for all teams before proceeding.');
             return;
         }
         showGroupAssignment();
    }

    document.querySelectorAll('.setup-step').forEach(el => {
        el.classList.remove('active');
        el.classList.add('hidden');
    });
    nextStep.classList.remove('hidden');
    nextStep.classList.add('active');
    document.getElementById('progress-bar').style.width = `${step * 25}%`;
}
        
        function toggleFreeHitRules() {
            const isEnabled = document.getElementById('free-hit-enabled').value === 'yes';
            document.getElementById('free-hit-rules-container').classList.toggle('hidden', !isEnabled);
        }

        function generateTeamInputs() {
            const numTeams = parseInt(document.getElementById('tournament-teams').value) || 0;
            const container = document.getElementById('team-entry-container');
            container.innerHTML = '';
            teamDataStore = {};
            if (numTeams <= 0) return;
            let savedTeamOptions = '<option value="">Import Saved Team...</option>';
            for (const teamName in savedTeams) {
                savedTeamOptions += `<option value="${teamName}">${teamName}</option>`;
            }
            for (let i = 0; i < numTeams; i++) {
                const randomDarkColor = darkColors[i % darkColors.length];
                teamDataStore[i] = { id: `T${Date.now() + i}`, name: '', color: randomDarkColor, players: [] };
                const teamRow = document.createElement('div');
                teamRow.className = 'grid grid-cols-1 sm:grid-cols-8 gap-3 items-center p-2 border rounded-lg';
                const isPlayersAdded = teamDataStore[i].players.length >= (parseInt(document.getElementById('tournament-players').value) - 1);
                const playersButtonClass = isPlayersAdded ? 'players-button completed' : '';
                const playersButtonText = isPlayersAdded ? 'Players Added' : 'Players';

                teamRow.innerHTML = `
                    <div class="sm:col-span-2"><select onchange="importTeam(this)" class="w-full p-2 border-gray-300 border rounded-md" data-team-index="${i}">${savedTeamOptions}</select></div>
                    <div class="flex justify-center items-center team-logo-preview-container cursor-pointer" onclick="triggerLogoUpload(${i})" title="Click to upload a logo" data-team-index="${i}">
                        <div class="team-logo-compact" style="background-color: ${randomDarkColor};">?</div>
                    </div>
                    <input type="file" id="logo-uploader-${i}" class="hidden" accept="image/*" onchange="handleLogoFileSelect(event, ${i})">
                    <div class="sm:col-span-2"><input type="text" placeholder="Team ${i + 1}" class="w-full p-2 border-gray-300 border rounded-md team-name-input" data-team-index="${i}"></div>
                    <input type="color" value="${teamDataStore[i].color}" class="w-full h-10 border-gray-300 border rounded-md team-color-input" data-team-index="${i}">
                    <button onclick="openAddPlayersModal(${i})" class="w-full p-2 text-sm bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 sm:col-span-2 font-bold transition-all duration-200 hover:scale-105 players-button ${playersButtonClass}">${playersButtonText}</button>
                `;
                container.appendChild(teamRow);
            }
            addTeamInputListeners();
        }

        function triggerLogoUpload(teamIndex) {
            document.getElementById(`logo-uploader-${teamIndex}`).click();
        }

        function handleLogoFileSelect(event, teamIndex) {
            const file = event.target.files[0];
            if (!file) { return; }
            if (!file.type.startsWith('image/')){
                showAlert('Please select a valid image file.');
                return;
            }
            const reader = new FileReader();
            reader.onloadend = function() {
                const dataUrl = reader.result;
                teamDataStore[teamIndex].logoUrl = dataUrl;
                updateTeamLogoPreview(teamIndex);
            }
            reader.readAsDataURL(file);
        }

        function updateTeamLogoPreview(teamIndex) {
            const teamData = teamDataStore[teamIndex];
            const logoPreviewContainer = document.querySelector(`.team-logo-preview-container[data-team-index='${teamIndex}']`);
            if (logoPreviewContainer) {
                // If a logo URL is provided, use it. Otherwise, fall back to initials.
                if (teamData.logoUrl) {
                    logoPreviewContainer.innerHTML = `<img src="${teamData.logoUrl}" alt="Team Logo" class="team-logo-compact object-cover rounded-full">`;
                } else {
                    const teamName = teamData.name || '';
                    const teamColor = teamData.color || '#cbd5e1';
                    logoPreviewContainer.innerHTML = `<div class="team-logo-compact" style="background-color: ${teamColor};">${teamName ? teamName.charAt(0).toUpperCase() : '?'}</div>`;
                }
            }
        }

        function addTeamInputListeners() {
            document.querySelectorAll('.team-name-input').forEach(input => input.onkeyup = (e) => {
                const teamIndex = e.target.dataset.teamIndex;
                teamDataStore[teamIndex].name = e.target.value;
                updateTeamLogoPreview(teamIndex);
            });
            document.querySelectorAll('.team-color-input').forEach(input => input.onchange = (e) => {
                const teamIndex = e.target.dataset.teamIndex;
                teamDataStore[teamIndex].color = e.target.value;
                updateTeamLogoPreview(teamIndex);
            });
        }
        
        function updatePlayerButtonStatus(teamIndex) {
            const playersPerSide = parseInt(document.getElementById('tournament-players').value);
            const requiredSquadSize = playersPerSide + 1;
            const playerList = teamDataStore[teamIndex].players || [];
            const teamRows = document.getElementById('team-entry-container').children;
            if (teamRows[teamIndex]) {
                const playerButton = teamRows[teamIndex].querySelector('.players-button');
                if (playerList.length >= requiredSquadSize) {
                    playerButton.classList.add('completed');
                    playerButton.textContent = 'Players Added';
                } else {
                    playerButton.classList.remove('completed');
                    playerButton.textContent = 'Players';
                }
            }
        }

        function openAddPlayersModal(teamIndex) {
            const playersPerSide = parseInt(document.getElementById('tournament-players').value);
            if (!playersPerSide) { showAlert("Please select 'Max Players per Side' on the 'Details' tab first."); return; }
            const teamData = teamDataStore[teamIndex];
            document.getElementById('add-players-modal-title').textContent = `Add Players for ${teamData.name || `Team ${teamIndex + 1}`}`;
            const container = document.getElementById('player-input-container');
            container.innerHTML = Array.from({ length: playersPerSide + 1 }, (_, i) => `<input type="text" placeholder="Player ${i + 1}${i === playersPerSide ? ' (Impact)' : ''}" value="${teamData.players[i] || ''}" class="w-full p-2 border-gray-300 border rounded-md">`).join('');
            document.getElementById('save-players-btn').onclick = () => savePlayers(teamIndex);
            openModal('add-players-modal');
        }

        function savePlayers(teamIndex) {
            const playerInputs = document.querySelectorAll('#player-input-container input');
            const playerList = Array.from(playerInputs).map(input => input.value.trim()).filter(p => p);
            
            teamDataStore[teamIndex].players = playerList;
            closeModal('add-players-modal');
            updatePlayerButtonStatus(teamIndex);
            showAlert(`Player list saved for ${teamDataStore[teamIndex].name || `Team ${teamIndex + 1}`}.`);
        }

        function showGroupAssignment() {
            const format = document.getElementById('tournament-format').value;
            const teams = Object.values(teamDataStore);
            const groupsContainer = document.getElementById('group-selection-container');
            const assignContainer = document.getElementById('group-assignment-container');
            const knockoutTeamsPerGroupContainer = document.getElementById('knockout-teams-per-group-container');
            const requiresGroupStage = ['round-robin', 'double_round_robin', 'group_knockout', 'playoffs', 'super_stage'].includes(format);
            
            knockoutTeamsPerGroupContainer.classList.add('hidden');

            if (requiresGroupStage) {
                groupsContainer.style.display = 'block';
                assignContainer.style.display = 'block';
                generateGroupUI();
            } else if (format === 'knockout') {
                 if (teams.length < 2) {
                    showAlert('A knockout tournament requires at least 2 teams.');
                }
                groupsContainer.style.display = 'none';
                assignContainer.style.display = 'none';
            } else {
                groupsContainer.style.display = 'none';
                assignContainer.style.display = 'none';
            }

            if (format === 'group_knockout' || format === 'super_stage') {
                knockoutTeamsPerGroupContainer.classList.remove('hidden');
            }
        }
        
        function generateGroupUI() {
            const numGroups = parseInt(document.getElementById('number-of-groups').value);
            const teams = Object.values(teamDataStore);
            const container = document.getElementById('group-assignment-container');
            container.innerHTML = '';
            
            if (teams.length > 0 && numGroups > 0 && teams.length % numGroups !== 0) {
                container.innerHTML = `<p class="text-red-500">Number of teams must be divisible by the number of groups.</p>`;
                return;
            }
            const teamsPerGroup = teams.length / numGroups;

            for (let i = 0; i < numGroups; i++) {
                const groupName = `Group ${String.fromCharCode(65 + i)}`;
                let groupHTML = `<div class="bg-slate-50 p-4 rounded-lg">
                    <h3 class="font-bold text-lg text-indigo-600 mb-2">${groupName}</h3>
                    <div class="space-y-2">`;
                for (let j = 0; j < teamsPerGroup; j++) {
                    groupHTML += `<div><select class="w-full p-2 border-gray-300 border rounded-md group-team-select" data-group-index="${i}"></select></div>`;
                }
                groupHTML += `</div></div>`;
                container.innerHTML += groupHTML;
            }
            updateGroupSelectOptions();
            document.querySelectorAll('.group-team-select').forEach(select => {
                select.addEventListener('change', updateGroupSelectOptions);
            });
        }

        function updateGroupSelectOptions() {
            const teams = Object.values(teamDataStore);
            const allSelects = document.querySelectorAll('.group-team-select');
            const selectedTeamIds = Array.from(allSelects).map(s => s.value).filter(v => v);

            allSelects.forEach(select => {
                const currentValue = select.value;
                let optionsHTML = '<option value="">-- Select Team --</option>';
                teams.forEach(team => {
                    const isSelectedElsewhere = selectedTeamIds.includes(team.id) && currentValue !== team.id;
                    optionsHTML += `<option value="${team.id}" ${isSelectedElsewhere ? 'disabled' : ''}>${team.name}</option>`;
                });
                select.innerHTML = optionsHTML;
                select.value = currentValue;
            });
        }
        function calculateNRR(team, allFixtures, allTeams) {
            let runsFor = 0;
            let oversFor = 0;
            let runsAgainst = 0;
            let oversAgainst = 0;
            const ballsPerOver = currentTournamentState.ballsPerOver || 6;

            const relevantFixtures = allFixtures.filter(f => (f.team1Id === team.id || f.team2Id === team.id) && f.status === 'completed' && f.summary && f.summary.length === 2);

            for (const fixture of relevantFixtures) {
                const teamInning = fixture.summary.find(s => s.teamId === team.id);
                const opponentInning = fixture.summary.find(s => s.teamId !== team.id);

                if (teamInning) {
                    runsFor += teamInning.score;
                    oversFor += Math.floor(teamInning.balls / ballsPerOver) + (teamInning.balls % ballsPerOver) / ballsPerOver;
                }
                if (opponentInning) {
                    runsAgainst += opponentInning.score;
                    oversAgainst += Math.floor(opponentInning.balls / ballsPerOver) + (opponentInning.balls % ballsPerOver) / ballsPerOver;
                }
            }
            
            if (oversFor === 0 || oversAgainst === 0) return 0;

            const nrr = (runsFor / oversFor) - (runsAgainst / oversAgainst);
            return isNaN(nrr) ? 0 : nrr;
        }

        function getTeamStandings(teamIds) {
            let teams = JSON.parse(JSON.stringify(currentTournamentState.teams.filter(t => teamIds.includes(t.id))));
            
            teams.forEach(team => {
                team.nrr = calculateNRR(team, currentTournamentState.fixtures, currentTournamentState.teams);
            });

            teams.sort((a, b) => {
                if (b.points !== a.points) return b.points - a.points;
                if (b.nrr !== a.nrr) return b.nrr - a.nrr;
                if (b.wins !== a.wins) return b.wins - a.wins;
                // Note: Head-to-head logic would require additional implementation
                return 0; 
            });
            return teams;
        }
        function finalizeTeamsAndGoToDashboard() {
            const format = document.getElementById('tournament-format').value;
            const teams = Object.values(teamDataStore);
            const teamsWithPlayers = teams.filter(t => t.players && t.players.length >= (parseInt(document.getElementById('tournament-players').value) - 1));
            
            if (teams.length !== teamsWithPlayers.length) {
                 showAlert("Please ensure all teams have their players added before creating the tournament.");
                 return;
            }
            
            if (['round-robin', 'group_knockout', 'double_round_robin', 'playoffs', 'super_stage'].includes(format)) {
                const allSelects = document.querySelectorAll('.group-team-select');
                const selectedCount = Array.from(allSelects).filter(s => s.value).length;
                if (selectedCount !== teams.length) {
                    showAlert('Please assign all teams to a group.');
                    return;
                }
                allSelects.forEach(select => {
                    const team = teams.find(t => t.id === select.value);
                    if (team) {
                        team.group = `Group ${String.fromCharCode(65 + parseInt(select.dataset.groupIndex))}`;
                    }
                });
            }

            const pointsRules = {
                win: parseInt(document.getElementById('points-win').value) || 0,
                loss: parseInt(document.getElementById('points-loss').value) || 0,
                tie: parseInt(document.getElementById('points-tie').value) || 0,
                noResult: parseInt(document.getElementById('points-no-result').value) || 0
            };

            generateFixtures();
            
            // Allow proceeding even if fixtures are not auto-generated
            if (['double_round_robin', 'playoffs', 'super_stage'].includes(format)) {
                 // Fixtures might be empty, which is ok for manual creation.
            } else if (!currentTournamentState.fixtures || currentTournamentState.fixtures.length === 0) {
                showAlert("Could not generate fixtures. Please check your settings.");
                return;
            }
            
            // const rulesText = document.getElementById('tournament-rules').value; // This element does not exist and was causing an error.

            currentTournamentState = {
                name: document.getElementById('tournament-name').value,
                startDate: document.getElementById('start-date').value,
                overs: parseInt(document.getElementById('tournament-overs').value),
                ballsPerOver: parseInt(document.getElementById('balls-per-over').value) || 6,
                playersPerSide: parseInt(document.getElementById('tournament-players').value),
                freeHitEnabled: document.getElementById('free-hit-enabled').value === 'yes',
                freeHitRules: document.getElementById('free-hit-rules').value,
                rules: "", // Set to empty string as the input element was removed.
                teams: teams.map(t => ({...t, played: 0, wins: 0, losses: 0, ties: 0, points: 0, nrr: 0})),
                fixtures: currentTournamentState.fixtures,
                pointsRules: pointsRules
            };

            localStorage.setItem('cricker_tournament_state', JSON.stringify(currentTournamentState));
            localStorage.setItem('cricker_current_view', 'tournament-dashboard');

            document.getElementById('tournament-setup').classList.add('hidden');
            document.getElementById('tournament-dashboard').classList.remove('hidden');
            displayDashboard();
        }

        function generateFairRoundRobinFixtures(teams, isGroupStage = false) {
            const fixtures = [];
            let localTeams = [...teams];

            if (localTeams.length % 2 !== 0) {
                localTeams.push({ id: 'bye', name: 'Bye' });
            }

            const numTeams = localTeams.length;
            const numRounds = numTeams - 1;
            const halfSize = numTeams / 2;
            const matchNamePrefix = isGroupStage ? 'Group Stage - ' : '';

            for (let round = 0; round < numRounds; round++) {
                for (let i = 0; i < halfSize; i++) {
                    const team1 = localTeams[i];
                    const team2 = localTeams[numTeams - 1 - i];

                    if (team1.id !== 'bye' && team2.id !== 'bye') {
                        fixtures.push({
                            matchId: `match_${Date.now()}_r${round+1}_${team1.id}_vs_${team2.id}`,
                            matchName: `${matchNamePrefix}Round ${round + 1}`,
                            team1Id: (i === 0 && round % 2 !== 0) ? team2.id : team1.id, // Alternate home for the fixed team
                            team2Id: (i === 0 && round % 2 !== 0) ? team1.id : team2.id,
                            status: 'upcoming',
                            result: '',
                            summary: null
                        });
                    }
                }
                const lastTeam = localTeams.pop();
                localTeams.splice(1, 0, lastTeam);
            }
            return fixtures;
        }

        function getKnockoutRoundName(numTeams) {
            if (numTeams === 2) return 'Final';
            if (numTeams === 4) return 'Semi-Final';
            if (numTeams === 8) return 'Quarter-Final';
            return `Round of ${numTeams}`;
        }

        function generateKnockoutBracket(teams) {
            let bracketFixtures = [];
            let currentRoundTeams = [...teams];
            let roundNum = 1;
            while (currentRoundTeams.length > 1) {
                const roundName = getKnockoutRoundName(currentRoundTeams.length);
                let nextRoundPlaceholders = [];
                
                for (let i = 0; i < currentRoundTeams.length; i += 2) {
                    const team1 = currentRoundTeams[i];
                    const team2 = currentRoundTeams[i + 1];
                    const matchId = `ko_placeholder_r${roundNum}_m${(i/2)+1}`;
                    
                    bracketFixtures.push({
                        matchId: matchId,
                        matchName: roundName,
                        team1Id: team1.id,
                        team2Id: team2.id,
                        status: 'upcoming', result: '', summary: null
                    });
                    nextRoundPlaceholders.push({id: `winner_${matchId}`, name: `Winner of ${matchId}`});
                }
                currentRoundTeams = nextRoundPlaceholders;
                roundNum++;
            }
            return bracketFixtures;
        }
        
        function generateFixtures() {
            const format = document.getElementById('tournament-format').value;
            const teams = Object.values(teamDataStore);
            const numGroups = parseInt(document.getElementById('number-of-groups').value) || 1;
            const teamsAdvancing = parseInt(document.getElementById('knockout-teams-per-group').value) || 2;
            let fixtures = [];

            switch (format) {
                case 'round-robin':
                case 'double_round_robin': {
                    let leagueFixtures = generateFairRoundRobinFixtures(teams, false);
                    if (format === 'double_round_robin') {
                        leagueFixtures = [...leagueFixtures, ...generateFairRoundRobinFixtures(teams.reverse(), false)];
                    }
                    fixtures.push(...leagueFixtures);

                    if (teamsAdvancing === 2 && teams.length >= 2) {
                        fixtures.push({ matchId: 'final', matchName: 'Final', team1Id: 'placeholder_rank_1', team2Id: 'placeholder_rank_2', status: 'upcoming', result: '', summary: null });
                    } else if (teamsAdvancing === 4 && teams.length >= 4) {
                        fixtures.push({ matchId: 'sf_1', matchName: 'Semi-Final', team1Id: 'placeholder_rank_1', team2Id: 'placeholder_rank_4', status: 'upcoming', result: '', summary: null });
                        fixtures.push({ matchId: 'sf_2', matchName: 'Semi-Final', team1Id: 'placeholder_rank_2', team2Id: 'placeholder_rank_3', status: 'upcoming', result: '', summary: null });
                        fixtures.push({ matchId: 'final', matchName: 'Final', team1Id: 'winner_sf_1', team2Id: 'winner_sf_2', status: 'upcoming', result: '', summary: null });
                    }
                    break;
                }
                case 'knockout': {
                    if (teams.length < 2) {
                        showAlert("Knockout format requires at least 2 teams.");
                        fixtures = [];
                        return;
                    }
                    let knockoutTeams = [...teams].sort(() => 0.5 - Math.random());
                    fixtures = generateKnockoutBracket(knockoutTeams);
                    break;
                }
                case 'group_knockout': {
                    for (let i = 0; i < numGroups; i++) {
                        const groupName = `Group ${String.fromCharCode(65 + i)}`;
                        const groupTeams = teams.filter(t => t.group === groupName);
                        if (groupTeams.length > 1) {
                            fixtures.push(...generateFairRoundRobinFixtures(groupTeams, true));
                        }
                    }
                    
                    const totalAdvancing = numGroups * teamsAdvancing;
                    if (totalAdvancing < 2) break;

                    if (numGroups === 2 && teamsAdvancing === 2) { // SF: A1xB2, B1xA2
                        fixtures.push({ matchId: 'sf_1', matchName: 'Semi-Final', team1Id: 'placeholder_A_1', team2Id: 'placeholder_B_2', status: 'upcoming' });
                        fixtures.push({ matchId: 'sf_2', matchName: 'Semi-Final', team1Id: 'placeholder_B_1', team2Id: 'placeholder_A_2', status: 'upcoming' });
                        fixtures.push({ matchId: 'final', matchName: 'Final', team1Id: 'winner_sf_1', team2Id: 'winner_sf_2', status: 'upcoming' });
                    } else if (numGroups === 4 && teamsAdvancing === 2) { // QF: A1vB2, C1vD2, etc. (standard draw)
                        fixtures.push({ matchId: 'qf_1', matchName: 'Quarter-Final', team1Id: 'placeholder_A_1', team2Id: 'placeholder_B_2', status: 'upcoming' });
                        fixtures.push({ matchId: 'qf_2', matchName: 'Quarter-Final', team1Id: 'placeholder_C_1', team2Id: 'placeholder_D_2', status: 'upcoming' });
                        fixtures.push({ matchId: 'qf_3', matchName: 'Quarter-Final', team1Id: 'placeholder_B_1', team2Id: 'placeholder_A_2', status: 'upcoming' });
                        fixtures.push({ matchId: 'qf_4', matchName: 'Quarter-Final', team1Id: 'placeholder_D_1', team2Id: 'placeholder_C_2', status: 'upcoming' });
                        fixtures.push({ matchId: 'sf_1', matchName: 'Semi-Final', team1Id: 'winner_qf_1', team2Id: 'winner_qf_2', status: 'upcoming' });
                        fixtures.push({ matchId: 'sf_2', matchName: 'Semi-Final', team1Id: 'winner_qf_3', team2Id: 'winner_qf_4', status: 'upcoming' });
                        fixtures.push({ matchId: 'final', matchName: 'Final', team1Id: 'winner_sf_1', team2Id: 'winner_sf_2', status: 'upcoming' });
                    } else { // Generic bracket for other combinations
                        let knockoutPlaceholders = [];
                        for (let i = 0; i < numGroups; i++) {
                            for (let j = 1; j <= teamsAdvancing; j++) {
                                knockoutPlaceholders.push({ id: `placeholder_${String.fromCharCode(65 + i)}_${j}` });
                            }
                        }
                        fixtures.push(...generateKnockoutBracket(knockoutPlaceholders));
                    }
                    break;
                }
                case 'playoffs': {
                    if (teams.length < 4) {
                        showAlert("Playoff (IPL Style) format requires at least 4 teams.");
                        fixtures = [];
                        return;
                    }
                    fixtures.push(...generateFairRoundRobinFixtures(teams, true));
                    fixtures.push({ matchId: 'qualifier_1', matchName: 'Qualifier 1', team1Id: 'placeholder_rank_1', team2Id: 'placeholder_rank_2', status: 'upcoming' });
                    fixtures.push({ matchId: 'eliminator', matchName: 'Eliminator', team1Id: 'placeholder_rank_3', team2Id: 'placeholder_rank_4', status: 'upcoming' });
                    fixtures.push({ matchId: 'qualifier_2', matchName: 'Qualifier 2', team1Id: 'loser_qualifier_1', team2Id: 'winner_eliminator', status: 'upcoming' });
                    fixtures.push({ matchId: 'final', matchName: 'Final', team1Id: 'winner_qualifier_1', team2Id: 'winner_qualifier_2', status: 'upcoming' });
                    break;
                }
                 case 'super_stage': {
                    const totalAdvancing = numGroups * teamsAdvancing;
                    if (totalAdvancing !== 6 && totalAdvancing !== 8) {
                        showAlert("Super Stage format currently supports Super 6 or Super 8 only.");
                        fixtures = [];
                        return;
                    }
                    for (let i = 0; i < numGroups; i++) {
                        const groupName = `Group ${String.fromCharCode(65 + i)}`;
                        const groupTeams = teams.filter(t => t.group === groupName);
                        fixtures.push(...generateFairRoundRobinFixtures(groupTeams, true));
                    }
                    let superStagePlaceholders = [];
                    for (let i = 0; i < numGroups; i++) {
                        for (let j = 1; j <= teamsAdvancing; j++) {
                            superStagePlaceholders.push({ id: `placeholder_${String.fromCharCode(65+i)}_${j}` });
                        }
                    }
                    const superStageFixtures = generateFairRoundRobinFixtures(superStagePlaceholders);
                    superStageFixtures.forEach(f => f.matchName = `Super ${totalAdvancing} Stage`);
                    fixtures.push(...superStageFixtures);
                    fixtures.push({ matchId: 'final', matchName: 'Final', team1Id: 'placeholder_ss_rank_1', team2Id: 'placeholder_ss_rank_2', status: 'upcoming' });
                    break;
                }
            }
            currentTournamentState.fixtures = fixtures;
        }
        
        function displayDashboard() {
            const data = currentTournamentState;
            document.getElementById('dashboard-title').textContent = data.name;
            document.getElementById('dashboard-sticky-title').textContent = data.name;
            document.getElementById('dashboard-subtitle').textContent = `Starting: ${new Date(data.startDate + 'T00:00:00').toLocaleDateString()}`;
            renderFixtures();
            renderPointsTable();
            renderLeaderboards();
        }

       function renderFixtures() {
            const container = document.getElementById('fixtures-list');
            if (!currentTournamentState.fixtures || !currentTournamentState.fixtures.length) { 
                container.innerHTML = `<p class="text-center text-slate-500 py-4">No matches created yet.</p>`; 
                return; 
            }
            
            container.innerHTML = currentTournamentState.fixtures.map((match) => {
                const team1 = currentTournamentState.teams.find(t => t.id === match.team1Id);
                const team2 = currentTournamentState.teams.find(t => t.id === match.team2Id);
                
                const team1Name = team1 ? team1.name : match.team1Id.replace(/_/g, ' ').replace('placeholder', 'TBD');
                const team2Name = team2 ? team2.name : match.team2Id.replace(/_/g, ' ').replace('placeholder', 'TBD');
                
                const team1Logo = team1 ? (team1.logoUrl ? `<img src="${team1.logoUrl}" class="team-logo-compact object-cover">` : `<div class="team-logo-compact" style="background-color: ${team1.color};">${team1.name.charAt(0)}</div>`) : `<div class="team-logo-compact bg-slate-200 text-slate-500">?</div>`;
                const team2Logo = team2 ? (team2.logoUrl ? `<img src="${team2.logoUrl}" class="team-logo-compact object-cover">` : `<div class="team-logo-compact" style="background-color: ${team2.color};">${team2.name.charAt(0)}</div>`) : `<div class="team-logo-compact bg-slate-200 text-slate-500">?</div>`;

                let statusChip = '';
                let resultText = '';
                const isCompleted = match.status === 'completed';
                
                if (isCompleted) {
                    statusChip = `<span class="text-xs font-semibold bg-slate-200 text-slate-600 px-2 py-1 rounded-full">Completed</span>`;
                    resultText = `<p class="text-xs text-slate-500 mt-2 font-semibold truncate">${match.result}</p>`;
                } else if (match.status === 'in-progress') {
                    statusChip = `<span class="flex items-center text-xs font-semibold bg-red-100 text-red-600 px-2 py-1 rounded-full"><span class="w-2 h-2 bg-red-500 rounded-full mr-1.5 animate-pulse"></span>Live</span>`;
                } else {
                    statusChip = `<span class="text-xs font-semibold bg-blue-100 text-blue-600 px-2 py-1 rounded-full">Upcoming</span>`;
                }
                
                let buttonHtml = '';
                if (isCompleted) {
                     buttonHtml = `<button onclick="viewMatchSummary('${match.matchId}')" class="text-xs font-bold text-indigo-600 hover:text-indigo-800 transition-colors">Summary</button>`;
                } else if (match.status === 'in-progress') {
                     buttonHtml = `<button onclick="startTournamentMatch('${match.matchId}', true)" class="text-xs font-bold text-red-600 hover:text-red-800 transition-colors">Continue</button>`;
                } else if (team1 && team2) {
                     buttonHtml = `<button onclick="startTournamentMatch('${match.matchId}')" class="text-xs font-bold text-indigo-600 hover:text-indigo-800 transition-colors">Start</button>`;
                }

                return `
                    <div class="glass-card p-4 mb-3">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-xs font-bold text-slate-500 uppercase tracking-wide">${match.matchName}</p>
                            </div>
                            ${statusChip}
                        </div>
                        <div class="mt-3 space-y-2">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    ${team1Logo}
                                    <span class="font-bold text-base">${team1Name}</span>
                                </div>
                            </div>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    ${team2Logo}
                                    <span class="font-bold text-base">${team2Name}</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex justify-between items-center mt-3 pt-3 border-t border-slate-200/60">
                            <div class="flex-grow">${resultText}</div>
                            ${buttonHtml}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderPointsTable() {
            const container = document.getElementById('points-table-container');
            // Clear only the table, not the whole container which will hold leaderboards
            const existingTable = container.querySelector('.points-table');
            if(existingTable) existingTable.remove();

            const sortedTeams = [...currentTournamentState.teams].sort((a,b) => b.points - a.points || b.nrr - a.nrr);
            let tableHTML = `<div class="overflow-x-auto points-table">
                <table class="w-full text-left text-sm">
                <thead><tr class="text-slate-500"><th class="font-semibold">Team</th><th class="font-semibold text-center">P</th><th class="font-semibold text-center">W</th><th class="font-semibold text-center">L</th><th class="font-semibold text-center">Pts</th><th class="font-semibold text-right">NRR</th></tr></thead>
                <tbody>${sortedTeams.map(team => `
                    <tr>
                        <td class="font-bold text-slate-700">${team.name}</td>
                        <td class="text-center">${team.played}</td>
                        <td class="text-center">${team.wins}</td>
                        <td class="text-center">${team.losses}</td>
                        <td class="font-extrabold text-indigo-600 text-center">${team.points}</td>
                        <td class="text-right">${team.nrr.toFixed(3)}</td>
                    </tr>`).join('')}
                </tbody>
            </table></div>`;
            container.insertAdjacentHTML('afterbegin', tableHTML);
        }
        function aggregateTournamentStats() {
            const completedFixtures = currentTournamentState.fixtures.filter(f => f.status === 'completed' && f.summary);
            const allPlayers = new Map();

            currentTournamentState.teams.forEach(team => {
                team.players.forEach(playerName => {
                    allPlayers.set(playerName, {
                        name: playerName, teamName: team.name, teamColor: team.color, photoUrl: null, 
                        runs: 0, ballsFaced: 0, fours: 0, sixes: 0, dismissals: 0, notOuts: 0, inningsBatted: 0,
                        wickets: 0, runsConceded: 0, ballsBowled: 0, dots: 0, maidens: 0, fourWickets: 0, fiveWickets: 0,
                        catches: 0, runOuts: 0, stumpings: 0,
                    });
                });
            });

            completedFixtures.forEach(match => {
                match.summary.forEach(inning => {
                    // Batting stats
                    Object.values(inning.playerStats).forEach(pStat => {
                        if (allPlayers.has(pStat.name)) {
                            const player = allPlayers.get(pStat.name);
                            player.runs += pStat.runs;
                            player.ballsFaced += pStat.balls;
                            player.fours += pStat.fours;
                            player.sixes += pStat.sixes;
                            
                            const batted = pStat.isOut || pStat.balls > 0;
                            if (batted) {
                                player.inningsBatted++;
                                if (pStat.isOut) {
                                    player.dismissals++;
                                } else {
                                    player.notOuts++;
                                }
                            }
                        }
                    });
                    // Bowling stats
                     Object.values(inning.bowlingStats).forEach(pStat => {
                        if (allPlayers.has(pStat.name)) {
                            const player = allPlayers.get(pStat.name);
                            player.wickets += pStat.wickets;
                            player.runsConceded += pStat.runsConceded;
                            player.ballsBowled += pStat.ballsBowled;
                            player.maidens += pStat.maidens;

                            if (pStat.wickets >= 5) player.fiveWickets++;
                            else if (pStat.wickets === 4) player.fourWickets++;
                        }
                    });
                });
            });
            
            tournamentStatsCache = Array.from(allPlayers.values());
            localStorage.setItem('cricker_leaderboards', JSON.stringify(tournamentStatsCache));
            return tournamentStatsCache;
        }

        function renderLeaderboards() {
            const stats = tournamentStatsCache || aggregateTournamentStats();
            const container = document.getElementById('leaderboards-container');
            container.innerHTML = ''; // Clear previous leaderboards

            // --- Batting Logic ---
            const batsmen = [...stats].filter(p => p.inningsBatted > 0).map(p => {
                const outs = Math.max(1, p.dismissals);
                p.avg = p.runs / outs;
                p.sr = p.ballsFaced > 0 ? (p.runs / p.ballsFaced) * 100 : 0;
                return p;
            });
            
            const sortedBatsmen = batsmen.sort((a, b) => b.runs - a.runs || b.sr - a.sr || b.avg - a.avg || b.sixes - a.sixes || b.fours - a.fours || a.ballsFaced - b.ballsFaced || a.name.localeCompare(b.name));

            // --- Bowling Logic ---
            const bowlers = [...stats].filter(p => p.ballsBowled > 0).map(p => {
                p.overs = Math.floor(p.ballsBowled / 6) + '.' + (p.ballsBowled % 6);
                p.econ = p.ballsBowled > 0 ? p.runsConceded / (p.ballsBowled / 6) : 0;
                p.bowlingSr = p.wickets > 0 ? p.ballsBowled / p.wickets : 0;
                return p;
            });

            const sortedBowlers = bowlers.sort((a, b) => b.wickets - a.wickets || a.econ - b.econ || a.bowlingSr - b.bowlingSr || a.runsConceded - b.runsConceded || b.ballsBowled - a.ballsBowled || a.name.localeCompare(b.name));

            // --- MVP Calculation ---
            const mvp = [...stats].map(p => {
                const sr = p.ballsFaced > 0 ? (p.runs / p.ballsFaced) * 100 : 0;
                p.mvpScore = (4 * p.wickets) + (0.5 * p.dots) - (0.25 * p.runsConceded) + p.runs + (2 * p.notOuts) + (3 * p.catches) + (3 * p.runOuts) + (4 * p.stumpings) + (0.02 * sr);
                return p;
            }).sort((a,b) => b.mvpScore - a.mvpScore)[0];
            
            // --- Render Functions for Lists ---
            const renderBatsmenList = (players) => {
                if (players.length === 0) return '<li><p class="text-center text-slate-400 text-xs py-4">Not enough data yet.</p></li>';
                const header = `<li class="flex justify-between text-xs font-bold text-slate-500 pb-2 border-b border-slate-200/80">
                    <span class="w-2/5 pl-10">Player</span>
                    <span class="w-3/5 grid grid-cols-8 text-center gap-1">
                        <span>R</span><span>I</span><span>NO</span><span>BF</span><span>SR</span><span>Avg</span><span>4s</span><span>6s</span>
                    </span>
                </li>`;
                const rows = players.slice(0, 10).map((p, i) => `
                    <li class="flex justify-between items-center text-xs py-2 border-b border-slate-200/80 last:border-0">
                        <span class="w-2/5 truncate font-semibold flex items-center">
                            <span class="text-slate-400 w-6 text-center">${i+1}</span>
                            ${getPlayerAvatar(p, 'md')}
                            <span class="ml-3">${p.name} <em class="text-slate-500 font-normal">(${p.teamName})</em></span>
                        </span>
                        <span class="w-3/5 grid grid-cols-8 text-center font-medium gap-1">
                            <span class="font-extrabold text-slate-800">${p.runs}</span>
                            <span>${p.inningsBatted}</span>
                            <span>${p.notOuts}</span>
                            <span>${p.ballsFaced}</span>
                            <span>${p.sr.toFixed(1)}</span>
                            <span>${p.avg.toFixed(1)}</span>
                            <span>${p.fours}</span>
                            <span>${p.sixes}</span>
                        </span>
                    </li>`).join('');
                return header + rows;
            };

            const renderBowlersList = (players) => {
                if (players.length === 0) return '<li><p class="text-center text-slate-400 text-xs py-4">Not enough data yet.</p></li>';
                const header = `<li class="flex justify-between text-xs font-bold text-slate-500 pb-2 border-b border-slate-200/80">
                    <span class="w-2/5 pl-10">Player</span>
                    <span class="w-3/5 grid grid-cols-7 text-center gap-1">
                        <span>O</span><span>M</span><span>R</span><span>W</span><span>Econ</span><span>SR</span><span>Dots</span>
                    </span>
                </li>`;
                const rows = players.slice(0, 10).map((p, i) => `
                    <li class="flex justify-between items-center text-xs py-2 border-b border-slate-200/80 last:border-0">
                        <span class="w-2/5 truncate font-semibold flex items-center">
                            <span class="text-slate-400 w-6 text-center">${i+1}</span>
                             ${getPlayerAvatar(p, 'md')}
                            <span class="ml-3">${p.name} <em class="text-slate-500 font-normal">(${p.teamName})</em></span>
                        </span>
                        <span class="w-3/5 grid grid-cols-7 text-center font-medium gap-1">
                            <span>${p.overs}</span>
                            <span>${p.maidens}</span>
                            <span>${p.runsConceded}</span>
                            <span class="font-extrabold text-slate-800">${p.wickets}</span>
                            <span>${p.econ.toFixed(2)}</span>
                            <span>${p.bowlingSr.toFixed(1)}</span>
                            <span>${p.dots}</span>
                        </span>
                    </li>`).join('');
                return header + rows;
            };

            const leaderboardHtml = `
                <div class="glass-card p-4 overflow-x-auto">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-bold text-base text-slate-700">Top Batsmen</h3>
                        <div class="flex items-center gap-3 sm:gap-4">
                            <span class="text-xs font-semibold text-slate-500 cursor-pointer hover:text-indigo-600">Best Avg</span>
                            <span class="text-xs font-semibold text-slate-500 cursor-pointer hover:text-indigo-600">Best SR</span>
                            <button class="text-xs font-bold text-indigo-600 hover:text-indigo-800">View All</button>
                        </div>
                    </div>
                    <ul class="text-sm min-w-[600px]">${renderBatsmenList(sortedBatsmen)}</ul>
                </div>
                <div class="glass-card p-4 overflow-x-auto">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-bold text-base text-slate-700">Top Bowlers</h3>
                        <div class="flex items-center gap-3 sm:gap-4">
                             <span class="text-xs font-semibold text-slate-500 cursor-pointer hover:text-indigo-600">Best Econ</span>
                             <button class="text-xs font-bold text-indigo-600 hover:text-indigo-800">View All</button>
                        </div>
                    </div>
                    <ul class="text-sm min-w-[600px]">${renderBowlersList(sortedBowlers)}</ul>
                </div>
                ${mvp && mvp.mvpScore > 0 ? `
                <div class="p-4 rounded-2xl bg-gradient-to-br from-yellow-300 via-orange-400 to-red-500 text-white shadow-lg">
                    <h3 class="font-bold text-xs uppercase tracking-widest flex items-center opacity-80">Most Valuable Player</h3>
                    <div class="flex items-center gap-3 mt-2">
                        ${getPlayerAvatar(mvp, 'lg')}
                        <div>
                            <p class="font-bold text-lg leading-tight">${mvp.name}</p>
                            <p class="text-xs font-medium opacity-90">${mvp.teamName}</p>
                        </div>
                    </div>
                </div>
                ` : ''}
            `;
            container.innerHTML = leaderboardHtml;
        }
        function openCreateMatchModal() {
            const teamASelect = document.getElementById('team-a-select');
            const teamBSelect = document.getElementById('team-b-select');
            let options = '<option value="">Select Team</option>';
            currentTournamentState.teams.forEach(team => { options += `<option value="${team.id}">${team.name}</option>`; });
            teamASelect.innerHTML = options;
            teamBSelect.innerHTML = options;
            openModal('create-match-modal');
        }

        function createMatch() {
            const teamAId = document.getElementById('team-a-select').value;
            const teamBId = document.getElementById('team-b-select').value;
            if (!teamAId || !teamBId || teamAId === teamBId) { showAlert("Please select two different teams."); return; }
            const newMatch = { matchId: `match_${Date.now()}`, team1Id: teamAId, team2Id: teamBId, status: 'upcoming', result: '' };
            currentTournamentState.fixtures.push(newMatch);
            renderFixtures();
            closeModal('create-match-modal');
        }
        
        function viewMatchSummary(matchId) {
            const match = currentTournamentState.fixtures.find(m => m.matchId === matchId);
            if (!match || match.status !== 'completed' || !match.summary) {
                showAlert("Summary is available only after a match is completed.");
                return;
            }

            const team1 = currentTournamentState.teams.find(t => t.id === match.team1Id);
            const team2 = currentTournamentState.teams.find(t => t.id === match.team2Id);

            const winningTeam = match.winnerId ? currentTournamentState.teams.find(t => t.id === match.winnerId) : null;
            const losingTeam = winningTeam ? (winningTeam.id === team1.id ? team2 : team1) : (match.result.toLowerCase().includes('tie') ? null : (team1 || team2));

            const inning1Summary = match.summary[0];
            const inning2Summary = match.summary[1];
            
            const inning1Team = currentTournamentState.teams.find(t => t.id === inning1Summary.teamId);
            const inning2Team = currentTournamentState.teams.find(t => t.id === inning2Summary.teamId);

            const topPerformers = getTopPerformers(match.summary);
            
            const mockMatchState = {
                inningsSummary: match.summary,
                team1: team1,
                team2: team2,
                ballsPerOver: currentTournamentState.ballsPerOver
            };
            const motm = suggestManOfTheMatch(mockMatchState, match.winnerId);

            // Re-use the existing end-of-match summary modal function
            showEndMatchSummaryModal(winningTeam, losingTeam, inning1Team, inning2Team, inning1Summary, inning2Summary, topPerformers, motm, match.result);
        }
        
        function renderSummaryTable(playerStats, type) {
            const players = Object.values(playerStats);
            let tableHtml = '';

            if (type === 'batting') {
                tableHtml = `<table class="min-w-full text-sm">
                    <thead><tr><th>Player</th><th>R</th><th>B</th><th>4s</th><th>6s</th><th>SR</th></tr></thead>
                    <tbody>
                        ${players.filter(p => p.runs > 0 || p.isOut).map(p => `
                        <tr>
                            <td>${p.name} ${p.isOut ? `(out ${p.dismissalInfo.type})` : '(not out)'}</td>
                            <td>${p.runs}</td><td>${p.balls}</td><td>${p.fours}</td><td>${p.sixes}</td><td>${(p.balls > 0 ? (p.runs/p.balls*100) : 0).toFixed(2)}</td>
                        </tr>
                        `).join('')}
                    </tbody>
                </table>`;
            } else if (type === 'bowling') {
                tableHtml = `<table class="min-w-full text-sm">
                    <thead><tr><th>Player</th><th>O</th><th>M</th><th>R</th><th>W</th><th>Econ</th></tr></thead>
                    <tbody>
                        ${players.filter(p => p.ballsBowled > 0).map(p => `
                        <tr>
                            <td>${p.name}</td>
                            <td>${Math.floor(p.ballsBowled / currentTournamentState.ballsPerOver)}.${p.ballsBowled % currentTournamentState.ballsPerOver}</td>
                            <td>${p.maidens}</td><td>${p.runsConceded}</td><td>${p.wickets}</td><td>${(p.ballsBowled > 0 ? (p.runsConceded / (p.ballsBowled / currentTournamentState.ballsPerOver)) : 0).toFixed(2)}</td>
                        </tr>
                        `).join('')}
                    </tbody>
                </table>`;
            }
            return tableHtml;
        }


        // --- MATCH SCORING (MODIFIED LOGIC) ---
        function startTournamentMatch(matchId, isContinuing = false) {
            const match = currentTournamentState.fixtures.find(f => f.matchId === matchId);
            if (!match) {
                console.error("Match not found for ID:", matchId);
                showAlert("Error: Could not find the match details.");
                return;
            }
            
            if (isContinuing) {
                const savedState = localStorage.getItem('cricker_match_state');
                if (savedState) {
                    liveMatchState = JSON.parse(savedState);
                } else {
                     showAlert("Could not find saved match state. Starting new match.");
                     isContinuing = false;
                }
            }
            
            if (!isContinuing) {
                const team1Data = currentTournamentState.teams.find(t => t.id === match.team1Id);
                const team2Data = currentTournamentState.teams.find(t => t.id === match.team2Id);

                if (!team1Data || !team2Data) {
                    showAlert("Error: Could not find team data for this match.");
                    return;
                }
                const minPlayers = parseInt(document.getElementById('tournament-players').value) - 1;
                if (team1Data.players.length < minPlayers || team2Data.players.length < minPlayers) {
                    showAlert(`Both teams must have at least ${minPlayers} players before starting a match. Please go back and add players.`);
                    return;
                }
                const initPlayerStats = (player) => ({ name: player, runs: 0, balls: 0, fours: 0, sixes: 0, isOut: false, dismissalInfo: null, ballsBowled: 0, runsConceded: 0, wickets: 0, maidens: 0 });
                liveMatchState = {
                    matchId, innings: 1, target: 0,
                    totalOvers: currentTournamentState.overs,
                    ballsPerOver: currentTournamentState.ballsPerOver,
                    playersPerSide: currentTournamentState.playersPerSide,
                    freeHit: false,
                    freeHitEnabled: currentTournamentState.freeHitEnabled,
                    freeHitRules: currentTournamentState.freeHitRules,
                    team1: { ...JSON.parse(JSON.stringify(team1Data)), score: 0, wickets: 0, balls: 0, playerStats: Object.fromEntries(team1Data.players.map(p => [p, initPlayerStats(p)])) },
                    team2: { ...JSON.parse(JSON.stringify(team2Data)), score: 0, wickets: 0, balls: 0, playerStats: Object.fromEntries(team2Data.players.map(p => [p, initPlayerStats(p)])) },
                    currentOverEvents: [], isScoringLocked: false, lastBowler: null, isLocked: false,
                };
                 currentTournamentState.fixtures.find(f => f.matchId === matchId).status = 'in-progress';
            }
            
            localStorage.setItem('cricker_tournament_state', JSON.stringify(currentTournamentState));
            localStorage.setItem('cricker_match_state', JSON.stringify(liveMatchState));
            localStorage.setItem('cricker_current_view', 'toss-screen');

            document.getElementById('tournament-flow').classList.add('hidden');
            document.getElementById('scorer-section').classList.remove('hidden');
            document.getElementById('toss-screen').classList.remove('hidden');
            document.getElementById('scorer-app').classList.add('hidden');

            if (!isContinuing || liveMatchState.innings === 1 && !liveMatchState.striker) {
                 setupTossScreen(liveMatchState.team1, liveMatchState.team2);
            } else {
                 document.getElementById('toss-screen').classList.add('hidden');
                 document.getElementById('scorer-app').classList.remove('hidden');
                 document.getElementById('scorer-app').classList.add('flex');
                 updateUI();
            }
        }
        
        function saveAndExitMatch() {
             if (liveMatchState.matchId) {
                localStorage.setItem(`liveMatchState_${liveMatchState.matchId}`, JSON.stringify(liveMatchState));
                showConfirm('Match progress has been saved. Do you want to return to the dashboard?', () => {
                    closeModal('confirm-modal');
                    returnToDashboard(false);
                });
            } else {
                returnToDashboard(false);
            }
        }

        function returnToDashboard(confirmFirst = false) {
            const performReturn = () => {
                localStorage.removeItem('cricker_match_state');
                localStorage.setItem('cricker_current_view', 'tournament-dashboard');
                document.getElementById('scorer-section').classList.add('hidden');
                document.getElementById('tournament-flow').classList.remove('hidden');
                closeModal('confirm-modal'); // Ensure confirm modal is closed if it was open
                displayDashboard();
            };

            if (confirmFirst && liveMatchState.matchId) {
                showConfirm("Are you sure you want to end the match and return to the dashboard?", performReturn);
            } else {
                performReturn();
            }
        }
        
        function setupTossScreen(team1, team2) {
            document.getElementById('toss-team1-name').textContent = team1.name;
            document.getElementById('toss-team2-name').textContent = team2.name;
            const t1Logo = document.getElementById('toss-team1-logo-container');
            if (team1.logoUrl) {
                t1Logo.innerHTML = `<img src="${team1.logoUrl}" alt="${team1.name}" class="w-full h-full rounded-full object-cover">`;
                t1Logo.style.backgroundColor = 'transparent';
            } else {
                t1Logo.style.backgroundColor = team1.color;
                t1Logo.innerHTML = `<span>${team1.name.charAt(0)}</span>`;
            }
            const t2Logo = document.getElementById('toss-team2-logo-container');
            if (team2.logoUrl) {
                t2Logo.innerHTML = `<img src="${team2.logoUrl}" alt="${team2.name}" class="w-full h-full rounded-full object-cover">`;
                t2Logo.style.backgroundColor = 'transparent';
            } else {
                t2Logo.style.backgroundColor = team2.color;
                t2Logo.innerHTML = `<span>${team2.name.charAt(0)}</span>`;
            }
        }
        
        function selectTossWinner(teamKey) {
            tossWinnerKey = teamKey;
            document.getElementById('toss-decision-container').classList.remove('hidden');
            document.getElementById('toss-winner-team1').classList.toggle('selected', teamKey === 'team1');
            document.getElementById('toss-winner-team2').classList.toggle('selected', teamKey === 'team2');
            checkTossCompletion();
        }

        function selectTossChoice(choice) {
            tossDecision = choice;
            document.getElementById('toss-choice-bat').classList.toggle('selected', choice === 'bat');
            document.getElementById('toss-choice-bowl').classList.toggle('selected', choice === 'bowl');
            checkTossCompletion();
        }

        function checkTossCompletion() {
            const startBtn = document.getElementById('start-match-btn');
            if (tossWinnerKey && tossDecision) {
                startBtn.disabled = false;
                startBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                startBtn.disabled = true;
                startBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }

        function startMatch() {
            liveMatchState.battingTeam = tossDecision === 'bat' ? tossWinnerKey : (tossWinnerKey === 'team1' ? 'team2' : 'team1');
            liveMatchState.bowlingTeam = liveMatchState.battingTeam === 'team1' ? 'team2' : 'team1';
            
            localStorage.setItem('cricker_match_state', JSON.stringify(liveMatchState));
            localStorage.setItem('cricker_current_view', 'scorer-app');

            document.getElementById('toss-screen').classList.add('hidden');
            document.getElementById('scorer-app').classList.remove('hidden');
            document.getElementById('scorer-app').classList.add('flex');
            initializeScorer();
        }

        async function initializeScorer() {
            liveMatchState.isScoringLocked = true;
            updateUI();
            const striker = await selectPlayer('striker'); liveMatchState.striker = striker;
            const nonStriker = await selectPlayer('nonStriker'); liveMatchState.nonStriker = nonStriker;
            const bowler = await selectPlayer('bowler'); liveMatchState.bowler = bowler;
            liveMatchState.isScoringLocked = false;
            updateUI();
            addCommentary(`Welcome to the match between ${liveMatchState.team1.name} and ${liveMatchState.team2.name}.`, true);
        }
        
        function addCommentary(text, isImportant = false) {
            const commentaryBox = document.getElementById('live-commentary');
            
            if (isImportant) {
                const welcomeModal = document.createElement('div');
                welcomeModal.className = "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[70] p-4";
                welcomeModal.innerHTML = `<div class="bg-white rounded-lg shadow-xl p-6 text-center w-full max-w-sm"><p class="text-xl font-bold text-gray-800">${text}</p><button class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-md" onclick="this.parentElement.parentElement.remove()">OK</button></div>`;
                document.body.appendChild(welcomeModal);
            } else {
                 commentaryBox.innerHTML = `<p class="text-sm text-gray-800 font-medium">${text}</p>`;
            }
        }

        function selectPlayer(role) {
            return new Promise(resolve => {
                document.getElementById('modal-title').textContent = `Select ${role.charAt(0).toUpperCase() + role.slice(1)}`;
                const teamKey = (role === 'bowler' || role === 'fielder') ? liveMatchState.bowlingTeam : liveMatchState.battingTeam;
                const select = document.getElementById('player-select');
                const battingPlayers = liveMatchState[liveMatchState.battingTeam].players;
                const bowlingPlayers = liveMatchState[liveMatchState.bowlingTeam].players;
                let availablePlayers = [];

                if (role === 'striker' || role === 'nonStriker' || role === 'batter') {
                    availablePlayers = battingPlayers.filter(p => !liveMatchState[liveMatchState.battingTeam].playerStats[p].isOut);
                } else if (role === 'bowler') {
                    availablePlayers = bowlingPlayers;
                }

                select.innerHTML = availablePlayers.map(p => {
                    const stats = liveMatchState[teamKey].playerStats[p];
                    const isSelected = liveMatchState.striker?.name === p || liveMatchState.nonStriker?.name === p;
                    const isLastBowler = role === 'bowler' && liveMatchState.lastBowler === p;
                    const isDisabled = isSelected || isLastBowler;
                    return `<option value="${p}" ${isDisabled ? 'disabled' : ''}>${p}</option>`;
                }).join('');

                document.getElementById('player-save-btn').onclick = () => {
                    if(!select.value) { showAlert("Please select a player."); return; }
                    const player = liveMatchState[teamKey].playerStats[select.value];
                    closeModal('player-modal');
                    resolve(player);
                };
                openModal('player-modal');
            });
        }
        
        function addRuns(runs) { 
            const isFreeHit = liveMatchState.freeHit;
            
            if (isFreeHit) {
                liveMatchState.freeHit = false;
                document.getElementById('free-hit-indicator').classList.add('hidden');
            }

            processBall({ 
                runsOnBat: runs, 
                eventText: `${runs}`, 
                commentary: generateCommentary(runs.toString(), { batsmanName: liveMatchState.striker.name, bowlerName: liveMatchState.bowler.name, runs: runs }), isFreeHit: isFreeHit
            });
        }
        
        function openNoBallModal() {
            openModal('no-ball-sub-modal');
            document.getElementById('noball-runs-container').classList.add('hidden');
        }

        function handleNoBall(type) {
            const isFreeHitEligible = (currentTournamentState.freeHitRules === 'all' || (currentTournamentState.freeHitRules === 'overstep_only' && type === 'overstep'));
            if (currentTournamentState.freeHitEnabled && isFreeHitEligible) {
                liveMatchState.freeHit = true;
                document.getElementById('free-hit-indicator').classList.remove('hidden');
            }
            document.getElementById('noball-runs-container').classList.remove('hidden'); addCommentary(generateCommentary('nb', { bowlerName: liveMatchState.bowler.name }));
        }
        
        function addExtra(type, runs) { 
            const isLegal = type === 'b' || type === 'lb' || type === 'wd' || type === 'nb';
            const extraRuns = (type === 'wd' || type === 'nb' ? 1 : 0) + runs;
            const runsOnBat = type === 'nb' ? runs : 0;
            const eventText = type.toUpperCase() + (runs > 0 ? `+${runs}` : ''); let commentaryText = generateCommentary(type, { bowlerName: liveMatchState.bowler.name, runs: extraRuns });
            processBall({ runsOnBat, extraRuns, isLegal: false, eventText, commentary: commentaryText }); 
            closeModal(`${type}-modal`); 
        }

        function openWicketModal() { openModal('wicket-type-modal'); }

        // NEW: Open modal for run out on extras
        function openRunOutExtraModal(type, title) {
            closeModal(`${type}-modal`);
            document.getElementById('run-out-extra-modal').querySelector('h3').textContent = title;
            const playerSelect = document.getElementById('run-out-player-select');
            playerSelect.innerHTML = `<option value="${liveMatchState.striker.name}">${liveMatchState.striker.name} (Striker)</option><option value="${liveMatchState.nonStriker.name}">${liveMatchState.nonStriker.name} (Non-striker)</option>`;
            document.getElementById('run-out-runs-input').value = 0;
            pendingRunOutDetails = { type, dismissedPlayer: null, runsTaken: 0, isLegal: false, eventText: 'RUN OUT' };
            openModal('run-out-extra-modal');
        }

        // NEW: Finalize run out from extra modes
        async function finalizeRunOutExtra() {
            const dismissedPlayerName = document.getElementById('run-out-player-select').value;
            const runsTaken = parseInt(document.getElementById('run-out-runs-input').value) || 0;
            const extraType = pendingRunOutDetails.type;

            closeModal('run-out-extra-modal');

            const extraRuns = (extraType === 'wd' || extraType === 'nb' ? 1 : 0) + runsTaken;
            const runsOnBat = extraType === 'nb' ? runsTaken : 0;
            const eventText = extraType.toUpperCase() + ' ' + (runsTaken > 0 ? `+${runsTaken}` : '') + ' & RO';
            
            const battingTeam = liveMatchState[liveMatchState.battingTeam];
            const dismissedPlayer = battingTeam.playerStats[dismissedPlayerName];
            
            // Check for free hit - no wicket falls on a free hit
            if (liveMatchState.freeHit) {
                addCommentary('Wicket on a free hit! The batsman survives.');
                if (type === 'Run Out') {
                    const runsTaken = 0; 
                    battingTeam.score += runsTaken;
                    if (liveMatchState.bowler) liveMatchState.bowler.runsConceded += runsTaken;
                }
                liveMatchState.freeHit = false;
                document.getElementById('free-hit-indicator').classList.add('hidden');
                processBall({ runsOnBat, extraRuns, isLegal: false, dismissal: null, eventText: 'Free Hit + RO', commentary: `A run-out attempt on a free hit! ${dismissedPlayerName} is safe.` });
                return;
            }

            dismissedPlayer.isOut = true;
            dismissedPlayer.dismissalInfo = { type: 'Run Out', bowler: liveMatchState.bowler.name }; let commentaryText = generateCommentary('wicket', { batsmanName: dismissedPlayer.name, dismissalType: 'Run Out' });
            
            processBall({ dismissal: true, commentary: commentaryText });

            if (battingTeam.wickets < liveMatchState.playersPerSide -1) {
                 const nextBatter = await selectPlayer('batter');
                 if(liveMatchState.striker.name === dismissedPlayerName){
                    liveMatchState.striker = nextBatter;
                 } else {
                    liveMatchState.nonStriker = nextBatter;
                 }
                 updateUI();
            }
        }

        function processBall(delivery) {
            if (liveMatchState.isLocked || liveMatchState.isScoringLocked) return;
            matchHistory.push(JSON.parse(JSON.stringify(liveMatchState)));
            
            const { runsOnBat = 0, extraRuns = 0, isLegal = true, dismissal = null, eventText = '', commentary = '', isFreeHit = false } = delivery;
            const battingTeam = liveMatchState[liveMatchState.battingTeam];
            const bowlingTeam = liveMatchState[liveMatchState.bowlingTeam];

            let wicketFell = false;
            if (dismissal && !isFreeHit) {
                battingTeam.wickets++;
                if (delivery.dismissalInfo && delivery.dismissalInfo.type !== 'Run Out') {
                    liveMatchState.bowler.wickets++;
                }
                wicketFell = true;
            }
            
            battingTeam.score += runsOnBat + extraRuns;
            if (liveMatchState.bowler) liveMatchState.bowler.runsConceded += runsOnBat + extraRuns;
            
            if (isLegal) {
                battingTeam.balls++;
                if(liveMatchState.bowler) liveMatchState.bowler.ballsBowled++;
                if (!dismissal && liveMatchState.striker) {
                    liveMatchState.striker.balls++;
                }
                liveMatchState.currentOverEvents.push({ event: eventText, isLegal: true, dismissal: wicketFell });
            } else {
                liveMatchState.currentOverEvents.push({ event: eventText, isLegal: false, dismissal: wicketFell });
            }

            if (liveMatchState.striker && !wicketFell) {
                liveMatchState.striker.runs += runsOnBat;
                if (runsOnBat === 4) liveMatchState.striker.fours++;
                if (runsOnBat === 6) liveMatchState.striker.sixes++;
            }

            if (!wicketFell && (runsOnBat + extraRuns) % 2 !== 0) {
                [liveMatchState.striker, liveMatchState.nonStriker] = [liveMatchState.nonStriker, liveMatchState.striker];
            }
            
            if (runsOnBat === 4) triggerEventAnimation('FOUR!', 'text-blue-500');
            if (runsOnBat === 6) triggerEventAnimation('SIX!', 'text-purple-500');
            if (wicketFell) triggerEventAnimation('OUT!', 'text-red-500');
            if (isFreeHit) triggerEventAnimation('FREE HIT!', 'text-green-500');

            if (commentary) addCommentary(commentary);
            
            updateUI();
            
            // Persist state after every ball
            if (liveMatchState.matchId) localStorage.setItem('cricker_match_state', JSON.stringify(liveMatchState));

            const maxBalls = liveMatchState.totalOvers * liveMatchState.ballsPerOver;
            const maxWickets = liveMatchState.playersPerSide - 1;

            if (liveMatchState.innings === 1) {
                if (isLegal && (battingTeam.balls >= maxBalls || battingTeam.wickets >= maxWickets)) {
                    endFirstInnings();
                    return;
                }
            } else if (liveMatchState.innings === 2) {
                if (battingTeam.score >= liveMatchState.target || (isLegal && (battingTeam.balls >= maxBalls || battingTeam.wickets >= maxWickets))) {
                    endMatch();
                    return;
                }
            }

            if (isLegal && battingTeam.balls % liveMatchState.ballsPerOver === 0 && battingTeam.balls > 0) {
                 handleOverEnd();
            }
        }

        async function handleWicket(type) {
            closeModal('wicket-type-modal');
            const battingTeam = liveMatchState[liveMatchState.battingTeam];
            let dismissedPlayer = liveMatchState.striker;
            let commentaryText = '';

            if (type === 'Run Out') {
                openModal('run-out-modal');
                const runOutOptions = document.getElementById('run-out-options');
                runOutOptions.innerHTML = `<button class="p-3 bg-gray-100 rounded-lg hover:bg-gray-200" onclick="finalizeWicket('Run Out', '${liveMatchState.striker.name}')">${liveMatchState.striker.name}</button>
                                           <button class="p-3 bg-gray-100 rounded-lg hover:bg-gray-200" onclick="finalizeWicket('Run Out', '${liveMatchState.nonStriker.name}')">${liveMatchState.nonStriker.name}</button>`;
                return; 
            } else {
                finalizeWicket(type, dismissedPlayer.name);
            }
        }

        async function finalizeWicket(type, dismissedPlayerName, commentaryText = '') {
            closeModal('run-out-modal');
            const battingTeamKey = liveMatchState.battingTeam;
            const battingTeam = liveMatchState[battingTeamKey];
            const dismissedPlayer = battingTeam.playerStats[dismissedPlayerName];
            if (liveMatchState.freeHit && type !== 'Run Out') {
                addCommentary('Wicket on a free hit! The batsman survives.');
                if (type === 'Run Out') {
                    const runsTaken = 0; 
                    battingTeam.score += runsTaken;
                    if (liveMatchState.bowler) liveMatchState.bowler.runsConceded += runsTaken;
                }
                liveMatchState.freeHit = false;
                document.getElementById('free-hit-indicator').classList.add('hidden');
                processBall({ runsOnBat: 0, extraRuns: 0, isLegal: true, dismissal: null, eventText: 'Free Hit + RO', commentary: `A run-out attempt on a free hit! ${dismissedPlayerName} is safe.` });
                return;
            }

            dismissedPlayer.isOut = true;
            dismissedPlayer.dismissalInfo = { type, bowler: liveMatchState.bowler.name }; commentaryText = commentaryText || generateCommentary('wicket', { batsmanName: dismissedPlayerName, bowlerName: liveMatchState.bowler.name, dismissalType: type });
            
            processBall({ dismissal: true, eventText: 'W', commentary: commentaryText });

            if (battingTeam.wickets < liveMatchState.playersPerSide -1) {
                 const nextBatter = await selectPlayer('batter');
                 if(liveMatchState.striker.name === dismissedPlayerName){
                    liveMatchState.striker = nextBatter;
                 } else {
                    liveMatchState.nonStriker = nextBatter;
                 }
                 addCommentary(`${nextBatter.name} comes to the crease.`);
                 updateUI();
            }
        }

        function handleOverEnd() { 
            [liveMatchState.striker, liveMatchState.nonStriker] = [liveMatchState.nonStriker, liveMatchState.striker];
            liveMatchState.lastBowler = liveMatchState.bowler.name;
            liveMatchState.currentOverEvents = [];
            liveMatchState.isScoringLocked = true;
            document.getElementById('bowler-prompt-overlay').classList.remove('hidden');
            addCommentary(`End of the over. The score is ${liveMatchState[liveMatchState.battingTeam].score}/${liveMatchState[liveMatchState.battingTeam].wickets}.`);
        }

        function endFirstInnings() {
            liveMatchState.isLocked = true;
            updateUI();
            const battingTeam = liveMatchState[liveMatchState.battingTeam];
            const bowlingTeam = liveMatchState[liveMatchState.bowlingTeam];
            const target = battingTeam.score + 1;
            
            liveMatchState.inningsSummary = liveMatchState.inningsSummary || [];
            liveMatchState.inningsSummary.push({
                teamId: battingTeam.id,
                score: battingTeam.score,
                wickets: battingTeam.wickets,
                balls: battingTeam.balls,
                playerStats: JSON.parse(JSON.stringify(battingTeam.playerStats)),
                bowlingStats: JSON.parse(JSON.stringify(bowlingTeam.playerStats))
            });

            showInningsBreakModal(battingTeam, bowlingTeam, target);
        }

        async function startSecondInnings() {
            const firstInningsTeamKey = liveMatchState.battingTeam;
            const secondInningsTeamKey = liveMatchState.bowlingTeam;

            liveMatchState.innings = 2;
            liveMatchState.target = liveMatchState[firstInningsTeamKey].score + 1;
            liveMatchState.battingTeam = secondInningsTeamKey;
            liveMatchState.bowlingTeam = firstInningsTeamKey;

            liveMatchState.currentOverEvents = [];
            liveMatchState.lastBowler = null;
            matchHistory = []; 
            liveMatchState.striker = null;
            liveMatchState.nonStriker = null;
            liveMatchState.bowler = null;
            
            liveMatchState.isLocked = false;
            liveMatchState.isScoringLocked = true;
            updateUI();
            
            const striker = await selectPlayer('striker'); liveMatchState.striker = striker;
            const nonStriker = await selectPlayer('nonStriker'); liveMatchState.nonStriker = nonStriker;
            const bowler = await selectPlayer('bowler'); liveMatchState.bowler = bowler;
            
            addCommentary(`The second innings is underway. ${liveMatchState[liveMatchState.battingTeam].name} needs ${liveMatchState.target} runs to win.`, true);

            liveMatchState.isScoringLocked = false;
            updateUI();
        }

        function endMatch() {
            liveMatchState.isLocked = true;
            updateUI();
            const battingTeam = liveMatchState[liveMatchState.battingTeam];
            const bowlingTeam = liveMatchState[liveMatchState.bowlingTeam];
            let resultMessage = '';
            let winningTeam = null;
            let losingTeam = null;
            let matchStatus = '';

            if (battingTeam.score >= liveMatchState.target) {
                const wicketsRemaining = liveMatchState.playersPerSide - 1 - battingTeam.wickets;
                resultMessage = `${battingTeam.name} won by ${wicketsRemaining} wicket(s).`;
                winningTeam = battingTeam;
                losingTeam = bowlingTeam;
                matchStatus = 'win';
            } else if (battingTeam.score < bowlingTeam.score) {
                const runsMargin = bowlingTeam.score - battingTeam.score;
                resultMessage = `${bowlingTeam.name} won by ${runsMargin} run(s).`;
                winningTeam = bowlingTeam;
                losingTeam = battingTeam;
                matchStatus = 'win';
            } else {
                resultMessage = "The match is a tie!";
                matchStatus = 'tie';
            }
            
            liveMatchState.inningsSummary = liveMatchState.inningsSummary || [];
            liveMatchState.inningsSummary.push({
                teamId: battingTeam.id,
                score: battingTeam.score,
                wickets: battingTeam.wickets,
                balls: battingTeam.balls,
                playerStats: battingTeam.playerStats,
                bowlingStats: bowlingTeam.playerStats
            });

            const matchIndex = currentTournamentState.fixtures.findIndex(m => m.matchId === liveMatchState.matchId);
            if (matchIndex !== -1) {
                currentTournamentState.fixtures[matchIndex].status = 'completed';
                currentTournamentState.fixtures[matchIndex].result = resultMessage;
                currentTournamentState.fixtures[matchIndex].winnerId = winningTeam ? winningTeam.id : null;
                currentTournamentState.fixtures[matchIndex].summary = liveMatchState.inningsSummary;
                
                updatePointsTable(matchStatus, winningTeam);
                updateKnockoutBracket(liveMatchState.matchId, winningTeam);
                
                // Update tournament state in localStorage after a match concludes
                localStorage.setItem('cricker_tournament_state', JSON.stringify(currentTournamentState));
            }
            
            const inning1Summary = liveMatchState.inningsSummary[0];
            const inning2Summary = liveMatchState.inningsSummary[1];

            const inning1Team = liveMatchState.team1.id === inning1Summary.teamId ? liveMatchState.team1 : liveMatchState.team2;
            const inning2Team = liveMatchState.team1.id === inning2Summary.teamId ? liveMatchState.team1 : liveMatchState.team2;

            const topPerformers = getTopPerformers(liveMatchState.inningsSummary);
            const motm = suggestManOfTheMatch(liveMatchState, winningTeam.id);

            showEndMatchSummaryModal(winningTeam, losingTeam, inning1Team, inning2Team, inning1Summary, inning2Summary, topPerformers, motm, resultMessage);
        }
        
        function getTopPerformers(inningsSummary) {
            let allBattingStats = [];
            let allBowlingStats = [];

            inningsSummary.forEach(inning => {
                allBattingStats.push(...Object.values(inning.playerStats).filter(p => p.balls > 0 || p.isOut));
                allBowlingStats.push(...Object.values(inning.bowlingStats).filter(p => p.ballsBowled > 0));
            });
            
            const topBatters = allBattingStats.sort((a, b) => b.runs - a.runs).slice(0, 3);
            const topBowlers = allBowlingStats.sort((a,b) => b.wickets - a.wickets || a.runsConceded - b.runsConceded).slice(0, 3);

            return { topBatters, topBowlers };
        }

        function suggestManOfTheMatch(matchState, winningTeamId) {
            const players = new Map();
            const { inningsSummary, team1, team2 } = matchState;

            const addPlayer = (player, team) => {
                if (!players.has(player.name)) {
                    players.set(player.name, { ...player, team, motm_points: 0 });
                }
            };

            [team1, team2].forEach(team => {
                Object.values(team.playerStats).forEach(p => addPlayer(p, team));
            });

            inningsSummary.forEach(inning => {
                const battingTeam = inning.teamId === team1.id ? team1 : team2;
                const bowlingTeam = inning.teamId === team1.id ? team2 : team1;

                Object.values(inning.playerStats).forEach(p_stat => {
                    const p = players.get(p_stat.name);
                    if (!p) return;
                    p.motm_points += p_stat.runs;
                    if (p_stat.runs >= 50) p.motm_points += 25;
                    if (p_stat.runs >= 100) p.motm_points += 50;
                    if (p_stat.balls > 10 && (p_stat.runs / p_stat.balls) > 1.5) p.motm_points += 15;
                    p.team = battingTeam;
                });
                
                Object.values(inning.bowlingStats).forEach(p_stat => {
                    const p = players.get(p_stat.name);
                    if (!p) return;
                    p.motm_points += p_stat.wickets * 25;
                    if (p_stat.wickets >= 3) p.motm_points += 25;
                    if (p_stat.wickets >= 5) p.motm_points += 50;
                    const overs = p_stat.ballsBowled / liveMatchState.ballsPerOver;
                    if (overs >= 2) {
                        const econ = p_stat.runsConceded / overs;
                        if (econ < 4) p.motm_points += 20;
                        if (econ < 6) p.motm_points += 10;
                    }
                    p.team = bowlingTeam;
                });
            });

            let bestPlayer = null;
            let maxPoints = -1;

            players.forEach(p => {
                if (p.team.id === winningTeamId) {
                    p.motm_points *= 1.2; // Bonus for being on the winning team
                }
                if (p.motm_points > maxPoints) {
                    maxPoints = p.motm_points;
                    bestPlayer = p;
                }
            });

            return bestPlayer;
        }

        function showEndMatchSummaryModal(winningTeam, losingTeam, inning1Team, inning2Team, inning1Summary, inning2Summary, topPerformers, motm, resultMessage) {
            const modal = document.getElementById('full-screen-message-modal');
            const contentContainer = document.getElementById('full-screen-message-content');

            const topBattersHTML = topPerformers.topBatters.map(p => `
                <div class="flex justify-between items-center text-sm py-1">
                    <span class="font-medium">${p.name}</span>
                    <span class="font-bold">${p.runs}<span class="text-xs opacity-70"> (${p.balls})</span></span>
                </div>`).join('');
            
            const topBowlersHTML = topPerformers.topBowlers.map(p => `
                 <div class="flex justify-between items-center text-sm py-1">
                    <span class="font-medium">${p.name}</span>
                    <span class="font-bold">${p.wickets}/${p.runsConceded}</span>
                </div>`).join('');
            
            const motmPerformance = motm.wickets > 0 ? `${motm.wickets}/${motm.runsConceded}` : `${motm.runs} (${motm.balls})`;

            const winningTeamLogoHtml = winningTeam.logoUrl
                ? `<img src="${winningTeam.logoUrl}" alt="${winningTeam.name}" class="team-logo-large mx-auto mb-2 rounded-full object-cover" style="border: 2px solid rgba(255,255,255,0.7);">`
                : `<div class="team-logo-large mx-auto mb-2" style="background-color: ${winningTeam.color}; border: 2px solid rgba(255,255,255,0.7);">${winningTeam.name.charAt(0)}</div>`;

            const inning1TeamLogoHtml = inning1Team.logoUrl
                ? `<img src="${inning1Team.logoUrl}" alt="${inning1Team.name}" class="team-logo small inline-block mr-2 rounded-full object-cover" style="vertical-align: middle;">`
                : `<div class="team-logo small inline-block mr-2" style="background-color: ${inning1Team.color}; vertical-align: middle;">${inning1Team.name.charAt(0)}</div>`;
            
            const inning2TeamLogoHtml = inning2Team.logoUrl
                ? `<img src="${inning2Team.logoUrl}" alt="${inning2Team.name}" class="team-logo small inline-block ml-2 rounded-full object-cover" style="vertical-align: middle;">`
                : `<div class="team-logo small inline-block ml-2" style="background-color: ${inning2Team.color}; vertical-align: middle;">${inning2Team.name.charAt(0)}</div>`;

            contentContainer.innerHTML = `
                <div class="rounded-2xl text-white p-6" style="background: linear-gradient(135deg, ${winningTeam.color}, ${losingTeam.color})">
                    <div class="text-center">
                         ${winningTeamLogoHtml}
                        <h2 class="text-3xl font-extrabold tracking-tight">${resultMessage}</h2>
                        <p class="text-sm opacity-80">Final Result</p>
                    </div>

                    <div class="summary-card rounded-xl p-4 my-6">
                         <div class="flex justify-between items-center">
                            <div class="w-2/5 text-left">
                                <p class="font-bold">${inning1Team.name}</p>
                            </div>
                            <div class="w-1/5 text-center font-bold text-lg">${inning1Summary.score}/${inning1Summary.wickets} <span class="text-sm font-normal opacity-70">(${Math.floor(inning1Summary.balls/6)}.${inning1Summary.balls%6})</span></div>
                            <div class="w-2/5 text-right">
                               <p class="font-bold">${inning2Team.name}</p>
                            </div>
                         </div>
                         <div class="flex justify-between items-center mt-1">
                            <div class="w-2/5 text-left">
                                ${inning1TeamLogoHtml}
                            </div>
                             <div class="w-1/5 text-center font-bold text-lg"><span class="text-sm font-normal opacity-70">vs</span></div>
                            <div class="w-2/5 text-right">
                                ${inning2TeamLogoHtml}
                            </div>
                         </div>
                         <div class="flex justify-between items-center mt-1">
                            <div class="w-2/5 text-left"></div>
                             <div class="w-1/5 text-center font-bold text-lg">${inning2Summary.score}/${inning2Summary.wickets} <span class="text-sm font-normal opacity-70">(${Math.floor(inning2Summary.balls/6)}.${inning2Summary.balls%6})</span></div>
                             <div class="w-2/5 text-right"></div>
                         </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="summary-card rounded-xl p-4">
                            <h3 class="font-bold text-yellow-300 mb-2">TOP BATTERS</h3>
                            <div class="space-y-1">${topBattersHTML}</div>
                        </div>
                        <div class="summary-card rounded-xl p-4">
                            <h3 class="font-bold text-cyan-300 mb-2">TOP BOWLERS</h3>
                            <div class="space-y-1">${topBowlersHTML}</div>
                        </div>
                    </div>

                    <div class="summary-card rounded-xl p-4 mt-4 text-center">
                        <h3 class="font-bold text-base text-yellow-300">⭐ MAN OF THE MATCH (SUGGESTION)</h3>
                        <p class="font-extrabold text-2xl mt-1">${motm.name}</p>
                        <p class="text-lg font-bold">${motmPerformance}</p>
                    </div>

                    <button onclick="closeModal('full-screen-message-modal'); returnToDashboard(false);" class="mt-6 w-full px-6 py-3 bg-white/90 text-black font-bold rounded-lg text-lg hover:bg-white transition-all">
                        Return to Dashboard
                    </button>
                </div>
            `;
            openModal('full-screen-message-modal');
        }

        function updatePointsTable(matchStatus, winningTeam) {
            const team1 = currentTournamentState.teams.find(t => t.id === liveMatchState.team1.id);
            const team2 = currentTournamentState.teams.find(t => t.id === liveMatchState.team2.id);
            
            team1.played++;
            team2.played++;

            if (matchStatus === 'win') {
                const winningTeamObj = winningTeam.id === team1.id ? team1 : team2;
                const losingTeamObj = winningTeam.id === team1.id ? team2 : team1;

                winningTeamObj.wins++;
                winningTeamObj.points += currentTournamentState.pointsRules.win;
                losingTeamObj.losses++;
                losingTeamObj.points += currentTournamentState.pointsRules.loss;
            } else if (matchStatus === 'tie') {
                team1.ties++;
                team2.ties++;
                team1.points += currentTournamentState.pointsRules.tie;
                team2.points += currentTournamentState.pointsRules.tie;
            }
            
            // Invalidate stats cache so leaderboards will be re-calculated
            tournamentStatsCache = null;
            localStorage.removeItem('cricker_leaderboards');

            renderPointsTable();
        }
        
        function updateKnockoutBracket(completedMatchId, winner) {
            // Part 1: Handle simple winner/loser progression for playoff formats
            const winnerPlaceholderId = `winner_${completedMatchId}`;
            const loserPlaceholderId = `loser_${completedMatchId}`;
            const winnerTeamId = winner ? winner.id : `tie_${completedMatchId}`;
            
            const completedMatch = currentTournamentState.fixtures.find(f => f.matchId === completedMatchId);
            const loserTeamId = winner && completedMatch ? (completedMatch.team1Id === winner.id ? completedMatch.team2Id : completedMatch.team1Id) : `tie_${completedMatchId}`;

            currentTournamentState.fixtures.forEach(f => {
                if (f.team1Id === winnerPlaceholderId) f.team1Id = winnerTeamId;
                if (f.team2Id === winnerPlaceholderId) f.team2Id = winnerTeamId;
                if (f.team1Id === loserPlaceholderId) f.team1Id = loserTeamId;
                if (f.team2Id === loserPlaceholderId) f.team2Id = loserTeamId;
            });

            // Part 2: Check if a league/group stage is complete to resolve rank-based placeholders
            const leagueFixtures = currentTournamentState.fixtures.filter(f => f.matchName.toLowerCase().includes('group') || f.matchName.toLowerCase().includes('round'));
            const areAllLeagueFixturesCompleted = leagueFixtures.length > 0 && leagueFixtures.every(f => f.status === 'completed');

            if (areAllLeagueFixturesCompleted) {
                const numGroups = parseInt(document.getElementById('number-of-groups').value) || 1;
                
                if (numGroups > 1) { // Multi-group logic
                    for (let i = 0; i < numGroups; i++) {
                        const groupChar = String.fromCharCode(65 + i);
                        const groupName = `Group ${groupChar}`;
                        const groupTeamIds = currentTournamentState.teams.filter(t => t.group === groupName).map(t => t.id);
                        const groupStandings = getTeamStandings(groupTeamIds);
                        
                        groupStandings.forEach((team, rankIndex) => {
                            const rank = rankIndex + 1;
                            const placeholderId = `placeholder_${groupChar}_${rank}`;
                            currentTournamentState.fixtures.forEach(f => {
                                if (f.team1Id === placeholderId) f.team1Id = team.id;
                                if (f.team2Id === placeholderId) f.team2Id = team.id;
                            });
                        });
                    }
                } else { // Single table logic (Round Robin, Playoffs)
                    const allTeamIds = currentTournamentState.teams.map(t => t.id);
                    const leagueStandings = getTeamStandings(allTeamIds);
                    
                    leagueStandings.forEach((team, rankIndex) => {
                        const rank = rankIndex + 1;
                        const placeholderId = `placeholder_rank_${rank}`;
                         currentTournamentState.fixtures.forEach(f => {
                            if (f.team1Id === placeholderId) f.team1Id = team.id;
                            if (f.team2Id === placeholderId) f.team2Id = team.id;
                        });
                    });
                }
            }
            renderFixtures();
        }

        function undo() { 
            if (liveMatchState.isLocked) return; 
            if (matchHistory.length > 0) { 
                liveMatchState = matchHistory.pop(); 
                updateUI(); 
                // Persist state after undo
                if (liveMatchState.matchId) localStorage.setItem('cricker_match_state', JSON.stringify(liveMatchState));
            } 
        }

        function toggleScoringLock() {
            liveMatchState.isLocked = !liveMatchState.isLocked;
            const lockBtn = document.getElementById('lock-btn');
            const scoringGrid = document.querySelector('.scoring-grid');
            if (liveMatchState.isLocked) {
                lockBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>`;
                scoringGrid.querySelectorAll('button').forEach(btn => btn.disabled = true);
                scoringGrid.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                lockBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z" /></svg>`;
                scoringGrid.querySelectorAll('button').forEach(btn => btn.disabled = false);
                scoringGrid.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        function updateUI() {
            updateHeader();
            updateScoreboard();
            updateBattingTable();
            updateBowlingTable();
            updateTargetInfo();
            updateRates();
            const lockBtn = document.getElementById('lock-btn');
            const scoringGrid = document.querySelector('.scoring-grid');
            const isCurrentlyLocked = liveMatchState.isLocked || liveMatchState.isScoringLocked;
            const freeHitIndicator = document.getElementById('free-hit-indicator');

            if (liveMatchState.freeHit) {
                freeHitIndicator.classList.remove('hidden');
            } else {
                freeHitIndicator.classList.add('hidden');
            }

            if (isCurrentlyLocked) {
                lockBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>`;
                scoringGrid.querySelectorAll('button').forEach(btn => btn.disabled = true);
                scoringGrid.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                 lockBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z" /></svg>`;
                scoringGrid.querySelectorAll('button').forEach(btn => btn.disabled = false);
                scoringGrid.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }
        
        function updateRates() {
            const battingTeam = liveMatchState[liveMatchState.battingTeam];
            const ballsPlayed = battingTeam.balls;
            
            if (ballsPlayed > 0) {
                const oversPlayed = ballsPlayed / liveMatchState.ballsPerOver;
                const crr = battingTeam.score / oversPlayed;
                document.getElementById('crr-display').textContent = crr.toFixed(2);
            } else {
                document.getElementById('crr-display').textContent = '0.00';
            }

            if (liveMatchState.innings === 2) {
                const runsNeeded = liveMatchState.target - battingTeam.score;
                const ballsRemaining = (liveMatchState.totalOvers * liveMatchState.ballsPerOver) - ballsPlayed;
                if (ballsRemaining > 0) {
                    const rrr = (runsNeeded / ballsRemaining) * liveMatchState.ballsPerOver;
                    document.getElementById('rrr-display').textContent = rrr.toFixed(2);
                } else {
                    document.getElementById('rrr-display').textContent = '0.00';
                }
            } else {
                 document.getElementById('rrr-display').textContent = '0.00';
            }
        }

        function updateHeader() {
            const team1 = liveMatchState.team1, team2 = liveMatchState.team2;
            const header = document.getElementById('match-header');
            header.innerHTML = `
                <h1 class="font-bold text-lg">${team1.name.toUpperCase()} vs ${team2.name.toUpperCase()}</h1>
                <p class="text-xs text-gray-500">${currentTournamentState.name} | ${liveMatchState.totalOvers} Overs, ${liveMatchState.playersPerSide}-a-side</p>
            `;
        }
        function updateScoreboard() {
            const battingTeam = liveMatchState[liveMatchState.battingTeam];
            const bowlingTeam = liveMatchState[liveMatchState.bowlingTeam];
            if(!battingTeam) return;

            const container = document.getElementById('team-scores-container');
            const overs = Math.floor(battingTeam.balls / liveMatchState.ballsPerOver);
            const ballsThisOver = battingTeam.balls % liveMatchState.ballsPerOver;
            
            const battingLogoHtml = battingTeam.logoUrl
                ? `<img src="${battingTeam.logoUrl}" alt="${battingTeam.name}" class="w-8 h-8 rounded-full object-cover">`
                : `<div class="w-8 h-8 rounded-full flex items-center justify-center font-bold text-white" style="background-color: ${battingTeam.color};">${battingTeam.name.charAt(0)}</div>`;

            const battingHTML = `<div class="flex items-center justify-between"><div class="flex items-center gap-3">${battingLogoHtml}<span class="font-semibold text-lg text-gray-800">${battingTeam.name}</span></div><div class="text-right"><p class="text-2xl font-extrabold text-gray-900">${battingTeam.score}/${battingTeam.wickets}</p><p class="text-sm text-gray-500">(${overs}.${ballsThisOver} / ${liveMatchState.totalOvers} ov)</p></div></div>`;
            
            let bowlingHTML = '';
            if (bowlingTeam) {
                const bowlingTeamOvers = Math.floor(bowlingTeam.balls / liveMatchState.ballsPerOver);
                const bowlingTeamBalls = bowlingTeam.balls % liveMatchState.ballsPerOver;
                const bowlingTeamScoreDisplay = (liveMatchState.innings > 1) ? `<p class="text-lg font-bold text-gray-700">${bowlingTeam.score}/${bowlingTeam.wickets}</p><p class="text-xs text-gray-500">(${bowlingTeamOvers}.${bowlingTeamBalls} ov)</p>` : `<p class="text-sm font-medium text-gray-500">Yet to bat</p>`;
                
                const bowlingLogoHtml = bowlingTeam.logoUrl
                    ? `<img src="${bowlingTeam.logoUrl}" alt="${bowlingTeam.name}" class="w-8 h-8 rounded-full object-cover">`
                    : `<div class="w-8 h-8 rounded-full flex items-center justify-center font-bold text-white" style="background-color: ${bowlingTeam.color};">${bowlingTeam.name.charAt(0)}</div>`;
                
                bowlingHTML = `<div class="flex items-center justify-between opacity-70"><div class="flex items-center gap-3">${bowlingLogoHtml}<span class="font-semibold text-lg text-gray-800">${bowlingTeam.name}</span></div><div class="text-right">${bowlingTeamScoreDisplay}</div></div>`;
            }
            container.innerHTML = battingHTML + bowlingHTML;
        }
        function updateBattingTable() {
            const table = document.getElementById('batting-table');
            let html = '';
            const s = liveMatchState.striker, ns = liveMatchState.nonStriker;
            if(s) html += `<tr><td class="p-2 font-semibold text-gray-800"><span class="striker-dot"></span>${s.name}</td><td class="text-center font-bold">${s.runs}</td><td class="text-center text-gray-600">${s.balls}</td><td class="text-center text-gray-600">${s.fours}</td><td class="text-center text-gray-600">${s.sixes}</td><td class="text-right text-gray-600">${(s.balls > 0 ? (s.runs/s.balls*100):0).toFixed(2)}</td></tr>`;
            if(ns) html += `<tr><td class="p-2 font-semibold text-gray-800">${ns.name}</td><td class="text-center font-bold">${ns.runs}</td><td class="text-center text-gray-600">${ns.balls}</td><td class="text-center text-gray-600">${ns.fours}</td><td class="text-center text-gray-600">${ns.sixes}</td><td class="text-right text-gray-600">${(ns.balls > 0 ? (ns.runs/ns.balls*100):0).toFixed(2)}</td></tr>`;
            table.innerHTML = html;
        }
        function updateBowlingTable() {
            const table = document.getElementById('bowling-table');
            const b = liveMatchState.bowler;
            if (!b) { table.innerHTML = ''; return; }

            const ballsPerOver = liveMatchState.ballsPerOver;
            const overs = `${Math.floor(b.ballsBowled / ballsPerOver)}.${b.ballsBowled % ballsPerOver}`;
            const econ = b.ballsBowled > 0 ? (b.runsConceded / (b.ballsBowled / ballsPerOver)).toFixed(2) : '0.00';
            
            const overSummaryHTML = liveMatchState.currentOverEvents.map((ball, index) => {
                let classes = 'w-8 h-8 flex items-center justify-center rounded-full text-sm font-bold ';
                const event = ball.event.toLowerCase();
                if (ball.dismissal) classes += 'bg-red-500 text-white';
                else if (event.includes('4') || event.includes('6')) classes += 'bg-blue-500 text-white';
                else if (event.includes('wd') || event.includes('nb')) classes += 'bg-yellow-400 text-black';
                else classes += 'bg-gray-200 text-gray-800';
                
                return `<div class="text-center">
                            <span class="${classes}">${ball.event}</span>
                            <p class="text-xs text-gray-500 mt-1">${Math.floor(b.ballsBowled / ballsPerOver)}.${index + 1}</p>
                        </div>`;
            }).join('');

            table.innerHTML = `<tr><td class="p-2 font-semibold text-gray-800">${b.name}</td><td class="text-center text-gray-600">${overs}</td><td class="text-center text-gray-600">${b.maidens}</td><td class="text-center text-gray-600">${b.runsConceded}</td><td class="text-center font-bold">${b.wickets}</td><td class="text-right text-gray-600">${econ}</td></tr>
                               <tr><td colspan="6" class="p-2"><div class="flex items-center gap-2">${overSummaryHTML}</div></td></tr>`;
        }

        function updateTargetInfo() {
            const container = document.getElementById('target-info-container');
            if (liveMatchState.innings === 2) {
                container.classList.remove('hidden');
                const battingTeam = liveMatchState[liveMatchState.battingTeam];
                const runsNeeded = liveMatchState.target - battingTeam.score;
                const ballsRemaining = (liveMatchState.totalOvers * liveMatchState.ballsPerOver) - battingTeam.balls;
                container.textContent = `Target: ${liveMatchState.target}. Need ${runsNeeded} runs in ${ballsRemaining} balls.`;
            } else {
                container.classList.add('hidden');
            }
        }
        
        // --- INITIALIZATION & SESSION PERSISTENCE ---

        // Helper function to clear session data when navigating home
        function clearSession() {
            localStorage.removeItem('cricker_current_view');
            localStorage.removeItem('cricker_tournament_state');
            localStorage.removeItem('cricker_match_state');
            sessionStorage.removeItem('fixtures_scroll_pos');
        }

        document.addEventListener('DOMContentLoaded', () => {
            const startDateInput = document.getElementById('start-date');
            if(startDateInput) startDateInput.value = new Date().toISOString().split('T')[0];
            
            loadSavedTeams();

            // Restore session state on page load
            const savedView = localStorage.getItem('cricker_current_view');
            if (savedView) {
                const savedTournamentState = localStorage.getItem('cricker_tournament_state');
                const savedMatchState = localStorage.getItem('cricker_match_state');

                if (savedTournamentState) {
                    currentTournamentState = JSON.parse(savedTournamentState);
                }
                if (savedMatchState) {
                    liveMatchState = JSON.parse(savedMatchState);
                }

                document.getElementById('tournament-choice-screen').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');

                switch (savedView) {
                    case 'tournament-dashboard':
                        document.getElementById('tournament-setup').classList.add('hidden');
                        document.getElementById('tournament-dashboard').classList.remove('hidden');
                        displayDashboard();
                        // Restore scroll position for fixtures
                        const scrollPos = sessionStorage.getItem('fixtures_scroll_pos');
                        if (scrollPos) {
                            setTimeout(() => { // Timeout ensures content is rendered before scrolling
                                document.getElementById('fixtures-list').scrollTop = parseInt(scrollPos, 10);
                            }, 100);
                        }
                        break;
                    case 'toss-screen':
                        document.getElementById('tournament-flow').classList.add('hidden');
                        document.getElementById('scorer-section').classList.remove('hidden');
                        document.getElementById('toss-screen').classList.remove('hidden');
                        document.getElementById('scorer-app').classList.add('hidden');
                        setupTossScreen(liveMatchState.team1, liveMatchState.team2);
                        break;
                    case 'scorer-app':
                        document.getElementById('tournament-flow').classList.add('hidden');
                        document.getElementById('scorer-section').classList.remove('hidden');
                        document.getElementById('toss-screen').classList.add('hidden');
                        document.getElementById('scorer-app').classList.remove('hidden');
                        document.getElementById('scorer-app').classList.add('flex');
                        updateUI();
                        break;
                    default: // Includes 'tournament-setup' and any invalid state
                        document.getElementById('tournament-setup').classList.remove('hidden');
                        document.getElementById('tournament-dashboard').classList.add('hidden');
                        break;
                }
            }

            // Add listeners to home buttons to clear session state
            document.querySelectorAll('a[href="index.html"]').forEach(a => {
                a.addEventListener('click', clearSession);
            });

            // Save scroll position for fixtures list
            const fixturesList = document.getElementById('fixtures-list');
            if (fixturesList) {
                fixturesList.addEventListener('scroll', (e) => {
                    sessionStorage.setItem('fixtures_scroll_pos', e.target.scrollTop);
                });
            }

            // --- Original Event Listeners ---
            const alertOkBtn = document.getElementById('alert-ok-btn');
            if(alertOkBtn) alertOkBtn.onclick = () => { if(alertCallback) { alertCallback(); alertCallback = null; } closeModal('alert-modal'); };
            
            const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
            if(confirmCancelBtn) confirmCancelBtn.onclick = () => { confirmCallback = null; closeModal('confirm-modal');};
            
            const confirmOkBtn = document.getElementById('confirm-ok-btn');
            if(confirmOkBtn) confirmOkBtn.onclick = () => { if(confirmCallback) confirmCallback(); confirmCallback = null; closeModal('confirm-modal'); };

            const createMatchBtn = document.getElementById('create-match-btn');
            if(createMatchBtn) createMatchBtn.onclick = openCreateMatchModal;

            const confirmCreateMatchBtn = document.getElementById('confirm-create-match-btn');
            if(confirmCreateMatchBtn) confirmCreateMatchBtn.onclick = createMatch;

            const tossWinner1 = document.getElementById('toss-winner-team1');
            if(tossWinner1) tossWinner1.onclick = () => selectTossWinner('team1');

            const tossWinner2 = document.getElementById('toss-winner-team2');
            if(tossWinner2) tossWinner2.onclick = () => selectTossWinner('team2');

            const tossChoiceBat = document.getElementById('toss-choice-bat');
            if(tossChoiceBat) tossChoiceBat.onclick = () => selectTossChoice('bat');
            
            const tossChoiceBowl = document.getElementById('toss-choice-bowl');
            if(tossChoiceBowl) tossChoiceBowl.onclick = () => selectTossChoice('bowl');

            const startMatchBtn = document.getElementById('start-match-btn');
            if(startMatchBtn) startMatchBtn.onclick = startMatch;

            const bowlerPrompt = document.getElementById('bowler-prompt-overlay');
            if(bowlerPrompt) bowlerPrompt.onclick = async () => {
                bowlerPrompt.classList.add('hidden');
                liveMatchState.bowler = await selectPlayer('bowler');
                liveMatchState.isScoringLocked = false; 
                updateUI(); 
            };

            const toggleCommentaryBtn = document.getElementById('toggle-commentary-btn');
            if (toggleCommentaryBtn) {
                toggleCommentaryBtn.addEventListener('click', () => {
                    const content = document.getElementById('live-commentary-content');
                    const chevron = document.getElementById('commentary-chevron');
                    content.classList.toggle('hidden');
                    chevron.classList.toggle('rotate-180');
                });
            };
        });
    </script>
</body>
</html>