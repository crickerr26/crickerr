<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Match Live Stream</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

    <style>
        body { margin: 0; background: #000; font-family: sans-serif; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
        
        /* LOGIN SCREEN */
        #login-screen {
            position: absolute; inset: 0; z-index: 10;
            background: radial-gradient(circle, #1e293b, #000);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        input {
            background: rgba(255,255,255,0.1); border: 2px solid #333;
            color: #fbbf24; font-size: 24px; padding: 15px; text-align: center;
            border-radius: 10px; margin-bottom: 20px; text-transform: uppercase;
            outline: none; font-weight: bold; width: 250px;
        }
        button {
            background: linear-gradient(135deg, #fbbf24, #d97706);
            border: none; padding: 15px 40px; font-size: 18px; font-weight: bold;
            border-radius: 50px; cursor: pointer; color: black;
            box-shadow: 0 4px 15px rgba(251, 191, 36, 0.4);
        }
        button:hover { transform: scale(1.05); }

        /* VIDEO PLAYER */
        #video-container { width: 100%; height: 100%; position: relative; display: none; }
        video { width: 100%; height: 100%; object-fit: contain; }
        
        /* STATUS OVERLAY */
        #status-msg {
            position: absolute; top: 20px; left: 20px;
            background: rgba(0,0,0,0.6); color: white;
            padding: 8px 16px; border-radius: 20px;
            display: flex; align-items: center; gap: 8px;
            font-size: 14px; pointer-events: none;
        }
        .dot { width: 10px; height: 10px; background: #ef4444; border-radius: 50%; }
        .blink { animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }
    </style>
</head>
<body>

    <div id="login-screen">
        <h1 style="color:white; margin-bottom: 5px;">LIVE CRICKET</h1>
        <p style="color:#888; margin-bottom: 30px;">ENTER MATCH ID</p>
        <input type="text" id="match-id" placeholder="MATCH ID">
        <button onclick="joinStream()">WATCH LIVE</button>
        <p id="error-msg" style="color:#ef4444; margin-top: 20px;"></p>
    </div>

    <div id="video-container">
        <video id="remote-video" autoplay playsinline controls></video>
        <div id="status-msg"><div class="dot blink"></div> LIVE</div>
    </div>

    <script>
        // CONFIG MUST MATCH YOUR BROADCASTER APP
        const firebaseConfig = { 
            apiKey: "AIzaSyBqcD59IAPpKqk98oDZkgzgkoVZ8b8LGgY", 
            authDomain: "livecricketscoring-92087.firebaseapp.com", 
            databaseURL: "https://livecricketscoring-92087-default-rtdb.firebaseio.com", 
            projectId: "livecricketscoring-92087", 
            storageBucket: "livecricketscoring-92087.firebasestorage.app", 
            messagingSenderId: "522927197627", 
            appId: "1:522927197627:web:f1df5db736cae96893089e" 
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        function joinStream() {
            const matchId = document.getElementById('match-id').value.trim().toUpperCase();
            if(!matchId) return;

            const btn = document.querySelector('button');
            btn.innerText = "CONNECTING...";
            btn.disabled = true;
            
            // 1. Listen to DB for Stream ID
            db.collection("live_matches").doc(matchId).onSnapshot(doc => {
                if(doc.exists && doc.data().isStreaming && doc.data().streamId) {
                    document.getElementById('error-msg').innerText = "Found Match! establishing connection...";
                    connectToPeer(doc.data().streamId);
                } else {
                    document.getElementById('error-msg').innerText = "Waiting for Broadcaster to go live...";
                    btn.innerText = "WAITING...";
                }
            });
        }

        function connectToPeer(targetPeerId) {
            const peer = new Peer({
                config: {
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' }
                    ]
                }
            });
            
            peer.on('open', (id) => {
                console.log("My Viewer ID: " + id);
                
                // Create dummy audio to keep connection alive
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const dest = ctx.createMediaStreamDestination();
                const dummyStream = dest.stream;

                const call = peer.call(targetPeerId, dummyStream);
                
                call.on('stream', (remoteStream) => {
                    console.log("Stream received!");
                    document.getElementById('login-screen').style.display = 'none';
                    document.getElementById('video-container').style.display = 'block';
                    const video = document.getElementById('remote-video');
                    
                    video.srcObject = remoteStream;
                    video.muted = true; // CRITICAL: Mute required for autoplay to work
                    
                    const playPromise = video.play();
                    if (playPromise !== undefined) {
                        playPromise.catch(error => {
                            console.log("Autoplay blocked. Showing button.");
                            const playBtn = document.createElement('button');
                            playBtn.innerText = "TAP TO START VIDEO";
                            playBtn.style.cssText = "position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); z-index:100; box-shadow: 0 0 20px black;";
                            playBtn.onclick = () => { video.play(); playBtn.remove(); };
                            document.body.appendChild(playBtn);
                        });
                    }
                });

                call.on('close', () => {
                    alert("Stream Ended");
                    location.reload();
                });
                
                call.on('error', (err) => {
                    console.error("Call Error:", err);
                    document.getElementById('error-msg').innerText = "Stream dropped. Retrying...";
                });
            });
            
            peer.on('error', (err) => {
                console.error("Peer Error:", err);
                document.getElementById('error-msg').innerText = "Connection Failed: " + err.type;
                const btn = document.querySelector('button');
                btn.disabled = false;
                btn.innerText = "RETRY";
            });
        }
    </script>
</body>
</html>
