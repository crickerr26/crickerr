<head>
    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Cricker - Live Scoring</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb"/>
    <link rel="apple-touch-icon" href="icon-512.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
<style>
    /* --- Pitch Map Modal Styles --- */
        #pitch-map-svg .shot-zone {
            transition: fill 0.2s ease-in-out;
            stroke: #fff;
            stroke-width: 1px;
        }
        #pitch-map-svg .shot-zone:hover {
            fill: rgba(37, 99, 235, 0.5) !important;
        }
        #pitch-map-svg text {
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            fill: #333;
            pointer-events: none;
            user-select: none;
        }
  /* ... some of your CSS rules ... */
  #bowler-prompt-overlay:not(.hidden) + .scoring-grid {
    visibility: hidden;
  }

  /* Full-screen layout and font size for setup pages on mobile */
  @media (max-width: 768px) {
    /* ... all of your other CSS rules ... */
  }

  /* ... all the rest of your styles ... */
  
 .scoring-grid button:nth-last-child(-n+4) {
    border-bottom: none;
  }

        /* Full-screen layout and font size for setup pages on mobile */
        @media (max-width: 768px) {
            body { font-size: 14px; }
            #setup-screen, #choice-screen { padding: 0; }
            .setup-card, .choice-card { max-width: 100%; min-height: 100vh; border-radius: 0; box-shadow: none; border: none; }
            
            /* --- Mobile Scoring Screen Layout --- */
            #app {
                overflow: hidden; /* Prevent the whole app from scrolling */
            }
            #app > .flex-grow {
                padding: 8px; /* Reduce padding on mobile */
                display: flex;
                flex-direction: column;
            }
            #match-header h1 {
                font-size: 1rem; /* Smaller headline */
                font-weight: 700;
            }
            #match-header p {
                font-size: 0.65rem; /* Smaller sub-headline */
            }
            .lg\\:col-span-2, .lg\\:col-span-1 {
                overflow-y: hidden; /* We will control scrolling inside specific elements instead */
            }
             .lg\\:col-span-2 {
                flex-grow: 1; /* This section now grows to fill available space */
                min-height: 0;
                display: flex;
                flex-direction: column;
            }
            .lg\\:col-span-2 > .space-y-2 {
                flex-grow: 1;
                overflow-y: auto;
                min-height: 0;
            }
            .lg\\:col-span-1 {
                flex-shrink: 0;
                display: flex; 
                flex-direction: column; 
                min-height: 0;
            }
            #scoring-controls {
                display: flex;
                flex-direction: column; 
            }
            .scoring-grid {
                 /* No longer need to force height */
            }
            .scoring-grid button {
                padding-top: 8px;
                padding-bottom: 8px;
                font-size: 0.875rem; 
            }
            .scoring-grid button:nth-last-child(-n+4) {
                padding-top: 4px; /* Reduced padding */
                padding-bottom: 4px; /* Reduced padding */
                font-size: 0.8rem; /* Stays the same, already small */
                min-height: 44px; /* Ensures it's easy to tap */
            }
            .scoring-grid button > .text-xl {
                font-size: 1.125rem;
            }
             .scoring-grid button > .text-xs {
                font-size: 0.7rem;
                margin-top: 1px;
            }
            #live-commentary-box {
    padding: 0.2rem 0.5rem; /* Further reduced vertical padding */
}
#live-commentary-content {
    margin-top: 0.1rem; 
    padding-top: 0.15rem; /* Tighter space above text */
}
#live-commentary { 
    font-size: 0.6rem; /* Slightly smaller font for mobile */
    line-height: 0.85rem; /* Further reduced line height */
}
            #scoreboard {
                padding: 4px;
            }
            
            /* --- NEW: Compact table layout on mobile --- */
            #batting-table th, #batting-table td, #bowling-table th, #bowling-table td {
                padding: 3px 1px; /* UPDATED: Made padding much smaller */
                font-size: 0.75rem; /* UPDATED: Slightly smaller text */
            }
            #batting-table td:first-child, #bowling-table td:first-child {
                 font-size: 0.75rem; /* Make player names smaller to fit better */
                 font-weight: 500;
            }
            #batting-table th.p-1, #bowling-table th.p-1 {
                font-size: 0.7rem; /* Smaller header font */
            }
        }

        /* --- SPLASH SCREEN STYLES --- */
        #splash-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #f0f2f5; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.75s ease-out; }
        #splash-logo { 
            width: 120px; 
            margin-bottom: 1rem; 
            animation: splash-logo-animation 1.2s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }
        #splash-text { 
            font-size: 0.8rem; 
            font-family: 'Inter', sans-serif; 
            color: #475569; 
            opacity: 0;
            animation: splash-text-animation 1s ease-in 0.5s forwards;
        }

        @keyframes splash-logo-animation { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
        @keyframes splash-text-animation { from { opacity: 0; } to { opacity: 1; } }

        /* General Styles */
        select.placeholder { color: #9ca3af; font-size: 0.9em; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        .modal-overlay { transition: opacity 0.3s ease-in-out; }
        .modal-content { transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out; }

        /* Setup Screen Styles */
        .setup-bg { background-color:#f0f2f5; }
        .setup-card { background: #ffffff; border: 1px solid #e2e8f0; transition: box-shadow 0.3s ease-in-out; }
        .setup-step { transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out; }
        .setup-step.hidden { opacity: 0; transform: translateX(30px) scale(0.98); position: absolute; pointer-events: none; }
        .setup-step.active { opacity: 1; transform: translateX(0) scale(1); }
        .progress-bar-fill { background-color: #2563eb; transition: width 0.5s ease-in-out; }
        .setup-btn { background-color: #2563eb; background-image: linear-gradient(to right, #2563eb, #1d4ed8); transition: all 0.3s ease; }
        .setup-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.3), 0 4px 6px -2px rgba(37, 99, 235, 0.15); }
        .back-btn { color: #475569; transition: color 0.2s; }
        .back-btn:hover { color: #1e293b; }
        
        #setup-screen {
            overflow-y: auto; 
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        #setup-screen::-webkit-scrollbar {
            display: none;
        }

        /* Toss Screen Styles */
        .toss-3d-button { border-radius: 0.75rem; color: #1f2937; font-weight: 600; background-color: #f9fafb; border: 1px solid #d1d5db; box-shadow: 0 4px 6px rgba(0,0,0,0.05); transition: all 0.15s ease-out; transform: translateY(0); }
.toss-3d-button:active { transform: translateY(2px); box-shadow: 0 2px 3px rgba(0,0,0,0.1); }
.toss-3d-button.selected { background-color: #2563eb; border-color: #1d4ed8; color: white; box-shadow: 0 2px 3px rgba(0,0,0,0.2); transform: translateY(2px); outline: none; }
.ripple { position: absolute; border-radius: 50%; background-color: rgba(156, 163, 175, 0.4); transform: scale(0); animation: ripple-effect 0.7s ease-out; pointer-events: none; }
@keyframes ripple-effect { to { transform: scale(4); opacity: 0; } }

        /* Event Animation Styles */
        .event-text-animation { animation: event-animation 1.5s ease-in-out forwards; }
        @keyframes event-animation { 0% { opacity: 0; transform: scale(0.8); } 20% { opacity: 1; transform: scale(1.1); } 80% { opacity: 1; transform: scale(1.1); } 100% { opacity: 0; transform: scale(0.8); } }

        /* Scoring & UI Polish */
        .highlight-score { animation: score-flash 0.6s ease-out; }
        @keyframes score-flash { 0% { background-color: transparent; } 50% { background-color: #bfdbfe; transform: scale(1.05); } 100% { background-color: transparent; transform: scale(1); } }
        .tab-button.active { border-color: #2563eb; background-color: #2563eb; color: white; }

        /* Scoreboard & Table Styles */
        #scoreboard { padding: 8px; }
        #team-scores-container > div { padding: 2px 0; }
        #batting-table, #bowling-table { table-layout: fixed; width: 100%; }
        #batting-table th, #batting-table td, #bowling-table th, #bowling-table td { padding: 4px 3px; font-size: 0.75rem; }
        #batting-table th:first-child, #batting-table td:first-child, #bowling-table th:first-child, #bowling-table td:first-child { padding-left: 8px; }
        #batting-table th:last-child, #batting-table td:last-child, #bowling-table th:last-child, #bowling-table td:last-child { padding-right: 8px; text-align: right; }
        #batting-table .font-semibold, #bowling-table .font-semibold { font-size: 0.8rem; }
        .target-highlight { color: #1e3a8a; }

        /* Player Out Summary Animation */
        .summary-pop-in-animation { animation: summary-pop-in 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; }
        @keyframes summary-pop-in { 0% { opacity: 0; transform: translateY(20px) scale(0.9); } 100% { opacity: 1; transform: translateY(0) scale(1); } }
        
        /* Innings Break Modal Animation */
        #innings-break-modal .modal-content { transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.4s ease; }
        .modal-overlay.hidden .modal-content { transform: scale(0.8) !important; opacity: 0 !important; }
        .target-container { animation: pulse-bg 2.5s infinite; }
        @keyframes pulse-bg { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(234, 179, 8, 0.7); } 70% { transform: scale(1.02); box-shadow: 0 0 0 12px rgba(234, 179, 8, 0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(234, 179, 8, 0); } }

        /* Win Modal Styles & Animations */
        #win-modal .win-modal-content { 
            background: radial-gradient(circle, #2d3748 0%, #1a202c 100%); 
            position: relative; /* Ensure content is above the fixed confetti */
            z-index: 10;
        }
        
        /* Celebration - Confetti */
        #confetti-container {
            position: fixed; /* Changed from absolute */
            inset: 0;
            pointer-events: none;
            z-index: 5; /* Behind modal content, but inside modal overlay */
        }
        #confetti-container i { 
            position: absolute; 
            width: 8px; 
            height: 16px; 
            background: #fde047; 
            top: -20px; 
            opacity: 0; 
            animation: confetti-fall 4s linear infinite; 
        }
        @keyframes confetti-fall { 
            0% { transform: translateY(0) rotate(0); opacity: 1; } 
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; } 
        }

        /* Celebration - Fireworks */
        .firework {
            position: absolute;
            width: 4px;
            height: 4px;
            background: white;
            border-radius: 50%;
            opacity: 1;
            animation: firework-burst 1.2s ease-out forwards;
        }
        @keyframes firework-burst {
            0% { transform: scale(0.5); opacity: 1; }
            100% { transform: scale(25); opacity: 0; }
        }

        /* Celebration - Victory Glow */
        .victory-glow {
            animation: victory-glow-animation 1.5s ease-in-out infinite alternate;
        }
        @keyframes victory-glow-animation {
            from { box-shadow: 0 0 15px 5px rgba(253, 224, 71, 0.5), 0 0 5px 2px rgba(255, 255, 255, 0.7); }
            to   { box-shadow: 0 0 25px 10px rgba(253, 224, 71, 0.7), 0 0 10px 4px rgba(255, 255, 255, 1); }
        }
        #win-modal h2.victory-glow {
             text-shadow: 0 0 10px rgba(253, 224, 71, 0.7);
             animation: victory-glow-text-animation 1.5s ease-in-out infinite alternate;
        }
         @keyframes victory-glow-text-animation {
            from { text-shadow: 0 0 10px rgba(253, 224, 71, 0.5); }
            to   { text-shadow: 0 0 20px rgba(253, 224, 71, 0.8); }
        }

        /* MoM Picker Styles */
        #wm-mom-picker-list label {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 0.375rem;
            cursor: pointer;
            transition: background-color 0.2s;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        #wm-mom-picker-list label:hover {
            background-color: rgba(255, 255, 255, 0.15);
        }
        #wm-mom-picker-list input[type="radio"] {
            -webkit-appearance: none;
            appearance: none;
            background-color: #fff;
            margin-right: 0.75rem;
            font: inherit;
            color: currentColor;
            width: 1.15em;
            height: 1.15em;
            border: 0.15em solid currentColor;
            border-radius: 50%;
            transform: translateY(-0.075em);
            display: grid;
            place-content: center;
            border-color: #9ca3af;
        }
        #wm-mom-picker-list input[type="radio"]::before {
            content: "";
            width: 0.65em;
            height: 0.65em;
            border-radius: 50%;
            transform: scale(0);
            transition: 120ms transform ease-in-out;
            box-shadow: inset 1em 1em #3b82f6;
        }
        #wm-mom-picker-list input[type="radio"]:checked {
            border-color: #3b82f6;
        }
        #wm-mom-picker-list input[type="radio"]:checked::before {
            transform: scale(1);
        }
        #wm-mom-picker-list .mom-picker-name {
            font-weight: 600;
            color: white;
        }
        #wm-mom-picker-list .mom-picker-perf {
            font-size: 0.75rem;
            color: #d1d5db;
        }
        
        /* Standard Animations */
        #win-modal .animate-pop-in { animation: pop-in 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; opacity: 0; transform: scale(0.5); }
        #win-modal .animate-slide-up { animation: slide-up 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; opacity: 0; transform: translateY(20px); animation-delay: var(--delay, 0s); }
        @keyframes pop-in { to { opacity: 1; transform: scale(1); } }
        @keyframes slide-up { to { opacity: 1; transform: translateY(0); } }

        /* FIX: Set team name color to white in scorelines */
        #win-modal [id^="wm-scoreline-"] span:first-child {
            color: white;
        }

        /* Respect Reduced Motion */
        @media (prefers-reduced-motion: reduce) {
            #confetti-container i, .firework {
                animation: none;
                display: none;
            }
            .victory-glow, #win-modal h2.victory-glow {
                animation: none;
            }
            #win-modal .animate-pop-in, #win-modal .animate-slide-up {
                animation: none;
                opacity: 1;
                transform: none;
            }
        }

        /* --- FINAL LAYOUT FIX --- */
        #scoring-controls {
            display: flex;
            flex-direction: column;
        }
        .scoring-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: 1fr 1fr 0.7fr; /* Makes the 3rd row shorter */
            flex-grow: 1;
        }
        /* NEW: Compact styles for the bottom row of scoring buttons on all screens */
        .scoring-grid button:nth-last-child(-n+4) {
            font-size: 1rem;    /* Reduces font size from the default */
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
        }
        .scoring-grid button {
            border-bottom: 1px solid #e0e0e0;
            border-right: 1px solid #e0e0e0;
        }
        .scoring-grid button:nth-child(4n) {
            border-right: none;
        }
        .scoring-grid button:nth-last-child(-n+4) {
            border-bottom: none;
        }
        .apple-card {
            background: linear-gradient(145deg, #ffffff, #e9eef2);
            border: 1px solid rgba(0, 0, 0, 0.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.04);
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        .apple-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.08);
            border-color: rgba(0, 0, 0, 0.08);
        }
        #live-commentary-box {
    padding: 0.3rem 0.75rem; /* Makes the box slimmer */
}
#live-commentary-content {
    margin-top: 0.25rem;
    padding-top: 0.25rem;
}
#live-commentary {
    font-size: 0.8rem; /* 12.8px, smaller than default */
    line-height: 1.2;  /* Tighter line spacing */
}
/* --- Upgraded Edit Match Modal Styles --- */
/* --- Contextual Over Editor Styles --- */
        .over-chips-display { cursor: pointer; }
        .over-chip { position: relative; transition: transform 0.2s, box-shadow 0.2s; }
        .over-chip:hover { transform: translateY(-2px); }
        .over-chip.active {
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.5);
            transform: scale(1.1);
            background-color: #dbeafe;
        }

        #over-edit-popover {
            display: none;
            position: absolute;
            z-index: 100;
            background: white;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            width: 320px;
            overflow: hidden;
        }
        #over-edit-popover .options-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 4px;
            padding: 8px;
        }
        #over-edit-popover .options-grid button {
            padding: 8px;
            font-size: 0.8rem;
            font-weight: 600;
            border-radius: 4px;
            background-color: #f3f4f6;
            transition: background-color 0.2s;
        }
        #over-edit-popover .options-grid button:hover { background-color: #e5e7eb; }
        #over-edit-popover .actions-footer {
            display: flex;
            justify-content: space-around;
            background-color: #f9fafb;
            padding: 8px;
            border-top: 1px solid #eee;
        }
        #over-edit-popover .actions-footer button {
            font-size: 0.8rem;
            font-weight: 700;
            padding: 6px 12px;
            border-radius: 4px;
        }
        #over-edit-popover .actions-footer .btn-delete { background-color: #fee2e2; color: #b91c1c; }
        #over-edit-popover .actions-footer .btn-delete:hover { background-color: #fecaca; }
        .edit-team-panel.highlight {
            border-color: #2563eb;
            box-shadow: 0 0 0 2px #2563eb;
            background-color: #eff6ff;
        }
        
        /* --- NEW: Apple Watery/Glassmorphism Theme for Edit Modal --- */
        .glass-modal-content {
            background-color: rgba(243, 244, 246, 0.8); /* gray-100/80 */
            backdrop-filter: blur(16px) saturate(180%);
            -webkit-backdrop-filter: blur(16px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .glass-section {
            background-color: rgba(255, 255, 255, 0.6); /* white/60 */
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
        }

        .glass-input, .glass-select {
            background-color: rgba(229, 231, 235, 0.5); /* gray-200/50 */
            border: 1px solid rgba(209, 213, 219, 0.5); /* gray-300/50 */
            color: #1f2937;
            border-radius: 0.5rem;
            padding: 0.6rem 0.75rem;
            transition: all 0.2s ease-in-out;
        }
        .glass-input:focus, .glass-select:focus {
            outline: none;
            border-color: rgba(59, 130, 246, 0.7); /* blue-500/70 */
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
            background-color: rgba(255, 255, 255, 0.7);
        }

        .glass-button-primary {
            background-color: rgba(37, 99, 235, 0.9); /* blue-600/90 */
            color: white;
            font-weight: 600;
            border-radius: 0.5rem;
            padding: 0.65rem 1.25rem;
            transition: all 0.2s ease-in-out;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
        }
        .glass-button-primary:hover {
            background-color: rgba(29, 78, 216, 1); /* blue-700 */
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }

        .glass-button-secondary {
            background-color: rgba(255, 255, 255, 0.7);
            color: #374151;
            font-weight: 600;
            border-radius: 0.5rem;
            padding: 0.65rem 1.25rem;
            transition: all 0.2s ease-in-out;
            border: 1px solid rgba(209, 213, 219, 0.7);
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05), 0 1px 2px -1px rgba(0, 0, 0, 0.05);
        }
        .glass-button-secondary:hover {
            background-color: rgba(249, 250, 251, 1); /* gray-50 */
            border-color: rgba(156, 163, 175, 1);
        }

        .edit-tab { /* Modified from original .edit-tab */
            padding: 0.5rem 1rem;
            font-weight: 600;
            color: #4b5563;
            border-radius: 0.5rem;
            border: 2px solid transparent;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }
        .edit-tab.active {
            color: #1e3a8a;
            background-color: rgba(219, 234, 254, 0.7); /* blue-100/70 */
            border-color: rgba(96, 165, 250, 0.5); /* blue-400/50 */
        }
        
        .player-list-editor { max-height: 200px; overflow-y: auto; padding-right: 0.5rem; }
        .player-list-editor .player-edit-row { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem; }
        .player-list-editor .player-avatar-uploader { position: relative; flex-shrink: 0; width: 40px; height: 40px; }
        .player-list-editor .player-avatar-uploader img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 2px solid #e5e7eb; }
        .player-list-editor .player-avatar-uploader .overlay { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background-color: rgba(0,0,0,0.4); color: white; border-radius: 50%; opacity: 0; transition: opacity 0.2s; cursor: pointer; }
        .player-list-editor .player-avatar-uploader:hover .overlay { opacity: 1; }
        .player-list-editor .player-avatar-uploader input[type="file"] { display: none; }
        .player-list-editor input[type="text"] { flex-grow: 1; }

        .logo-uploader { position: relative; width: 80px; height: 80px; }
        .logo-uploader img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 2px solid #e5e7eb; }
        .logo-uploader .overlay { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background-color: rgba(0,0,0,0.4); color: white; border-radius: 50%; opacity: 0; transition: opacity 0.2s; cursor: pointer; }
        .logo-uploader:hover .overlay { opacity: 1; }
        .logo-uploader input[type="file"] { display: none; }

        .mini-scoring-pad { display: grid; grid-template-columns: repeat(6, 1fr); gap: 0.5rem; }
        .mini-scoring-pad button { padding: 0.5rem; font-weight: 600; border-radius: 0.25rem; background-color: #f3f4f6; transition: background-color 0.2s; }
        .mini-scoring-pad button:hover { background-color: #e5e7eb; }
        .mini-scoring-pad button.undo { background-color: #fed7aa; }
        .mini-scoring-pad button.clear { background-color: #fecaca; }

        .over-chips-display { display: flex; flex-wrap: wrap; gap: 0.25rem; padding: 0.5rem; background-color: #e5e7eb; border-radius: 0.25rem; min-height: 40px; }
        .over-chip { padding: 0.25rem 0.5rem; background-color: white; border-radius: 999px; font-weight: 500; font-size: 0.8rem; }
/* --- Professional End Match Modal Styles --- */
.end-match-step { display: none; }
.end-match-step.active { display: block; }

.outcome-card {
    border: 1px solid #e5e7eb;
    border-radius: 0.5rem;
    padding: 0.75rem;
    cursor: pointer;
    transition: all 0.2s ease-in-out;
    background-color: #f9fafb;
}
.outcome-card:hover {
    border-color: #9ca3af;
    background-color: #f3f4f6;
}
.outcome-card.selected {
    border-color: #2563eb;
    background-color: #eff6ff;
    box-shadow: 0 0 0 2px #2563eb;
}
.outcome-card h4 { font-weight: 600; color: #1f2937; }
.outcome-card p { font-size: 0.8rem; color: #6b7280; }

#end-match-dynamic-fields .field-group {
    display: none;
    padding: 1rem;
    border: 1px solid #e5e7eb;
    border-radius: 0.5rem;
    margin-top: 1rem;
    background-color: #ffffff;
}

#end-match-summary-preview {
    background-color: #f3f4f6;
    padding: 0.75rem;
    border-radius: 0.375rem;
    font-weight: 600;
    color: #1e3a8a;
    text-align: center;
    min-height: 40px;
    transition: background-color 0.2s;
}
        /* --- ICC Match Summary Styles --- */
        #summary-content { font-family: 'Inter', sans-serif; }
        .summary-team-header { font-weight: 600; font-size: 0.9rem; flex-shrink: 0; }
        .summary-team-logo { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 1px solid #eee; flex-shrink: 0;}

        .summary-score-strip { display: flex; align-items: center; padding: 0.6rem; border-radius: 0.375rem; background-color: #f9fafb; border: 1px solid #f3f4f6; }
        .summary-score-strip .team-name { font-weight: 700; font-size: 1rem; }
        .summary-score-strip .score { font-weight: 800; font-size: 1.1rem; margin-left: auto; }
        .summary-score-strip .overs, .summary-score-strip .rr { font-size: 0.8rem; color: #6b7280; margin-left: 0.5rem; }
        .summary-score-strip .target { font-size: 0.85rem; font-weight: 600; color: #1d4ed8; margin-left: 1rem; }

        /* Innings Tabs */
        .summary-tabs { display: flex; border-bottom: 1px solid #e5e7eb; }
        .summary-tab { flex: 1; text-align: center; padding: 0.75rem 0.5rem; font-weight: 600; color: #6b7280; cursor: pointer; background-color: #f9fafb; border: 0; border-bottom: 2px solid transparent; transition: all 0.2s; }
        .summary-tab[aria-selected="true"] { color: #1d4ed8; border-color: #2563eb; background-color: #fff; }
        .summary-innings-panel[hidden] { display: none; }

        .summary-innings-card h3 { font-size: 1.1rem; font-weight: 700; padding: 0.6rem; background-color: #f3f4f6; border-radius: 0.375rem; margin-bottom: 0.5rem; position: sticky; top: 0; z-index: 10; }
        .summary-table-container { overflow-x: auto; }
        .summary-table { width: 100%; border-collapse: collapse; min-width: 600px; }
        .summary-table th, .summary-table td { padding: 0.6rem 0.5rem; text-align: left; border-bottom: 1px solid #f3f4f6; font-size: 0.85rem; white-space: nowrap; }
        .summary-table th { font-weight: 600; color: #4b5563; font-size: 0.75rem; text-transform: uppercase; }
        .summary-table tr:nth-child(even) { background-color: #f9fafb; }
        .summary-table .text-right { text-align: right; }
        .summary-table .font-bold { font-weight: 700; }
        .summary-table .text-gray-500 { color: #6b7280; font-size: 0.8rem; }
        .summary-table .striker-star { color: #ef4444; font-weight: 700; }

        .summary-extras-row td, .summary-total-row td { font-weight: 600; }
        .summary-fow-section h4 { font-weight: 700; margin-top: 1.5rem; margin-bottom: 0.5rem; }
        .summary-fow-list { color: #374151; font-size: 0.85rem; line-height: 1.6; }
        .summary-fow-list span { margin-right: 0.75rem; }

        #summary-motm-card { background-color: #fefce8; border: 1px solid #fde047; border-radius: 0.5rem; padding: 1rem; text-align: center; }
        #summary-motm-card h3 { color: #a16207; font-weight: 700; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 0.05em; }
        #summary-motm-card .motm-name { font-size: 1.75rem; font-weight: 800; color: #1f2937; }
        #summary-motm-card .motm-team { color: #6b7280; }
        #summary-motm-card .motm-contribution { margin-top: 0.25rem; }

        /* --- NEW: Man of the Match Choice Modal & Card Styles --- */
        .mom-suggestion-card { text-align: left; background-color: #fff; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem; }
        .mom-player-header { display: flex; align-items: center; gap: 0.75rem; }
        .mom-player-image { width: 48px; height: 48px; border-radius: 50%; object-fit: cover; border: 2px solid #fff; box-shadow: 0 0 0 1px #e5e7eb; }
        .mom-player-name { font-size: 1.25rem; font-weight: 700; }
        .mom-player-team { font-size: 0.875rem; color: #6b7280; }
        .mom-player-performance { margin-top: 0.75rem; font-weight: 500; }
        .mom-suggestion-actions { margin-top: 1rem; display: flex; gap: 0.5rem; }

        #mom-choice-modal .player-rank-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; border-radius: 0.375rem; transition: background-color 0.2s; }
        #mom-choice-modal .player-rank-item:hover { background-color: #f3f4f6; }
        #mom-choice-modal .player-rank-score { margin-left: auto; font-weight: 700; font-size: 1.1rem; color: #1e3a8a; }

        @media (max-width: 768px) {
            .summary-table-container { overflow-x: hidden; }
            .summary-table { min-width: 100%; table-layout: fixed; }
            .summary-table th, .summary-table td { font-size: 0.7rem; padding: 0.5rem 0.25rem; white-space: normal; }
            .summary-table th { font-size: 0.65rem; }
            .summary-table th:first-child, .summary-table td:first-child { width: 35%; padding-left: 0.5rem; }
            .summary-table th:nth-child(2), .summary-table td:nth-child(2) { width: 30%; }

            /* --- NEW MOBILE SUMMARY STYLES --- */
            #summary-screen { padding: 0.25rem; }
            #summary-content { border-radius: 0.5rem; }
            #summary-content > header { padding: 0.75rem; }
            #summary-content h1 { font-size: 1.1rem; }
            #summary-content #summary-venue-date { font-size: 0.65rem; }
            #summary-header-team1, #summary-header-team2 { flex-basis: 20%; }
            .summary-team-logo { width: 28px; height: 28px; }
            
            #summary-score-strips { padding: 0.5rem; }
            .summary-score-strip { padding: 0.5rem; }
            .summary-score-strip .team-name { font-size: 0.9rem; }
            .summary-score-strip .score { font-size: 1rem; }
            .summary-score-strip .overs, .summary-score-strip .rr { font-size: 0.7rem; margin-left: 0.25rem; }

            .summary-tabs { margin-top: 0; }
            .summary-tab { padding: 0.5rem; font-size: 0.8rem; }
            #summary-main-content { padding: 0.5rem; }

            .summary-innings-card h3 { font-size: 0.9rem; padding: 0.5rem; margin-bottom: 0.25rem; }
            .summary-table-container { overflow-x: auto; } /* Allow horizontal scroll */
            .summary-table { min-width: 450px; } /* Force a min-width to prevent squishing */
            .summary-table th, .summary-table td { padding: 0.4rem 0.3rem; font-size: 0.75rem; white-space: nowrap; }

            .summary-extras-row td, .summary-total-row td { font-size: 0.8rem; }
            .summary-dnb-section, .summary-fow-section { margin-top: 0.75rem; padding: 0 0.25rem; }
            .summary-dnb-section h4, .summary-fow-section h4 { font-size: 0.8rem; }
            .summary-dnb-section p, .summary-fow-list { font-size: 0.75rem; line-height: 1.4; }
        }
    </style>
</head>
<body class="bg-gray-100 antialiased">

    

    <div id="splash-screen" style="display: none;">
        <img src="my-logo.png" alt="App Logo" id="splash-logo">
    </div>

    <div id="event-animation-overlay" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 pointer-events-none hidden z-50">
        <h1 id="event-animation-text" class="text-8xl font-black uppercase" style="text-shadow: 3px 3px 6px rgba(0,0,0,0.5);"></h1>
    </div>

    <div id="choice-screen" class="min-h-screen w-full flex flex-col items-center justify-center setup-bg p-4">
        <div class="w-full max-w-4xl bg-white/50 backdrop-blur-sm border border-gray-200/80 shadow-xl rounded-2xl p-6 md:p-8 choice-card flex flex-col">
            <header class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800">Single Match Dashboard</h1>
                <p class="text-gray-500 mt-1">Choose an option to get started</p>
            </header>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div onclick="showSetupScreen()" class="apple-card cursor-pointer p-6 rounded-2xl flex flex-col justify-center items-center text-center">
                    <div class="bg-gray-200 p-3 rounded-full">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                        </svg>
                    </div>
                    <h2 class="text-xl font-bold text-gray-800 mt-4">Create New Match</h2>
                    <p class="text-gray-500 text-sm mt-1">Set up a fresh match and start scoring right away.</p>
                </div>
                <a href="upcoming_matches.html" class="apple-card block p-6 rounded-2xl flex flex-col justify-center items-center text-center">
                    <div class="bg-gray-200 p-3 rounded-full">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                    </div>
                    <h2 class="text-xl font-bold text-gray-800 mt-4">Upcoming Matches</h2>
                    <p class="text-gray-500 text-sm mt-1">Create and schedule a match for a future date.</p>
                </a>
                <a href="match_history.html" class="apple-card block p-6 rounded-2xl flex flex-col justify-center items-center text-center">
                     <div class="bg-gray-200 p-3 rounded-full">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                    </div>
                    <h2 class="text-xl font-bold text-gray-800 mt-4">Match History</h2>
                    <p class="text-gray-500 text-sm mt-1">Check the summaries of your previously played matches.</p>
                </a>
            </div>
            <div class="mt-8 text-center">
                <a href="index.html" class="text-sm font-semibold text-gray-600 hover:text-gray-800">‚Üê Back to Home</a>
            </div>
        </div>
    </div>
    
    <div id="setup-screen" class="min-h-screen w-full flex flex-col items-center justify-center setup-bg hidden">
        <div class="w-full max-w-2xl shadow-xl rounded-2xl p-8 setup-card overflow-hidden">
            <div id="progress-container" class="mb-8">
                <div class="progress-bar-bg w-full h-2 bg-gray-200 rounded-full">
                    <div id="progress-bar" class="progress-bar-fill h-2 rounded-full" style="width: 25%;"></div>
                </div>
                <div class="flex justify-between text-xs sm:text-sm text-gray-500 mt-2">
                    <span>Details</span>
                    <span>Home Team</span>
                    <span>Away Team</span>
                    <span>Toss</span>
                </div>
            </div>

            <div class="relative">
                <div id="setup-step-1" class="setup-step active">
                    <header class="text-center mb-8">
                        <h1 class="text-3xl font-bold text-gray-800">Match Setup</h1>
                        <p class="text-gray-500 mt-1">Configure your match details and team names</p>
                    </header>
                    <div class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="space-y-2">
                                <label for="venue" class="block font-medium text-gray-700">Ground üèüÔ∏è<span class="text-red-500 ml-1">*</span></label>
                                <input type="text" id="venue" placeholder="e.g., National Stadium" class="w-full p-2 border-gray-300 border rounded-md focus:ring-blue-500 focus:border-blue-500 transition" style="text-transform: uppercase;">
                            </div>
                            <div class="space-y-2">
                                <label for="match-date-input" class="block font-medium text-gray-700">Date</label>
                                <input type="date" id="match-date-input" class="w-full p-2 border-gray-300 border rounded-md focus:ring-blue-500 focus:border-blue-500 transition">
                            </div>
                        </div>
                         <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="space-y-2">
                                <label for="total-overs" class="block font-medium text-gray-700">Match Format (Overs)<span class="text-red-500 ml-1">*</span></label>
                                <select id="total-overs" class="w-full p-2 border-gray-300 border rounded-md focus:ring-blue-500 focus:border-blue-500 transition">
                                    <option value="" disabled selected>Select Match Format</option>
                                    <option value="3">3 Overs</option>
                                    <option value="4">4 Overs</option>
                                    <option value="5">5 Overs</option>
                                    <option value="6">6 Overs</option>
                                    <option value="7">7 Overs</option>
                                    <option value="8">8 Overs</option>
                                    <option value="9">9 Overs</option>
                                    <option value="10">10 Overs</option>
                                    <option value="12">12 Overs</option>
                                    <option value="15">15 Overs</option>
                                    <option value="20">20 Overs</option>
                                    <option value="50">50 Overs</option>
                                </select>
                            </div>
                            <div class="space-y-2">
    <label for="players-per-side" class="block font-medium text-gray-700">Players per Side<span class="text-red-500 ml-1">*</span></label>
    <select id="players-per-side" class="w-full p-2 border-gray-300 border rounded-md focus:ring-blue-500 focus:border-blue-500 transition">
        <option value="" disabled selected>Select Players per Side</option>
        <option value="4">4A Side</option>
        <option value="5">5A Side</option>
        <option value="6">6A Side</option>
        <option value="7">7A Side</option>
                                    <option value="8">8A Side</option>
                                    <option value="9">9A Side</option>
                                    <option value="10">10A Side</option>
                                    <option value="11">11A Side</option>
                                </select>
                            </div>
                        </div>
                        <div class="border-t pt-4 space-y-4 bg-blue-50 p-4 rounded-lg">
                             <div class="space-y-2">
                                <label for="team1-select" class="block font-medium text-gray-700 font-bold">Load Saved team</label>
                                <select id="team1-select" class="w-full p-2 border-gray-300 border rounded-md focus:ring-blue-500 focus:border-blue-500 transition">
                                    <option value="">Search saved teams...</option>
                                </select>
                            </div>
                             <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="space-y-2 md:col-span-3">
                                     <label for="team1-name-input" class="block font-medium text-gray-700">Home Team Name<span class="text-red-500 ml-1">*</span></label>
                                     <input type="text" id="team1-name-input" placeholder="Enter Home Team Name" value="" class="w-full p-2 border-gray-300 border rounded-md focus:ring-blue-500 focus:border-blue-500 transition" style="text-transform: uppercase;" oninput="document.querySelector('label[for=\'team1-logo-input\']').textContent = this.value.trim() ? this.value.trim().toUpperCase() + ' Logo' : 'Home Team Logo'">
                                </div>
                             </div>
                             <div class="space-y-2">
                                    <label for="team1-logo-input" class="block font-medium text-gray-700">Home Team Logo</label>
                                    <input type="file" id="team1-logo-input" accept="image/png, image/jpeg" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                                </div>
                        </div>
                         <div class="border-t pt-4 space-y-4 bg-gray-50 p-4 rounded-lg">
                            <div class="space-y-2">
                                <label for="team2-select" class="block font-medium text-gray-700 font-bold">Load Saved team</label>
                                <select id="team2-select" class="w-full p-2 border-gray-300 border rounded-md focus:ring-blue-500 focus:border-blue-500 transition">
                                    <option value="">Search saved teams...</option>
                                </select>
                            </div>
                             <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="space-y-2 md:col-span-3">
                                     <label for="team2-name-input" class="block font-medium text-gray-700">Away Team Name<span class="text-red-500 ml-1">*</span></label>
                                     <input type="text" id="team2-name-input" placeholder="Enter Away Team Name" value="" class="w-full p-2 border-gray-300 border rounded-md focus:ring-blue-500 focus:border-blue-500 transition" style="text-transform: uppercase;" oninput="document.querySelector('label[for=\'team2-logo-input\']').textContent = this.value.trim() ? this.value.trim().toUpperCase() + ' Logo' : 'Away Team Logo'">
                                </div>
                             </div>
                             <div class="space-y-2">
                                    <label for="team2-logo-input" class="block font-medium text-gray-700">Away Team Logo</label>
                                    <input type="file" id="team2-logo-input" accept="image/png, image/jpeg" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                                </div>
                        </div>
                    </div>
                    <div class="mt-8 text-right">
                        <button onclick="goToStep(2)" class="px-6 py-2 text-white font-bold rounded-lg setup-btn">Next</button>
                    </div>
                </div>

                <div id="setup-step-2" class="setup-step hidden">
    <div class="w-full max-w-lg mx-auto px-6">
        <header class="text-center mb-8">
            <img id="team1-roster-logo" src="" alt="Team 1 Logo" class="w-20 h-20 mx-auto mb-4 rounded-full object-cover hidden shadow-md" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iI2NiZDVkNQoiPjxwYXRoIGQ9Ik0xMiAyQzYuNDggMiAyIDYuNDggMiAxMnM0LjQ4IDEwIDEwIDEwIDEwLTQuNDggMTAtMTBTMTcuNTIgMiAxMiAyeptMCAzYzEuNjYgMCAzIDEuMzQgMyAzcy0xLjM0IDMtMyAzLTMtMS4zNC0zLTMgMS4zNC0zIDMtM3ptMCAxNGMtMi4zMyAwLTguMTMgMS4xNy04LjEzIDMuNUM0IDIzLjUyIDcuNTggMjQgMTIgMjRzOC0uNDggOC0xLjVDMjAuMTMgMTkuMTcgMTQuMzMgMTggMTIgMTh6Ii8+PC9zdmc='">
            <h1 id="team1-roster-title" class="text-3xl font-bold"></h1>
            <p class="text-gray-500 mt-1">Enter player names & upload player images</p>
        </header>
        <div id="team1-player-inputs" class="space-y-3 pr-2 overflow-y-auto" style="max-height: 50vh;">
        </div>
        <div class="mt-8 flex justify-between items-center">
            <button onclick="goToStep(1)" class="back-btn font-semibold">Back</button>
            <button onclick="proceedFromStep2()" class="px-6 py-2 text-white font-bold rounded-lg setup-btn">Next</button>
        </div>
    </div>
</div>

<div id="setup-step-3" class="setup-step hidden">
    <div class="w-full max-w-lg mx-auto px-6">
        <header class="text-center mb-8">
            <img id="team2-roster-logo" src="" alt="Team 2 Logo" class="w-20 h-20 mx-auto mb-4 rounded-full object-cover hidden shadow-md" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iI2NiZDVkNQoiPjxwYXRoIGQ9Ik0xMiAyQzYuNDggMiAyIDYuNDggMiAxMnM0LjQ4IDEwIDEwIDEwIDEwLTQuNDggMTAtMTBTMTcuNTIgMiAxMiAyeptMCAzYzEuNjYgMCAzIDEuMzQgMyAzcy0xLjM0IDMtMyAzLTMtMS4zNC0zLTMgMS4zNC0zIDMtM3ptMCAxNGMtMi4zMyAwLTguMTMgMS4xNy04LjEzIDMuNUM0IDIzLjUyIDcuNTggMjQgMTIgMjRzOC0uNDggOC0xLjVDMjAuMTMgMTkuMTcgMTQuMzMgMTggMTIgMTh6Ii8+PC9zdmc='">
            <h1 id="team2-roster-title" class="text-3xl font-bold"></h1>
            <p class="text-gray-500 mt-1">Enter player names & upload player images</p>
        </header>
        <div id="team2-player-inputs" class="space-y-3 pr-2 overflow-y-auto" style="max-height: 50vh;">
        </div>
        <div class="mt-8 flex justify-between items-center">
            <button onclick="goToStep(2)" class="back-btn font-semibold">Back</button>
             <button onclick="proceedFromStep3()" class="px-6 py-2 text-white font-bold rounded-lg setup-btn">Toss</button>
        </div>
    </div>
</div>

                <div id="setup-step-4" class="setup-step hidden text-slate-800">
                     <div class="w-full max-w-lg mx-auto px-6">
                            <header class="text-center mb-8">
                                 <h1 class="text-3xl font-bold">Toss Result</h1>
                                 <p class="text-slate-600 mt-1">Select the toss winner and their choice</p>
                            </header>
                            <div id="toss-flow-container" class="space-y-8">
                                <div>
                                    <p class="text-center font-semibold mb-4">Who won the toss?</p>
                                    <div class="flex justify-center gap-6">
                                        <button id="toss-winner-team1" class="toss-3d-button flex flex-col items-center gap-3 w-32 p-4">
                                            <div id="toss-team1-logo-container" class="w-16 h-16 rounded-full flex items-center justify-center text-2xl font-bold bg-cover bg-center text-white"></div>
                                            <span id="toss-team1-name" class="truncate w-full"></span>
                                        </button>
                                        <button id="toss-winner-team2" class="toss-3d-button flex flex-col items-center gap-3 w-32 p-4">
                                            <div id="toss-team2-logo-container" class="w-16 h-16 rounded-full flex items-center justify-center text-2xl font-bold bg-cover bg-center text-white"></div>
                                            <span id="toss-team2-name" class="truncate w-full"></span>
                                        </button>
                                    </div>
                                </div>

                                <div id="toss-decision-container" class="hidden text-center">
                                    <p class="font-semibold mb-4">...and elected to:</p>
                                    <div class="flex justify-center gap-6">
                                        <button id="toss-choice-bat" class="toss-3d-button w-32 py-3">Bat First</button>
                                        <button id="toss-choice-bowl" class="toss-3d-button w-32 py-3">Field First</button>
                                    </div>
                                </div>
                            </div>
                           <div class="mt-12 flex justify-between items-center">
                                <button onclick="goToStep(3)" class="back-btn font-semibold hover:text-slate-900">Back</button>
                                <button id="start-match-btn" class="px-6 py-2 text-white font-bold rounded-lg setup-btn opacity-50 cursor-not-allowed" disabled>Start Match</button>
                           </div>
                     </div>
                </div>
            </div>
        </div>
    </div>


    <div id="app" class="h-screen w-full flex flex-col hidden">
        <div id="match-header" class="relative text-center px-4 bg-gray-100">
        </div>
        <div class="flex-grow w-full px-4 pt-2 pb-4 grid lg:grid-cols-3 gap-2 overflow-hidden min-h-0">
    
            <div class="lg:col-span-2 flex flex-col space-y-2">
                <div id="scoreboard" class="bg-white rounded-lg p-1 shadow-md">
                    <div id="team-scores-container" class="space-y-0">
                    </div>
                </div>
                
                <div id="target-info-container" class="hidden bg-white rounded-lg p-2 shadow-md text-center"></div>
    
                <div class="flex-grow min-h-0 flex flex-col gap-2">
                    <div class="flex-grow min-h-0 rounded-lg shadow-md overflow-y-auto bg-gradient-to-br from-gray-50 to-gray-100 border border-gray-200/75">
                        <table class="table-fixed w-full text-left text-sm relative">
                            <thead class="bg-gray-100 border-b">
                                <tr>
                                    <th class="p-1 font-semibold text-xs w-1/2">Batting</th>
                                    <th class="text-center p-1 font-semibold text-sm w-[9%]">R</th>
                                    <th class="text-center p-1 font-semibold text-sm w-[9%]">B</th>
                                    <th class="text-center p-1 font-semibold text-sm w-[9%]">4s</th>
                                    <th class="text-center p-1 font-semibold text-sm w-[9%]">6s</th>
                                    <th class="text-right p-1 font-semibold text-sm w-[14%]">SR</th>
                                </tr>
                            </thead>
                            <tbody id="batting-table">
                            </tbody>
                        </table>
                    </div>
                    <div class="rounded-lg shadow-md overflow-y-auto bg-gradient-to-br from-gray-50 to-gray-100 border border-gray-200/75">
                        <table class="table-fixed w-full text-left text-sm">
                            <thead class="bg-gray-100 border-b">
                                <tr>
                                    <th class="p-1 font-semibold text-xs w-1/2">Bowling</th>
                                    <th class="text-center p-1 font-semibold text-sm w-[9%]">O</th>
                                    <th class="text-center p-1 font-semibold text-sm w-[9%]">M</th>
                                    <th class="text-center p-1 font-semibold text-sm w-[9%]">R</th>
                                    <th class="text-center p-1 font-semibold text-sm w-[9%]">W</th>
                                    <th class="text-right p-1 font-semibold text-sm w-[14%]">Econ</th>
                                </tr>
                            </thead>
                            <tbody id="bowling-table">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
           <div class="lg:col-span-1 flex flex-col space-y-2">
                <div id="live-commentary-box" class="bg-blue-50 rounded-lg p-2 shadow-md hidden">
                    <div class="flex justify-between items-center cursor-pointer" id="toggle-commentary-btn">
                        <p class="text-xs font-semibold text-blue-800 uppercase tracking-wider">LIVE COMMENTARY</p>
                        <svg id="commentary-chevron" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-600 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </div>
                    <div id="live-commentary-content">
                         <p id="live-commentary" class="text-gray-800 font-medium border-t border-blue-200"></p>
                    </div>
                </div>
                <footer id="scoring-controls" class="bg-white shadow-md relative flex flex-col h-52 -mx-4 rounded-none lg:mx-0 lg:rounded-lg overflow-hidden">
    
    <div id="bowler-prompt-overlay" class="absolute inset-0 z-20 bg-blue-50 bg-opacity-95 flex items-center justify-center hidden cursor-pointer">
        <p class="font-bold text-blue-800 text-3xl tracking-tight">Choose the Next Bowler</p>
    </div>

    <div id="match-ended-overlay" class="absolute inset-0 z-10 bg-gray-100 bg-opacity-95 flex flex-col items-center justify-center hidden">
        <p class="font-bold text-gray-800 text-xl mb-2">Match Completed</p>
        <p class="text-gray-500 text-sm mb-4">Scorebook is disabled.</p>
        <button onclick="undoLastAction()" class="flex items-center gap-2 px-6 py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 shadow-lg transition-transform active:scale-95">
            <span class="text-xl">‚ü≤</span>
            <span>Undo End Match</span>
        </button>
    </div>

    <div id="active-scoring-ui" class="w-full h-full">
        <div class="scoring-grid">
            <button onclick="addRuns(0)" class="flex flex-col items-center justify-center bg-amber-400 text-black transition-transform active:scale-95">
                <span class="font-bold text-xl leading-none">0</span>
                <span class="text-xs font-semibold mt-1 opacity-75">Dot</span>
            </button>
            <button onclick="addRuns(1)" class="flex flex-col items-center justify-center bg-sky-400 text-white transition-transform active:scale-95">
                <span class="font-bold text-xl leading-none">1</span>
                <span class="text-xs font-semibold mt-1 opacity-75">Single</span>
            </button>
            <button onclick="addRuns(2)" class="flex flex-col items-center justify-center bg-slate-300 text-black transition-transform active:scale-95">
                <span class="font-bold text-xl leading-none">2</span>
                <span class="text-xs font-semibold mt-1 opacity-75">Double</span>
            </button>
            <div class="flex">
                <button onclick="undoLastAction()" id="undo-btn-grid" class="flex-1 flex flex-col items-center justify-center bg-amber-500 text-white transition-transform active:scale-95 h-full p-2 disabled:opacity-50">
                    <span class="text-xl">‚ü≤</span>
                    <span class="text-sm font-semibold mt-1">Undo</span>
                </button>
                <button onclick="redoLastAction()" id="redo-btn-grid" class="flex-1 flex flex-col items-center justify-center bg-amber-300 text-amber-900 transition-transform active:scale-95 h-full p-2 disabled:opacity-50">
                    <span class="text-xl">‚ü≥</span>
                    <span class="text-sm font-semibold mt-1">Redo</span>
                </button>
            </div>
            
            <button onclick="addRuns(3)" class="flex flex-col items-center justify-center bg-slate-200 text-black transition-transform active:scale-95">
                <span class="font-bold text-xl leading-none">3</span>
                <span class="text-xs font-semibold mt-1 opacity-75">Triple</span>
            </button>
            <button onclick="addRuns(4)" class="flex flex-col items-center justify-center bg-blue-600 text-white transition-transform active:scale-95">
                <span class="font-bold text-xl leading-none">4</span>
                <span class="text-xs font-semibold mt-1 opacity-75">Four</span>
            </button>
            <button onclick="addRuns(6)" class="flex flex-col items-center justify-center bg-green-500 text-white transition-transform active:scale-95">
                <span class="font-bold text-xl leading-none">6</span>
                <span class="text-xs font-semibold mt-1 opacity-75">Six</span>
            </button>
            <button onclick="openWicketModal()" class="flex items-center justify-center bg-red-600 text-white font-bold text-xl transition-transform active:scale-95">
                Wicket
            </button>
            
            <button onclick="openModal('wide-modal')" class="flex items-center justify-center bg-slate-50 text-slate-700 font-bold text-xl transition-transform active:scale-95">
                Wide
            </button>
            <button onclick="openModal('noball-modal')" class="flex items-center justify-center bg-slate-50 text-slate-700 font-bold text-xl transition-transform active:scale-95">
                NB
            </button>
            <button onclick="openModal('byes-modal')" class="flex items-center justify-center bg-slate-50 text-slate-700 font-bold text-xl transition-transform active:scale-95">
                Byes
            </button>
            <button onclick="openModal('legbyes-modal')" class="flex items-center justify-center bg-slate-50 text-slate-700 font-bold text-xl transition-transform active:scale-95">
                LB
            </button>
        </div>
    </div>
</footer>
            </div>
        </div> 
        <header class="bg-gray-100 p-1 border-t border-gray-300 shadow-[0_-2px_10px_rgba(0,0,0,0.05)] z-20">
    <div class="flex flex-wrap justify-center items-center gap-2 w-full max-w-4xl mx-auto py-1">
        
        <button onclick="openEditModal()" class="text-[10px] font-bold uppercase tracking-wider py-1.5 px-2 bg-white border border-gray-300 rounded shadow-sm text-gray-700 hover:bg-gray-50 active:scale-95 transition-transform">
            Edit
        </button>
        
        <button onclick="showSummaryScreen()" class="text-[10px] font-bold uppercase tracking-wider py-1.5 px-2 bg-white border border-gray-300 rounded shadow-sm text-gray-700 hover:bg-gray-50 active:scale-95 transition-transform">
            Summary
        </button>

        <div class="flex items-center space-x-1 px-1 border-l border-r border-gray-300 mx-1" title="Shot Map">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2h14a2 2 0 002-2z"></path></svg>
            <button id="pitch-map-toggle" onclick="togglePitchMap()" class="relative inline-flex flex-shrink-0 h-4 w-7 border-2 border-transparent rounded-full cursor-pointer transition-colors ease-in-out duration-200 focus:outline-none bg-gray-400">
                <span id="pitch-map-toggle-knob" class="pointer-events-none inline-block h-3 w-3 rounded-full bg-white shadow transform ring-0 transition ease-in-out duration-200 translate-x-0"></span>
            </button>
        </div>

        <button onclick="openEndMatchModal()" class="text-[10px] font-bold uppercase tracking-wider py-1.5 px-2 bg-red-600 text-white rounded shadow-sm hover:bg-red-700 active:scale-95 transition-transform">
            End Match
        </button>
        
        <button id="rematch-btn" onclick="startRematch()" class="text-[10px] font-bold uppercase tracking-wider py-1.5 px-2 bg-blue-600 text-white rounded shadow-sm hover:bg-blue-700 active:scale-95 transition-transform disabled:opacity-50 disabled:cursor-not-allowed" disabled>
            Rematch
        </button>
        
        <button onclick="confirmStartNewMatch()" class="text-[10px] font-bold uppercase tracking-wider py-1.5 px-2 bg-green-600 text-white rounded shadow-sm hover:bg-green-700 active:scale-95 transition-transform">
            New Match
        </button>
    </div>
</header>
    </div>

    <div id="summary-screen" class="min-h-screen w-full flex-col hidden items-center bg-gray-100 p-2 sm:p-4">
        <div id="summary-content" class="relative w-full max-w-4xl mx-auto bg-white rounded-lg shadow-xl overflow-hidden">
            <header class="p-3 sm:p-4 border-b relative">
                <button onclick="backToScorecard()" class="absolute top-2 right-2 p-2 text-gray-400 hover:text-gray-700">
                     <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
                <div class="flex justify-between items-center text-center">
                    <div id="summary-header-team1" class="flex items-center gap-2 w-1/3"></div>
                    <div class="flex-grow">
                        <h1 class="text-xl sm:text-2xl font-bold text-gray-800">Match Summary</h1>
                        <p id="summary-venue-date" class="text-xs sm:text-sm text-gray-500"></p>
                    </div>
                    <div id="summary-header-team2" class="flex items-center gap-2 justify-end w-1/3"></div>
                </div>
                <div id="summary-status-ribbon" class="text-center bg-gray-200 text-gray-700 font-semibold text-sm py-1 rounded-md mt-3"></div>
            </header>

            <div id="summary-score-strips" class="p-3 sm:p-4 space-y-2 border-b">
            </div>

            <div class="summary-tabs" role="tablist">
                 <button id="summary-tab-innings1" role="tab" aria-controls="panel-innings1" class="summary-tab"></button>
                 <button id="summary-tab-innings2" role="tab" aria-controls="panel-innings2" class="summary-tab"></button>
            </div>

            <div id="summary-main-content" class="p-2 sm:p-4">
                 <section id="panel-innings1" role="tabpanel" aria-labelledby="summary-tab-innings1" class="summary-innings-panel"></section>
                 <section id="panel-innings2" role="tabpanel" aria-labelledby="summary-tab-innings2" class="summary-innings-panel"></section>
                 <div id="summary-motm-panel"></div>
            </div>
        </div>
        
        <div class="w-full max-w-4xl mx-auto mt-4 flex flex-col sm:flex-row justify-center items-center space-y-2 sm:space-y-0 sm:space-x-3">
            <button onclick="backToScorecard()" class="w-full sm:w-auto px-6 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700">Back to Scorecard</button>
            <button onclick="previewDownload('jpeg')" class="w-full sm:w-auto px-6 py-2 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700">Download JPEG</button>
        </div>
    </div>

    <div id="fielder-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl p-6 w-11/12 max-w-sm transform scale-95">
            <div class="flex justify-between items-center mb-4">
                <h3 id="fielder-modal-title" class="text-lg font-bold">Select Fielder</h3>
                <button onclick="closeModal('fielder-modal')" class="text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <select id="fielder-select" class="w-full p-2 border rounded-md mb-4">
                </select>
            <div class="flex justify-end space-x-3">
                <button onclick="closeModal('fielder-modal')" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancel</button>
                <button id="fielder-save-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Confirm</button>
            </div>
        </div>
    </div>

    <div id="player-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl p-6 w-11/12 max-w-sm transform scale-95">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modal-title" class="text-lg font-bold">Select Player</h3>
                <button id="player-modal-cancel-btn-x" onclick="closeModal('player-modal')" class="text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <select id="player-select" class="w-full p-2 border rounded-md mb-4">
                </select>
            <div class="flex justify-end space-x-3">
                <button id="player-modal-cancel-btn-text" onclick="closeModal('player-modal')" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancel</button>
                <button id="player-save-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Save</button>
            </div>
        </div>
    </div>
    
   <div id="edit-match-modal" class="modal-overlay fixed inset-0 bg-black/30 flex justify-center items-center hidden z-50 p-2 sm:p-4">
        <div class="modal-content glass-modal-content rounded-2xl shadow-2xl w-full max-w-3xl transform scale-95 max-h-[95vh] flex flex-col">
            <!-- Modal Header -->
            <div class="flex-shrink-0 flex justify-between items-center p-4 sm:p-5 border-b border-white/20">
                <div>
                    <h3 class="text-xl sm:text-2xl font-bold text-gray-900">Edit Match State</h3>
                    <p class="text-sm text-gray-600 mt-1">Make adjustments to the match settings, scores, and players.</p>
                </div>
                <button onclick="closeModal('edit-match-modal')" class="p-2 text-gray-500 hover:text-gray-800 hover:bg-white/50 rounded-full transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="flex-grow overflow-y-auto p-4 sm:p-6 space-y-6">
                <!-- General Settings Section -->
                <div class="glass-section p-4 sm:p-6">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4">General Settings</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                        <div>
                            <label for="edit-venue" class="block text-sm font-medium text-gray-700 mb-1.5">Venue</label>
                            <input type="text" id="edit-venue" class="w-full glass-input" style="text-transform: uppercase;">
                        </div>
                        <div>
                            <label for="edit-total-overs" class="block text-sm font-medium text-gray-700 mb-1.5">Match Format (Overs)</label>
                            <select id="edit-total-overs" class="w-full glass-select">
                                <option value="3">3 Overs</option><option value="4">4 Overs</option><option value="5">5 Overs</option><option value="6">6 Overs</option><option value="7">7 Overs</option><option value="8">8 Overs</option><option value="9">9 Overs</option><option value="10">10 Overs</option><option value="12">12 Overs</option><option value="15">15 Overs</option><option value="20">20 Overs</option><option value="50">50 Overs</option>
                            </select>
                        </div>
                    </div>
                     <div class="mt-6">
                        <h4 class="text-lg font-semibold text-gray-800 mb-2">Current Over</h4>
                        <p class="text-sm text-gray-500 mb-4">Tap a ball to edit the sequence of the current over.</p>
                        <div id="edit-over-chips-display" class="over-chips-display bg-gray-200/60 rounded-lg"></div>
                    </div>
                </div>

                <!-- Teams Section with Tabs -->
                <div class="glass-section p-4 sm:p-6">
                    <div class="border-b border-gray-900/10">
                        <nav class="flex space-x-2" aria-label="Tabs">
                            <button id="edit-team1-tab" class="edit-tab active">Team 1</button>
                            <button id="edit-team2-tab" class="edit-tab">Team 2</button>
                        </nav>
                    </div>
                    <div class="pt-6">
                        <!-- Team 1 Panel -->
                        <div id="edit-team1-panel" class="edit-team-content-panel space-y-5">
                            <div class="flex items-center gap-4">
                                <div id="edit-team1-logo-uploader" class="logo-uploader flex-shrink-0"></div>
                                <div class="flex-grow">
                                    <label class="block text-sm font-medium text-gray-700 mb-1.5">Team Name</label>
                                    <input type="text" id="edit-team1-name" class="w-full glass-input">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Score</label>
                                <div class="grid grid-cols-2 gap-x-4 gap-y-3">
                                    <div><label class="text-xs text-gray-600">Runs</label><input type="number" id="edit-team1-score" class="w-full glass-input"></div>
                                    <div><label class="text-xs text-gray-600">Wickets</label><input type="number" id="edit-team1-wickets" class="w-full glass-input"></div>
                                    <div><label class="text-xs text-gray-600">Overs</label><input type="number" id="edit-team1-overs" class="w-full glass-input"></div>
                                    <div><label class="text-xs text-gray-600">Balls</label><input type="number" id="edit-team1-balls" class="w-full glass-input"></div>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Player List</label>
                                <div id="edit-team1-players" class="player-list-editor mt-1 p-2 border rounded-lg bg-gray-200/20 border-gray-300/50"></div>
                            </div>
                        </div>

                        <!-- Team 2 Panel -->
                        <div id="edit-team2-panel" class="edit-team-content-panel hidden space-y-5">
                            <div class="flex items-center gap-4">
                                <div id="edit-team2-logo-uploader" class="logo-uploader flex-shrink-0"></div>
                                <div class="flex-grow">
                                    <label class="block text-sm font-medium text-gray-700 mb-1.5">Team Name</label>
                                    <input type="text" id="edit-team2-name" class="w-full glass-input">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Score</label>
                                <div class="grid grid-cols-2 gap-x-4 gap-y-3">
                                   <div><label class="text-xs text-gray-600">Runs</label><input type="number" id="edit-team2-score" class="w-full glass-input"></div>
                                   <div><label class="text-xs text-gray-600">Wickets</label><input type="number" id="edit-team2-wickets" class="w-full glass-input"></div>
                                   <div><label class="text-xs text-gray-600">Overs</label><input type="number" id="edit-team2-overs" class="w-full glass-input"></div>
                                   <div><label class="text-xs text-gray-600">Balls</label><input type="number" id="edit-team2-balls" class="w-full glass-input"></div>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Player List</label>
                                <div id="edit-team2-players" class="player-list-editor mt-1 p-2 border rounded-lg bg-gray-200/20 border-gray-300/50"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="flex-shrink-0 flex justify-end items-center space-x-3 p-4 border-t border-white/20">
                <button onclick="closeModal('edit-match-modal')" class="glass-button-secondary">Cancel</button>
                <button onclick="saveMatchEdits()" class="glass-button-primary">Save Changes</button>
            </div>

            <!-- Popover for editing over -->
            <div id="over-edit-popover">
                <div id="over-edit-options" class="options-grid"></div>
                <div class="actions-footer">
                    <button id="popover-replace-btn">Replace</button>
                    <button id="popover-insertBefore-btn">Insert Before</button>
                    <button id="popover-insertAfter-btn">Insert After</button>
                    <button id="popover-delete-btn" class="btn-delete">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <div id="wicket-type-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl p-6 w-11/12 max-w-sm transform scale-95">
            <h3 class="text-lg font-bold text-center mb-4">How Out?</h3>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="handleWicket('Catch')" class="p-3 bg-gray-100 rounded-lg">Catch</button>
                <button onclick="handleWicket('Bowled')" class="p-3 bg-gray-100 rounded-lg">Bowled</button>
                <button onclick="handleWicket('Stump Out')" class="p-3 bg-gray-100 rounded-lg">Stump Out</button>
                <button onclick="handleWicket('Run Out')" class="p-3 bg-gray-100 rounded-lg">Run Out</button>
                <button onclick="handleWicket('LBW')" class="p-3 bg-gray-100 rounded-lg">LBW</button>
                <button onclick="handleWicket('Hit Wicket')" class="p-3 bg-gray-100 rounded-lg">Hit Wicket</button>
                <button onclick="handleWicket('Retired Out')" class="p-3 bg-gray-100 rounded-lg">Retired Out</button>
                <button onclick="handleWicket('Other')" class="p-3 bg-gray-100 rounded-lg">Other</button>
            </div>
        </div>
    </div>
    
    <div id="run-out-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl p-6 w-11/12 max-w-sm transform scale-95">
             <button onclick="closeModal('run-out-modal')" class="absolute top-2 right-2 text-gray-400 hover:text-gray-600">&times;</button>
            <h3 id="run-out-modal-title" class="text-lg font-bold text-center mb-4">Run Out</h3>

            <div id="run-out-runs-section" class="mb-4">
                 <p id="run-out-runs-prompt" class="text-sm font-semibold text-center text-gray-600 mb-2">Runs completed before run-out:</p>
                 <div class="flex justify-center gap-2" id="run-out-runs-chips">
                     <button data-runs="0" class="run-chip px-3 py-1 bg-gray-200 rounded-full text-sm font-semibold focus:outline-none focus:ring-2 focus:ring-blue-500 ring-offset-1">0</button>
                     <button data-runs="1" class="run-chip px-3 py-1 bg-gray-200 rounded-full text-sm font-semibold focus:outline-none focus:ring-2 focus:ring-blue-500 ring-offset-1">1</button>
                     <button data-runs="2" class="run-chip px-3 py-1 bg-gray-200 rounded-full text-sm font-semibold focus:outline-none focus:ring-2 focus:ring-blue-500 ring-offset-1">2</button>
                     <button data-runs="3" class="run-chip px-3 py-1 bg-gray-200 rounded-full text-sm font-semibold focus:outline-none focus:ring-2 focus:ring-blue-500 ring-offset-1">3</button>
                     <button data-runs="4+" class="run-chip px-3 py-1 bg-gray-200 rounded-full text-sm font-semibold focus:outline-none focus:ring-2 focus:ring-blue-500 ring-offset-1">4+</button>
                 </div>
                 <input type="number" id="run-out-runs-input" min="4" value="4" class="hidden w-20 mx-auto mt-2 p-1 border rounded-md text-center">
                 <input type="hidden" id="run-out-selected-runs" value="0"> </div>

             <div class="border-t pt-4">
                <p class="text-sm font-semibold text-center text-gray-600 mb-2">Who is out?</p>
                <div id="run-out-options" class="space-y-2">
                     </div>
             </div>
        </div>
    </div>

    <div id="wide-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex justify-center items-end hidden z-50" onclick="closeModal('wide-modal')">
        <div class="modal-content bg-white rounded-t-2xl shadow-xl w-full max-w-md p-6 transform translate-y-full" onclick="event.stopPropagation()">
            <div class="w-10 h-1 bg-gray-300 rounded-full mx-auto mb-4"></div>
            <h3 class="text-lg font-bold text-center mb-2">Wides</h3>
            <p class="text-center text-sm text-gray-500 mb-6">(Wide = 1 run + any extra runs)</p>
            <div class="grid grid-cols-5 gap-3">
                <button onclick="addExtra('wd', 0)" class="p-3 bg-gray-100 rounded-lg">WD</button>
                <button onclick="addExtra('wd', 1)" class="p-3 bg-gray-100 rounded-lg">WD+1</button>
                <button onclick="addExtra('wd', 2)" class="p-3 bg-gray-100 rounded-lg">WD+2</button>
                <button onclick="addExtra('wd', 3)" class="p-3 bg-gray-100 rounded-lg">WD+3</button>
                <button onclick="addExtra('wd', 4)" class="p-3 bg-gray-100 rounded-lg">WD+4</button>
            </div>
             <div class="mt-4 border-t pt-4">
                <button onclick="initiateExtraRunOut('wd')" class="w-full p-3 bg-red-100 text-red-700 rounded-lg font-semibold">Run Out</button>
            </div>
        </div>
    </div>
    
    <div id="noball-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex justify-center items-end hidden z-50" onclick="closeModal('noball-modal')">
        <div class="modal-content bg-white rounded-t-2xl shadow-xl w-full max-w-md p-6 transform translate-y-full" onclick="event.stopPropagation()">
            <div class="w-10 h-1 bg-gray-300 rounded-full mx-auto mb-4"></div>
            <h3 class="text-lg font-bold text-center mb-2">No Ball</h3>
            <p class="text-center text-sm text-gray-500 mb-6">(NB = 1 run + runs off bat. Free Hit next ball.)</p>
            <div class="grid grid-cols-4 gap-3">
                <button onclick="addExtra('nb', 1)" class="p-3 bg-gray-100 rounded-lg">NB+1</button>
                <button onclick="addExtra('nb', 2)" class="p-3 bg-gray-100 rounded-lg">NB+2</button>
                <button onclick="addExtra('nb', 3)" class="p-3 bg-gray-100 rounded-lg">NB+3</button>
                <button onclick="addExtra('nb', 4)" class="p-3 bg-gray-100 rounded-lg">NB+4</button>
                <button onclick="addExtra('nb', 0)" class="p-3 bg-gray-100 rounded-lg col-span-2">NB+0</button>
                <button onclick="addExtra('nb', 6)" class="p-3 bg-gray-100 rounded-lg col-span-2">NB+6</button>
            </div>
            <div class="mt-4 border-t pt-4">
                <button onclick="initiateExtraRunOut('nb')" class="w-full p-3 bg-red-100 text-red-700 rounded-lg font-semibold">Run Out</button>
            </div>
        </div>
    </div>
    
    <div id="byes-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex justify-center items-end hidden z-50" onclick="closeModal('byes-modal')">
        <div class="modal-content bg-white rounded-t-2xl shadow-xl w-full max-w-md p-6 transform translate-y-full" onclick="event.stopPropagation()">
            <div class="w-10 h-1 bg-gray-300 rounded-full mx-auto mb-4"></div>
            <h3 class="text-lg font-bold text-center mb-6">Byes</h3>
            <div class="grid grid-cols-4 gap-3">
                <button onclick="addExtra('b', 1)" class="p-3 bg-gray-100 rounded-lg">B+1</button>
                <button onclick="addExtra('b', 2)" class="p-3 bg-gray-100 rounded-lg">B+2</button>
                <button onclick="addExtra('b', 3)" class="p-3 bg-gray-100 rounded-lg">B+3</button>
                <button onclick="addExtra('b', 4)" class="p-3 bg-gray-100 rounded-lg">B+4</button>
            </div>
            <div class="mt-4 border-t pt-4">
                <button onclick="initiateExtraRunOut('b')" class="w-full p-3 bg-red-100 text-red-700 rounded-lg font-semibold">Run Out</button>
            </div>
        </div>
    </div>
    
    <div id="legbyes-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex justify-center items-end hidden z-50" onclick="closeModal('legbyes-modal')">
        <div class="modal-content bg-white rounded-t-2xl shadow-xl w-full max-w-md p-6 transform translate-y-full" onclick="event.stopPropagation()">
            <div class="w-10 h-1 bg-gray-300 rounded-full mx-auto mb-4"></div>
            <h3 class="text-lg font-bold text-center mb-6">Leg Byes</h3>
            <div class="grid grid-cols-4 gap-3">
                <button onclick="addExtra('lb', 1)" class="p-3 bg-gray-100 rounded-lg">LB+1</button>
                <button onclick="addExtra('lb', 2)" class="p-3 bg-gray-100 rounded-lg">LB+2</button>
                <button onclick="addExtra('lb', 3)" class="p-3 bg-gray-100 rounded-lg">LB+3</button>
                <button onclick="addExtra('lb', 4)" class="p-3 bg-gray-100 rounded-lg">LB+4</button>
            </div>
            <div class="mt-4 border-t pt-4">
                <button onclick="initiateExtraRunOut('lb')" class="w-full p-3 bg-red-100 text-red-700 rounded-lg font-semibold">Run Out</button>
            </div>
        </div>
    </div>
    
    <div id="runs-attempted-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl p-6 w-11/12 max-w-sm transform scale-95">
            <h3 class="text-lg font-bold text-center mb-4">How many runs were attempted?</h3>
            <div id="runs-attempted-options" class="grid grid-cols-3 gap-3">
                <button onclick="handleAttemptedRuns(0)" class="p-3 bg-gray-100 rounded-lg">0 Runs</button>
                <button onclick="handleAttemptedRuns(1)" class="p-3 bg-gray-100 rounded-lg">1 Run</button>
                <button onclick="handleAttemptedRuns(2)" class="p-3 bg-gray-100 rounded-lg">2 Runs</button>
                <button onclick="handleAttemptedRuns(3)" class="p-3 bg-gray-100 rounded-lg">3 Runs</button>
                <button onclick="handleAttemptedRuns(4)" class="p-3 bg-gray-100 rounded-lg">4 Runs</button>
            </div>
        </div>
    </div>

    <div id="alert-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl p-6 w-11/12 max-w-sm text-center transform scale-95">
            <p id="alert-message" class="mb-4"></p>
            <button id="alert-ok-btn" class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">OK</button>
        </div>
    </div>

    <div id="confirm-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl p-6 w-11/12 max-w-sm text-center transform scale-95">
            <p id="confirm-message" class="mb-6"></p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-cancel-btn" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancel</button>
                <button id="confirm-ok-btn" class="px-6 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Confirm</button>
            </div>
        </div>
    </div>
<div id="choice-confirm-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50">
    <div class="modal-content bg-white rounded-lg shadow-xl p-6 w-11/12 max-w-sm text-center transform scale-95">
        <h3 id="choice-confirm-title" class="text-lg font-bold mb-2"></h3>
        <p id="choice-confirm-message" class="mb-6"></p>
        <div id="choice-confirm-buttons" class="flex flex-col space-y-2">
            <!-- Buttons will be injected by JavaScript -->
        </div>
    </div>
</div>
    <div id="end-match-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50 p-4">
    <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-2xl transform scale-95 max-h-[90vh] flex flex-col">
        <div class="flex justify-between items-center p-4 border-b">
            <h3 class="text-xl font-bold">Declare Match Result</h3>
            <button onclick="closeModal('end-match-modal')" class="text-gray-400 hover:text-gray-700">
                <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>

        <div class="p-6 overflow-y-auto">
            <div id="end-match-step-1" class="end-match-step active">
                <h4 class="font-semibold mb-3">1. Select the Match Outcome</h4>
                <div id="end-match-outcomes" class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                    </div>
            </div>

            <div id="end-match-step-2" class="end-match-step">
                <h4 class="font-semibold mb-3">2. Provide Result Details</h4>
                <div id="end-match-dynamic-fields">
                    </div>
            </div>
        </div>

        <div class="p-4 border-t bg-gray-50 space-y-3">
            
            <div class="flex justify-end space-x-3">
                <button id="end-match-back-btn" onclick="openEndMatchModal(1)" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 hidden">Back</button>
                <button id="end-match-confirm-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed" disabled>Confirm Result</button>
            </div>
        </div>
    </div>
</div>

    <div id="win-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-75 flex justify-center items-center hidden z-50 p-4">
        <div id="confetti-container" class="fixed inset-0 pointer-events-none z-[1]"></div>

        <div class="win-modal-content modal-content bg-gray-900 rounded-2xl shadow-xl w-full max-w-lg text-center transform scale-100 relative overflow-hidden border-2 border-yellow-400/50">
            <div class="relative p-6 space-y-4 z-10">
                <button onclick="closeModal('win-modal')" class="absolute top-0 right-0 mt-4 mr-4 text-gray-500 hover:text-white transition-colors z-20">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>

                <div class="flex flex-col items-center animate-pop-in">
                    <img id="wm-winner-logo" src="" class="w-24 h-24 mx-auto rounded-full object-cover border-4 border-white shadow-lg">
                    <h2 id="wm-winner-name" class="text-3xl font-black uppercase text-white mt-3"></h2>
                    <p id="wm-win-margin" class="text-lg text-yellow-400 font-bold"></p>
                </div>

                <div class="p-3 bg-black/20 rounded-lg text-sm space-y-2 text-left animate-slide-up" style="--delay: 0.2s;">
                    <p id="wm-scoreline-1" class="flex justify-between items-center font-mono"></p>
                    <p id="wm-scoreline-2" class="flex justify-between items-center font-mono"></p>
                </div>

                <div class="grid grid-cols-2 gap-4 text-xs text-left animate-slide-up" style="--delay: 0.3s;">
                    <div>
                        <h4 class="font-bold text-gray-400 mb-1">TOP BATTERS</h4>
                        <div id="wm-top-batters" class="space-y-1 text-gray-200"></div>
                    </div>
                    <div>
                        <h4 class="font-bold text-gray-400 mb-1">TOP BOWLERS</h4>
                        <div id="wm-top-bowlers" class="space-y-1 text-gray-200"></div>
                    </div>
                </div>

                <div id="wm-mom-picker-section" class="text-left animate-slide-up" style="--delay: 0.4s;">
                    <h4 class="font-bold text-gray-400 mb-2 text-center text-xs tracking-wider">SELECT PLAYER OF THE MATCH</h4>
                    <div id="wm-mom-picker-list" class="space-y-1.5 max-h-48 overflow-y-auto p-2 bg-black/20 rounded-lg border border-gray-700">
                        </div>
                </div>

                <p id="wm-meta-line" class="text-center text-xs text-gray-500 border-t border-gray-700 pt-3 animate-slide-up" style="--delay: 0.5s;"></p>
                
                <button id="win-modal-confirm-btn" class="w-full mt-2 px-8 py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition-transform hover:scale-105 animate-slide-up" style="--delay: 0.6s;">Confirm & View Summary</button>
            </div>
        </div>
    </div>
    
    <div id="innings-break-modal" class="modal-overlay fixed inset-0 z-[60] hidden flex items-center justify-center bg-black/60 backdrop-blur-sm p-0 sm:p-4 transition-opacity duration-300">
    <div class="modal-content relative w-full h-full sm:h-auto sm:max-h-[90vh] sm:max-w-3xl bg-slate-900/70 backdrop-blur-2xl border border-white/10 shadow-2xl sm:rounded-3xl overflow-hidden flex flex-col transform transition-all duration-300 scale-95 opacity-0">
        
        <div class="flex-shrink-0 p-6 border-b border-white/10 bg-white/5 text-center">
            <h2 class="text-2xl sm:text-3xl font-black uppercase tracking-[0.2em] text-transparent bg-clip-text bg-gradient-to-r from-blue-300 to-white drop-shadow-sm" id="innings-break-title">INNINGS BREAK</h2>
        </div>

        <div class="flex-grow overflow-y-auto custom-scrollbar p-6 space-y-6">
            
            <div id="innings-summary-content" class="text-left space-y-6 text-sm text-white">
                <div class="bg-gradient-to-br from-blue-600/30 to-indigo-900/30 p-5 rounded-2xl border border-white/10 shadow-inner relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-full bg-gradient-to-b from-white/5 to-transparent pointer-events-none"></div>
                    
                    <div class="flex justify-between items-end relative z-10">
                        <div>
                            <span class="block text-xs font-bold text-blue-200 tracking-wider mb-1">BATTING TEAM</span>
                            <span id="ib-batting-team-name" class="text-2xl sm:text-3xl font-black tracking-tight text-white"></span>
                        </div>
                        <div class="text-right">
                            <div class="flex items-baseline justify-end gap-2">
                                <span id="ib-batting-team-score" class="text-4xl sm:text-5xl font-black text-white" style="text-shadow: 0 4px 20px rgba(59, 130, 246, 0.5);"></span>
                            </div>
                            <span id="ib-batting-team-overs" class="text-lg font-medium text-blue-200"></span>
                        </div>
                    </div>
                    <div id="ib-run-rate" class="text-xs font-bold text-blue-300 mt-2 uppercase tracking-wide border-t border-white/10 pt-2"></div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-white/5 rounded-xl border border-white/5 p-4 backdrop-blur-md">
                        <h4 class="font-bold mb-3 text-xs text-blue-300 tracking-widest uppercase border-b border-white/10 pb-2">Top Batters</h4>
                        <ul id="ib-top-batters" class="space-y-2 text-sm font-medium"></ul>
                    </div>
                    <div class="bg-white/5 rounded-xl border border-white/5 p-4 backdrop-blur-md">
                        <h4 class="font-bold mb-3 text-xs text-green-300 tracking-widest uppercase border-b border-white/10 pb-2">Top Bowlers</h4>
                        <ul id="ib-top-bowlers" class="space-y-2 text-sm font-medium"></ul>
                    </div>
                </div>

                <div class="bg-black/20 rounded-xl p-4 border border-white/5 space-y-4">
                    <div>
                        <h4 class="font-bold text-[10px] text-gray-400 tracking-widest uppercase mb-1">Fall of Wickets</h4>
                        <p id="ib-fow" class="text-xs leading-relaxed text-gray-300 font-mono"></p>
                    </div>
                    <div class="grid grid-cols-2 gap-4 pt-3 border-t border-white/5">
                        <div>
                            <h4 class="font-bold text-[10px] text-gray-400 tracking-widest uppercase mb-1">Extras</h4>
                            <p id="ib-extras" class="font-semibold text-white"></p>
                        </div>
                        <div>
                            <h4 class="font-bold text-[10px] text-gray-400 tracking-widest uppercase mb-1">Boundary Count</h4>
                            <p id="ib-boundaries" class="font-semibold text-white"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="flex-shrink-0 p-6 border-t border-white/10 bg-white/5 flex flex-col items-center gap-4">
            
            <div class="target-container w-full bg-gradient-to-r from-amber-400 to-yellow-500 text-black py-3 px-6 rounded-xl shadow-lg shadow-amber-500/20 flex flex-col sm:flex-row items-center justify-between">
                <div class="text-center sm:text-left">
                    <p id="innings-break-target-team" class="font-bold text-xs uppercase tracking-wide opacity-80"></p>
                    <p class="font-black text-xs uppercase tracking-wide">Target to win</p>
                </div>
                <div class="flex items-baseline gap-1 mt-1 sm:mt-0">
                    <p class="text-3xl font-black tracking-tighter" id="innings-break-target-runs"></p>
                    <span class="text-xs font-bold uppercase">Runs</span>
                </div>
            </div>
            
            <button id="start-second-innings-btn" class="w-full py-4 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-xl shadow-lg shadow-blue-600/30 transition-all transform active:scale-95 text-sm uppercase tracking-widest">
                Start 2nd Innings
            </button>
        </div>
    </div>
</div>

    <div id="player-out-summary-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-75 flex justify-center items-center hidden z-[70]">
        <div class="modal-content bg-white rounded-lg shadow-xl p-6 w-11/12 max-w-sm text-center transform scale-95 relative overflow-hidden">
            <img id="summary-team-logo" src="" class="absolute top-3 right-3 w-12 h-12 rounded-full object-cover shadow-md" onerror="this.style.display='none'">
            <div id="summary-player-image-container" class="w-24 h-24 mx-auto mb-2 rounded-full bg-gray-200 flex items-center justify-center border-4 border-white shadow-lg">
                 <svg class="w-16 h-16 text-gray-400" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path></svg>
            </div>
            <h2 id="summary-player-name" class="text-3xl font-bold text-gray-800">Player Name</h2>
            <p id="summary-dismissal-info" class="text-sm text-gray-500 mb-4 font-medium"></p>
            
            <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-left mt-6 bg-gray-50 p-4 rounded-lg">
                <div class="font-semibold text-gray-600">Runs</div>
                <div class="font-bold text-xl text-gray-900 text-right" id="summary-player-runs"></div>
                <div class="font-semibold text-gray-600">Balls Faced</div>
                <div class="font-bold text-xl text-gray-900 text-right" id="summary-player-balls"></div>
                <div class="font-semibold text-gray-600">Fours</div>
                <div class="font-bold text-xl text-gray-900 text-right" id="summary-player-fours"></div>
                <div class="font-semibold text-gray-600">Sixes</div>
                <div class="font-bold text-xl text-gray-900 text-right" id="summary-player-sixes"></div>
            </div>
            
            <button id="summary-ok-btn" class="mt-6 w-full px-6 py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition-colors">OK</button>
        </div>
    </div>
    
    <div id="preview-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-75 flex justify-center items-center hidden z-[60] p-4">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 class="text-xl font-bold">Download Preview</h3>
                <button onclick="closeModal('preview-modal')" class="text-gray-400 hover:text-gray-700">
                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="p-4 flex-grow overflow-y-auto bg-gray-200">
                <img id="preview-image" src="" alt="Match Summary Preview" class="w-full h-auto shadow-lg">
            </div>
            <div class="flex justify-end space-x-3 p-4 border-t bg-gray-50">
                <button onclick="closeModal('preview-modal')" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancel</button>
                <button id="confirm-download-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Download</button>
            </div>
        </div>
    </div>

    <div id="mom-choice-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-[70] p-4">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-lg max-h-[90vh] flex flex-col transform scale-95">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 class="text-xl font-bold">Choose Man of the Match</h3>
                <button onclick="closeModal('mom-choice-modal')" class="text-gray-400 hover:text-gray-700">
                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div id="mom-choice-list" class="p-4 overflow-y-auto space-y-2">
                <!-- Ranked player list will be injected here -->
            </div>
        </div>
    </div>

    <div id="squad-selection-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center hidden z-[60] p-4">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-lg max-h-[90vh] flex flex-col transform scale-95">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 id="squad-selection-title" class="text-xl font-bold">Select Squad</h3>
                <button onclick="cancelSquadSelection()" class="text-gray-400 hover:text-gray-700">
                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div id="squad-player-list" class="p-6 overflow-y-auto space-y-3">
                </div>
            <div class="flex justify-end space-x-3 p-4 border-t bg-gray-50">
                <p id="squad-selection-counter" class="text-sm text-gray-600 mr-auto flex items-center"></p>
                <button onclick="cancelSquadSelection()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancel</button>
                <button id="squad-confirm-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Confirm Selection</button>
            </div>
        </div>
    </div>
    <div id="freehit-confirm-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50">
    <div class="modal-content bg-white rounded-lg shadow-xl p-6 w-11/12 max-w-sm text-center transform scale-95">
        <h3 class="text-lg font-bold text-center mb-2">No Ball</h3>
        <p id="confirm-message" class="mb-6">Does this result in a Free Hit?</p>
        <div class="flex justify-center space-x-4">
            <button onclick="processFreeHitChoice(false)" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">No</button>
            <button onclick="processFreeHitChoice(true)" class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Yes, Award Free Hit</button>
        </div>
    </div>
</div>

<div id="freehit-indicator-container" class="hidden absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-black/70 p-4 rounded-lg z-40 pointer-events-none">
    <h2 class="text-5xl font-black text-white tracking-widest" style="text-shadow: 0 0 15px rgba(59, 130, 246, 0.8);">FREE HIT</h2>
</div> 
<script>
    function togglePitchMap() {
    state.isPitchMapEnabled = !state.isPitchMapEnabled;
    updatePitchMapToggleUI();
    localStorage.setItem('isPitchMapEnabled_v1', state.isPitchMapEnabled);
}

function updatePitchMapToggleUI() {
    const toggle = document.getElementById('pitch-map-toggle');
    const knob = document.getElementById('pitch-map-toggle-knob');
    if (state.isPitchMapEnabled) {
        toggle.classList.remove('bg-gray-400');
        toggle.classList.add('bg-blue-600');
        knob.classList.remove('translate-x-0');
        knob.classList.add('translate-x-4');
    } else {
        toggle.classList.remove('bg-blue-600');
        toggle.classList.add('bg-gray-400');
        knob.classList.remove('translate-x-4');
        knob.classList.add('translate-x-0');
    }
}

function openPitchMapModal(runs, oldScore) {
    state.pendingShot = { runs, oldScore };
    openModal('pitch-map-modal');
}

function markShot(region) {
    if (!state.pendingShot) return;
    const { runs, oldScore } = state.pendingShot;
    state.pendingShot = null;
    closeModal('pitch-map-modal');

    // Generate specific commentary
    let commentary = `<b>${runs === 4 ? 'FOUR!' : 'SIX!'}</b> `;
    commentary += `A great shot from ${formatPlayerName(state.striker.name)}, hit towards <b>${region}</b> for a boundary!`;

    // Trigger animation and update commentary
    triggerEventAnimation(runs === 4 ? 'FOUR!' : 'SIX!', runs === 4 ? 'text-yellow-400' : 'text-green-500');
    
    // Check for milestones (copied from addRuns)
    let milestoneReached = false;
    if (oldScore < 100 && state.striker.runs >= 100) {
        generateRealCommentary('milestone_100', { striker: state.striker });
        milestoneReached = true;
    } else if (oldScore < 50 && state.striker.runs >= 50) {
        generateRealCommentary('milestone_50', { striker: state.striker });
        milestoneReached = true;
    }

    // Update live commentary after animation/milestone
    setTimeout(() => {
        updateLiveCommentary(commentary);
    }, milestoneReached ? 1500 : (runs === 4 || runs === 6) ? 1500 : 0);
}

function cancelShotMarking(useGeneric = false) {
    if (!state.pendingShot) return;
    const { runs, oldScore } = state.pendingShot;
    state.pendingShot = null;
    closeModal('pitch-map-modal');

    if (useGeneric) {
        // User clicked "Skip", so use the generic commentary
        triggerEventAnimation(runs === 4 ? 'FOUR!' : 'SIX!', runs === 4 ? 'text-yellow-400' : 'text-green-500');

        let milestoneReached = false;
        if (oldScore < 100 && state.striker.runs >= 100) {
            generateRealCommentary('milestone_100', { striker: state.striker });
            milestoneReached = true;
        } else if (oldScore < 50 && state.striker.runs >= 50) {
            generateRealCommentary('milestone_50', { striker: state.striker });
            milestoneReached = true;
        }

        setTimeout(() => {
            generateRealCommentary('runs', {
                runs: runs,
                bowler: state.bowler,
                striker: state.striker,
                nonStriker: state.nonStriker
            });
        }, milestoneReached ? 1500 : (runs === 4 || runs === 6) ? 1500 : 0);
    }
    // If useGeneric is false (closed with 'X'), just close the modal.
}
    function populatePlayerOptions(selectElement, teamKey, { disabledIds = [], isOutFilter = false, addBlankOption = false, blankOptionText = 'Select Player' } = {}) {
    if (!selectElement || !state[teamKey] || !state[teamKey].players) return;

    const currentSelection = selectElement.value; // Preserve selection
    selectElement.innerHTML = '';

    if (addBlankOption) {
        const blankOpt = document.createElement('option');
        blankOpt.value = '';
        blankOpt.textContent = blankOptionText;
        blankOpt.disabled = true;
        selectElement.appendChild(blankOpt);
    }

    const players = state[teamKey].players; // Array of player objects

    players.forEach(player => {
        if (!player || !player.id) return;

        const playerStats = state[teamKey].playerStats[player.id];
        if (!playerStats) return;

        // FIX: If the filter is on and the player is out, skip them completely.
        if (isOutFilter && playerStats.isOut) {
            return; // Do not create an <option> for this player.
        }

        const option = document.createElement('option');
        option.value = player.id;
        option.textContent = playerStats.name; // Use the fresh name from playerStats

        // Disable only if they are an active batter/bowler, not because they are out.
        if (disabledIds.includes(player.id)) {
            option.disabled = true;
            option.classList.add('text-gray-400');
        }

        selectElement.appendChild(option);
    });

    // Restore selection if the previously selected player still exists
    if (Array.from(selectElement.options).some(opt => opt.value === currentSelection)) {
        selectElement.value = currentSelection;
    }
}
        const EXPERIMENT_ENABLE__FOOTER_REMATCH = true;
        // --- ALL JAVASCRIPT IS IDENTICAL AND REMAINS UNCHANGED ---
        // ... (script content from your original file) ...
        // --- STATE MANAGEMENT ---
const state = {
    id: null, innings: 1, target: 0, totalOvers: 20, playersPerSide: 11, venue: '', matchDate: '',
    team1: {
        name: "HOME TEAM", score: 0, wickets: 0, overs: 0, balls: 0, squad: [], playing: [], 
        playerStats: {}, inningsHistory: [], extras: { b: 0, lb: 0, wd: 0, nb: 0, total: 0 }
    },
    team2: {
        name: "AWAY TEAM", score: 0, wickets: 0, overs: 0, balls: 0, squad: [], playing: [],
        playerStats: {}, inningsHistory: [], extras: { b: 0, lb: 0, wd: 0, nb: 0, total: 0 }
    },
    battingTeam: 'team1', bowlingTeam: 'team2',
    striker: null, nonStriker: null, bowler: null, lastBowler: null,
    currentOver: [], history: [], redoHistory: [], isScoringLocked: false, manOfTheMatch: null, winner: null,
    winMargin: '', toss: {}, pendingExtra: null, result: null, isFreeHit: false,
    isPitchMapEnabled: false, // NEW
    pendingShot: null // NEW (e.g., { runs: 4, oldScore: 10 })
};

let currentPlayerSelection = {};
let alertCallback = null;
let downloadAction = null;
let tossWinnerKey = null;
let tossDecision = 'bat';
let savedTeamsData = [];
let currentTeamSelectionKey = null;

// --- AUTOSAVE AND REFRESH-SAFE LOGIC ---
function debounce(func, delay) {
    let timeout;
    return function(...args) {
        const context = this;
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(context, args), delay);
    };
}

const saveStateToLocal = () => {
    try {
        // We don't need to save the undo history, it can be cleared on refresh.
        const stateToSave = { ...state, history: [] };
        localStorage.setItem('matchState_v1', JSON.stringify(stateToSave));
    } catch (e) {
        console.error("Failed to save state to localStorage:", e);
    }
};

const debouncedSave = debounce(saveStateToLocal, 200);

        // --- DOM ELEMENTS ---
        const ui = {
            setupScreen: document.getElementById('setup-screen'),
            appScreen: document.getElementById('app'),
            summaryScreen: document.getElementById('summary-screen'),
            eventAnimationOverlay: document.getElementById('event-animation-overlay'),
            eventAnimationText: document.getElementById('event-animation-text'),
            totalOversInput: document.getElementById('total-overs'),
            playersPerSideInput: document.getElementById('players-per-side'),
            venueInput: document.getElementById('venue'),
            matchDateInput: document.getElementById('match-date-input'),
            team1NameInput: document.getElementById('team1-name-input'),
            team2NameInput: document.getElementById('team2-name-input'),
            team1ColorInput: document.getElementById('team1-color-input'),
            team2ColorInput: document.getElementById('team2-color-input'),
            team1LogoInput: document.getElementById('team1-logo-input'),
            team2LogoInput: document.getElementById('team2-logo-input'),
            team1PlayerInputs: document.getElementById('team1-player-inputs'),
            team2PlayerInputs: document.getElementById('team2-player-inputs'),
            team1RosterTitle: document.getElementById('team1-roster-title'),
            team2RosterTitle: document.getElementById('team2-roster-title'),
            team1RosterLogo: document.getElementById('team1-roster-logo'),
            team2RosterLogo: document.getElementById('team2-roster-logo'),
            progressBar: document.getElementById('progress-bar'),
            progressContainer: document.getElementById('progress-container'),
            matchHeader: document.getElementById('match-header'),
            teamScoresContainer: document.getElementById('team-scores-container'),
            targetInfoContainer: document.getElementById('target-info-container'),
            battingTable: document.getElementById('batting-table'),
            bowlingTable: document.getElementById('bowling-table'),
            bowlerPromptOverlay: document.getElementById('bowler-prompt-overlay'),
            liveCommentaryBox: document.getElementById('live-commentary-box'),
            scoringControls: document.getElementById('scoring-controls'),
            playerModal: document.getElementById('player-modal'),
            modalTitle: document.getElementById('modal-title'),
            playerSelect: document.getElementById('player-select'),
            playerSaveBtn: document.getElementById('player-save-btn'),
            playerModalCancelBtnX: document.getElementById('player-modal-cancel-btn-x'),
            playerModalCancelBtnText: document.getElementById('player-modal-cancel-btn-text'),
            alertModal: document.getElementById('alert-modal'),
            alertMessage: document.getElementById('alert-message'),
            alertOkBtn: document.getElementById('alert-ok-btn'),
            confirmModal: document.getElementById('confirm-modal'),
            confirmMessage: document.getElementById('confirm-message'),
            confirmOkBtn: document.getElementById('confirm-ok-btn'),
            confirmCancelBtn: document.getElementById('confirm-cancel-btn'),
            runOutOptions: document.getElementById('run-out-options'),
            tossWinnerTeam1: document.getElementById('toss-winner-team1'),
            tossWinnerTeam2: document.getElementById('toss-winner-team2'),
            tossTeam1Name: document.getElementById('toss-team1-name'),
            tossTeam2Name: document.getElementById('toss-team2-name'),
            tossTeam1LogoContainer: document.getElementById('toss-team1-logo-container'),
            tossTeam2LogoContainer: document.getElementById('toss-team2-logo-container'),
            tossChoiceBat: document.getElementById('toss-choice-bat'),
            tossChoiceBowl: document.getElementById('toss-choice-bowl'),
            tossDecisionContainer: document.getElementById('toss-decision-container'),
            startMatchBtn: document.getElementById('start-match-btn'),
            winModal: document.getElementById('win-modal'),
            confettiContainer: document.getElementById('confetti-container'),
            previewImage: document.getElementById('preview-image'),
            confirmDownloadBtn: document.getElementById('confirm-download-btn'),
            setupCard: document.querySelector('.setup-card'),
            setupStep4: document.getElementById('setup-step-4'),
            liveCommentary: document.getElementById('live-commentary'),
            team1Select: document.getElementById('team1-select'),
            team2Select: document.getElementById('team2-select'),
        };
        function selectFielderForCatch() {
    const fielderSelect = document.getElementById('fielder-select');
    const fieldingTeamKey = state.bowlingTeam;

    populatePlayerOptions(fielderSelect, fieldingTeamKey, { 
        addBlankOption: true, 
        blankOptionText: 'Select Fielder' 
    });

    // Set up the confirm button
    const confirmBtn = document.getElementById('fielder-save-btn');
    confirmBtn.onclick = () => {
        const selectedFielderId = fielderSelect.value;
        if (selectedFielderId) {
            const fielderName = state[fieldingTeamKey].playerStats[selectedFielderId].name;
            processWicket('Catch', state.striker.playerId, fielderName, selectedFielderId);
            closeModal('fielder-modal');
        }
    };

    openModal('fielder-modal');
}

        // --- HELPER FUNCTIONS ---
        function showChoiceConfirm(title, message, buttons) {
    document.getElementById('choice-confirm-title').textContent = title;
    document.getElementById('choice-confirm-message').textContent = message;
    const buttonsContainer = document.getElementById('choice-confirm-buttons');
    buttonsContainer.innerHTML = '';

    buttons.forEach(btn => {
        const buttonEl = document.createElement('button');
        buttonEl.textContent = btn.text;
        buttonEl.className = btn.class || 'px-6 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300';
        buttonEl.onclick = () => {
            closeModal('choice-confirm-modal');
            if (btn.callback) btn.callback();
        };
        buttonsContainer.appendChild(buttonEl);
    });

    openModal('choice-confirm-modal');
}

function shiftBatterContribution({ fromBatterId, toBatterId, scope = 'currentStint' }) {
    const battingTeamKey = state.battingTeam;
    const inningsHistory = state[battingTeamKey].inningsHistory;
    if (inningsHistory.length === 0) return;

    saveState(); // Save state for undo functionality

    let ballIndicesToChange = [];

    if (scope === 'lastBall') {
        // Find the absolute last ball of the innings and check if it was faced by the 'from' batter
        if (inningsHistory.length > 0) {
             const lastBall = inningsHistory[inningsHistory.length - 1];
             if (lastBall.batterId === fromBatterId) {
                ballIndicesToChange.push(inningsHistory.length - 1);
             }
        }
    } else { // scope === 'currentStint'
        // 1. Find the start of the current stint.
        let stintStartIndex = 0;
        // Iterate backwards to find the last wicket. The stint starts on the next ball.
        for (let i = inningsHistory.length - 1; i >= 0; i--) {
            const ball = inningsHistory[i];
            if (ball.event === 'W' || (ball.event || '').includes('+W')) {
                stintStartIndex = i + 1;
                break;
            }
        }

        // 2. Collect all ball indices within that stint faced by the 'from' batter
        for (let i = stintStartIndex; i < inningsHistory.length; i++) {
            if (inningsHistory[i].batterId === fromBatterId) {
                ballIndicesToChange.push(i);
            }
        }
    }

    if (ballIndicesToChange.length === 0) {
        console.log("No balls found for the 'from' batter in the selected scope. No changes made.");
        return;
    }

    // 3. Re-attribute all identified balls
    ballIndicesToChange.forEach(index => {
        const ball = inningsHistory[index];
        ball.batterId = toBatterId;

        // If this ball was a wicket, the dismissal must also be moved
        if (ball.dismissalInfo) {
            const fromPlayerStats = state[battingTeamKey].playerStats[fromBatterId];
            if (fromPlayerStats) {
                fromPlayerStats.isOut = false;
                fromPlayerStats.dismissalInfo = null;
            }
            const toPlayerStats = state[battingTeamKey].playerStats[toBatterId];
            if (toPlayerStats) {
                toPlayerStats.isOut = true;
                toPlayerStats.dismissalInfo = ball.dismissalInfo;
            }
        }
    });

    // 4. Recalculate all stats from the ground up and update UI
    recalculateAllPlayerStats();
}

function recalculateAllPlayerStats() {
    // Recalculate for both teams to be safe
    ['team1', 'team2'].forEach(teamKey => {
        if (!state[teamKey] || !state[teamKey].playerStats) return;

        // 1. Reset all numeric stats for every player on the team
        Object.keys(state[teamKey].playerStats).forEach(playerId => {
            const stats = state[teamKey].playerStats[playerId];
            stats.runs = 0;
            stats.balls = 0;
            stats.fours = 0;
            stats.sixes = 0;
            stats.ballsBowled = 0;
            stats.runsConceded = 0;
            stats.wickets = 0;
            stats.maidens = 0;
            stats.dots = 0;
        });

        // 2. Iterate through the entire innings history and re-apply stats
        const inningsHistory = state[teamKey].inningsHistory || [];
        inningsHistory.forEach(ball => {
            const batterStats = state[teamKey].playerStats[ball.batterId];
            const bowlerTeamKey = teamKey === 'team1' ? 'team2' : 'team1';
            const bowlerStats = state[bowlerTeamKey].playerStats[ball.bowlerId];

            const runs = parseBallEvent(ball.event);
            const isLegal = isLegalDelivery(ball.event);

            // Apply batter stats
            if (batterStats && !ball.extraType) { // Batting stats only apply for non-extra runs
                batterStats.runs += runs;
                if(isLegal) batterStats.balls++;
                if (runs === 4) batterStats.fours++;
                if (runs === 6) batterStats.sixes++;
            }

            // Apply bowler stats
            if (bowlerStats) {
                bowlerStats.runsConceded += runs;
                if(isLegal) {
                    bowlerStats.ballsBowled++;
                    if (runs === 0 && ball.event !== 'W') bowlerStats.dots++;
                    if (ball.event === 'W') bowlerStats.wickets++;
                }
            }
        });
    });

    // 3. Refresh the active player objects (striker, non-striker, bowler) with the new data
    if (state.striker) {
        state.striker = { ...state[state.battingTeam].playerStats[state.striker.playerId] };
    }
    if (state.nonStriker) {
        state.nonStriker = { ...state[state.battingTeam].playerStats[state.nonStriker.playerId] };
    }
    if (state.bowler) {
        state.bowler = { ...state[state.bowlingTeam].playerStats[state.bowler.playerId] };
    }
}
        function generateUniqueId() {
            return `player_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        }
        function toTitleCase(str) {
            if (!str) return '';
            return str.replace(
                /\w\S*/g,
                (txt) => txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase()
            );
        }
        function hexToRgba(hex, alpha = 0.1) {
            if (!hex || hex.length < 7) hex = '#ffffff'; // Default to white if color is invalid
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }
        function formatPlayerName(fullName) {
            if (!fullName || typeof fullName !== 'string') {
                return '';
            }
            // Return the full name after trimming whitespace, without shortening the last name.
            return fullName.trim();
        }

        // --- NEW HELPER FUNCTIONS as requested ---
        const toInt = v => {
            const n = parseInt(v, 10);
            return isNaN(n) ? 0 : n;
        };

        const toNum = v => {
            const n = parseFloat(v);
            return isNaN(n) ? 0 : n;
        };
        
        const formatOvers = (totalBalls) => {
            if (totalBalls < 0) totalBalls = 0;
            return {
                overs: Math.floor(totalBalls / 6),
                balls: totalBalls % 6
            };
        };
        
        const parseOversToBalls = (overs, balls) => {
            return (toInt(overs) * 6) + toInt(balls);
        };

        function sanitizeState(s) {
            // Sanitize top-level
            s.innings = toInt(s.innings);
            s.target = toInt(s.target);
            s.totalOvers = toInt(s.totalOvers);
            s.playersPerSide = toInt(s.playersPerSide);

            // Sanitize teams
            ['team1', 'team2'].forEach(teamKey => {
                if (s[teamKey]) {
                    const team = s[teamKey];
                    team.score = toInt(team.score);
                    team.wickets = toInt(team.wickets);
                    team.overs = toInt(team.overs);
                    team.balls = toInt(team.balls);
                    
                    // Sanitize extras
                    if (team.extras) {
                        team.extras.b = toInt(team.extras.b);
                        team.extras.lb = toInt(team.extras.lb);
                        team.extras.wd = toInt(team.extras.wd);
                        team.extras.nb = toInt(team.extras.nb);
                        team.extras.total = toInt(team.extras.total);
                    }

                    // Sanitize playerStats
                    if (team.playerStats) {
                        Object.values(team.playerStats).forEach(player => {
                            if (player) { // Add safety check for player object
                                player.runs = toInt(player.runs);
                                player.balls = toInt(player.balls);
                                player.fours = toInt(player.fours);
                                player.sixes = toInt(player.sixes);
                                player.ballsBowled = toInt(player.ballsBowled);
                                player.runsConceded = toInt(player.runsConceded);
                                player.wickets = toInt(player.wickets);
                                player.maidens = toInt(player.maidens);
                                player.dots = toInt(player.dots);
                                player.foursConceded = toInt(player.foursConceded);
                                player.sixesConceded = toInt(player.sixesConceded);
                                player.consecutiveFours = toInt(player.consecutiveFours);
                                player.consecutiveSixes = toInt(player.consecutiveSixes);
                            }
                        });
                    }
                }
            });

            // Sanitize active players (by re-copying from sanitized stats)
            try {
                if (s.striker && s.battingTeam && s[s.battingTeam].playerStats[s.striker.playerId]) {
                    s.striker = { ...s[s.battingTeam].playerStats[s.striker.playerId] };
                }
                if (s.nonStriker && s.battingTeam && s[s.battingTeam].playerStats[s.nonStriker.playerId]) {
                    s.nonStriker = { ...s[s.battingTeam].playerStats[s.nonStriker.playerId] };
                }
                if (s.bowler && s.bowlingTeam && s[s.bowlingTeam].playerStats[s.bowler.playerId]) {
                    s.bowler = { ...s[s.bowlingTeam].playerStats[s.bowler.playerId] };
                }
            } catch (e) {
                console.error("Error sanitizing active players:", e);
                // This might happen if player IDs are out of sync, force a reset
                s.striker = null;
                s.nonStriker = null;
                s.bowler = null;
            }
        }
        function proceedFromStep3() {
            const playersSelected = ui.team2PlayerInputs.querySelectorAll('input[type="checkbox"]:checked').length;
            const playersRequired = parseInt(ui.playersPerSideInput.value) || 11;

            if (!state.team2.isLoaded) { // Only validate and save if manually entered
                 // Allow selecting *at least* the required number, plus reserves
                if (playersSelected < playersRequired) {
                    showAlert(`Please select at least ${playersRequired} players for the team.`);
                    return;
                }
                savePlayerInputsToState('team2');
            }
            // Navigate to Step 4, indicating we came from Step 3
            goToStep(4, 3);
        }

        function parseBallEvent(event) {
            if (!event) return 0;
            const e = event.trim().toUpperCase();
            if (e === '.' || e === 'W') return 0;

            // Simple number runs (0, 1, 2, 3, 4, 6)
            const simpleRuns = parseInt(e);
            if (!isNaN(simpleRuns) && simpleRuns >= 0 && simpleRuns <= 6) {
                return simpleRuns;
            }

            // Extras
            if (e.startsWith('WD')) {
                const runs = parseInt(e.substring(2)) || 0;
                return 1 + runs;
            }
            if (e.startsWith('NB')) {
                const runs = parseInt(e.substring(2)) || 0;
                return 1 + runs;
            }
            if (e.startsWith('B')) {
                return parseInt(e.substring(1)) || 0;
            }
            if (e.startsWith('LB')) {
                return parseInt(e.substring(2)) || 0;
            }

            return 0; // Return 0 for any unrecognised format
        }
function processFreeHitChoice(awardFreeHit) {
    if (!state.pendingExtra || state.pendingExtra.type !== 'nb') return;
    saveState();

    state.isFreeHit = awardFreeHit;

    const { type, runs } = state.pendingExtra;
    state.pendingExtra = null; 

    const baseExtraRun = 1;
    const totalRuns = baseExtraRun + runs;

    const battingTeam = state[state.battingTeam];
    battingTeam.score += totalRuns;
    battingTeam.extras[type] += totalRuns;
    battingTeam.extras.total += totalRuns;

    if (state.bowler) {
        state.bowler.runsConceded += totalRuns;
    }

    state.striker.consecutiveFours = 0;
    state.striker.consecutiveSixes = 0;

    let ballEvent = 'NB';
    if (runs > 0) {
        ballEvent += `+${runs}`;
    }

    const ballData = { event: ballEvent, runs: totalRuns, batterId: state.striker.playerId, bowlerId: state.bowler.playerId, extraType: type };
    battingTeam.inningsHistory.push(ballData);
    state.currentOver.push({ event: ballEvent, runs: totalRuns });

    generateRealCommentary('extra', { extraType: type, runs: runs, bowler: state.bowler.name });
    if (awardFreeHit) {
        updateLiveCommentary('<b>Free hit</b> on the next ball.', true);
    }

    if (runs > 0 && runs % 2 !== 0) {
        swapBatsmen();
    }

    closeModal('freehit-confirm-modal');
    updateUI();
    checkWinCondition();
}

function updateFreeHitIndicator() {
    const indicator = document.getElementById('freehit-indicator-container');
    if (!indicator) return;

    const shouldShow = state.isFreeHit && !state.isScoringLocked;

    if (shouldShow) {
        indicator.classList.remove('hidden');
    } else {
        indicator.classList.add('hidden');
    }
}
        // --- SETUP LOGIC ---
        function savePlayerInputsToState(teamKey) {
            const playerInputsContainer = (teamKey === 'team1') ? ui.team1PlayerInputs : ui.team2PlayerInputs;
            const playerRows = playerInputsContainer.querySelectorAll('.player-input-row');
            
            state[teamKey].playing = []; // Reset the playing list before saving.
            
            playerRows.forEach(row => {
                const playerId = row.dataset.playerId;
                const player = state[teamKey].squad.find(p => p.id === playerId);
                if (player) {
                    const nameInput = row.querySelector('input[type="text"]');
                    const imageSrc = nameInput.dataset.imageSrc || player.image || '';
                    player.name = nameInput.value;
                    player.image = imageSrc;

                    const checkbox = row.querySelector('input[type="checkbox"]');
                    if (checkbox && checkbox.checked) {
                        state[teamKey].playing.push(playerId);
                    }
                }
            });
        }
        
        function generatePlayerInputs(teamKey) {
            const container = (teamKey === 'team1') ? ui.team1PlayerInputs : ui.team2PlayerInputs;
            container.innerHTML = '';

            const numPlayers = parseInt(ui.playersPerSideInput.value) || 11;
            const totalFields = numPlayers + 2;

            while (state[teamKey].squad.length < totalFields) {
                state[teamKey].squad.push({ id: generateUniqueId(), name: '', image: '' });
            }
            state[teamKey].squad.length = totalFields;

            state[teamKey].squad.forEach((player, index) => {
                let placeholder = 'Player Name';
                if (index >= numPlayers) placeholder = `Reserve Player ${index - numPlayers + 1}`;
                
                // For a new match, auto-select the first N players. For a rematch, this will be empty.
                const isSelected = state[teamKey].playing.length > 0 ? state[teamKey].playing.includes(player.id) : index < numPlayers;
                
                createPlayerInputRow(container, player, index + 1, placeholder, isSelected);
            });
        }

        function createPlayerInputRow(container, player, index, placeholder, isSelected) {
            const playerRow = document.createElement('div');
            playerRow.className = 'flex items-center gap-3 player-input-row';
            playerRow.dataset.playerId = player.id;

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.checked = isSelected;
            checkbox.className = 'h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500 cursor-pointer flex-shrink-0';

            const imageContainer = document.createElement('div');
            imageContainer.className = 'w-10 h-10 flex-shrink-0';
            const imagePreview = document.createElement('img');
            const defaultImage = `data:image/svg+xml;base64,${btoa('<svg class="w-10 h-10 text-gray-400" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path></svg>')}`;
            imagePreview.src = player.image || defaultImage;
            imagePreview.alt = `Player ${index} Image`;
            imagePreview.className = 'w-10 h-10 rounded-full object-cover bg-gray-200 cursor-pointer hover:opacity-80 transition';

            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.className = 'hidden';
            fileInput.accept = 'image/*';

            const nameInput = document.createElement('input');
            nameInput.type = 'text';
            nameInput.placeholder = placeholder;
            nameInput.value = player.name || ''; // Use player.name which is now normalized
            nameInput.className = 'w-full p-2 border-gray-300 border rounded-md focus:ring-blue-500 focus:border-blue-500 transition';
            nameInput.style.textTransform = 'uppercase';
            nameInput.dataset.imageSrc = player.image || '';

            fileInput.onchange = () => {
                if (fileInput.files && fileInput.files[0]) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        imagePreview.src = e.target.result;
                        nameInput.dataset.imageSrc = e.target.result;
                    };
                    reader.readAsDataURL(fileInput.files[0]);
                }
            };

            imagePreview.onclick = () => fileInput.click();

            playerRow.appendChild(checkbox);
            imageContainer.appendChild(imagePreview);
            imageContainer.appendChild(fileInput);
            playerRow.appendChild(imageContainer);
            playerRow.appendChild(nameInput);
            container.appendChild(playerRow);
        }
        
        function selectTossWinner(teamKey) {
            tossWinnerKey = teamKey;
            ui.tossDecisionContainer.classList.remove('hidden');
            ui.startMatchBtn.disabled = false;
            ui.startMatchBtn.classList.remove('opacity-50', 'cursor-not-allowed');

            if (teamKey === 'team1') {
                ui.tossWinnerTeam1.classList.add('selected');
                ui.tossWinnerTeam2.classList.remove('selected');
            } else {
                ui.tossWinnerTeam2.classList.add('selected');
                ui.tossWinnerTeam1.classList.remove('selected');
            }
        }

        function selectTossChoice(choice) {
            tossDecision = choice;
                 if (choice === 'bat') {
                ui.tossChoiceBat.classList.add('selected');
                ui.tossChoiceBowl.classList.remove('selected');
            } else {
                ui.tossChoiceBowl.classList.add('selected');
                ui.tossChoiceBat.classList.remove('selected');
            }
        }


        function goToStep(step, fromStep = null) {
            const activeStepElement = document.querySelector('.setup-step.active');
            const currentStepNum = activeStepElement ? parseInt(activeStepElement.id.split('-')[2]) : 0; // Corrected index from 3 to 2
            fromStep = fromStep || currentStepNum; // Determine the step we are coming FROM

            console.log(`Navigating to step ${step} from step ${fromStep}`);

            // --- Validation & Data Saving ---
            if (step > fromStep) { // Only validate/save when moving FORWARD
                if (fromStep === 1) {
                    // --- NEW: Added more validation checks ---
                    if (!ui.venueInput.value.trim()) { showAlert('Please enter the Venue name.'); return; }
                    if (!ui.totalOversInput.value) { showAlert('Please select a match format.'); return; }
                    if (!ui.playersPerSideInput.value) { showAlert('Please select the number of players per side.'); return; }
                    if (!ui.team1NameInput.value.trim()) { showAlert('Please enter the Home Team name.'); return; }
                    if (!ui.team2NameInput.value.trim()) { showAlert('Please enter the Away Team name.'); return; }
                    // --- END NEW CHECKS ---

                    // Save team details from step 1 IF they weren't loaded
                    if (!state.team1.isLoaded) {
                        state.team1.name = (ui.team1NameInput.value.trim() || 'HOME TEAM').toUpperCase();
                        // state.team1.color = ui.team1ColorInput.value; // Color input removed previously
                        handleLogoUpload(ui.team1LogoInput.files[0], 'team1');
                    }
                     if (!state.team2.isLoaded) {
                        state.team2.name = (ui.team2NameInput.value.trim() || 'AWAY TEAM').toUpperCase();
                        // state.team2.color = ui.team2ColorInput.value; // Color input removed previously
                        handleLogoUpload(ui.team2LogoInput.files[0], 'team2');
                    }
                } else if (fromStep === 2) {
                     savePlayerInputsToState('team1'); // Save manually entered team 1 players
                 } else if (fromStep === 3) {
                     savePlayerInputsToState('team2'); // Save manually entered team 2 players
                 }
            }

            // --- Skip Logic ---
            if (step === 2 && fromStep === 1) { // Trying to go from Details to Team 1 Roster
                if (state.team1.isLoaded) {
                    console.log("Skipping Step 2 (Team 1 loaded)");
                    goToStep(3, 1); // Skip to Team 2 roster entry/check, pretending we came from step 1
                    return;
                }
            }
            if (step === 3 && fromStep < 3) { // Trying to go to Team 2 Roster (from Step 1 or potentially skipped Step 2)
                if (state.team2.isLoaded) {
                     console.log("Skipping Step 3 (Team 2 loaded)");
                     goToStep(4, fromStep); // Skip directly to Toss
                     return;
                 }
            }

             // --- Hide Current, Show Next ---
             if (activeStepElement) {
                activeStepElement.classList.remove('active');
                activeStepElement.classList.add('hidden');
             }
             const nextStepElement = document.getElementById(`setup-step-${step}`);
             if (!nextStepElement) {
                 console.error(`Setup step ${step} not found.`);
                 return;
             }
             nextStepElement.classList.remove('hidden');
             nextStepElement.classList.add('active');

            // --- Update Progress Bar ---
            let progress = 25 * step;
            ui.progressBar.style.width = `${progress}%`;

            // --- Step-Specific Setup ---
             if (step === 2 && !state.team1.isLoaded) { // Only generate if NOT loaded/skipped
                 if (state.team1.logo) { ui.team1RosterLogo.src = state.team1.logo; ui.team1RosterLogo.classList.remove('hidden'); }
                 else { ui.team1RosterLogo.classList.add('hidden'); }
                 ui.team1RosterTitle.textContent = state.team1.name;
                 generatePlayerInputs('team1'); // Generate inputs for manual entry
             }
             if (step === 3 && !state.team2.isLoaded) { // Only generate if NOT loaded/skipped
                 if (state.team2.logo) { ui.team2RosterLogo.src = state.team2.logo; ui.team2RosterLogo.classList.remove('hidden'); }
                 else { ui.team2RosterLogo.classList.add('hidden'); }
                 ui.team2RosterTitle.textContent = state.team2.name;
                 generatePlayerInputs('team2'); // Generate inputs for manual entry
             }
            if (step === 4) {
                // --- DATE-BASED UI LOGIC ---
                const matchDateVal = ui.matchDateInput.value;
                const today = new Date();
                const matchDate = new Date(matchDateVal + 'T00:00:00');
                today.setHours(0, 0, 0, 0);
                const isFutureDate = matchDate > today;

                const startMatchBtn = document.getElementById('start-match-btn');
                const tossFlowContainer = document.getElementById('toss-flow-container');
                const header = ui.setupStep4.querySelector('h1');
                const subHeader = ui.setupStep4.querySelector('p');

                if (isFutureDate) {
                    header.textContent = 'Schedule Match';
                    subHeader.textContent = 'This match is scheduled for a future date and will be saved.';
                    tossFlowContainer.style.display = 'none';
                    startMatchBtn.textContent = 'Save Upcoming Match';
                    startMatchBtn.onclick = saveMatchForLater;
                    startMatchBtn.disabled = false;
                    startMatchBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                } else {
                    header.textContent = 'Toss Result';
                    subHeader.textContent = 'Select the toss winner and their choice';
                    tossFlowContainer.style.display = 'block';
                    startMatchBtn.textContent = 'Start Match';
                    startMatchBtn.onclick = startMatch;
                    startMatchBtn.disabled = true; // Re-disabled until toss complete
                    startMatchBtn.classList.add('opacity-50', 'cursor-not-allowed'); // Re-add classes

                    tossWinnerKey = null; // Reset toss state
                    tossDecision = 'bat';
                    ui.tossDecisionContainer.classList.add('hidden');
                    ui.tossWinnerTeam1.classList.remove('selected');
                    ui.tossWinnerTeam2.classList.remove('selected');
                    selectTossChoice('bat'); // Set default choice visual
                }
                // --- END OF DATE-BASED UI LOGIC ---

                // Ensure team names and logos are correct based on final state data
                ui.tossTeam1Name.textContent = state.team1.name;
                if (state.team1.logo) {
                    ui.tossTeam1LogoContainer.innerHTML = `<img src="${state.team1.logo}" class="w-full h-full object-cover rounded-full">`;
                    ui.tossTeam1LogoContainer.style.backgroundColor = '';
                } else {
                    ui.tossTeam1LogoContainer.style.backgroundColor = state.team1.color;
                    ui.tossTeam1LogoContainer.innerHTML = `<span>${state.team1.name.charAt(0)}</span>`;
                }

                ui.tossTeam2Name.textContent = state.team2.name;
                if (state.team2.logo) {
                    ui.tossTeam2LogoContainer.innerHTML = `<img src="${state.team2.logo}" class="w-full h-full object-cover rounded-full">`;
                    ui.tossTeam2LogoContainer.style.backgroundColor = '';
                } else {
                    ui.tossTeam2LogoContainer.style.backgroundColor = state.team2.color;
                    ui.tossTeam2LogoContainer.innerHTML = `<span>${state.team2.name.charAt(0)}</span>`;
                }
            }
        }

        function handleLogoUpload(file, teamKey) {
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    state[teamKey].logo = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }
        
        const beforeUnloadHandler = (event) => {
            event.preventDefault();
            event.returnValue = '';
            return 'Are you sure you want to leave? All scoring data will be lost.';
        };

       function startMatch() {
            console.log("startMatch called"); // Log start
            state.totalOvers = parseInt(ui.totalOversInput.value);
            state.playersPerSide = parseInt(ui.playersPerSideInput.value);
            state.venue = ui.venueInput.value || 'The Local Ground';
            state.matchDate = ui.matchDateInput.value;
            state.team1.name = (ui.team1NameInput.value || 'HOME TEAM').toUpperCase();
            state.team2.name = (ui.team2NameInput.value || 'AWAY TEAM').toUpperCase();
            // state.team1.color = ui.team1ColorInput.value; // Color removed previously
            // state.team2.color = ui.team2ColorInput.value; // Color removed previously
            console.log("Basic match details set:", state.totalOvers, state.playersPerSide, state.venue);

            const processTeamData = (teamKey) => {
                console.log(`Processing team data for: ${teamKey}`);
                const playerStats = {};
                // Ensure playing is an array even if not properly set before
                if (!Array.isArray(state[teamKey].playing)) {
                    state[teamKey].playing = [];
                }
                let playingPlayerIds = state[teamKey].playing;
                console.log(`${teamKey} initial playingPlayerIds:`, playingPlayerIds);

                // --- Fallback/Correction Logic ---
                // If 'playing' is empty but 'squad' exists (might happen with loaded teams where selection failed/skipped)
                // or if players were entered manually but not saved correctly to 'playing'
                if (playingPlayerIds.length === 0 && state[teamKey].squad && state[teamKey].squad.length > 0) {
                     // If team was loaded, 'isLoaded' flag should be true.
                     // If entered manually, it might be false/undefined.
                     if(state[teamKey].isLoaded) {
                         console.warn(`Playing XI for loaded team ${teamKey} is empty. Attempting to use first ${state.playersPerSide} from squad.`);
                         // Use the first N players from the squad as the playing XI
                         playingPlayerIds = state[teamKey].squad.slice(0, state.playersPerSide).map(p => p.id);
                         state[teamKey].playing = playingPlayerIds; // Correct the state
                     } else {
                         // If manually entered, try saving from inputs again (should have happened in goToStep, but as fallback)
                         console.warn(`Playing XI for manually entered team ${teamKey} is empty. Attempting to save from inputs again.`);
                         savePlayerInputsToState(teamKey);
                         playingPlayerIds = state[teamKey].playing; // Re-fetch after saving
                     }
                     console.log(`Corrected ${teamKey} playingPlayerIds:`, playingPlayerIds);
                }
                // --- End Fallback ---


                if (!playingPlayerIds || playingPlayerIds.length === 0) {
                     console.error(`Error: Could not determine players for ${teamKey}.`);
                     showAlert(`Error processing team ${teamKey}: No players found. Please go back and ensure players are selected or entered correctly.`);
                     return false; // Indicate failure
                }

                // Build stats only for players in the 'playing' list, keyed by playerId
                playingPlayerIds.forEach(playerId => {
                    // Ensure squad is an array before trying to find
                    const squadArray = Array.isArray(state[teamKey].squad) ? state[teamKey].squad : [];
                    const player = squadArray.find(p => p.id === playerId);
                    if (player && player.name) {
                        const playerName = player.name.trim().toUpperCase();
                        playerStats[playerId] = {
                            playerId: player.id,
                            name: playerName,
                            image: player.image || '',
                            runs: 0, balls: 0, fours: 0, sixes: 0, isOut: false, dismissalInfo: null,
                            ballsBowled: 0, runsConceded: 0, wickets: 0, maidens: 0, dots: 0,
                            foursConceded: 0, sixesConceded: 0, consecutiveFours: 0, consecutiveSixes: 0
                        };
                    } else {
                        console.warn(`Could not find player data in squad for ID: ${playerId} in ${teamKey}`);
                        // Create a placeholder if not found in squad (shouldn't happen ideally)
                        playerStats[playerId] = {
                            playerId: playerId, name: `UNKNOWN PLAYER ${playerId.substring(0, 5)}`, image: '',
                             runs: 0, balls: 0, fours: 0, sixes: 0, isOut: false, dismissalInfo: null,
                             ballsBowled: 0, runsConceded: 0, wickets: 0, maidens: 0, dots: 0,
                             foursConceded: 0, sixesConceded: 0, consecutiveFours: 0, consecutiveSixes: 0
                        };
                    }
                });

                // The 'players' property should store the full player objects for easy access
                const squadArrayForMap = Array.isArray(state[teamKey].squad) ? state[teamKey].squad : [];
                state[teamKey].players = playingPlayerIds
                    .map(id => squadArrayForMap.find(p => p.id === id) || { id: id, name: playerStats[id]?.name || `UNKNOWN ${id.substring(0,5)}` } ) // Use stat name if not in squad
                    .filter(Boolean); // Ensure no null/undefined entries

                console.log(`${teamKey} players array (full objects):`, state[teamKey].players);
                state[teamKey].playerStats = playerStats;
                state[teamKey].inningsHistory = [];
                state[teamKey].extras = { b: 0, lb: 0, wd: 0, nb: 0, total: 0 };
                console.log(`Finished processing ${teamKey}. Players array length: ${state[teamKey].players.length}`);
                return true; // Indicate success
            };

            if (!processTeamData('team1')) return; // Stop if team 1 failed
            if (!processTeamData('team2')) return; // Stop if team 2 failed

            console.log("Player count validation:", `Team1: ${state.team1.players.length}`, `Team2: ${state.team2.players.length}`);
            // Adjust validation based on playersPerSide
            const minBatters = Math.min(2, state.playersPerSide);
            const minFielders = Math.min(1, state.playersPerSide);
            console.log(`Validation check: Min Batters required: ${minBatters}, Min Fielders required: ${minFielders}`);

            // Determine who bats first *before* validation
            const tossLoserKey = tossWinnerKey === 'team1' ? 'team2' : 'team1';
            const firstBattingTeamKey = tossDecision === 'bat' ? tossWinnerKey : tossLoserKey;
            const firstBowlingTeamKey = firstBattingTeamKey === 'team1' ? 'team2' : 'team1';
            console.log(`First batting team: ${firstBattingTeamKey}, First bowling team: ${firstBowlingTeamKey}`);


            if (state[firstBattingTeamKey].players.length < minBatters || state[firstBowlingTeamKey].players.length < minFielders) {
                 showAlert(`Please ensure at least ${minBatters} players are selected/entered for the batting team (${state[firstBattingTeamKey].name}) and ${minFielders} for the fielding team (${state[firstBowlingTeamKey].name}). Check previous steps.`);
                 console.error("Player count validation failed.");
                 return; // Stop execution
            } else {
                  console.log("Player count validation passed.");
            }

            // Set toss details *after* validation passes
            state.toss.winner = state[tossWinnerKey].name;
            state.toss.decision = tossDecision;
            console.log("Toss winner:", state.toss.winner, "Decision:", state.toss.decision);

            // Set batting/bowling teams
            if (tossDecision === 'bat') {
                state.battingTeam = tossWinnerKey;
                state.bowlingTeam = tossLoserKey;
            } else {
                state.battingTeam = tossLoserKey;
                state.bowlingTeam = tossWinnerKey;
            }
            console.log("Actual Batting team set to:", state.battingTeam, "Actual Bowling team set to:", state.bowlingTeam);

            // --- Screen Transition ---
            ui.setupScreen.classList.add('hidden');
            ui.appScreen.classList.add('flex'); // Ensure flex is added if missing
            ui.appScreen.classList.remove('hidden');
            console.log("Switched to app screen");

            window.addEventListener('beforeunload', beforeUnloadHandler);
            console.log("Calling initialize()");
            initialize(); // Setup initial players for the match
        }

        function proceedFromStep2() { // Renamed for clarity
            const playersSelected = ui.team1PlayerInputs.querySelectorAll('input[type="checkbox"]:checked').length;
            const playersRequired = parseInt(ui.playersPerSideInput.value) || 11;

            if (!state.team1.isLoaded) { // Only validate count if manually entered
                 // Allow selecting *at least* the required number, plus reserves
                if (playersSelected < playersRequired) {
                    showAlert(`Please select at least ${playersRequired} players for the team.`);
                    return;
                }
                savePlayerInputsToState('team1'); // Save manual entries
            }

            // Now call goToStep(3), telling it we are coming from Step 2.
            // goToStep(3) will handle the skip logic for team 2 internally.
            goToStep(3, 2);
        }

        function showIntroCommentary() {
            let introText = '';
            let title = '';

            if (state.innings === 1) {
                title = 'Match Start';
                const tossWinnerName = state.toss.winner;
                const tossDecisionText = state.toss.decision === 'bat' ? 'bat first' : 'field first';
                introText = `Welcome to <b>${state.venue}</b>. ${tossWinnerName} won the toss and will ${tossDecisionText}. The opening pair of <b>${formatPlayerName(state.striker.name)}</b> and <b>${formatPlayerName(state.nonStriker.name)}</b> are out in the middle, and <b>${formatPlayerName(state.bowler.name)}</b> will start the attack.`;
            } else {
                title = 'Second Innings';
                introText = `The second innings is about to begin. <b>${formatPlayerName(state.striker.name)}</b> and <b>${formatPlayerName(state.nonStriker.name)}</b> are the openers for ${state[state.battingTeam].name}. The bowler is <b>${formatPlayerName(state.bowler.name)}</b>.`;
            }
            
            ui.alertMessage.innerHTML = introText;
            ui.alertModal.querySelector('.modal-content').classList.add('text-left');
            alertCallback = () => {
                ui.alertModal.querySelector('.modal-content').classList.remove('text-left');
            }
            openModal('alert-modal');
        }

        function updateMatchHeader() {
            const team1Name = state.team1.name;
            const team2Name = state.team2.name;

            // Format venue and match format to Title Case using the new helper function
            const venue = toTitleCase(state.venue || 'Unknown Venue');
            const matchFormat = toTitleCase(`${state.totalOvers} Overs, ${state.playersPerSide}-a-side`);
            
            const dateStr = state.matchDate ? new Date(state.matchDate + 'T00:00:00').toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            }) : new Date().toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            const matchHeader = ui.matchHeader;
            matchHeader.innerHTML = '';
            const title = document.createElement('h1');
            title.className = 'font-bold text-base';
            title.textContent = `${team1Name} vs ${team2Name}`; // Team names remain uppercase

            const details = document.createElement('p');
            details.className = 'text-xs text-gray-600';
            details.textContent = `${venue} | ${dateStr} | ${matchFormat}`;
            
            matchHeader.appendChild(title);
            matchHeader.appendChild(details);
        }

        function initialize(isSecondInnings = false) {
            updateMatchHeader(); // Use the new reusable function
            state.isScoringLocked = true;
            updateUI();
            
            const setupPlayers = () => {
                ui.playerModalCancelBtnX.classList.add('hidden');
                ui.playerModalCancelBtnText.classList.add('hidden');
                selectPlayer('striker', () => {
                    selectPlayer('nonStriker', () => {
                        selectPlayer('bowler', () => {
                            ui.playerModalCancelBtnX.classList.remove('hidden');
                            ui.playerModalCancelBtnText.classList.remove('hidden');
                            state.isScoringLocked = false;
                            updateUI();
                            showIntroCommentary();
                        });
                    });
                });
            };

            if (isSecondInnings) {
                showAlert('The 2nd innings is about to begin. Please select the opening batsmen and bowler.', setupPlayers);
            } else {
                setupPlayers();
            }
        }
        
        function savePlayerStats(playerObject, teamKey) {
    if (!playerObject || !playerObject.playerId || !teamKey) return;
    state[teamKey].playerStats[playerObject.playerId] = { ...state[teamKey].playerStats[playerObject.playerId],
        ...playerObject
    };
}

    function selectPlayer(role, onCompleteCallback) {
    ui.modalTitle.textContent = `Select ${role.charAt(0).toUpperCase() + role.slice(1)}`;

    ui.modalTitle.classList.remove('text-red-800');
    if (role === 'striker' || role === 'nonStriker') {
        ui.modalTitle.classList.add('text-red-800');
    }

    const teamKey = role === 'bowler' ? state.bowlingTeam : state.battingTeam;

    // Assemble list of players who should be disabled in the dropdown
    const disabledIds = [];

    if (role === 'striker') {
        // When picking a striker, disable the *current non-striker*.
        if (state.nonStriker) disabledIds.push(state.nonStriker.playerId);
    } else if (role === 'nonStriker') {
        // When picking a non-striker, disable the *current striker*.
        if (state.striker) disabledIds.push(state.striker.playerId);
    } else if (role === 'bowler') {
        // When picking a bowler, disable the *last bowler* (if they just finished an over).
        if (state.lastBowler) disabledIds.push(state.lastBowler);
    }

    // --- UPDATED: Pass addBlankOption: true ---
    populatePlayerOptions(ui.playerSelect, teamKey, {
        disabledIds: disabledIds,
        isOutFilter: (role !== 'bowler'),
        addBlankOption: true,
        blankOptionText: 'Select Player'
    });
    
    // --- UPDATED: Force the dropdown to be empty initially ---
    ui.playerSelect.value = ""; 

    // DEFINITIVE FIX: Re-bind the onclick handler every time the modal is opened.
    ui.playerSaveBtn.onclick = () => {
        const selectedPlayerId = ui.playerSelect.value;

        // --- UPDATED: Check if user actually selected something ---
        if (!selectedPlayerId) {
            showAlert("Please select a player from the list.");
            return;
        }

        // Validation for duplicate batters
        if (role === 'striker' && state.nonStriker && selectedPlayerId === state.nonStriker.playerId) {
            showAlert("The same player cannot be both striker and non-striker. Please select a different player.");
            return;
        }
        if (role === 'nonStriker' && state.striker && selectedPlayerId === state.striker.playerId) {
            showAlert("The same player cannot be both striker and non-striker. Please select a different player.");
            return;
        }

        const oldPlayerId = state[role] ? state[role].playerId : null;
        if (!selectedPlayerId || !state[teamKey].playerStats[selectedPlayerId]) return;

        const updatePlayerState = () => {
            state[role] = { ...state[teamKey].playerStats[selectedPlayerId] };
            closeModal('player-modal');
            updateUI();
            if (typeof onCompleteCallback === 'function') {
                setTimeout(onCompleteCallback, 350);
            }
        };

        const battingTeam = state[state.battingTeam];
        if (role === 'striker' && oldPlayerId && selectedPlayerId !== oldPlayerId && battingTeam.inningsHistory.length > 0) {
            // Automatically apply the correction for the entire current stint without asking the user.
            shiftBatterContribution({ fromBatterId: oldPlayerId, toBatterId: selectedPlayerId, scope: 'currentStint' });
            updatePlayerState();
        } else {
            updatePlayerState();
        }
    };

    openModal('player-modal');
}

        function triggerEventAnimation(text, colorClass) {
            const overlay = ui.eventAnimationOverlay;
            const textElement = ui.eventAnimationText;

            textElement.textContent = text;
            textElement.className = `text-8xl font-black uppercase ${colorClass}`;
            
            overlay.classList.remove('hidden');
            textElement.classList.add('event-text-animation');

            return new Promise(resolve => setTimeout(() => {
                overlay.classList.add('hidden');
                textElement.classList.remove('event-text-animation');
                resolve();
            }, 1500));
        }
        
        function updateLiveCommentary(commentary, append = false) {
			if (ui.liveCommentary && commentary) {
				ui.liveCommentaryBox.classList.remove('hidden'); // This now shows our new commentary box
				if (append) {
					ui.liveCommentary.innerHTML += `<br><span class="text-gray-500 italic">${commentary}</span>`;
				} else {
					ui.liveCommentary.innerHTML = commentary;
				}
			}
		}
        
        const commentaryPool = {
            dot: ["Excellent delivery from {bowler}! A perfect dot ball.", "{bowler} to {striker}, played straight to the fielder. No run there.", "A swing and a miss! {striker} couldn't connect on that one.", "Good, tight bowling from {bowler}. {striker} is forced to defend.", "Punched to the cover fielder, no space for a single.", "Solidly defended by {striker}. No run on offer.", "Left alone outside the off stump, wise batting from {striker}.", "A sharp bouncer from {bowler}, and {striker} has to duck under it.", "Driven firmly, but straight to the man at mid-off."],
            single: ["Pushed into the gap for a quick single. That brings {nonStriker} on strike.", "Just one run, keeping the scoreboard ticking over nicely.", "{striker} gets off the mark with a simple single.", "Tucked away to the leg side for one. Easy does it.", "Dabbed down to third man for a comfortable single.", "Good running, they pinch a single and rotate the strike.", "Works it away through square leg and they'll get one for it."],
            double: [`Good placement by {striker}, they'll come back for two runs easily.`, `Well-judged running between the wickets nets them a couple.`, `Flicked off the pads, and they'll pick up two more.`, `Driven through the covers, and that's a brace for {striker}.`, "Excellent running, they convert the single into two."],
            triple: [`They're pushing hard! Great effort in the deep, but they'll make it back for three.`, `Finds the vast outfield space, and it's three more valuable runs for {striker}.`, `A bit of a fumble in the deep allows them to come back for the third. Excellent awareness.`],
            four: [`<b>FOUR!</b> A cracking shot from {striker}! It races away to the boundary.`, `<b>FOUR!</b> Beautifully timed! Pierces the field for a boundary.`, `<b>FOUR!</b> Smashed away with power! {striker} is looking in great touch.`, `<b>FOUR!</b> A delicate late cut finds the rope. Sublime.`, `<b>FOUR!</b> Pulled away with disdain by {striker}!`, `<b>FOUR!</b> Finds the gap to perfection! Wonderful placement.`, `<b>FOUR!</b> Classic cover drive, textbook stuff from {striker}.`, `<b>FOUR!</b> Edged... and it flies past the slips for a lucky boundary!`],
            four_2: ["That's two in a row! {striker} is finding the boundary with ease now.", "Another four! {bowler} is under pressure as {striker} hits another boundary."],
            four_3: ["Hat-trick of boundaries! This is superb batting from {striker}!", "Make that three in a row! {striker} is putting on a show!"],
            four_4plus: ["Four fours in a row! This is an onslaught from {striker}!", "It's a boundary-fest! {striker} makes it four in a row!"],
            six: [`<b>SIX!</b> That's out of here! A monstrous hit from {striker}!`, `<b>SIX!</b> The ball is sailing over the fence! What a powerful shot by {striker}!`, `<b>SIX!</b> That's a massive one! The batsman, {striker}, is on fire!`, `<b>SIX!</b> Clears the front leg and launches it over long-on!`, `<b>SIX!</b> High and handsome! That's gone all the way!`, `<b>SIX!</b> It's in the stands! Incredible power from {striker}!`, `<b>SIX!</b> A flick of the wrists and it travels the distance! Effortless!`, `<b>SIX!</b> Right out of the middle of the bat!`],
            six_2: ["WOW! Back-to-back sixes! {striker} is on fire and the crowd is loving it!", "Continuous sixes for the batsman! {bowler} doesn't know where to bowl!"],
            six_3: ["UNBELIEVABLE! THREE SIXES IN A ROW! {striker} is simply unstoppable!", "This is carnage! A hat-trick of sixes for {striker}!"],
            six_4plus: ["MAKE THAT FOUR SIXES IN A ROW! This is unbelievable hitting from {striker}!", "{bowler} has no answer! It's another maximum, the fourth in a row!"],
            milestone_50: ["<b>Fifty for {striker}!</b> A brilliant knock, and he raises his bat to the applause of the crowd!", "That's a half-century for {striker}! He gets there with a quick single."],
            milestone_100: ["<b>CENTURY! What an innings from {striker}!</b> He takes off his helmet and soaks in the ovation!", "A hundred for {striker}! An absolutely masterful innings comes to a magnificent conclusion."]
        };
        let usedCommentaryIndexes = {};

        function pickUnique(poolName) {
            if (!commentaryPool[poolName]) return "";
            if (!usedCommentaryIndexes[poolName]) {
                usedCommentaryIndexes[poolName] = [];
            }
            let pool = commentaryPool[poolName];
            if (usedCommentaryIndexes[poolName].length === pool.length) {
                usedCommentaryIndexes[poolName] = [];
            }
            let randomIndex;
            do {
                randomIndex = Math.floor(Math.random() * pool.length);
            } while (usedCommentaryIndexes[poolName].includes(randomIndex));
            
            usedCommentaryIndexes[poolName].push(randomIndex);
            return pool[randomIndex];
        }

        function generateRealCommentary(type, data) {
            let commentary = '';
            let poolName = '';
            const { bowler, striker, nonStriker, runs, wicketType, fielder, playerOut, extraType, overRuns, maiden } = data;
            let append = false;

            switch (type) {
                case 'runs':
                        switch (runs) {
                            case 0: poolName = 'dot'; break;
                            case 1: poolName = 'single'; break;
                            case 2: poolName = 'double'; break;
                            case 3: poolName = 'triple'; break;
                            case 4: 
                                if (striker.consecutiveFours >= 4) poolName = 'four_4plus';
                                else if (striker.consecutiveFours === 3) poolName = 'four_3';
                                else if (striker.consecutiveFours === 2) poolName = 'four_2';
                                else poolName = 'four';
                                break;
                            case 6: 
                                if (striker.consecutiveSixes >= 4) poolName = 'six_4plus';
                                else if (striker.consecutiveSixes === 3) poolName = 'six_3';
                                else if (striker.consecutiveSixes === 2) poolName = 'six_2';
                                else poolName = 'six';
                                break;
                        }
                        commentary = pickUnique(poolName);
                        break;
                case 'wicket':
                        switch (wicketType) {
                            case 'Catch': commentary = `<b>OUT! Caught!</b> In the air... and taken! A superb catch by ${formatPlayerName(fielder)} sends ${formatPlayerName(data.striker.name)} packing.`; break;
                            case 'Bowled': commentary = `<b>OUT! Bowled 'em!</b> Right through the defenses! A perfect delivery from ${formatPlayerName(bowler)} dismantles the stumps.`; break;
                            case 'Stump Out': commentary = `<b>OUT! Stumped!</b> Lightning-fast work by the keeper! ${formatPlayerName(data.striker.name)} is caught out of the crease.`; break;
                            case 'Run Out': commentary = `<b>OUT! Run out!</b> A moment of madness! A direct hit from the fielder catches ${formatPlayerName(playerOut)} well short.`; break;
                        }
                        break;
                case 'extra':
                        const totalExtraRuns = (extraType === 'wd' || extraType === 'nb' ? 1 : 0) + runs;
                        if(extraType === 'wd') commentary = `<b>Wide!</b> That's drifted down the leg side. The umpire signals a wide and it's ${totalExtraRuns} run${totalExtraRuns > 1 ? 's' : ''} added to the total.`;
                        if(extraType === 'nb') commentary = `<b>No Ball!</b> ${formatPlayerName(bowler)} has overstepped. That's a free hit coming up, and they add ${totalExtraRuns} run${totalExtraRuns > 1 ? 's' : ''}.`;
                        if(extraType === 'b') commentary = `<b>Byes!</b> It beats the bat and the keeper! They'll pick up ${totalExtraRuns} bye${totalExtraRuns > 1 ? 's' : ''}.`;
                        if(extraType === 'lb') commentary = `<b>Leg Byes!</b> Off the pads and they scamper through for ${totalExtraRuns} leg bye${totalExtraRuns > 1 ? 's' : ''}.`;
                        break;
                case 'milestone_50': commentary = pickUnique('milestone_50'); break;
                case 'milestone_100': commentary = pickUnique('milestone_100'); break;
                case 'endOfOver':
                        append = true;
                        if (maiden) {
                            commentary = `A maiden over! Superb, disciplined bowling from ${formatPlayerName(bowler)}.`;
                        } else {
                            commentary = `End of the over. ${overRuns} run${overRuns !== 1 ? 's' : ''} from it.`;
                            if (overRuns >= 12) commentary += ` A very expensive one for ${formatPlayerName(bowler)}.`;
                            else if (overRuns >= 6) commentary += ` A decent over for the batting side.`;
                            else if (overRuns > 0) commentary += ` A tidy over from ${formatPlayerName(bowler)}.`;
                        }
                        break;
            }
            if(commentary) {
                updateLiveCommentary(commentary.replace(/{striker}/g, striker ? formatPlayerName(striker.name) : "").replace(/{nonStriker}/g, nonStriker ? formatPlayerName(nonStriker.name) : "").replace(/{bowler}/g, bowler ? formatPlayerName(bowler.name) : ""), append);
            }
        }

        function addRuns(runs, isExtra = false, extraType = '') {
            if (state.isScoringLocked) return;
            saveState();
            
            const battingTeam = state[state.battingTeam];
            battingTeam.score += runs;

            if (!isExtra) {
                const oldScore = state.striker.runs;
                

                if(runs === 6) {
                    state.striker.consecutiveSixes++;
                    state.striker.consecutiveFours = 0;
                } else if(runs === 4) {
                    state.striker.consecutiveFours++;
                    state.striker.consecutiveSixes = 0;
                } else {
                    state.striker.consecutiveFours = 0;
                    state.striker.consecutiveSixes = 0;
                }

                state.striker.runs += runs;
                state.striker.balls++;
                if (runs === 4) state.striker.fours++;
                if (runs === 6) state.striker.sixes++;

                // --- NEW PITCH MAP LOGIC ---
                const isBoundary = (runs === 4 || runs === 6);
                if (isBoundary && state.isPitchMapEnabled) {
                    // Open modal to mark the shot. Commentary will be handled by markShot() or cancelShotMarking().
                    openPitchMapModal(runs, oldScore);
                } else {
                    // Standard generic commentary flow (for 0-3 runs, or if map is disabled)
                    if (runs === 4) triggerEventAnimation('FOUR!', 'text-yellow-400');
                    if (runs === 6) triggerEventAnimation('SIX!', 'text-green-500');
                    
                    let milestoneReached = false;
                    if (oldScore < 100 && state.striker.runs >= 100) {
                        generateRealCommentary('milestone_100', { striker: state.striker });
                        milestoneReached = true;
                    } else if (oldScore < 50 && state.striker.runs >= 50) {
                        generateRealCommentary('milestone_50', { striker: state.striker });
                        milestoneReached = true;
                    }

                    setTimeout(() => {
                        generateRealCommentary('runs', {
                            runs: runs,
                            bowler: state.bowler,
                            striker: state.striker,
                            nonStriker: state.nonStriker
                        });
                    }, milestoneReached ? 1500 : (isBoundary ? 1500 : 0)); // Add animation delay for boundaries
                }
                // --- END NEW LOGIC ---

                processBall(runs, `${runs}`);

                if (runs % 2 !== 0) {
                    swapBatsmen();
                }
            }
            
            updateUI();
            checkWinCondition();
        }

        function addExtra(type, runs) {
    if (state.isScoringLocked) return;
    saveState();

    if (type === 'nb') {
        state.pendingExtra = { type: 'nb', runs: runs };
        closeAllModals();
        openModal('freehit-confirm-modal');
        return; 
    }

    const baseExtraRun = (type === 'wd' || type === 'nb' ? 1 : 0);
    const totalRuns = baseExtraRun + runs;

    const battingTeam = state[state.battingTeam];
    battingTeam.score += totalRuns;
    battingTeam.extras[type] += totalRuns;
    battingTeam.extras.total += totalRuns;

    if (state.bowler) {
       state.bowler.runsConceded += totalRuns;
    }

    state.striker.consecutiveFours = 0;
    state.striker.consecutiveSixes = 0;

    // FIX: Correctly format the event string for B/LB
    let ballEvent = type.toUpperCase();
    if (runs > 0) {
         // For B/LB, format is B1, B2 etc. For WD/NB, it's WD+1
        ballEvent += (type === 'b' || type === 'lb') ? runs : `+${runs}`;
    }

    const ballData = { event: ballEvent, runs: totalRuns, batterId: state.striker.playerId, bowlerId: state.bowler.playerId, extraType: type };
    battingTeam.inningsHistory.push(ballData);

    generateRealCommentary('extra', { extraType: type, runs: runs, bowler: state.bowler.name });

    if (type === 'b' || type === 'lb') {
         processBall(totalRuns, ballEvent, type); // Legal delivery
    } else {
         state.currentOver.push({ event: ballEvent, runs: totalRuns }); // Illegal delivery
    }

    // Correctly swap strike if the physically run portion is odd
    if (runs > 0 && runs % 2 !== 0) {
        swapBatsmen();
    }

    closeAllModals();
    updateUI();
    checkWinCondition();
}

        function openWicketModal() {
    if (state.isScoringLocked) return;

    const wicketModal = document.getElementById('wicket-type-modal');
    const buttons = wicketModal.querySelectorAll('button');

    if (state.isFreeHit) {
        // On a free hit, only Run Out is a valid dismissal
        buttons.forEach(button => {
            const wicketType = button.getAttribute('onclick').match(/'([^']+)'/)[1];
            if (wicketType !== 'Run Out') {
                button.disabled = true;
                button.classList.add('opacity-50', 'cursor-not-allowed', 'bg-gray-50');
                button.classList.remove('bg-gray-100');
            } else {
                button.disabled = false;
                button.classList.remove('opacity-50', 'cursor-not-allowed', 'bg-gray-50');
                button.classList.add('bg-gray-100');
            }
        });
    } else {
        // On a normal delivery, ensure all buttons are enabled
        buttons.forEach(button => {
            button.disabled = false;
            button.classList.remove('opacity-50', 'cursor-not-allowed', 'bg-gray-50');
            button.classList.add('bg-gray-100');
        });
    }

    openModal('wicket-type-modal');
}

        function initiateExtraRunOut(extraType) {
            // Determine the correct modal to close based on the extra type
            let modalToClose;
            switch (extraType) {
                case 'wd':
                    modalToClose = 'wide-modal';
                    break;
                case 'nb':
                    modalToClose = 'noball-modal';
                    break;
                case 'b':
                    modalToClose = 'byes-modal';
                    break;
                case 'lb':
                    modalToClose = 'legbyes-modal';
                    break;
            }

            // Close only the specific modal that was open
            if (modalToClose) {
                closeModal(modalToClose);
            }

           // Proceed with the run out logic as before
            state.pendingExtra = { type: extraType, runs: 0 };
            openModal('runs-attempted-modal');
        }

        function handleAttemptedRuns(runs) {
    if (state.pendingExtra) {
        state.pendingExtra.runs = runs;
        closeModal('runs-attempted-modal');

        ui.runOutOptions.innerHTML = `
            <button onclick="finalizeExtraRunOut('${state.striker.playerId}')" class="p-3 bg-gray-100 rounded-lg">${formatPlayerName(state.striker.name)}</button>
            <button onclick="finalizeExtraRunOut('${state.nonStriker.playerId}')" class="p-3 bg-gray-100 rounded-lg">${formatPlayerName(state.nonStriker.name)}</button>
        `;
        openModal('run-out-modal');
    }
}

        async function finalizeExtraRunOut(playerOutId) {
    if (!state.pendingExtra) return;
    saveState();

    const { type, runs } = state.pendingExtra;
    const isLegalDelivery = (type === 'b' || type === 'lb');
    const baseExtraRuns = isLegalDelivery ? 0 : 1;
    const totalRuns = baseExtraRuns + runs;

    const battingTeamKey = state.battingTeam;
    const battingTeam = state[battingTeamKey];
    battingTeam.score += totalRuns;
    battingTeam.wickets++;
    if (state.bowler) state.bowler.runsConceded += totalRuns;

    const playerOutObject = (state.striker && state.striker.playerId === playerOutId) ? state.striker : state.nonStriker;
    playerOutObject.isOut = true;
    const dismissalInfo = { 
        type: 'Run Out', 
        via: type.toUpperCase(), 
        bowler: null, 
        fielder: null,
        scoreAtFall: battingTeam.score,
        overAtFall: `${battingTeam.overs}.${battingTeam.balls}`
    };
    playerOutObject.dismissalInfo = dismissalInfo;

    const ballEvent = `${type.toUpperCase()}+${runs}+W`;

    if (isLegalDelivery) {
        playerOutObject.balls++;
        processBall(totalRuns, ballEvent, type, dismissalInfo);
    } else {
        state.currentOver.push({ event: ballEvent, runs: totalRuns });
        // Manually add to innings history as processBall is not called for illegal deliveries
        const ballData = { event: ballEvent, runs: totalRuns, batterId: playerOutObject.playerId, bowlerId: state.bowler.playerId, extraType: type, dismissalInfo };
        battingTeam.inningsHistory.push(ballData);
    }

    savePlayerStats(playerOutObject, battingTeamKey);
    state.pendingExtra = null;
    closeAllModals();

    generateRealCommentary('wicket', { wicketType: 'Run Out', playerOut: playerOutObject.name });

    if (state.striker && state.striker.playerId === playerOutId) state.striker = null;
    if (state.nonStriker && state.nonStriker.playerId === playerOutId) state.nonStriker = null;

    updateUI();
    await triggerEventAnimation('OUT', 'text-red-700');
    await showPlayerOutSummary(playerOutObject);

    if (checkInningsEnd()) return;

    const roleToFill = !state.striker ? 'striker' : 'nonStriker';
    selectPlayer(roleToFill);
}

        function handleWicket(type) {
    closeModal('wicket-type-modal');

    if (type === 'Run Out') {
        // NEW: Unified Run Out flow for both normal and Free Hit deliveries
        initiateRunOutFlow();
    } else if (type === 'Catch') {
        selectFielderForCatch(); // Existing flow for catch
    } else {
        // Other wicket types (Bowled, LBW, etc.) - always striker
        processWicket(type, state.striker.playerId);
    }
}
        
   async function processWicket(type, playerOutId, fielderName = null, fielderId = null) {
    if (state.isFreeHit && type !== 'Run Out') {
        showAlert("Batsman cannot be out on a Free Hit (except for Run Out).");
        closeAllModals();
        state.isFreeHit = false;
        updateUI();
        return;
    }

    let playerOutObject;
    closeAllModals();
    saveState();

    const battingTeamKey = state.battingTeam;
    const battingTeam = state[battingTeamKey];

    if (state.striker && state.striker.playerId === playerOutId) {
        playerOutObject = state.striker;
    } else if (state.nonStriker && state.nonStriker.playerId === playerOutId) {
        playerOutObject = state.nonStriker;
    } else {
        console.error("Could not find player to dismiss with ID:", playerOutId);
        return;
    }

    playerOutObject.consecutiveFours = 0;
    playerOutObject.consecutiveSixes = 0;
    battingTeam.wickets++;

    const bowlerCreditedWickets = ['Catch', 'Bowled', 'Stump Out', 'LBW', 'Hit Wicket'];
    if (bowlerCreditedWickets.includes(type) && state.bowler) {
        state.bowler.wickets++;
    }

    playerOutObject.balls++;
    playerOutObject.isOut = true;

    const dismissalInfo = { 
        type: type, 
        bowlerId: state.bowler ? state.bowler.playerId : null, 
        bowlerName: state.bowler ? state.bowler.name : null,
        fielderId: fielderId,
        fielderName: fielderName,
        scoreAtFall: battingTeam.score,
        overAtFall: `${battingTeam.overs}.${battingTeam.balls}`
    };
    playerOutObject.dismissalInfo = dismissalInfo;

    savePlayerStats(playerOutObject, battingTeamKey); 
    generateRealCommentary('wicket', { wicketType: type, bowler: state.bowler, striker: playerOutObject, fielder: fielderName, playerOut: playerOutObject.name });

    processBall(0, 'W', null, dismissalInfo);

    if (state.striker && state.striker.playerId === playerOutId) state.striker = null;
    if (state.nonStriker && state.nonStriker.playerId === playerOutId) state.nonStriker = null;

    updateUI();
    await triggerEventAnimation('OUT', 'text-red-700');
    await showPlayerOutSummary(playerOutObject);

    if (checkInningsEnd()) return;

    // DIRECTLY OPEN NEXT PLAYER MODAL (No Alert)
    state.isScoringLocked = true;
    const roleToFill = !state.striker ? 'striker' : 'nonStriker';

    // Hide cancel buttons to force selection
    ui.playerModalCancelBtnX.classList.add('hidden');
    ui.playerModalCancelBtnText.classList.add('hidden');
    
    selectPlayer(roleToFill, () => {
        ui.playerModalCancelBtnX.classList.remove('hidden');
        ui.playerModalCancelBtnText.classList.remove('hidden');
        state.isScoringLocked = false;
        updateUI();
    });
}
function initiateRunOutFlow() {
            const modalTitle = document.getElementById('run-out-modal-title');
            const runsSection = document.getElementById('run-out-runs-section');
            const runsPrompt = document.getElementById('run-out-runs-prompt');
            const runsChipsContainer = document.getElementById('run-out-runs-chips');
            const runsInput = document.getElementById('run-out-runs-input');
            const selectedRunsInput = document.getElementById('run-out-selected-runs');
            const runOutOptionsContainer = document.getElementById('run-out-options');

            // Set modal title based on whether it's a Free Hit
            modalTitle.textContent = state.isFreeHit ? "Run Out on Free Hit" : "Who was Run Out?";
            runsPrompt.textContent = "Runs completed before run-out:";
            runsSection.classList.remove('hidden'); // Ensure runs section is visible
            runsInput.classList.add('hidden'); // Hide numeric input initially
            selectedRunsInput.value = '0'; // Default to 0 runs

            // --- Setup Run Chip Listeners ---
            runsChipsContainer.querySelectorAll('.run-chip').forEach(chip => {
                chip.onclick = () => {
                    runsChipsContainer.querySelectorAll('.run-chip').forEach(c => c.classList.remove('bg-blue-600', 'text-white', '!bg-gray-200')); // Reset styles more robustly
                    chip.classList.add('bg-blue-600', 'text-white'); // Style selected chip
                    chip.classList.remove('bg-gray-200');

                    const runsValue = chip.dataset.runs;
                    if (runsValue === '4+') {
                        runsInput.classList.remove('hidden');
                        runsInput.focus();
                        selectedRunsInput.value = runsInput.value || '4'; // Use input value or default to 4
                    } else {
                        runsInput.classList.add('hidden');
                        selectedRunsInput.value = runsValue; // Use chip value
                    }
                };
            });
            runsInput.oninput = () => {
                selectedRunsInput.value = runsInput.value || '4'; // Store numeric value, default to 4 if empty
            };
            // Default select '0' runs visually
             runsChipsContainer.querySelector('[data-runs="0"]').click();


            // --- Setup Player Radio Buttons ---
            // These now call the generic finalizeRunOutDismissal
            runOutOptionsContainer.innerHTML = `
                <label class="flex items-center p-3 bg-gray-100 rounded-lg cursor-pointer hover:bg-gray-200">
                    <input type="radio" name="runOutPlayer" value="${state.striker.playerId}" class="mr-3 h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500" onclick="finalizeRunOutDismissal('${state.striker.playerId}')">
                    <span class="font-medium">${formatPlayerName(state.striker.name)} (Striker)</span>
                </label>
                <label class="flex items-center p-3 bg-gray-100 rounded-lg cursor-pointer hover:bg-gray-200">
                    <input type="radio" name="runOutPlayer" value="${state.nonStriker.playerId}" class="mr-3 h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500" onclick="finalizeRunOutDismissal('${state.nonStriker.playerId}')">
                    <span class="font-medium">${formatPlayerName(state.nonStriker.name)} (Non-Striker)</span>
                </label>
            `;

            openModal('run-out-modal');
        }
        async function finalizeRunOutDismissal(playerOutId) {
    closeModal('run-out-modal');
    saveState(); 

    const runsTakenInput = document.getElementById('run-out-selected-runs');
    const runsTaken = parseInt(runsTakenInput.value) || 0; 

    const battingTeamKey = state.battingTeam;
    const battingTeam = state[battingTeamKey];
    const playerOutObject = state[battingTeamKey].playerStats[playerOutId];

    if (!playerOutObject) return;

    battingTeam.score += runsTaken;
    battingTeam.wickets++;

    playerOutObject.isOut = true;
    const dismissalInfo = {
        type: 'Run Out',
        bowlerId: null, 
        bowlerName: null,
        fielderId: null, 
        fielderName: null,
        scoreAtFall: battingTeam.score, 
        overAtFall: `${battingTeam.overs}.${battingTeam.balls + 1}` 
    };
    playerOutObject.dismissalInfo = dismissalInfo;

    if (!playerOutObject.balls) playerOutObject.balls = 0;
    playerOutObject.balls++; 

    savePlayerStats(playerOutObject, battingTeamKey);

    const eventString = `${runsTaken}+W`;
    processBall(runsTaken, eventString, null, dismissalInfo);

    if (state.isFreeHit) state.isFreeHit = false;

    if (state.striker && state.striker.playerId === playerOutId) state.striker = null;
    if (state.nonStriker && state.nonStriker.playerId === playerOutId) state.nonStriker = null;

    updateUI();
    await triggerEventAnimation('OUT', 'text-red-700');
    await showPlayerOutSummary(playerOutObject);

    if (runsTaken > 0 && runsTaken % 2 !== 0) {
         const shouldBeStrikerId = (state.striker?.playerId === playerOutId) ? state.nonStriker?.playerId : state.striker?.playerId;
         if (state.striker?.playerId !== shouldBeStrikerId && state.nonStriker?.playerId === shouldBeStrikerId) {
              [state.striker, state.nonStriker] = [state.nonStriker, state.striker];
         }
    }

    if (checkInningsEnd()) return;

    // DIRECTLY OPEN NEXT PLAYER MODAL (No Alert)
    state.isScoringLocked = true;
    const roleToFill = !state.striker ? 'striker' : 'nonStriker';
    
    // Hide cancel buttons to force selection
    ui.playerModalCancelBtnX.classList.add('hidden');
    ui.playerModalCancelBtnText.classList.add('hidden');

    selectPlayer(roleToFill, () => {
        ui.playerModalCancelBtnX.classList.remove('hidden');
        ui.playerModalCancelBtnText.classList.remove('hidden');
        state.isScoringLocked = false;
        updateUI();
    });
}
        // Check within your parseBallEvent function if it handles '1+RO' correctly.
        // If not, you might need a small modification there.
        // Example addition to parseBallEvent:
        function parseBallEvent(event) {
            if (!event) return 0;
            const e = event.trim().toUpperCase();
            if (e === '.' || e === 'W') return 0;

            // NEW: Handle "X+RO" format specifically
            if (e.includes('+RO')) {
                const runsPart = e.split('+RO')[0];
                const runs = parseInt(runsPart);
                return isNaN(runs) ? 0 : runs;
            }

            // Existing logic...
            const simpleRuns = parseInt(e);
            // ... rest of parseBallEvent
        }

        // No direct changes needed inside processBall itself if parseBallEvent is correct.
        // Example addition to parseBallEvent:
        function parseBallEvent(event) {
            if (!event) return 0;
            const e = event.trim().toUpperCase();
            if (e === '.' || e === 'W') return 0;

            // NEW: Handle "X+RO" format specifically
            if (e.includes('+RO')) {
                const runsPart = e.split('+RO')[0];
                return toInt(runsPart); // Use strict toInt
            }

            // Existing logic...
            // Simple number runs (0, 1, 2, 3, 4, 6)
            const simpleRuns = toInt(e); // Use strict toInt
            if (simpleRuns >= 0 && simpleRuns <= 6 && e.length === 1) { // Added length check
                return simpleRuns;
            }

            // Extras
            if (e.startsWith('WD')) {
                const runs = toInt(e.substring(2)); // Use strict toInt
                return 1 + runs;
            }
            if (e.startsWith('NB')) {
                const runs = toInt(e.substring(2)); // Use strict toInt
                return 1 + runs;
            }
            if (e.startsWith('B')) {
                return toInt(e.substring(1)); // Use strict toInt
            }
            if (e.startsWith('LB')) {
                return toInt(e.substring(2)); // Use strict toInt
            }
            
            return 0; // Return 0 for any unrecognised format
        }

        // No direct changes needed inside processBall itself if parseBallEvent is correct.
        function processBall(runs, event, extraType = null, dismissalInfo = null) {
            // ... existing function body ...
        }
    function processBall(runs, event, extraType = null, dismissalInfo = null) {
    const battingTeam = state[state.battingTeam];
    const bowlingTeam = state[state.bowlingTeam];

    // Store complete ball data for the innings history, ensuring dismissalInfo is included
    const ballData = { event, runs, batterId: state.striker.playerId, bowlerId: state.bowler.playerId, extraType, dismissalInfo };
    battingTeam.inningsHistory.push(ballData);

    // This is a legal delivery
    battingTeam.balls++;
    //...
    if(state.bowler) {
        state.bowler.ballsBowled++;
        state.bowler.runsConceded += runs;
        if (runs === 0 && event !== 'W') state.bowler.dots++;
        if (runs === 4) state.bowler.foursConceded++;
        if (runs === 6) state.bowler.sixesConceded++;
    }
    state.currentOver.push({ event, runs });

    if (state.isFreeHit) {
        state.isFreeHit = false;
    }

    const isOverComplete = battingTeam.balls === 6;

    if (isOverComplete) {
        state.isScoringLocked = true;
        const overRuns = state.currentOver.reduce((acc, ball) => acc + ball.runs, 0);
        const isMaiden = overRuns === 0 && state.currentOver.every(b => !b.event.includes('wd') && !b.event.includes('nb'));

        setTimeout(() => {
            battingTeam.overs++;
            battingTeam.balls = 0;

            if (isMaiden) {
                state.bowler.maidens++;
            }
            generateRealCommentary('endOfOver', { overRuns: overRuns, maiden: isMaiden, bowler: state.bowler.name });

savePlayerStats(state.bowler, state.bowlingTeam);
state.lastBowler = state.bowler.playerId;

if (checkInningsEnd()) return;

            ui.bowlerPromptOverlay.classList.remove('hidden');
        }, 2000); 
    }
}

        function checkInningsEnd() {
            const battingTeam = state[state.battingTeam];

            const playersOutCount = Object.values(battingTeam.playerStats).filter(p => p.isOut).length;
            const isAllOut = playersOutCount >= state.playersPerSide - 1;

            if (isAllOut || battingTeam.overs === state.totalOvers) {
                savePlayerStats(state.striker, state.battingTeam);
                savePlayerStats(state.nonStriker, state.battingTeam);
                savePlayerStats(state.bowler, state.bowlingTeam);

                if (state.innings === 1) {
                    openInningsBreakModal();
                } else {
                    checkWinCondition();
                }
                return true; 
            }
            return false;
        }

        function checkWinCondition() {
    if (state.innings !== 2 || (state.result && state.result.status)) {
        return;
    }

    const battingTeam = state[state.battingTeam];
    const bowlingTeam = state[state.bowlingTeam];
    let matchOver = false;
    
    // Chasing team wins
    if (battingTeam.score >= state.target) {
        matchOver = true;
        const wicketsRemaining = (state.playersPerSide - 1) - battingTeam.wickets;
        state.result = {
            status: 'completed_normal',
            winnerSide: state.battingTeam,
            margin: wicketsRemaining,
            marginType: 'wickets'
        };
        state.winner = battingTeam.name;
    } 
    // Innings ends before target is reached
    else if (battingTeam.overs === state.totalOvers || battingTeam.wickets >= state.playersPerSide - 1) {
        matchOver = true;
        // Defending team wins
        if (battingTeam.score < state.target - 1) {
            const runsMargin = (state.target - 1) - battingTeam.score;
            state.result = {
                status: 'completed_normal',
                winnerSide: state.bowlingTeam,
                margin: runsMargin,
                marginType: 'runs'
            };
            state.winner = bowlingTeam.name;
        }
        // Match is tied
        else if (battingTeam.score === state.target - 1) {
            state.result = { status: 'tie' };
            state.winner = 'Match Tied';
        }
    }
    
    if (matchOver) {
        let marginText = '';
        if(state.result.margin) {
            const margin = state.result.margin;
            const type = state.result.marginType;
            marginText = `by ${margin} ${type === 'runs' ? 'run' : 'wicket'}${margin !== 1 ? 's' : ''}`;
        }

        savePlayerStats(state.striker, state.battingTeam);
        savePlayerStats(state.nonStriker, state.battingTeam);
        savePlayerStats(state.bowler, state.bowlingTeam);
        saveCompletedMatchSummary();
        openWinModal(state.winner, marginText);
        
        state.isScoringLocked = true;
        // ui.scoringControls.classList.add('hidden'); // REMOVED THIS LINE
        
        updateFooterButtons();
        updateUI(); // Added to trigger the new footer overlay
    }
}
        
        function swapBatsmen() {
            if (state.striker) {
                state.striker.consecutiveFours = 0;
                state.striker.consecutiveSixes = 0;
            }
            [state.striker, state.nonStriker] = [state.nonStriker, state.striker];
            updateUI();
        }
        
        function undoLastAction() {
    if (state.history.length > 0) {
        const currentState = { ...state };
        delete currentState.history;
        delete currentState.redoHistory;
        state.redoHistory.push(JSON.stringify(currentState));

        const lastState = state.history.pop();
        Object.assign(state, JSON.parse(lastState));

        updateUI();
        debouncedSave();
    }
}

function redoLastAction() {
    if (state.redoHistory.length > 0) {
        const currentState = { ...state };
        delete currentState.history;
        delete currentState.redoHistory;
        state.history.push(JSON.stringify(currentState));

        const nextState = state.redoHistory.pop();
        Object.assign(state, JSON.parse(nextState));

        updateUI();
        debouncedSave();
    }
}

function saveState() {
    const stateToSave = { ...state };
    delete stateToSave.history;
    delete stateToSave.redoHistory; // Also remove redo history from snapshot

    try {
        state.history.push(JSON.stringify(stateToSave));
        if (state.history.length > 20) {
            state.history.shift();
        }
        // A new action clears the redo history
        state.redoHistory = [];
        debouncedSave();
    } catch (e) {
        console.error("Could not save state to history:", e);
    }
}

        // --- UI UPDATES ---
function updateUI() {
    updateMatchHeader();
    updateScoreboard();
    updateTargetInfo();
    updateBattingTable();
    updateBowlingTable();
    updateFooterButtons();
    updateFreeHitIndicator();
    updateHistoryButtons(); 

    // NEW: Handle Footer State (Active vs Match Ended)
    const activeUI = document.getElementById('active-scoring-ui');
    const endedUI = document.getElementById('match-ended-overlay');
    
    if (state.winner) {
        // If match is over: Hide buttons, show Undo message
        if (activeUI) activeUI.classList.add('hidden');
        if (endedUI) endedUI.classList.remove('hidden');
    } else {
        // If match is live: Show buttons, hide Undo message
        if (activeUI) activeUI.classList.remove('hidden');
        if (endedUI) endedUI.classList.add('hidden');
    }
}

// NEW FUNCTION: Handles the water ripple effect on click
function applyRipple(event) {
    const button = event.currentTarget;
    const circle = document.createElement("span");
    const diameter = Math.max(button.clientWidth, button.clientHeight);
    const radius = diameter / 2;

    circle.style.width = circle.style.height = `${diameter}px`;
    const rect = button.getBoundingClientRect();
    circle.style.left = `${event.clientX - rect.left - radius}px`;
    circle.style.top = `${event.clientY - rect.top - radius}px`;
    circle.classList.add("ripple"); // Uses existing .ripple CSS from the toss buttons

    const existingRipple = button.querySelector(".ripple");
    if (existingRipple) {
        existingRipple.remove();
    }

    button.appendChild(circle);
}

function updateHistoryButtons() {
    const container = document.getElementById('history-actions');
    if (!container) return;

    let undoBtn = document.getElementById('undo-btn');
    let redoBtn = document.getElementById('redo-btn');

    // Create buttons only if they don't exist
    if (!undoBtn) {
        container.innerHTML = `
            <button id="undo-btn" title="Undo (Ctrl+Z)" class="relative overflow-hidden flex items-center justify-center w-6 h-6 rounded-full bg-gray-200/60 backdrop-blur-sm border border-white/30 shadow-md text-gray-700 transition-all duration-200 active:scale-90 sm:w-auto sm:h-auto sm:rounded-md sm:py-2 sm:px-3 sm:gap-2 sm:bg-white sm:text-gray-800 sm:backdrop-blur-none sm:shadow-sm disabled:opacity-50 disabled:cursor-not-allowed">
                <svg class="w-3 h-3 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M3 10h10a8 8 0 018 8v2M3 10l4-4m-4 4l4 4"></path></svg>
                <span class="hidden sm:inline font-semibold">Undo</span>
            </button>
            <button id="redo-btn" title="Redo (Shift+Ctrl+Z)" class="relative overflow-hidden flex items-center justify-center w-6 h-6 rounded-full bg-gray-200/60 backdrop-blur-sm border border-white/30 shadow-md text-gray-700 transition-all duration-200 active:scale-90 sm:w-auto sm:h-auto sm:rounded-md sm:py-2 sm:px-3 sm:gap-2 sm:bg-white sm:text-gray-800 sm:backdrop-blur-none sm:shadow-sm disabled:opacity-50 disabled:cursor-not-allowed">
                <svg class="w-3 h-3 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M21 10H11a8 8 0 00-8 8v2m18-10l-4-4m4 4l-4 4"></path></svg>
                <span class="hidden sm:inline font-semibold">Redo</span>
            </button>
        `;
        undoBtn = document.getElementById('undo-btn');
        redoBtn = document.getElementById('redo-btn');
        
        // Attach event listeners that include the ripple effect
        undoBtn.addEventListener('click', (e) => {
            applyRipple(e);
            undoLastAction();
        });
        redoBtn.addEventListener('click', (e) => {
            applyRipple(e);
            redoLastAction();
        });
    }

    // Always update the disabled state
    undoBtn.disabled = state.history.length === 0;
    redoBtn.disabled = state.redoHistory.length === 0;
}

        function updateFooterButtons() {
            if (EXPERIMENT_ENABLE__FOOTER_REMATCH) {
                const rematchBtn = document.getElementById('rematch-btn');
                if (rematchBtn) {
                    // Enable the rematch button only when a winner is decided
                    rematchBtn.disabled = !state.winner;
                }
            }
        }

        function startRematch() {
            if (!state.winner) return;

            // 1. DYNAMICALLY CREATE THE REMATCH MODAL (If it doesn't exist yet)
            // UPDATED: Now uses "glass-modal-content", "glass-input", etc. for the Apple Watery Theme
            if (!document.getElementById('rematch-config-modal')) {
                const modalHTML = `
                <div id="rematch-config-modal" class="modal-overlay fixed inset-0 bg-black/40 backdrop-blur-sm flex justify-center items-center hidden z-50 p-4">
                    <div class="modal-content glass-modal-content rounded-2xl shadow-2xl p-6 w-full max-w-sm transform scale-95 border border-white/40">
                        <div class="text-center mb-6">
                            <h3 class="text-2xl font-bold text-gray-900 tracking-tight">Rematch Setup</h3>
                            <p class="text-sm text-gray-500 mt-1">Configure settings for the next game</p>
                        </div>
                        
                        <div class="space-y-5">
                            <div>
                                <label class="block text-xs font-semibold uppercase text-gray-500 mb-1.5 tracking-wider">Overs per Match</label>
                                <input type="number" id="rematch-overs-input" min="1" class="glass-input w-full font-bold text-center text-xl text-gray-800" value="${state.totalOvers}">
                            </div>
                            
                            <div>
                                <label class="block text-xs font-semibold uppercase text-gray-500 mb-1.5 tracking-wider">Batting First</label>
                                <select id="rematch-batting-select" class="glass-select w-full font-medium text-gray-800 text-center">
                                    </select>
                            </div>
                        </div>

                        <div class="flex items-center gap-3 mt-8">
                            <button onclick="closeModal('rematch-config-modal')" class="glass-button-secondary w-full justify-center">Cancel</button>
                            <button onclick="executeRematch()" class="glass-button-primary w-full justify-center shadow-lg shadow-blue-500/30">Start Match</button>
                        </div>
                    </div>
                </div>`;
                document.body.insertAdjacentHTML('beforeend', modalHTML);
            }

            // 2. PREPARE THE OPTIONS
            const batSelect = document.getElementById('rematch-batting-select');
            batSelect.innerHTML = '';
            
            const opt1 = document.createElement('option');
            opt1.value = 'team1';
            opt1.textContent = state.team1.name;
            batSelect.appendChild(opt1);

            const opt2 = document.createElement('option');
            opt2.value = 'team2';
            opt2.textContent = state.team2.name;
            batSelect.appendChild(opt2);

            // Pre-fill overs
            document.getElementById('rematch-overs-input').value = state.totalOvers;

            // 3. OPEN THE MODAL
            closeAllModals();
            openModal('rematch-config-modal');
        }

        function executeRematch() {
            // UPDATED: Added Validation for Overs
            const oversInput = document.getElementById('rematch-overs-input');
            const newOvers = parseInt(oversInput.value);

            if (isNaN(newOvers) || newOvers < 1) {
                showAlert("Please enter a valid number of overs (Minimum 1).");
                oversInput.focus();
                return;
            }

            const newBattingKey = document.getElementById('rematch-batting-select').value;
            const newBowlingKey = newBattingKey === 'team1' ? 'team2' : 'team1';

            // 1. RESET STATE BUT KEEP PLAYERS
            state.totalOvers = newOvers;
            state.innings = 1;
            state.target = 0;
            state.striker = null;
            state.nonStriker = null;
            state.bowler = null;
            state.lastBowler = null;
            state.currentOver = [];
            state.history = [];
            state.redoHistory = [];
            state.winner = null;
            state.result = null;
            state.battingTeam = newBattingKey;
            state.bowlingTeam = newBowlingKey;
            state.toss = { winner: 'Rematch Choice', decision: 'Selected directly' }; 

            // 2. RESET STATS FOR BOTH TEAMS
            ['team1', 'team2'].forEach(key => {
                const team = state[key];
                team.score = 0;
                team.wickets = 0;
                team.overs = 0;
                team.balls = 0;
                team.extras = { b: 0, lb: 0, wd: 0, nb: 0, total: 0 };
                team.inningsHistory = [];
                
                // Zero out every player's stats
                Object.keys(team.playerStats).forEach(pId => {
                    team.playerStats[pId] = {
                        ...team.playerStats[pId],
                        runs: 0, balls: 0, fours: 0, sixes: 0, isOut: false, dismissalInfo: null,
                        ballsBowled: 0, runsConceded: 0, wickets: 0, maidens: 0, dots: 0,
                        foursConceded: 0, sixesConceded: 0, consecutiveFours: 0, consecutiveSixes: 0
                    };
                });
            });

            // 3. SAVE AND RESTART
            localStorage.removeItem('matchState_v1');
            closeModal('rematch-config-modal');
            
            // Switch screens
            ui.summaryScreen.classList.add('hidden');
            ui.setupScreen.classList.add('hidden');
            ui.appScreen.classList.remove('hidden');

            // Force Re-Init
            updateUI();
            initialize();
        }

        function updateScoreboard() {
            const battingTeamKey = state.battingTeam;
            const bowlingTeamKey = state.bowlingTeam;
            const battingTeam = state[battingTeamKey];
            const bowlingTeam = state[bowlingTeamKey];

            const createTeamHTML = (team, isBatting) => {
                const overs = `${team.overs}.${team.balls}`;
                let scoreHTML;

                if (!isBatting && state.innings === 1) {
                    scoreHTML = `<p class="text-sm font-semibold text-gray-500">Yet to bat</p>`;
                } else {
                    scoreHTML = `
                        <p class="text-xl font-bold text-gray-900">${team.score}/${team.wickets}</p>
                        <p class="text-xs text-gray-500">(${overs} / ${state.totalOvers} ov)</p>
                    `;
                }

                // REAL-TIME UPDATE: Dynamically create logo or initial div
                let logoHTML;
                if (team.logo) {
                    logoHTML = `<img src="${team.logo}" class="w-7 h-7 rounded-full object-cover border border-gray-200">`;
                } else {
                    logoHTML = `<div class="w-7 h-7 rounded-full flex items-center justify-center font-semibold text-white text-xs" style="background-color: ${team.color};">
                                ${team.name.charAt(0).toUpperCase()}
                            </div>`;
                }

                return `
                    <div class="flex items-center justify-between py-1 ${!isBatting ? 'opacity-60' : ''}">
                        <div class="flex items-center gap-2">
                            ${logoHTML}
                            <span class="font-semibold text-gray-700">${team.name}</span>
                        </div>
                        <div class="text-right">
                            ${scoreHTML}
                        </div>
                    </div>
                `;
            };

            const battingTeamHTML = createTeamHTML(battingTeam, true);
            const bowlingTeamHTML = createTeamHTML(bowlingTeam, false);

            ui.teamScoresContainer.innerHTML = battingTeamHTML + bowlingTeamHTML;
            document.getElementById('scoreboard').style.background = '';
        }

        function updateTargetInfo() {
            if (state.innings !== 2 || state.winner) {
                ui.targetInfoContainer.classList.add('hidden');
                return;
            }

            const battingTeam = state[state.battingTeam];
            const runsNeeded = state.target - battingTeam.score;

            if (runsNeeded <= 0) {
                ui.targetInfoContainer.classList.add('hidden');
                return;
            }

            const totalBalls = state.totalOvers * 6;
            const ballsBowled = battingTeam.overs * 6 + battingTeam.balls;
            const ballsRemaining = totalBalls - ballsBowled;

            if (ballsRemaining <= 0 && runsNeeded > 0) {
                ui.targetInfoContainer.classList.add('hidden');
                return;
            }

            const crr = ballsBowled > 0 ? (battingTeam.score / (ballsBowled / 6)).toFixed(2) : '0.00';
            const rrr = ballsRemaining > 0 ? (runsNeeded / (ballsRemaining / 6)).toFixed(2) : '&infin;';

             ui.targetInfoContainer.innerHTML = `
                <p class="text-xs font-semibold text-gray-800 truncate">
                    <span>Target: <b class="font-black text-blue-700">${state.target}</b></span>
                    <span class="mx-2">|</span>
                    <span>Need <b class="font-black text-blue-700">${runsNeeded}</b> off <b>${ballsRemaining}</b> balls</span>
                    <span class="mx-2">|</span>
                    <span>RRR: <b class="font-black text-blue-700">${rrr}</b></span>
                </p>
            `;
            
            ui.targetInfoContainer.className = 'bg-blue-100 border-t border-b border-blue-200 py-1 px-2 text-center';
        }
        
        function updateBattingTable() {
    const battingTeam = state[state.battingTeam];
    const hasInningsStarted = battingTeam.inningsHistory.length > 0 || battingTeam.overs > 0 || battingTeam.balls > 0;

    // Stricter condition: Show placeholder ONLY if no batters are set AND the innings has not begun.
    if (!state.striker && !state.nonStriker && !hasInningsStarted) {
        ui.battingTable.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-gray-500">Select batsmen to begin</td></tr>`;
        return;
    }

    let fullTableHTML = '';

    if (state.striker) {
        fullTableHTML += createBatsmanRow(state.striker, true);
    }

    // Add swap button row only if both batsmen are actively on the field
    if (state.striker && state.nonStriker) {
        const swapRowHTML = `
            <tr class="h-0">
                <td class="p-0 border-t relative">
                    <button onclick="swapBatsmen()" title="Swap Batsmen" class="absolute right-0 transform -translate-x-1/2 -translate-y-1/2 z-10 w-7 h-7 flex items-center justify-center bg-white border-2 border-blue-500 rounded-full text-blue-600 hover:bg-blue-100 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-blue-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M8 9l4-4 4 4m0 6l-4 4-4-4" />
                        </svg>
                    </button>
                </td>
                <td class="p-0 border-t"></td>
                <td class="p-0 border-t"></td>
                <td class="p-0 border-t"></td>
                <td class="p-0 border-t"></td>
                <td class="p-0 border-t"></td>
            </tr>
        `;
        fullTableHTML += swapRowHTML;
    }

    if (state.nonStriker) {
        fullTableHTML += createBatsmanRow(state.nonStriker, false);
    }

    ui.battingTable.innerHTML = fullTableHTML;
}

       function createBatsmanRow(batsman, isStriker) {
            // Use toInt to ensure runs/balls are numbers, then apply specified SR formula
            const runs = toInt(batsman.runs);
            const balls = toInt(batsman.balls);
            const sr = balls > 0 ? ((runs / balls) * 100).toFixed(2) : '0.00';
            
            const fallbackImg = `data:image/svg+xml;base64,${btoa('<svg class="w-full h-full text-gray-400" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path></svg>')}`;
            
            return `
                <tr class="border-t align-middle">
                    <td class="p-2 font-semibold text-gray-800 flex items-center justify-between text-sm">
                        <span class="truncate">${batsman.name} ${isStriker ? '<span class="text-red-500 ml-1 text-xs">*</span>' : ''}</span>
                        <div class="flex items-center space-x-2">
                            <button onclick="editPlayer('${isStriker ? 'striker' : 'nonStriker'}')" title="Edit Player" class="text-gray-400 hover:text-gray-700">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L16.732 3.732z" /></svg>
                            </button>
                        </div>
                    </td>
                    <td class="text-center p-2 font-bold text-base">${runs}</td>
                    <td class="text-center p-2 text-base">${balls}</td>
                    <td class="text-center p-2 text-base">${toInt(batsman.fours)}</td>
                    <td class="text-center p-2 text-base">${toInt(batsman.sixes)}</td>
                    <td class="text-right p-2 text-base">${sr}</td>
                </tr>
            `;
        }

        function editPlayer(role) {
            savePlayerStats(state.striker, state.battingTeam);
            savePlayerStats(state.nonStriker, state.battingTeam);
            savePlayerStats(state.bowler, state.bowlingTeam);
            selectPlayer(role, () => {});
        }
        
        function updateBowlingTable() {
            ui.bowlingTable.innerHTML = '';
            if (state.bowler) {
                const bowler = state.bowler;
                // Use toInt to ensure numbers
                const ballsBowled = toInt(bowler.ballsBowled);
                const runsConceded = toInt(bowler.runsConceded);
                const maidens = toInt(bowler.maidens);
                const wickets = toInt(bowler.wickets);

                const overs = Math.floor(ballsBowled / 6);
                const balls = ballsBowled % 6;
                const oversDisplay = `${overs}.${balls}`;
                
                // Specified Econ formula
                const econ = ballsBowled > 0 ? (runsConceded * 6 / ballsBowled).toFixed(2) : '0.00';
                
                const fallbackImg = `data:image/svg+xml;base64,${btoa('<svg class="w-full h-full text-gray-400" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path></svg>')}`;

                // This part creates the main row for the bowler's stats
                let tableHTML = `
                    <tr class="border-t align-middle">
                        <td class="p-2 font-semibold text-gray-800 flex items-center text-sm">
                            <span class="flex-grow truncate">${bowler.name}</span>
                            <button onclick="editPlayer('bowler')" class="ml-2 text-gray-400 hover:text-gray-700">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L16.732 3.732z" /></svg>
                            </button>
                        </td>
                        <td class="text-center p-2 text-base">${oversDisplay}</td>
                        <td class="text-center p-2 text-base">${maidens}</td>
                        <td class="text-center p-2 text-base">${runsConceded}</td>
                        <td class="text-center p-2 text-base">${wickets}</td>
                        <td class="text-right p-2 text-base">${econ}</td>
                    </tr>
                `;

                // This new part adds the ball-by-ball display below the bowler
                if (state.currentOver.length > 0) {
                    let legalBallCount = 0; // Initialize a new counter for legal balls
                    const overHistoryHTML = state.currentOver.map((ball, index) => {
                        let ballEventText = ball.event;
                        let bgColor = 'bg-gray-300';
                        if (ballEventText === '0') { bgColor = 'bg-yellow-400 text-black'; }
                        if (ballEventText === '1') { bgColor = 'bg-sky-400 text-white'; }
                        if (ballEventText === '4') { bgColor = 'bg-blue-500 text-white'; }
                        if (ballEventText === '6') { bgColor = 'bg-green-500 text-white'; }
                        if (ballEventText.includes('W')) { bgColor = 'bg-red-500 text-white'; }
                        
                        const isIllegalDelivery = ballEventText.toLowerCase().includes('wd') || ballEventText.toLowerCase().includes('nb');

                        if (isIllegalDelivery) {
                            bgColor = 'bg-orange-400 text-white';
                        } else {
                            legalBallCount++; 
                        }
                        
                        let ballEventHTML;
                        if ((ballEventText.includes('NB+') || ballEventText.includes('WD+')) && ballEventText.length > 2) {
                            const prefix = ballEventText.substring(0, 3);
                            const runs = ballEventText.substring(3);
                            ballEventHTML = `<span style="font-size: 0.5rem; font-weight: 600; margin-right: -1px; letter-spacing: -0.5px;">${prefix}</span><span style="font-size: 0.7rem; font-weight: 700;">${runs}</span>`;
                        } else {
                            ballEventHTML = ballEventText;
                        }

                        const ballNumberLabel = `${state[state.battingTeam].overs}.${legalBallCount}`; 
                        
                        return `
                            <div class="flex flex-col items-center space-y-0.5">
                                <div class="w-6 h-6 rounded-full flex items-center justify-center text-[10px] font-bold ${bgColor}">${ballEventHTML}</div>
                                <p class="text-[9px] text-gray-400">${ballNumberLabel}</p>
                            </div>
                        `;
                    }).join('');
                    
                    tableHTML += `
                        <tr>
                            <td colspan="6" class="py-0 px-1">
                                <div class="flex items-start space-x-2 overflow-x-auto p-0.5 pt-1">
                                    ${overHistoryHTML}
                                </div>
                            </td>
                        </tr>
                    `;
                }
                ui.bowlingTable.innerHTML = tableHTML;
            } else {
                ui.bowlingTable.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-gray-500">Select bowler to begin</td></tr>`;
            }
        }
        
        // --- MODAL CONTROLS ---
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) return;
            modal.classList.remove('hidden');
            const modalContent = modal.querySelector('.modal-content');
            if (modalContent) {
                modalContent.style.transform = '';
                modalContent.style.opacity = '';
            }
            setTimeout(() => {
                modal.classList.remove('bg-opacity-0');
                if (modalContent) {
                    modalContent.classList.remove('scale-95', 'translate-y-full', 'scale-80', 'opacity-0');
                }
            }, 10);
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) return;
            modal.classList.add('bg-opacity-0');
            const modalContent = modal.querySelector('.modal-content');
            if (modalContent) {
                modalContent.classList.add('scale-95');
            }
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }
        
        function closeAllModals() {
            ['player-modal', 'wicket-type-modal', 'run-out-modal', 'wide-modal', 'noball-modal', 'byes-modal', 'legbyes-modal', 'alert-modal', 'confirm-modal', 'edit-match-modal', 'preview-modal', 'fielder-modal', 'end-match-modal', 'player-out-summary-modal', 'innings-break-modal', 'runs-attempted-modal', 'squad-selection-modal', 'pitch-map-modal'].forEach(closeModal);
            if (!ui.winModal.classList.contains('hidden')) {
                 ui.winModal.classList.add('hidden');
            }
        }

        function showAlert(message, onOkCallback) {
            ui.alertMessage.textContent = message;
            alertCallback = onOkCallback;
            openModal('alert-modal');
        }

        let confirmCallback = null;
        function showConfirm(message, onConfirm) {
            ui.confirmMessage.textContent = message;
            confirmCallback = onConfirm;
            openModal('confirm-modal');
        }

        let resultDraft = {};

function openEndMatchModal(step = 1) {
    const step1 = document.getElementById('end-match-step-1');
    const step2 = document.getElementById('end-match-step-2');
    const backBtn = document.getElementById('end-match-back-btn');
    const confirmBtn = document.getElementById('end-match-confirm-btn');

    if (step === 1) {
        resultDraft = {}; // Reset draft on first open
        step1.classList.add('active');
        step2.classList.remove('active');
        backBtn.classList.add('hidden');
        confirmBtn.disabled = true;

        // Build Outcome Radio Cards
        const outcomesContainer = document.getElementById('end-match-outcomes');
        const outcomes = [
            { id: 'completed_normal', title: 'Completed', desc: 'A standard win by runs or wickets.' },
            { id: 'completed_dls', title: 'Completed (DLS)', desc: 'Result decided by DLS method.' },
            { id: 'tie', title: 'Match Tied', desc: 'Scores are level after all innings.' },
            { id: 'no_result', title: 'No Result', desc: 'Match started but not finished.' },
            { id: 'abandoned', title: 'Abandoned', desc: 'Match called off without a ball bowled.' },
            { id: 'forfeit', title: 'Forfeit / Conceded', desc: 'One team concedes the match.' },
        ];
        outcomesContainer.innerHTML = outcomes.map(o => `
            <div class="outcome-card" data-outcome="${o.id}">
                <h4>${o.title}</h4><p>${o.desc}</p>
            </div>
        `).join('');

        document.querySelectorAll('.outcome-card').forEach(card => {
            card.onclick = () => selectMatchOutcome(card.dataset.outcome);
        });

    } else if (step === 2) {
        step1.classList.remove('active');
        step2.classList.add('active');
        backBtn.classList.remove('hidden');
        confirmBtn.disabled = false;
    }

    
    openModal('end-match-modal');
}

function selectMatchOutcome(outcome) {
    resultDraft = { type: outcome };
    document.querySelectorAll('.outcome-card').forEach(c => c.classList.remove('selected'));
    document.querySelector(`.outcome-card[data-outcome="${outcome}"]`).classList.add('selected');

    const fieldsContainer = document.getElementById('end-match-dynamic-fields');
    const team1Name = state.team1.name;
    const team2Name = state.team2.name;

    // Dynamic fields based on outcome
    let fieldsHTML = '';
    switch(outcome) {
        case 'completed_normal':
        case 'completed_dls':
            fieldsHTML = `
                <div><label class="font-medium">Winner</label><select id="result-winner" class="w-full mt-1 p-2 border rounded-md"><option value="${team1Name}">${team1Name}</option><option value="${team2Name}">${team2Name}</option></select></div>
                <div class="mt-4"><label class="font-medium">Margin</label><div class="flex items-center gap-2 mt-1"><select id="result-margin-type" class="p-2 border rounded-md"><option value="runs">runs</option><option value="wickets">wickets</option></select><input id="result-margin-value" type="number" class="w-full p-2 border rounded-md" placeholder="e.g., 7"></div></div>
                ${outcome === 'completed_dls' ? '<div class="mt-4"><label class="flex items-center"><input type="checkbox" id="result-dls-applied" class="h-4 w-4 mr-2">DLS Method Applied</label></div>' : ''}
            `;
            break;
        case 'tie':
            fieldsHTML = `<div><label class="flex items-center"><input type="checkbox" id="result-super-over" class="h-4 w-4 mr-2">Schedule Super Over?</label></div>`;
            break;
        case 'forfeit':
             fieldsHTML = `<div><label class="font-medium">Team that Conceded</label><select id="result-conceded-by" class="w-full mt-1 p-2 border rounded-md"><option value="${team1Name}">${team1Name}</option><option value="${team2Name}">${team2Name}</option></select></div>`;
            break;
        default: // No Result, Abandoned, etc.
             fieldsHTML = `<div><label class="font-medium">Reason</label><select id="result-reason" class="w-full mt-1 p-2 border rounded-md"><option>Rain</option><option>Bad Light</option><option>Unsafe Pitch</option><option>Time Overrun</option><option>Other</option></select></div>`;
            break;
    }

    fieldsContainer.innerHTML = `<div class="field-group" style="display: block;">${fieldsHTML}</div>`;

    // Add listeners to update draft on change
    fieldsContainer.querySelectorAll('input, select').forEach(el => {
        el.oninput = () => {
            const winnerSelect = document.getElementById('result-winner');
            const marginTypeSelect = document.getElementById('result-margin-type');
            const marginValueInput = document.getElementById('result-margin-value');
            const dlsCheckbox = document.getElementById('result-dls-applied');
            const superOverCheckbox = document.getElementById('result-super-over');
            const concededBySelect = document.getElementById('result-conceded-by');
            const reasonSelect = document.getElementById('result-reason');

            if (winnerSelect) resultDraft.winner = winnerSelect.value;
            if (marginTypeSelect) resultDraft.marginType = marginTypeSelect.value;
            if (marginValueInput) resultDraft.marginValue = marginValueInput.value;
            if (dlsCheckbox) resultDraft.dlsApplied = dlsCheckbox.checked;
            if (superOverCheckbox) resultDraft.superOver = superOverCheckbox.checked;
            if (reasonSelect) resultDraft.reason = reasonSelect.value;
            if (concededBySelect) {
                resultDraft.concededBy = concededBySelect.value;
                resultDraft.winner = concededBySelect.value === state.team1.name ? state.team2.name : state.team1.name;
            }

            
        };
        // Trigger initial input to populate draft
        el.dispatchEvent(new Event('input'));
    });

    openEndMatchModal(2);
}

function generateResultSummaryLine(result) {
    // This function is now only used for the *summary screen ribbon*
    if (!result || !result.status) return 'Match in progress...';

    const winnerName = result.winnerSide ? state[result.winnerSide].name : null;

    // Handle Super Over win specifically
    if (result.superOver && winnerName) {
        return `${winnerName} won in Super Over.`;
    }

    switch(result.status) {
        case 'completed_normal':
        case 'completed_dls':
            if (winnerName && result.margin && result.marginType) {
                let summary = `${winnerName} won by ${result.margin} ${result.marginType}.`;
                if(result.status === 'completed_dls') summary += ' (DLS Method)';
                return summary;
            }
            // Fallback if data is missing
            return `${winnerName || 'Team'} won the match.`;
            
        case 'tie':
            return `Match tied.`;
            
        case 'forfeit':
             if (winnerName) {
                return `${winnerName} won by forfeit.`;
             }
             return 'Match forfeited.';

        case 'no_result':
        case 'abandoned':
            return `No result.`;
            
        default:
            return 'Match concluded.';
    }
}

function endMatch() {
    if (!resultDraft || !resultDraft.type) {
        showAlert('Invalid result. Please start again.');
        return;
    }

    saveState(); // ADDED: Save state so we can Undo the "End Match" action

    // Determine winner side ('team1', 'team2', or null)
    let winnerSide = null;
    if (resultDraft.winner === state.team1.name) {
        winnerSide = 'team1';
    } else if (resultDraft.winner === state.team2.name) {
        winnerSide = 'team2';
    }

    // Save a structured result object to the state
    state.result = {
        status: resultDraft.type,
        winnerSide: winnerSide,
        marginType: resultDraft.marginType,
        margin: resultDraft.marginValue,
        reason: resultDraft.reason,
        superOver: resultDraft.superOver
    };
    
    state.winner = resultDraft.winner || (resultDraft.type === 'tie' ? 'Match Tied' : 'No Result');
    
    const summaryLine = generateResultSummaryLine(state.result);
    state.winMargin = summaryLine; 

    state.isScoringLocked = true;
    // ui.scoringControls.classList.add('hidden'); // REMOVED THIS LINE

    updateLiveCommentary(`<b>MATCH ENDED:</b> ${summaryLine}`);

    saveCompletedMatchSummary();
    localStorage.removeItem('matchState_v1');
    window.removeEventListener('beforeunload', beforeUnloadHandler);

    closeModal('end-match-modal');
    updateUI(); 
    showSummaryScreen();
}

// Wire up the confirm button
document.getElementById('end-match-confirm-btn').onclick = endMatch;
        
        function confirmStartNewMatch() {
    showConfirm('Are you sure you want to start a new match? All current progress will be lost.', () => {
        localStorage.removeItem('matchState_v1'); // Clear autosaved state before reloading
        window.location.reload();
    });
}

        // --- WIN MODAL & SUMMARY CONTROLS ---
        function launchCelebration() {
            const container = document.getElementById('confetti-container');
            container.innerHTML = '';
            
            // 1. Victory Glow
            const logo = document.getElementById('wm-winner-logo');
            const name = document.getElementById('wm-winner-name');
            logo.classList.add('victory-glow');
            name.classList.add('victory-glow');
            
            // Stop glow after 5 seconds
            setTimeout(() => {
                logo.classList.remove('victory-glow');
                name.classList.remove('victory-glow');
            }, 5000);

            // 2. Confetti
            const colors = ['#fde047', '#06b6d4', '#f43f5e', '#4ade80', '#a78bfa', '#f97316', '#3b82f6', '#d946ef'];
            const confettiCount = 100;
            for (let i = 0; i < confettiCount; i++) {
                const confetti = document.createElement('i');
                const color = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.animationDelay = Math.random() * 4 + 's';
                confetti.style.animationDuration = 3 + Math.random() * 3 + 's';
                confetti.style.backgroundColor = color;
                
                if (i % 3 === 0) { confetti.style.width = '5px'; confetti.style.height = '10px'; }
                else if (i % 2 === 0) { confetti.style.width = '8px'; confetti.style.height = '8px'; confetti.style.borderRadius = '50%'; }
                
                container.appendChild(confetti);
            }

            // 3. Fireworks
            const fireworksCount = 10;
            for (let i = 0; i < fireworksCount; i++) {
                setTimeout(() => {
                    const firework = document.createElement('div');
                    firework.className = 'firework';
                    firework.style.left = (10 + Math.random() * 80) + 'vw';
                    firework.style.top = (10 + Math.random() * 80) + 'vh';
                    
                    const particleCount = 30;
                    for (let j = 0; j < particleCount; j++) {
                        const particle = document.createElement('div');
                        particle.className = 'firework';
                        particle.style.transform = `rotate(${Math.random() * 360}deg) scale(0.5)`;
                        particle.style.animationDuration = (0.8 + Math.random() * 0.4) + 's';
                        particle.style.background = colors[Math.floor(Math.random() * colors.length)];
                        firework.appendChild(particle);
                    }
                    container.appendChild(firework);
                    // Remove firework element after animation
                    setTimeout(() => firework.remove(), 1200);
                }, Math.random() * 3000); // Stagger fireworks
            }
        }

        function openWinModal(winnerName, margin) {
            // This cloning is done to restart the CSS animations on the modal.
            const modalContent = ui.winModal.querySelector('.modal-content');
            const newModalContent = modalContent.cloneNode(true);
            modalContent.parentNode.replaceChild(newModalContent, modalContent);
            
            // --- 1. Display Winner Info ---
            if (winnerName === 'Match Tied') {
                document.getElementById('wm-winner-name').textContent = "MATCH TIED";
                document.getElementById('wm-win-margin').textContent = '';
                document.getElementById('wm-winner-logo').style.display = 'none';
            } else {
                const winnerTeamKey = state.result.winnerSide;
                const winnerTeamData = state[winnerTeamKey];
                document.getElementById('wm-winner-logo').style.display = 'block';
                document.getElementById('wm-winner-logo').src = winnerTeamData.logo || '';
                document.getElementById('wm-winner-name').textContent = `${winnerTeamData.name} WINS`;
                document.getElementById('wm-win-margin').textContent = `by ${state.result.margin} ${state.result.marginType}`;
            }

            // --- 2. Scorelines ---
            const teams = [state.team1, state.team2];
            teams.forEach((team, index) => {
                const ballsFaced = team.overs * 6 + team.balls;
                const rr = ballsFaced > 0 ? (team.score / (ballsFaced / 6)).toFixed(2) : '0.00';
                document.getElementById(`wm-scoreline-${index + 1}`).innerHTML = `
                    <span class="flex items-center gap-2">
                        <img src="${team.logo || ''}" class="w-5 h-5 rounded-full object-cover">
                        ${team.name}
                    </span>
                    <span>
                        <b class="text-white text-base">${team.score}/${team.wickets}</b> 
                        <span class="text-gray-400">(${team.overs}.${team.balls})</span> 
                        <span class="text-gray-400 ml-2">RR ${rr}</span>
                    </span>`;
            });

            // --- 3. Top Performers ---
            const allPlayers = [...Object.values(state.team1.playerStats), ...Object.values(state.team2.playerStats)];
            const topBatters = allPlayers.filter(p => p.runs > 0).sort((a,b) => b.runs - a.runs).slice(0, 2);
            document.getElementById('wm-top-batters').innerHTML = topBatters.map(p => `
                <div>
                    <p class="font-semibold">${p.name}</p>
                    <p class="text-gray-400">${p.runs} (${p.balls}), SR ${p.balls > 0 ? (p.runs/p.balls*100).toFixed(2) : '0.00'}</p>
                </div>`).join('');

            const topBowlers = allPlayers.filter(p => p.ballsBowled > 0).sort((a, b) => b.wickets - a.wickets || a.runsConceded - b.runsConceded).slice(0, 2);
            document.getElementById('wm-top-bowlers').innerHTML = topBowlers.map(p => `
                <div>
                    <p class="font-semibold">${p.name}</p>
                    <p class="text-gray-400">${Math.floor(p.ballsBowled/6)}.${p.ballsBowled%6}-${p.maidens}-${p.runsConceded}-${p.wickets}, ECO ${p.ballsBowled > 0 ? (p.runsConceded/(p.ballsBowled/6)).toFixed(2) : '0.00'}</p>
                </div>`).join('');

            // --- 4. Man of the Match Picker ---
            const momPickerList = document.getElementById('wm-mom-picker-list');
            const rankedPlayers = calculateManOfTheMatch().slice(0, 5); // Get top 5
            
            // --- FIX: Add a better fallback silhouette image for onerror ---
            const fallbackSvg = `data:image/svg+xml;base64,PHN2ZyBjbGFzcz0idy0xMCBoLTEwIHRleHQtZ3JheS00MDAiIGZpbGw9ImN1cnJlbnRDb2xvciIgdmlld0JveD0iMCAwIDIwIDIwIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxwYXRoIGZpbGwtcnVsZT0iZXZlbm9kZCIgZD0iTTEwIDlhMyAzIDAgMTAwLTYgMyAzIDAgMDAwIDZ6bS03IDlhNyA3IDAgMTExNCAwSDN6IiBjbGlwLXJ1bGU9ImV2ZW5vZGQiPjwvcGF0aD48L3N2Zz4=`;

            if (rankedPlayers.length > 0) {
                momPickerList.innerHTML = rankedPlayers.map((player, index) => {
                    // Use player.image, which is (player.avatar || team.logo) from calculateManOfTheMatch
                    const imageSrc = player.image || fallbackSvg; 
                    return `
                    <label>
                        <input type="radio" name="mom-picker" value="${player.playerId}" ${index === 0 ? 'checked' : ''}>
                        <img src="${imageSrc}" class="w-8 h-8 rounded-full object-cover border border-gray-600" onerror="this.src='${fallbackSvg}'">
                        <div>
                            <p class="mom-picker-name">${player.name} <span class="text-xs text-gray-400">(${player.teamName})</span></p>
                            <p class="mom-picker-perf">${player.performance || 'No notable performance'}</p>
                        </div>
                    </label>
                `}).join('');
            } else {
                 document.getElementById('wm-mom-picker-section').style.display = 'none';
            }

            // --- 5. Meta Line ---
            const dateStr = new Date(state.matchDate + 'T00:00:00').toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
            document.getElementById('wm-meta-line').textContent = `${toTitleCase(state.venue)} ‚Ä¢ ${dateStr} ‚Ä¢ ${state.totalOvers} Overs`;
            
            // --- 6. Final Setup & Button Handler ---
            const confirmBtn = document.getElementById('win-modal-confirm-btn');
            confirmBtn.onclick = () => {
                const selectedRadio = document.querySelector('input[name="mom-picker"]:checked');
                if (selectedRadio) {
                    const selectedPlayerId = selectedRadio.value;
                    const chosenPlayer = rankedPlayers.find(p => p.playerId === selectedPlayerId);
                    if (chosenPlayer) {
                        state.manOfTheMatch = chosenPlayer;
                        saveCompletedMatchSummary(); // Persist the MoM selection
                    }
                }
                closeModal('win-modal');
                showSummaryScreen();
            };
            
            ui.winModal.classList.remove('hidden');
            if (winnerName !== 'Match Tied') {
                launchCelebration(); // Use the new celebration function
            }
        }

        function formatDismissalText(dismissalInfo) {
            if (!dismissalInfo) return 'not out';
            const { type, bowler, fielder, via } = dismissalInfo;
            if (type === 'Catch' && fielder) {
                return `c ${formatPlayerName(fielder)} b ${formatPlayerName(bowler)}`;
            } else if (type === 'Run Out') {
                return `run out ${via ? `(${via})` : ''}`;
            } else if (bowler) {
                return `${type.toLowerCase()} b ${formatPlayerName(bowler)}`;
            } else {
                return type.toLowerCase();
            }
        }

        function openInningsBreakModal() {
            const battingTeamData = state[state.battingTeam];
            const bowlingTeamData = state[state.bowlingTeam];
            const target = battingTeamData.score + 1;

            // --- 1. Calculate Innings Statistics ---
            const ballsBowled = battingTeamData.overs * 6 + battingTeamData.balls;
            const runRate = ballsBowled > 0 ? (battingTeamData.score / (ballsBowled / 6)).toFixed(2) : '0.00';

            const topBatters = Object.values(battingTeamData.playerStats)
                .filter(p => p.balls > 0 || p.isOut)
                .sort((a, b) => b.runs - a.runs)
                .slice(0, 3);
            
            const topBowlers = Object.values(bowlingTeamData.playerStats)
                .filter(p => p.ballsBowled > 0)
                .sort((a, b) => b.wickets - a.wickets || a.runsConceded - b.runsConceded)
                .slice(0, 3);

            const fow = battingTeamData.inningsHistory
                .filter(ball => ball.dismissalInfo)
                .map(ball => `${ball.dismissalInfo.scoreAtFall}-${battingTeamData.wickets - (battingTeamData.inningsHistory.filter(b => b.dismissalInfo && b.dismissalInfo.scoreAtFall <= ball.dismissalInfo.scoreAtFall).length - 1)} (${ball.dismissalInfo.overAtFall})`)
                .join(', ');

            let dots = 0, fours = 0, sixes = 0;
            battingTeamData.inningsHistory.forEach(ball => {
                if (ball.event === '0' || ball.event === '.' || (ball.event === 'W' && !ball.runs)) dots++;
                if (ball.runs === 4) fours++;
                if (ball.runs === 6) sixes++;
            });

            // --- 2. Populate Modal with Calculated Data ---
            document.getElementById('ib-batting-team-name').textContent = battingTeamData.name;
            document.getElementById('ib-batting-team-score').textContent = `${battingTeamData.score}/${battingTeamData.wickets}`;
            document.getElementById('ib-batting-team-overs').textContent = `(${battingTeamData.overs}.${battingTeamData.balls} Ov)`;
            document.getElementById('ib-run-rate').textContent = `Run Rate: ${runRate}`;

            document.getElementById('ib-top-batters').innerHTML = topBatters.map(p => `
                <li class="flex justify-between">
                    <span>${formatPlayerName(p.name)}</span>
                    <span class="font-bold">${p.runs} <span class="text-gray-400 font-normal">(${p.balls})</span></span>
                </li>`).join('');

            document.getElementById('ib-top-bowlers').innerHTML = topBowlers.map(p => `
                <li class="flex justify-between">
                    <span>${formatPlayerName(p.name)}</span>
                    <span class="font-bold">${p.wickets}/${p.runsConceded}</span>
                </li>`).join('');

            document.getElementById('ib-fow').textContent = fow || 'No wickets lost.';
            document.getElementById('ib-extras').textContent = `${battingTeamData.extras.total} (wd ${battingTeamData.extras.wd}, nb ${battingTeamData.extras.nb}, b ${battingTeamData.extras.b}, lb ${battingTeamData.extras.lb})`;
            document.getElementById('ib-boundaries').textContent = `Dots: ${dots}, 4s: ${fours}, 6s: ${sixes}`;

            // --- 3. Populate Target Box ---
            document.getElementById('innings-break-target-team').textContent = `${bowlingTeamData.name} need`;
            document.getElementById('innings-break-target-runs').textContent = target;

            // --- 4. Set up the 'Start 2nd Innings' Button ---
            const startBtn = document.getElementById('start-second-innings-btn');
            const newStartBtn = startBtn.cloneNode(true);
            startBtn.parentNode.replaceChild(newStartBtn, startBtn);
            
            newStartBtn.onclick = () => {
                closeModal('innings-break-modal');
                state.innings = 2;
                state.target = target;
                [state.battingTeam, state.bowlingTeam] = [state.bowlingTeam, state.battingTeam];
                
                const newBattingTeam = state[state.battingTeam];
                newBattingTeam.score = 0;
                newBattingTeam.wickets = 0;
                newBattingTeam.overs = 0;
                newBattingTeam.balls = 0;

                state.striker = null;
                state.nonStriker = null;
                state.bowler = null;
                state.lastBowler = null;
                state.currentOver = [];
                
                initialize(true);
            };

            openModal('innings-break-modal');
        }

        async function showPlayerOutSummary(playerOutObject) {
            return new Promise(resolve => {
                const teamKey = state.team1.players.includes(playerOutObject.name) ? 'team1' : 'team2';
                const team = state[teamKey];
                
                const imageContainer = document.getElementById('summary-player-image-container');
                imageContainer.innerHTML = '';

                if (playerOutObject.image) {
                    const img = document.createElement('img');
                    img.src = playerOutObject.image;
                    img.className = 'w-full h-full rounded-full object-cover';
                    imageContainer.appendChild(img);
                } else {
                    imageContainer.innerHTML = `<svg class="w-16 h-16 text-gray-400" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path></svg>`;
                }

                document.getElementById('summary-player-name').textContent = formatPlayerName(playerOutObject.name);
                document.getElementById('summary-dismissal-info').textContent = formatDismissalText(playerOutObject.dismissalInfo);
                document.getElementById('summary-player-runs').textContent = playerOutObject.runs;
                document.getElementById('summary-player-balls').textContent = playerOutObject.balls;
                document.getElementById('summary-player-fours').textContent = playerOutObject.fours;
                document.getElementById('summary-player-sixes').textContent = playerOutObject.sixes;
                document.getElementById('summary-team-logo').src = team.logo || `https://placehold.co/60x60/${team.color.substring(1)}/FFFFFF?text=${team.name.charAt(0)}`;

                const modalContent = document.getElementById('player-out-summary-modal').querySelector('.modal-content');
                modalContent.classList.add('summary-pop-in-animation');

                const okBtn = document.getElementById('summary-ok-btn');
                const newOkBtn = okBtn.cloneNode(true);
                okBtn.parentNode.replaceChild(newOkBtn, okBtn);

                newOkBtn.onclick = () => {
                    modalContent.classList.remove('summary-pop-in-animation');
                    closeModal('player-out-summary-modal');
                    resolve();
                };
                
                openModal('player-out-summary-modal');
            });
        }
        
       function calculateManOfTheMatch() {
            // --- Step 1: Calculate Fielding Stats First ---
            const allPlayerStats = {...state.team1.playerStats, ...state.team2.playerStats};
            // Reset fielding stats
            Object.values(allPlayerStats).forEach(p => {
                p.catches = 0;
                p.runouts = 0;
                p.stumpings = 0;
            });
            // Tally fielding stats from innings history
            [...state.team1.inningsHistory, ...state.team2.inningsHistory].forEach(ball => {
                if (ball.event === 'W' && ball.dismissalInfo) {
                    const { type, fielder } = ball.dismissalInfo;
                    if (fielder && allPlayerStats[fielder]) {
                         if (type === 'Catch') allPlayerStats[fielder].catches++;
                         if (type === 'Stump Out') allPlayerStats[fielder].stumpings++;
                         if (type === 'Run Out') allPlayerStats[fielder].runouts++;
                    }
                }
            });

            // --- Step 2: Calculate MoM Score for Each Player ---
            let rankedPlayers = Object.values(allPlayerStats).map((player, index) => {
                let battingScore = 0, bowlingScore = 0, fieldingScore = 0;
                let performance = [];

                // Batting Score
                if (player.balls > 0 || player.runs > 0) {
                    battingScore += player.runs;
                    battingScore += player.fours * 1 + player.sixes * 2; // Boundary bonus
                    if (!player.isOut) battingScore += 10; // Not out bonus

                    const sr = player.balls > 0 ? (player.runs / player.balls) * 100 : 0;
                    if (sr >= 200) battingScore += 20;
                    else if (sr >= 170) battingScore += 15;
                    else if (sr >= 140) battingScore += 8;
                    
                    performance.push(`${player.runs}${!player.isOut ? '*' : ''} (${player.balls})`);
                }

                // Bowling Score
                if (player.ballsBowled > 0) {
                    bowlingScore += player.wickets * 20;
                    bowlingScore += player.maidens * 8;
                    if (player.wickets >= 5) bowlingScore += 8;
                    else if (player.wickets >= 3) bowlingScore += 3;

                    const overs = player.ballsBowled / 6;
                    if (overs > 0) {
                        const econ = player.runsConceded / overs;
                        if (econ < 6) bowlingScore += 10;
                        else if (econ < 7.5) bowlingScore += 6;
                        else if (econ < 9) bowlingScore += 3;
                    }
                    performance.push(`${player.wickets}/${player.runsConceded}`);
                }

                // Fielding Score
                fieldingScore += player.catches * 6 + player.runouts * 8 + player.stumpings * 8;
                if(player.catches > 0) performance.push(`${player.catches} catch${player.catches > 1 ? 'es' : ''}`);
                if(player.runouts > 0) performance.push(`${player.runouts} run-out${player.runouts > 1 ? 's' : ''}`);
                if(player.stumpings > 0) performance.push(`${player.stumpings} stumping${player.stumpings > 1 ? 's' : ''}`);

                const totalScore = battingScore + bowlingScore + fieldingScore;
                
                // --- FIX: Correctly determine teamKey by checking if the playerId exists in team1's stats ---
                const teamKey = state.team1.playerStats[player.playerId] ? 'team1' : 'team2';

                return {
                    playerId: player.playerId, // Pass the stable ID through
                    name: player.name,
                    teamName: state[teamKey].name,
                    teamKey: teamKey,
                    image: player.image || state[teamKey].logo, // Prioritizes player avatar, falls back to team logo
                    score: totalScore,
                    performance: performance.join(' & '),
                    // For tie-breaking
                    wickets: player.wickets,
                    runs: player.runs,
                    fieldingInvolvements: player.catches + player.runouts + player.stumpings,
                    ballsFaced: player.balls,
                    economy: player.ballsBowled > 0 ? player.runsConceded / (player.ballsBowled / 6) : 999,
                    isHomeTeam: teamKey === 'team1',
                    index: index,
                };
            });

            // --- Step 3: Sort Players with Tie-breakers ---
            rankedPlayers.sort((a, b) => {
                if (b.score !== a.score) return b.score - a.score; // 1. Higher score
                if (b.wickets !== a.wickets) return b.wickets - a.wickets; // 2. Higher wickets
                if (b.runs !== a.runs) return b.runs - a.runs; // 3. Higher runs
                if (b.fieldingInvolvements !== a.fieldingInvolvements) return b.fieldingInvolvements - a.fieldingInvolvements; // 4. More fielding
                if (a.ballsFaced !== b.ballsFaced) return a.ballsFaced - b.ballsFaced; // 5. Fewer balls faced
                if (a.economy !== b.economy) return a.economy - b.economy; // 6. Lower economy
                if (b.isHomeTeam !== a.isHomeTeam) return b.isHomeTeam ? 1 : -1; // 7. Home team player
                return a.index - b.index; // 8. Original index
            });

            return rankedPlayers.slice(0, 5);
        }

        function showSummaryScreen() {
            if (state.striker) savePlayerStats(state.striker, state.battingTeam);
            if (state.nonStriker) savePlayerStats(state.nonStriker, state.battingTeam);
            if (state.bowler) savePlayerStats(state.bowler, state.bowlingTeam);
            closeAllModals();

            updateMatchHeader();
            document.getElementById('summary-header-team1').innerHTML = `<img src="${state.team1.logo || ''}" class="summary-team-logo"><span class="summary-team-header hidden sm:inline">${state.team1.name}</span>`;
            document.getElementById('summary-header-team2').innerHTML = `<span class="summary-team-header hidden sm:inline">${state.team2.name}</span><img src="${state.team2.logo || ''}" class="summary-team-logo">`;
            document.getElementById('summary-status-ribbon').textContent = calculateCurrentStatus();
            document.getElementById('summary-venue-date').textContent = `${toTitleCase(state.venue)} | ${new Date(state.matchDate + 'T00:00:00').toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}`;

            const scoreStripsContainer = document.getElementById('summary-score-strips');
            const panel1 = document.getElementById('panel-innings1');
            const panel2 = document.getElementById('panel-innings2');
            const motmPanel = document.getElementById('summary-motm-panel');
            scoreStripsContainer.innerHTML = '';
            panel1.innerHTML = '';
            panel2.innerHTML = '';
            motmPanel.innerHTML = '';

            const inningsOrder = [state.team1, state.team2];
            if (state.innings === 1 && state.battingTeam === 'team2') inningsOrder.reverse();
            if (state.innings === 2 && state.bowlingTeam === 'team2') inningsOrder.reverse();

            inningsOrder.forEach((teamData, index) => {
                const oversPlayed = `${teamData.overs}.${teamData.balls}`;
                const ballsBowled = teamData.overs * 6 + teamData.balls;
                const runRate = ballsBowled > 0 ? (teamData.score / (ballsBowled / 6)).toFixed(2) : '0.00';
                let targetHTML = '';
                if (index === 1 && state.target > 0) {
                    targetHTML = `<div class="target">Target: ${state.target}</div>`;
                }
                scoreStripsContainer.innerHTML += `
                    <div class="summary-score-strip">
                        <img src="${teamData.logo || ''}" class="summary-team-logo mr-3">
                        <span class="team-name">${teamData.name}</span>
                        <span class="score ml-auto">${teamData.score}/${teamData.wickets}</span>
                        <span class="overs">(${oversPlayed} Ov)</span>
                        <span class="rr">RR: ${runRate}</span>
                        ${targetHTML}
                    </div>`;
            });

            panel1.innerHTML = buildInningsCardHTML(inningsOrder[0]);
            panel2.innerHTML = (state.innings === 2 || state.winner) ? buildInningsCardHTML(inningsOrder[1]) : '<div class="summary-innings-card p-4 text-center text-gray-500">Yet to bat</div>';

            const tab1 = document.getElementById('summary-tab-innings1');
            const tab2 = document.getElementById('summary-tab-innings2');
            tab1.textContent = `${inningsOrder[0].name} Innings`;
            tab2.textContent = `${inningsOrder[1].name} Innings`;
            const tabs = [tab1, tab2];
            const panels = [panel1, panel2];
            const switchTab = (tabToActivate) => {
                tabs.forEach(tab => tab.setAttribute('aria-selected', (tab === tabToActivate).toString()));
                panels.forEach(panel => panel.hidden = (panel.id !== tabToActivate.getAttribute('aria-controls')));
            };
            tab1.onclick = () => switchTab(tab1);
            tab2.onclick = () => switchTab(tab2);
            switchTab(tab1); 

            // MODIFIED: MoM selection is now done in the win modal.
            // We just need to display the final result if it exists.
            if (state.manOfTheMatch) {
                motmPanel.innerHTML = renderFinalMoMCard(state.manOfTheMatch);
            }
            
            showScreen('summary-screen');
        }

        function backToScorecard() {
            closeModal('win-modal');
            if (state.winner) {
                showScreen('app');
            } else {
                showScreen('app');
            }
        }

        function confirmSuggestedMoM() {
            const rankedPlayers = calculateManOfTheMatch();
            if (rankedPlayers.length > 0) {
                state.manOfTheMatch = rankedPlayers[0];
                saveCompletedMatchSummary();
                showSummaryScreen();
            }
        }

        function renderFinalMoMCard(player) {
            return `
                 <div id="summary-motm-card" class="mt-4">
                    <h3>Man of the Match</h3>
                    <p class="motm-name">${player.name}</p>
                    <p class="motm-team">${player.teamName}</p>
                    <p class="motm-contribution">${player.performance}</p>
                </div>`;
        }

        function showSummaryScreen() {
            if (state.striker) savePlayerStats(state.striker, state.battingTeam);
            if (state.nonStriker) savePlayerStats(state.nonStriker, state.battingTeam);
            if (state.bowler) savePlayerStats(state.bowler, state.bowlingTeam);
            closeAllModals();

            updateMatchHeader();
            document.getElementById('summary-header-team1').innerHTML = `<img src="${state.team1.logo || ''}" class="summary-team-logo"><span class="summary-team-header hidden sm:inline">${state.team1.name}</span>`;
            document.getElementById('summary-header-team2').innerHTML = `<span class="summary-team-header hidden sm:inline">${state.team2.name}</span><img src="${state.team2.logo || ''}" class="summary-team-logo">`;
            document.getElementById('summary-status-ribbon').textContent = calculateCurrentStatus();
            document.getElementById('summary-venue-date').textContent = `${toTitleCase(state.venue)} | ${new Date(state.matchDate + 'T00:00:00').toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}`;

            const scoreStripsContainer = document.getElementById('summary-score-strips');
            const panel1 = document.getElementById('panel-innings1');
            const panel2 = document.getElementById('panel-innings2');
            const motmPanel = document.getElementById('summary-motm-panel');
            scoreStripsContainer.innerHTML = '';
            panel1.innerHTML = '';
            panel2.innerHTML = '';
            motmPanel.innerHTML = '';

            const inningsOrder = [state.team1, state.team2];
            if (state.innings === 1 && state.battingTeam === 'team2') inningsOrder.reverse();
            if (state.innings === 2 && state.bowlingTeam === 'team2') inningsOrder.reverse();

            inningsOrder.forEach((teamData, index) => {
                const oversPlayed = `${teamData.overs}.${teamData.balls}`;
                const ballsBowled = teamData.overs * 6 + teamData.balls;
                const runRate = ballsBowled > 0 ? (teamData.score / (ballsBowled / 6)).toFixed(2) : '0.00';
                let targetHTML = '';
                if (index === 1 && state.target > 0) {
                    targetHTML = `<div class="target">Target: ${state.target}</div>`;
                }
                scoreStripsContainer.innerHTML += `
                    <div class="summary-score-strip">
                        <img src="${teamData.logo || ''}" class="summary-team-logo mr-3">
                        <span class="team-name">${teamData.name}</span>
                        <span class="score ml-auto">${teamData.score}/${teamData.wickets}</span>
                        <span class="overs">(${oversPlayed} Ov)</span>
                        <span class="rr">RR: ${runRate}</span>
                        ${targetHTML}
                    </div>`;
            });

            panel1.innerHTML = buildInningsCardHTML(inningsOrder[0]);
            panel2.innerHTML = (state.innings === 2 || state.winner) ? buildInningsCardHTML(inningsOrder[1]) : '<div class="summary-innings-card p-4 text-center text-gray-500">Yet to bat</div>';

            const tab1 = document.getElementById('summary-tab-innings1');
            const tab2 = document.getElementById('summary-tab-innings2');
            tab1.textContent = `${inningsOrder[0].name} Innings`;
            tab2.textContent = `${inningsOrder[1].name} Innings`;
            const tabs = [tab1, tab2];
            const panels = [panel1, panel2];
            const switchTab = (tabToActivate) => {
                tabs.forEach(tab => tab.setAttribute('aria-selected', (tab === tabToActivate).toString()));
                panels.forEach(panel => panel.hidden = (panel.id !== tabToActivate.getAttribute('aria-controls')));
            };
            tab1.onclick = () => switchTab(tab1);
            tab2.onclick = () => switchTab(tab2);
            switchTab(tab1); 

            if (state.winner && state.winner !== 'Match Tied') {
                const rankedPlayers = calculateManOfTheMatch();
                if (state.manOfTheMatch) {
                    motmPanel.innerHTML = renderFinalMoMCard(state.manOfTheMatch);
                } else if (rankedPlayers && rankedPlayers.length > 0) {
                    motmPanel.innerHTML = renderSuggestedMoMCard(rankedPlayers);
                }
            }
            
            showScreen('summary-screen');
        }

        function backToScorecard() {
            closeModal('win-modal');
            if (state.winner) {
                showScreen('app');
            } else {
                showScreen('app');
            }
        }

        function renderSuggestedMoMCard(rankedPlayers) {
            const topPlayer = rankedPlayers[0];
            return `
                <div class="mom-suggestion-card mt-4">
                    <h3 class="font-semibold text-gray-700 mb-3">Suggested Man of the Match</h3>
                    <div class="mom-player-header">
                        <img src="${topPlayer.image || ''}" class="mom-player-image" onerror="this.src='data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs='">
                        <div>
                            <p class="mom-player-name">${topPlayer.name}</p>
                            <p class="mom-player-team">${topPlayer.teamName}</p>
                        </div>
                    </div>
                    <p class="mom-player-performance">${topPlayer.performance}</p>
                    <div class="mom-suggestion-actions">
                        <button onclick="confirmSuggestedMoM()" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-md flex-grow">Confirm</button>
                        <button onclick="openMoMChoiceModal()" class="px-4 py-2 bg-gray-200 text-gray-800 font-semibold rounded-md">Choose Another</button>
                    </div>
                </div>`;
        }

        function renderFinalMoMCard(player) {
            return `
                 <div id="summary-motm-card" class="mt-4">
                    <h3>Man of the Match</h3>
                    <p class="motm-name">${player.name}</p>
                    <p class="motm-team">${player.teamName}</p>
                    <p class="motm-contribution">${player.performance}</p>
                </div>`;
        }

        function showSummaryScreen() {
            if (state.striker) savePlayerStats(state.striker, state.battingTeam);
            if (state.nonStriker) savePlayerStats(state.nonStriker, state.battingTeam);
            if (state.bowler) savePlayerStats(state.bowler, state.bowlingTeam);
            closeAllModals();

            updateMatchHeader();
            document.getElementById('summary-header-team1').innerHTML = `<img src="${state.team1.logo || ''}" class="summary-team-logo"><span class="summary-team-header hidden sm:inline">${state.team1.name}</span>`;
            document.getElementById('summary-header-team2').innerHTML = `<span class="summary-team-header hidden sm:inline">${state.team2.name}</span><img src="${state.team2.logo || ''}" class="summary-team-logo">`;
            document.getElementById('summary-status-ribbon').textContent = calculateCurrentStatus();
            document.getElementById('summary-venue-date').textContent = `${toTitleCase(state.venue)} | ${new Date(state.matchDate + 'T00:00:00').toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}`;

            const scoreStripsContainer = document.getElementById('summary-score-strips');
            const panel1 = document.getElementById('panel-innings1');
            const panel2 = document.getElementById('panel-innings2');
            const motmPanel = document.getElementById('summary-motm-panel');
            scoreStripsContainer.innerHTML = '';
            panel1.innerHTML = '';
            panel2.innerHTML = '';
            motmPanel.innerHTML = '';

            const inningsOrder = [state.team1, state.team2];
            if (state.innings === 1 && state.battingTeam === 'team2') inningsOrder.reverse();
            if (state.innings === 2 && state.bowlingTeam === 'team2') inningsOrder.reverse();

            inningsOrder.forEach((teamData, index) => {
                const oversPlayed = `${teamData.overs}.${teamData.balls}`;
                const ballsBowled = teamData.overs * 6 + teamData.balls;
                const runRate = ballsBowled > 0 ? (teamData.score / (ballsBowled / 6)).toFixed(2) : '0.00';
                let targetHTML = '';
                if (index === 1 && state.target > 0) {
                    targetHTML = `<div class="target">Target: ${state.target}</div>`;
                }
                scoreStripsContainer.innerHTML += `
                    <div class="summary-score-strip">
                        <img src="${teamData.logo || ''}" class="summary-team-logo mr-3">
                        <span class="team-name">${teamData.name}</span>
                        <span class="score ml-auto">${teamData.score}/${teamData.wickets}</span>
                        <span class="overs">(${oversPlayed} Ov)</span>
                        <span class="rr">RR: ${runRate}</span>
                        ${targetHTML}
                    </div>`;
            });

            panel1.innerHTML = buildInningsCardHTML(inningsOrder[0]);
            panel2.innerHTML = (state.innings === 2 || state.winner) ? buildInningsCardHTML(inningsOrder[1]) : '<div class="summary-innings-card p-4 text-center text-gray-500">Yet to bat</div>';

            const tab1 = document.getElementById('summary-tab-innings1');
            const tab2 = document.getElementById('summary-tab-innings2');
            tab1.textContent = `${inningsOrder[0].name} Innings`;
            tab2.textContent = `${inningsOrder[1].name} Innings`;
            const tabs = [tab1, tab2];
            const panels = [panel1, panel2];
            const switchTab = (tabToActivate) => {
                tabs.forEach(tab => tab.setAttribute('aria-selected', (tab === tabToActivate).toString()));
                panels.forEach(panel => panel.hidden = (panel.id !== tabToActivate.getAttribute('aria-controls')));
            };
            tab1.onclick = () => switchTab(tab1);
            tab2.onclick = () => switchTab(tab2);
            switchTab(tab1); 

            if (state.winner && state.winner !== 'Match Tied') {
                const rankedPlayers = calculateManOfTheMatch();
                if (state.manOfTheMatch) {
                    motmPanel.innerHTML = renderFinalMoMCard(state.manOfTheMatch);
                } else if (rankedPlayers && rankedPlayers.length > 0) {
                    motmPanel.innerHTML = renderSuggestedMoMCard(rankedPlayers);
                }
            }
            
            showScreen('summary-screen');
        }

        function backToScorecard() {
            closeModal('win-modal');
            if (state.winner) {
                showScreen('app');
            } else {
                showScreen('app');
            }
        }

        function renderSuggestedMoMCard(rankedPlayers) {
            const topPlayer = rankedPlayers[0];
            return `
                <div class="mom-suggestion-card mt-4">
                    <h3 class="font-semibold text-gray-700 mb-3">Suggested Man of the Match</h3>
                    <div class="mom-player-header">
                        <img src="${topPlayer.image || ''}" class="mom-player-image" onerror="this.src='data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs='">
                        <div>
                            <p class="mom-player-name">${topPlayer.name}</p>
                            <p class="mom-player-team">${topPlayer.teamName}</p>
                        </div>
                    </div>
                    <p class="mom-player-performance">${topPlayer.performance}</p>
                    <div class="mom-suggestion-actions">
                        <button onclick="confirmSuggestedMoM()" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-md flex-grow">Confirm</button>
                        <button onclick="openMoMChoiceModal()" class="px-4 py-2 bg-gray-200 text-gray-800 font-semibold rounded-md">Choose Another</button>
                    </div>
                </div>`;
        }

        function confirmSuggestedMoM() {
            const rankedPlayers = calculateManOfTheMatch();
            if (rankedPlayers.length > 0) {
                state.manOfTheMatch = rankedPlayers[0];
                saveCompletedMatchSummary();
                showSummaryScreen();
            }
        }

        function renderFinalMoMCard(player) {
            return `
                 <div id="summary-motm-card" class="mt-4">
                    <h3>Man of the Match</h3>
                    <p class="motm-name">${player.name}</p>
                    <p class="motm-team">${player.teamName}</p>
                    <p class="motm-contribution">${player.performance}</p>
                </div>`;
        }

        function calculateCurrentStatus() {
            if (state.result && state.result.status) {
                return generateResultSummaryLine(state.result);
            }
            
            if (state.innings === 1) {
                return `1st Innings in progress...`;
            }
            
            if (state.innings === 2) {
                const battingTeam = state[state.battingTeam];
                const runsNeeded = state.target - battingTeam.score;
                if (runsNeeded > 0) {
                    const totalBalls = state.totalOvers * 6;
                    const ballsBowled = battingTeam.overs * 6 + battingTeam.balls;
                    const ballsRemaining = totalBalls - ballsBowled;
                    return `${state[state.battingTeam].name} need ${runsNeeded} run${runsNeeded !== 1 ? 's' : ''} to win from ${ballsRemaining} ball${ballsRemaining !== 1 ? 's' : ''}.`;
                }
            }
            
            return 'Match in progress...';
        }

        function buildInningsCardHTML(teamData) {
            const battingTeamKey = teamData.name === state.team1.name ? 'team1' : 'team2';
            const bowlingTeamKey = teamData.name === state.team1.name ? 'team2' : 'team1';
            
            let battingHTML = `
                <div class="summary-table-container">
                    <table class="summary-table">
                        <thead>
                            <tr><th>BATSMEN</th><th></th><th class="text-right">R</th><th class="text-right">B</th><th class="text-right">4s</th><th class="text-right">6s</th><th class="text-right">SR</th></tr>
                        </thead>
                        <tbody>`;

            const batsmen = Object.values(state[battingTeamKey].playerStats).filter(p => p.balls > 0 || p.isOut);
            batsmen.forEach(p => {
                const sr = p.balls > 0 ? ((p.runs / p.balls) * 100).toFixed(2) : '0.00';
                battingHTML += `
                    <tr>
                        <td class="font-bold">${p.name}</td>
                        <td class="text-gray-500">${formatDismissalText(p.dismissalInfo)}</td>
                        <td class="text-right font-bold">${p.runs}</td>
                        <td class="text-right">${p.balls}</td>
                        <td class="text-right">${p.fours}</td>
                        <td class="text-right">${p.sixes}</td>
                        <td class="text-right">${sr}</td>
                    </tr>`;
            });

            const extras = state[battingTeamKey].extras;
            const extrasString = `(B ${extras.b}, LB ${extras.lb}, WD ${extras.wd}, NB ${extras.nb})`;
            battingHTML += `
                    <tr class="summary-extras-row">
                        <td colspan="2">Extras</td>
                        <td colspan="5" class="text-right">${extras.total} ${extrasString}</td>
                    </tr>
                    <tr class="summary-total-row">
                        <td colspan="2">Total</td>
                        <td colspan="5" class="text-right">${state[battingTeamKey].score}/${state[battingTeamKey].wickets} (${state[battingTeamKey].overs}.${state[battingTeamKey].balls} Overs)</td>
                    </tr>
                </tbody></table></div>`;
            
            const didNotBat = state[battingTeamKey].players.filter(pName => !batsmen.some(b => b.name === pName));
            let dnbHTML = '';
            if (didNotBat.length > 0) {
                dnbHTML = `<div class="summary-dnb-section mt-4 px-2 sm:px-0"><h4 class="font-semibold text-sm">Did not bat:</h4><p class="text-gray-600 text-sm">${didNotBat.join(', ')}</p></div>`;
            }

            const fow = state[battingTeamKey].inningsHistory
                .filter(ball => ball.dismissalInfo)
                .map(ball => {
                    const batsmanOut = Object.values(state[battingTeamKey].playerStats).find(p => p.dismissalInfo === ball.dismissalInfo);
                    return {
                        score: ball.dismissalInfo.scoreAtFall,
                        over: ball.dismissalInfo.overAtFall,
                        player: batsmanOut ? batsmanOut.name : 'Unknown'
                    };
                })
                .sort((a, b) => a.score - b.score);
                
            let fowHTML = '';
            if (fow.length > 0) {
                fowHTML = `<div class="summary-fow-section mt-4 px-2 sm:px-0">
                    <h4 class="font-semibold text-sm mb-1">Fall of Wickets</h4>
                    <p class="summary-fow-list">${fow.map((w, i) => `<span>${i+1}-${w.score} (${w.player}, ${w.over})</span>`).join('')}</p>
                </div>`;
            }

            let bowlingHTML = `<div class="summary-table-container mt-6"><table class="summary-table">
                <thead><tr><th>BOWLING</th><th class="text-right">O</th><th class="text-right">M</th><th class="text-right">R</th><th class="text-right">W</th><th class="text-right">ECON</th></tr></thead>
                <tbody>`;

            const bowlers = Object.values(state[bowlingTeamKey].playerStats).filter(p => p.ballsBowled > 0);
            bowlers.forEach(p => {
                const overs = `${Math.floor(p.ballsBowled / 6)}.${p.ballsBowled % 6}`;
                const econ = p.ballsBowled > 0 ? (p.runsConceded / (p.ballsBowled / 6)).toFixed(2) : '0.00';
                bowlingHTML += `
                    <tr>
                        <td class="font-bold">${p.name}</td>
                        <td class="text-right">${overs}</td>
                        <td class="text-right">${p.maidens}</td>
                        <td class="text-right">${p.runsConceded}</td>
                        <td class="text-right font-bold">${p.wickets}</td>
                        <td class="text-right">${econ}</td>
                    </tr>`;
            });
            bowlingHTML += `</tbody></table></div>`;

            return `<div class="summary-innings-card"><h3>${teamData.name} Innings</h3>${battingHTML}${dnbHTML}${fowHTML}${bowlingHTML}</div>`;
        }

        function showSummaryScreen() {
            if (state.striker) savePlayerStats(state.striker, state.battingTeam);
            if (state.nonStriker) savePlayerStats(state.nonStriker, state.battingTeam);
            if (state.bowler) savePlayerStats(state.bowler, state.bowlingTeam);
            closeAllModals();

            updateMatchHeader();
            document.getElementById('summary-header-team1').innerHTML = `<img src="${state.team1.logo || ''}" class="summary-team-logo"><span class="summary-team-header hidden sm:inline">${state.team1.name}</span>`;
            document.getElementById('summary-header-team2').innerHTML = `<span class="summary-team-header hidden sm:inline">${state.team2.name}</span><img src="${state.team2.logo || ''}" class="summary-team-logo">`;
            document.getElementById('summary-status-ribbon').textContent = calculateCurrentStatus();
            document.getElementById('summary-venue-date').textContent = `${toTitleCase(state.venue)} | ${new Date(state.matchDate + 'T00:00:00').toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}`;

            const scoreStripsContainer = document.getElementById('summary-score-strips');
            const panel1 = document.getElementById('panel-innings1');
            const panel2 = document.getElementById('panel-innings2');
            const motmPanel = document.getElementById('summary-motm-panel');
            scoreStripsContainer.innerHTML = '';
            panel1.innerHTML = '';
            panel2.innerHTML = '';
            motmPanel.innerHTML = '';

            const inningsOrder = [state.team1, state.team2];
            if (state.innings === 1 && state.battingTeam === 'team2') inningsOrder.reverse();
            if (state.innings === 2 && state.bowlingTeam === 'team2') inningsOrder.reverse();

            inningsOrder.forEach((teamData, index) => {
                const oversPlayed = `${teamData.overs}.${teamData.balls}`;
                const ballsBowled = teamData.overs * 6 + teamData.balls;
                const runRate = ballsBowled > 0 ? (teamData.score / (ballsBowled / 6)).toFixed(2) : '0.00';
                let targetHTML = '';
                if (index === 1 && state.target > 0) {
                    targetHTML = `<div class="target">Target: ${state.target}</div>`;
                }
                scoreStripsContainer.innerHTML += `
                    <div class="summary-score-strip">
                        <img src="${teamData.logo || ''}" class="summary-team-logo mr-3">
                        <span class="team-name">${teamData.name}</span>
                        <span class="score ml-auto">${teamData.score}/${teamData.wickets}</span>
                        <span class="overs">(${oversPlayed} Ov)</span>
                        <span class="rr">RR: ${runRate}</span>
                        ${targetHTML}
                    </div>`;
            });

            panel1.innerHTML = buildInningsCardHTML(inningsOrder[0]);
            panel2.innerHTML = (state.innings === 2 || state.winner) ? buildInningsCardHTML(inningsOrder[1]) : '<div class="summary-innings-card p-4 text-center text-gray-500">Yet to bat</div>';

            const tab1 = document.getElementById('summary-tab-innings1');
            const tab2 = document.getElementById('summary-tab-innings2');
            tab1.textContent = `${inningsOrder[0].name} Innings`;
            tab2.textContent = `${inningsOrder[1].name} Innings`;
            const tabs = [tab1, tab2];
            const panels = [panel1, panel2];
            const switchTab = (tabToActivate) => {
                tabs.forEach(tab => tab.setAttribute('aria-selected', (tab === tabToActivate).toString()));
                panels.forEach(panel => panel.hidden = (panel.id !== tabToActivate.getAttribute('aria-controls')));
            };
            tab1.onclick = () => switchTab(tab1);
            tab2.onclick = () => switchTab(tab2);
            switchTab(tab1); 

            if (state.winner && state.winner !== 'Match Tied') {
                const rankedPlayers = calculateManOfTheMatch();
                if (state.manOfTheMatch) {
                    motmPanel.innerHTML = renderFinalMoMCard(state.manOfTheMatch);
                } else if (rankedPlayers && rankedPlayers.length > 0) {
                    motmPanel.innerHTML = renderSuggestedMoMCard(rankedPlayers);
                }
            }
            
            showScreen('summary-screen');
        }

        function backToScorecard() {
            closeModal('win-modal');
            if (state.winner) {
                showScreen('app');
            } else {
                showScreen('app');
            }
        }

        function renderSuggestedMoMCard(rankedPlayers) {
            const topPlayer = rankedPlayers[0];
            return `
                <div class="mom-suggestion-card mt-4">
                    <h3 class="font-semibold text-gray-700 mb-3">Suggested Man of the Match</h3>
                    <div class="mom-player-header">
                        <img src="${topPlayer.image || ''}" class="mom-player-image" onerror="this.src='data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs='">
                        <div>
                            <p class="mom-player-name">${topPlayer.name}</p>
                            <p class="mom-player-team">${topPlayer.teamName}</p>
                        </div>
                    </div>
                    <p class="mom-player-performance">${topPlayer.performance}</p>
                    <div class="mom-suggestion-actions">
                        <button onclick="confirmSuggestedMoM()" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-md flex-grow">Confirm</button>
                        <button onclick="openMoMChoiceModal()" class="px-4 py-2 bg-gray-200 text-gray-800 font-semibold rounded-md">Choose Another</button>
                    </div>
                </div>`;
        }

        function confirmSuggestedMoM() {
            const rankedPlayers = calculateManOfTheMatch();
            if (rankedPlayers.length > 0) {
                state.manOfTheMatch = rankedPlayers[0];
                saveCompletedMatchSummary();
                showSummaryScreen();
            }
        }

        function renderFinalMoMCard(player) {
            return `
                 <div id="summary-motm-card" class="mt-4">
                    <h3>Man of the Match</h3>
                    <p class="motm-name">${player.name}</p>
                    <p class="motm-team">${player.teamName}</p>
                    <p class="motm-contribution">${player.performance}</p>
                </div>`;
        }

        function calculateCurrentStatus() {
            if (state.result && state.result.status) {
                return generateResultSummaryLine(state.result);
            }
            
            if (state.innings === 1) {
                return `1st Innings in progress...`;
            }
            
            if (state.innings === 2) {
                const battingTeam = state[state.battingTeam];
                const runsNeeded = state.target - battingTeam.score;
                if (runsNeeded > 0) {
                    const totalBalls = state.totalOvers * 6;
                    const ballsBowled = battingTeam.overs * 6 + battingTeam.balls;
                    const ballsRemaining = totalBalls - ballsBowled;
                    return `${state[state.battingTeam].name} need ${runsNeeded} run${runsNeeded !== 1 ? 's' : ''} to win from ${ballsRemaining} ball${ballsRemaining !== 1 ? 's' : ''}.`;
                }
            }
            
            return 'Match in progress...';
        }

        function buildInningsCardHTML(teamData) {
            const battingTeamKey = teamData.name === state.team1.name ? 'team1' : 'team2';
            const bowlingTeamKey = teamData.name === state.team1.name ? 'team2' : 'team1';
            
            let battingHTML = `
                <div class="summary-table-container">
                    <table class="summary-table">
                        <thead>
                            <tr><th>BATSMEN</th><th></th><th class="text-right">R</th><th class="text-right">B</th><th class="text-right">4s</th><th class="text-right">6s</th><th class="text-right">SR</th></tr>
                        </thead>
                        <tbody>`;

            const batsmen = Object.values(state[battingTeamKey].playerStats).filter(p => p.balls > 0 || p.isOut);
            batsmen.forEach(p => {
                const sr = p.balls > 0 ? ((p.runs / p.balls) * 100).toFixed(2) : '0.00';
                battingHTML += `
                    <tr>
                        <td class="font-bold">${p.name}</td>
                        <td class="text-gray-500">${formatDismissalText(p.dismissalInfo)}</td>
                        <td class="text-right font-bold">${p.runs}</td>
                        <td class="text-right">${p.balls}</td>
                        <td class="text-right">${p.fours}</td>
                        <td class="text-right">${p.sixes}</td>
                        <td class="text-right">${sr}</td>
                    </tr>`;
            });

            const extras = state[battingTeamKey].extras;
            const extrasString = `(B ${extras.b}, LB ${extras.lb}, WD ${extras.wd}, NB ${extras.nb})`;
            battingHTML += `
                    <tr class="summary-extras-row">
                        <td colspan="2">Extras</td>
                        <td colspan="5" class="text-right">${extras.total} ${extrasString}</td>
                    </tr>
                    <tr class="summary-total-row">
                        <td colspan="2">Total</td>
                        <td colspan="5" class="text-right">${state[battingTeamKey].score}/${state[battingTeamKey].wickets} (${state[battingTeamKey].overs}.${state[battingTeamKey].balls} Overs)</td>
                    </tr>
                </tbody></table></div>`;
            
            const didNotBat = state[battingTeamKey].players.filter(pName => !batsmen.some(b => b.name === pName));
            let dnbHTML = '';
            if (didNotBat.length > 0) {
                dnbHTML = `<div class="summary-dnb-section mt-4 px-2 sm:px-0"><h4 class="font-semibold text-sm">Did not bat:</h4><p class="text-gray-600 text-sm">${didNotBat.join(', ')}</p></div>`;
            }

            const fow = state[battingTeamKey].inningsHistory
                .filter(ball => ball.dismissalInfo)
                .map(ball => {
                    const batsmanOut = Object.values(state[battingTeamKey].playerStats).find(p => p.dismissalInfo === ball.dismissalInfo);
                    return {
                        score: ball.dismissalInfo.scoreAtFall,
                        over: ball.dismissalInfo.overAtFall,
                        player: batsmanOut ? batsmanOut.name : 'Unknown'
                    };
                })
                .sort((a, b) => a.score - b.score);
                
            let fowHTML = '';
            if (fow.length > 0) {
                fowHTML = `<div class="summary-fow-section mt-4 px-2 sm:px-0">
                    <h4 class="font-semibold text-sm mb-1">Fall of Wickets</h4>
                    <p class="summary-fow-list">${fow.map((w, i) => `<span>${i+1}-${w.score} (${w.player}, ${w.over})</span>`).join('')}</p>
                </div>`;
            }

            let bowlingHTML = `<div class="summary-table-container mt-6"><table class="summary-table">
                <thead><tr><th>BOWLING</th><th class="text-right">O</th><th class="text-right">M</th><th class="text-right">R</th><th class="text-right">W</th><th class="text-right">ECON</th></tr></thead>
                <tbody>`;

            const bowlers = Object.values(state[bowlingTeamKey].playerStats).filter(p => p.ballsBowled > 0);
            bowlers.forEach(p => {
                const overs = `${Math.floor(p.ballsBowled / 6)}.${p.ballsBowled % 6}`;
                const econ = p.ballsBowled > 0 ? (p.runsConceded / (p.ballsBowled / 6)).toFixed(2) : '0.00';
                bowlingHTML += `
                    <tr>
                        <td class="font-bold">${p.name}</td>
                        <td class="text-right">${overs}</td>
                        <td class="text-right">${p.maidens}</td>
                        <td class="text-right">${p.runsConceded}</td>
                        <td class="text-right font-bold">${p.wickets}</td>
                        <td class="text-right">${econ}</td>
                    </tr>`;
            });
            bowlingHTML += `</tbody></table></div>`;

            return `<div class="summary-innings-card"><h3>${teamData.name} Innings</h3>${battingHTML}${dnbHTML}${fowHTML}${bowlingHTML}</div>`;
        }

        function showSummaryScreen() {
            if (state.striker) savePlayerStats(state.striker, state.battingTeam);
            if (state.nonStriker) savePlayerStats(state.nonStriker, state.battingTeam);
            if (state.bowler) savePlayerStats(state.bowler, state.bowlingTeam);
            closeAllModals();

            updateMatchHeader();
            document.getElementById('summary-header-team1').innerHTML = `<img src="${state.team1.logo || ''}" class="summary-team-logo"><span class="summary-team-header hidden sm:inline">${state.team1.name}</span>`;
            document.getElementById('summary-header-team2').innerHTML = `<span class="summary-team-header hidden sm:inline">${state.team2.name}</span><img src="${state.team2.logo || ''}" class="summary-team-logo">`;
            document.getElementById('summary-status-ribbon').textContent = calculateCurrentStatus();
            document.getElementById('summary-venue-date').textContent = `${toTitleCase(state.venue)} | ${new Date(state.matchDate + 'T00:00:00').toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}`;

            const scoreStripsContainer = document.getElementById('summary-score-strips');
            const panel1 = document.getElementById('panel-innings1');
            const panel2 = document.getElementById('panel-innings2');
            const motmPanel = document.getElementById('summary-motm-panel');
            scoreStripsContainer.innerHTML = '';
            panel1.innerHTML = '';
            panel2.innerHTML = '';
            motmPanel.innerHTML = '';

            const inningsOrder = [state.team1, state.team2];
            if (state.innings === 1 && state.battingTeam === 'team2') inningsOrder.reverse();
            if (state.innings === 2 && state.bowlingTeam === 'team2') inningsOrder.reverse();

            inningsOrder.forEach((teamData, index) => {
                const oversPlayed = `${teamData.overs}.${teamData.balls}`;
                const ballsBowled = teamData.overs * 6 + teamData.balls;
                const runRate = ballsBowled > 0 ? (teamData.score / (ballsBowled / 6)).toFixed(2) : '0.00';
                let targetHTML = '';
                if (index === 1 && state.target > 0) {
                    targetHTML = `<div class="target">Target: ${state.target}</div>`;
                }
                scoreStripsContainer.innerHTML += `
                    <div class="summary-score-strip">
                        <img src="${teamData.logo || ''}" class="summary-team-logo mr-3">
                        <span class="team-name">${teamData.name}</span>
                        <span class="score ml-auto">${teamData.score}/${teamData.wickets}</span>
                        <span class="overs">(${oversPlayed} Ov)</span>
                        <span class="rr">RR: ${runRate}</span>
                        ${targetHTML}
                    </div>`;
            });

            panel1.innerHTML = buildInningsCardHTML(inningsOrder[0]);
            panel2.innerHTML = (state.innings === 2 || state.winner) ? buildInningsCardHTML(inningsOrder[1]) : '<div class="summary-innings-card p-4 text-center text-gray-500">Yet to bat</div>';

            const tab1 = document.getElementById('summary-tab-innings1');
            const tab2 = document.getElementById('summary-tab-innings2');
            tab1.textContent = `${inningsOrder[0].name} Innings`;
            tab2.textContent = `${inningsOrder[1].name} Innings`;
            const tabs = [tab1, tab2];
            const panels = [panel1, panel2];
            const switchTab = (tabToActivate) => {
                tabs.forEach(tab => tab.setAttribute('aria-selected', (tab === tabToActivate).toString()));
                panels.forEach(panel => panel.hidden = (panel.id !== tabToActivate.getAttribute('aria-controls')));
            };
            tab1.onclick = () => switchTab(tab1);
            tab2.onclick = () => switchTab(tab2);
            switchTab(tab1); 

            if (state.winner && state.winner !== 'Match Tied') {
                const rankedPlayers = calculateManOfTheMatch();
                if (state.manOfTheMatch) {
                    motmPanel.innerHTML = renderFinalMoMCard(state.manOfTheMatch);
                } else if (rankedPlayers && rankedPlayers.length > 0) {
                    motmPanel.innerHTML = renderSuggestedMoMCard(rankedPlayers);
                }
            }
            
            showScreen('summary-screen');
        }

        function backToScorecard() {
            closeModal('win-modal');
            if (state.winner) {
                showScreen('app');
            } else {
                showScreen('app');
            }
        }

        function renderSuggestedMoMCard(rankedPlayers) {
            const topPlayer = rankedPlayers[0];
            return `
                <div class="mom-suggestion-card mt-4">
                    <h3 class="font-semibold text-gray-700 mb-3">Suggested Man of the Match</h3>
                    <div class="mom-player-header">
                        <img src="${topPlayer.image || ''}" class="mom-player-image" onerror="this.src='data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs='">
                        <div>
                            <p class="mom-player-name">${topPlayer.name}</p>
                            <p class="mom-player-team">${topPlayer.teamName}</p>
                        </div>
                    </div>
                    <p class="mom-player-performance">${topPlayer.performance}</p>
                    <div class="mom-suggestion-actions">
                        <button onclick="confirmSuggestedMoM()" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-md flex-grow">Confirm</button>
                        <button onclick="openMoMChoiceModal()" class="px-4 py-2 bg-gray-200 text-gray-800 font-semibold rounded-md">Choose Another</button>
                    </div>
                </div>`;
        }

        function confirmSuggestedMoM() {
            const rankedPlayers = calculateManOfTheMatch();
            if (rankedPlayers.length > 0) {
                state.manOfTheMatch = rankedPlayers[0];
                saveCompletedMatchSummary();
                showSummaryScreen();
            }
        }

        function renderFinalMoMCard(player) {
            return `
                 <div id="summary-motm-card" class="mt-4">
                    <h3>Man of the Match</h3>
                    <p class="motm-name">${player.name}</p>
                    <p class="motm-team">${player.teamName}</p>
                    <p class="motm-contribution">${player.performance}</p>
                </div>`;
        }

        function calculateCurrentStatus() {
            if (state.result && state.result.status) {
                return generateResultSummaryLine(state.result);
            }
            
            if (state.innings === 1) {
                return `1st Innings in progress...`;
            }
            
            if (state.innings === 2) {
                const battingTeam = state[state.battingTeam];
                const runsNeeded = state.target - battingTeam.score;
                if (runsNeeded > 0) {
                    const totalBalls = state.totalOvers * 6;
                    const ballsBowled = battingTeam.overs * 6 + battingTeam.balls;
                    const ballsRemaining = totalBalls - ballsBowled;
                    return `${state[state.battingTeam].name} need ${runsNeeded} run${runsNeeded !== 1 ? 's' : ''} to win from ${ballsRemaining} ball${ballsRemaining !== 1 ? 's' : ''}.`;
                }
            }
            
            return 'Match in progress...';
        }

        function buildInningsCardHTML(teamData) {
            const battingTeamKey = teamData.name === state.team1.name ? 'team1' : 'team2';
            const bowlingTeamKey = teamData.name === state.team1.name ? 'team2' : 'team1';
            
            let battingHTML = `
                <div class="summary-table-container">
                    <table class="summary-table">
                        <thead>
                            <tr><th>BATSMEN</th><th></th><th class="text-right">R</th><th class="text-right">B</th><th class="text-right">4s</th><th class="text-right">6s</th><th class="text-right">SR</th></tr>
                        </thead>
                        <tbody>`;

            const batsmen = Object.values(state[battingTeamKey].playerStats).filter(p => p.balls > 0 || p.isOut);
            batsmen.forEach(p => {
                const sr = p.balls > 0 ? ((p.runs / p.balls) * 100).toFixed(2) : '0.00';
                battingHTML += `
                    <tr>
                        <td class="font-bold">${p.name}</td>
                        <td class="text-gray-500">${formatDismissalText(p.dismissalInfo)}</td>
                        <td class="text-right font-bold">${p.runs}</td>
                        <td class="text-right">${p.balls}</td>
                        <td class="text-right">${p.fours}</td>
                        <td class="text-right">${p.sixes}</td>
                        <td class="text-right">${sr}</td>
                    </tr>`;
            });

            const extras = state[battingTeamKey].extras;
            const extrasString = `(B ${extras.b}, LB ${extras.lb}, WD ${extras.wd}, NB ${extras.nb})`;
            battingHTML += `
                    <tr class="summary-extras-row">
                        <td colspan="2">Extras</td>
                        <td colspan="5" class="text-right">${extras.total} ${extrasString}</td>
                    </tr>
                    <tr class="summary-total-row">
                        <td colspan="2">Total</td>
                        <td colspan="5" class="text-right">${state[battingTeamKey].score}/${state[battingTeamKey].wickets} (${state[battingTeamKey].overs}.${state[battingTeamKey].balls} Overs)</td>
                    </tr>
                </tbody></table></div>`;
            
            const didNotBat = state[battingTeamKey].players.filter(pName => !batsmen.some(b => b.name === pName));
            let dnbHTML = '';
            if (didNotBat.length > 0) {
                dnbHTML = `<div class="summary-dnb-section mt-4 px-2 sm:px-0"><h4 class="font-semibold text-sm">Did not bat:</h4><p class="text-gray-600 text-sm">${didNotBat.join(', ')}</p></div>`;
            }

            const fow = state[battingTeamKey].inningsHistory
                .filter(ball => ball.dismissalInfo)
                .map(ball => {
                    const batsmanOut = Object.values(state[battingTeamKey].playerStats).find(p => p.dismissalInfo === ball.dismissalInfo);
                    return {
                        score: ball.dismissalInfo.scoreAtFall,
                        over: ball.dismissalInfo.overAtFall,
                        player: batsmanOut ? batsmanOut.name : 'Unknown'
                    };
                })
                .sort((a, b) => a.score - b.score);
                
            let fowHTML = '';
            if (fow.length > 0) {
                fowHTML = `<div class="summary-fow-section mt-4 px-2 sm:px-0">
                    <h4 class="font-semibold text-sm mb-1">Fall of Wickets</h4>
                    <p class="summary-fow-list">${fow.map((w, i) => `<span>${i+1}-${w.score} (${w.player}, ${w.over})</span>`).join('')}</p>
                </div>`;
            }

            let bowlingHTML = `<div class="summary-table-container mt-6"><table class="summary-table">
                <thead><tr><th>BOWLING</th><th class="text-right">O</th><th class="text-right">M</th><th class="text-right">R</th><th class="text-right">W</th><th class="text-right">ECON</th></tr></thead>
                <tbody>`;

            const bowlers = Object.values(state[bowlingTeamKey].playerStats).filter(p => p.ballsBowled > 0);
            bowlers.forEach(p => {
                const overs = `${Math.floor(p.ballsBowled / 6)}.${p.ballsBowled % 6}`;
                const econ = p.ballsBowled > 0 ? (p.runsConceded / (p.ballsBowled / 6)).toFixed(2) : '0.00';
                bowlingHTML += `
                    <tr>
                        <td class="font-bold">${p.name}</td>
                        <td class="text-right">${overs}</td>
                        <td class="text-right">${p.maidens}</td>
                        <td class="text-right">${p.runsConceded}</td>
                        <td class="text-right font-bold">${p.wickets}</td>
                        <td class="text-right">${econ}</td>
                    </tr>`;
            });
            bowlingHTML += `</tbody></table></div>`;

            return `<div class="summary-innings-card"><h3>${teamData.name} Innings</h3>${battingHTML}${dnbHTML}${fowHTML}${bowlingHTML}</div>`;
        }

        function showSummaryScreen() {
            if (state.striker) savePlayerStats(state.striker, state.battingTeam);
            if (state.nonStriker) savePlayerStats(state.nonStriker, state.battingTeam);
            if (state.bowler) savePlayerStats(state.bowler, state.bowlingTeam);
            closeAllModals();

            updateMatchHeader();
            document.getElementById('summary-header-team1').innerHTML = `<img src="${state.team1.logo || ''}" class="summary-team-logo"><span class="summary-team-header hidden sm:inline">${state.team1.name}</span>`;
            document.getElementById('summary-header-team2').innerHTML = `<span class="summary-team-header hidden sm:inline">${state.team2.name}</span><img src="${state.team2.logo || ''}" class="summary-team-logo">`;
            document.getElementById('summary-status-ribbon').textContent = calculateCurrentStatus();
            document.getElementById('summary-venue-date').textContent = `${toTitleCase(state.venue)} | ${new Date(state.matchDate + 'T00:00:00').toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}`;

            const scoreStripsContainer = document.getElementById('summary-score-strips');
            const panel1 = document.getElementById('panel-innings1');
            const panel2 = document.getElementById('panel-innings2');
            const motmPanel = document.getElementById('summary-motm-panel');
            scoreStripsContainer.innerHTML = '';
            panel1.innerHTML = '';
            panel2.innerHTML = '';
            motmPanel.innerHTML = '';

            const inningsOrder = [state.team1, state.team2];
            if (state.innings === 1 && state.battingTeam === 'team2') inningsOrder.reverse();
            if (state.innings === 2 && state.bowlingTeam === 'team2') inningsOrder.reverse();

            inningsOrder.forEach((teamData, index) => {
                const oversPlayed = `${teamData.overs}.${teamData.balls}`;
                const ballsBowled = teamData.overs * 6 + teamData.balls;
                const runRate = ballsBowled > 0 ? (teamData.score / (ballsBowled / 6)).toFixed(2) : '0.00';
                let targetHTML = '';
                if (index === 1 && state.target > 0) {
                    targetHTML = `<div class="target">Target: ${state.target}</div>`;
                }
                scoreStripsContainer.innerHTML += `
                    <div class="summary-score-strip">
                        <img src="${teamData.logo || ''}" class="summary-team-logo mr-3">
                        <span class="team-name">${teamData.name}</span>
                        <span class="score ml-auto">${teamData.score}/${teamData.wickets}</span>
                        <span class="overs">(${oversPlayed} Ov)</span>
                        <span class="rr">RR: ${runRate}</span>
                        ${targetHTML}
                    </div>`;
            });

            panel1.innerHTML = buildInningsCardHTML(inningsOrder[0]);
            panel2.innerHTML = (state.innings === 2 || state.winner) ? buildInningsCardHTML(inningsOrder[1]) : '<div class="summary-innings-card p-4 text-center text-gray-500">Yet to bat</div>';

            const tab1 = document.getElementById('summary-tab-innings1');
            const tab2 = document.getElementById('summary-tab-innings2');
            tab1.textContent = `${inningsOrder[0].name} Innings`;
            tab2.textContent = `${inningsOrder[1].name} Innings`;
            const tabs = [tab1, tab2];
            const panels = [panel1, panel2];
            const switchTab = (tabToActivate) => {
                tabs.forEach(tab => tab.setAttribute('aria-selected', (tab === tabToActivate).toString()));
                panels.forEach(panel => panel.hidden = (panel.id !== tabToActivate.getAttribute('aria-controls')));
            };
            tab1.onclick = () => switchTab(tab1);
            tab2.onclick = () => switchTab(tab2);
            switchTab(tab1); 

            if (state.winner && state.winner !== 'Match Tied') {
                const rankedPlayers = calculateManOfTheMatch();
                if (state.manOfTheMatch) {
                    motmPanel.innerHTML = renderFinalMoMCard(state.manOfTheMatch);
                } else if (rankedPlayers && rankedPlayers.length > 0) {
                    motmPanel.innerHTML = renderSuggestedMoMCard(rankedPlayers);
                }
            }
            
            showScreen('summary-screen');
        }

        function backToScorecard() {
            closeModal('win-modal'); // Explicitly close the win modal
            if (state.winner) {
                // Now that the modal is closed, just show the app screen.
                // The win state is already handled on the main screen.
                showScreen('app');
            } else {
                showScreen('app');
            }
        }

        function renderSuggestedMoMCard(rankedPlayers) {
            const topPlayer = rankedPlayers[0];
            return `
                <div class="mom-suggestion-card mt-4">
                    <h3 class="font-semibold text-gray-700 mb-3">Suggested Man of the Match</h3>
                    <div class="mom-player-header">
                        <img src="${topPlayer.image || ''}" class="mom-player-image" onerror="this.src='data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs='">
                        <div>
                            <p class="mom-player-name">${topPlayer.name}</p>
                            <p class="mom-player-team">${topPlayer.teamName}</p>
                        </div>
                    </div>
                    <p class="mom-player-performance">${topPlayer.performance}</p>
                    <div class="mom-suggestion-actions">
                        <button onclick="confirmSuggestedMoM()" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-md flex-grow">Confirm</button>
                        <button onclick="openMoMChoiceModal()" class="px-4 py-2 bg-gray-200 text-gray-800 font-semibold rounded-md">Choose Another</button>
                    </div>
                </div>`;
        }

        function confirmSuggestedMoM() {
            const rankedPlayers = calculateManOfTheMatch();
            if (rankedPlayers.length > 0) {
                state.manOfTheMatch = rankedPlayers[0];
                saveCompletedMatchSummary();
                showSummaryScreen(); // Re-render the summary screen with the final card
            }
        }

        function renderFinalMoMCard(player) {
            return `
                 <div id="summary-motm-card" class="mt-4">
                    <h3>Man of the Match</h3>
                    <p class="motm-name">${player.name}</p>
                    <p class="motm-team">${player.teamName}</p>
                    <p class="motm-contribution">${player.performance}</p>
                </div>`;
        }

        function calculateCurrentStatus() {
            if (state.result && state.result.status) {
                return generateResultSummaryLine(state.result);
            }
            
            if (state.innings === 1) {
                return `1st Innings in progress...`;
            }
            
            if (state.innings === 2) {
                const battingTeam = state[state.battingTeam];
                const runsNeeded = state.target - battingTeam.score;
                if (runsNeeded > 0) {
                    const totalBalls = state.totalOvers * 6;
                    const ballsBowled = battingTeam.overs * 6 + battingTeam.balls;
                    const ballsRemaining = totalBalls - ballsBowled;
                    return `${state[state.battingTeam].name} need ${runsNeeded} run${runsNeeded !== 1 ? 's' : ''} to win from ${ballsRemaining} ball${ballsRemaining !== 1 ? 's' : ''}.`;
                }
            }
            
            return 'Match in progress...';
        }

        function buildInningsCardHTML(teamData) {
            const battingTeamKey = teamData.name === state.team1.name ? 'team1' : 'team2';
            const bowlingTeamKey = teamData.name === state.team1.name ? 'team2' : 'team1';
            
            let battingHTML = `
                <div class="summary-table-container">
                    <table class="summary-table">
                        <thead>
                            <tr><th>BATSMEN</th><th></th><th class="text-right">R</th><th class="text-right">B</th><th class="text-right">4s</th><th class="text-right">6s</th><th class="text-right">SR</th></tr>
                        </thead>
                        <tbody>`;

            const batsmen = Object.values(state[battingTeamKey].playerStats).filter(p => p.balls > 0 || p.isOut);
            batsmen.forEach(p => {
                const sr = p.balls > 0 ? ((p.runs / p.balls) * 100).toFixed(2) : '0.00';
                battingHTML += `
                    <tr>
                        <td class="font-bold">${p.name}</td>
                        <td class="text-gray-500">${formatDismissalText(p.dismissalInfo)}</td>
                        <td class="text-right font-bold">${p.runs}</td>
                        <td class="text-right">${p.balls}</td>
                        <td class="text-right">${p.fours}</td>
                        <td class="text-right">${p.sixes}</td>
                        <td class="text-right">${sr}</td>
                    </tr>`;
            });

            const extras = state[battingTeamKey].extras;
            const extrasString = `(B ${extras.b}, LB ${extras.lb}, WD ${extras.wd}, NB ${extras.nb})`;
            battingHTML += `
                    <tr class="summary-extras-row">
                        <td colspan="2">Extras</td>
                        <td colspan="5" class="text-right">${extras.total} ${extrasString}</td>
                    </tr>
                    <tr class="summary-total-row">
                        <td colspan="2">Total</td>
                        <td colspan="5" class="text-right">${state[battingTeamKey].score}/${state[battingTeamKey].wickets} (${state[battingTeamKey].overs}.${state[battingTeamKey].balls} Overs)</td>
                    </tr>
                </tbody></table></div>`;
            
            const didNotBat = state[battingTeamKey].players.filter(pName => !batsmen.some(b => b.name === pName));
            let dnbHTML = '';
            if (didNotBat.length > 0) {
                dnbHTML = `<div class="summary-dnb-section mt-4 px-2 sm:px-0"><h4 class="font-semibold text-sm">Did not bat:</h4><p class="text-gray-600 text-sm">${didNotBat.join(', ')}</p></div>`;
            }

            const fow = state[battingTeamKey].inningsHistory
                .filter(ball => ball.dismissalInfo)
                .map(ball => {
                    const batsmanOut = Object.values(state[battingTeamKey].playerStats).find(p => p.dismissalInfo === ball.dismissalInfo);
                    return {
                        score: ball.dismissalInfo.scoreAtFall,
                        over: ball.dismissalInfo.overAtFall,
                        player: batsmanOut ? batsmanOut.name : 'Unknown'
                    };
                })
                .sort((a, b) => a.score - b.score);
                
            let fowHTML = '';
            if (fow.length > 0) {
                fowHTML = `<div class="summary-fow-section mt-4 px-2 sm:px-0">
                    <h4 class="font-semibold text-sm mb-1">Fall of Wickets</h4>
                    <p class="summary-fow-list">${fow.map((w, i) => `<span>${i+1}-${w.score} (${w.player}, ${w.over})</span>`).join('')}</p>
                </div>`;
            }

            let bowlingHTML = `<div class="summary-table-container mt-6"><table class="summary-table">
                <thead><tr><th>BOWLING</th><th class="text-right">O</th><th class="text-right">M</th><th class="text-right">R</th><th class="text-right">W</th><th class="text-right">ECON</th></tr></thead>
                <tbody>`;

            const bowlers = Object.values(state[bowlingTeamKey].playerStats).filter(p => p.ballsBowled > 0);
            bowlers.forEach(p => {
                const overs = `${Math.floor(p.ballsBowled / 6)}.${p.ballsBowled % 6}`;
                const econ = p.ballsBowled > 0 ? (p.runsConceded / (p.ballsBowled / 6)).toFixed(2) : '0.00';
                bowlingHTML += `
                    <tr>
                        <td class="font-bold">${p.name}</td>
                        <td class="text-right">${overs}</td>
                        <td class="text-right">${p.maidens}</td>
                        <td class="text-right">${p.runsConceded}</td>
                        <td class="text-right font-bold">${p.wickets}</td>
                        <td class="text-right">${econ}</td>
                    </tr>`;
            });
            bowlingHTML += `</tbody></table></div>`;

            return `<div class="summary-innings-card"><h3>${teamData.name} Innings</h3>${battingHTML}${dnbHTML}${fowHTML}${bowlingHTML}</div>`;
        }

        function calculateCurrentStatus() {
            if (state.result && state.result.status) {
                return generateResultSummaryLine(state.result);
            }
            
            if (state.innings === 1) {
                return `1st Innings in progress...`;
            }
            
            if (state.innings === 2) {
                const battingTeam = state[state.battingTeam];
                const runsNeeded = state.target - battingTeam.score;
                if (runsNeeded > 0) {
                    const totalBalls = state.totalOvers * 6;
                    const ballsBowled = battingTeam.overs * 6 + battingTeam.balls;
                    const ballsRemaining = totalBalls - ballsBowled;
                    return `${state[state.battingTeam].name} need ${runsNeeded} run${runsNeeded !== 1 ? 's' : ''} to win from ${ballsRemaining} ball${ballsRemaining !== 1 ? 's' : ''}.`;
                }
            }
            
            return 'Match in progress...';
        }

        function buildInningsCardHTML(teamData) {
            const battingTeamKey = teamData.name === state.team1.name ? 'team1' : 'team2';
            const bowlingTeamKey = teamData.name === state.team1.name ? 'team2' : 'team1';
            
            // Batting Table
            let battingHTML = `
                <div class="summary-table-container">
                    <table class="summary-table">
                        <thead>
                            <tr><th>BATSMEN</th><th></th><th class="text-right">R</th><th class="text-right">B</th><th class="text-right">4s</th><th class="text-right">6s</th><th class="text-right">SR</th></tr>
                        </thead>
                        <tbody>`;

            const batsmen = Object.values(state[battingTeamKey].playerStats).filter(p => p.balls > 0 || p.isOut);
            batsmen.forEach(p => {
                const sr = p.balls > 0 ? ((p.runs / p.balls) * 100).toFixed(2) : '0.00';
                battingHTML += `
                    <tr>
                        <td class="font-bold">${p.name}</td>
                        <td class="text-gray-500">${formatDismissalText(p.dismissalInfo)}</td>
                        <td class="text-right font-bold">${p.runs}</td>
                        <td class="text-right">${p.balls}</td>
                        <td class="text-right">${p.fours}</td>
                        <td class="text-right">${p.sixes}</td>
                        <td class="text-right">${sr}</td>
                    </tr>`;
            });

            // Extras and Total
            const extras = state[battingTeamKey].extras;
            const extrasString = `(B ${extras.b}, LB ${extras.lb}, WD ${extras.wd}, NB ${extras.nb})`;
            battingHTML += `
                    <tr class="summary-extras-row">
                        <td colspan="2">Extras</td>
                        <td colspan="5" class="text-right">${extras.total} ${extrasString}</td>
                    </tr>
                    <tr class="summary-total-row">
                        <td colspan="2">Total</td>
                        <td colspan="5" class="text-right">${state[battingTeamKey].score}/${state[battingTeamKey].wickets} (${state[battingTeamKey].overs}.${state[battingTeamKey].balls} Overs)</td>
                    </tr>
                </tbody></table></div>`;
            
            // Did Not Bat
            // Get player *objects* from the 'players' array (which now holds objects)
            const allPlayingPlayers = state[battingTeamKey].players; 
            // Filter out players who batted (present in the 'batsmen' array by name)
            const didNotBatPlayers = allPlayingPlayers.filter(playerObj => 
                !batsmen.some(batsman => batsman.playerId === playerObj.id)
            );
            
            let dnbHTML = '';
            if (didNotBatPlayers.length > 0) {
                 // Map the player objects to their names and join
                const didNotBatNames = didNotBatPlayers.map(player => player.name).join(', ');
                dnbHTML = `<div class="summary-dnb-section mt-4 px-2 sm:px-0"><h4 class="font-semibold text-sm">Did not bat:</h4><p class="text-gray-600 text-sm">${didNotBatNames}</p></div>`;
            }

            // Fall of Wickets
            const fow = state[battingTeamKey].inningsHistory
                .filter(ball => ball.dismissalInfo)
                .map(ball => {
                    const batsmanOut = Object.values(state[battingTeamKey].playerStats).find(p => p.dismissalInfo === ball.dismissalInfo);
                    return {
                        score: ball.dismissalInfo.scoreAtFall,
                        over: ball.dismissalInfo.overAtFall,
                        player: batsmanOut ? batsmanOut.name : 'Unknown'
                    };
                })
                .sort((a, b) => a.score - b.score);
                
            let fowHTML = '';
            if (fow.length > 0) {
                fowHTML = `<div class="summary-fow-section mt-4 px-2 sm:px-0">
                    <h4 class="font-semibold text-sm mb-1">Fall of Wickets</h4>
                    <p class="summary-fow-list">${fow.map((w, i) => `<span>${i+1}-${w.score} (${w.player}, ${w.over})</span>`).join('')}</p>
                </div>`;
            }

            // Bowling Table
            let bowlingHTML = `<div class="summary-table-container mt-6"><table class="summary-table">
                <thead><tr><th>BOWLING</th><th class="text-right">O</th><th class="text-right">M</th><th class="text-right">R</th><th class="text-right">W</th><th class="text-right">ECON</th></tr></thead>
                <tbody>`;

            const bowlers = Object.values(state[bowlingTeamKey].playerStats).filter(p => p.ballsBowled > 0);
            bowlers.forEach(p => {
                const overs = `${Math.floor(p.ballsBowled / 6)}.${p.ballsBowled % 6}`;
                const econ = p.ballsBowled > 0 ? (p.runsConceded / (p.ballsBowled / 6)).toFixed(2) : '0.00';
                bowlingHTML += `
                    <tr>
                        <td class="font-bold">${p.name}</td>
                        <td class="text-right">${overs}</td>
                        <td class="text-right">${p.maidens}</td>
                        <td class="text-right">${p.runsConceded}</td>
                        <td class="text-right font-bold">${p.wickets}</td>
                        <td class="text-right">${econ}</td>
                    </tr>`;
            });
            bowlingHTML += `</tbody></table></div>`;

            return `<div class="summary-innings-card"><h3>${teamData.name} Innings</h3>${battingHTML}${dnbHTML}${fowHTML}${bowlingHTML}</div>`;
        }
        
        function showSummaryScreen() {
            if (state.striker) savePlayerStats(state.striker, state.battingTeam);
            if (state.nonStriker) savePlayerStats(state.nonStriker, state.battingTeam);
            if (state.bowler) savePlayerStats(state.bowler, state.bowlingTeam);
            closeAllModals();

            updateMatchHeader();
            document.getElementById('summary-header-team1').innerHTML = `<img src="${state.team1.logo || ''}" class="summary-team-logo"><span class="summary-team-header hidden sm:inline">${state.team1.name}</span>`;
            document.getElementById('summary-header-team2').innerHTML = `<span class="summary-team-header hidden sm:inline">${state.team2.name}</span><img src="${state.team2.logo || ''}" class="summary-team-logo">`;
            document.getElementById('summary-status-ribbon').textContent = calculateCurrentStatus();
            document.getElementById('summary-venue-date').textContent = `${toTitleCase(state.venue)} | ${new Date(state.matchDate + 'T00:00:00').toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}`;

            const scoreStripsContainer = document.getElementById('summary-score-strips');
            const panel1 = document.getElementById('panel-innings1');
            const panel2 = document.getElementById('panel-innings2');
            const motmPanel = document.getElementById('summary-motm-panel');
            scoreStripsContainer.innerHTML = '';
            panel1.innerHTML = '';
            panel2.innerHTML = '';
            motmPanel.innerHTML = '';

            const inningsOrder = [state.team1, state.team2];
            if (state.innings === 1 && state.battingTeam === 'team2') inningsOrder.reverse();
            if (state.innings === 2 && state.bowlingTeam === 'team2') inningsOrder.reverse();

            inningsOrder.forEach((teamData, index) => {
                const oversPlayed = `${teamData.overs}.${teamData.balls}`;
                const ballsBowled = teamData.overs * 6 + teamData.balls;
                const runRate = ballsBowled > 0 ? (teamData.score / (ballsBowled / 6)).toFixed(2) : '0.00';
                let targetHTML = '';
                if (index === 1 && state.target > 0) {
                    targetHTML = `<div class="target">Target: ${state.target}</div>`;
                }
                scoreStripsContainer.innerHTML += `
                    <div class="summary-score-strip">
                        <img src="${teamData.logo || ''}" class="summary-team-logo mr-3">
                        <span class="team-name">${teamData.name}</span>
                        <span class="score ml-auto">${teamData.score}/${teamData.wickets}</span>
                        <span class="overs">(${oversPlayed} Ov)</span>
                        <span class="rr">RR: ${runRate}</span>
                        ${targetHTML}
                    </div>`;
            });

            panel1.innerHTML = buildInningsCardHTML(inningsOrder[0]);
            panel2.innerHTML = (state.innings === 2 || state.winner) ? buildInningsCardHTML(inningsOrder[1]) : '<div class="summary-innings-card p-4 text-center text-gray-500">Yet to bat</div>';

            const tab1 = document.getElementById('summary-tab-innings1');
            const tab2 = document.getElementById('summary-tab-innings2');
            tab1.textContent = `${inningsOrder[0].name} Innings`;
            tab2.textContent = `${inningsOrder[1].name} Innings`;
            const tabs = [tab1, tab2];
            const panels = [panel1, panel2];
            const switchTab = (tabToActivate) => {
                tabs.forEach(tab => tab.setAttribute('aria-selected', (tab === tabToActivate).toString()));
                panels.forEach(panel => panel.hidden = (panel.id !== tabToActivate.getAttribute('aria-controls')));
            };
            tab1.onclick = () => switchTab(tab1);
            tab2.onclick = () => switchTab(tab2);
            switchTab(tab1); 

            if (state.winner && state.winner !== 'Match Tied') {
                const rankedPlayers = calculateManOfTheMatch();
                if (state.manOfTheMatch) {
                    motmPanel.innerHTML = renderFinalMoMCard(state.manOfTheMatch);
                } else if (rankedPlayers && rankedPlayers.length > 0) {
                    motmPanel.innerHTML = renderSuggestedMoMCard(rankedPlayers);
                }
            }
            
            showScreen('summary-screen');
        }
        
        function backToScorecard() {
            closeModal('win-modal'); // Explicitly close the win modal
            if (state.winner) {
                // Now that the modal is closed, just show the app screen.
                // The win state is already handled on the main screen.
                showScreen('app');
            } else {
                showScreen('app');
            }
        }
        
        function renderSuggestedMoMCard(rankedPlayers) {
            const topPlayer = rankedPlayers[0];
            return `
                <div class="mom-suggestion-card mt-4">
                    <h3 class="font-semibold text-gray-700 mb-3">Suggested Man of the Match</h3>
                    <div class="mom-player-header">
                        <img src="${topPlayer.image || ''}" class="mom-player-image" onerror="this.src='data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs='">
                        <div>
                            <p class="mom-player-name">${topPlayer.name}</p>
                            <p class="mom-player-team">${topPlayer.teamName}</p>
                        </div>
                    </div>
                    <p class="mom-player-performance">${topPlayer.performance}</p>
                    <div class="mom-suggestion-actions">
                        <button onclick="confirmSuggestedMoM()" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-md flex-grow">Confirm</button>
                        <button onclick="openMoMChoiceModal()" class="px-4 py-2 bg-gray-200 text-gray-800 font-semibold rounded-md">Choose Another</button>
                    </div>
                </div>`;
        }

        function confirmSuggestedMoM() {
            const rankedPlayers = calculateManOfTheMatch();
            if (rankedPlayers.length > 0) {
                state.manOfTheMatch = rankedPlayers[0];
                saveCompletedMatchSummary();
                showSummaryScreen(); // Re-render the summary screen with the final card
            }
        }

        function renderFinalMoMCard(player) {
            return `
                 <div id="summary-motm-card" class="mt-4">
                    <h3>Man of the Match</h3>
                    <p class="motm-name">${player.name}</p>
                    <p class="motm-team">${player.teamName}</p>
                    <p class="motm-contribution">${player.performance}</p>
                </div>`;
        }

        function calculateCurrentStatus() {
            if (state.result && state.result.status) {
                return generateResultSummaryLine(state.result);
            }
            
            if (state.innings === 1) {
                return `1st Innings in progress...`;
            }
            
            if (state.innings === 2) {
                const battingTeam = state[state.battingTeam];
                const runsNeeded = state.target - battingTeam.score;
                if (runsNeeded > 0) {
                    const totalBalls = state.totalOvers * 6;
                    const ballsBowled = battingTeam.overs * 6 + battingTeam.balls;
                    const ballsRemaining = totalBalls - ballsBowled;
                    return `${state[state.battingTeam].name} need ${runsNeeded} run${runsNeeded !== 1 ? 's' : ''} to win from ${ballsRemaining} ball${ballsRemaining !== 1 ? 's' : ''}.`;
                }
            }
            
            return 'Match in progress...';
        }

        function buildInningsCardHTML(teamData) {
            const battingTeamKey = teamData.name === state.team1.name ? 'team1' : 'team2';
            const bowlingTeamKey = teamData.name === state.team1.name ? 'team2' : 'team1';
            
            // Batting Table
            let battingHTML = `
                <div class="summary-table-container">
                    <table class="summary-table">
                        <thead>
                            <tr><th>BATSMEN</th><th></th><th class="text-right">R</th><th class="text-right">B</th><th class="text-right">4s</th><th class="text-right">6s</th><th class="text-right">SR</th></tr>
                        </thead>
                        <tbody>`;

            const batsmen = Object.values(state[battingTeamKey].playerStats).filter(p => p.balls > 0 || p.isOut);
            batsmen.forEach(p => {
                const sr = p.balls > 0 ? ((p.runs / p.balls) * 100).toFixed(2) : '0.00';
                battingHTML += `
                    <tr>
                        <td class="font-bold">${p.name}</td>
                        <td class="text-gray-500">${formatDismissalText(p.dismissalInfo)}</td>
                        <td class="text-right font-bold">${p.runs}</td>
                        <td class="text-right">${p.balls}</td>
                        <td class="text-right">${p.fours}</td>
                        <td class="text-right">${p.sixes}</td>
                        <td class="text-right">${sr}</td>
                    </tr>`;
            });

            // Extras and Total
            const extras = state[battingTeamKey].extras;
            const extrasString = `(B ${extras.b}, LB ${extras.lb}, WD ${extras.wd}, NB ${extras.nb})`;
            battingHTML += `
                    <tr class="summary-extras-row">
                        <td colspan="2">Extras</td>
                        <td colspan="5" class="text-right">${extras.total} ${extrasString}</td>
                    </tr>
                    <tr class="summary-total-row">
                        <td colspan="2">Total</td>
                        <td colspan="5" class="text-right">${state[battingTeamKey].score}/${state[battingTeamKey].wickets} (${state[battingTeamKey].overs}.${state[battingTeamKey].balls} Overs)</td>
                    </tr>
                </tbody></table></div>`;
            
            // Did Not Bat
            // Get player *objects* from the 'players' array (which holds objects)
            const allPlayingPlayers = state[battingTeamKey].players; 
            // Filter out players who batted (present in the 'batsmen' array by ID)
            const didNotBatPlayers = allPlayingPlayers.filter(playerObj => 
                !batsmen.some(batsman => batsman.playerId === playerObj.id)
            );
            
            let dnbHTML = '';
            if (didNotBatPlayers.length > 0) {
                 // Map the player objects to their names and join
                const didNotBatNames = didNotBatPlayers.map(player => player.name).join(', ');
                dnbHTML = `<div class="summary-dnb-section mt-4 px-2 sm:px-0"><h4 class="font-semibold text-sm">Did not bat:</h4><p class="text-gray-600 text-sm">${didNotBatNames}</p></div>`;
            }

            // Fall of Wickets
            const fow = state[battingTeamKey].inningsHistory
                .filter(ball => ball.dismissalInfo)
                .map(ball => {
                    const batsmanOut = Object.values(state[battingTeamKey].playerStats).find(p => p.dismissalInfo === ball.dismissalInfo);
                    return {
                        score: ball.dismissalInfo.scoreAtFall,
                        over: ball.dismissalInfo.overAtFall,
                        player: batsmanOut ? batsmanOut.name : 'Unknown'
                    };
                })
                .sort((a, b) => a.score - b.score);
                
            let fowHTML = '';
            if (fow.length > 0) {
                fowHTML = `<div class="summary-fow-section mt-4 px-2 sm:px-0">
                    <h4 class="font-semibold text-sm mb-1">Fall of Wickets</h4>
                    <p class="summary-fow-list">${fow.map((w, i) => `<span>${i+1}-${w.score} (${w.player}, ${w.over})</span>`).join('')}</p>
                </div>`;
            }

            // Bowling Table
            let bowlingHTML = `<div class="summary-table-container mt-6"><table class="summary-table">
                <thead><tr><th>BOWLING</th><th class="text-right">O</th><th class="text-right">M</th><th class="text-right">R</th><th class="text-right">W</th><th class="text-right">ECON</th></tr></thead>
                <tbody>`;

            const bowlers = Object.values(state[bowlingTeamKey].playerStats).filter(p => p.ballsBowled > 0);
            bowlers.forEach(p => {
                const overs = `${Math.floor(p.ballsBowled / 6)}.${p.ballsBowled % 6}`;
                const econ = p.ballsBowled > 0 ? (p.runsConceded / (p.ballsBowled / 6)).toFixed(2) : '0.00';
                bowlingHTML += `
                    <tr>
                        <td class="font-bold">${p.name}</td>
                        <td class="text-right">${overs}</td>
                        <td class="text-right">${p.maidens}</td>
                        <td class="text-right">${p.runsConceded}</td>
                        <td class="text-right font-bold">${p.wickets}</td>
                        <td class="text-right">${econ}</td>
                    </tr>`;
            });
            bowlingHTML += `</tbody></table></div>`;

            return `<div class="summary-innings-card"><h3>${teamData.name} Innings</h3>${battingHTML}${dnbHTML}${fowHTML}${bowlingHTML}</div>`;
        }

        function calculateCurrentStatus() {
            if (state.result && state.result.status) {
                return generateResultSummaryLine(state.result);
            }
            
            if (state.innings === 1) {
                return `1st Innings in progress...`;
            }
            
            if (state.innings === 2) {
                const battingTeam = state[state.battingTeam];
                const runsNeeded = state.target - battingTeam.score;
                if (runsNeeded > 0) {
                    const totalBalls = state.totalOvers * 6;
                    const ballsBowled = battingTeam.overs * 6 + battingTeam.balls;
                    const ballsRemaining = totalBalls - ballsBowled;
                    return `${state[state.battingTeam].name} need ${runsNeeded} run${runsNeeded !== 1 ? 's' : ''} to win from ${ballsRemaining} ball${ballsRemaining !== 1 ? 's' : ''}.`;
                }
            }
            
            return 'Match in progress...';
        }

        function buildInningsCardHTML(teamData) {
            const battingTeamKey = teamData.name === state.team1.name ? 'team1' : 'team2';
            const bowlingTeamKey = teamData.name === state.team1.name ? 'team2' : 'team1';
            
            // Batting Table
            let battingHTML = `
                <div class="summary-table-container">
                    <table class="summary-table">
                        <thead>
                            <tr><th>BATSMEN</th><th></th><th class="text-right">R</th><th class="text-right">B</th><th class="text-right">4s</th><th class="text-right">6s</th><th class="text-right">SR</th></tr>
                        </thead>
                        <tbody>`;

            const batsmen = Object.values(state[battingTeamKey].playerStats).filter(p => p.balls > 0 || p.isOut);
            batsmen.forEach(p => {
                const sr = p.balls > 0 ? ((p.runs / p.balls) * 100).toFixed(2) : '0.00';
                battingHTML += `
                    <tr>
                        <td class="font-bold">${p.name}</td>
                        <td class="text-gray-500">${formatDismissalText(p.dismissalInfo)}</td>
                        <td class="text-right font-bold">${p.runs}</td>
                        <td class="text-right">${p.balls}</td>
                        <td class="text-right">${p.fours}</td>
                        <td class="text-right">${p.sixes}</td>
                        <td class="text-right">${sr}</td>
                    </tr>`;
            });

            // Extras and Total
            const extras = state[battingTeamKey].extras;
            const extrasString = `(B ${extras.b}, LB ${extras.lb}, WD ${extras.wd}, NB ${extras.nb})`;
            battingHTML += `
                    <tr class="summary-extras-row">
                        <td colspan="2">Extras</td>
                        <td colspan="5" class="text-right">${extras.total} ${extrasString}</td>
                    </tr>
                    <tr class="summary-total-row">
                        <td colspan="2">Total</td>
                        <td colspan="5" class="text-right">${state[battingTeamKey].score}/${state[battingTeamKey].wickets} (${state[battingTeamKey].overs}.${state[battingTeamKey].balls} Overs)</td>
                    </tr>
                </tbody></table></div>`;
            
            // Did Not Bat
            // Get player *objects* from the 'players' array (which holds objects)
            const allPlayingPlayers = state[battingTeamKey].players; 
            // Filter out players who batted (present in the 'batsmen' array by ID)
            const didNotBatPlayers = allPlayingPlayers.filter(playerObj => 
                !batsmen.some(batsman => batsman.playerId === playerObj.id)
            );
            
            let dnbHTML = '';
            if (didNotBatPlayers.length > 0) {
                 // Map the player objects to their names and join
                const didNotBatNames = didNotBatPlayers.map(player => player.name).join(', ');
                dnbHTML = `<div class="summary-dnb-section mt-4 px-2 sm:px-0"><h4 class="font-semibold text-sm">Did not bat:</h4><p class="text-gray-600 text-sm">${didNotBatNames}</p></div>`;
            }

            // Fall of Wickets
            const fow = state[battingTeamKey].inningsHistory
                .filter(ball => ball.dismissalInfo)
                .map(ball => {
                    const batsmanOut = Object.values(state[battingTeamKey].playerStats).find(p => p.dismissalInfo === ball.dismissalInfo);
                    return {
                        score: ball.dismissalInfo.scoreAtFall,
                        over: ball.dismissalInfo.overAtFall,
                        player: batsmanOut ? batsmanOut.name : 'Unknown'
                    };
                })
                .sort((a, b) => a.score - b.score);
                
            let fowHTML = '';
            if (fow.length > 0) {
                fowHTML = `<div class="summary-fow-section mt-4 px-2 sm:px-0">
                    <h4 class="font-semibold text-sm mb-1">Fall of Wickets</h4>
                    <p class="summary-fow-list">${fow.map((w, i) => `<span>${i+1}-${w.score} (${w.player}, ${w.over})</span>`).join('')}</p>
                </div>`;
            }

            // Bowling Table
            let bowlingHTML = `<div class="summary-table-container mt-6"><table class="summary-table">
                <thead><tr><th>BOWLING</th><th class="text-right">O</th><th class="text-right">M</th><th class="text-right">R</th><th class="text-right">W</th><th class="text-right">ECON</th></tr></thead>
                <tbody>`;

            const bowlers = Object.values(state[bowlingTeamKey].playerStats).filter(p => p.ballsBowled > 0);
            bowlers.forEach(p => {
                const overs = `${Math.floor(p.ballsBowled / 6)}.${p.ballsBowled % 6}`;
                const econ = p.ballsBowled > 0 ? (p.runsConceded / (p.ballsBowled / 6)).toFixed(2) : '0.00';
                bowlingHTML += `
                    <tr>
                        <td class="font-bold">${p.name}</td>
                        <td class="text-right">${overs}</td>
                        <td class="text-right">${p.maidens}</td>
                        <td class="text-right">${p.runsConceded}</td>
                        <td class="text-right font-bold">${p.wickets}</td>
                        <td class="text-right">${econ}</td>
                    </tr>`;
            });
            bowlingHTML += `</tbody></table></div>`;

            return `<div class="summary-innings-card"><h3>${teamData.name} Innings</h3>${battingHTML}${dnbHTML}${fowHTML}${bowlingHTML}</div>`;
        }
        
        // ... (some functions omitted for brevity) ...

        function openMoMChoiceModal() {
            const rankedPlayers = calculateManOfTheMatch();
            const listContainer = document.getElementById('mom-choice-list');
            listContainer.innerHTML = rankedPlayers.map(player => `
                <div class="player-rank-item">
                    <img src="${player.image || ''}" class="mom-player-image" onerror="this.src='data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs='">
                    <div>
                        <p class="font-bold">${player.name}</p>
                        <p class="text-sm text-gray-600">${player.teamName}</p>
                        <p class="text-xs text-gray-500">${player.performance}</p>
                    </div>
                    <div class="player-rank-score">${player.score.toFixed(0)}</div>
                    <button onclick="selectMoM('${player.playerId}')" class="ml-4 px-3 py-1.5 bg-blue-100 text-blue-700 text-sm font-semibold rounded-md hover:bg-blue-200">Select</button>
                </div>
            `).join('');
            openModal('mom-choice-modal');
        }

        function selectMoM(playerId) {
            const rankedPlayers = calculateManOfTheMatch();
            const chosenPlayer = rankedPlayers.find(p => p.playerId === playerId);
            if (chosenPlayer) {
                state.manOfTheMatch = chosenPlayer;
                saveCompletedMatchSummary(); // Persist
                closeModal('mom-choice-modal');
                showSummaryScreen(); // Re-render
            }
        }

        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen(); 
                }
            }
        }
        
        let editedOver = [];
        let scoreBeforeOver = 0;
        let editHistory = [];
        let editInitialStriker = null;
        let editInitialNonStriker = null;

        function shouldSwapForEvent(eventString) {
            const e = eventString.toUpperCase();
            
            // Standard runs off bat
            const simpleRuns = parseInt(e);
            if (!isNaN(simpleRuns) && simpleRuns % 2 !== 0) {
                return true;
            }

            // Extras with physically run component (e.g., WD+1, LB+3)
            if (e.includes('+')) {
                const runsTaken = parseInt(e.split('+')[1]);
                if (!isNaN(runsTaken) && runsTaken % 2 !== 0) {
                    return true;
                }
            }

            // Byes or Leg-byes without a '+' (e.g., B1, LB3)
            if ((e.startsWith('B') || e.startsWith('LB')) && !e.includes('+')) {
                const runsTaken = parseInt(e.replace('B', '').replace('LB', ''));
                 if (!isNaN(runsTaken) && runsTaken % 2 !== 0) {
                    return true;
                }
            }

            return false; // No swap for boundaries, dots, wickets, or even runs
        }

        function isLegalDelivery(eventString) {
            if (!eventString) return false;
            const e = eventString.toUpperCase();
            return !e.startsWith('WD') && !e.startsWith('NB');
        }

        function createEditablePlayerRow(player, teamKey) {
            const row = document.createElement('div');
            row.className = 'player-edit-row';

            const uploaderDiv = document.createElement('div');
            uploaderDiv.className = 'player-avatar-uploader';
            
            const placeholderImg = `data:image/svg+xml;base64,${btoa('<svg class="w-full h-full text-gray-400" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path></svg>')}`;
            const img = document.createElement('img');
            img.src = player.image || placeholderImg;
            
            const label = document.createElement('label');
            label.className = 'overlay';
            label.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>`;
            
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*';
            fileInput.onchange = (e) => {
                if (e.target.files && e.target.files[0]) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const newImageUrl = event.target.result;
                        img.src = newImageUrl;
                        player.image = newImageUrl;
                        if(state[teamKey].playerStats[player.id]) {
                            state[teamKey].playerStats[player.id].image = newImageUrl;
                        }
                        updateUI();
                        debouncedSave();
                    };
                    reader.readAsDataURL(e.target.files[0]);
                }
            };
            
            uploaderDiv.appendChild(img);
            uploaderDiv.appendChild(label);
            uploaderDiv.appendChild(fileInput);
            label.onclick = () => fileInput.click();

            const nameInput = document.createElement('input');
            nameInput.type = 'text';
            nameInput.value = player.name || '';
            nameInput.placeholder = 'New Player';
            nameInput.className = 'w-full p-2 border rounded-md';
            
            nameInput.oninput = () => {
                const oldName = player.name;
                const newName = nameInput.value.trim().toUpperCase();

                if (newName === oldName || !newName) return;

                // 1. Update the name in the master squad object
                player.name = newName;

                // 2. Find or create the entry in the 'players' array (list of all available players)
                let playerInList = state[teamKey].players.find(p => p.id === player.id);
                if (playerInList) {
                    playerInList.name = newName; // Update existing
                } else {
                    // This is a new player, add them to the list of available players
                    state[teamKey].players.push({ ...player });
                }

                // 3. Find or create the entry in the 'playerStats' object
                let playerStats = state[teamKey].playerStats[player.id];
                if (playerStats) {
                    playerStats.name = newName; // Update existing
                } else {
                    // This is a new player, initialize their stats
                    state[teamKey].playerStats[player.id] = {
                        playerId: player.id, name: newName, image: player.image || '',
                        runs: 0, balls: 0, fours: 0, sixes: 0, isOut: false, dismissalInfo: null,
                        ballsBowled: 0, runsConceded: 0, wickets: 0, maidens: 0, dots: 0,
                        foursConceded: 0, sixesConceded: 0, consecutiveFours: 0, consecutiveSixes: 0
                    };
                }
                
                // 4. Update active player objects if their name changed
                if (state.striker && state.striker.playerId === player.id) state.striker.name = newName;
                if (state.nonStriker && state.nonStriker.playerId === player.id) state.nonStriker.name = newName;
                if (state.bowler && state.bowler.playerId === player.id) state.bowler.name = newName;
                
                // 5. Trigger a full UI re-render and persist the changes
                updateUI();
                debouncedSave();
            };

            row.appendChild(uploaderDiv);
            row.appendChild(nameInput);
            return row;
        }

        function renderEditablePlayerList(teamKey) {
            const playersContainer = document.getElementById(`edit-${teamKey}-players`);
            playersContainer.innerHTML = '';
            
            const team = state[teamKey];
            const squad = team.squad || [];

            squad.forEach(player => {
                const row = createEditablePlayerRow(player, teamKey);
                playersContainer.appendChild(row);
            });
            
            const addPlayerBtn = document.createElement('button');
            addPlayerBtn.textContent = '+ Add Player';
            addPlayerBtn.className = 'mt-2 text-sm font-semibold text-blue-600 hover:text-blue-800';
            
            addPlayerBtn.onclick = () => {
                const newPlayer = { id: generateUniqueId(), name: '', image: '' };
                team.squad.push(newPlayer);
                const newRow = createEditablePlayerRow(newPlayer, teamKey);
                playersContainer.insertBefore(newRow, addPlayerBtn);
            };
            
            playersContainer.appendChild(addPlayerBtn);
        }

        function switchEditTab(teamKeyToShow) {
    // Tab buttons
    document.getElementById('edit-team1-tab').classList.toggle('active', teamKeyToShow === 'team1');
    document.getElementById('edit-team2-tab').classList.toggle('active', teamKeyToShow === 'team2');

    // Content panels
    document.getElementById('edit-team1-panel').classList.toggle('hidden', teamKeyToShow !== 'team1');
    document.getElementById('edit-team2-panel').classList.toggle('hidden', teamKeyToShow !== 'team2');
}

function openEditModal() {
    // Per your instructions, we must pre-fill all fields from the live state.
    editInitialStriker = JSON.parse(JSON.stringify(state.striker));
    editInitialNonStriker = JSON.parse(JSON.stringify(state.nonStriker));
    document.getElementById('edit-venue').value = state.venue || '';
    document.getElementById('edit-total-overs').value = state.totalOvers || 0;
    
    // Deep copy the current over for editing
    editedOver = JSON.parse(JSON.stringify(state.currentOver));
    
    // Setup Tab Listeners & Text
    document.getElementById('edit-team1-tab').textContent = state.team1.name;
    document.getElementById('edit-team2-tab').textContent = state.team2.name;
    document.getElementById('edit-team1-tab').onclick = () => switchEditTab('team1');
    document.getElementById('edit-team2-tab').onclick = () => switchEditTab('team2');
    
    const battingTeamKey = state.battingTeam;
    
    // Calculate the score *before* the current over began
    const initialOverRuns = state.currentOver.reduce((acc, ball) => acc + parseBallEvent(ball.event), 0);
    scoreBeforeOver = toInt(state[battingTeamKey].score) - toInt(initialOverRuns);
    if (scoreBeforeOver < 0) scoreBeforeOver = 0; // Safety check

    // This function will be called to live-recalculate totals in the modal
    const liveRecalcModalTotals = () => {
        const battingTeamScoreInput = document.getElementById(`edit-${battingTeamKey}-score`);
        const battingTeamOversInput = document.getElementById(`edit-${battingTeamKey}-overs`);
        const battingTeamBallsInput = document.getElementById(`edit-${battingTeamKey}-balls`);

        // 1. Recalculate over runs from the *edited* over
        let newOverRuns = editedOver.reduce((acc, ball) => acc + parseBallEvent(ball.event), 0);
        battingTeamScoreInput.value = toInt(scoreBeforeOver) + toInt(newOverRuns);
        
        // 2. Recalculate balls
        let legalBallsInEditedOver = editedOver.filter(ball => isLegalDelivery(ball.event)).length;
        
        // Find the base overs/balls *before* this over started
        let originalLegalBallsInOver = state.currentOver.filter(ball => isLegalDelivery(ball.event)).length;
        let baseTotalBalls = (toInt(state[battingTeamKey].overs) * 6) + toInt(state[battingTeamKey].balls) - originalLegalBallsInOver;
        if (baseTotalBalls < 0) baseTotalBalls = 0; // Safety

        let newTotalLegalBalls = baseTotalBalls + legalBallsInEditedOver;
        
        const newOversParts = formatOvers(newTotalLegalBalls); // Uses new helper
        battingTeamOversInput.value = newOversParts.overs;
        battingTeamBallsInput.value = newOversParts.balls;
    };

    // This function updates the over chips display
    const renderOverChips = () => {
        const chipsContainer = document.getElementById('edit-over-chips-display');
        chipsContainer.innerHTML = editedOver.map((ball, index) => 
            `<span class="over-chip" data-index="${index}">${ball.event}</span>`
        ).join('');
        chipsContainer.querySelectorAll('.over-chip').forEach(chip => {
            // Re-bind click handler to open popover, which will trigger liveRecalcModalTotals on change
            chip.onclick = () => openOverEditPopover(chip, chip.dataset.index, liveRecalcModalTotals, renderOverChips);
        });
    };

    // --- Populate Modal Fields (Team 1 & 2) ---
    ['team1', 'team2'].forEach(teamKey => {
        const team = state[teamKey];
        document.getElementById(`edit-${teamKey}-name`).value = team.name || '';
        document.getElementById(`edit-${teamKey}-score`).value = toInt(team.score);
        document.getElementById(`edit-${teamKey}-wickets`).value = toInt(team.wickets);
        document.getElementById(`edit-${teamKey}-overs`).value = toInt(team.overs);
        document.getElementById(`edit-${teamKey}-balls`).value = toInt(team.balls);

        const logoUploader = document.getElementById(`edit-${teamKey}-logo-uploader`);
        logoUploader.innerHTML = `
            <img id="edit-${teamKey}-logo-preview" src="${team.logo || ''}" alt="${team.name} Logo" onerror="this.src='data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=';">
            <label for="edit-${teamKey}-logo-input" class="overlay"><span>Change</span></label>
            <input type="file" id="edit-${teamKey}-logo-input" accept="image/png, image/jpeg">`;
        
        document.getElementById(`edit-${teamKey}-logo-input`).onchange = (e) => {
            if (e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    document.getElementById(`edit-${teamKey}-logo-preview`).src = event.target.result;
                };
                reader.readAsDataURL(e.target.files[0]);
            }
        };

        renderEditablePlayerList(teamKey);

        // Add live-recalc listeners for non-batting team (batting team is handled by liveRecalcModalTotals)
        if (teamKey !== battingTeamKey) {
            document.getElementById(`edit-${teamKey}-score`).oninput = liveRecalcModalTotals;
            document.getElementById(`edit-${teamKey}-wickets`).oninput = liveRecalcModalTotals;
            document.getElementById(`edit-${teamKey}-overs`).oninput = liveRecalcModalTotals;
            document.getElementById(`edit-${teamKey}-balls`).oninput = liveRecalcModalTotals;
        }
    });

    renderOverChips(); // Initial render of over chips
    liveRecalcModalTotals(); // Initial calculation of totals
    switchEditTab('team1'); // Set initial tab
    openModal('edit-match-modal');
}
        
        function openOverEditPopover(chipElement, ballIndex, liveRecalcCallback, renderChipsCallback) {
            const popover = document.getElementById('over-edit-popover');
            const optionsContainer = document.getElementById('over-edit-options');
            
            // Highlight active chip
            document.querySelectorAll('.over-chip').forEach(c => c.classList.remove('active'));
            chipElement.classList.add('active');

            // Position popover
            const rect = chipElement.getBoundingClientRect();
            popover.style.display = 'block';
            popover.style.top = `${rect.bottom + window.scrollY + 5}px`;
            popover.style.left = `${rect.left + window.scrollX}px`;

            const options = ['0', '1', '2', '3', '4', '6', '.', 'W', 'WD', 'WD+1', 'WD+2', 'NB', 'NB+1', 'B1', 'LB1'];
            optionsContainer.innerHTML = options.map(opt => `<button data-event="${opt}">${opt}</button>`).join('');

            // We will modify `editedOver` directly, and the callbacks will handle the UI
            let selectedEvent = editedOver[ballIndex] ? editedOver[ballIndex].event : '0';
            
            const saveHistory = () => editHistory.push(JSON.parse(JSON.stringify(editedOver)));

            const runCallbacksAndClose = () => {
                if (liveRecalcCallback) liveRecalcCallback();
                if (renderChipsCallback) renderChipsCallback();
                popover.style.display = 'none';
            };

            // Event handlers for popover
            optionsContainer.querySelectorAll('button').forEach(btn => {
                btn.onclick = () => {
                    selectedEvent = btn.dataset.event;
                    // For single-action buttons, we can just replace directly
                    document.getElementById('popover-replace-btn').click();
                };
            });

            document.getElementById('popover-replace-btn').onclick = () => {
                saveHistory();
                const newRuns = parseBallEvent(selectedEvent);
                editedOver[ballIndex] = { event: selectedEvent, runs: newRuns };
                runCallbacksAndClose();
            };
            document.getElementById('popover-insertBefore-btn').onclick = () => {
                saveHistory();
                const newRuns = parseBallEvent(selectedEvent);
                editedOver.splice(ballIndex, 0, { event: selectedEvent, runs: newRuns });
                runCallbacksAndClose();
            };
            document.getElementById('popover-insertAfter-btn').onclick = () => {
                saveHistory();
                const newRuns = parseBallEvent(selectedEvent);
                editedOver.splice(parseInt(ballIndex) + 1, 0, { event: selectedEvent, runs: newRuns });
                runCallbacksAndClose();
            };
            document.getElementById('popover-delete-btn').onclick = () => {
                saveHistory();
                editedOver.splice(ballIndex, 1);
                runCallbacksAndClose();
            };
        }

        function saveMatchEdits() {
    saveState(); // Log state before making major changes for undo history

    // --- 1. GATHER ALL NEW VALUES FROM THE FORM (using toInt/toNum) ---
    const patch = {
        venue: document.getElementById('edit-venue').value.toUpperCase(),
        totalOvers: toInt(document.getElementById('edit-total-overs').value),
        team1: {
            name: document.getElementById('edit-team1-name').value.toUpperCase(),
            score: toInt(document.getElementById('edit-team1-score').value),
            wickets: toInt(document.getElementById('edit-team1-wickets').value),
            overs: toInt(document.getElementById('edit-team1-overs').value),
            balls: toInt(document.getElementById('edit-team1-balls').value),
            logo: document.getElementById('edit-team1-logo-preview').src
        },
        team2: {
            name: document.getElementById('edit-team2-name').value.toUpperCase(),
            score: toInt(document.getElementById('edit-team2-score').value),
            wickets: toInt(document.getElementById('edit-team2-wickets').value),
            overs: toInt(document.getElementById('edit-team2-overs').value),
            balls: toInt(document.getElementById('edit-team2-balls').value),
            logo: document.getElementById('edit-team2-logo-preview').src
        }
    };

    // --- 2. APPLY PATCH TO THE MAIN STATE (Deep Merge style, as requested) ---
    // This merges the patch values into the existing state, not replacing whole objects
    state.venue = patch.venue;
    state.totalOvers = patch.totalOvers;

    // Merge team data without destroying playerStats, inningsHistory, etc.
    Object.assign(state.team1, patch.team1);
    Object.assign(state.team2, patch.team2);
    
    // Apply the edited over
    state.currentOver = JSON.parse(JSON.stringify(editedOver));

    // --- 3. RECALCULATE ALL PLAYER STATS FROM INNINGS HISTORY ---
    // This is the most robust way to ensure stats are correct after any edit.
    // This function will repopulate all player runs, balls, etc.
    recalculateAllPlayerStats();

    // --- 4. FINALIZE ---
    closeModal('edit-match-modal');
    updateUI(); // Re-render everything with the fresh, correct state
    debouncedSave();

    showAlert('Match state has been updated successfully.');
}


        function previewDownload(format) {
             const { jsPDF } = window.jspdf;
             const content = document.getElementById('summary-content');
             const buttons = document.querySelector('#summary-screen > div:last-child');
             buttons.classList.add('hidden');
             html2canvas(content, { scale: 2 }).then(canvas => {
                  buttons.classList.remove('hidden');
                  const imageDataUrl = canvas.toDataURL('image/jpeg', 0.9);
                  ui.previewImage.src = imageDataUrl;

                  downloadAction = () => {
                       if(format === 'jpeg') {
                            const link = document.createElement('a');
                            link.download = `cricker-summary-${state.team1.name}-vs-${state.team2.name}.jpeg`;
                            link.href = imageDataUrl;
                            link.click();
                       } else { // PDF
                            const pdf = new jsPDF({ orientation: 'portrait', unit: 'px', format: [canvas.width, canvas.height] });
                            pdf.addImage(imageDataUrl, 'JPEG', 0, 0, canvas.width, canvas.height);
                            pdf.save(`cricker-summary-${state.team1.name}-vs-${state.team2.name}.pdf`);
                       }
                       closeModal('preview-modal');
                  };
                  openModal('preview-modal');
             });
        }
        
        // --- TEAM MANAGEMENT LOGIC ---
        function loadSavedTeams() {
            try {
                const teamsJSON = localStorage.getItem('savedTeams');
                if (teamsJSON && teamsJSON !== '{}') { // Added check for empty object string
                    console.log("Found savedTeams data in localStorage:", teamsJSON); // Debug log
                    const teamsObject = JSON.parse(teamsJSON);
                    savedTeamsData = Object.values(teamsObject);
                    if (savedTeamsData.length === 0) {
                        console.warn("Parsed savedTeams data, but it resulted in an empty array."); // Warning
                    }
                    populateTeamDropdowns();
                } else {
                    console.warn("No valid savedTeams data found in localStorage."); // More explicit warning
                    showAlert("No saved teams found in local storage. Please create teams in 'Manage Teams' first."); // User Alert
                    savedTeamsData = []; // Ensure it's empty
                    populateTeamDropdowns(); // Populate with no options
                }
            } catch (e) {
                console.error("Could not load or parse saved teams:", e);
                showAlert(`Error loading saved teams: ${e.message}`); // Show error to user
                savedTeamsData = [];
                populateTeamDropdowns();
            }
        }
        function populateTeamDropdowns() {
            [ui.team1Select, ui.team2Select].forEach(select => {
                while (select.options.length > 1) {
                    select.remove(1);
                }
                savedTeamsData.forEach(team => {
                    const option = document.createElement('option');
                    option.value = team.name;
                    option.textContent = team.name;
                    select.appendChild(option);
                });
            });
        }

        function handleTeamSelection(event, teamKey) {
            const selectedTeamName = event.target.value;
            if (!selectedTeamName) {
                const nameInput = teamKey === 'team1' ? ui.team1NameInput : ui.team2NameInput;
                nameInput.value = '';
                state[teamKey].players = [];
                state[teamKey].playerStats = {};
                return;
            }

            const teamData = savedTeamsData.find(t => t.name === selectedTeamName);
            if (!teamData) return;

            const playersPerSide = parseInt(ui.playersPerSideInput.value);
            if (isNaN(playersPerSide) || playersPerSide <= 0) {
                showAlert('Please select the "Players per Side" format first.');
                event.target.value = "";
                return;
            }

            currentTeamSelectionKey = teamKey;
            openSquadSelectionModal(teamData, playersPerSide);
        }

        function openSquadSelectionModal(teamData, playersPerSide) {
            const squadListContainer = document.getElementById('squad-player-list');
            const titleEl = document.getElementById('squad-selection-title');
            const counterEl = document.getElementById('squad-selection-counter');
            const confirmBtn = document.getElementById('squad-confirm-btn');

            // --- NEW RULES ---
            const optionalBench = 2;
            const minRequired = playersPerSide;
            const maxAllowed = playersPerSide + optionalBench;
            // --- END NEW RULES ---

            // --- NEW: Handle persistence ---
            let previouslySelectedNames = [];
            if (currentTeamSelectionKey && state[currentTeamSelectionKey].isLoaded && state[currentTeamSelectionKey].name === teamData.name) {
                 previouslySelectedNames = state[currentTeamSelectionKey].playing
                    .map(id => state[currentTeamSelectionKey].playerStats[id]?.name)
                    .filter(Boolean);
            }
            // --- END NEW ---

            titleEl.textContent = `Select Squad for ${teamData.name}`;
            squadListContainer.innerHTML = '';

            if (!teamData.players || teamData.players.length === 0) {
                squadListContainer.innerHTML = '<p class="text-gray-500">This saved team has no players in its roster.</p>';
            } else {
                teamData.players.forEach(player => {
                    // NEW: Check if this player was previously selected
                    const isChecked = previouslySelectedNames.includes(player.name);
                    const checkboxId = `player-${player.name.replace(/\s+/g, '-')}-${Math.random().toString(36).substr(2, 9)}`; // Ensure unique ID

                    const playerDiv = document.createElement('div');
                    playerDiv.className = 'flex items-center bg-gray-50 p-2 rounded-md hover:bg-gray-100';
                    playerDiv.innerHTML = `
                        <input type="checkbox" id="${checkboxId}" value="${player.name}" class="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500 mr-3 cursor-pointer" ${isChecked ? 'checked' : ''}>
                        <img src="${player.image || `data:image/svg+xml;base64,${btoa('<svg class="w-8 h-8 text-gray-400" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path></svg>')}`}" class="w-8 h-8 rounded-full object-cover mr-3 bg-gray-200">
                        <label for="${checkboxId}" class="font-medium text-gray-800 flex-grow cursor-pointer">${player.name}</label>
                    `;
                    squadListContainer.appendChild(playerDiv);
                });
            }

            const updateCounter = () => {
                const allCheckboxes = squadListContainer.querySelectorAll('input[type="checkbox"]');
                const selectedCount = squadListContainer.querySelectorAll('input[type="checkbox"]:checked').length;
                
                // Update counter text
                counterEl.textContent = `${selectedCount} / ${maxAllowed} selected`;

                // Update button state
                if (selectedCount >= minRequired && selectedCount <= maxAllowed) {
                    counterEl.classList.add('text-green-600', 'font-semibold');
                    counterEl.classList.remove('text-gray-600');
                    confirmBtn.disabled = false;
                    confirmBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                } else {
                    counterEl.classList.remove('text-green-600', 'font-semibold');
                    counterEl.classList.add('text-gray-600');
                    confirmBtn.disabled = true;
                    confirmBtn.classList.add('opacity-50', 'cursor-not-allowed');
                }

                // Update checkbox disabled state
                if (selectedCount >= maxAllowed) {
                    allCheckboxes.forEach(cb => {
                        if (!cb.checked) {
                            cb.disabled = true;
                            cb.parentElement.classList.add('opacity-50'); // Grey out the row
                        }
                    });
                } else {
                    allCheckboxes.forEach(cb => {
                        cb.disabled = false;
                        cb.parentElement.classList.remove('opacity-50');
                    });
                }
            };
            
            squadListContainer.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', updateCounter);
            });

            confirmBtn.onclick = () => {
                const selectedPlayers = [];
                const selectedCheckboxes = squadListContainer.querySelectorAll('input[type="checkbox"]:checked');
                
                selectedCheckboxes.forEach(checkbox => {
                    const playerName = checkbox.value;
                    // Find the player in the original teamData (from saved storage)
                    const playerObject = teamData.players.find(p => p.name === playerName);
                    if (playerObject) {
                        selectedPlayers.push(playerObject);
                    }
                });

                // FinalizeTeamSelection will create new IDs if they don't exist
                // and store the selected player IDs in state[teamKey].playing
                finalizeTeamSelection(currentTeamSelectionKey, teamData, selectedPlayers);
                closeModal('squad-selection-modal');
            };
            
            updateCounter(); // Run once on open
            openModal('squad-selection-modal');
        }

        function finalizeTeamSelection(teamKey, originalTeamData, selectedSquadMembers) {
    if (!teamKey) return;

    const nameInput = teamKey === 'team1' ? ui.team1NameInput : ui.team2NameInput;
    // Color input reference removed to prevent crash
    const logoInput = teamKey === 'team1' ? ui.team1LogoInput : ui.team2LogoInput;

    // Update Step 1 inputs
    nameInput.value = originalTeamData.name;
    // We set the color directly in state below instead of trying to put it in a missing input box
    
    // Clear file input as logo is loaded
    logoInput.value = '';
    document.querySelector(`label[for='${logoInput.id}']`).textContent = `${originalTeamData.name} Logo`;


    // Update state
    state[teamKey].name = originalTeamData.name;
    // Use saved color or default blue/gray if missing
    state[teamKey].color = originalTeamData.color || (teamKey === 'team1' ? '#3b82f6' : '#64748b'); 
    state[teamKey].logo = originalTeamData.logo || '';
    state[teamKey].squad = originalTeamData.players.map(p => ({...p, id: p.id || generateUniqueId() })); // Store the full potential squad
    state[teamKey].playing = selectedSquadMembers.map(p => p.id || state[teamKey].squad.find(sq => sq.name === p.name)?.id).filter(Boolean); // Store IDs of selected playing members
    state[teamKey].isLoaded = true; // Flag that this team was loaded

    // Pre-generate playerStats ONLY for the selected playing members
    const playerStats = {};
    state[teamKey].playing.forEach(playerId => {
        const player = state[teamKey].squad.find(p => p.id === playerId);
        if (player) {
            playerStats[playerId] = {
                playerId: player.id,
                name: player.name.trim().toUpperCase(),
                image: player.image || '',
                runs: 0, balls: 0, fours: 0, sixes: 0, isOut: false, dismissalInfo: null,
                ballsBowled: 0, runsConceded: 0, wickets: 0, maidens: 0, dots: 0,
                foursConceded: 0, sixesConceded: 0, consecutiveFours: 0, consecutiveSixes: 0
            };
        }
    });
    state[teamKey].playerStats = playerStats; // Store initial stats

    console.log(`Finalized ${teamKey}: Loaded=${state[teamKey].isLoaded}, Playing IDs=${state[teamKey].playing.join(', ')}`);
}

        function cancelSquadSelection() {
            if (currentTeamSelectionKey) {
                const selectDropdown = currentTeamSelectionKey === 'team1' ? ui.team1Select : ui.team2Select;
                selectDropdown.value = "";
            }
            currentTeamSelectionKey = null;
            closeModal('squad-selection-modal');
        }
        
        // --- NEW/MODIFIED: CORE APP FLOW & DATA HANDLING ---
     function showScreen(screenIdToShow) {
            // Save the current screen ID to local storage so we can return to it on refresh
            localStorage.setItem('lastVisitedPath', screenIdToShow);

            const screens = ['choice-screen', 'setup-screen', 'app', 'summary-screen'];
            screens.forEach(id => {
                const screen = document.getElementById(id);
                if (screen) {
                    if (id !== screenIdToShow && !screen.classList.contains('hidden')) {
                        screen.classList.add('hidden');
                    }
                }
            });

            const screenToShow = document.getElementById(screenIdToShow);
            if (screenToShow) {
                if (screenToShow.classList.contains('hidden')) {
                    screenToShow.classList.remove('hidden');
                }
            }
        }

        function showSetupScreen() {
            document.getElementById('choice-screen').classList.add('hidden');
            const splashScreen = document.getElementById('splash-screen');
            splashScreen.style.display = 'flex';
            splashScreen.style.opacity = '1';

            setTimeout(() => {
                splashScreen.style.opacity = '0';
                setTimeout(() => {
                    splashScreen.style.display = 'none';
                    showScreen('setup-screen');
                }, 750);
            }, 1500);
        }

        function saveCompletedMatchSummary() {
            if (!state.winner) return;
            calculateManOfTheMatch();

            const summaryState = JSON.parse(JSON.stringify(state));
            summaryState.id = state.id || `match_${Date.now()}`;
            delete summaryState.history;
            delete summaryState.pendingExtra;

            try {
                const completedMatchesJSON = localStorage.getItem('completedMatches');
                const completedMatches = completedMatchesJSON ? JSON.parse(completedMatchesJSON) : [];
                
                const existingIndex = completedMatches.findIndex(m => m.id === summaryState.id);
                if (existingIndex > -1) {
                    completedMatches[existingIndex] = summaryState;
                } else {
                    completedMatches.push(summaryState);
                }

                localStorage.setItem('completedMatches', JSON.stringify(completedMatches));
            } catch (e) {
                console.error("Failed to save match summary:", e);
            }
        }

        function collectMatchData() {
            const collectPlayerData = (playerInputsContainer) => {
                const playerRows = playerInputsContainer.querySelectorAll('.player-input-row');
                const players = [];
                playerRows.forEach(row => {
                    const nameInput = row.querySelector('input[type="text"]');
                    const playerName = nameInput.value.trim();
                    if (playerName) {
                        const imageSrc = nameInput.dataset.imageSrc || '';
                        players.push({ name: playerName, image: imageSrc });
                    }
                });
                return players;
            };

            return {
                id: `match_${Date.now()}`,
                totalOvers: parseInt(ui.totalOversInput.value),
                playersPerSide: parseInt(ui.playersPerSideInput.value),
                venue: ui.venueInput.value || 'The Local Ground',
                matchDate: ui.matchDateInput.value,
                team1: {
                    name: ui.team1NameInput.value || 'HOME TEAM',
                    players: collectPlayerData(ui.team1PlayerInputs),
                    color: ui.team1ColorInput.value,
                    logo: state.team1.logo
                },
                team2: {
                    name: ui.team2NameInput.value || 'AWAY TEAM',
                    players: collectPlayerData(ui.team2PlayerInputs),
                    color: ui.team2ColorInput.value,
                    logo: state.team2.logo
                }
            };
        }

        function saveMatchForLater() {
            if (!ui.totalOversInput.value || !ui.playersPerSideInput.value || !ui.team1NameInput.value || !ui.team2NameInput.value) {
                showAlert('Please fill in match format, players per side, and both team names before saving.');
                return;
            }
            const matchData = collectMatchData();

            try {
                const upcomingMatchesJSON = localStorage.getItem('upcomingMatches');
                const upcomingMatches = upcomingMatchesJSON ? JSON.parse(upcomingMatchesJSON) : [];
                upcomingMatches.push(matchData);
                localStorage.setItem('upcomingMatches', JSON.stringify(upcomingMatches));
                showAlert('Match saved successfully!');
                setTimeout(() => {
                    window.location.href = 'upcoming_matches.html';
                }, 1000);
            } catch (e) {
                console.error("Failed to save match:", e);
                showAlert('An error occurred while saving the match.');
            }
        }

        function populateSetupWithData(matchData) {
            state.id = matchData.id;

            // Populate Step 1
            ui.venueInput.value = matchData.venue;
            ui.matchDateInput.value = matchData.matchDate;
            ui.totalOversInput.value = matchData.totalOvers;
            ui.playersPerSideInput.value = matchData.playersPerSide;
            ui.team1NameInput.value = matchData.team1.name;
            ui.team1ColorInput.value = matchData.team1.color;
            ui.team2NameInput.value = matchData.team2.name;
            ui.team2ColorInput.value = matchData.team2.color;
            
            // Populate state for steps 2 & 3
            state.team1.logo = matchData.team1.logo;
            state.team1.players = matchData.team1.players;
            state.team2.logo = matchData.team2.logo;
            state.team2.players = matchData.team2.players;

            // FIX: Generate the hidden player input DOM elements so they exist when startMatch is called
            generatePlayerInputs('team1');
            generatePlayerInputs('team2');

            // Jump to Toss screen
            goToStep(4);
        }

        // --- INITIALIZATION ---
// --- INITIALIZATION ---
        function initializeApp() {
            // This function sets up all the button clicks and input handlers for the app.
            const initializeCommonEventListeners = () => {
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0'); // Months are 0-indexed
                const day = String(today.getDate()).padStart(2, '0');
                ui.matchDateInput.value = `${year}-${month}-${day}`;

                ui.tossWinnerTeam1.onclick = () => selectTossWinner('team1');
                ui.tossWinnerTeam2.onclick = () => selectTossWinner('team2');
                ui.tossChoiceBat.onclick = () => selectTossChoice('bat');
                ui.tossChoiceBowl.onclick = () => selectTossChoice('bowl');
                ui.team1LogoInput.onchange = (e) => handleLogoUpload(e.target.files[0], 'team1');
                ui.team2LogoInput.onchange = (e) => handleLogoUpload(e.target.files[0], 'team2');
                loadSavedTeams();
                ui.team1Select.onchange = (e) => handleTeamSelection(e, 'team1');
                ui.team2Select.onchange = (e) => handleTeamSelection(e, 'team2');
                const selects = document.querySelectorAll('#total-overs, #players-per-side');
                selects.forEach(select => {
                    function applyPlaceholderStyle() {
                        if (select.value === "") select.classList.add('placeholder');
                        else select.classList.remove('placeholder');
                    }
                    applyPlaceholderStyle();
                    select.addEventListener('change', applyPlaceholderStyle);
                });
                ui.alertOkBtn.onclick = () => {
                    closeModal('alert-modal');
                    if (typeof alertCallback === 'function') { alertCallback(); alertCallback = null; }
                };
                ui.confirmCancelBtn.onclick = () => { closeModal('confirm-modal'); confirmCallback = null; };
                ui.confirmOkBtn.onclick = () => {
                    if (typeof confirmCallback === 'function') { confirmCallback(); }
                    closeModal('confirm-modal');
                    confirmCallback = null;
                };


                ui.bowlerPromptOverlay.onclick = () => {
                    ui.playerModalCancelBtnX.classList.add('hidden');
                    ui.playerModalCancelBtnText.classList.add('hidden');
                    swapBatsmen();
                    state.currentOver = [];
                    updateUI();
                    ui.bowlerPromptOverlay.classList.add('hidden');
                    selectPlayer('bowler', () => {
                        ui.playerModalCancelBtnX.classList.remove('hidden');
                        ui.playerModalCancelBtnText.classList.remove('hidden');
                        state.isScoringLocked = false;
                        updateUI();
                    });
                };
                ui.confirmDownloadBtn.onclick = () => { if (downloadAction) downloadAction(); };
                const toggleBtn = document.getElementById('toggle-commentary-btn');
                const commentaryContent = document.getElementById('live-commentary-content');
                const commentaryChevron = document.getElementById('commentary-chevron');
                if (toggleBtn) {
                    toggleBtn.addEventListener('click', () => {
                        commentaryContent.classList.toggle('hidden');
                        commentaryChevron.classList.toggle('rotate-180');
                    });
                }
                
                // NEW: Load pitch map toggle state
                const savedPitchMapState = localStorage.getItem('isPitchMapEnabled_v1');
                state.isPitchMapEnabled = (savedPitchMapState === 'true');
                updatePitchMapToggleUI();
            };

            initializeCommonEventListeners();

            // --- APP STARTUP LOGIC ---
            const savedStateJSON = localStorage.getItem('matchState_v1');

            if (savedStateJSON && savedStateJSON !== 'null') {
                // An active match was found in storage.
                try {
                    const savedState = JSON.parse(savedStateJSON);
                    Object.assign(state, savedState);
                    
                    // --- SANITIZE LOADED STATE ---
                    sanitizeState(state); 
                    // --- END SANITIZE ---

                    window.addEventListener('beforeunload', beforeUnloadHandler);

                    const lastPath = localStorage.getItem('lastVisitedPath');
                    
                    if (lastPath === 'summary-screen') {
                        showScreen('summary-screen');
                        showSummaryScreen();
                    } else {
                        // Default to the main scoring screen if a match is in progress.
                        showScreen('app');
                        updateUI();
                    }
                } catch (e) {
                    // If loading the saved state fails, it's corrupt. Clear it and start over.
                    console.error("Failed to load saved state, starting fresh.", e);
                    localStorage.removeItem('matchState_v1');
                    localStorage.removeItem('lastVisitedPath');
                    showScreen('choice-screen');
                }
            } else {
                // No active match. Check if we are trying to view a completed match from history.
                const summaryToViewJSON = localStorage.getItem('summaryToView');
                if (summaryToViewJSON) {
                    localStorage.removeItem('summaryToView'); // Clear it after reading
                    try {
                        const summaryData = JSON.parse(summaryToViewJSON);
                        Object.assign(state, summaryData);
                        
                        // --- SANITIZE LOADED STATE ---
                        sanitizeState(state);
                        // --- END SANITIZE ---
                        
                        showScreen('summary-screen');
                        showSummaryScreen();
                    } catch (e) { 
                        console.error("Failed to parse summary data, starting fresh.", e); 
                        showScreen('choice-screen');
                    }
                } else {
                    // This is a fresh session. Show the main choice screen.
                    showScreen('choice-screen');
                }
            }
        }

        document.addEventListener('DOMContentLoaded', initializeApp);

document.addEventListener('keydown', function(event) {
    // Do not trigger shortcuts if an input field is focused
    if (event.target.tagName === 'INPUT' || event.target.tagName === 'SELECT' || event.target.tagName === 'TEXTAREA') {
        return;
    }

    const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
    const isModifier = isMac ? event.metaKey : event.ctrlKey;

    if (isModifier && event.key.toLowerCase() === 'z') {
        event.preventDefault();
        if (event.shiftKey) {
            if (!document.getElementById('redo-btn').disabled) redoLastAction();
        } else {
            if (!document.getElementById('undo-btn').disabled) undoLastAction();
        }
    }
});

        document.addEventListener('keydown', function(event) {
            if (event.key === 'Enter' && !ui.setupScreen.classList.contains('hidden')) {
                const target = event.target;

                if (target.tagName === 'INPUT' && (target.closest('#team1-player-inputs') || target.closest('#team2-player-inputs'))) {
                    
                    event.preventDefault();

                    const container = target.closest('#team1-player-inputs') || target.closest('#team2-player-inputs');
                    const inputs = Array.from(container.querySelectorAll('input[type="text"]'));
                    const currentIndex = inputs.indexOf(target);
                    
                    if (currentIndex < inputs.length - 1) {
                        inputs[currentIndex + 1].focus();
                    } else {
                        const activeStep = target.closest('.setup-step');
                        if (activeStep) {
                            const nextButton = activeStep.querySelector('.setup-btn');
                            if (nextButton) {
                                nextButton.click();
                            }
                        }
                    }
                }
            }
        });
    </script>
</body>
</html>
