<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>CRiCKERR Scorebook | Professional Live Scores</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Oswald:wght@500;700&display=swap" rel="stylesheet">

    <style>
        body { background-color: #000000; color: #e0e0e0; font-family: 'Inter', sans-serif; }
        .font-oswald { font-family: 'Oswald', sans-serif; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1e1e1e; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        
        .match-card { background: #121212; border: 1px solid #2a2a2a; transition: transform 0.2s; position: relative; }
        .match-card:active { transform: scale(0.98); }
        
        /* DELETE BUTTON - MOVED TO BOTTOM RIGHT */
        .delete-btn {
            position: absolute; 
            bottom: 15px; /* Changed from top to bottom */
            right: 15px;  /* Adjusted right spacing slightly */
            width: 28px; height: 28px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 50%; background: rgba(31, 41, 55, 0.8); border: 1px solid #374151;
            color: #ef4444; font-size: 14px; cursor: pointer; z-index: 20;
            transition: all 0.2s;
        }
        .delete-btn:hover { background: #ef4444; color: white; transform: scale(1.1); border-color: #ef4444; }

        /* Search Suggestions */
        #suggestions-box {
            position: absolute; top: 100%; left: 0; right: 0;
            background: #1a1a1a; border: 1px solid #333;
            border-top: none; border-radius: 0 0 8px 8px;
            z-index: 100; max-height: 250px; overflow-y: auto;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
        }
        .suggestion-item {
            padding: 12px 16px; border-bottom: 1px solid #2a2a2a;
            cursor: pointer; font-size: 13px; color: #e5e5e5; display: flex; justify-content: space-between; align-items: center;
        }
        .suggestion-item:hover { background: #2a2a2a; color: white; }
        .suggestion-highlight { color: #3b82f6; font-weight: bold; }

        .stat-card { background: linear-gradient(145deg, #1a1a1a, #111); border: 1px solid #333; border-radius: 8px; padding: 10px; flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .stat-value { font-family: 'Oswald', sans-serif; font-size: 18px; color: white; font-weight: 700; letter-spacing: 0.5px; }
        .stat-label { font-size: 9px; text-transform: uppercase; color: #888; font-weight: 600; letter-spacing: 1px; margin-top: 2px; }
        
        .prob-container { height: 6px; background: #333; border-radius: 3px; overflow: hidden; display: flex; margin-top: 4px; }
        .prob-bar { height: 100%; transition: width 0.5s ease; }

        .logo-anim { animation: logoFloat 3s ease-in-out infinite; }
        @keyframes logoFloat { 0% { transform: translateY(0px) scale(1); } 50% { transform: translateY(-3px) scale(1.05); } 100% { transform: translateY(0px) scale(1); } }
        
        .team-logo { border: 2px solid rgba(255,255,255,0.15); padding: 1px; background: #000; }
        .tab-container { background-color: #1f1f1f; padding: 4px; border-radius: 8px; display: flex; }
        .tab-btn { flex: 1; text-align: center; padding: 8px 0; font-size: 13px; font-weight: 600; color: #9ca3af; border-radius: 6px; transition: all 0.2s ease; text-transform: uppercase; letter-spacing: 0.5px; }
        .tab-btn.active { background-color: #3b3b3b; color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        
        details > summary { list-style: none; cursor: pointer; outline: none; }
        details > summary::-webkit-details-marker { display: none; }
        .scorecard-header { background-color: #1a1a1a; color: #e0e0e0; padding: 12px 16px; border-bottom: 1px solid #333; font-weight: bold; font-size: 12px; text-transform: uppercase; letter-spacing: 1px; display: flex; justify-content: space-between; align-items: center; }
        
        /* Impact Animation */
        #impact-overlay { pointer-events: none; }
        @keyframes impactPop { 0% { transform: scale(0.5) rotate(-10deg); opacity: 0; } 50% { transform: scale(1.2) rotate(5deg); opacity: 1; } 100% { transform: scale(1.1); opacity: 0; } }
        .animate-impact { animation: impactPop 2.5s ease-out forwards; }
        .animate-flash { animation: flashBg 0.5s ease-out; }
        @keyframes flashBg { 0% { background: rgba(255,255,255,0); } 10% { background: rgba(255,255,255,0.2); } 100% { background: rgba(255,255,255,0); } }

        /* KEYPAD STYLES */
        .keypad-btn { width: 70px; height: 70px; border-radius: 50%; background-color: rgba(255, 255, 255, 0.9); box-shadow: 0 2px 5px rgba(0,0,0,0.05); font-size: 28px; font-weight: 400; color: #1f2937; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s; cursor: pointer; user-select: none; }
        .keypad-btn:active { background-color: #d1d5db; }
        .dot { width: 14px; height: 14px; border-radius: 50%; border: 1px solid #9ca3af; transition: all 0.2s; }
        .dot.filled { background-color: #1f2937; border-color: #1f2937; }
        .shake { animation: shake 0.5s; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <div id="impact-overlay" class="fixed inset-0 z-[100] flex items-center justify-center hidden">
        <div class="absolute inset-0 bg-black/40" id="impact-bg"></div>
        <div id="impact-content" class="relative z-10 flex flex-col items-center justify-center"></div>
    </div>

    <nav class="bg-[#121212] border-b border-gray-800 p-3 sticky top-0 z-50 backdrop-blur-md bg-opacity-90">
        <div class="max-w-4xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-3">
                <img src="my-logo.png" onerror="this.src='https://placehold.co/40x40/black/white?text=C'" class="h-9 w-9 object-contain logo-anim">
                <h1 class="font-oswald text-xl uppercase tracking-wider text-white">CRiCKERR Scorebook</h1>
            </div>
            <div class="flex items-center gap-3">
                <button id="share-btn" onclick="shareMatch()" class="hidden flex items-center gap-2 text-xs font-bold text-white uppercase tracking-wider bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded-full shadow-lg transition-colors"><span>Share</span></button>
                <button id="back-btn" onclick="showHome()" class="hidden text-xs font-bold text-gray-400 hover:text-white uppercase tracking-wider bg-gray-800 px-3 py-2 rounded-lg">Back</button>
            </div>
        </div>
    </nav>

    <div id="home-view" class="flex-grow p-4 max-w-4xl mx-auto w-full">
        <div class="mb-6 relative">
            <div class="flex gap-2 relative z-50">
                <input type="text" id="search-input" placeholder="Search Team Name (e.g. Baby Bles...)" 
                    oninput="handleSearchInput(this.value)"
                    class="flex-grow bg-[#1a1a1a] border border-gray-800 text-white text-sm rounded-lg px-4 py-3 focus:outline-none focus:border-blue-500 transition-colors uppercase placeholder-gray-600">
                <button onclick="resetSearch()" class="bg-gray-800 hover:bg-gray-700 text-gray-400 font-bold uppercase text-xs px-4 rounded-lg transition-colors">Reset</button>
            </div>
            <div id="suggestions-box" class="hidden"></div>
        </div>

        <div class="mb-8">
            <h2 class="text-xs font-bold text-red-500 uppercase tracking-widest mb-3 flex items-center gap-2">
                <span class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></span> Live Matches
            </h2>
            <div id="live-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="text-gray-500 text-sm italic">Loading matches...</div>
            </div>
        </div>
        
        <div class="mb-6">
            <h2 class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-3">Completed Matches</h2>
            <div id="completed-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        </div>

        <div class="text-center pb-8">
            <button id="load-more-btn" onclick="loadMoreMatches()" class="hidden text-xs font-bold text-gray-500 hover:text-white uppercase tracking-wider border border-gray-700 hover:border-gray-500 px-6 py-3 rounded-full transition-all">
                Load More Matches
            </button>
        </div>
    </div>

    <div id="detail-view" class="hidden flex-grow flex flex-col max-w-4xl mx-auto w-full bg-black">
        
        <div class="bg-[#121212] p-4 pb-0 border-b border-gray-800">
            <div class="flex justify-between text-[10px] text-gray-500 uppercase tracking-wider font-bold mb-4">
                <div><span id="d-match-type" class="text-blue-400 mr-2">Single Match</span> ‚Ä¢ <span id="d-venue" class="ml-2">Loading...</span></div>
                <span id="d-date"></span>
            </div>

            <div class="flex justify-between items-center mb-4">
                <div class="flex flex-col items-start w-[40%]">
                    <img id="d-t1-logo" class="w-14 h-14 object-cover rounded-full team-logo mb-2">
                    <div class="text-[10px] font-bold text-gray-400 leading-tight uppercase tracking-wider" id="d-t1-name">TEAM 1</div>
                    <div class="text-3xl font-bold text-white mt-0.5 tracking-tight flex items-center" id="d-t1-score"></div>
                </div>
                <div class="text-center w-[20%]">
                    <div class="text-xl font-bold text-gray-700">VS</div>
                    <div id="d-status" class="mt-2 inline-block px-2 py-0.5 bg-red-900/30 text-red-500 text-[9px] font-bold rounded-full uppercase tracking-wide border border-red-800">LIVE</div>
                </div>
                <div class="flex flex-col items-end w-[40%] text-right">
                    <img id="d-t2-logo" class="w-14 h-14 object-cover rounded-full team-logo mb-2">
                    <div class="text-[10px] font-bold text-gray-400 leading-tight uppercase tracking-wider" id="d-t2-name">TEAM 2</div>
                    <div class="text-3xl font-bold text-white mt-0.5 tracking-tight flex items-center justify-end" id="d-t2-score"></div>
                </div>
            </div>

            <div class="text-center pb-4">
                <p id="d-result-text" class="text-white font-bold text-lg hidden">Team Won by X Runs</p>
                <p id="d-req-text" class="text-yellow-500 font-medium text-xs uppercase tracking-wide"></p>
                
                <div id="prob-wrapper" class="hidden w-full max-w-xs mx-auto mt-2">
                    <div class="flex justify-between text-[9px] font-bold text-gray-500 uppercase">
                        <span id="prob-t1-name">Team A</span>
                        <span id="prob-t2-name">Team B</span>
                    </div>
                    <div class="prob-container">
                        <div id="prob-bar-fill" class="prob-bar bg-blue-500" style="width: 50%"></div>
                        <div class="prob-bar bg-red-500 flex-1"></div>
                    </div>
                </div>
            </div>

            <div id="live-stats-row" class="flex gap-2 mb-4">
                <div class="stat-card">
                    <div id="stat-part" class="stat-value text-green-400">-</div>
                    <div class="stat-label">Partnership</div>
                </div>
                <div class="stat-card">
                    <div id="stat-last5" class="stat-value text-blue-400">-</div>
                    <div class="stat-label">Last 5 Overs</div>
                </div>
                <div class="stat-card">
                    <div id="stat-proj" class="stat-value text-yellow-400">-</div>
                    <div class="stat-label">Projected</div>
                </div>
            </div>

            <div class="tab-container mt-2 mb-2">
                <button onclick="switchTab('summary')" id="tab-summary" class="tab-btn active">Summary</button>
                <button onclick="switchTab('scorecard')" id="tab-scorecard" class="tab-btn">Scorecard</button>
                <button onclick="switchTab('stats')" id="tab-stats" class="tab-btn">Stats</button>
                <button onclick="switchTab('squads')" id="tab-squads" class="tab-btn">Squads</button>
                <button onclick="switchTab('commentary')" id="tab-commentary" class="tab-btn">Ball by Ball</button>
            </div>
        </div>
        
        <div id="view-squads" class="hidden p-4"></div>

        <div id="view-summary" class="p-4 space-y-4">
            <div class="bg-[#1a1a1a] p-3 rounded-lg border border-gray-800 flex items-center gap-3">
                <div class="text-xl">ü™ô</div>
                <div>
                    <h3 class="text-[9px] text-gray-500 font-bold uppercase tracking-widest">Toss Result</h3>
                    <p id="toss-info" class="text-xs text-white font-medium">Loading toss info...</p>
                </div>
            </div>
            <div id="pom-card" class="hidden bg-[#1a1a1a] p-4 rounded-lg border border-gray-800">
                <h3 class="text-[9px] text-yellow-500 font-bold uppercase tracking-widest mb-1">Player of the Match</h3>
                <div class="flex items-center justify-between"><span id="pom-name" class="text-lg font-bold text-white"></span><span id="pom-stats" class="text-xs text-gray-400"></span></div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-[#1a1a1a] rounded-lg border border-gray-800 p-4"><h3 class="text-[9px] text-gray-500 font-bold uppercase tracking-widest mb-4">Top Batters</h3><div id="summary-batters" class="space-y-3"></div></div>
                <div class="bg-[#1a1a1a] rounded-lg border border-gray-800 p-4"><h3 class="text-[9px] text-gray-500 font-bold uppercase tracking-widest mb-4">Top Bowlers</h3><div id="summary-bowlers" class="space-y-3"></div></div>
            </div>
        </div>

        <div id="view-scorecard" class="hidden p-4 space-y-4">
            <div id="scorecard-inn1"></div>
            <div id="fow-inn1" class="hidden bg-[#121212] p-3 border border-gray-800 rounded-lg mb-4">
                <h4 class="text-[10px] text-gray-500 uppercase font-bold mb-2">Fall of Wickets (1st Inn)</h4>
                <div id="fow-list-1" class="text-xs text-gray-400 leading-relaxed"></div>
            </div>

            <div id="scorecard-inn2"></div>
            <div id="fow-inn2" class="hidden bg-[#121212] p-3 border border-gray-800 rounded-lg">
                <h4 class="text-[10px] text-gray-500 uppercase font-bold mb-2">Fall of Wickets (2nd Inn)</h4>
                <div id="fow-list-2" class="text-xs text-gray-400 leading-relaxed"></div>
            </div>
        </div>

        <div id="view-stats" class="hidden p-4 space-y-6">
            <div class="bg-[#1a1a1a] rounded-lg border border-gray-800 p-4">
                <h3 class="text-[10px] text-gray-500 font-bold uppercase tracking-widest mb-4">WORM GRAPH</h3>
                <div class="w-full h-64"><canvas id="wormChart"></canvas></div>
            </div>
            <div class="bg-[#1a1a1a] rounded-lg border border-gray-800 p-4">
                <h3 class="text-[10px] text-gray-500 font-bold uppercase tracking-widest mb-4">RUN RATE PER OVER</h3>
                <div class="w-full h-64"><canvas id="runRateChart"></canvas></div>
            </div>
        </div>

        <div id="view-commentary" class="hidden p-4">
            <div class="bg-[#1a1a1a] rounded-lg border border-gray-800 p-4 mb-4">
                <h3 id="comm-header" class="text-[10px] text-blue-400 font-bold uppercase tracking-widest mb-3">Current Over</h3>
                <div id="comm-current-over" class="flex gap-2 mb-2 overflow-x-auto pb-2"></div>
            </div>
            <div id="comm-history-list" class="space-y-0"></div>
        </div>
    </div>

    <div id="tournament-view" class="hidden flex-grow flex flex-col max-w-4xl mx-auto w-full p-4 space-y-6">
        
        <div class="bg-[#121212] p-6 rounded-2xl border border-gray-800 text-center relative overflow-hidden shadow-lg">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-600 via-purple-600 to-pink-600"></div>
            <div class="inline-block px-3 py-1 rounded-full bg-blue-900/20 text-blue-400 text-[10px] font-bold uppercase tracking-widest mb-3 border border-blue-800/50" id="tv-status">Upcoming</div>
            <h1 id="tv-name" class="text-3xl md:text-4xl font-black text-white uppercase tracking-tight mb-2 font-oswald drop-shadow-md">Tournament Name</h1>
            <div class="flex items-center justify-center gap-2 text-xs font-bold text-gray-500 uppercase tracking-widest">
                <span id="tv-category">Category</span> ‚Ä¢ <span id="tv-location">Location</span> ‚Ä¢ <span id="tv-date">Date</span>
            </div>
        </div>

        <div class="space-y-4 animate-slide-up">
            <h3 class="text-xs font-bold text-blue-400 uppercase tracking-widest flex items-center gap-2 px-2">
                <span class="w-2 h-2 rounded-full bg-blue-500 shadow-[0_0_10px_#3b82f6]"></span> Points Table
            </h3>
            <div class="bg-[#1a1a1a] rounded-xl border border-gray-800 overflow-hidden shadow-sm">
                <div class="overflow-x-auto">
                    <table class="w-full text-left whitespace-nowrap">
                        <thead>
                            <tr class="bg-[#121212] text-[10px] font-bold text-gray-500 uppercase tracking-wider border-b border-gray-800">
                                <th class="p-4 pl-6">Team</th>
                                <th class="p-4 text-center">P</th>
                                <th class="p-4 text-center">W</th>
                                <th class="p-4 text-center">L</th>
                                <th class="p-4 text-center">NRR</th>
                                <th class="p-4 pr-6 text-center text-blue-400">Pts</th>
                            </tr>
                        </thead>
                        <tbody id="tv-standings-body" class="text-xs font-bold text-gray-300 divide-y divide-gray-800"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="space-y-4 pb-12 animate-slide-up" style="animation-delay: 100ms;">
            <h3 class="text-xs font-bold text-purple-400 uppercase tracking-widest flex items-center gap-2 px-2">
                <span class="w-2 h-2 rounded-full bg-purple-500 shadow-[0_0_10px_#a855f7]"></span> Match Schedule
            </h3>
            <div id="tv-schedule-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        </div>
    </div>

    <div id="passcode-modal" class="hidden fixed inset-0 z-[110] bg-black/95 backdrop-blur-xl flex flex-col items-center justify-center animate-fade-in">
        <div class="w-full max-w-sm flex flex-col items-center">
            <div class="mb-10 text-center">
                <div class="bg-[#1f1f1f] shadow-md w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 border border-gray-800">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                </div>
                <h3 class="text-xl font-bold text-white">Admin Deletion</h3>
                <p class="text-gray-500 text-xs mt-1">Enter code to permanently delete this match</p>
            </div>

            <div id="passcode-dots" class="flex gap-6 mb-12">
                <div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div>
            </div>

            <div class="grid grid-cols-3 gap-x-8 gap-y-6 mb-10">
                <div class="keypad-btn" onclick="handleKeypad(1)">1</div>
                <div class="keypad-btn" onclick="handleKeypad(2)">2</div>
                <div class="keypad-btn" onclick="handleKeypad(3)">3</div>
                <div class="keypad-btn" onclick="handleKeypad(4)">4</div>
                <div class="keypad-btn" onclick="handleKeypad(5)">5</div>
                <div class="keypad-btn" onclick="handleKeypad(6)">6</div>
                <div class="keypad-btn" onclick="handleKeypad(7)">7</div>
                <div class="keypad-btn" onclick="handleKeypad(8)">8</div>
                <div class="keypad-btn" onclick="handleKeypad(9)">9</div>
                <div class="keypad-btn opacity-0 cursor-default"></div> 
                <div class="keypad-btn" onclick="handleKeypad(0)">0</div>
                <div class="keypad-btn text-base font-bold text-gray-500 bg-transparent shadow-none hover:bg-transparent" onclick="handleKeypad('back')">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2M3 12l6.414 6.414a2 2 0 001.414.586H19a2 2 0 002-2V7a2 2 0 00-2-2h-8.172a2 2 0 00-1.414.586L3 12z" /></svg>
                </div>
            </div>

            <button onclick="closePasscodeModal()" class="text-gray-500 font-semibold text-sm mt-4 hover:text-white uppercase tracking-wider">Cancel</button>
        </div>
    </div>

    <script>
    // --- FIREBASE SETUP ---
    const firebaseConfig = { 
        apiKey: "AIzaSyBqcD59IAPpKqk98oDZkgzgkoVZ8b8LGgY", 
        authDomain: "livecricketscoring-92087.firebaseapp.com", 
        databaseURL: "https://livecricketscoring-92087-default-rtdb.firebaseio.com", 
        projectId: "livecricketscoring-92087", 
        storageBucket: "livecricketscoring-92087.firebasestorage.app", 
        messagingSenderId: "522927197627", 
        appId: "1:522927197627:web:f1df5db736cae96893089e" 
    };
    
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // 1. ENABLE OFFLINE PERSISTENCE
    db.enablePersistence({ synchronizeTabs: true }).catch(err => console.log(err.code));

    let activeListener = null;
    let currentMatchId = null;
    let lastActionId = 0;
    
    // --- SEARCH & PAGINATION VARS ---
    let lastVisibleMatch = null;
    let searchDebounce = null;
    const MATCH_LIMIT = 10;
    
    // --- ADMIN VARS ---
    let matchToDelete = null;
    let passcodeBuffer = "";
    const _AC = "2626"; // Admin Code (Hidden Logic)

    // --- INIT ---
    window.onload = function() {
        const urlParams = new URLSearchParams(window.location.search);
        const id = urlParams.get('id');
        
        if (id) {
            // Intelligent Routing: Check if it's a Tournament or a Match
            db.collection("tournaments").doc(id).get().then(doc => {
                if(doc.exists) {
                    openTournament(id); // It's a tournament
                } else {
                    openMatch(id); // Fallback to match viewer
                }
            }).catch(err => {
                console.log("Routing check failed, trying match...", err);
                openMatch(id);
            });
        }
        else loadMatchList();
    };

    // --- TOURNAMENT VIEWER LOGIC ---
    let activeTourneyListener = null;

    function openTournament(id) {
        currentMatchId = id; // Store for sharing
        
        // Switch Views
        document.getElementById('home-view').classList.add('hidden');
        document.getElementById('detail-view').classList.add('hidden');
        document.getElementById('tournament-view').classList.remove('hidden');
        
        // Show Nav Buttons
        document.getElementById('back-btn').classList.remove('hidden');
        document.getElementById('share-btn').classList.remove('hidden');
        document.getElementById('share-btn').style.display = 'flex';

        // Listen for Real-time Updates
        if (activeTourneyListener) activeTourneyListener();
        activeTourneyListener = db.collection("tournaments").doc(id).onSnapshot(doc => {
            if (doc.exists) renderTournamentView(doc.data());
            else alert("Tournament not found or deleted");
        });
    }

    function renderTournamentView(data) {
        // 1. Header
        const meta = data.meta || {};
        document.getElementById('tv-name').textContent = meta.name || "Tournament";
        document.getElementById('tv-category').textContent = meta.category || "Open";
        document.getElementById('tv-location').textContent = meta.country || "Global";
        document.getElementById('tv-date').textContent = meta.startDate || "-";
        
        // Status Logic
        const total = data.fixtures ? data.fixtures.length : 0;
        const completed = data.fixtures ? data.fixtures.filter(f => f.status === 'COMPLETED').length : 0;
        const statusEl = document.getElementById('tv-status');
        
        if(completed === total && total > 0) {
            statusEl.textContent = "COMPLETED";
            statusEl.className = "inline-block px-3 py-1 rounded-full bg-green-900/30 text-green-400 text-[10px] font-bold uppercase tracking-widest mb-3 border border-green-800";
        } else {
            statusEl.textContent = "LIVE TOURNAMENT";
            statusEl.className = "inline-block px-3 py-1 rounded-full bg-red-900/30 text-red-400 text-[10px] font-bold uppercase tracking-widest mb-3 border border-red-800 animate-pulse";
        }

        // 2. Standings
        const tbody = document.getElementById('tv-standings-body');
        const sorted = (data.standings || []).sort((a,b) => b.pts - a.pts || b.nrr - a.nrr);
        
        tbody.innerHTML = sorted.map((t, i) => `
            <tr class="hover:bg-white/5 transition-colors border-b border-gray-800 last:border-0 group">
                <td class="p-4 pl-6 flex items-center gap-3">
                    <span class="font-mono text-gray-600 text-[10px] group-hover:text-blue-500">${i+1}</span>
                    <span class="font-bold text-white group-hover:text-blue-400 transition-colors">${t.name}</span>
                </td>
                <td class="p-4 text-center text-gray-500 font-mono">${t.p}</td>
                <td class="p-4 text-center text-green-500 font-bold bg-green-900/10 rounded">${t.w}</td>
                <td class="p-4 text-center text-red-500 font-medium">${t.l}</td>
                <td class="p-4 text-center text-gray-400 font-mono text-[10px]">${t.nrr ? t.nrr.toFixed(3) : '0.000'}</td>
                <td class="p-4 pr-6 text-center text-lg font-black text-blue-500 bg-blue-900/10 rounded-r">${t.pts}</td>
            </tr>
        `).join('');

        // 3. Schedule
        const list = document.getElementById('tv-schedule-list');
        const fixtures = (data.fixtures || []).sort((a,b) => a.matchNo - b.matchNo);
        
        list.innerHTML = fixtures.map(f => {
            let badge = `<span class="text-blue-400 text-[9px] font-bold uppercase border border-blue-900 bg-blue-900/20 px-2 py-0.5 rounded">${f.time || 'Upcoming'}</span>`;
            let resultRow = "";
            let borderColor = "border-gray-800";
            
            if (f.status === 'COMPLETED') {
                badge = `<span class="text-gray-500 text-[9px] font-bold uppercase border border-gray-800 bg-gray-800 px-2 py-0.5 rounded">Finished</span>`;
                resultRow = `<div class="mt-3 text-center text-[10px] font-bold text-green-500 uppercase bg-green-900/20 py-1.5 rounded border border-green-900/50 tracking-wide">${f.result}</div>`;
            } else if (f.status === 'LIVE') {
                badge = `<span class="text-red-500 text-[9px] font-bold uppercase border border-red-900 bg-red-900/20 px-2 py-0.5 rounded animate-pulse">‚óè LIVE</span>`;
                // Add link to open match if live
                resultRow = `<div class="mt-3 cursor-pointer text-center text-[10px] font-bold text-white uppercase bg-blue-600 hover:bg-blue-500 py-2 rounded transition-colors" onclick="openMatch('${f.id}')">Watch Live Score ‚ûú</div>`;
            }
            
            if(f.stage.includes('Final')) borderColor = "border-yellow-600/50 shadow-[0_0_15px_rgba(234,179,8,0.1)]";

            return `
            <div class="bg-[#1a1a1a] p-4 rounded-xl border ${borderColor} relative overflow-hidden group hover:border-gray-700 transition-colors">
                ${f.stage.includes('Final') ? '<div class="absolute top-0 left-0 w-1 h-full bg-yellow-500"></div>' : ''}
                <div class="flex justify-between items-center mb-3">
                    <span class="text-[9px] font-black text-gray-500 uppercase tracking-wider">${f.stage} <span class="mx-1 text-gray-700">‚Ä¢</span> ${f.ground || 'Ground'}</span>
                    ${badge}
                </div>
                <div class="flex justify-between items-center px-1">
                    <div class="w-5/12 text-center">
                        <div class="text-xs font-black text-gray-300 uppercase truncate">${f.t1}</div>
                    </div>
                    <div class="text-[10px] font-black text-gray-700">VS</div>
                    <div class="w-5/12 text-center">
                        <div class="text-xs font-black text-gray-300 uppercase truncate">${f.t2}</div>
                    </div>
                </div>
                ${resultRow}
            </div>
            `;
        }).join('');
    }

    function formatTeamName(name) {
        if (!name) return "Team";
        return name.replace(/CRICKET CLUB/gi, "C.C").replace(/Cricket Club/g, "C.C");
    }

    async function shareMatch() {
        if (!currentMatchId) return;
        const shareUrl = `${window.location.origin}${window.location.pathname}?id=${currentMatchId}`;
        const shareData = { title: 'CRiCKERR', text: 'Follow live score:', url: shareUrl };
        try { 
            if (navigator.share) await navigator.share(shareData);
            else { await navigator.clipboard.writeText(shareUrl); alert("Link Copied!"); }
        } catch (err) {}
    }

    // --- VISUAL EFFECTS ---
    function triggerImpact(type) {
        if (!['4', '6', 'W'].includes(type)) return;
        const overlay = document.getElementById('impact-overlay');
        const content = document.getElementById('impact-content');
        const bg = document.getElementById('impact-bg');
        let colorClass = "", text = "", subtext = "";
        
        if (type === '4') { colorClass = "text-blue-500 border-blue-500 bg-blue-900/40"; text = "4"; subtext = "BOUNDARY"; } 
        else if (type === '6') { colorClass = "text-green-500 border-green-500 bg-green-900/40"; text = "6"; subtext = "MAXIMUM"; } 
        else if (type === 'W') { colorClass = "text-red-500 border-red-500 bg-red-900/40"; text = "OUT"; subtext = "WICKET"; }
        
        content.innerHTML = `<div class="animate-impact flex flex-col items-center justify-center p-8 rounded-full border-4 ${colorClass} shadow-2xl backdrop-blur-sm relative overflow-hidden w-64 h-64"><div class="text-[120px] font-oswald font-black leading-none tracking-tighter drop-shadow-lg">${text}</div><div class="text-xl font-bold uppercase tracking-widest text-white mt-2">${subtext}</div></div>`;
        overlay.classList.remove('hidden'); bg.classList.add('animate-flash');
        setTimeout(() => { overlay.classList.add('hidden'); bg.classList.remove('animate-flash'); content.innerHTML = ""; }, 2600);
    }

    // --- SMART SEARCH & SUGGESTIONS ---
    function handleSearchInput(val) {
        const inputVal = val.trim();
        const upperVal = inputVal.toUpperCase(); // Normalize to Uppercase for matching
        const box = document.getElementById('suggestions-box');
        
        // 1. CLIENT-SIDE FILTER (Instantly filter the visible cards)
        // This solves the issue where you see the card but search says "none found"
        const allCards = document.querySelectorAll('.match-card');
        
        allCards.forEach(card => {
            // We get the text content of the card to check if it matches
            const cardText = card.innerText.toUpperCase();
            if (cardText.includes(upperVal)) {
                card.style.display = ""; // Show
            } else {
                card.style.display = "none"; // Hide
            }
        });

        // 2. SUGGESTION BOX LOGIC (Database Search)
        // Only search DB if we have input, otherwise clear box
        if (inputVal.length < 2) {
            box.classList.add('hidden');
            box.innerHTML = '';
            // If cleared, show all cards again
            if(inputVal.length === 0) {
                 allCards.forEach(c => c.style.display = "");
            }
            return;
        }

        // Debounce database call
        if (searchDebounce) clearTimeout(searchDebounce);
        
        searchDebounce = setTimeout(async () => {
            // Note: This searches for exact case start. 
            // Since your data looks Uppercase, we search using upperVal.
            const queryRef = db.collection('live_matches')
                .orderBy('t1')
                .startAt(upperVal)
                .endAt(upperVal + '\uf8ff')
                .limit(5);

            try {
                const snapshot = await queryRef.get();
                if (snapshot.empty) {
                    box.innerHTML = `<div class="p-3 text-xs text-gray-500 italic">No extra matches found in DB for "${inputVal}"</div>`;
                } else {
                    let html = '';
                    snapshot.forEach(doc => {
                        const m = doc.data();
                        html += `<div onclick="openMatch('${doc.id}')" class="suggestion-item">
                                    <span>${m.t1} <span class="text-gray-500">vs</span> ${m.t2}</span>
                                    <span class="text-[10px] bg-gray-800 px-2 py-0.5 rounded text-gray-400 border border-gray-700">${m.matchStatus || 'LIVE'}</span>
                                 </div>`;
                    });
                    box.innerHTML = html;
                }
                box.classList.remove('hidden');
            } catch (e) {
                console.log("Search error", e);
                box.innerHTML = '<div class="p-3 text-xs text-red-500 italic">Error connecting to database.</div>';
            }
        }, 400); // 400ms delay
    }

    function resetSearch() {
        document.getElementById('search-input').value = "";
        document.getElementById('suggestions-box').classList.add('hidden');
        
        // Restore all cards visibility
        const allCards = document.querySelectorAll('.match-card');
        allCards.forEach(c => c.style.display = "");
        
        lastVisibleMatch = null;
        // Optional: reload list from DB to be safe
        loadMatchList(false);
    }

    // --- DATA LOADING ---
    function loadMatchList(isNextPage = false) {
        const liveContainer = document.getElementById('live-list');
        const completedContainer = document.getElementById('completed-list');
        const loadMoreBtn = document.getElementById('load-more-btn');

        if (!isNextPage) {
            liveContainer.innerHTML = '<div class="text-gray-500 text-sm italic col-span-2">Loading matches...</div>';
            completedContainer.innerHTML = '';
            lastVisibleMatch = null;
        }

        let query = db.collection('live_matches').orderBy('timestamp', 'desc').limit(MATCH_LIMIT);

        if (isNextPage && lastVisibleMatch) {
            query = query.startAfter(lastVisibleMatch);
        }

        query.get().then(snapshot => {
            if (!isNextPage) liveContainer.innerHTML = ''; 
            
            if (snapshot.empty) {
                loadMoreBtn.classList.add('hidden');
                if (!isNextPage) {
                    liveContainer.innerHTML = '<div class="text-gray-600 text-sm italic col-span-2 p-4 text-center border border-gray-800 rounded">No live matches found.</div>';
                }
                return;
            }

            lastVisibleMatch = snapshot.docs[snapshot.docs.length - 1];
            loadMoreBtn.classList.remove('hidden');

            const docs = snapshot.docs;
            docs.forEach(doc => {
                const m = doc.data();
                const id = doc.id;
                const isComplete = m.matchStatus === "COMPLETE";
                
                let t1Score = "0/0"; let t2Score = "Yet to Bat";
                if (m.scorecard) {
                    if(m.scorecard.innings1) t1Score = m.scorecard.innings1.score;
                    if(m.scorecard.innings2) t2Score = m.scorecard.innings2.score;
                } else if (m.score) {
                    t1Score = `${m.score}/${m.wickets}`;
                }

                const card = createMatchCard(id, m, t1Score, t2Score);
                if (isComplete) { completedContainer.insertAdjacentHTML('beforeend', card); } 
                else { liveContainer.insertAdjacentHTML('beforeend', card); }
            });
        }).catch(err => {
            console.log("Error loading matches:", err);
            liveContainer.innerHTML = '<div class="text-red-500 text-sm italic col-span-2">Error loading data.</div>';
        });
    }

    function loadMoreMatches() {
        loadMatchList(true);
    }

    function createMatchCard(id, m, t1Score, t2Score) {
        let statusBadge = "LIVE", statusColor = "bg-red-900/30 text-red-500 border-red-800";
        if (m.matchStatus === "COMPLETE") { statusBadge = "RESULT"; statusColor = "bg-gray-800 text-gray-300 border-gray-700"; }
        else if (['RAIN', 'BAD LIGHT'].includes(m.matchStatus)) { statusBadge = m.matchStatus; statusColor = "bg-yellow-900/30 text-yellow-500 border-yellow-800"; }
        
        return `
        <div onclick="openMatch('${id}')" class="match-card cursor-pointer p-5 rounded-xl">
            <div onclick="initiateDelete(event, '${id}')" class="delete-btn">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
            </div>

            <div class="flex justify-between items-start mb-4">
                <div class="flex flex-col">
                    <span class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">${m.tournament || 'Tournament'} ‚Ä¢ ${m.country || 'Country'}</span>
                    <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mt-0.5">${m.venue || 'Ground'}</span>
                    <span class="text-[9px] font-bold text-blue-500 uppercase tracking-wider mt-0.5">${m.matchType || "Match"}</span>
                </div>
                <span class="text-[10px] font-bold uppercase tracking-widest px-2 py-0.5 rounded border ${statusColor}">${m.matchStatus === 'COMPLETE' ? '' : '<span class="mr-1 animate-pulse">‚óè</span>'}${statusBadge}</span>
            </div>
            <div class="flex justify-between items-center mb-3">
                <div class="flex items-center gap-3 w-1/2"><img src="${m.t1Logo || 'https://placehold.co/40x40/333/888?text=T1'}" class="w-10 h-10 rounded-full object-cover team-logo"><div class="flex flex-col"><span class="font-bold text-gray-400 text-xs uppercase tracking-wider">${formatTeamName(m.t1)}</span><span class="font-bold text-white text-xl tracking-tight">${t1Score}</span></div></div>
            </div>
            <div class="flex justify-between items-center"><div class="flex items-center gap-3 w-1/2"><img src="${m.t2Logo || 'https://placehold.co/40x40/333/888?text=T2'}" class="w-10 h-10 rounded-full object-cover team-logo"><div class="flex flex-col"><span class="font-bold text-gray-400 text-xs uppercase tracking-wider">${formatTeamName(m.t2)}</span><span class="font-bold text-white text-xl tracking-tight">${t2Score}</span></div></div></div>
            <div class="text-xs text-blue-400 mt-4 border-t border-gray-800 pt-2 uppercase tracking-wide">${m.matchStatus === "COMPLETE" ? (m.resultMain || "Match Ended") : (m.target > 0 ? "Target: " + m.target : "1st Innings")}</div>
        </div>`;
    }

    // --- ADMIN DELETE LOGIC ---
    function initiateDelete(e, id) {
        e.stopPropagation(); // Stop opening the match details
        matchToDelete = id;
        passcodeBuffer = "";
        updateDots();
        document.getElementById('passcode-modal').classList.remove('hidden');
    }

    function closePasscodeModal() {
        document.getElementById('passcode-modal').classList.add('hidden');
        matchToDelete = null;
        passcodeBuffer = "";
    }

    function handleKeypad(val) {
        if (val === 'back') {
            passcodeBuffer = passcodeBuffer.slice(0, -1);
        } else {
            if (passcodeBuffer.length < 4) passcodeBuffer += val;
        }
        updateDots();

        if (passcodeBuffer.length === 4) {
            setTimeout(() => {
                if (passcodeBuffer === _AC) {
                    performDelete();
                } else {
                    // Wrong code animation
                    const dots = document.getElementById('passcode-dots');
                    dots.classList.add('shake');
                    setTimeout(() => { 
                        dots.classList.remove('shake'); 
                        passcodeBuffer = ""; 
                        updateDots();
                    }, 500);
                }
            }, 200);
        }
    }

    function updateDots() {
        const dots = document.querySelectorAll('.dot');
        dots.forEach((dot, idx) => {
            if (idx < passcodeBuffer.length) dot.classList.add('filled');
            else dot.classList.remove('filled');
        });
    }

    function performDelete() {
        if (!matchToDelete) return;
        db.collection('live_matches').doc(matchToDelete).delete().then(() => {
            alert("Match Deleted Successfully");
            closePasscodeModal();
            loadMatchList(false); // Refresh UI
        }).catch(err => {
            alert("Error deleting: " + err);
        });
    }

    function openMatch(id) {
        currentMatchId = id;
        document.getElementById('home-view').classList.add('hidden');
        document.getElementById('detail-view').classList.remove('hidden');
        document.getElementById('back-btn').classList.remove('hidden');
        document.getElementById('share-btn').classList.remove('hidden');
        document.getElementById('share-btn').style.display = 'flex';
        
        if (activeListener) activeListener(); 
        
        activeListener = db.collection('live_matches').doc(id).onSnapshot(doc => {
            if (doc.exists) {
                const data = doc.data();
                renderMatchDetails(data);
                if (data.lastAction && data.lastAction.id !== lastActionId) {
                    lastActionId = data.lastAction.id;
                    triggerImpact(data.lastAction.type);
                }
                if(document.getElementById('view-stats').classList.contains('hidden') === false) {
                    renderStats(data);
                }
            } else {
                alert("Match not found or deleted");
                showHome();
            }
        }, error => {
            console.error("Error fetching match:", error);
            if(error.code === 'resource-exhausted') alert("Live updates paused due to high traffic. Please refresh manually.");
        });
    }

    function showHome() {
        if (activeListener) activeListener();
        if (activeTourneyListener) activeTourneyListener(); // Stop tournament listener
        
        window.history.pushState({}, document.title, window.location.pathname.split('?')[0]);
        
        document.getElementById('detail-view').classList.add('hidden');
        document.getElementById('tournament-view').classList.add('hidden'); // Hide tournament view
        document.getElementById('home-view').classList.remove('hidden');
        
        document.getElementById('back-btn').classList.add('hidden');
        document.getElementById('share-btn').classList.add('hidden');
        loadMatchList(); 
    }

    // --- FULL RENDERING LOGIC ---
    function renderMatchDetails(data) {
        const setText = (id, txt) => { const el = document.getElementById(id); if(el) el.innerText = txt || '-'; };
        
        // Header Info
        setText('d-venue', data.venue);
        setText('d-match-type', (data.matchType || 'Single Match').toUpperCase());
        setText('d-t1-name', formatTeamName(data.t1));
        setText('d-t2-name', formatTeamName(data.t2));
        setText('d-date', data.date || '');
        
        // Logos
        document.getElementById('d-t1-logo').src = data.t1Logo || 'https://placehold.co/60x60/333/888?text=T1';
        document.getElementById('d-t2-logo').src = data.t2Logo || 'https://placehold.co/60x60/333/888?text=T2';
        
        // Status Badge
        const statusEl = document.getElementById('d-status');
        if (data.matchStatus === 'COMPLETE') {
            statusEl.innerText = 'RESULT';
            statusEl.className = 'mt-2 inline-block px-2 py-0.5 bg-gray-800 text-gray-300 text-[9px] font-bold rounded-full uppercase tracking-wide border border-gray-700';
            document.getElementById('d-result-text').innerText = data.resultMain || "Match Concluded";
            document.getElementById('d-result-text').classList.remove('hidden');
            document.getElementById('d-req-text').classList.add('hidden');
        } else {
            statusEl.innerText = data.matchStatus || 'LIVE';
            statusEl.className = 'mt-2 inline-block px-2 py-0.5 bg-red-900/30 text-red-500 text-[9px] font-bold rounded-full uppercase tracking-wide border border-red-800';
            document.getElementById('d-result-text').classList.add('hidden');
            document.getElementById('d-req-text').classList.remove('hidden');
            if (data.req) document.getElementById('d-req-text').innerText = data.req;
            else if(data.target) document.getElementById('d-req-text').innerText = `Target: ${data.target}`;
        }

        // Scores
        let i1 = { name: data.t1, score: "0/0", overs: "0.0" };
        let i2 = { name: data.t2, score: "Yet to Bat", overs: "0.0" };
        if(data.scorecard) {
             if(data.scorecard.innings1) i1 = data.scorecard.innings1;
             if(data.scorecard.innings2) i2 = data.scorecard.innings2;
        } else if (data.score) {
             i1 = { name: data.t1, score: `${data.score}/${data.wickets}`, overs: `${data.overs}.${data.balls}` };
        }

        document.getElementById('d-t1-score').innerHTML = `<span class="mr-2">${i1.score}</span> <span class="text-xs text-gray-500 font-normal">(${i1.overs})</span>`;
        if(i2.score !== "Yet to Bat") {
            document.getElementById('d-t2-score').innerHTML = `<span class="mr-2">${i2.score}</span> <span class="text-xs text-gray-500 font-normal">(${i2.overs})</span>`;
        } else {
             document.getElementById('d-t2-score').innerHTML = `<span class="text-base text-gray-600">Yet to Bat</span>`;
        }

        // Toss
        if(data.tossWinner) {
             document.getElementById('toss-info').innerText = `${data.tossWinner} won toss & elected to ${data.tossChoice}`;
        } else { document.getElementById('toss-info').innerText = "Toss yet to happen"; }

        // Live Stats Strip
        setText('stat-part', data.partnership ? `${data.partnership.runs} (${data.partnership.balls})` : '-');
        setText('stat-last5', data.last5 || '-');
        setText('stat-proj', data.projected || '-');

        // Render Scorecard Tabs
        const inn1Data = (data.scorecard && data.scorecard.innings1) ? data.scorecard.innings1 : i1;
        const inn2Data = (data.scorecard && data.scorecard.innings2) ? data.scorecard.innings2 : i2;
        
        if(!inn1Data.name) inn1Data.name = data.t1;
        if(!inn2Data.name) inn2Data.name = data.t2;

        renderInningsBlock(document.getElementById('scorecard-inn1'), "Innings 1", inn1Data, "border-blue-500");
        renderInningsBlock(document.getElementById('scorecard-inn2'), "Innings 2", inn2Data, "border-orange-500");
        
        // FOW
        const fow1 = (data.scorecard && data.scorecard.innings1 && data.scorecard.innings1.fow) ? data.scorecard.innings1.fow : null;
        const fow2 = (data.scorecard && data.scorecard.innings2 && data.scorecard.innings2.fow) ? data.scorecard.innings2.fow : null;
        
        renderFOW(data.timeline || [], fow1, 'fow-inn1', 'fow-list-1');
        renderFOW(data.timeline || [], fow2, 'fow-inn2', 'fow-list-2');

        // Summary Top Players
        renderTopPerformers(inn1Data, inn2Data);

        // Squads
        renderSquads(data);

        // Commentary
        const commList = document.getElementById('comm-history-list');
        const sourceData = (data.timeline && Array.isArray(data.timeline)) ? data.timeline : [];
        if (sourceData.length > 0) {
            const history = [...sourceData].reverse();
            commList.innerHTML = history.map((b) => {
                let event = (typeof b === 'object') ? (b.event || b.runs || '0') : b;
                let desc = (b.bowler && b.batter) ? `${b.bowler} to ${b.batter}` : "Ball";
                let overNum = (b.over !== undefined) ? b.over : 0;
                let ballNum = (b.ball !== undefined) ? b.ball : 0;
                
                let displayEvent = event;
                let bgClass = "bg-gray-700 text-gray-200";
                
                if (event === "0" || event === 0) { displayEvent = "DOT"; bgClass = "bg-gray-600 text-white"; }
                else if (event == "4") { bgClass = "bg-blue-600 text-white"; }
                else if (event == "6") { bgClass = "bg-green-600 text-white"; }
                else if (String(event).includes('W') && !String(event).includes('WD')) { bgClass = "bg-red-600 text-white"; displayEvent = "W"; }
                else if (String(event).includes('WD')) { bgClass = "bg-purple-600 text-white"; }
                else if (String(event).includes('NB')) { bgClass = "bg-orange-600 text-white"; }
                
                let runText = displayEvent === "DOT" ? "No run" : (String(event).includes('W') && !String(event).includes('WD') ? "Wicket!" : `${event} runs`);

                return `<div class="flex items-center gap-4 border-b border-gray-800 py-3 px-2">
                    <div class="font-mono text-gray-400 text-xs w-8 text-right font-bold">${overNum}.${ballNum}</div>
                    <div class="flex-grow">
                        <div class="text-xs text-gray-400 uppercase tracking-wider mb-0.5">${desc}</div>
                        <div class="text-sm text-gray-200 font-medium">Result: ${runText}</div>
                    </div>
                    <div class="flex items-center justify-center w-8 h-8 rounded-full ${bgClass} text-xs font-bold ring-1 ring-white/10 shrink-0">${displayEvent}</div>
                </div>`;
            }).join('');
        }
    }

    function renderTopPerformers(i1, i2) {
        // Simple logic to find top 2 batters from both inns
        let allBatters = [];
        if(i1.batting) allBatters = [...i1.batting];
        if(i2.batting) allBatters = [...allBatters, ...i2.batting];
        
        allBatters.sort((a,b) => parseInt(b.runs) - parseInt(a.runs));
        const top2Bat = allBatters.slice(0, 2);
        
        document.getElementById('summary-batters').innerHTML = top2Bat.map(p => 
            `<div class="flex justify-between items-center text-sm border-b border-gray-800 pb-2">
                <span class="text-white font-medium">${p.name}</span>
                <span class="font-bold text-blue-400">${p.runs} <span class="text-xs text-gray-600 font-normal">(${p.balls})</span></span>
             </div>`).join('');
             
        // Same for bowlers would go here (requires bowling data structure in scorecard)
        document.getElementById('summary-bowlers').innerHTML = `<div class="text-xs text-gray-500 italic">Data accumulating...</div>`;
    }

    function renderFOW(timeline, fowData, divId, listId) {
        const divEl = document.getElementById(divId);
        const listEl = document.getElementById(listId);
        if (!divEl || !listEl) return;

        let fowText = [];
        
        if (fowData && fowData.length > 0) {
            fowText = fowData.map(f => `${f.score}-${f.wicket} ${f.batter ? `(${f.batter})` : ''} ${f.over ? `@ ${f.over}` : ''}`);
        } 
        else if (timeline && timeline.length > 0) {
            let wickets = 0; let currentRuns = 0;
            const sortedTimeline = [...timeline].sort((a, b) => parseFloat(`${a.over}.${a.ball}`) - parseFloat(`${b.over}.${b.ball}`));
            
            sortedTimeline.forEach(b => {
                if(b.runs && !isNaN(b.runs)) currentRuns += parseInt(b.runs);
                let eventStr = String((typeof b === 'object') ? b.event : b);
                if(eventStr.includes('W') && !eventStr.includes('WD')) {
                    wickets++;
                    let scoreAtWicket = b.score || currentRuns;
                    fowText.push(`${scoreAtWicket}-${wickets} (${b.over}.${b.ball})`);
                }
            });
        }

        if(fowText.length > 0) {
            divEl.classList.remove('hidden');
            listEl.innerHTML = fowText.join(', &nbsp; ');
        } else {
            divEl.classList.add('hidden');
        }
    }

    function renderInningsBlock(container, title, data, borderColorClass) {
        container.innerHTML = "";
        const section = document.createElement('details');
        section.open = true;
        section.className = `bg-[#1a1a1a] rounded-lg overflow-hidden border border-gray-800 mb-4 border-l-4 ${borderColorClass}`;
        
        const summaryHTML = `<summary class="scorecard-header"><span class="uppercase tracking-widest text-sm">${formatTeamName(data.name)}</span><span class="text-blue-400 text-lg">${data.score} <span class="text-xs text-gray-500">(${data.overs})</span></span></summary>`;
        
        let battingHtml = "";
        if (data.batting && data.batting.length > 0) {
            battingHtml = `<div class="px-2 overflow-x-auto"><table class="w-full text-left text-xs mb-4 mt-2 whitespace-nowrap"><thead class="text-gray-500 border-b border-gray-800"><tr><th class="p-2 font-light">Batter</th><th class="p-2 text-right">R</th><th class="p-2 text-right">B</th><th class="p-2 text-right">4s</th><th class="p-2 text-right">6s</th><th class="p-2 text-right">SR</th></tr></thead><tbody class="divide-y divide-gray-800 text-gray-300">
                ${data.batting.map(p => `<tr><td class="p-3 font-medium text-white">${p.name}<div class="text-[10px] text-gray-500 whitespace-normal min-w-[120px]">${p.dismissal||'not out'}</div></td><td class="p-3 text-right font-bold text-white">${p.runs}</td><td class="p-3 text-right text-gray-400">${p.balls}</td><td class="p-3 text-right text-gray-500">${p.fours||0}</td><td class="p-3 text-right text-gray-500">${p.sixes||0}</td><td class="p-3 text-right text-gray-500">${p.sr||'-'}</td></tr>`).join('')}
            </tbody></table></div>`;
        } else {
            battingHtml = `<div class="p-4 text-xs text-gray-500 italic text-center">Waiting for batting data...</div>`;
        }

        let bowlingHtml = "";
        if (data.bowling && data.bowling.length > 0) {
            bowlingHtml = `<div class="px-2 overflow-x-auto"><h4 class="text-[10px] text-gray-500 uppercase font-bold mb-2 ml-2 mt-2">Bowling</h4><table class="w-full text-left text-xs mb-2 whitespace-nowrap"><thead class="text-gray-500 border-b border-gray-800"><tr><th class="p-2 font-light">Bowler</th><th class="p-2 text-right">O</th><th class="p-2 text-right">M</th><th class="p-2 text-right">R</th><th class="p-2 text-right font-bold text-white">W</th><th class="p-2 text-right">ECON</th></tr></thead><tbody class="divide-y divide-gray-800 text-gray-300">
                ${data.bowling.map(b => `<tr><td class="p-3 font-medium text-white">${b.name}</td><td class="p-3 text-right text-gray-400">${b.overs}</td><td class="p-3 text-right text-gray-500">${b.maidens||0}</td><td class="p-3 text-right text-gray-400">${b.runs}</td><td class="p-3 text-right font-bold text-white">${b.wickets}</td><td class="p-3 text-right text-gray-500">${b.econ||'-'}</td></tr>`).join('')}
            </tbody></table></div>`;
        }

        section.innerHTML = summaryHTML + battingHtml + bowlingHtml;
        container.appendChild(section);
    }

    let wormChartInstance = null;
    let runRateChartInstance = null;

    function renderStats(data) {
        if (!data.timeline || data.timeline.length === 0) return;
        
        const timeline = [...data.timeline].sort((a, b) => parseFloat(`${a.over}.${a.ball}`) - parseFloat(`${b.over}.${b.ball}`));
        
        let overLabels = [];
        let cumulativeRuns = [];
        let rpoData = [];
        let currentRuns = 0;
        let currentOverRuns = 0;
        let lastOver = -1;

        timeline.forEach(b => {
            let r = parseInt(b.runs) || 0;
            let o = parseInt(b.over);
            
            if (lastOver !== o && lastOver !== -1) {
                overLabels.push(`Over ${lastOver + 1}`);
                cumulativeRuns.push(currentRuns);
                rpoData.push(currentOverRuns);
                currentOverRuns = 0;
            }
            
            currentRuns += r;
            currentOverRuns += r;
            lastOver = o;
        });
        
        if (lastOver !== -1) {
            overLabels.push(`Over ${lastOver + 1}`);
            cumulativeRuns.push(currentRuns);
            rpoData.push(currentOverRuns);
        }

        const ctxWorm = document.getElementById('wormChart');
        if (ctxWorm) {
            if (wormChartInstance) wormChartInstance.destroy();
            wormChartInstance = new Chart(ctxWorm.getContext('2d'), {
                type: 'line',
                data: {
                    labels: overLabels,
                    datasets: [{
                        label: 'Cumulative Runs',
                        data: cumulativeRuns,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { grid: { color: '#333' }, ticks: { color: '#888' } },
                        x: { grid: { display: false }, ticks: { color: '#888' } }
                    }
                }
            });
        }

        const ctxRR = document.getElementById('runRateChart');
        if (ctxRR) {
            if (runRateChartInstance) runRateChartInstance.destroy();
            runRateChartInstance = new Chart(ctxRR.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: overLabels,
                    datasets: [{
                        label: 'Runs Per Over',
                        data: rpoData,
                        backgroundColor: '#10b981',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { grid: { color: '#333' }, ticks: { color: '#888' } },
                        x: { grid: { display: false }, ticks: { color: '#888' } }
                    }
                }
            });
        }
    }

    function renderSquads(data) {
        const container = document.getElementById('view-squads');
        if (!container) return;
        
        const t1Squad = data.squad1 || (data.t1Players || []);
        const t2Squad = data.squad2 || (data.t2Players || []);
        
        const renderTeam = (name, squad) => `
            <div class="bg-[#1a1a1a] rounded-lg border border-gray-800 p-4 mb-4">
                <h3 class="text-[10px] text-gray-500 font-bold uppercase tracking-widest mb-3 border-b border-gray-800 pb-2">${name} SQUAD</h3>
                ${squad.length > 0 
                    ? `<div class="grid grid-cols-1 md:grid-cols-2 gap-2">${squad.map(p => `
                        <div class="flex items-center gap-3 p-2 hover:bg-white/5 rounded-lg transition-colors">
                            <div class="w-8 h-8 rounded-full bg-gray-800 flex items-center justify-center text-xs font-bold text-gray-400 border border-gray-700">
                                ${(p.name || p).substring(0,2).toUpperCase()}
                            </div>
                            <div>
                                <div class="text-sm font-medium text-white">${p.name || p}</div>
                                <div class="text-[9px] text-gray-500 uppercase tracking-widest">${p.role || 'Player'}</div>
                            </div>
                        </div>`).join('')}</div>`
                    : `<div class="text-xs text-gray-500 italic py-2">Squad information not available</div>`
                }
            </div>
        `;
        
        container.innerHTML = renderTeam(formatTeamName(data.t1), t1Squad) + renderTeam(formatTeamName(data.t2), t2Squad);
    }

    function switchTab(tab) {
        ['summary', 'scorecard', 'commentary', 'stats', 'squads'].forEach(t => {
            const viewEl = document.getElementById(`view-${t}`);
            const tabEl = document.getElementById(`tab-${t}`);
            if (viewEl) viewEl.classList.add('hidden');
            if (tabEl) tabEl.classList.remove('active');
        });
        
        const activeView = document.getElementById(`view-${tab}`);
        const activeTab = document.getElementById(`tab-${tab}`);
        
        if (activeView) activeView.classList.remove('hidden');
        if (activeTab) activeTab.classList.add('active');
        
        if (tab === 'stats' && currentMatchId) {
            db.collection('live_matches').doc(currentMatchId).get().then(doc => {
                if(doc.exists) renderStats(doc.data());
            });
        }
    }
</script>
</body>
</html>
