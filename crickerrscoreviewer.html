<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>CRiCKERR Scorebook | Live Scores</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Oswald:wght@500;700&display=swap" rel="stylesheet">

    <style>
        body { background-color: #000000; color: #e0e0e0; font-family: 'Inter', sans-serif; }
        .font-oswald { font-family: 'Oswald', sans-serif; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1e1e1e; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }

        /* Card Styles */
        .match-card { background: #121212; border: 1px solid #2a2a2a; transition: transform 0.2s; position: relative; }
        .match-card:active { transform: scale(0.98); }
        
        /* Ball Circle */
        .ball-circle {
            width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;
            border-radius: 50%; font-size: 10px; font-weight: bold; color: black; background: white;
        }
        .bg-4 { background-color: #3b82f6; color: white; }
        .bg-6 { background-color: #22c55e; color: white; }
        .bg-w { background-color: #ef4444; color: white; }

        /* Delete Button */
        .delete-btn {
            position: absolute; bottom: 10px; right: 10px;
            width: 24px; height: 24px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 50%; background: #1f2937; border: 1px solid #374151;
            color: #ef4444; font-size: 12px; cursor: pointer; z-index: 20;
        }

        /* LOGO ANIMATION */
        @keyframes logoFloat {
            0% { transform: translateY(0px) scale(1); }
            50% { transform: translateY(-3px) scale(1.05); }
            100% { transform: translateY(0px) scale(1); }
        }
        .logo-anim { animation: logoFloat 3s ease-in-out infinite; }

        /* TEAM LOGO BORDER */
        .team-logo { border: 2px solid rgba(255,255,255,0.15); padding: 1px; background: #000; }

        /* APPLE STYLE TABS (Segmented Control) */
        .tab-container {
            background-color: #1f1f1f; padding: 4px; border-radius: 8px; display: flex; position: relative;
        }
        .tab-btn {
            flex: 1; text-align: center; padding: 8px 0; font-size: 13px; font-weight: 600; color: #9ca3af;
            border-radius: 6px; transition: all 0.2s ease; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .tab-btn.active { background-color: #3b3b3b; color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }

        /* IMPACT ANIMATION CSS */
        #impact-overlay { pointer-events: none; }
        @keyframes impactPop {
            0% { transform: scale(0.5) rotate(-10deg); opacity: 0; }
            50% { transform: scale(1.2) rotate(5deg); opacity: 1; }
            70% { transform: scale(1.0) rotate(0deg); opacity: 1; }
            100% { transform: scale(1.1); opacity: 0; }
        }
        .animate-impact { animation: impactPop 2.5s ease-out forwards; }
        
        @keyframes flashBg {
            0% { background-color: rgba(255, 255, 255, 0); }
            10% { background-color: rgba(255, 255, 255, 0.2); }
            100% { background-color: rgba(255, 255, 255, 0); }
        }
        .animate-flash { animation: flashBg 0.5s ease-out; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <div id="impact-overlay" class="fixed inset-0 z-[100] flex items-center justify-center hidden">
        <div class="absolute inset-0 bg-black/40" id="impact-bg"></div>
        <div id="impact-content" class="relative z-10 flex flex-col items-center justify-center">
            </div>
    </div>

    <nav class="bg-[#121212] border-b border-gray-800 p-3 sticky top-0 z-50 backdrop-blur-md bg-opacity-90">
        <div class="max-w-4xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-3">
                <img src="my-logo.png" onerror="this.src='https://placehold.co/40x40/black/white?text=C'" class="h-9 w-9 object-contain logo-anim">
                <h1 class="font-oswald text-xl uppercase tracking-wider text-white">CRiCKERR Scorebook</h1>
            </div>
            
            <div class="flex items-center gap-3">
                <button id="share-btn" onclick="shareMatch()" class="hidden flex items-center gap-2 text-xs font-bold text-white uppercase tracking-wider bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded-full shadow-lg transition-colors">
                    <span>Share üîó</span>
                </button>
                <button id="back-btn" onclick="showHome()" class="hidden text-xs font-bold text-gray-400 hover:text-white uppercase tracking-wider bg-gray-800 px-3 py-2 rounded-lg">
                    Back
                </button>
            </div>
        </div>
    </nav>

    <div id="home-view" class="flex-grow p-4 max-w-4xl mx-auto w-full">
        <div class="mb-8">
            <h2 class="text-xs font-bold text-red-500 uppercase tracking-widest mb-3 flex items-center gap-2">
                <span class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></span> Live Matches
            </h2>
            <div id="live-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="text-gray-500 text-sm italic">Searching for live matches...</div>
            </div>
        </div>
        <div>
            <h2 class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-3">Completed Matches</h2>
            <div id="completed-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        </div>
    </div>

    <div id="detail-view" class="hidden flex-grow flex flex-col max-w-4xl mx-auto w-full bg-black">
        
        <div class="bg-[#121212] p-4 pb-0 border-b border-gray-800">
            <div class="flex justify-between text-[10px] text-gray-500 uppercase tracking-wider font-bold mb-4">
                <div>
                    <span id="d-match-type" class="text-blue-400 mr-2">Single Match</span> ‚Ä¢ 
                    <span id="d-venue" class="ml-2">Loading...</span>
                </div>
                <span id="d-date"></span>
            </div>

            <div class="flex justify-between items-center mb-6">
                <div class="flex flex-col items-start w-[40%]">
                    <img id="d-t1-logo" class="w-14 h-14 object-cover rounded-full team-logo mb-2">
                    <div class="text-[10px] font-bold text-gray-400 leading-tight uppercase tracking-wider" id="d-t1-name">TEAM 1</div>
                    <div class="text-3xl font-bold text-white mt-0.5 tracking-tight flex items-center" id="d-t1-score"></div>
                </div>

                <div class="text-center w-[20%]">
                    <div class="text-xl font-bold text-gray-700">VS</div>
                    <div id="d-status" class="mt-2 inline-block px-2 py-0.5 bg-red-900/30 text-red-500 text-[9px] font-bold rounded-full uppercase tracking-wide border border-red-800">
                        LIVE
                    </div>
                </div>

                <div class="flex flex-col items-end w-[40%] text-right">
                    <img id="d-t2-logo" class="w-14 h-14 object-cover rounded-full team-logo mb-2">
                    <div class="text-[10px] font-bold text-gray-400 leading-tight uppercase tracking-wider" id="d-t2-name">TEAM 2</div>
                    <div class="text-3xl font-bold text-white mt-0.5 tracking-tight flex items-center justify-end" id="d-t2-score"></div>
                </div>
            </div>

            <div class="text-center pb-6 border-b border-gray-800">
                <p id="d-result-text" class="text-white font-bold text-lg hidden">Team Won by X Runs</p>
                <p id="d-req-text" class="text-yellow-500 font-medium text-xs uppercase tracking-wide"></p>
                <p id="d-stop-reason" class="text-red-400 font-bold text-xs mt-1 hidden"></p>
            </div>

            <div class="tab-container mt-4 mb-2">
                <button onclick="switchTab('summary')" id="tab-summary" class="tab-btn active">Summary</button>
                <button onclick="switchTab('scorecard')" id="tab-scorecard" class="tab-btn">Scorecard</button>
                <button onclick="switchTab('commentary')" id="tab-commentary" class="tab-btn">Ball by Ball</button>
            </div>
        </div>

        <div id="view-summary" class="p-4 space-y-4">
            <div class="bg-[#1a1a1a] p-3 rounded-lg border border-gray-800 flex items-center gap-3">
                <div class="text-xl">ü™ô</div>
                <div>
                    <h3 class="text-[9px] text-gray-500 font-bold uppercase tracking-widest">Toss Result</h3>
                    <p id="toss-info" class="text-xs text-white font-medium">Loading toss info...</p>
                </div>
            </div>
            <div id="pom-card" class="hidden bg-[#1a1a1a] p-4 rounded-lg border border-gray-800">
                <h3 class="text-[9px] text-yellow-500 font-bold uppercase tracking-widest mb-1">Player of the Match</h3>
                <div class="flex items-center justify-between">
                    <span id="pom-name" class="text-lg font-bold text-white"></span>
                    <span id="pom-stats" class="text-xs text-gray-400"></span>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-[#1a1a1a] rounded-lg border border-gray-800 p-4">
                    <h3 class="text-[9px] text-gray-500 font-bold uppercase tracking-widest mb-4">Top Batters</h3>
                    <div id="summary-batters" class="space-y-3"></div>
                </div>
                <div class="bg-[#1a1a1a] rounded-lg border border-gray-800 p-4">
                    <h3 class="text-[9px] text-gray-500 font-bold uppercase tracking-widest mb-4">Top Bowlers</h3>
                    <div id="summary-bowlers" class="space-y-3"></div>
                </div>
            </div>
        </div>

        <div id="view-scorecard" class="hidden p-4 space-y-6">
            <div class="bg-[#1a1a1a] rounded-lg overflow-hidden border border-gray-800">
                <div class="bg-[#222] p-3 text-xs font-bold text-white uppercase tracking-wider border-b border-gray-800">Batting</div>
                <table class="w-full text-left text-xs">
                    <thead class="text-[10px] text-gray-500 bg-[#121212] border-b border-gray-800 uppercase">
                        <tr><th class="p-3">Batter</th><th class="p-3 text-right">R</th><th class="p-3 text-right">B</th><th class="p-3 text-right hidden sm:table-cell">4s</th><th class="p-3 text-right hidden sm:table-cell">6s</th><th class="p-3 text-right">SR</th></tr>
                    </thead>
                    <tbody id="full-batting-table" class="divide-y divide-gray-800 text-gray-300"></tbody>
                </table>
            </div>
            <div class="bg-[#1a1a1a] rounded-lg overflow-hidden border border-gray-800">
                <div class="bg-[#222] p-3 text-xs font-bold text-white uppercase tracking-wider border-b border-gray-800">Bowling</div>
                <table class="w-full text-left text-xs">
                    <thead class="text-[10px] text-gray-500 bg-[#121212] border-b border-gray-800 uppercase">
                        <tr><th class="p-3">Bowler</th><th class="p-3 text-right">O</th><th class="p-3 text-right">R</th><th class="p-3 text-right">W</th><th class="p-3 text-right">Econ</th></tr>
                    </thead>
                    <tbody id="full-bowling-table" class="divide-y divide-gray-800 text-gray-300"></tbody>
                </table>
            </div>
        </div>

        <div id="view-commentary" class="hidden p-4">
            <div class="bg-[#1a1a1a] rounded-lg border border-gray-800 p-4 mb-4">
                <h3 id="comm-header" class="text-[10px] text-blue-400 font-bold uppercase tracking-widest mb-3">Current Over</h3>
                <div id="comm-current-over" class="flex gap-2 mb-2 overflow-x-auto pb-2"></div>
            </div>
            <div id="comm-history-list" class="space-y-0"></div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const firebaseConfig = { apiKey: "AIzaSyBqcD59IAPpKqk98oDZkgzgkoVZ8b8LGgY", authDomain: "livecricketscoring-92087.firebaseapp.com", databaseURL: "https://livecricketscoring-92087-default-rtdb.firebaseio.com", projectId: "livecricketscoring-92087", storageBucket: "livecricketscoring-92087.firebasestorage.app", messagingSenderId: "522927197627", appId: "1:522927197627:web:f1df5db736cae96893089e" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let activeListener = null;
        let currentMatchId = null;
        let lastActionId = 0; 

        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const matchId = urlParams.get('id');
            if (matchId) openMatch(matchId);
            else loadMatchList();
        };

        function formatTeamName(name) {
            if (!name) return "Team";
            return name.replace(/CRICKET CLUB/gi, "C.C").replace(/Cricket Club/g, "C.C");
        }

        async function shareMatch() {
            if (!currentMatchId) return;
            const shareUrl = `${window.location.origin}${window.location.pathname}?id=${currentMatchId}`;
            const shareData = { title: 'CRiCKERR Scorebook', text: 'Follow live score:', url: shareUrl };
            if (navigator.share) {
                try { await navigator.share(shareData); } catch (err) {}
            } else {
                try { await navigator.clipboard.writeText(shareUrl); alert("Link Copied!"); } catch (err) { prompt("Copy link:", shareUrl); }
            }
        }

        function triggerImpact(type) {
            if (!['4', '6', 'W'].includes(type)) return;
            const overlay = document.getElementById('impact-overlay');
            const content = document.getElementById('impact-content');
            const bg = document.getElementById('impact-bg');
            
            let colorClass = ""; let text = ""; let subtext = "";
            if (type === '4') { colorClass = "text-blue-500 border-blue-500 bg-blue-900/40"; text = "4"; subtext = "BOUNDARY"; } 
            else if (type === '6') { colorClass = "text-green-500 border-green-500 bg-green-900/40"; text = "6"; subtext = "MAXIMUM"; } 
            else if (type === 'W') { colorClass = "text-red-500 border-red-500 bg-red-900/40"; text = "OUT"; subtext = "WICKET"; }

            content.innerHTML = `<div class="animate-impact flex flex-col items-center justify-center p-8 rounded-full border-4 ${colorClass} shadow-2xl backdrop-blur-sm relative overflow-hidden w-64 h-64"><div class="text-[120px] font-oswald font-black leading-none tracking-tighter drop-shadow-lg">${text}</div><div class="text-xl font-bold uppercase tracking-widest text-white mt-2">${subtext}</div></div>`;
            overlay.classList.remove('hidden'); bg.classList.add('animate-flash');
            setTimeout(() => { overlay.classList.add('hidden'); bg.classList.remove('animate-flash'); content.innerHTML = ""; }, 2600);
        }

        function loadMatchList() {
            const liveContainer = document.getElementById('live-list');
            const completedContainer = document.getElementById('completed-list');
            liveContainer.innerHTML = '<div class="text-gray-500 text-sm italic col-span-2">Loading matches...</div>';
            completedContainer.innerHTML = '';

            const now = new Date();
            const twoDaysAgo = new Date(now.getTime() - (48 * 60 * 60 * 1000));
            const halfDayAgo = new Date(now.getTime() - (12 * 60 * 60 * 1000));

            db.collection('live_matches').get().then(snapshot => {
                liveContainer.innerHTML = '';
                let liveCount = 0;
                let completedCount = 0;

                snapshot.forEach(doc => {
                    const m = doc.data();
                    const id = doc.id;
                    const isComplete = m.matchStatus === "COMPLETE";
                    let isRelevant = true;
                    const lastUpdate = m.timestamp ? m.timestamp.toDate() : new Date(0); 

                    if (isComplete) { if (lastUpdate < twoDaysAgo) isRelevant = false; } 
                    else { if (lastUpdate < halfDayAgo) isRelevant = false; }

                    if (isRelevant) {
                        const card = createMatchCard(id, m);
                        if (isComplete) { completedContainer.innerHTML += card; completedCount++; } 
                        else { liveContainer.innerHTML += card; liveCount++; }
                    }
                });

                if (liveCount === 0) liveContainer.innerHTML = '<div class="text-gray-600 text-sm italic col-span-2 p-4 text-center border border-gray-800 rounded">No live matches found.</div>';
                if (completedCount === 0) completedContainer.innerHTML = '<div class="text-gray-600 text-sm italic col-span-2 p-4 text-center">No recent results found.</div>';
            });
        }

        function deleteMatch(id, e) {
            e.stopPropagation(); 
            const code = prompt("Enter Admin Code to DELETE:");
            if (code === "2626") {
                if(confirm("Permanently delete match?")) {
                    db.collection('live_matches').doc(id).delete().then(() => {
                        alert("Deleted."); loadMatchList();
                    }).catch(error => alert("Error: " + error.message));
                }
            } else if (code !== null) alert("Incorrect Code!");
        }

        function createMatchCard(id, m) {
            let statusBadge = "LIVE";
            let statusColor = "bg-red-900/30 text-red-500 border-red-800";
            
            if (m.matchStatus === "COMPLETE") {
                statusBadge = "RESULT";
                statusColor = "bg-gray-800 text-gray-300 border-gray-700";
            } else if (['RAIN', 'BAD LIGHT', 'STOPPED', 'ABANDONED'].includes(m.matchStatus)) {
                statusBadge = m.matchStatus;
                statusColor = "bg-yellow-900/30 text-yellow-500 border-yellow-800";
            }

            let t1ScoreDisplay = '-';
            let t2ScoreDisplay = '-';
            
            if (m.matchStatus === 'COMPLETE') {
                if(m.resultT1) t1ScoreDisplay = m.resultT1.score;
                if(m.resultT2) t2ScoreDisplay = m.resultT2.score;
            } else {
                const currentScore = `${m.score}/${m.wickets}`;
                if (m.target > 0) {
                   t1ScoreDisplay = `Target ${m.target}`;
                   t2ScoreDisplay = currentScore;
                } else {
                   t1ScoreDisplay = currentScore;
                   t2ScoreDisplay = '<span class="text-xs font-medium text-gray-500 uppercase tracking-wider">Yet to bat</span>';
                }
            }

            const matchType = m.matchType || "Single Match";

            return `
            <div onclick="openMatch('${id}')" class="match-card cursor-pointer p-5 rounded-xl pb-10">
                <div class="flex justify-between items-start mb-4">
                    <div class="flex flex-col">
                        <span class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">${m.venue || 'Unknown Ground'}</span>
                        <span class="text-[9px] font-bold text-blue-500 uppercase tracking-wider mt-0.5">${matchType}</span>
                    </div>
                    <span class="text-[10px] font-bold uppercase tracking-widest px-2 py-0.5 rounded border ${statusColor}">
                        ${m.matchStatus === 'COMPLETE' ? '' : '<span class="mr-1 animate-pulse">‚óè</span>'}${statusBadge}
                    </span>
                </div>
                <div class="flex justify-between items-center mb-3">
                    <div class="flex items-center gap-3 w-1/2">
                        <img src="${m.t1Logo || 'https://placehold.co/40x40/333/888?text=T1'}" class="w-10 h-10 rounded-full object-cover team-logo">
                        <div class="flex flex-col">
                            <span class="font-bold text-gray-400 text-xs uppercase tracking-wider">${formatTeamName(m.t1)}</span>
                            <span class="font-bold text-white text-xl tracking-tight">${t1ScoreDisplay}</span>
                        </div>
                    </div>
                </div>
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-3 w-1/2">
                        <img src="${m.t2Logo || 'https://placehold.co/40x40/333/888?text=T2'}" class="w-10 h-10 rounded-full object-cover team-logo">
                        <div class="flex flex-col">
                            <span class="font-bold text-gray-400 text-xs uppercase tracking-wider">${formatTeamName(m.t2)}</span>
                            <span class="font-bold text-white text-xl tracking-tight">${t2ScoreDisplay}</span>
                        </div>
                    </div>
                </div>
                <div class="text-xs text-blue-400 mt-4 border-t border-gray-800 pt-2 uppercase tracking-wide">
                    ${m.matchStatus === "COMPLETE" ? (m.resultMain || "Match Ended") : (m.target > 0 ? "2nd Innings - Chase On" : "1st Innings - Batting")}
                </div>
                <div class="delete-btn" onclick="deleteMatch('${id}', event)">üóëÔ∏è</div>
            </div>`;
        }

        function openMatch(id) {
            currentMatchId = id;
            document.getElementById('home-view').classList.add('hidden');
            document.getElementById('detail-view').classList.remove('hidden');
            document.getElementById('back-btn').classList.remove('hidden');
            document.getElementById('share-btn').classList.remove('hidden');
            document.getElementById('share-btn').style.display = 'flex';
            if (activeListener) activeListener(); 
            activeListener = db.collection('live_matches').doc(id).onSnapshot(doc => {
                if (doc.exists) {
                    const data = doc.data();
                    renderMatchDetails(data);
                    if (data.lastAction && data.lastAction.id !== lastActionId) {
                        lastActionId = data.lastAction.id;
                        triggerImpact(data.lastAction.type);
                    }
                }
            });
        }

        function showHome() {
            window.history.pushState({}, document.title, window.location.pathname);
            if (activeListener) activeListener();
            document.getElementById('detail-view').classList.add('hidden');
            document.getElementById('home-view').classList.remove('hidden');
            document.getElementById('back-btn').classList.add('hidden');
            document.getElementById('share-btn').classList.add('hidden');
            loadMatchList(); 
        }

        function renderMatchDetails(data) {
            document.getElementById('d-venue').innerText = data.venue || "Indoor Arena";
            document.getElementById('d-date').innerText = data.matchDate || "";
            document.getElementById('d-match-type').innerText = (data.matchType || "Single Match").toUpperCase();
            
            document.getElementById('d-t1-name').innerText = formatTeamName(data.t1);
            document.getElementById('d-t1-logo').src = data.t1Logo || "";
            document.getElementById('d-t2-name').innerText = formatTeamName(data.t2);
            document.getElementById('d-t2-logo').src = data.t2Logo || "";

            const statusEl = document.getElementById('d-status');
            const stopReasonEl = document.getElementById('d-stop-reason');
            stopReasonEl.classList.add('hidden');

            if (data.matchStatus === "COMPLETE") {
                statusEl.innerText = "RESULT";
                statusEl.className = "mt-2 inline-block px-3 py-1 bg-gray-800 text-gray-300 text-xs font-bold rounded-full uppercase tracking-wide border border-gray-700";
            } else if (['RAIN', 'BAD LIGHT', 'STOPPED', 'ABANDONED'].includes(data.matchStatus)) {
                statusEl.innerText = data.matchStatus;
                statusEl.className = "mt-2 inline-block px-3 py-1 bg-yellow-900/30 text-yellow-500 text-xs font-bold rounded-full uppercase tracking-wide border border-yellow-800";
                stopReasonEl.innerText = `MATCH STOPPED: ${data.matchStatus}`;
                stopReasonEl.classList.remove('hidden');
            } else {
                statusEl.innerText = "LIVE";
                statusEl.className = "mt-2 inline-block px-3 py-1 bg-red-900/30 text-red-500 text-xs font-bold rounded-full uppercase tracking-wide border border-red-800";
            }

            const tossEl = document.getElementById('toss-info');
            if (data.tossWinner && data.tossChoice) {
                tossEl.innerText = `${formatTeamName(data.tossWinner)} won the toss and elected to ${data.tossChoice}`;
                tossEl.className = "text-xs text-white font-medium";
            } else {
                tossEl.innerText = "Toss information not yet available";
                tossEl.className = "text-xs text-gray-500 italic";
            }

            let t1Text = "0/0"; let t2Text = "0/0";
            
            if (data.matchStatus === "COMPLETE") {
                if(data.resultT1) t1Text = `${data.resultT1.score} <span class="text-sm font-normal text-gray-500">(${data.resultT1.overs})</span>`;
                if(data.resultT2) t2Text = `${data.resultT2.score} <span class="text-sm font-normal text-gray-500">(${data.resultT2.overs})</span>`;
                document.getElementById('d-result-text').classList.remove('hidden');
                document.getElementById('d-result-text').innerText = data.resultMain || "Match Complete";
                document.getElementById('d-req-text').innerText = data.resultSub || "";
                if (data.pom) {
                    document.getElementById('pom-card').classList.remove('hidden');
                    document.getElementById('pom-name').innerText = data.pom.name;
                    document.getElementById('pom-stats').innerText = data.pom.stats;
                }
            } else {
                document.getElementById('d-result-text').classList.add('hidden');
                const currentScore = `${data.score}/${data.wickets} <span class="text-sm font-normal text-gray-500">(${data.overs}.${data.balls})</span>`;
                if (data.target > 0) {
                    t1Text = `Target: ${data.target}`; t2Text = currentScore;
                    const needed = data.target - data.score;
                    const ballsRem = (data.totalOvers * 6) - ((data.overs * 6) + data.balls);
                    document.getElementById('d-req-text').innerText = `Need ${needed} runs in ${ballsRem} balls`;
                } else {
                    t1Text = currentScore; 
                    t2Text = '<span class="text-lg font-medium text-gray-500 uppercase tracking-wider">Yet to bat</span>';
                    document.getElementById('d-req-text').innerText = `Current Run Rate: ${(data.score / Math.max(1, (data.overs + data.balls/6))).toFixed(2)}`;
                }
            }

            document.getElementById('d-t1-score').innerHTML = t1Text;
            document.getElementById('d-t2-score').innerHTML = t2Text;

            // ... (Tables Logic Same as Before) ...
            const batters = data.battingCard || [];
            const bowlers = data.bowlingCard || [];
            
            const sortedBatters = [...batters].sort((a,b) => b.runs - a.runs).slice(0, 3);
            document.getElementById('summary-batters').innerHTML = sortedBatters.map(p => `
                <div class="flex justify-between items-center text-xs border-b border-gray-800 pb-2 mb-2 last:border-0">
                    <div><div class="font-bold text-white">${p.name}</div><div class="text-[10px] text-gray-500">${p.status}</div></div>
                    <div class="text-right"><span class="font-bold text-white">${p.runs}</span> <span class="text-[10px] text-gray-500">(${p.balls})</span></div>
                </div>`).join('');

            const sortedBowlers = [...bowlers].sort((a,b) => b.w - a.w).slice(0, 3);
            document.getElementById('summary-bowlers').innerHTML = sortedBowlers.map(p => `
                <div class="flex justify-between items-center text-xs border-b border-gray-800 pb-2 mb-2 last:border-0">
                    <div class="font-bold text-white">${p.name}</div>
                    <div class="text-right"><span class="font-bold text-white">${p.w}</span><span class="text-gray-500">/${p.r}</span> <span class="text-[10px] text-gray-500">(${p.o})</span></div>
                </div>`).join('');

            document.getElementById('full-batting-table').innerHTML = batters.map(p => `
                <tr>
                    <td class="p-3 border-b border-gray-800 font-medium text-white">${p.name} <div class="text-[10px] text-gray-500 uppercase">${p.status}</div></td>
                    <td class="p-3 border-b border-gray-800 text-right font-bold text-white">${p.runs}</td>
                    <td class="p-3 border-b border-gray-800 text-right text-gray-400">${p.balls}</td>
                    <td class="p-3 border-b border-gray-800 text-right hidden sm:table-cell text-gray-500">-</td>
                    <td class="p-3 border-b border-gray-800 text-right hidden sm:table-cell text-gray-500">-</td>
                    <td class="p-3 border-b border-gray-800 text-right text-gray-500">${(p.runs*100/Math.max(1,p.balls)).toFixed(1)}</td>
                </tr>
            `).join('');

            document.getElementById('full-bowling-table').innerHTML = bowlers.map(p => `
                <tr>
                    <td class="p-3 border-b border-gray-800 font-medium text-white">${p.name}</td>
                    <td class="p-3 border-b border-gray-800 text-right text-gray-400">${p.o}</td>
                    <td class="p-3 border-b border-gray-800 text-right text-gray-400">${p.r}</td>
                    <td class="p-3 border-b border-gray-800 text-right font-bold text-white">${p.w}</td>
                    <td class="p-3 border-b border-gray-800 text-right text-gray-500">${p.e}</td>
                </tr>
            `).join('');

            // --- FULL BALL-BY-BALL COMMENTARY ---
            const commList = document.getElementById('comm-history-list');
            const commHeader = document.getElementById('comm-header');
            
            // Header Update
            commHeader.innerText = `CURRENT OVER - ${data.bowler ? data.bowler.name : 'BOWLER'}`;

            // List Update
            if (data.timeline && Array.isArray(data.timeline)) {
                // RICH DATA AVAILABLE (Timeline)
                let lastOver = -1;
                // Copy & Reverse to show newest first
                const history = [...data.timeline].reverse(); 
                
                commList.innerHTML = history.map((b, i) => {
                    let html = "";
                    
                    // Insert Divider if Over changes (Since we reversed, we check next item's over)
                    // Actually, simpler logic: If current ball is last ball of over (e.g. 2.6), show end of over above it?
                    // Better: Just group visually or show "End of Over" items if they exist.
                    // For now, let's just render the list cleanly.
                    
                    // Ball Logic
                    const isWicket = b.type === 'W' || b.run === 'W';
                    const runVal = b.run === 'W' ? 'W' : b.run;
                    
                    let bgClass = "bg-gray-700 text-white";
                    if(runVal == "4") bgClass = "bg-blue-600 text-white";
                    if(runVal == "6") bgClass = "bg-green-600 text-white";
                    if(isWicket) bgClass = "bg-red-600 text-white";

                    // Wicket Detail Text
                    let detailText = `${b.bowler} to ${b.batter}`;
                    let subDetail = "";
                    if(isWicket) {
                        subDetail = `<div class="text-[10px] text-red-400 font-bold uppercase mt-0.5">
                            ${b.wicketType || "WICKET"} ${b.fielder ? `c ${b.fielder}` : ""} b ${b.bowler}
                        </div>`;
                    } else if (runVal == "4" || runVal == "6") {
                        subDetail = `<div class="text-[10px] text-gray-400 font-bold uppercase mt-0.5">${runVal} RUNS</div>`;
                    }

                    // Over Divider Check (Simple approach: if decimal is .6, show divider before? No, simpler list first)
                    // Let's just output the ball row
                    return `
                    <div class="flex items-start gap-4 border-b border-gray-800 py-3 px-2">
                        <div class="font-mono text-gray-500 text-xs pt-1 w-8">${b.over}.${b.ball}</div>
                        <div class="flex-grow">
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="text-xs text-white font-medium">${detailText}</div>
                                    ${subDetail}
                                </div>
                                <div class="flex items-center justify-center w-6 h-6 rounded-full ${bgClass} text-[10px] font-bold">
                                    ${runVal}
                                </div>
                            </div>
                        </div>
                    </div>`;
                }).join('');

            } else if (data.currentOver) {
                // FALLBACK DATA LOGIC
                commList.innerHTML = [...data.currentOver].reverse().map((b, i) => {
                    // 1. Calculate Over Number
                    const overStr = `${data.overs}.${(data.currentOver.length - i)}`;
                    
                    // 2. Extract Event & Names (Handle both old string format and new object format)
                    let event = "";
                    let desc = "Bowler to Batter";
                    
                    if (typeof b === 'object') {
                        event = b.event;
                        // Use saved names if available, otherwise generic
                        desc = (b.bowler && b.batter) ? `${b.bowler} to ${b.batter}` : "Bowler to Batter";
                    } else {
                        event = b; // Old string format support
                    }

                    // 3. Color Logic
                    let bgClass = "bg-gray-700";
                    if(event.includes('W')) bgClass = "bg-red-600";
                    else if(event == '4') bgClass = "bg-blue-600";
                    else if(event == '6') bgClass = "bg-green-600";

                    return `
                    <div class="flex items-start gap-4 border-b border-gray-800 py-3 px-2">
                        <div class="font-mono text-gray-500 text-xs pt-1 w-8">${overStr}</div>
                        <div class="flex-grow">
                            <div class="flex justify-between items-center">
                                <span class="text-xs text-gray-400 font-medium uppercase tracking-wide">${desc}</span>
                                <div class="flex items-center justify-center w-6 h-6 rounded-full ${bgClass} text-white text-[10px] font-bold">
                                    ${event}
                                </div>
                            </div>
                        </div>
                    </div>`;
                }).join('');
            }
            
            // Current Over Strip
            const commOver = document.getElementById('comm-current-over');
            if (data.currentOver && data.currentOver.length > 0) {
                commOver.innerHTML = data.currentOver.map(b => {
                    let c = "bg-gray-200";
                    if(b === "4") c = "bg-4";
                    if(b === "6") c = "bg-6";
                    if(b.includes("W") && !b.includes("WD")) c = "bg-w";
                    return `<div class="ball-circle ${c}">${b}</div>`;
                }).join('');
            } else {
                commOver.innerHTML = "<span class='text-gray-600 text-xs italic'>No balls in current over</span>";
            }
        }

        function switchTab(tab) {
            ['summary', 'scorecard', 'commentary'].forEach(t => {
                document.getElementById(`view-${t}`).classList.add('hidden');
                document.getElementById(`tab-${t}`).classList.remove('active');
            });
            document.getElementById(`view-${tab}`).classList.remove('hidden');
            document.getElementById(`tab-${tab}`).classList.add('active');
        }
    </script>
</body>
</html>
